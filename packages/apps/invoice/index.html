<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Invoice Creator ‚Äî PAN Demo App</title>
  <link rel="stylesheet" href="../assets/theme.css">
  <style>
    body {
      padding: 0;
      margin: 0;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Toolbar */
    .toolbar {
      background: var(--color-surface, #ffffff);
      border-bottom: 2px solid var(--color-border, #e2e8f0);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-primary, #006699);
      margin: 0;
    }

    .invoice-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .invoice-selector select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      border: 1px solid var(--color-border, #e2e8f0);
      border-radius: 0.375rem;
      background: var(--color-surface, #ffffff);
      color: var(--color-text, #1e293b);
      font-size: 0.875rem;
      cursor: pointer;
      min-width: 200px;
      outline: none;
      transition: all 0.2s ease;
    }

    .invoice-selector select:focus {
      border-color: var(--color-primary, #006699);
      box-shadow: 0 0 0 3px var(--color-primary-soft, #e0f2fe);
    }

    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--color-primary, #006699);
      border-color: var(--color-primary, #006699);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-dark, #004d73);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--color-surface, #ffffff);
      border-color: var(--color-border, #e2e8f0);
      color: var(--color-text, #1e293b);
    }

    .btn-secondary:hover {
      background: var(--color-bg-alt, #f8fafc);
      border-color: var(--color-border-strong, #cbd5e1);
    }

    .btn-danger {
      background: var(--color-danger, #ef4444);
      border-color: var(--color-danger, #ef4444);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .invoice-section {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted, #64748b);
      margin-bottom: 1rem;
    }

    /* Print Styles */
    @media print {
      .toolbar,
      .btn,
      .invoice-selector,
      pan-theme-toggle {
        display: none !important;
      }

      body {
        background: white;
      }

      .main-content {
        padding: 0;
        max-width: none;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .toolbar-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .main-content {
        padding: 1rem;
      }
    }

    /* Status indicator */
    .save-status {
      font-size: 0.75rem;
      color: var(--color-text-muted, #64748b);
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      background: var(--color-bg-alt, #f8fafc);
    }

    .save-status.saved {
      color: var(--color-success, #10b981);
      background: var(--color-success-light, #d1fae5);
    }

    /* File input hidden */
    .file-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <h1 class="app-title">üìÑ Invoice Creator</h1>

        <div class="invoice-selector">
          <select id="invoice-select" aria-label="Select invoice">
            <option value="">Loading...</option>
          </select>
        </div>

        <span class="save-status" id="save-status">Auto-saving...</span>
      </div>

      <div class="toolbar-actions">
        <button class="btn btn-primary" id="btn-new">
          ‚ûï New
        </button>
        <button class="btn btn-secondary" id="btn-save">
          üíæ Save
        </button>
        <button class="btn btn-secondary" id="btn-print">
          üñ®Ô∏è Print
        </button>
        <button class="btn btn-secondary" id="btn-export">
          üì§ Export
        </button>
        <button class="btn btn-secondary" id="btn-import">
          üì• Import
        </button>
        <button class="btn btn-danger" id="btn-delete">
          üóëÔ∏è Delete
        </button>
        <pan-theme-toggle variant="icon"></pan-theme-toggle>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Invoice Header -->
      <div class="invoice-section">
        <pan-invoice-header></pan-invoice-header>
      </div>

      <!-- Invoice Items -->
      <div class="invoice-section">
        <div class="section-title">Line Items</div>
        <pan-invoice-items></pan-invoice-items>
      </div>

      <!-- Invoice Totals -->
      <div class="invoice-section">
        <pan-invoice-totals></pan-invoice-totals>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="file-import" class="file-input" accept=".json" />

  <!-- State Management -->
  <pan-bus></pan-bus>
  <pan-invoice-store auto-save="true"></pan-invoice-store>
  <pan-theme-provider theme="auto"></pan-theme-provider>

  <script type="module">
    import '../../core/src/components/pan-bus.mjs';
    import './components/pan-invoice-items.mjs';
    import './components/pan-invoice-header.mjs';
    import './components/pan-invoice-totals.mjs';
    import '../../components/src/components/pan-invoice-store.mjs';
    import '../../components/src/components/pan-theme-provider.mjs';
    import '../../components/src/components/pan-theme-toggle.mjs';

    // Get elements
    const bus = document.querySelector('pan-bus');
    const invoiceSelect = document.getElementById('invoice-select');
    const saveStatus = document.getElementById('save-status');
    const fileInput = document.getElementById('file-import');

    // Button handlers
    document.getElementById('btn-new').addEventListener('click', () => {
      bus.publish('invoice.new', {});
    });

    document.getElementById('btn-save').addEventListener('click', () => {
      bus.publish('invoice.save', {});
    });

    document.getElementById('btn-print').addEventListener('click', () => {
      window.print();
    });

    document.getElementById('btn-export').addEventListener('click', () => {
      bus.publish('invoice.export', {});
    });

    document.getElementById('btn-import').addEventListener('click', () => {
      fileInput.click();
    });

    document.getElementById('btn-delete').addEventListener('click', () => {
      bus.publish('invoice.delete', {});
    });

    // File import handler
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const json = JSON.parse(event.target.result);
            bus.publish('invoice.import', { json });
            fileInput.value = ''; // Reset input
          } catch (error) {
            alert('Failed to import file. Please check the file format.');
            console.error('Import error:', error);
          }
        };
        reader.readAsText(file);
      }
    });

    // Invoice selector handler
    invoiceSelect.addEventListener('change', (e) => {
      const id = e.target.value;
      if (id) {
        bus.publish('invoice.load-by-id', { id });
      }
    });

    // Listen to invoice list updates
    bus.subscribe('invoice.list-updated', (data) => {
      const invoices = data.invoices || [];

      invoiceSelect.innerHTML = invoices.length === 0
        ? '<option value="">No invoices</option>'
        : invoices.map(inv => {
            const displayName = inv.invoiceNumber
              ? `${inv.invoiceNumber} - ${inv.customerName}`
              : `${inv.customerName} (${new Date(inv.date).toLocaleDateString()})`;
            return `<option value="${inv.id}">${displayName}</option>`;
          }).join('');
    });

    // Listen to current invoice changes
    bus.subscribe('invoice.current-changed', (data) => {
      invoiceSelect.value = data.id;
    });

    // Listen to save events
    bus.subscribe('invoice.saved', () => {
      saveStatus.textContent = 'Saved ‚úì';
      saveStatus.classList.add('saved');

      setTimeout(() => {
        saveStatus.textContent = 'Auto-saving...';
        saveStatus.classList.remove('saved');
      }, 2000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S to save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        bus.publish('invoice.save', {});
      }

      // Ctrl/Cmd + P to print
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        window.print();
      }

      // Ctrl/Cmd + N for new invoice
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        bus.publish('invoice.new', {});
      }
    });

    console.log('üìÑ Invoice Creator initialized');
    console.log('üí° Keyboard shortcuts:');
    console.log('   Ctrl/Cmd + S: Save');
    console.log('   Ctrl/Cmd + P: Print');
    console.log('   Ctrl/Cmd + N: New Invoice');
  </script>
</body>
</html>
