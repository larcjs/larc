import{PanClient as c}from"../../../core/pan-client.mjs";class h extends HTMLElement{constructor(){super(),this.pc=new c(this),this.authState=null}connectedCallback(){this.resource=(this.getAttribute("resource")||"items").trim(),this.key=(this.getAttribute("key")||"id").trim(),this.baseUrl=(this.getAttribute("base-url")||"").trim().replace(/\/?$/,""),this.listPath=(this.getAttribute("list-path")||`/${this.resource}`).trim(),this.itemPath=(this.getAttribute("item-path")||`/${this.resource}/:id`).trim(),this.updateMethod=(this.getAttribute("update-method")||"PUT").toUpperCase(),this.credentials=(this.getAttribute("credentials")||"").trim(),this.opts=this.#a(),this.authOff=this.pc.subscribe("auth.internal.state",s=>{this.authState=s.data},{retained:!0});const t=`${this.resource}.list.get`,e=`${this.resource}.item.get`,i=`${this.resource}.item.save`,r=`${this.resource}.item.delete`;this.off=[this.pc.subscribe(t,s=>this.#h(s)),this.pc.subscribe(e,s=>this.#c(s)),this.pc.subscribe(i,s=>this.#n(s)),this.pc.subscribe(r,s=>this.#l(s))],this.#i()}disconnectedCallback(){this.off?.forEach(t=>t&&t()),this.authOff?.()}#a(){let t={};const e=this.querySelector('script[type="application/json"]');if(e&&e.textContent?.trim())try{t=JSON.parse(e.textContent.trim())}catch{}return this.credentials&&(t.credentials=this.credentials),t}#t(t){return t.startsWith("/")||(t="/"+t),`${this.baseUrl}${t}`}#o(t){const e=t&&typeof t=="object"?Object.entries(t).filter(([r,s])=>s!=null):[];if(!e.length)return"";const i=new URLSearchParams;for(const[r,s]of e)Array.isArray(s)?s.forEach(a=>i.append(r,String(a))):i.append(r,String(s));return`?${i.toString()}`}async#e(t,{method:e="GET",body:i}={}){const r=Object.assign({method:e},this.opts);r.headers=Object.assign({"Content-Type":"application/json"},this.opts?.headers||{}),this.authState?.authenticated&&this.authState?.token&&(r.headers.Authorization=`Bearer ${this.authState.token}`),i!==void 0&&(r.body=typeof i=="string"?i:JSON.stringify(i));const s=await fetch(t,r),a=await s.text();let o=null;try{o=a?JSON.parse(a):null}catch{}if(!s.ok)throw{status:s.status,statusText:s.statusText,body:o??a};return o}#r(t){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:Array.isArray(t)?t:[]},retain:!0})}#s(t,e={}){try{const i=t&&typeof t=="object"?t[this.key]??t.id:t;if(i==null)return;e&&e.deleted?this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{id:i,deleted:!0}}):this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{item:t},retain:!0})}catch{}}async#i(t){try{const e=this.#t(this.listPath)+this.#o(t),i=await this.#e(e,{method:"GET"}),r=Array.isArray(i)?i:i?.items||i?.data||[];return this.#r(r),r}catch{return this.#r([]),[]}}async#h(t){const e=await this.#i(t?.data);t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,items:e}})}async#c(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this.#t(this.itemPath.replace(":id",encodeURIComponent(String(e))));try{const r=await this.#e(i,{method:"GET"});this.#s(r),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,item:r}})}catch(r){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:r}})}}async#n(t){let e=t?.data?.item??t?.data;(!e||typeof e!="object")&&(e={});const i=!!e[this.key],r=i?this.updateMethod||"PUT":"POST",s=i?this.#t(this.itemPath.replace(":id",encodeURIComponent(String(e[this.key])))):this.#t(this.listPath);try{const a=await this.#e(s,{method:r,body:e}),o=Object.assign({},e,a||{});!o[this.key]&&e[this.key]&&(o[this.key]=e[this.key]),this.#s(o),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,item:o}})}catch(a){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:a}})}await this.#i()}async#l(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this.#t(this.itemPath.replace(":id",encodeURIComponent(String(e))));try{await this.#e(i,{method:"DELETE"}),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,id:e}})}catch(r){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:r,id:e}})}this.#s(e,{deleted:!0}),await this.#i()}}customElements.define("pan-data-connector",h);var p=h;export{h as PanDataConnector,p as default};
