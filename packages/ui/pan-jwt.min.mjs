import{PanClient as h}from"../core/pan-client.mjs";class r extends HTMLElement{constructor(){super(),this.client=new h(this),this.token=null,this.refreshToken=null,this.tokenData=null,this.refreshTimer=null,this.memoryStorage={}}connectedCallback(){this.storageType=this.getAttribute("storage")||"localStorage",this.tokenKey=this.getAttribute("token-key")||"jwt_token",this.refreshKey=this.getAttribute("refresh-key")||"jwt_refresh",this.autoRefresh=this.getAttribute("auto-refresh")!=="false",this.refreshBefore=parseInt(this.getAttribute("refresh-before")||"300"),this.apiUrl=this.getAttribute("api-url")||"",this.loginEndpoint=this.getAttribute("login-endpoint")||"/auth/login",this.refreshEndpoint=this.getAttribute("refresh-endpoint")||"/auth/refresh",this.logoutEndpoint=this.getAttribute("logout-endpoint")||"/auth/logout",this.loadToken(),this.subscribeToMessages(),this.token&&this.scheduleRefresh(),this.publishState()}disconnectedCallback(){this.refreshTimer&&clearTimeout(this.refreshTimer)}subscribeToMessages(){this.client.subscribe("auth.login.request",async e=>{await this.login(e.data.credentials)}),this.client.subscribe("auth.logout.request",async()=>{await this.logout()}),this.client.subscribe("auth.token.refresh",async()=>{await this.refresh()}),this.client.subscribe("auth.state.get",()=>{this.publishState()})}async login(e){try{const t=await fetch(`${this.apiUrl}${this.loginEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Login failed: ${t.statusText}`);const s=await t.json();return this.setToken(s.token||s.access_token),s.refresh_token&&this.setRefreshToken(s.refresh_token),this.client.publish({topic:"auth.login.success",data:{user:s.user,tokenData:this.tokenData}}),this.publishState(),this.autoRefresh&&this.scheduleRefresh(),{success:!0,data:s}}catch(t){return this.client.publish({topic:"auth.login.error",data:{error:t.message}}),{success:!1,error:t.message}}}async logout(){try{this.token&&this.apiUrl&&await fetch(`${this.apiUrl}${this.logoutEndpoint}`,{method:"POST",headers:{Authorization:`Bearer ${this.token}`}})}catch(e){console.warn("Logout endpoint failed:",e)}this.clearToken(),this.clearRefreshToken(),this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.client.publish({topic:"auth.logout",data:{}}),this.publishState()}async refresh(){if(!this.refreshToken)return console.warn("No refresh token available"),{success:!1,error:"No refresh token"};try{const e=await fetch(`${this.apiUrl}${this.refreshEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.refreshToken}`}});if(!e.ok)throw new Error(`Token refresh failed: ${e.statusText}`);const t=await e.json();return this.setToken(t.token||t.access_token),this.client.publish({topic:"auth.token.refreshed",data:{tokenData:this.tokenData}}),this.publishState(),this.autoRefresh&&this.scheduleRefresh(),{success:!0,data:t}}catch(e){return this.client.publish({topic:"auth.token.expired",data:{error:e.message}}),await this.logout(),{success:!1,error:e.message}}}setToken(e){this.token=e,this.tokenData=this.parseToken(e),this.saveToStorage(this.tokenKey,e)}setRefreshToken(e){this.refreshToken=e,this.saveToStorage(this.refreshKey,e)}clearToken(){this.token=null,this.tokenData=null,this.removeFromStorage(this.tokenKey)}clearRefreshToken(){this.refreshToken=null,this.removeFromStorage(this.refreshKey)}loadToken(){this.token=this.loadFromStorage(this.tokenKey),this.refreshToken=this.loadFromStorage(this.refreshKey),this.token&&(this.tokenData=this.parseToken(this.token),this.isExpired()&&(console.warn("Stored token is expired"),this.clearToken()))}parseToken(e){try{const t=e.split(".");if(t.length!==3)return null;const i=t[1].replace(/[-_]/g,a=>a==="-"?"+":"/"),o=atob(i);return JSON.parse(o)}catch(t){return console.error("Failed to parse token:",t),null}}isExpired(){if(!this.tokenData||!this.tokenData.exp)return!0;const e=Math.floor(Date.now()/1e3);return this.tokenData.exp<e}getTimeToExpiry(){if(!this.tokenData||!this.tokenData.exp)return 0;const e=Math.floor(Date.now()/1e3),t=this.tokenData.exp-e;return Math.max(0,t)}scheduleRefresh(){this.refreshTimer&&clearTimeout(this.refreshTimer);const e=this.getTimeToExpiry(),t=Math.max(0,(e-this.refreshBefore)*1e3);t>0&&this.autoRefresh&&(this.refreshTimer=setTimeout(()=>{this.refresh()},t))}getAuthHeader(){return this.token?`Bearer ${this.token}`:null}isAuthenticated(){return this.token!==null&&!this.isExpired()}publishState(){this.client.publish({topic:"auth.state",data:{authenticated:this.isAuthenticated(),token:this.token,tokenData:this.tokenData,expiresIn:this.getTimeToExpiry()},retain:!0})}saveToStorage(e,t){try{this.storageType==="localStorage"?localStorage.setItem(e,t):this.storageType==="sessionStorage"?sessionStorage.setItem(e,t):this.memoryStorage[e]=t}catch(s){console.error("Failed to save to storage:",s)}}loadFromStorage(e){try{return this.storageType==="localStorage"?localStorage.getItem(e):this.storageType==="sessionStorage"?sessionStorage.getItem(e):this.memoryStorage[e]||null}catch(t){return console.error("Failed to load from storage:",t),null}}removeFromStorage(e){try{this.storageType==="localStorage"?localStorage.removeItem(e):this.storageType==="sessionStorage"?sessionStorage.removeItem(e):delete this.memoryStorage[e]}catch(t){console.error("Failed to remove from storage:",t)}}}customElements.define("pan-jwt",r);var u=r;export{r as PanJWT,u as default};
