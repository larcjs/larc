import{PanClient as c}from"../core/pan-client.mjs";class o extends HTMLElement{static get observedAttributes(){return["topics","src","worker-type"]}constructor(){super(),this.pc=new c(this),this._offs=[],this._url=null}connectedCallback(){this.#t()}disconnectedCallback(){this.#e()}attributeChangedCallback(){this.#r()}get topics(){const t=(this.getAttribute("topics")||"").trim();return t?t.split(/\s+/):[]}get workerType(){return(this.getAttribute("worker-type")||"classic").toLowerCase()==="module"?"module":"classic"}async#t(){try{this.worker||await this.#s(),this.#i()}catch(t){this.pc.publish({topic:"pan:sys.error",data:{code:"PAN_WORKER_INIT",message:String(t&&t.message||t)}})}}#e(){if(this._offs.forEach(t=>t&&t()),this._offs=[],this.worker&&(this.worker.terminate(),this.worker=null),this._url){try{URL.revokeObjectURL(this._url)}catch{}this._url=null}}#r(){this.#e(),this.#t()}async#s(){const t=(this.getAttribute("src")||"").trim();if(t)this.worker=new Worker(t,{type:this.workerType});else{const r=this.querySelector('script[type="application/worker"],script[type="text/worker"],script[type="text/plain"]')?.textContent||"",s=new Blob([r],{type:"text/javascript"}),i=URL.createObjectURL(s);this._url=i,this.worker=new Worker(i,{type:this.workerType})}this.worker.onmessage=e=>{const r=e.data;if(!r)return;const s=r.topic?r:r.msg;s&&s.topic&&this.pc.publish(s)}}#i(){if(this._offs.forEach(e=>e&&e()),this._offs=[],!this.worker)return;const t=e=>{try{this.worker.postMessage({topic:e.topic,data:e.data,replyTo:e.replyTo,correlationId:e.correlationId,headers:e.headers})}catch{}};for(const e of this.topics)this._offs.push(this.pc.subscribe(e,t,{retained:!0}))}}customElements.define("pan-worker",o);var h=o;export{o as PanWorker,h as default};
