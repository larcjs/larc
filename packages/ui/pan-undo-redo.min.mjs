class h extends HTMLElement{static observedAttributes=["topics","max-history","channel","auto-snapshot","snapshot-interval","debug"];constructor(){super(),this._history=[],this._future=[],this._currentState=new Map,this._subscriptions=new Map,this._controlSubs=[],this._panClient=null,this._autoSnapshotTimer=null,this._pendingChanges=new Map,this._batchTimer=null}connectedCallback(){this._waitForPanBus().then(()=>{this._initialize()})}disconnectedCallback(){this._cleanup()}attributeChangedCallback(t,s,i){s!==i&&(t==="topics"||t==="channel"?(this._cleanup(),this._initialize()):t==="auto-snapshot"&&(this.hasAttribute("auto-snapshot")?this._startAutoSnapshot():this._stopAutoSnapshot()))}async _waitForPanBus(){let t=document.querySelector("pan-bus");if(!(t&&t.panClient))return new Promise(s=>{const i=setInterval(()=>{t=document.querySelector("pan-bus"),t&&t.panClient&&(clearInterval(i),s())},50);setTimeout(()=>{clearInterval(i),s()},5e3)})}_initialize(){if(this._panClient=this._getPanClient(),!this._panClient){console.error("pan-undo-redo could not find pan-client");return}const t=this.getAttribute("topics");if(t){const i=t.split(",").map(e=>e.trim());for(const e of i)this._subscribeToTopic(e)}const s=this.getAttribute("channel")||"history";this._controlSubs.push(this._panClient.subscribe(`${s}.undo`,()=>this.undo())),this._controlSubs.push(this._panClient.subscribe(`${s}.redo`,()=>this.redo())),this._controlSubs.push(this._panClient.subscribe(`${s}.clear`,()=>this.clear())),this._controlSubs.push(this._panClient.subscribe(`${s}.snapshot`,()=>this.snapshot())),this.hasAttribute("auto-snapshot")&&this._startAutoSnapshot(),this._log("Initialized",{channel:s,maxHistory:this.getAttribute("max-history")}),this._publishState()}_cleanup(){for(const[t,s]of this._subscriptions.entries())this._panClient?.unsubscribe(t,s);this._subscriptions.clear();for(const t of this._controlSubs)typeof t=="function"&&t();this._controlSubs=[],this._stopAutoSnapshot(),this._batchTimer&&(clearTimeout(this._batchTimer),this._batchTimer=null)}_subscribeToTopic(t){if(this._subscriptions.has(t))return;const s=i=>{i.meta?.source!=="undo-redo"&&this._trackChange(i.topic,i.data)};this._panClient.subscribe(t,s),this._subscriptions.set(t,s),this._log("Subscribed to topic",{pattern:t})}_trackChange(t,s){const i=this._currentState.get(t);this._currentState.set(t,s),this._pendingChanges.set(t,{oldValue:i,newValue:s}),this._batchTimer&&clearTimeout(this._batchTimer),this._batchTimer=setTimeout(()=>{this._commitBatch()},100)}_commitBatch(){if(this._pendingChanges.size===0)return;const t={timestamp:Date.now(),changes:new Map(this._pendingChanges)};this._future=[],this._history.push(t);const s=parseInt(this.getAttribute("max-history")||"50",10);this._history.length>s&&this._history.shift(),this._pendingChanges.clear(),this._publishState(),this._log("Committed batch",{changes:t.changes.size,historySize:this._history.length})}_startAutoSnapshot(){this._stopAutoSnapshot();const t=parseInt(this.getAttribute("snapshot-interval")||"5000",10);this._autoSnapshotTimer=setInterval(()=>{this._pendingChanges.size>0&&this._commitBatch()},t),this._log("Auto-snapshot enabled",{interval:t})}_stopAutoSnapshot(){this._autoSnapshotTimer&&(clearInterval(this._autoSnapshotTimer),this._autoSnapshotTimer=null)}undo(){if(this._history.length===0)return this._log("Nothing to undo"),!1;this._pendingChanges.size>0&&this._commitBatch();const t=this._history.pop();this._future.push(t);for(const[s,{oldValue:i}]of t.changes.entries())this._currentState.set(s,i),this._panClient.publish(s,i,{retain:!0,meta:{source:"undo-redo",action:"undo",timestamp:t.timestamp}});return this._publishState(),this._log("Undo",{changes:t.changes.size,historySize:this._history.length}),!0}redo(){if(this._future.length===0)return this._log("Nothing to redo"),!1;const t=this._future.pop();this._history.push(t);for(const[s,{newValue:i}]of t.changes.entries())this._currentState.set(s,i),this._panClient.publish(s,i,{retain:!0,meta:{source:"undo-redo",action:"redo",timestamp:t.timestamp}});return this._publishState(),this._log("Redo",{changes:t.changes.size,futureSize:this._future.length}),!0}clear(){this._history=[],this._future=[],this._pendingChanges.clear(),this._batchTimer&&(clearTimeout(this._batchTimer),this._batchTimer=null),this._publishState(),this._log("History cleared")}snapshot(){this._pendingChanges.size>0&&this._commitBatch(),this._log("Manual snapshot")}_publishState(){const t=this.getAttribute("channel")||"history";this._panClient.publish(`${t}.state`,{canUndo:this._history.length>0,canRedo:this._future.length>0,historySize:this._history.length,futureSize:this._future.length,maxHistory:parseInt(this.getAttribute("max-history")||"50",10),timestamp:Date.now()},{retain:!0})}_getPanClient(){if(this._panClient)return this._panClient;const s=document.querySelector("pan-bus")?.panClient||document.querySelector("pan-client");return s&&(this._panClient=s.client||s),this._panClient}_log(...t){this.hasAttribute("debug")&&console.log("[pan-undo-redo]",...t)}get canUndo(){return this._history.length>0}get canRedo(){return this._future.length>0}get historySize(){return this._history.length}get futureSize(){return this._future.length}getHistory(){return this._history.map(t=>({timestamp:t.timestamp,changes:Array.from(t.changes.entries()).map(([s,{oldValue:i,newValue:e}])=>({topic:s,oldValue:i,newValue:e}))}))}getCurrentState(){return new Map(this._currentState)}goToTimestamp(t){const s=this._history.findIndex(n=>n.timestamp===t);if(s===-1)return this._log("Snapshot not found",{timestamp:t}),!1;const e=this._history.length-1-s;if(e>0)for(let n=0;n<e;n++)this.undo();else if(e<0)for(let n=0;n<Math.abs(e);n++)this.redo();return!0}}customElements.define("pan-undo-redo",h);export{h as PanUndoRedo};
