import{PanClient as b}from"../core/pan-client.mjs";class f extends HTMLElement{static get observedAttributes(){return["resource","key","live"]}constructor(){super(),this.attachShadow({mode:"open"}),this.pc=new b(this),this.schema=null,this.value={},this._offs=[],this._offLive=null,this._selectedId=null}connectedCallback(){this.render(),this.#t()}disconnectedCallback(){this.#r()}attributeChangedCallback(){this.render(),this.#t()}get resource(){return(this.getAttribute("resource")||"items").trim()}get key(){return(this.getAttribute("key")||"id").trim()}get live(){const e=(this.getAttribute("live")||"true").toLowerCase();return e!=="false"&&e!=="0"}#t(){this.#r(),this._offs.push(this.pc.subscribe(`${this.resource}.schema.state`,s=>{this.schema=s?.data?.schema||null,this.render()},{retained:!0})),this._offs.push(this.pc.subscribe(`${this.resource}.item.select`,async s=>{const r=s?.data?.id;if(r){this._selectedId=r,this.#s();try{const{data:a}=await this.pc.request(`${this.resource}.item.get`,{id:r});this.#e(a?.item||{})}catch{}}}));const e=this.shadowRoot.getElementById("f");e&&(e.onsubmit=s=>{s.preventDefault(),this.#o()});const t=this.shadowRoot.getElementById("del");t&&(t.onclick=s=>{s.preventDefault(),this.#n()})}#r(){try{this._offs.forEach(e=>e&&e())}catch{}this._offs=[];try{this._offLive&&this._offLive()}catch{}this._offLive=null}#s(){try{this._offLive&&this._offLive()}catch{}if(this._offLive=null,!this.live)return;const e=this._selectedId||this.value?.[this.key]||this.value?.id;if(!e)return;const t=`${this.resource}.item.state.${e}`;this._offLive=this.pc.subscribe(t,s=>{const r=s?.data||{};if(r.deleted){const a=this.value?.[this.key]||this.value?.id;String(a)===String(e)&&this.#e({});return}if(r.item&&typeof r.item=="object"){this.#e(r.item);return}if(r.patch&&typeof r.patch=="object"){this.#e(Object.assign({},this.value||{},r.patch));return}r&&typeof r=="object"&&this.#e(Object.assign({},this.value||{},r))},{retained:!1})}async#o(){const e=this.#l(),t=this.#h(e);if(this.#u(t),!(t&&t.length))try{const{data:s}=await this.pc.request(`${this.resource}.item.save`,{item:e}),r=s?.item||e;this.#e(r),this._selectedId=r?.[this.key]||r?.id||this._selectedId,this.#s()}catch{}}async#n(){const e=this.value?.[this.key]||this.value?.id;if(e)try{await this.pc.request(`${this.resource}.item.delete`,{id:e}),this.#e({})}catch{}}#l(){const e=Object.assign({},this.value||{}),t=this.schema?.properties||{},s=this.#i();for(const r of s){const a=this.shadowRoot.querySelector(`[name="${r}"]`);a&&(e[r]=this.#c(t[r],a))}return e}#c(e,t){const s=e&&e.type||"string";if(s==="boolean")return!!t.checked;if(s==="number"||s==="integer"){const r=Number(t.value);return Number.isFinite(r)?s==="integer"?Math.trunc(r):r:void 0}return t.value}#h(e){const t=[],s=this.schema?.properties||{},r=Array.isArray(this.schema?.required)?this.schema.required:[];for(const a of r){const o=e[a];(o==null||o==="")&&t.push({name:a,message:"Required"})}for(const[a,o]of Object.entries(s)){const i=e[a];if(i==null||i==="")continue;const n=o.type||"string";if((n==="number"||n==="integer")&&(typeof i!="number"||!Number.isFinite(i))&&t.push({name:a,message:"Must be a number"}),n==="boolean"&&typeof i!="boolean"&&t.push({name:a,message:"Must be true/false"}),o.pattern&&typeof i=="string")try{new RegExp(o.pattern).test(i)||t.push({name:a,message:"Invalid format"})}catch{}o.minLength!=null&&typeof i=="string"&&i.length<o.minLength&&t.push({name:a,message:`Min length ${o.minLength}`}),o.maxLength!=null&&typeof i=="string"&&i.length>o.maxLength&&t.push({name:a,message:`Max length ${o.maxLength}`}),o.minimum!=null&&typeof i=="number"&&i<o.minimum&&t.push({name:a,message:`>= ${o.minimum}`}),o.maximum!=null&&typeof i=="number"&&i>o.maximum&&t.push({name:a,message:`<= ${o.maximum}`}),Array.isArray(o.enum)&&!o.enum.includes(i)&&t.push({name:a,message:"Invalid value"}),o.format==="email"&&typeof i=="string"&&(/.+@.+\..+/.test(i)||t.push({name:a,message:"Invalid email"}))}return t}#u(e){const t=new Map((e||[]).map(s=>[s.name,s.message]));this.shadowRoot.querySelectorAll(".err").forEach(s=>s.textContent="");for(const[s,r]of t){const a=this.shadowRoot.querySelector(`.err[data-for="${s}"]`);a&&(a.textContent=r)}}#e(e){this.value=e||{},this.render(),this.#t()}#i(){const e=this.schema?.properties||{},t=Object.keys(e),s=this.schema&&(this.schema["ui:order"]||this.schema.uiOrder||null);return Array.isArray(s)?t.sort((r,a)=>(s.indexOf(r)===-1?1:s.indexOf(r))-(s.indexOf(a)===-1?1:s.indexOf(a))):t}render(){const e=String.raw,t=this.schema?.properties||{},s=this.#i(),r=this.value||{},a=this.key,o=s.map(i=>{const n=t[i]||{},l=n.type||"string",c=n.title||i,h=n.description||"",d=Array.isArray(this.schema?.required)&&this.schema.required.includes(i),u=r[i]??"";if(Array.isArray(n.enum))return e`<label class="row"><span class="lab">${c}${d?" *":""}</span>
          <select name="${i}">${n.enum.map(m=>`<option value="${String(m)}" ${String(m)===String(u)?"selected":""}>${String(m)}</option>`).join("")}</select>
          <small class="hint">${h}</small><small class="err" data-for="${i}"></small></label>`;if(l==="boolean")return e`<label class="row chk"><input type="checkbox" name="${i}" ${u?"checked":""}/><span>${c}</span><small class="hint">${h}</small><small class="err" data-for="${i}"></small></label>`;const p=l==="number"||l==="integer"?"number":n.format==="email"?"email":"text";return n.maxLength&&n.maxLength>180||n.format==="multiline"?e`<label class="row"><span class="lab">${c}${d?" *":""}</span>
          <textarea name="${i}" rows="4">${this.#a(u)}</textarea>
          <small class="hint">${h}</small><small class="err" data-for="${i}"></small></label>`:e`<label class="row"><span class="lab">${c}${d?" *":""}</span>
        <input type="${p}" name="${i}" value="${this.#a(u)}" />
        <small class="hint">${h}</small><small class="err" data-for="${i}"></small></label>`}).join("");this.shadowRoot.innerHTML=e`
      <style>
        :host{display:block; border:1px solid var(--color-border, #ddd); border-radius:8px; padding:12px; font:13px/1.4 system-ui, sans-serif; background: var(--color-surface, white); color: var(--color-text, inherit)}
        form{ display:grid; gap:10px }
        .row{ display:grid; gap:6px }
        .row.chk{ grid-template-columns: auto 1fr; align-items:center }
        .lab{ font-weight:600 }
        input,select,textarea{ padding:8px 10px; font:inherit; border:1px solid var(--color-border, #e2e2e2); border-radius:8px; background: var(--color-surface, white); color: var(--color-text, inherit) }
        button{ padding:8px 10px; font:inherit; border:1px solid var(--color-border, #ddd); border-radius:8px; background: var(--color-surface, white); color: var(--color-text, inherit); cursor:pointer }
        button:hover{ background: var(--color-surface-alt, #f5f5f5) }
        button[type="submit"]{ background: var(--color-primary, #006699); color: white; border-color: var(--color-primary, #006699) }
        button[type="submit"]:hover{ background: var(--color-primary-dark, #004d73) }
        .actions{ display:flex; gap:8px; align-items:center }
        .hint{ color: var(--color-text-muted, #888) }
        .err{ color: var(--color-danger, #c33) }
      </style>
      <form id="f">
        ${o}
        <div class="actions">
          <button id="save" type="submit">Save</button>
          <span style="flex:1"></span>
          <button id="del" type="button">Delete</button>
        </div>
      </form>
    `,this.#s()}#a(e){return String(e??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}}customElements.define("pan-schema-form",f);var x=f;export{f as PanSchemaForm,x as default};
