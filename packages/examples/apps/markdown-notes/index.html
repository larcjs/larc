<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Markdown Notes ‚Äî PAN Demo App</title>
  <link rel="stylesheet" href="../assets/theme.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      background: var(--color-surface, #ffffff);
      border-bottom: 2px solid var(--color-border, #e2e8f0);
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-primary, #006699);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .current-file {
      font-size: 0.875rem;
      color: var(--color-text-muted, #64748b);
    }

    .current-file .filename {
      color: var(--color-text, #1e293b);
      font-weight: 500;
    }

    .toolbar-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--color-primary, #006699);
      border-color: var(--color-primary, #006699);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-primary-dark, #004d73);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--color-surface, #ffffff);
      border-color: var(--color-border, #e2e8f0);
      color: var(--color-text, #1e293b);
    }

    .btn-secondary:hover {
      background: var(--color-bg-alt, #f8fafc);
      border-color: var(--color-border-strong, #cbd5e1);
    }

    /* Main Content */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 280px;
      border-right: 1px solid var(--color-border, #e2e8f0);
      display: flex;
      flex-direction: column;
      background: var(--color-bg-alt, #f8fafc);
    }

    .sidebar.collapsed {
      width: 0;
      border-right: none;
      overflow: hidden;
    }

    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    pan-files {
      flex: 1;
      overflow: hidden;
    }

    pan-markdown-editor {
      flex: 1;
      overflow: hidden;
    }

    /* Welcome screen */
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 2rem;
      text-align: center;
    }

    .welcome-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .welcome-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--color-text, #1e293b);
      margin-bottom: 0.5rem;
    }

    .welcome-text {
      color: var(--color-text-muted, #64748b);
      margin-bottom: 2rem;
      max-width: 500px;
    }

    .welcome-actions {
      display: flex;
      gap: 1rem;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        left: 0;
        top: 57px;
        bottom: 0;
        z-index: 20;
        box-shadow: var(--shadow-xl);
        width: 280px;
      }

      .sidebar.collapsed {
        left: -280px;
      }

      .current-file {
        display: none;
      }
    }

    /* Unsaved indicator */
    .unsaved-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-warning, #f59e0b);
      display: none;
    }

    .unsaved-indicator.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <button class="btn-secondary" id="toggle-sidebar" style="padding: 0.5rem 0.75rem;">
          üìÇ
        </button>
        <h1 class="app-title">
          üìù Markdown Notes
          <span class="unsaved-indicator" id="unsaved-indicator"></span>
        </h1>
        <div class="current-file">
          <span class="filename" id="current-filename">No file open</span>
        </div>
      </div>

      <div class="toolbar-actions">
        <button class="btn btn-secondary" id="btn-new">
          ‚ûï New
        </button>
        <button class="btn btn-primary" id="btn-save">
          üíæ Save
        </button>
        <button class="btn btn-secondary" id="btn-export">
          üì§ Export
        </button>
        <pan-theme-toggle variant="icon"></pan-theme-toggle>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <pan-files filter=".md"></pan-files>
      </div>

      <!-- Editor Area -->
      <div class="editor-area" id="editor-area">
        <!-- Welcome Screen (shown initially) -->
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-icon">üìù</div>
          <h2 class="welcome-title">Welcome to Markdown Notes</h2>
          <p class="welcome-text">
            A powerful markdown editor with file management, built entirely with PAN components.
            All your notes are stored in your browser's private filesystem.
          </p>
          <div class="welcome-actions">
            <button class="btn btn-primary" id="btn-welcome-new">
              ‚ûï Create New Note
            </button>
            <button class="btn btn-secondary" id="btn-welcome-open">
              üìÇ Open Existing
            </button>
          </div>
        </div>

        <!-- Editor (hidden initially) -->
        <pan-markdown-editor
          id="editor"
          preview="true"
          autosave="false"
          style="display: none;">
        </pan-markdown-editor>
      </div>
    </div>
  </div>

  <!-- Components -->
  <pan-bus></pan-bus>
  <pan-theme-provider theme="auto"></pan-theme-provider>

  <script type="module">
    import '/larc/packages/components/pan-bus.mjs';
    import '/larc/packages/components/pan-markdown-editor.mjs';
    import '/larc/packages/components/pan-markdown-renderer.mjs';
    import '/larc/packages/components/pan-files.mjs';
    import '/larc/packages/components/pan-theme-provider.mjs';
    import '/larc/packages/components/pan-theme-toggle.mjs';

    // State
    let currentFile = null;
    let isModified = false;

    // Get elements
    const bus = document.querySelector('pan-bus');
    const editor = document.getElementById('editor');
    const files = document.querySelector('pan-files');
    const welcomeScreen = document.getElementById('welcome-screen');
    const sidebar = document.getElementById('sidebar');
    const filenameDisplay = document.getElementById('current-filename');
    const unsavedIndicator = document.getElementById('unsaved-indicator');

    // Initialize
    init();

    async function init() {
      // Check if any files exist
      const fileList = await files.listFiles();
      if (fileList.length === 0) {
        showWelcome();
      }
    }

    function showWelcome() {
      welcomeScreen.style.display = 'flex';
      editor.style.display = 'none';
    }

    function showEditor() {
      welcomeScreen.style.display = 'none';
      editor.style.display = 'block';
    }

    // File management
    async function createNewFile() {
      const filename = prompt('Enter file name (with .md extension):', 'untitled.md');
      if (!filename) return;

      // Ensure .md extension
      const finalName = filename.endsWith('.md') ? filename : filename + '.md';

      currentFile = '/' + finalName;
      editor.setValue('# New Document\n\nStart writing...');
      isModified = true;
      updateUI();
      showEditor();

      // Auto-save empty file
      await saveFile();
    }

    async function openFile(path) {
      // Save current file if modified
      if (isModified && currentFile) {
        if (confirm('Save changes to current file?')) {
          await saveFile();
        }
      }

      currentFile = path;
      isModified = false;

      try {
        const content = await files.readFile(path);
        editor.setValue(content);
        updateUI();
        showEditor();
      } catch (error) {
        alert('Failed to open file: ' + error.message);
      }
    }

    async function saveFile() {
      if (!currentFile) {
        await createNewFile();
        return;
      }

      try {
        const content = editor.getValue();
        await files.writeFile(currentFile, content);
        isModified = false;
        updateUI();
        await files.refresh();

        // Show save feedback
        const btn = document.getElementById('btn-save');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úì Saved';
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);
      } catch (error) {
        alert('Failed to save file: ' + error.message);
      }
    }

    function exportFile() {
      if (!currentFile) return;

      const content = editor.getValue();
      const blob = new Blob([content], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = currentFile.split('/').pop();
      a.click();

      URL.revokeObjectURL(url);
    }

    function updateUI() {
      if (currentFile) {
        filenameDisplay.textContent = currentFile.split('/').pop();
      } else {
        filenameDisplay.textContent = 'No file open';
      }

      if (isModified) {
        unsavedIndicator.classList.add('show');
      } else {
        unsavedIndicator.classList.remove('show');
      }
    }

    // Event handlers
    document.getElementById('btn-new').addEventListener('click', createNewFile);
    document.getElementById('btn-save').addEventListener('click', saveFile);
    document.getElementById('btn-export').addEventListener('click', exportFile);

    document.getElementById('btn-welcome-new').addEventListener('click', createNewFile);
    document.getElementById('btn-welcome-open').addEventListener('click', () => {
      sidebar.classList.remove('collapsed');
    });

    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });

    // PAN event listeners
    bus.subscribe('file.selected', async (data) => {
      if (!data.isDirectory) {
        await openFile(data.path);
      }
    });

    bus.subscribe('markdown.changed', () => {
      isModified = true;
      updateUI();
    });

    bus.subscribe('file.created', async (data) => {
      if (!data.isDirectory && data.path.endsWith('.md')) {
        await openFile(data.path);
      }
    });

    bus.subscribe('file.deleted', () => {
      if (currentFile) {
        currentFile = null;
        isModified = false;
        updateUI();
        showWelcome();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S to save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveFile();
      }

      // Ctrl/Cmd + N for new file
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        createNewFile();
      }

      // Ctrl/Cmd + B to toggle sidebar
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        sidebar.classList.toggle('collapsed');
      }
    });

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (isModified) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    console.log('üìù Markdown Notes initialized');
    console.log('üí° Keyboard shortcuts:');
    console.log('   Ctrl/Cmd + S: Save');
    console.log('   Ctrl/Cmd + N: New File');
    console.log('   Ctrl/Cmd + B: Toggle Sidebar');
  </script>
</body>
</html>
