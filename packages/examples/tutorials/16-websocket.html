<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>16 · WebSocket Bridge — LARC PAN</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/grail.css">
  <style>
    .connection-status {
      padding: 1rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 0.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #94a3b8;
    }

    .status-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.connecting {
      background: #f59e0b;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .status-indicator.disconnected {
      background: #ef4444;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-weight: 600;
      color: var(--color-text);
    }

    .chat-container {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 0.5rem;
      display: flex;
      flex-direction: column;
      height: 400px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .message {
      padding: 0.75rem;
      border-radius: 0.5rem;
      max-width: 80%;
    }

    .message.sent {
      align-self: flex-end;
      background: var(--color-accent);
      color: white;
    }

    .message.received {
      align-self: flex-start;
      background: var(--color-accent-soft);
      color: var(--color-text);
    }

    .message.system {
      align-self: center;
      background: transparent;
      color: var(--color-muted);
      font-size: 0.875rem;
      font-style: italic;
      max-width: 100%;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .chat-input-area {
      padding: 1rem;
      border-top: 1px solid var(--color-border);
      display: flex;
      gap: 0.75rem;
    }

    .chat-input {
      flex: 1;
      padding: 0.625rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 0.375rem;
      font-family: inherit;
      font-size: 0.95rem;
      background: var(--color-bg);
      color: var(--color-text);
    }

    .send-button {
      padding: 0.625rem 1.5rem;
      background: var(--color-accent);
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .send-button:hover {
      opacity: 0.9;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .demo-note {
      padding: 1rem;
      background: var(--color-accent-soft);
      border: 1px solid var(--color-accent);
      border-radius: 0.5rem;
      margin-bottom: 2rem;
      color: var(--color-text);
      line-height: 1.6;
    }

    .demo-note strong {
      color: var(--color-accent);
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <aside class="sidebar">
      <div class="logo-area">
        <div class="logo-text">
          <div class="logo-title">LARC · PAN</div>
          <div class="logo-subtitle">Example 16</div>
        </div>
      </div>
      <div class="demo-info">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title-area">
              <div class="title">WebSocket Bridge</div>
              <div class="subtitle">Bidirectional realtime with <code>pan-websocket</code></div>
            </div>
            <div class="toolbar">
              <a class="button-link" href="/larc/packages/components/pan-websocket.mjs">View source</a>
            </div>
          </div>
          <div class="panel-body">
            <p style="line-height:1.6;">
              Demonstrates bidirectional WebSocket communication bridged to PAN topics.
              Features automatic reconnection, heartbeat, and topic filtering.
            </p>
          </div>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="demo-note">
        <strong>Note:</strong> This demo requires a WebSocket server running on <code>ws://localhost:8080</code>.
        The component will attempt to connect and show connection status below.
        In production, messages sent via PAN topics would be forwarded to the server and vice versa.
      </div>

      <div class="connection-status">
        <div class="status-indicator" id="status-indicator"></div>
        <div class="status-text" id="status-text">Disconnected</div>
      </div>

      <div class="chat-container">
        <div class="chat-messages" id="messages">
          <div class="message system">
            Waiting for connection...
          </div>
        </div>
        <div class="chat-input-area">
          <input
            type="text"
            class="chat-input"
            id="message-input"
            placeholder="Type a message..."
            disabled
          >
          <button class="send-button" id="send-button" disabled>Send</button>
        </div>
      </div>

      <div class="inspector-area">
        <div class="inspector-header">
          <span class="inspector-title">PAN Inspector</span>
          <span class="inspector-subtitle">WebSocket & chat events</span>
        </div>
        <pan-inspector style="height:100%;"></pan-inspector>
      </div>
    </main>
  </div>

  <!-- PAN Components -->
  <pan-websocket
    url="ws://localhost:8080"
    outbound-topics="chat.*"
    inbound-topics="chat.* server.*"
    auto-reconnect="true"
    heartbeat="30">
  </pan-websocket>

  <script type="module">
    import { PanClient } from '../../core/pan-client.mjs';

    const pc = new PanClient();
    const messages = document.getElementById('messages');
    const input = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');

    let isConnected = false;

    // Connection status updates
    pc.subscribe('ws.connected', (msg) => {
      isConnected = true;
      statusIndicator.className = 'status-indicator connected';
      statusText.textContent = 'Connected';
      input.disabled = false;
      sendButton.disabled = false;
      addSystemMessage('Connected to server');
    });

    pc.subscribe('ws.disconnected', (msg) => {
      isConnected = false;
      statusIndicator.className = 'status-indicator disconnected';
      statusText.textContent = 'Disconnected - Reconnecting...';
      statusIndicator.classList.add('connecting');
      input.disabled = true;
      sendButton.disabled = true;
      addSystemMessage(`Disconnected (${msg.data.reason || 'unknown reason'})`);
    });

    pc.subscribe('ws.error', (msg) => {
      addSystemMessage(`Error: ${msg.data.error}`);
    });

    // Chat messages
    pc.subscribe('chat.message', (msg) => {
      // Determine if this is our message or from another client
      const isSent = msg.data.clientId === pc.clientId;
      addMessage(msg.data.text, isSent ? 'sent' : 'received');
    });

    // Server announcements
    pc.subscribe('server.announcement', (msg) => {
      addSystemMessage(msg.data.text);
    });

    // Send message function
    function sendMessage() {
      const text = input.value.trim();
      if (!text || !isConnected) return;

      pc.publish({
        topic: 'chat.message',
        data: {
          text,
          clientId: pc.clientId,
          timestamp: Date.now()
        }
      });

      input.value = '';
    }

    // UI event handlers
    sendButton.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Helper functions
    function addMessage(text, type = 'received') {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      const textDiv = document.createElement('div');
      textDiv.textContent = text;

      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date().toLocaleTimeString();

      msg.appendChild(textDiv);
      msg.appendChild(timeDiv);

      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    function addSystemMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'message system';
      msg.textContent = text;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // Initial status
    setTimeout(() => {
      if (!isConnected) {
        statusIndicator.className = 'status-indicator connecting';
        statusText.textContent = 'Connecting...';
      }
    }, 100);
  </script>

  <!-- Autoload all components -->
  <script type="module">
    if (!customElements.get('pan-bus')) {
      await import('../../core/pan-bus.mjs');
    // Load autoload system to discover and load custom elements on demand
    await import('../src/pan.mjs');
    }
  </script>

  <pan-bus debug="true"></pan-bus>
</body>
</html>
