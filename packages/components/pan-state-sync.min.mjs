class l extends HTMLElement{static observedAttributes=["channel","topics","strategy","leader","debug"];constructor(){super(),this._channel=null,this._subscriptions=new Map,this._isLeader=!1,this._leaderId=null,this._tabId=this._generateTabId(),this._messageQueue=[],this._processing=!1,this._stateCache=new Map,this._boundHandleMessage=this._handleBroadcastMessage.bind(this),this._boundHandleVisibilityChange=this._handleVisibilityChange.bind(this),this._heartbeatInterval=null,this._leaderTimeout=null}connectedCallback(){this._initialize(),document.addEventListener("visibilitychange",this._boundHandleVisibilityChange),this.getAttribute("leader")!=="never"&&this._startHeartbeat()}disconnectedCallback(){this._cleanup(),document.removeEventListener("visibilitychange",this._boundHandleVisibilityChange)}attributeChangedCallback(e,t,a){t!==a&&(e==="topics"||e==="channel")&&(this._cleanup(),this._initialize())}_generateTabId(){return`${Date.now()}-${Math.random().toString(36).substring(2,9)}`}_initialize(){const e=this.getAttribute("channel")||"pan-state-sync",t=this.getAttribute("topics")||"*",a=this.getAttribute("leader")||"auto";if(!window.BroadcastChannel){console.error("BroadcastChannel not supported in this browser"),this._publishEvent("sync.error",{error:"BroadcastChannel not supported",tabId:this._tabId});return}this._channel=new BroadcastChannel(e),this._channel.addEventListener("message",this._boundHandleMessage),this._subscribeToTopics(t.split(",").map(s=>s.trim())),a==="always"?this._becomeLeader():a==="auto"&&this._requestLeaderStatus(),this._log("Initialized",{tabId:this._tabId,channel:e,topics:t})}_cleanup(){this._channel&&(this._channel.removeEventListener("message",this._boundHandleMessage),this._channel.close(),this._channel=null);for(const[e,t]of this._subscriptions.entries())this._panClient?.unsubscribe(e,t);this._subscriptions.clear(),this._heartbeatInterval&&(clearInterval(this._heartbeatInterval),this._heartbeatInterval=null),this._leaderTimeout&&(clearTimeout(this._leaderTimeout),this._leaderTimeout=null),this._stateCache.clear()}_subscribeToTopics(e){const t=this._getPanClient();if(t)for(const a of e){if(this._subscriptions.has(a))continue;const s=i=>{this._handleLocalStateChange(a,i)};t.subscribe(a,s),this._subscriptions.set(a,s)}}async _handleLocalStateChange(e,t){if(t.meta?.source==="broadcast-channel")return;const a=t.topic,s=t.data;this._stateCache.set(a,{data:s,timestamp:Date.now(),tabId:this._tabId}),this._broadcastMessage({type:"state-change",topic:a,data:s,timestamp:Date.now(),tabId:this._tabId}),this._log("Broadcasting state change",{topic:a,tabId:this._tabId})}_handleBroadcastMessage(e){const t=e.data;switch(t.type){case"state-change":this._handleRemoteStateChange(t);break;case"request-state":this._handleStateRequest(t);break;case"state-snapshot":this._handleStateSnapshot(t);break;case"heartbeat":this._handleHeartbeat(t);break;case"leader-claim":this._handleLeaderClaim(t);break;default:this._log("Unknown message type",t)}}_handleRemoteStateChange(e){const{topic:t,data:a,timestamp:s,tabId:i}=e;if(i===this._tabId)return;const n=this.getAttribute("strategy")||"last-write-wins",h=this._stateCache.get(t);if(h&&h.timestamp>s)if(n==="last-write-wins"){this._log("Ignoring older state",{topic:t,remoteTime:s,localTime:h.timestamp});return}else this._publishEvent("sync.conflict",{topic:t,local:h,remote:{data:a,timestamp:s,tabId:i},strategy:n});this._stateCache.set(t,{data:a,timestamp:s,tabId:i});const r=this._getPanClient();r&&(r.publish(t,a,{retain:!0,meta:{source:"broadcast-channel",tabId:i}}),this._log("Applied remote state",{topic:t,tabId:i}))}_handleStateRequest(e){if(!this._isLeader)return;const t={};for(const[a,s]of this._stateCache.entries())t[a]=s;this._broadcastMessage({type:"state-snapshot",snapshot:t,timestamp:Date.now(),tabId:this._tabId}),this._log("Sent state snapshot",{requestor:e.tabId,topics:Object.keys(t).length})}_handleStateSnapshot(e){const{snapshot:t,tabId:a}=e;if(a===this._tabId)return;const s=this._getPanClient();if(s){for(const[i,n]of Object.entries(t))this._stateCache.set(i,n),s.publish(i,n.data,{retain:!0,meta:{source:"broadcast-channel",tabId:n.tabId}});this._log("Applied state snapshot",{from:a,topics:Object.keys(t).length})}}_startHeartbeat(){this._heartbeatInterval=setInterval(()=>{this._broadcastMessage({type:"heartbeat",tabId:this._tabId,isLeader:this._isLeader,timestamp:Date.now()})},5e3),this._checkLeaderTimeout()}_handleHeartbeat(e){const{tabId:t,isLeader:a,timestamp:s}=e;a&&(this._leaderId=t,this._leaderLastSeen=s,this._isLeader&&t!==this._tabId&&(this._isLeader=!1,this._log("Demoted from leader",{newLeader:t})))}_handleLeaderClaim(e){const{tabId:t,timestamp:a}=e;t<this._tabId&&(this._isLeader&&(this._isLeader=!1,this._log("Deferred leadership",{to:t})),this._leaderId=t)}_checkLeaderTimeout(){setInterval(()=>{if(!this._isLeader&&this._leaderLastSeen){const t=Date.now()-this._leaderLastSeen;t>15e3&&(this._log("Leader timeout detected",{lastSeen:t}),this._requestLeaderStatus())}},1e4)}_requestLeaderStatus(){const e=Math.random()*1e3;setTimeout(()=>{!this._leaderId||this._leaderId===this._tabId?this._becomeLeader():this._broadcastMessage({type:"request-state",tabId:this._tabId,timestamp:Date.now()})},e)}_becomeLeader(){this._isLeader=!0,this._leaderId=this._tabId,this._broadcastMessage({type:"leader-claim",tabId:this._tabId,timestamp:Date.now()}),this._publishEvent("sync.leader-elected",{tabId:this._tabId,timestamp:Date.now()}),this._log("Became leader",{tabId:this._tabId})}_handleVisibilityChange(){document.visibilityState==="visible"&&(this._broadcastMessage({type:"request-state",tabId:this._tabId,timestamp:Date.now()}),this._log("Tab visible, requesting state"))}_broadcastMessage(e){if(this._channel)try{this._channel.postMessage(e)}catch(t){this._log("Broadcast error",{error:t.message,message:e})}}_publishEvent(e,t){const a=this._getPanClient();if(!a)return;const i=`${this.getAttribute("channel")||"pan-state-sync"}.${e}`;a.publish(i,t,{retain:!1})}_getPanClient(){if(this._panClient)return this._panClient;const t=document.querySelector("pan-bus")?.panClient||document.querySelector("pan-client");return t&&(this._panClient=t.client||t),this._panClient}_log(...e){this.hasAttribute("debug")&&console.log("[pan-state-sync]",...e)}get tabId(){return this._tabId}get isLeader(){return this._isLeader}get channel(){return this.getAttribute("channel")||"pan-state-sync"}async requestFullSync(){this._broadcastMessage({type:"request-state",tabId:this._tabId,timestamp:Date.now()})}clearCache(){this._stateCache.clear(),this._log("Cache cleared")}getStateCache(){return new Map(this._stateCache)}}customElements.define("pan-state-sync",l);export{l as PanStateSync};
