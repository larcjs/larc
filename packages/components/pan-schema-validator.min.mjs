class u extends HTMLElement{static observedAttributes=["topic","strict","debug"];constructor(){super(),this._schema=null,this._subscription=null,this._panClient=null,this._validators=new Map}connectedCallback(){this._waitForPanBus().then(()=>{this._initialize()})}disconnectedCallback(){this._cleanup()}attributeChangedCallback(e,t,i){t!==i&&e==="topic"&&(this._cleanup(),this._initialize())}async _waitForPanBus(){let e=document.querySelector("pan-bus");if(!(e&&e.panClient))return new Promise(t=>{const i=setInterval(()=>{e=document.querySelector("pan-bus"),e&&e.panClient&&(clearInterval(i),t())},50);setTimeout(()=>{clearInterval(i),t()},5e3)})}_initialize(){if(this._panClient=this._getPanClient(),!this._panClient){console.error("pan-schema-validator could not find pan-client");return}if(this._schema=this._extractSchema(),!this._schema){console.error("pan-schema-validator requires a JSON schema in a <script> element");return}const e=this.getAttribute("topic");if(!e){console.error('pan-schema-validator requires a "topic" attribute');return}this._subscription=this._panClient.subscribe(e,t=>{this._validateMessage(t)}),this._log("Initialized",{topic:e,schema:this._schema})}_cleanup(){this._subscription&&(this._panClient?.unsubscribe(this.getAttribute("topic"),this._subscription),this._subscription=null)}_extractSchema(){const e=this.querySelector('script[type="application/json"]');if(!e)return null;try{return JSON.parse(e.textContent)}catch(t){return console.error("Failed to parse JSON schema:",t),null}}_validateMessage(e){const t=this.validate(e.data,this._schema);t.valid?(this._publishEvent("valid",{topic:e.topic,timestamp:Date.now()}),this._log("Valid message",{topic:e.topic})):(this._publishEvent("invalid",{topic:e.topic,errors:t.errors,timestamp:Date.now()}),this.hasAttribute("strict")?(console.error("Validation failed (strict mode):",{topic:e.topic,errors:t.errors,data:e.data}),this._panClient.publish(`${e.topic}.cancel`,{reason:"validation-failed",errors:t.errors},{retain:!1})):console.warn("Validation warning:",{topic:e.topic,errors:t.errors}),this._log("Invalid message",{topic:e.topic,errors:t.errors}))}validate(e,t,i=""){const n=[];if(t.type){const r=this._getType(e);if(Array.isArray(t.type))t.type.includes(r)||n.push({path:i,message:`Expected type ${t.type.join(" or ")}, got ${r}`});else if(r!==t.type)return n.push({path:i,message:`Expected type ${t.type}, got ${r}`}),{valid:!1,errors:n}}if(t.const!==void 0&&e!==t.const&&n.push({path:i,message:`Expected ${JSON.stringify(t.const)}, got ${JSON.stringify(e)}`}),t.enum&&(t.enum.includes(e)||n.push({path:i,message:`Value must be one of ${JSON.stringify(t.enum)}`})),typeof e=="string"&&(t.minLength!==void 0&&e.length<t.minLength&&n.push({path:i,message:`String length ${e.length} is less than minimum ${t.minLength}`}),t.maxLength!==void 0&&e.length>t.maxLength&&n.push({path:i,message:`String length ${e.length} exceeds maximum ${t.maxLength}`}),t.pattern&&(new RegExp(t.pattern).test(e)||n.push({path:i,message:`String does not match pattern ${t.pattern}`})),t.format&&(this._validateFormat(e,t.format)||n.push({path:i,message:`String does not match format ${t.format}`}))),typeof e=="number"&&(t.minimum!==void 0&&e<t.minimum&&n.push({path:i,message:`Value ${e} is less than minimum ${t.minimum}`}),t.maximum!==void 0&&e>t.maximum&&n.push({path:i,message:`Value ${e} exceeds maximum ${t.maximum}`}),t.multipleOf!==void 0&&e%t.multipleOf!==0&&n.push({path:i,message:`Value ${e} is not a multiple of ${t.multipleOf}`})),Array.isArray(e)&&(t.minItems!==void 0&&e.length<t.minItems&&n.push({path:i,message:`Array length ${e.length} is less than minimum ${t.minItems}`}),t.maxItems!==void 0&&e.length>t.maxItems&&n.push({path:i,message:`Array length ${e.length} exceeds maximum ${t.maxItems}`}),t.uniqueItems&&this._hasDuplicates(e)&&n.push({path:i,message:"Array items must be unique"}),t.items&&e.forEach((r,s)=>{const o=this.validate(r,t.items,`${i}[${s}]`);n.push(...o.errors)})),e!==null&&typeof e=="object"&&!Array.isArray(e)){if(t.required)for(const r of t.required)r in e||n.push({path:i,message:`Missing required property "${r}"`});if(t.properties){for(const[r,s]of Object.entries(t.properties))if(r in e){const o=i?`${i}.${r}`:r,l=this.validate(e[r],s,o);n.push(...l.errors)}}if(t.additionalProperties===!1){const r=new Set(Object.keys(t.properties||{}));for(const s of Object.keys(e))r.has(s)||n.push({path:i,message:`Additional property "${s}" is not allowed`})}}return{valid:n.length===0,errors:n}}_getType(e){return e===null?"null":Array.isArray(e)?"array":typeof e=="number"?Number.isInteger(e)?"integer":"number":typeof e}_validateFormat(e,t){switch(t){case"email":return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);case"uri":case"url":try{return new URL(e),!0}catch{return!1}case"date":return/^\d{4}-\d{2}-\d{2}$/.test(e)&&!isNaN(Date.parse(e));case"time":return/^\d{2}:\d{2}:\d{2}(\.\d+)?(Z|[+-]\d{2}:\d{2})?$/.test(e);case"date-time":return!isNaN(Date.parse(e));case"uuid":return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);case"ipv4":return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)&&e.split(".").every(i=>parseInt(i)<=255);case"ipv6":return/^([\da-f]{1,4}:){7}[\da-f]{1,4}$/i.test(e);default:return!0}}_hasDuplicates(e){const t=new Set;for(const i of e){const n=JSON.stringify(i);if(t.has(n))return!0;t.add(n)}return!1}_publishEvent(e,t){if(!this._panClient)return;const i=this.getAttribute("topic");this._panClient.publish(`${i}.${e}`,t,{retain:!1})}_getPanClient(){if(this._panClient)return this._panClient;const t=document.querySelector("pan-bus")?.panClient||document.querySelector("pan-client");return t&&(this._panClient=t.client||t),this._panClient}_log(...e){this.hasAttribute("debug")&&console.log("[pan-schema-validator]",...e)}getSchema(){return this._schema}setSchema(e){this._schema=e,this._log("Schema updated",e)}}customElements.define("pan-schema-validator",u);export{u as PanSchemaValidator};
