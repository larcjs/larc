import{PanClient as y}from"../../../core/pan-client.mjs";class d extends HTMLElement{static get observedAttributes(){return["database","version","store","key-path","auto-increment","indexes"]}constructor(){super(),this.pc=new y(this),this.db=null,this.initPromise=null}connectedCallback(){this.#i(),this.#r()}disconnectedCallback(){this.db&&(this.db.close(),this.db=null)}attributeChangedCallback(s){["database","version","store"].includes(s)&&this.isConnected&&(this.db&&(this.db.close(),this.db=null),this.#i())}get database(){return this.getAttribute("database")||""}get version(){return Number(this.getAttribute("version"))||1}get store(){return this.getAttribute("store")||""}get keyPath(){return this.getAttribute("key-path")||"id"}get autoIncrement(){return this.hasAttribute("auto-increment")}get indexes(){const s=this.getAttribute("indexes");if(!s)return[];try{return JSON.parse(s)}catch{return[]}}async get(s){return await this.initPromise,this.#e("readonly",t=>t.get(s))}async put(s){return await this.initPromise,this.#e("readwrite",t=>t.put(s))}async add(s){return await this.initPromise,this.#e("readwrite",t=>t.add(s))}async delete(s){return await this.initPromise,this.#e("readwrite",t=>t.delete(s))}async clear(){return await this.initPromise,this.#e("readwrite",s=>s.clear())}async list(s={}){await this.initPromise;const{index:t,range:e,direction:r="next",limit:a}=s;return this.#e("readonly",n=>{const i=t?n.index(t):n,o=e?i.openCursor(e,r):i.openCursor(null,r);return new Promise((u,b)=>{const c=[];o.onsuccess=l=>{const h=l.target.result;h&&(!a||c.length<a)?(c.push(h.value),h.continue()):u(c)},o.onerror=()=>b(o.error)})})}async query(s,t){return await this.initPromise,this.#e("readonly",e=>e.index(s).getAll(t))}async count(s){return await this.initPromise,this.#e("readonly",t=>(s?t.index(s):t).count())}#i(){!this.database||!this.store||(this.initPromise=new Promise((s,t)=>{const e=indexedDB.open(this.database,this.version);e.onerror=()=>{const r=e.error?.message||"Failed to open database";this.#t("init",r),t(new Error(r))},e.onsuccess=()=>{this.db=e.result,this.db.onerror=r=>{this.#t("db",r.target.error?.message||"Database error")},this.pc.publish({topic:`${this.store}.idb.ready`,data:{database:this.database,store:this.store}}),s()},e.onupgradeneeded=r=>{const a=r.target.result;if(!a.objectStoreNames.contains(this.store)){const n=a.createObjectStore(this.store,{keyPath:this.keyPath,autoIncrement:this.autoIncrement});for(const i of this.indexes)i.name&&i.keyPath&&n.createIndex(i.name,i.keyPath,{unique:i.unique||!1,multiEntry:i.multiEntry||!1})}}}))}#r(){const s=this.store;s&&(this.pc.subscribe(`${s}.idb.get`,async t=>{try{const e=await this.get(t.data.key);this.#s("get",{item:e},t.id)}catch(e){this.#t("get",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.put`,async t=>{try{const e=await this.put(t.data.item);this.#s("put",{key:e},t.id)}catch(e){this.#t("put",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.add`,async t=>{try{const e=await this.add(t.data.item);this.#s("add",{key:e},t.id)}catch(e){this.#t("add",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.delete`,async t=>{try{await this.delete(t.data.key),this.#s("delete",{key:t.data.key},t.id)}catch(e){this.#t("delete",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.clear`,async t=>{try{await this.clear(),this.#s("clear",{},t.id)}catch(e){this.#t("clear",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.list`,async t=>{try{const e=await this.list(t.data);this.#s("list",{items:e},t.id)}catch(e){this.#t("list",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.query`,async t=>{try{const e=await this.query(t.data.index,t.data.value);this.#s("query",{items:e},t.id)}catch(e){this.#t("query",e.message,t.id)}}),this.pc.subscribe(`${s}.idb.count`,async t=>{try{const e=await this.count(t.data.index);this.#s("count",{count:e},t.id)}catch(e){this.#t("count",e.message,t.id)}}))}#e(s,t){return new Promise((e,r)=>{if(!this.db){r(new Error("Database not initialized"));return}try{const n=this.db.transaction(this.store,s).objectStore(this.store),i=t(n);i&&i.onsuccess!==void 0?(i.onsuccess=()=>e(i.result),i.onerror=()=>r(i.error)):i instanceof Promise?i.then(e).catch(r):e(i)}catch(a){r(a)}})}#s(s,t,e){this.pc.publish({topic:`${this.store}.idb.result`,data:{operation:s,success:!0,...t,requestId:e}})}#t(s,t,e){this.pc.publish({topic:`${this.store}.idb.error`,data:{operation:s,success:!1,error:t,requestId:e}})}}customElements.define("pan-idb",d);var w=d;export{d as PanIDB,w as default};
