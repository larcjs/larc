function y(v={}){const u=new EventTarget;let i=!1,l=structuredClone(v);const d=[],a=new Map,r=new Proxy(l,{set(t,s,e){if(Object.is(t[s],e))return!0;const n=t[s];if(t[s]=e,!i){for(const c of d)try{c({key:s,value:e,oldValue:n,state:r})}catch(o){console.error("Middleware error:",o)}u.dispatchEvent(new CustomEvent("state",{detail:{key:s,value:e,oldValue:n,state:r}})),p(s)}return!0},get(t,s){return a.has(s)?a.get(s).compute():t[s]}}),h=(t={})=>{i=!0;try{for(const[s,e]of Object.entries(t))r[s]=e}finally{i=!1,u.dispatchEvent(new CustomEvent("state",{detail:{keys:Object.keys(t),state:r}}))}},p=t=>{for(const[s,e]of a.entries())if(e.deps.includes(t)){const n=e.compute();u.dispatchEvent(new CustomEvent("derived",{detail:{key:s,value:n,state:r}}))}};return{state:r,subscribe(t){return u.addEventListener("state",t),()=>u.removeEventListener("state",t)},snapshot(){return JSON.parse(JSON.stringify(r))},set(t,s){r[t]=s},patch(t){t&&typeof t=="object"&&h(t)},update(t){const s=JSON.parse(JSON.stringify(r)),e=t(s)||s;h(e)},select(t){const s=t.split(".");let e=r;for(const n of s){if(e==null)return;e=e[n]}return e},derive(t,s,e){typeof s=="function"&&(e=s,s=Object.keys(l));const n=()=>{const o=s.map(f=>r[f]);return e(...o)};a.set(t,{deps:s,compute:n});const c=this.subscribe(({detail:o})=>{o.key&&s.includes(o.key)&&p(o.key)});return()=>{a.delete(t),c()}},batch(t){i=!0;const s=[];try{t({set:(e,n)=>{const c=r[e];l[e]=n,s.push({key:e,value:n,oldValue:c})},state:r})}finally{i=!1,s.length>0&&u.dispatchEvent(new CustomEvent("state",{detail:{batch:!0,changes:s,state:r}}))}},use(t){return d.push(t),()=>{const s=d.indexOf(t);s>-1&&d.splice(s,1)}},reset(){h(structuredClone(v))},has(t){return t in r||a.has(t)},delete(t){if(t in r){const s=r[t];return delete l[t],u.dispatchEvent(new CustomEvent("state",{detail:{key:t,deleted:!0,oldValue:s,state:r}})),!0}return!1},keys(){return[...Object.keys(l),...a.keys()]},_setAll:h}}function E(v,u,i,l={}){const d=l.events||["input","change"],a=e=>e.type==="checkbox",r=e=>e.type==="radio",h=e=>a(e)?!!e.checked:(r(e),e.value),p=(e,n)=>{a(e)?e.checked=!!n:r(e)?e.checked=e.value===String(n):e.value=n??""},t=[];for(const[e,n]of Object.entries(i||{}))v.querySelectorAll(e).forEach(c=>{const o=()=>{u.state[n]=h(c)};for(const f of d)c.addEventListener(f,o);t.push(()=>{for(const f of d)c.removeEventListener(f,o)}),p(c,u.state[n])});const s=u.subscribe(({detail:{key:e,value:n}})=>{for(const[c,o]of Object.entries(i||{}))o===e&&v.querySelectorAll(c).forEach(f=>p(f,n))});return()=>{try{s()}catch{}t.forEach(e=>{try{e()}catch{}})}}var b={createStore:y,bind:E};export{E as bind,y as createStore,b as default};
