class o extends HTMLElement{constructor(){super(),this.subs=[],this.retained=new Map,this.clients=new Map}connectedCallback(){document.addEventListener("pan:publish",this.onPublish,!0),document.addEventListener("pan:request",this.onPublish,!0),document.addEventListener("pan:reply",this.onReply,!0),document.addEventListener("pan:subscribe",this.onSubscribe,!0),document.addEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.addEventListener("pan:hello",this.onHello,!0),window.__panReady=!0,document.dispatchEvent(new CustomEvent("pan:sys.ready",{bubbles:!0,composed:!0}))}disconnectedCallback(){document.removeEventListener("pan:publish",this.onPublish,!0),document.removeEventListener("pan:request",this.onPublish,!0),document.removeEventListener("pan:reply",this.onReply,!0),document.removeEventListener("pan:subscribe",this.onSubscribe,!0),document.removeEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.removeEventListener("pan:hello",this.onHello,!0)}onHello=e=>{const t=e.detail||{};t.id&&this.clients.set(t.id,{el:this._et(e),caps:t.caps||[]})};onSubscribe=e=>{const{topics:t=[],options:s={},clientId:i}=e.detail||{},n=this._et(e);for(const r of t)this.subs.push({pattern:r,el:n,clientId:i,retained:!!s.retained});if(s.retained)for(const[r,c]of this.retained)t.some(u=>o.matches(r,u))&&this._deliver(n,c)};onUnsubscribe=e=>{const{topics:t=[],clientId:s}=e.detail||{},i=this._et(e);this.subs=this.subs.filter(n=>!((s?n.clientId===s:n.el===i)&&t.includes(n.pattern)))};onPublish=e=>{const t=e.detail||{},s=Object.assign({ts:Date.now(),id:crypto.randomUUID()},t);s.retain&&this.retained.set(s.topic,s);for(const i of this.subs)o.matches(s.topic,i.pattern)&&this._deliver(i.el,s)};onReply=e=>{const t=e.detail||{};for(const s of this.subs)o.matches(t.topic,s.pattern)&&this._deliver(s.el,t)};_deliver(e,t){try{e.dispatchEvent(new CustomEvent("pan:deliver",{detail:t}))}catch{}}_et(e){return typeof e.composedPath=="function"?e.composedPath()[0]:e.target||document}static matches(e,t){if(t==="*"||e===t)return!0;if(t&&t.includes("*")){const s=n=>n.replace(/[|\\{}()\[\]^$+?.]/g,"\\$&").replace(/\*/g,"[^.]+");return new RegExp(`^${s(t)}$`).test(e)}return!1}}customElements.define("pan-bus",o);var d=o;export{o as PanBus,d as default};
