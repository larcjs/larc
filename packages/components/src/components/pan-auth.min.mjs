import{PanClient as p}from"../../../core/src/components/pan-client.mjs";class l extends HTMLElement{static get observedAttributes(){return["storage","token-key","refresh-key","auto-refresh","refresh-before","login-endpoint","refresh-endpoint"]}constructor(){super(),this.pc=new p(this),this.authState={authenticated:!1,token:null,refreshToken:null,user:null,expiresAt:null},this.refreshTimer=null,this.useHttpOnlyCookies=!0}connectedCallback(){this.config={storage:this.getAttribute("storage")||"localStorage",tokenKey:this.getAttribute("token-key")||"pan_jwt",refreshKey:this.getAttribute("refresh-key")||"pan_refresh_jwt",autoRefresh:this.getAttribute("auto-refresh")!=="false",refreshBefore:parseInt(this.getAttribute("refresh-before")||"300",10),loginEndpoint:this.getAttribute("login-endpoint")||"/api/auth/login",refreshEndpoint:this.getAttribute("refresh-endpoint")||"/api/auth/refresh",logoutEndpoint:this.getAttribute("logout-endpoint")||"/api/auth/logout"},this.loadTokens(),this.setupHandlers(),this.publishAuthState(),this.config.autoRefresh&&this.authState.authenticated&&this.scheduleRefresh()}disconnectedCallback(){this.refreshTimer&&clearTimeout(this.refreshTimer)}setupHandlers(){this.pc.subscribe("auth.login",async e=>{await this.handleLogin(e)}),this.pc.subscribe("auth.logout",async e=>{await this.handleLogout(e)}),this.pc.subscribe("auth.refresh",async e=>{await this.handleRefresh(e)}),this.pc.subscribe("auth.setToken",e=>{this.setToken(e.data)}),this.pc.subscribe("auth.check",e=>{this.publishAuthState()})}async handleLogin(e){const{email:r,password:s,username:t,credentials:o,endpoint:u}=e.data,c=u||this.config.loginEndpoint;try{const n=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o||{email:r,password:s,username:t})}),i=await n.json();if(n.ok&&i.token)this.setToken({token:i.token,refreshToken:i.refreshToken||i.refresh_token,user:i.user}),e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!0,user:this.authState.user},correlationId:e.correlationId}),this.pc.publish({topic:"auth.login.success",data:{user:this.authState.user}});else{const h=i.error||i.message||"Login failed";e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!1,error:h},correlationId:e.correlationId}),this.pc.publish({topic:"auth.login.error",data:{error:h}})}}catch(a){e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!1,error:a.message},correlationId:e.correlationId}),this.pc.publish({topic:"auth.login.error",data:{error:a.message}})}}async handleLogout(e){const r=e.data?.endpoint||this.config.logoutEndpoint;try{r&&this.authState.token&&await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${this.authState.token}`}})}catch(s){console.warn("Logout endpoint failed:",s)}this.clearTokens(),e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!0},correlationId:e.correlationId}),this.pc.publish({topic:"auth.logout.success",data:{}})}async handleRefresh(e){if(!this.authState.refreshToken){e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!1,error:"No refresh token available"},correlationId:e.correlationId});return}const r=e.data?.endpoint||this.config.refreshEndpoint;try{const s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authState.refreshToken}`},body:JSON.stringify({refreshToken:this.authState.refreshToken})}),t=await s.json();s.ok&&t.token?(this.setToken({token:t.token,refreshToken:t.refreshToken||t.refresh_token||this.authState.refreshToken,user:t.user||this.authState.user}),e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!0},correlationId:e.correlationId}),this.pc.publish({topic:"auth.refresh.success",data:{}})):(this.clearTokens(),e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!1,error:"Token refresh failed"},correlationId:e.correlationId}),this.pc.publish({topic:"auth.refresh.error",data:{error:"Token refresh failed"}}))}catch(s){this.clearTokens(),e.replyTo&&this.pc.publish({topic:e.replyTo,data:{ok:!1,error:s.message},correlationId:e.correlationId}),this.pc.publish({topic:"auth.refresh.error",data:{error:s.message}})}}setToken({token:e,refreshToken:r,user:s}){const t=this.decodeJWT(e),o=t?.exp?t.exp*1e3:null;this.authState={authenticated:!0,token:e,refreshToken:r||this.authState.refreshToken,user:s||t||this.authState.user,expiresAt:o},this.storeTokens(),this.publishAuthState(),this.config.autoRefresh&&o&&this.scheduleRefresh()}clearTokens(){this.authState={authenticated:!1,token:null,refreshToken:null,user:null,expiresAt:null};const e=this.getStorage();e&&(e.removeItem(this.config.tokenKey),e.removeItem(this.config.refreshKey)),this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),this.publishAuthState()}loadTokens(){if(this.useHttpOnlyCookies){fetch(this.config.loginEndpoint.replace("/login","/check"),{credentials:"include"}).then(t=>t.json()).then(t=>{t.authenticated&&(this.authState={authenticated:!0,token:null,refreshToken:null,user:t.user,expiresAt:null},this.publishAuthState())}).catch(t=>{console.error("Failed to check auth status:",t)});return}const e=this.getStorage();if(!e)return;const r=e.getItem(this.config.tokenKey),s=e.getItem(this.config.refreshKey);if(r){const t=this.decodeJWT(r),o=t?.exp?t.exp*1e3:null;if(o&&Date.now()>o){this.clearTokens();return}this.authState={authenticated:!0,token:r,refreshToken:s,user:t,expiresAt:o},console.warn("⚠ Loading tokens from localStorage - vulnerable to XSS")}}storeTokens(){if(this.useHttpOnlyCookies){console.log("✓ Tokens stored in HttpOnly cookies (server-side)");return}const e=this.getStorage();e&&(this.authState.token&&(e.setItem(this.config.tokenKey,this.authState.token),console.warn("⚠ Token stored in localStorage - vulnerable to XSS. Use HttpOnly cookies instead.")),this.authState.refreshToken&&(e.setItem(this.config.refreshKey,this.authState.refreshToken),console.warn("⚠ Refresh token stored in localStorage - vulnerable to XSS. Use HttpOnly cookies instead.")))}getStorage(){switch(this.config.storage){case"localStorage":return typeof window<"u"?window.localStorage:null;case"sessionStorage":return typeof window<"u"?window.sessionStorage:null;case"memory":return null;default:return typeof window<"u"?window.localStorage:null}}publishAuthState(){this.pc.publish({topic:"auth.state",data:{authenticated:this.authState.authenticated,user:this.authState.user,expiresAt:this.authState.expiresAt,hasRefreshToken:!!this.authState.refreshToken,useHttpOnlyCookies:this.useHttpOnlyCookies},retain:!0}),this.pc.publish({topic:"auth.internal.state",data:{authenticated:this.authState.authenticated,user:this.authState.user,expiresAt:this.authState.expiresAt,token:null,refreshToken:null},retain:!0})}scheduleRefresh(){if(this.refreshTimer&&clearTimeout(this.refreshTimer),!this.authState.expiresAt)return;const e=Date.now(),t=this.authState.expiresAt-this.config.refreshBefore*1e3-e;t>0&&(this.refreshTimer=setTimeout(()=>{this.pc.publish({topic:"auth.refresh",data:{}})},t))}decodeJWT(e){try{const s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(atob(s).split("").map(o=>"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(t)}catch(r){return console.error("Failed to decode JWT:",r),null}}}customElements.define("pan-auth",l);var k=l;export{k as default};
