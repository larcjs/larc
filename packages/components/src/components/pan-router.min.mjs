import{PanClient as u}from"../../../core/src/components/pan-client.mjs";class c extends HTMLElement{static get observedAttributes(){return["base","mode","auth-topic"]}#e;#s;constructor(){super(),this.pc=new u(this),this.routes=[],this.guards=[],this.authState=null}connectedCallback(){this.#o(),this.#n(),this.#t()}disconnectedCallback(){window.removeEventListener("popstate",this.#e),window.removeEventListener("click",this.#s)}attributeChangedCallback(){this.isConnected&&this.#t()}get base(){return(this.getAttribute("base")||"").trim()}get mode(){return this.getAttribute("mode")||"history"}get authTopic(){return this.getAttribute("auth-topic")||"auth.state"}addRoute(t,e){this.routes.push({pattern:t,guard:e})}addGuard(t){typeof t=="function"&&this.guards.push(t)}#o(){this.#e=()=>this.#t(),this.#s=t=>this.#h(t),window.addEventListener("popstate",this.#e),window.addEventListener("click",this.#s,!0)}#n(){this.pc.subscribe("nav.goto",t=>this.#a(t)),this.pc.subscribe("nav.back",()=>window.history.back()),this.pc.subscribe("nav.forward",()=>window.history.forward()),this.pc.subscribe("nav.replace",t=>this.#a(t,!0)),this.authTopic&&this.pc.subscribe(this.authTopic,t=>{this.authState=t.data},{retained:!0})}#h(t){const e=t.target.closest("a");if(!e||e.target==="_blank"||e.hasAttribute("download"))return;const s=e.getAttribute("href");if(!(!s||s.startsWith("http://")||s.startsWith("https://")||s.startsWith("//"))){if(s.startsWith("#")){this.mode==="hash"&&(t.preventDefault(),this.#i(s));return}this.mode==="history"&&(t.preventDefault(),this.#i(s,e.hasAttribute("data-replace")))}}#a(t,e=!1){const s=t.data||{},i=s.path||s.url||"",a=s.state||{};this.#i(i,e||s.replace,a)}#i(t,e=!1,s={}){if(!this.#c(t)){this.pc.publish({topic:"nav.blocked",data:{path:t,reason:"guard"}});return}const i=this.#d(t);this.mode==="hash"?e?window.location.replace("#"+i):window.location.hash=i:e?window.history.replaceState(s,"",i):window.history.pushState(s,"",i),this.#t()}#c(t){for(const e of this.routes)if(this.#u(t,e.pattern)&&e.guard&&!e.guard(t,this.authState))return!1;for(const e of this.guards)if(!e(t,this.authState))return!1;return!0}#u(t,e){return e==="*"||t===e?!0:e.includes("*")?new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t):!1}#d(t){if(t.startsWith("/"))return t;const s=this.#r().split("/").slice(0,-1);return s.push(t),s.join("/")}#r(){return this.mode==="hash"?window.location.hash.slice(1)||"/":window.location.pathname}#t(){const t=this.#r(),e=window.location.search,s=this.mode==="history"?window.location.hash:"",i={},a=new URLSearchParams(e);for(const[r,n]of a)i[r]=n;const o=this.#l(t),h={path:t,query:i,hash:s.slice(1),params:o,full:window.location.href};this.pc.publish({topic:"nav.state",data:h,retain:!0})}#l(t){const e={};for(const s of this.routes){const i=s.pattern;if(i.includes(":")){const a=new RegExp("^"+i.replace(/:[^/]+/g,"([^/]+)")+"$"),o=t.match(a);if(o){(i.match(/:[^/]+/g)||[]).map(r=>r.slice(1)).forEach((r,n)=>{e[r]=o[n+1]});break}}}return e}}customElements.define("pan-router",c);var p=c;export{c as PanRouter,p as default};
