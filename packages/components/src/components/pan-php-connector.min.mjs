import{PanClient as o}from"../../../core/src/components/pan-client.mjs";class h extends HTMLElement{static get observedAttributes(){return["resource","api-url","fields","page-size","start-param"]}constructor(){super(),this.pc=new o(this),this.items=[],this.meta={total:null,start:0,count:0,page:null},this._offs=[],this._busy=!1}connectedCallback(){this.#e()}disconnectedCallback(){this.#s()}attributeChangedCallback(){this.#e()}get resource(){return(this.getAttribute("resource")||"items").trim()}get apiUrl(){return(this.getAttribute("api-url")||"api.php").trim()}get fields(){return(this.getAttribute("fields")||"").trim()}get pageSize(){const t=Number(this.getAttribute("page-size"));return Number.isFinite(t)&&t>0?t:20}get startParam(){return(this.getAttribute("start-param")||"start").trim()}#e(){this.#s();const t=this.resource;this._offs.push(this.pc.subscribe(`${t}.list.get`,e=>this.#a(e))),this._offs.push(this.pc.subscribe(`${t}.list.more`,e=>this.#h(e))),this._offs.push(this.pc.subscribe(`${t}.list.reset`,()=>this.#n()))}#s(){try{this._offs.forEach(t=>t&&t())}catch{}this._offs=[]}async#a(t){const e=t&&t.data||{};(!Object.prototype.hasOwnProperty.call(e,this.startParam)||(Number(e[this.startParam])||0)===0||e.reset)&&this.#i(),await this.#t(e),t&&t.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,items:this.items,meta:this.meta}})}async#h(t){const e=t&&t.data||{};e[this.startParam]=this.meta.start||0,await this.#t(e),t&&t.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,items:this.items,meta:this.meta}})}#i(){this.items=[],this.meta={total:null,start:0,count:0,page:null},this.#r()}async#n(){this.#i(),await this.#t({})}#r(){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:this.items.slice()},retain:!0}),this.pc.publish({topic:`${this.resource}.list.meta`,data:Object.assign({},this.meta)})}#o(t){const e=new URLSearchParams;e.set("x","get"),e.set("rsc",this.resource),e.set("page_size",String(this.pageSize));const r=t&&t.fields?String(t.fields).trim():this.fields;r&&e.set("fields",r);const s=Number(t&&Object.prototype.hasOwnProperty.call(t,this.startParam)?t[this.startParam]:this.meta.start||0)||0;if(e.set(this.startParam,String(s)),t&&t.filters!=null)try{const i=Array.isArray(t.filters)?t.filters:JSON.parse(String(t.filters));e.set("filters",JSON.stringify(i))}catch{e.set("filters",String(t.filters))}return t&&t.id!=null&&e.set("id",String(t.id)),`${this.apiUrl}?${e.toString()}`}async#t(t){if(!this._busy){this._busy=!0;try{const e=this.#o(t||{}),r=await fetch(e,{credentials:"same-origin"});if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();let i=[];Array.isArray(s)?i=s:s&&Array.isArray(s.results)&&(i=s.results);const n=this.items.length;if(i&&i.length?(this.items.push(...i),this.meta.start=(this.meta.start||0)+i.length,this.meta.count=i.length):this.meta.count=0,s&&typeof s.total<"u"){const a=typeof s.total=="number"?s.total:Number(s.total);Number.isFinite(a)&&(this.meta.total=a)}if(s&&typeof s.page<"u"){const a=typeof s.page=="number"?s.page:Number(s.page);Number.isFinite(a)&&(this.meta.page=a)}(this.items.length!==n||this.meta.count===0)&&this.#r()}catch(e){this.pc.publish({topic:`${this.resource}.list.meta`,data:Object.assign({},this.meta,{error:String(e&&e.message||e)})})}finally{this._busy=!1}}}}customElements.define("pan-php-connector",h);var u=h;export{h as PanPhpConnector,u as default};
