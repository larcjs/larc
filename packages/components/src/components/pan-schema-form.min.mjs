import{PanClient as g}from"../../../core/src/components/pan-client.mjs";class f extends HTMLElement{static get observedAttributes(){return["resource","key","live"]}constructor(){super(),this.attachShadow({mode:"open"}),this.pc=new g(this),this.schema=null,this.value={},this._offs=[],this._offLive=null,this._selectedId=null}connectedCallback(){this.render(),this.#t()}disconnectedCallback(){this.#i()}attributeChangedCallback(){this.render(),this.#t()}get resource(){return(this.getAttribute("resource")||"items").trim()}get key(){return(this.getAttribute("key")||"id").trim()}get live(){const e=(this.getAttribute("live")||"true").toLowerCase();return e!=="false"&&e!=="0"}#t(){this.#i(),this._offs.push(this.pc.subscribe(`${this.resource}.schema.state`,s=>{this.schema=s?.data?.schema||null,this.render()},{retained:!0})),this._offs.push(this.pc.subscribe(`${this.resource}.item.select`,async s=>{const i=s?.data?.id;if(i){this._selectedId=i,this.#s();try{const{data:n}=await this.pc.request(`${this.resource}.item.get`,{id:i});this.#e(n?.item||{})}catch{}}}));const e=this.shadowRoot.getElementById("f");e&&(e.onsubmit=s=>{s.preventDefault(),this.#a()});const t=this.shadowRoot.getElementById("del");t&&(t.onclick=s=>{s.preventDefault(),this.#o()})}#i(){try{this._offs.forEach(e=>e&&e())}catch{}this._offs=[];try{this._offLive&&this._offLive()}catch{}this._offLive=null}#s(){try{this._offLive&&this._offLive()}catch{}if(this._offLive=null,!this.live)return;const e=this._selectedId||this.value?.[this.key]||this.value?.id;if(!e)return;const t=`${this.resource}.item.state.${e}`;this._offLive=this.pc.subscribe(t,s=>{const i=s?.data||{};if(i.deleted){const n=this.value?.[this.key]||this.value?.id;String(n)===String(e)&&this.#e({});return}if(i.item&&typeof i.item=="object"){this.#e(i.item);return}if(i.patch&&typeof i.patch=="object"){this.#e(Object.assign({},this.value||{},i.patch));return}i&&typeof i=="object"&&this.#e(Object.assign({},this.value||{},i))},{retained:!1})}async#a(){const e=this.#l(),t=this.#h(e);if(this.#u(t),!(t&&t.length))try{const{data:s}=await this.pc.request(`${this.resource}.item.save`,{item:e}),i=s?.item||e;this.#e(i),this._selectedId=i?.[this.key]||i?.id||this._selectedId,this.#s()}catch{}}async#o(){const e=this.value?.[this.key]||this.value?.id;if(e)try{await this.pc.request(`${this.resource}.item.delete`,{id:e}),this.#e({})}catch{}}#l(){const e=Object.assign({},this.value||{}),t=this.schema?.properties||{},s=this.#r();for(const i of s){const n=this.shadowRoot.querySelector(`[name="${i}"]`);n&&(e[i]=this.#c(t[i],n))}return e}#c(e,t){const s=e&&e.type||"string";if(s==="boolean")return!!t.checked;if(s==="number"||s==="integer"){const i=Number(t.value);return Number.isFinite(i)?s==="integer"?Math.trunc(i):i:void 0}return t.value}#h(e){const t=[],s=this.schema?.properties||{},i=Array.isArray(this.schema?.required)?this.schema.required:[];for(const n of i){const a=e[n];(a==null||a==="")&&t.push({name:n,message:"Required"})}for(const[n,a]of Object.entries(s)){const r=e[n];if(r==null||r==="")continue;const o=a.type||"string";if((o==="number"||o==="integer")&&(typeof r!="number"||!Number.isFinite(r))&&t.push({name:n,message:"Must be a number"}),o==="boolean"&&typeof r!="boolean"&&t.push({name:n,message:"Must be true/false"}),a.pattern&&typeof r=="string")try{new RegExp(a.pattern).test(r)||t.push({name:n,message:"Invalid format"})}catch{}a.minLength!=null&&typeof r=="string"&&r.length<a.minLength&&t.push({name:n,message:`Min length ${a.minLength}`}),a.maxLength!=null&&typeof r=="string"&&r.length>a.maxLength&&t.push({name:n,message:`Max length ${a.maxLength}`}),a.minimum!=null&&typeof r=="number"&&r<a.minimum&&t.push({name:n,message:`>= ${a.minimum}`}),a.maximum!=null&&typeof r=="number"&&r>a.maximum&&t.push({name:n,message:`<= ${a.maximum}`}),Array.isArray(a.enum)&&!a.enum.includes(r)&&t.push({name:n,message:"Invalid value"}),a.format==="email"&&typeof r=="string"&&(/.+@.+\..+/.test(r)||t.push({name:n,message:"Invalid email"}))}return t}#u(e){const t=new Map((e||[]).map(s=>[s.name,s.message]));this.shadowRoot.querySelectorAll(".err").forEach(s=>s.textContent="");for(const[s,i]of t){const n=this.shadowRoot.querySelector(`.err[data-for="${s}"]`);n&&(n.textContent=i)}}#e(e){this.value=e||{},this.render(),this.#t()}#r(){const e=this.schema?.properties||{},t=Object.keys(e),s=this.schema&&(this.schema["ui:order"]||this.schema.uiOrder||null);return Array.isArray(s)?t.sort((i,n)=>(s.indexOf(i)===-1?1:s.indexOf(i))-(s.indexOf(n)===-1?1:s.indexOf(n))):t}render(){const e=String.raw,t=this.schema?.properties||{},s=this.#r(),i=this.value||{},n=this.key,a=s.map(r=>{const o=t[r]||{},l=o.type||"string",c=o.title||r,h=o.description||"",m=Array.isArray(this.schema?.required)&&this.schema.required.includes(r),u=i[r]??"";if(Array.isArray(o.enum))return e`<label class="row"><span class="lab">${c}${m?" *":""}</span>
          <select name="${r}">${o.enum.map(d=>`<option value="${String(d)}" ${String(d)===String(u)?"selected":""}>${String(d)}</option>`).join("")}</select>
          <small class="hint">${h}</small><small class="err" data-for="${r}"></small></label>`;if(l==="boolean")return e`<label class="row chk"><input type="checkbox" name="${r}" ${u?"checked":""}/><span>${c}</span><small class="hint">${h}</small><small class="err" data-for="${r}"></small></label>`;const p=l==="number"||l==="integer"?"number":o.format==="email"?"email":"text";return o.maxLength&&o.maxLength>180||o.format==="multiline"?e`<label class="row"><span class="lab">${c}${m?" *":""}</span>
          <textarea name="${r}" rows="4">${this.#n(u)}</textarea>
          <small class="hint">${h}</small><small class="err" data-for="${r}"></small></label>`:e`<label class="row"><span class="lab">${c}${m?" *":""}</span>
        <input type="${p}" name="${r}" value="${this.#n(u)}" />
        <small class="hint">${h}</small><small class="err" data-for="${r}"></small></label>`}).join("");this.shadowRoot.innerHTML=e`
      <style>
        :host{display:block; border:1px solid #ddd; border-radius:8px; padding:12px; font:13px/1.4 system-ui, sans-serif}
        form{ display:grid; gap:10px }
        .row{ display:grid; gap:6px }
        .row.chk{ grid-template-columns: auto 1fr; align-items:center }
        .lab{ font-weight:600 }
        input,select,textarea,button{ padding:8px 10px; font:inherit }
        input,select,textarea{ border:1px solid #e2e2e2; border-radius:8px }
        .actions{ display:flex; gap:8px; align-items:center }
        .hint{ color:#888 }
        .err{ color:#c33 }
      </style>
      <form id="f">
        ${a}
        <div class="actions">
          <button id="save" type="submit">Save</button>
          <span style="flex:1"></span>
          <button id="del" type="button">Delete</button>
        </div>
      </form>
    `,this.#s()}#n(e){return String(e??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}}customElements.define("pan-schema-form",f);var $=f;export{f as PanSchemaForm,$ as default};
