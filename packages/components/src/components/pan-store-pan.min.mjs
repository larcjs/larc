import{PanClient as x}from"../../../core/src/components/pan-client.mjs";function w(f,{resource:l="items",id:h=null,key:g="id",live:m=!0,autoSave:a=!0,debounceMs:d=300,followSelect:b=!0}={}){const r=new x;let s=h,t=null,p=null,u=!1,i=null,o=0;function n(c){o++;try{c&&typeof c=="object"&&f._setAll(c)}finally{o--}}function y(){try{t&&t()}catch{}t=null,!(!m||!s)&&(t=r.subscribe(`${l}.item.state.${s}`,c=>{const e=c?.data||{};if(e.deleted){String(s)===String(e.id)&&n({});return}e.item?n(e.item):e.patch?f.patch(e.patch):e&&typeof e=="object"&&f.patch(e)},{retained:!0}))}function j(){!a||!s||o>0||(clearTimeout(i),i=setTimeout(async()=>{try{u=!0;const c=f.snapshot();await r.request(`${l}.item.save`,{item:c})}catch{}finally{u=!1}},Math.max(0,d|0)))}const $=f.subscribe(j);return b&&(p=r.subscribe(`${l}.item.select`,async c=>{const e=c?.data?.id;if(e){s=e,y();try{const{data:S}=await r.request(`${l}.item.get`,{id:e});S?.item&&n(S.item)}catch{}}})),s&&(y(),(async()=>{try{const{data:c}=await r.request(`${l}.item.get`,{id:s});c?.item&&n(c.item)}catch{}})()),()=>{try{t&&t()}catch{}try{p&&p()}catch{}try{$&&$()}catch{}clearTimeout(i)}}function I(f,{resource:l="items",key:h="id",live:g=!0}={}){const m=new x;let a=[];function d(){f._setAll({items:a})}function b(t,p){let u=t?.id??t?.item?.[h]??t?.item?.id;if(u==null&&p){const n=String(p).split(".");u=n[n.length-1]}if(u==null)return;const i=a.findIndex(n=>String(n?.[h]??n?.id)===String(u));if(t.deleted){i>=0&&a.splice(i,1);return}if(t.item&&typeof t.item=="object"){i>=0?a[i]=t.item:a.push(t.item);return}const o=t.patch||t;if(o&&typeof o=="object"){const n=i>=0?a[i]:{},y=Object.assign({},n,o);i>=0?a[i]=y:a.push(y)}}const r=m.subscribe(`${l}.list.state`,t=>{a=t?.data?.items||[],d()},{retained:!0}),s=g?m.subscribe(`${l}.item.state.*`,t=>{b(t?.data||{},t?.topic),d()}):null;return m.publish({topic:`${l}.list.get`,data:{}}),()=>{try{r&&r()}catch{}try{s&&s()}catch{}}}var q={syncItem:w,syncList:I};export{q as default,w as syncItem,I as syncList};
