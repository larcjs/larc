import{PanClient as r}from"../../../core/src/components/pan-client.mjs";class o extends HTMLElement{static get observedAttributes(){return["url","protocols","outbound-topics","inbound-topics","auto-reconnect","reconnect-delay","heartbeat","heartbeat-topic"]}constructor(){super(),this.pc=new r(this),this.ws=null,this.reconnectTimer=null,this.heartbeatTimer=null,this.reconnectAttempts=0,this.stopped=!1,this.subscriptions=[]}connectedCallback(){this.#t(),this.#c()}disconnectedCallback(){this.stopped=!0,this.#e(),this.#a()}attributeChangedCallback(t){t==="url"&&this.isConnected?this.#i():t==="outbound-topics"&&this.isConnected&&(this.#a(),this.#c())}get url(){return this.getAttribute("url")||""}get protocols(){return this.getAttribute("protocols")||""}get outboundTopics(){const t=(this.getAttribute("outbound-topics")||"").trim();return t?t.split(/\s+/):[]}get inboundTopics(){const t=(this.getAttribute("inbound-topics")||"").trim();return t?t.split(/\s+/):["*"]}get autoReconnect(){return this.getAttribute("auto-reconnect")!=="false"}get reconnectDelay(){const t=(this.getAttribute("reconnect-delay")||"1000,15000").split(",").map(i=>Number(i)||0),[e,s]=[Math.max(100,t[0]||1e3),Math.max(t[1]||t[0]||15e3,t[0]||1e3)];return{min:e,max:s}}get heartbeat(){return Number(this.getAttribute("heartbeat"))||30}get heartbeatTopic(){return this.getAttribute("heartbeat-topic")||"sys.ping"}send(t){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(typeof t=="string"?t:JSON.stringify(t))}close(){this.stopped=!0,this.#e()}reconnect(){this.#i()}#t(){if(!(!this.url||this.stopped))try{const t=this.protocols?new WebSocket(this.url,this.protocols.split(",").map(e=>e.trim())):new WebSocket(this.url);this.ws=t,t.addEventListener("open",()=>this.#p()),t.addEventListener("message",e=>this.#u(e)),t.addEventListener("close",e=>this.#l(e)),t.addEventListener("error",e=>this.#n(e))}catch(t){this.#n(t),this.#o()}}#e(){if(this.#s(),this.#r(),this.ws){try{this.ws.close()}catch{}this.ws=null}}#i(){this.#e(),this.reconnectAttempts=0,this.stopped=!1,this.#t()}#o(){if(!this.autoReconnect||this.stopped)return;this.#r();const{min:t,max:e}=this.reconnectDelay,s=Math.min(e,t*Math.pow(1.5,this.reconnectAttempts)+Math.random()*1e3);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>{this.#t()},s)}#r(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}#h(){this.#s(),!(this.heartbeat<=0)&&(this.heartbeatTimer=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({topic:this.heartbeatTopic,ts:Date.now()})},this.heartbeat*1e3))}#s(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}#p(){this.reconnectAttempts=0,this.#h(),this.pc.publish({topic:"ws.connected",data:{url:this.url,timestamp:Date.now()}})}#u(t){try{const e=JSON.parse(t.data);if(this.pc.publish({topic:"ws.message",data:{message:e,timestamp:Date.now()}}),e.topic&&this.inboundTopics.some(i=>this.#d(e.topic,i))){const i={topic:e.topic,data:e.data||e.payload||e};typeof e.retain=="boolean"&&(i.retain=e.retain),this.pc.publish(i)}}catch{this.pc.publish({topic:"ws.message",data:{raw:t.data,timestamp:Date.now()}})}}#l(t){this.#s(),this.pc.publish({topic:"ws.disconnected",data:{code:t.code,reason:t.reason,wasClean:t.wasClean,timestamp:Date.now()}}),this.stopped||this.#o()}#n(t){this.pc.publish({topic:"ws.error",data:{error:t.message||"WebSocket error",timestamp:Date.now()}})}#c(){for(const t of this.outboundTopics){const e=this.pc.subscribe(t,s=>{s.topic.startsWith("ws.")||this.send({topic:s.topic,data:s.data,ts:s.ts,id:s.id})});this.subscriptions.push(e)}}#a(){for(const t of this.subscriptions)typeof t=="function"&&t();this.subscriptions=[]}#d(t,e){return e==="*"||t===e?!0:e.includes("*")?new RegExp("^"+e.replace(/\*/g,"[^.]+")+"$").test(t):!1}}customElements.define("pan-websocket",o);var a=o;export{o as PanWebSocket,a as default};
