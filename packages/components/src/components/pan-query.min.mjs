import{PanClient as h}from"../../../core/src/components/pan-client.mjs";class u extends HTMLElement{static get observedAttributes(){return["resource","defaults","sync-url","debounce-ms","auto-request"]}constructor(){super(),this.pc=new h(this),this.state={},this.defaults={},this._timer=null}connectedCallback(){this.#s()}disconnectedCallback(){this.off?.forEach(t=>t&&t()),this.off=null,this._timer&&(clearTimeout(this._timer),this._timer=null)}attributeChangedCallback(){this.#s()}get resource(){return(this.getAttribute("resource")||"items").trim()}get debounceMs(){const t=Number(this.getAttribute("debounce-ms"));return Number.isFinite(t)&&t>=0?t:150}get autoRequest(){const t=(this.getAttribute("auto-request")||"true").toLowerCase();return t!=="false"&&t!=="0"}get syncUrl(){const t=(this.getAttribute("sync-url")||"").toLowerCase();return t==="search"||t==="hash"?t:""}#s(){this.defaults=this.#a();const t=this.#n();this.state=Object.assign({},this.defaults,t),this.#t(),this.autoRequest&&this.#e(),this.off?.forEach(e=>e&&e()),this.off=[this.pc.subscribe(`${this.resource}.query.set`,e=>this.#c(e?.data||{})),this.pc.subscribe(`${this.resource}.query.reset`,()=>this.#u())]}#a(){let t={};const e=this.getAttribute("defaults");if(e)try{t=JSON.parse(e)}catch{}const s=this.querySelector('script[type="application/json"]');if(s&&s.textContent?.trim())try{t=Object.assign({},t,JSON.parse(s.textContent.trim()))}catch{}return t}#n(){if(!this.syncUrl)return{};try{const t=this.syncUrl==="search"?new URL(location.href).searchParams:new URLSearchParams((location.hash||"").replace(/^#\??/,"")),e=c=>t.has(c)?t.get(c):void 0,s={},r=e("q");r!=null&&(s.q=r);const a=e("sort");a!=null&&(s.sort=a);const i=e("page");i!=null&&(s.page=Number(i)||1);const n=e("size");return n!=null&&(s.size=Number(n)||50),s}catch{return{}}}#i(){if(this.syncUrl)try{const t=new URLSearchParams,{q:e,sort:s,page:r,size:a}=this.state;if(e&&t.set("q",String(e)),s&&t.set("sort",String(s)),r!=null&&t.set("page",String(r)),a!=null&&t.set("size",String(a)),this.syncUrl==="search"){const i=new URL(location.href);i.search=t.toString(),history.replaceState(null,"",i.toString())}else{const i=t.toString();location.hash=i?"#"+i:""}}catch{}}#t(){this.pc.publish({topic:`${this.resource}.query.state`,data:Object.assign({},this.state),retain:!0})}#e(){const t=Object.assign({},this.state);this.pc.publish({topic:`${this.resource}.list.get`,data:t})}#c(t){this.state=Object.assign({},this.state,t||{}),this.#t(),this.#i(),this.autoRequest&&this.#r()}#u(){this.state=Object.assign({},this.defaults),this.#t(),this.#i(),this.autoRequest&&this.#r()}#r(){if(!this.debounceMs)return this.#e();clearTimeout(this._timer),this._timer=setTimeout(()=>this.#e(),this.debounceMs)}}customElements.define("pan-query",u);var f=u;export{u as PanQuery,f as default};
