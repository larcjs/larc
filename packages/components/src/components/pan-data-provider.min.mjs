import{PanClient as h}from"../../../core/src/components/pan-client.mjs";const c=()=>globalThis.crypto&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;class o extends HTMLElement{constructor(){super(),this.pc=new h(this),this.items=[]}connectedCallback(){this.resource=(this.getAttribute("resource")||"items").trim(),this.key=(this.getAttribute("key")||"id").trim(),this.persist=(this.getAttribute("persist")||"").toLowerCase()==="localstorage",this.storageKey=`pan:mock:${this.resource}`,this.#s();const t=`${this.resource}.list.get`,e=`${this.resource}.item.get`,i=`${this.resource}.item.save`,r=`${this.resource}.item.delete`;this.off=[this.pc.subscribe(t,s=>this.#r(s)),this.pc.subscribe(e,s=>this.#o(s)),this.pc.subscribe(i,s=>this.#h(s)),this.pc.subscribe(r,s=>this.#c(s))],this.#t()}disconnectedCallback(){this.off?.forEach(t=>t&&t())}#s(){const t=this.querySelector('script[type="application/json"]');if(t&&t.textContent?.trim())try{this.items=JSON.parse(t.textContent.trim()),this.#e();return}catch{}if(this.persist)try{const e=localStorage.getItem(this.storageKey);if(e){this.items=JSON.parse(e);return}}catch{}this.items=[]}#e(){if(this.persist)try{localStorage.setItem(this.storageKey,JSON.stringify(this.items))}catch{}}#t(){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:this.items},retain:!0})}#i(t,e={}){try{const i=t&&typeof t=="object"?t[this.key]??t.id:t;if(i==null)return;e&&e.deleted?this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{id:i,deleted:!0}}):this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{item:t},retain:!0})}catch{}}#r(t){const{replyTo:e}=t;e&&this.pc.publish({topic:e,correlationId:t.correlationId,data:{items:this.items}}),this.#t()}#o(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this.items.find(s=>String(s[this.key])===String(e)),r=i?{ok:!0,item:i}:{ok:!1,error:"NOT_FOUND",id:e};i&&this.#i(i),t.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:r})}#h(t){let e=t?.data?.item??t?.data;(!e||typeof e!="object")&&(e={}),e[this.key]||(e[this.key]=c());const i=e[this.key],r=this.items.findIndex(s=>String(s[this.key])===String(i));r>=0?this.items[r]=Object.assign({},this.items[r],e):this.items.push(e),this.#e(),this.#t(),this.#i(e),t.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,item:e}})}#c(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this.items.length;this.items=this.items.filter(s=>String(s[this.key])!==String(e));const r=this.items.length!==i;this.#e(),this.#t(),this.#i(e,{deleted:!0}),t.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:r,id:e}})}}customElements.define("pan-data-provider",o);var l=o;export{o as PanDataProvider,l as default};
