const l={maxRetained:1e3,maxMessageSize:1048576,maxPayloadSize:524288,cleanupInterval:3e4,rateLimit:1e3,rateLimitWindow:1e3,allowGlobalWildcard:!0,debug:!1,enableRouting:!1,enableTracing:!1};function g(o){try{return JSON.stringify(o),!0}catch{return!1}}function h(o){try{return new Blob([JSON.stringify(o)]).size}catch{return 0}}function p(o){return!o||!o.isConnected?!1:document.contains(o)||document.body.contains(o)}class d extends HTMLElement{static get observedAttributes(){return["max-retained","max-message-size","max-payload-size","cleanup-interval","rate-limit","allow-global-wildcard","debug","enable-routing","enable-tracing"]}constructor(){super(),this.config={...l},this.subs=[],this.clients=new Map,this.retained=new Map,this.retainedAccessOrder=[],this.publishCounts=new Map,this.stats={published:0,delivered:0,dropped:0,retainedEvicted:0,subsCleanedUp:0,errors:0},this.cleanupTimer=null,this.routingManager=null,this.debugManager=null}attributeChangedCallback(e,i,t){if(i!==t)switch(e){case"max-retained":this.config.maxRetained=parseInt(t,10)||l.maxRetained;break;case"max-message-size":this.config.maxMessageSize=parseInt(t,10)||l.maxMessageSize;break;case"max-payload-size":this.config.maxPayloadSize=parseInt(t,10)||l.maxPayloadSize;break;case"cleanup-interval":this.config.cleanupInterval=parseInt(t,10)||l.cleanupInterval,this.cleanupTimer&&this._setupCleanup();break;case"rate-limit":this.config.rateLimit=parseInt(t,10)||l.rateLimit;break;case"allow-global-wildcard":this.config.allowGlobalWildcard=t==="true";break;case"debug":this.config.debug=t==="true";break;case"enable-routing":this.config.enableRouting=t==="true",this.config.enableRouting&&!this.routingManager&&this._initRouting();break;case"enable-tracing":this.config.enableTracing=t==="true",this.config.enableTracing&&this.debugManager?this.debugManager.enableTracing():!this.config.enableTracing&&this.debugManager&&this.debugManager.disableTracing();break}}connectedCallback(){document.addEventListener("pan:publish",this.onPublish,!0),document.addEventListener("pan:request",this.onPublish,!0),document.addEventListener("pan:reply",this.onReply,!0),document.addEventListener("pan:subscribe",this.onSubscribe,!0),document.addEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.addEventListener("pan:hello",this.onHello,!0),document.addEventListener("pan:sys.stats",this.onGetStats,!0),document.addEventListener("pan:sys.clear-retained",this.onClearRetained,!0),document.addEventListener("pan:control",this.onControlMessage,!0),this.config.enableRouting&&this._initRouting(),this._initDebugManager(),this._setupCleanup(),window.__panReady=!0,this._log("PAN Bus Enhanced ready",this.config),document.dispatchEvent(new CustomEvent("pan:sys.ready",{bubbles:!0,composed:!0,detail:{enhanced:!0,routing:this.config.enableRouting,tracing:this.config.enableTracing,config:this.config}})),typeof window<"u"&&(window.pan=window.pan||{},window.pan.bus=this)}disconnectedCallback(){document.removeEventListener("pan:publish",this.onPublish,!0),document.removeEventListener("pan:request",this.onPublish,!0),document.removeEventListener("pan:reply",this.onReply,!0),document.removeEventListener("pan:subscribe",this.onSubscribe,!0),document.removeEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.removeEventListener("pan:hello",this.onHello,!0),document.removeEventListener("pan:sys.stats",this.onGetStats,!0),document.removeEventListener("pan:sys.clear-retained",this.onClearRetained,!0),document.removeEventListener("pan:control",this.onControlMessage,!0),this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null),typeof window<"u"&&window.pan&&(delete window.pan.routes,delete window.pan.debug,delete window.pan.bus)}_setupCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.cleanupTimer=setInterval(()=>{this._cleanupDeadSubscriptions(),this._cleanupRateLimits()},this.config.cleanupInterval)}_cleanupDeadSubscriptions(){const e=this.subs.length;this.subs=this.subs.filter(t=>p(t.el));const i=e-this.subs.length;i>0&&(this.stats.subsCleanedUp+=i,this._log(`Cleaned up ${i} dead subscriptions`))}_cleanupRateLimits(){const e=Date.now();for(const[i,t]of this.publishCounts.entries())e-t.windowStart>this.config.rateLimitWindow*2&&this.publishCounts.delete(i)}_checkRateLimit(e){const i=Date.now();let t=this.publishCounts.get(e);return!t||i-t.windowStart>this.config.rateLimitWindow?(t={count:1,windowStart:i},this.publishCounts.set(e,t),!0):t.count>=this.config.rateLimit?(this._error("Rate limit exceeded",{clientId:e,limit:this.config.rateLimit}),!1):(t.count++,!0)}_validateMessage(e){if(!e.topic||typeof e.topic!="string")return{valid:!1,error:"Invalid topic: must be a non-empty string"};if(e.data!==void 0&&!g(e.data))return{valid:!1,error:"Data must be JSON-serializable (no functions, DOM nodes, circular refs)"};const i=h(e);if(i>this.config.maxMessageSize)return{valid:!1,error:`Message size (${i} bytes) exceeds limit (${this.config.maxMessageSize} bytes)`};const t=h(e.data);return t>this.config.maxPayloadSize?{valid:!1,error:`Payload size (${t} bytes) exceeds limit (${this.config.maxPayloadSize} bytes)`}:{valid:!0}}_storeRetained(e,i){const t=this.retainedAccessOrder.indexOf(e);for(t!==-1&&this.retainedAccessOrder.splice(t,1),this.retainedAccessOrder.push(e),this.retained.set(e,i);this.retained.size>this.config.maxRetained;){const n=this.retainedAccessOrder.shift();n&&(this.retained.delete(n),this.stats.retainedEvicted++,this._log(`Evicted retained message for topic: ${n}`))}}_getRetained(e){const i=this.retained.get(e);if(i){const t=this.retainedAccessOrder.indexOf(e);t!==-1&&(this.retainedAccessOrder.splice(t,1),this.retainedAccessOrder.push(e))}return i}_validateSubscription(e){return e==="*"&&!this.config.allowGlobalWildcard?{valid:!1,error:"Global wildcard (*) subscriptions are disabled for security"}:!e||typeof e!="string"?{valid:!1,error:"Pattern must be a non-empty string"}:{valid:!0}}onHello=e=>{const i=e.detail||{};i.id&&(this.clients.set(i.id,{el:this._et(e),caps:i.caps||[]}),this._log("Client registered",{id:i.id,caps:i.caps}))};onSubscribe=e=>{const{topics:i=[],options:t={},clientId:n}=e.detail||{},s=this._et(e);for(const r of i){const a=this._validateSubscription(r);if(!a.valid){this._error("Subscription rejected",{pattern:r,reason:a.error}),this._emitError(s,"SUBSCRIPTION_INVALID",a.error,{pattern:r});continue}this.subs.push({pattern:r,el:s,clientId:n,retained:!!t.retained}),this._log("Subscription added",{pattern:r,clientId:n})}if(t.retained)for(const[r,a]of this.retained)i.some(c=>d.matches(r,c))&&this._deliver(s,this._getRetained(r))};onUnsubscribe=e=>{const{topics:i=[],clientId:t}=e.detail||{},n=this._et(e),s=this.subs.length;this.subs=this.subs.filter(a=>!((t?a.clientId===t:a.el===n)&&i.includes(a.pattern)));const r=s-this.subs.length;r>0&&this._log("Unsubscribed",{topics:i,clientId:t,count:r})};onPublish=e=>{const i=e.detail||{},t=this._et(e),n=i.clientId||t&&t.dataset&&t.dataset.panClientId||"anonymous";if(!this._checkRateLimit(n)){this.stats.dropped++,this._emitError(t,"RATE_LIMIT_EXCEEDED","Too many messages",{clientId:n});return}const s={ts:Date.now(),id:crypto.randomUUID(),...i},r=this._validateMessage(s);if(!r.valid){this.stats.errors++,this._error("Message validation failed",{topic:s.topic,error:r.error}),this._emitError(t,"MESSAGE_INVALID",r.error,{topic:s.topic});return}this.stats.published++,s.retain&&this._storeRetained(s.topic,s);let a=[];if(this.routingManager)try{a=this.routingManager.processMessage(s)||[]}catch(u){this._error("Routing failed",u)}this.debugManager&&this.debugManager.trace&&this.debugManager.trace(s,a);let c=0;for(const u of this.subs)d.matches(s.topic,u.pattern)&&this._deliver(u.el,s)&&c++;this.stats.delivered+=c,this._log("Published",{topic:s.topic,retain:s.retain,delivered:c,routes:a.length})};onReply=e=>{const i=e.detail||{};for(const t of this.subs)d.matches(i.topic,t.pattern)&&this._deliver(t.el,i)};onGetStats=e=>{const i=this._et(e),t={...this.stats,subscriptions:this.subs.length,clients:this.clients.size,retained:this.retained.size,config:this.config};i.dispatchEvent(new CustomEvent("pan:deliver",{detail:{topic:"pan:sys.stats",data:t,id:crypto.randomUUID(),ts:Date.now()}}))};onClearRetained=e=>{const{pattern:i}=e.detail||{};if(i){let t=0;for(const n of this.retained.keys())if(d.matches(n,i)){this.retained.delete(n);const s=this.retainedAccessOrder.indexOf(n);s!==-1&&this.retainedAccessOrder.splice(s,1),t++}this._log(`Cleared ${t} retained messages matching pattern: ${i}`)}else{const t=this.retained.size;this.retained.clear(),this.retainedAccessOrder=[],this._log(`Cleared all ${t} retained messages`)}};_deliver(e,i){try{return p(e)?(e.dispatchEvent(new CustomEvent("pan:deliver",{detail:i,bubbles:!0,composed:!0})),!0):!1}catch(t){return this._error("Delivery failed",{topic:i.topic,error:t.message}),!1}}_emitError(e,i,t,n={}){const s={topic:"pan:sys.error",data:{code:i,message:t,details:n},id:crypto.randomUUID(),ts:Date.now()};try{e.dispatchEvent(new CustomEvent("pan:deliver",{detail:s}))}catch{this._error("Cannot deliver error event",{code:i,message:t})}document.dispatchEvent(new CustomEvent("pan:sys.error",{bubbles:!0,composed:!0,detail:s.data}))}async _initDebugManager(){if(!this.debugManager)try{const{PanDebugManager:e}=await import("./pan-debug.mjs");this.debugManager=new e,this.config.enableTracing&&this.debugManager.enableTracing(),this._log("Debug manager initialized (lazy-loaded)"),typeof window<"u"&&window.pan&&(window.pan.debug=this.debugManager)}catch(e){this._error("Failed to load debug manager",e)}}async _initRouting(){if(!this.routingManager)try{const{PanRoutesManager:e}=await import("./pan-routes.mjs");this.routingManager=new e(this),this._log("Routing system initialized (lazy-loaded)"),this.routingManager.onError(i=>{this._error("Routing error",i),document.dispatchEvent(new CustomEvent("pan:routes.error",{bubbles:!0,composed:!0,detail:i}))}),typeof window<"u"&&window.pan&&(window.pan.routes=this.routingManager)}catch(e){this._error("Failed to load routing system",e)}}onControlMessage=e=>{const i=e.detail||{},{type:t}=i;if(t&&t.startsWith("pan.routes.")){if(!this.routingManager){this._error("Routing not enabled",{type:t});return}try{const n=this.routingManager.handleControlMessage(i);t==="pan.routes.list"&&i.payload?.requestId&&this._et(e).dispatchEvent(new CustomEvent("pan:deliver",{detail:{topic:"__pan.control",type:"pan.routes.list.result",data:{requestId:i.payload.requestId,routes:n},id:crypto.randomUUID(),ts:Date.now()}}))}catch(n){this._error("Control message failed",{type:t,error:n.message})}}};_et(e){return typeof e.composedPath=="function"?e.composedPath()[0]:e.target||document}_log(...e){this.config.debug&&console.log("[PAN Bus]",...e)}_error(...e){console.error("[PAN Bus ERROR]",...e),this.stats.errors++}static matches(e,i){if(i==="*"||e===i)return!0;if(i&&i.includes("*")){const t=s=>s.replace(/[|\\{}()\[\]^$+?.]/g,"\\$&").replace(/\*/g,"[^.]+");return new RegExp(`^${t(i)}$`).test(e)}return!1}publish(e,i,t={}){this.dispatchEvent(new CustomEvent("pan:publish",{detail:{topic:e,data:i,...t},bubbles:!0,composed:!0}))}subscribe(e,i){e=Array.isArray(e)?e:[e];const t=`bus-direct-${crypto.randomUUID()}`,n=s=>{const r=s.detail;!r||!r.topic||e.some(a=>d.matches(r.topic,a))&&i(r)};return document.addEventListener("pan:deliver",n),this.dispatchEvent(new CustomEvent("pan:subscribe",{detail:{clientId:t,topics:e,options:{}},bubbles:!0,composed:!0})),()=>{document.removeEventListener("pan:deliver",n),this.dispatchEvent(new CustomEvent("pan:unsubscribe",{detail:{clientId:t,topics:e},bubbles:!0,composed:!0}))}}}customElements.define("pan-bus",d);var b=d;export{d as PanBusEnhanced,b as default};
