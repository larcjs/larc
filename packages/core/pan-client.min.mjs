class c{constructor(e=document,t="pan-bus"){this.host=e,this.bus=document.querySelector(t);const n=e instanceof HTMLElement?e.tagName.toLowerCase()+(e.id?"#"+e.id:""):"doc";this.clientId=`${n}#${crypto.randomUUID()}`,this._pendingOps=[],this._isReady=!1,this._ready=new Promise(i=>{const s=()=>{document.removeEventListener("pan:sys.ready",s,!0),i()};if(globalThis.window&&window.__panReady)return i();document.addEventListener("pan:sys.ready",s,!0)}).then(()=>{this._isReady=!0,this._dispatchImmediate("pan:hello",{id:this.clientId,caps:["client"]});const i=this._pendingOps.slice();this._pendingOps=[],i.forEach(s=>s())})}ready(){return this._ready}_dispatchImmediate(e,t){this.host.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0}))}_dispatch(e,t){this._isReady?this._dispatchImmediate(e,t):this._pendingOps.push(()=>this._dispatchImmediate(e,t))}publish(e){this._dispatch("pan:publish",e)}subscribe(e,t,n={}){e=Array.isArray(e)?e:[e];const i=r=>{const a=r.detail;!a||!a.topic||e.some(d=>c.matches(a.topic,d))&&t(a)};this.host.addEventListener("pan:deliver",i),this._dispatch("pan:subscribe",{clientId:this.clientId,topics:e,options:{retained:!!n.retained}});const s=()=>{this.host.removeEventListener("pan:deliver",i),this._dispatch("pan:unsubscribe",{clientId:this.clientId,topics:e})};if(n.signal){const r=()=>{s(),n.signal?.removeEventListener("abort",r)};n.signal.addEventListener("abort",r,{once:!0})}return s}request(e,t,{timeoutMs:n=5e3}={}){const i=crypto.randomUUID(),s=`pan:$reply:${this.clientId}:${i}`;return new Promise((r,a)=>{const d=this.subscribe(s,h=>{clearTimeout(o),d(),r(h)}),o=setTimeout(()=>{d(),a(new Error("PAN request timeout"))},n);this.publish({topic:e,data:t,replyTo:s,correlationId:i})})}static matches(e,t){if(t==="*"||e===t)return!0;if(t&&t.includes("*")){const n=s=>s.replace(/[|\\{}()\[\]^$+?.]/g,"\\$&").replace(/\*/g,"[^.]+");return new RegExp(`^${n(t)}$`).test(e)}return!1}}var u=c;export{c as PanClient,u as default};
