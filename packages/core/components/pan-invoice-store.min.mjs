class n extends HTMLElement{static observedAttributes=["auto-save"];constructor(){super(),this._currentInvoiceId=null,this._currentInvoice=this._getEmptyInvoice(),this._autoSave=!0,this._saveDebounceTimer=null,this._storageKey="pan-invoices"}connectedCallback(){this._autoSave=this.hasAttribute("auto-save")?this.getAttribute("auto-save")!=="false":!0,this._setupPanListeners(),this._loadInvoicesList();const e=this._getAllInvoices();if(e.length>0){const i=localStorage.getItem("pan-invoice-last-id"),t=e.find(s=>s.id===i)||e[0];this._loadInvoice(t.id)}else this._createNewInvoice()}_setupPanListeners(){const e=document.querySelector("pan-bus");e&&(e.subscribe("invoice.header.changed",i=>{this._currentInvoice.header=i,this._markModified(),this._autoSave&&this._debounceSave()}),e.subscribe("invoice.items.changed",i=>{this._currentInvoice.items=i.items,this._markModified(),this._autoSave&&this._debounceSave()}),e.subscribe("invoice.total.calculated",i=>{this._currentInvoice.totals=i,this._markModified(),this._autoSave&&this._debounceSave()}),e.subscribe("invoice.save",()=>{this._saveCurrentInvoice()}),e.subscribe("invoice.load-by-id",i=>{i.id&&this._loadInvoice(i.id)}),e.subscribe("invoice.new",()=>{this._createNewInvoice()}),e.subscribe("invoice.delete",i=>{const t=i.id||this._currentInvoiceId;t&&this._deleteInvoice(t)}),e.subscribe("invoice.export",()=>{this._exportInvoice()}),e.subscribe("invoice.import",i=>{i.json&&this._importInvoice(i.json)}),e.subscribe("invoice.export-all",()=>{this._exportAllInvoices()}),e.subscribe("invoice.clear",()=>{this._currentInvoice=this._getEmptyInvoice(),this._broadcastInvoice()}))}_getEmptyInvoice(){return{id:this._generateId(),created:new Date().toISOString(),modified:new Date().toISOString(),header:{from:{name:"",address:"",city:"",phone:"",email:""},to:{name:"",address:"",city:"",phone:"",email:""},invoiceNumber:"",invoiceDate:new Date().toLocaleDateString("en-US"),dueDate:""},items:[],totals:{subtotal:0,tax:0,taxRate:0,total:0,notes:""}}}_createNewInvoice(){this._currentInvoice.modified&&this._saveCurrentInvoice(),this._currentInvoice=this._getEmptyInvoice(),this._currentInvoiceId=this._currentInvoice.id;const e=this._getAllInvoices();if(e.length>0){const i=e[e.length-1];i.header?.from&&(this._currentInvoice.header.from={...i.header.from}),i.totals?.taxRate&&(this._currentInvoice.totals.taxRate=i.totals.taxRate)}this._broadcastInvoice(),this._broadcastInvoicesList(),this._publishEvent("invoice.current-changed",{id:this._currentInvoiceId,invoice:this._currentInvoice})}_loadInvoice(e){const t=this._getAllInvoices().find(s=>s.id===e);t&&(this._currentInvoice=t,this._currentInvoiceId=e,localStorage.setItem("pan-invoice-last-id",e),this._broadcastInvoice(),this._publishEvent("invoice.current-changed",{id:this._currentInvoiceId,invoice:this._currentInvoice}))}_saveCurrentInvoice(){const e=this._getAllInvoices(),i=e.findIndex(t=>t.id===this._currentInvoiceId);this._currentInvoice.modified=new Date().toISOString(),i>=0?e[i]=this._currentInvoice:e.push(this._currentInvoice),this._saveAllInvoices(e),this._broadcastInvoicesList(),this._publishEvent("invoice.saved",{id:this._currentInvoiceId,timestamp:this._currentInvoice.modified})}_deleteInvoice(e){if(!confirm("Are you sure you want to delete this invoice?"))return;const t=this._getAllInvoices().filter(s=>s.id!==e);this._saveAllInvoices(t),e===this._currentInvoiceId&&(t.length>0?this._loadInvoice(t[0].id):this._createNewInvoice()),this._broadcastInvoicesList()}_exportInvoice(){const e=JSON.stringify(this._currentInvoice,null,2),i=new Blob([e],{type:"application/json"}),t=URL.createObjectURL(i),s=document.createElement("a");s.href=t,s.download=`invoice-${this._currentInvoice.header.invoiceNumber||this._currentInvoiceId}.json`,s.click(),URL.revokeObjectURL(t)}_exportAllInvoices(){const e=this._getAllInvoices(),i=JSON.stringify(e,null,2),t=new Blob([i],{type:"application/json"}),s=URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=`all-invoices-${new Date().toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(s)}_importInvoice(e){try{const i=typeof e=="string"?JSON.parse(e):e;if(Array.isArray(i)){const t=this._getAllInvoices();i.forEach(s=>{s.id=s.id||this._generateId();const o=t.findIndex(c=>c.id===s.id);o>=0?t[o]=s:t.push(s)}),this._saveAllInvoices(t),this._loadInvoice(i[0].id)}else{i.id=i.id||this._generateId();const t=this._getAllInvoices();t.push(i),this._saveAllInvoices(t),this._loadInvoice(i.id)}this._broadcastInvoicesList()}catch(i){console.error("Failed to import invoice:",i),this._publishEvent("invoice.error",{message:"Failed to import invoice",error:i})}}_broadcastInvoice(){const e=document.querySelector("pan-bus");e&&e.publish("invoice.load",this._currentInvoice)}_broadcastInvoicesList(){const i=this._getAllInvoices().map(t=>({id:t.id,invoiceNumber:t.header?.invoiceNumber||"Untitled",customerName:t.header?.to?.name||"No customer",date:t.header?.invoiceDate||t.created,total:t.totals?.total||0,created:t.created,modified:t.modified}));this._publishEvent("invoice.list-updated",{invoices:i})}_loadInvoicesList(){this._broadcastInvoicesList()}_markModified(){this._currentInvoice.modified=new Date().toISOString()}_debounceSave(){clearTimeout(this._saveDebounceTimer),this._saveDebounceTimer=setTimeout(()=>{this._saveCurrentInvoice()},1e3)}_getAllInvoices(){try{const e=localStorage.getItem(this._storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load invoices:",e),[]}}_saveAllInvoices(e){try{localStorage.setItem(this._storageKey,JSON.stringify(e))}catch(i){console.error("Failed to save invoices:",i),this._publishEvent("invoice.error",{message:"Failed to save to localStorage",error:i})}}_generateId(){return`INV-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}_publishEvent(e,i){const t=document.querySelector("pan-bus");t&&t.publish(e,i)}getCurrentInvoice(){return this._currentInvoice}getAllInvoices(){return this._getAllInvoices()}save(){this._saveCurrentInvoice()}load(e){this._loadInvoice(e)}createNew(){this._createNewInvoice()}}customElements.define("pan-invoice-store",n);var a=n;export{n as PanInvoiceStore,a as default};
