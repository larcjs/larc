import{PanClient as l}from"../core/pan-client.mjs";class h extends HTMLElement{static get observedAttributes(){return["src","topics","with-credentials","persist-last-event","backoff"]}constructor(){super(),this.pc=new l(this),this.es=null,this._stopped=!1,this._timer=null}connectedCallback(){this.#s()}disconnectedCallback(){this._stopped=!0,this.#t()}attributeChangedCallback(){this.#e()}get src(){return(this.getAttribute("src")||"").trim()}get topics(){const t=(this.getAttribute("topics")||"").trim();return t?t.split(/\s+/):[]}get withCredentials(){return(this.getAttribute("with-credentials")||"").toLowerCase()!=="false"}get persistKey(){return(this.getAttribute("persist-last-event")||"").trim()}get backoff(){const t=(this.getAttribute("backoff")||"1000,15000").split(",").map(n=>Number(n)||0),[s,i]=[Math.max(100,t[0]||1e3),Math.max(t[1]||t[0]||5e3,t[0]||1e3)];return{min:s,max:i}}#e(){this.#t(),this.#s()}#t(){try{this.es&&this.es.close()}catch{}this.es=null,this._timer&&(clearTimeout(this._timer),this._timer=null)}#i(){let t=this.src;if(!t)return"";const s=new URL(t,location.origin);if(this.topics.length&&s.searchParams.set("topics",this.topics.join(",")),this.persistKey)try{const i=localStorage.getItem(`pan:sse:last:${this.persistKey}`);i&&s.searchParams.set("lastEventId",i)}catch{}return s.toString()}#s(){if(!this.src||this._stopped)return;const t=this.#i();if(!t)return;const s=new EventSource(t,{withCredentials:this.withCredentials});this.es=s;const i=r=>{const c=r.lastEventId;if(c&&this.persistKey)try{localStorage.setItem(`pan:sse:last:${this.persistKey}`,c)}catch{}let a=r.type&&r.type!=="message"?r.type:"";try{const e=r.data?JSON.parse(r.data):null;if(a||(a=e?.topic||""),!a)return;const o={topic:a,data:e?.data??e?.payload??(e?.item?{item:e.item}:e)};e&&typeof e.retain=="boolean"&&(o.retain=e.retain),this.pc.publish(o)}catch{a&&this.pc.publish({topic:a,data:{raw:r.data}})}},n=()=>{this.#r()};s.addEventListener("message",i),s.addEventListener("error",n)}#r(){if(this._stopped)return;this.#t();const{min:t,max:s}=this.backoff,i=Math.min(s,Math.round(t+Math.random()*(s-t)));this._timer=setTimeout(()=>this.#s(),i)}}customElements.define("pan-sse",h);var d=h;export{h as PanSSE,d as default};
