import{PanClient as u}from"../core/pan-client.mjs";class h extends HTMLElement{constructor(){super(),this.pc=new u(this),this._offs=[],this._refreshTimer=null,this._items=[],this._loading=!1,this._error=null,this._lastUpdated=null}static get observedAttributes(){return["resource","url","path","refresh-interval","transform"]}connectedCallback(){this._init()}disconnectedCallback(){this._offs.forEach(t=>t?.()),this._offs=[],this._stopAutoRefresh()}attributeChangedCallback(){this.isConnected&&this._init()}get resource(){return(this.getAttribute("resource")||"items").trim()}get url(){return(this.getAttribute("url")||"").trim()}get path(){return(this.getAttribute("path")||"").trim()}get refreshInterval(){return parseInt(this.getAttribute("refresh-interval")||"0",10)}get transformFn(){const t=(this.getAttribute("transform")||"").trim();return t&&typeof window[t]=="function"?window[t]:null}_init(){this._offs.forEach(t=>t?.()),this._offs=[],this._stopAutoRefresh(),this._offs.push(this.pc.subscribe(`${this.resource}.list.get`,t=>this._onListGet(t))),this._fetch(),this.refreshInterval>0&&this._startAutoRefresh()}_startAutoRefresh(){this._stopAutoRefresh(),this._refreshTimer=setInterval(()=>{this._fetch()},this.refreshInterval*1e3)}_stopAutoRefresh(){this._refreshTimer&&(clearInterval(this._refreshTimer),this._refreshTimer=null)}_extractPath(t,i){if(!i)return t;const s=i.split(".");let r=t;for(const e of s){if(r==null)return;r=r[e]}return r}_buildUrl(t){let i=this.url;if(!i)return"";if(t&&typeof t=="object"&&!Array.isArray(t)){const s=Object.entries(t).filter(([r,e])=>e!=null&&e!=="");if(s.length>0){const r=new URLSearchParams;for(const[n,a]of s)r.append(n,String(a));const e=i.includes("?")?"&":"?";i=`${i}${e}${r.toString()}`}}return i}async _fetch(t={}){const i=this._buildUrl(t);if(!i){this._publishState({error:"No URL configured"});return}this._loading=!0,this._error=null,this._publishState();try{const s=await fetch(i);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const r=await s.json();let e=this._extractPath(r,this.path);Array.isArray(e)||(e=r.data||r.items||r.results||r.records||[],Array.isArray(e)||(e=Array.isArray(r)?r:[]));const n=this.transformFn;return n&&(e=e.map((a,o)=>{try{return n(a,o)}catch(l){return console.warn(`[pan-open-data-connector] Transform error for item ${o}:`,l),a}})),this._items=e,this._loading=!1,this._lastUpdated=Date.now(),this._publishState(),e}catch(s){return this._loading=!1,this._error=s.message||String(s),this._publishState(),[]}}_publishState(t={}){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:this._items,loading:this._loading,error:this._error,lastUpdated:this._lastUpdated,...t},retain:!0})}async _onListGet(t){const i=t?.data||{},s=await this._fetch(i);t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!this._error,items:s,error:this._error}})}}customElements.define("pan-open-data-connector",h);var _=h;export{h as PanOpenDataConnector,_ as default};
