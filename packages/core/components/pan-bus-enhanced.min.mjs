const d={maxRetained:1e3,maxMessageSize:1048576,maxPayloadSize:524288,cleanupInterval:3e4,rateLimit:1e3,rateLimitWindow:1e3,allowGlobalWildcard:!0,debug:!1};function p(o){try{return JSON.stringify(o),!0}catch{return!1}}function u(o){try{return new Blob([JSON.stringify(o)]).size}catch{return 0}}function h(o){return!o||!o.isConnected?!1:document.contains(o)||document.body.contains(o)}class c extends HTMLElement{static get observedAttributes(){return["max-retained","max-message-size","max-payload-size","cleanup-interval","rate-limit","allow-global-wildcard","debug"]}constructor(){super(),this.config={...d},this.subs=[],this.clients=new Map,this.retained=new Map,this.retainedAccessOrder=[],this.publishCounts=new Map,this.stats={published:0,delivered:0,dropped:0,retainedEvicted:0,subsCleanedUp:0,errors:0},this.cleanupTimer=null}attributeChangedCallback(e,i,t){if(i!==t)switch(e){case"max-retained":this.config.maxRetained=parseInt(t,10)||d.maxRetained;break;case"max-message-size":this.config.maxMessageSize=parseInt(t,10)||d.maxMessageSize;break;case"max-payload-size":this.config.maxPayloadSize=parseInt(t,10)||d.maxPayloadSize;break;case"cleanup-interval":this.config.cleanupInterval=parseInt(t,10)||d.cleanupInterval,this.cleanupTimer&&this._setupCleanup();break;case"rate-limit":this.config.rateLimit=parseInt(t,10)||d.rateLimit;break;case"allow-global-wildcard":this.config.allowGlobalWildcard=t==="true";break;case"debug":this.config.debug=t==="true";break}}connectedCallback(){document.addEventListener("pan:publish",this.onPublish,!0),document.addEventListener("pan:request",this.onPublish,!0),document.addEventListener("pan:reply",this.onReply,!0),document.addEventListener("pan:subscribe",this.onSubscribe,!0),document.addEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.addEventListener("pan:hello",this.onHello,!0),document.addEventListener("pan:sys.stats",this.onGetStats,!0),document.addEventListener("pan:sys.clear-retained",this.onClearRetained,!0),this._setupCleanup(),window.__panReady=!0,this._log("PAN Bus Enhanced ready",this.config),document.dispatchEvent(new CustomEvent("pan:sys.ready",{bubbles:!0,composed:!0,detail:{enhanced:!0,config:this.config}}))}disconnectedCallback(){document.removeEventListener("pan:publish",this.onPublish,!0),document.removeEventListener("pan:request",this.onPublish,!0),document.removeEventListener("pan:reply",this.onReply,!0),document.removeEventListener("pan:subscribe",this.onSubscribe,!0),document.removeEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.removeEventListener("pan:hello",this.onHello,!0),document.removeEventListener("pan:sys.stats",this.onGetStats,!0),document.removeEventListener("pan:sys.clear-retained",this.onClearRetained,!0),this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}_setupCleanup(){this.cleanupTimer&&clearInterval(this.cleanupTimer),this.cleanupTimer=setInterval(()=>{this._cleanupDeadSubscriptions(),this._cleanupRateLimits()},this.config.cleanupInterval)}_cleanupDeadSubscriptions(){const e=this.subs.length;this.subs=this.subs.filter(t=>h(t.el));const i=e-this.subs.length;i>0&&(this.stats.subsCleanedUp+=i,this._log(`Cleaned up ${i} dead subscriptions`))}_cleanupRateLimits(){const e=Date.now();for(const[i,t]of this.publishCounts.entries())e-t.windowStart>this.config.rateLimitWindow*2&&this.publishCounts.delete(i)}_checkRateLimit(e){const i=Date.now();let t=this.publishCounts.get(e);return!t||i-t.windowStart>this.config.rateLimitWindow?(t={count:1,windowStart:i},this.publishCounts.set(e,t),!0):t.count>=this.config.rateLimit?(this._error("Rate limit exceeded",{clientId:e,limit:this.config.rateLimit}),!1):(t.count++,!0)}_validateMessage(e){if(!e.topic||typeof e.topic!="string")return{valid:!1,error:"Invalid topic: must be a non-empty string"};if(e.data!==void 0&&!p(e.data))return{valid:!1,error:"Data must be JSON-serializable (no functions, DOM nodes, circular refs)"};const i=u(e);if(i>this.config.maxMessageSize)return{valid:!1,error:`Message size (${i} bytes) exceeds limit (${this.config.maxMessageSize} bytes)`};const t=u(e.data);return t>this.config.maxPayloadSize?{valid:!1,error:`Payload size (${t} bytes) exceeds limit (${this.config.maxPayloadSize} bytes)`}:{valid:!0}}_storeRetained(e,i){const t=this.retainedAccessOrder.indexOf(e);for(t!==-1&&this.retainedAccessOrder.splice(t,1),this.retainedAccessOrder.push(e),this.retained.set(e,i);this.retained.size>this.config.maxRetained;){const r=this.retainedAccessOrder.shift();r&&(this.retained.delete(r),this.stats.retainedEvicted++,this._log(`Evicted retained message for topic: ${r}`))}}_getRetained(e){const i=this.retained.get(e);if(i){const t=this.retainedAccessOrder.indexOf(e);t!==-1&&(this.retainedAccessOrder.splice(t,1),this.retainedAccessOrder.push(e))}return i}_validateSubscription(e){return e==="*"&&!this.config.allowGlobalWildcard?{valid:!1,error:"Global wildcard (*) subscriptions are disabled for security"}:!e||typeof e!="string"?{valid:!1,error:"Pattern must be a non-empty string"}:{valid:!0}}onHello=e=>{const i=e.detail||{};i.id&&(this.clients.set(i.id,{el:this._et(e),caps:i.caps||[]}),this._log("Client registered",{id:i.id,caps:i.caps}))};onSubscribe=e=>{const{topics:i=[],options:t={},clientId:r}=e.detail||{},s=this._et(e);for(const n of i){const a=this._validateSubscription(n);if(!a.valid){this._error("Subscription rejected",{pattern:n,reason:a.error}),this._emitError(s,"SUBSCRIPTION_INVALID",a.error,{pattern:n});continue}this.subs.push({pattern:n,el:s,clientId:r,retained:!!t.retained}),this._log("Subscription added",{pattern:n,clientId:r})}if(t.retained)for(const[n,a]of this.retained)i.some(l=>c.matches(n,l))&&this._deliver(s,this._getRetained(n))};onUnsubscribe=e=>{const{topics:i=[],clientId:t}=e.detail||{},r=this._et(e),s=this.subs.length;this.subs=this.subs.filter(a=>!((t?a.clientId===t:a.el===r)&&i.includes(a.pattern)));const n=s-this.subs.length;n>0&&this._log("Unsubscribed",{topics:i,clientId:t,count:n})};onPublish=e=>{const i=e.detail||{},t=this._et(e),r=i.clientId||t&&t.dataset&&t.dataset.panClientId||"anonymous";if(!this._checkRateLimit(r)){this.stats.dropped++,this._emitError(t,"RATE_LIMIT_EXCEEDED","Too many messages",{clientId:r});return}const s={ts:Date.now(),id:crypto.randomUUID(),...i},n=this._validateMessage(s);if(!n.valid){this.stats.errors++,this._error("Message validation failed",{topic:s.topic,error:n.error}),this._emitError(t,"MESSAGE_INVALID",n.error,{topic:s.topic});return}this.stats.published++,s.retain&&this._storeRetained(s.topic,s);let a=0;for(const l of this.subs)c.matches(s.topic,l.pattern)&&this._deliver(l.el,s)&&a++;this.stats.delivered+=a,this._log("Published",{topic:s.topic,retain:s.retain,delivered:a})};onReply=e=>{const i=e.detail||{};for(const t of this.subs)c.matches(i.topic,t.pattern)&&this._deliver(t.el,i)};onGetStats=e=>{const i=this._et(e),t={...this.stats,subscriptions:this.subs.length,clients:this.clients.size,retained:this.retained.size,config:this.config};i.dispatchEvent(new CustomEvent("pan:deliver",{detail:{topic:"pan:sys.stats",data:t,id:crypto.randomUUID(),ts:Date.now()}}))};onClearRetained=e=>{const{pattern:i}=e.detail||{};if(i){let t=0;for(const r of this.retained.keys())if(c.matches(r,i)){this.retained.delete(r);const s=this.retainedAccessOrder.indexOf(r);s!==-1&&this.retainedAccessOrder.splice(s,1),t++}this._log(`Cleared ${t} retained messages matching pattern: ${i}`)}else{const t=this.retained.size;this.retained.clear(),this.retainedAccessOrder=[],this._log(`Cleared all ${t} retained messages`)}};_deliver(e,i){try{return h(e)?(e.dispatchEvent(new CustomEvent("pan:deliver",{detail:i})),!0):!1}catch(t){return this._error("Delivery failed",{topic:i.topic,error:t.message}),!1}}_emitError(e,i,t,r={}){const s={topic:"pan:sys.error",data:{code:i,message:t,details:r},id:crypto.randomUUID(),ts:Date.now()};try{e.dispatchEvent(new CustomEvent("pan:deliver",{detail:s}))}catch{this._error("Cannot deliver error event",{code:i,message:t})}document.dispatchEvent(new CustomEvent("pan:sys.error",{bubbles:!0,composed:!0,detail:s.data}))}_et(e){return typeof e.composedPath=="function"?e.composedPath()[0]:e.target||document}_log(...e){this.config.debug&&console.log("[PAN Bus]",...e)}_error(...e){console.error("[PAN Bus ERROR]",...e),this.stats.errors++}static matches(e,i){if(i==="*"||e===i)return!0;if(i&&i.includes("*")){const t=s=>s.replace(/[|\\{}()\[\]^$+?.]/g,"\\$&").replace(/\*/g,"[^.]+");return new RegExp(`^${t(i)}$`).test(e)}return!1}}customElements.define("pan-bus-enhanced",c);var m=c;export{c as PanBusEnhanced,m as default};
