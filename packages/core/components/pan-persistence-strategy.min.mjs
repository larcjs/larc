class l extends HTMLElement{static observedAttributes=["auto-hydrate","debug"];constructor(){super(),this._strategies=[],this._subscriptions=new Map,this._ttlTimers=new Map,this._panClient=null,this._db=null,this._initialized=!1}connectedCallback(){this._waitForPanBus().then(()=>{this._initialize()})}disconnectedCallback(){this._cleanup()}async _waitForPanBus(){let e=document.querySelector("pan-bus");if(!(e&&e.panClient))return new Promise(t=>{const s=setInterval(()=>{e=document.querySelector("pan-bus"),e&&e.panClient&&(clearInterval(s),t())},50);setTimeout(()=>{clearInterval(s),t()},5e3)})}async _initialize(){if(!this._initialized){if(this._panClient=this._getPanClient(),!this._panClient){console.error("pan-persistence-strategy could not find pan-client");return}this._parseStrategies(),this._strategies.some(e=>e.storage==="indexedDB")&&await this._initIndexedDB();for(const e of this._strategies)this._subscribeToTopics(e);this.hasAttribute("auto-hydrate")&&await this._hydrateAll(),this._initialized=!0,this._log("Initialized",{strategies:this._strategies.length})}}_cleanup(){for(const[e,t]of this._subscriptions.entries())this._panClient?.unsubscribe(e,t);this._subscriptions.clear();for(const e of this._ttlTimers.values())clearTimeout(e);this._ttlTimers.clear(),this._db&&(this._db.close(),this._db=null),this._initialized=!1}_parseStrategies(){const e=this.querySelectorAll("strategy");for(const t of e){const s=t.getAttribute("topics")||"*",i=t.getAttribute("storage")||"memory",r=parseInt(t.getAttribute("ttl")||"0",10),n=t.getAttribute("database")||"pan-persistence",o=parseInt(t.getAttribute("max-size")||"0",10),a=t.hasAttribute("compress");this._strategies.push({topics:s.split(",").map(c=>c.trim()),storage:i,ttl:r,database:n,maxSize:o,compress:a})}this._log("Parsed strategies",this._strategies)}async _initIndexedDB(){const e=new Set(this._strategies.filter(s=>s.storage==="indexedDB").map(s=>s.database)),t=Array.from(e)[0]||"pan-persistence";return new Promise((s,i)=>{const r=indexedDB.open(t,1);r.onerror=()=>i(r.error),r.onsuccess=()=>{this._db=r.result,s()},r.onupgradeneeded=n=>{const o=n.target.result;if(!o.objectStoreNames.contains("persistence")){const a=o.createObjectStore("persistence",{keyPath:"topic"});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("expires","expires",{unique:!1})}}})}_subscribeToTopics(e){for(const t of e.topics){if(this._subscriptions.has(t))continue;const s=i=>{this._handleMessage(i,e)};this._panClient.subscribe(t,s),this._subscriptions.set(t,s),this._log("Subscribed",{pattern:t,storage:e.storage})}}async _handleMessage(e,t){const s=e.topic,i=e.data;if(t.maxSize>0){const r=JSON.stringify(i).length;if(r>t.maxSize){this._log("Data exceeds max size",{topic:s,size:r,max:t.maxSize});return}}try{switch(t.storage){case"memory":t.ttl>0&&this._setTTL(s,t.ttl);break;case"localStorage":await this._saveToLocalStorage(s,i,t);break;case"sessionStorage":await this._saveToSessionStorage(s,i,t);break;case"indexedDB":await this._saveToIndexedDB(s,i,t);break;default:this._log("Unknown storage type",{storage:t.storage})}this._publishEvent("persist.saved",{topic:s,storage:t.storage,timestamp:Date.now()})}catch(r){console.error("Failed to persist data:",r),this._publishEvent("persist.error",{topic:s,storage:t.storage,error:r.message})}}async _saveToLocalStorage(e,t,s){const i={data:t,timestamp:Date.now(),expires:s.ttl>0?Date.now()+s.ttl:null},r=this._getStorageKey(e);localStorage.setItem(r,JSON.stringify(i)),s.ttl>0&&this._setTTL(e,s.ttl,"localStorage")}async _saveToSessionStorage(e,t,s){const i={data:t,timestamp:Date.now(),expires:s.ttl>0?Date.now()+s.ttl:null},r=this._getStorageKey(e);sessionStorage.setItem(r,JSON.stringify(i)),s.ttl>0&&this._setTTL(e,s.ttl,"sessionStorage")}async _saveToIndexedDB(e,t,s){return new Promise((i,r)=>{const n={topic:e,data:t,timestamp:Date.now(),expires:s.ttl>0?Date.now()+s.ttl:null},c=this._db.transaction(["persistence"],"readwrite").objectStore("persistence").put(n);c.onsuccess=()=>{s.ttl>0&&this._setTTL(e,s.ttl,"indexedDB"),i()},c.onerror=()=>r(c.error)})}_setTTL(e,t,s=null){this._ttlTimers.has(e)&&clearTimeout(this._ttlTimers.get(e));const i=setTimeout(()=>{this._expireData(e,s)},t);this._ttlTimers.set(e,i)}async _expireData(e,t){if(this._log("Expiring data",{topic:e,storage:t}),t==="localStorage"){const s=this._getStorageKey(e);localStorage.removeItem(s)}else if(t==="sessionStorage"){const s=this._getStorageKey(e);sessionStorage.removeItem(s)}else t==="indexedDB"&&await this._removeFromIndexedDB(e);this._ttlTimers.delete(e)}async _removeFromIndexedDB(e){return new Promise((t,s)=>{const n=this._db.transaction(["persistence"],"readwrite").objectStore("persistence").delete(e);n.onsuccess=()=>t(),n.onerror=()=>s(n.error)})}async _hydrateAll(){this._log("Hydrating all persisted state");for(const e of this._strategies)try{switch(e.storage){case"localStorage":await this._hydrateFromLocalStorage(e);break;case"sessionStorage":await this._hydrateFromSessionStorage(e);break;case"indexedDB":await this._hydrateFromIndexedDB(e);break}}catch(t){console.error("Failed to hydrate from",e.storage,t)}this._publishEvent("persist.hydrated",{timestamp:Date.now()}),this._log("Hydration complete")}async _hydrateFromLocalStorage(e){const t=this._getStorageKey("");for(let s=0;s<localStorage.length;s++){const i=localStorage.key(s);if(i.startsWith(t)){const r=i.substring(t.length);if(this._matchesTopicPattern(r,e.topics)){const n=localStorage.getItem(i);if(n){const o=JSON.parse(n);if(o.expires&&Date.now()>o.expires){localStorage.removeItem(i);continue}if(this._panClient.publish(r,o.data,{retain:!0}),o.expires){const a=o.expires-Date.now();a>0&&this._setTTL(r,a,"localStorage")}}}}}}async _hydrateFromSessionStorage(e){const t=this._getStorageKey("");for(let s=0;s<sessionStorage.length;s++){const i=sessionStorage.key(s);if(i.startsWith(t)){const r=i.substring(t.length);if(this._matchesTopicPattern(r,e.topics)){const n=sessionStorage.getItem(i);if(n){const o=JSON.parse(n);if(o.expires&&Date.now()>o.expires){sessionStorage.removeItem(i);continue}if(this._panClient.publish(r,o.data,{retain:!0}),o.expires){const a=o.expires-Date.now();a>0&&this._setTTL(r,a,"sessionStorage")}}}}}}async _hydrateFromIndexedDB(e){return new Promise((t,s)=>{const n=this._db.transaction(["persistence"],"readonly").objectStore("persistence").getAll();n.onsuccess=()=>{const o=n.result;for(const a of o)if(this._matchesTopicPattern(a.topic,e.topics)){if(a.expires&&Date.now()>a.expires){this._removeFromIndexedDB(a.topic);continue}if(this._panClient.publish(a.topic,a.data,{retain:!0}),a.expires){const c=a.expires-Date.now();c>0&&this._setTTL(a.topic,c,"indexedDB")}}t()},n.onerror=()=>s(n.error)})}_matchesTopicPattern(e,t){for(const s of t)if(new RegExp("^"+s.replace(/\*/g,".*")+"$").test(e))return!0;return!1}_getStorageKey(e){return`pan-persist:${e}`}_publishEvent(e,t){this._panClient&&this._panClient.publish(`persist.${e}`,t,{retain:!1})}_getPanClient(){if(this._panClient)return this._panClient;const t=document.querySelector("pan-bus")?.panClient||document.querySelector("pan-client");return t&&(this._panClient=t.client||t),this._panClient}_log(...e){this.hasAttribute("debug")&&console.log("[pan-persistence-strategy]",...e)}async hydrate(){await this._hydrateAll()}async clearAll(){for(const e of this._strategies)switch(e.storage){case"localStorage":this._clearStorage(localStorage);break;case"sessionStorage":this._clearStorage(sessionStorage);break;case"indexedDB":await this._clearIndexedDB();break}this._log("Cleared all persisted data")}_clearStorage(e){const t=this._getStorageKey(""),s=[];for(let i=0;i<e.length;i++){const r=e.key(i);r.startsWith(t)&&s.push(r)}for(const i of s)e.removeItem(i)}async _clearIndexedDB(){return new Promise((e,t)=>{const r=this._db.transaction(["persistence"],"readwrite").objectStore("persistence").clear();r.onsuccess=()=>e(),r.onerror=()=>t(r.error)})}getStrategies(){return[...this._strategies]}}customElements.define("pan-persistence-strategy",l);export{l as PanPersistenceStrategy};
