import{PanClient as n}from"../../../core/pan-client.mjs";class h extends HTMLElement{constructor(){super(),this.pc=new n(this),this._offs=[],this.paths={},this.ops={},this.authState=null}static get observedAttributes(){return["resource","endpoint","key"]}connectedCallback(){this.#i()}disconnectedCallback(){this._offs.forEach(t=>t&&t()),this._offs=[],this._authOff?.()}attributeChangedCallback(){this.#i()}get resource(){return(this.getAttribute("resource")||"items").trim()}get endpoint(){return(this.getAttribute("endpoint")||"").trim()}get key(){return(this.getAttribute("key")||"id").trim()}#i(){this._offs.forEach(s=>s&&s()),this._offs=[],this.#o(),this._authOff=this.pc.subscribe("auth.internal.state",s=>{this.authState=s.data},{retained:!0});const t=this.resource;this._offs.push(this.pc.subscribe(`${t}.list.get`,s=>this.#a(s))),this._offs.push(this.pc.subscribe(`${t}.item.get`,s=>this.#h(s))),this._offs.push(this.pc.subscribe(`${t}.item.save`,s=>this.#n(s))),this._offs.push(this.pc.subscribe(`${t}.item.delete`,s=>this.#c(s)))}#o(){this.ops={},this.paths={},this.querySelectorAll('script[type="application/graphql"]').forEach(s=>{const e=(s.getAttribute("data-op")||"").trim();e&&(this.ops[e]=s.textContent||"")});const t=this.querySelector('script[type="application/json"][data-paths]');if(t&&t.textContent?.trim())try{this.paths=JSON.parse(t.textContent.trim())}catch{}}async#t(t,s){if(!this.endpoint)throw new Error("Missing endpoint");const e={"Content-Type":"application/json"};this.authState?.authenticated&&this.authState?.token&&(e.Authorization=`Bearer ${this.authState.token}`);const i=await(await fetch(this.endpoint,{method:"POST",headers:e,body:JSON.stringify({query:t,variables:s})})).json();if(i.errors&&i.errors.length)throw new Error(i.errors.map(o=>o.message).join("; "));return i}#s(t,s){if(!s)return t;const e=String(s).split(".");let r=t;for(const i of e){if(r==null)return;r=r[i]}return r}#r(t){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:Array.isArray(t)?t:[]},retain:!0})}#e(t,s={}){try{const e=t&&typeof t=="object"?t[this.key]??t.id:t;if(e==null)return;s.deleted?this.pc.publish({topic:`${this.resource}.item.state.${e}`,data:{id:e,deleted:!0}}):this.pc.publish({topic:`${this.resource}.item.state.${e}`,data:{item:t},retain:!0})}catch{}}async#a(t){try{const s=this.ops.list;if(!s)throw new Error("Missing list GraphQL");const e=await this.#t(s,t?.data||{}),r=this.#s(e,this.paths.list)||[];this.#r(r),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,items:r}})}catch(s){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:String(s&&s.message||s)}}),this.#r([])}}async#h(t){try{const s=this.ops.item;if(!s)throw new Error("Missing item GraphQL");const e={id:t?.data?.[this.key]??t?.data?.id??t?.data},r=await this.#t(s,e),i=this.#s(r,this.paths.item)||null;i&&this.#e(i),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!!i,item:i}})}catch(s){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:String(s&&s.message||s)}})}}async#n(t){try{const s=this.ops.save;if(!s)throw new Error("Missing save GraphQL");const e=t?.data?.item??t?.data??{},r=e?.[this.key]??e?.id,i=Object.assign({item:e},r!=null?{id:r}:{}),o=await this.#t(s,i),a=this.#s(o,this.paths.save)||e;this.#e(a),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,item:a}}),this.pc.publish({topic:`${this.resource}.list.get`,data:{}})}catch(s){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:String(s&&s.message||s)}})}}async#c(t){try{const s=this.ops.delete;if(!s)throw new Error("Missing delete GraphQL");const e=t?.data?.[this.key]??t?.data?.id??t?.data,r=await this.#t(s,{id:e}),i=!!this.#s(r,this.paths.delete);i&&this.#e(e,{deleted:!0}),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:i,id:e}}),this.pc.publish({topic:`${this.resource}.list.get`,data:{}})}catch(s){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:String(s&&s.message||s)}})}}}customElements.define("pan-graphql-connector",h);var l=h;export{h as PanGraphQLConnector,l as default};
