class f{constructor(){this.enabled=!1,this.traceBuffer=[],this.maxBuffer=1e3,this.sampleRate=1,this.messageCount=0}enableTracing(e={}){this.enabled=!0,this.maxBuffer=e.maxBuffer!==void 0?e.maxBuffer:1e3,this.sampleRate=e.sampleRate!==void 0?e.sampleRate:1,this.sampleRate<0&&(this.sampleRate=0),this.sampleRate>1&&(this.sampleRate=1),console.log(`[PAN Debug] Tracing enabled (buffer: ${this.maxBuffer}, sample rate: ${this.sampleRate})`)}disableTracing(){this.enabled=!1,console.log(`[PAN Debug] Tracing disabled (captured ${this.traceBuffer.length} messages)`)}trace(e,t=[]){if(!this.enabled||(this.messageCount++,this.sampleRate<1&&Math.random()>this.sampleRate))return;const s={message:this._sanitizeMessage(e),matchedRoutes:t.map(a=>({id:a.id,name:a.name,actions:a.actions.map(i=>i.type),error:null})),ts:Date.now(),sequence:this.messageCount};for(this.traceBuffer.push(s);this.traceBuffer.length>this.maxBuffer;)this.traceBuffer.shift()}traceError(e,t,s){if(!this.enabled)return;const a=this.traceBuffer.slice().reverse().find(i=>i.message.id===e.id);if(a){const i=a.matchedRoutes.find(n=>n.id===t.id);i&&(i.error={message:s.message||String(s),stack:s.stack})}}getTrace(){return[...this.traceBuffer]}clearTrace(){this.traceBuffer=[],this.messageCount=0,console.log("[PAN Debug] Trace buffer cleared")}getStats(){const e={enabled:this.enabled,messageCount:this.messageCount,bufferSize:this.traceBuffer.length,maxBuffer:this.maxBuffer,sampleRate:this.sampleRate};return this.traceBuffer.length>0&&(e.oldestMessage=this.traceBuffer[0].ts,e.newestMessage=this.traceBuffer[this.traceBuffer.length-1].ts,e.timespan=e.newestMessage-e.oldestMessage),e}query(e={}){let t=[...this.traceBuffer];return e.topic&&(t=t.filter(s=>s.message.topic===e.topic)),e.type&&(t=t.filter(s=>s.message.type===e.type)),e.hasRoutes!==void 0&&(e.hasRoutes?t=t.filter(s=>s.matchedRoutes.length>0):t=t.filter(s=>s.matchedRoutes.length===0)),e.hasErrors!==void 0&&(e.hasErrors?t=t.filter(s=>s.matchedRoutes.some(a=>a.error!==null)):t=t.filter(s=>!s.matchedRoutes.some(a=>a.error!==null))),e.startTs&&(t=t.filter(s=>s.ts>=e.startTs)),e.endTs&&(t=t.filter(s=>s.ts<=e.endTs)),e.limit&&e.limit>0&&(t=t.slice(-e.limit)),t}export(){return JSON.stringify(this.traceBuffer,null,2)}import(e){try{const t=JSON.parse(e);Array.isArray(t)&&(this.traceBuffer=t,console.log(`[PAN Debug] Imported ${t.length} trace entries`))}catch(t){throw console.error("[PAN Debug] Failed to import trace:",t),t}}_sanitizeMessage(e){try{return JSON.parse(JSON.stringify(e))}catch{return{id:e.id,type:e.type,topic:e.topic,ts:e.ts,error:"Failed to serialize message"}}}}function u(r,e,t){const s={timestamp:Date.now(),bus:null,routes:null,debug:null};return r&&typeof r.stats=="object"&&(s.bus={stats:{...r.stats},subscriptions:r.subs?r.subs.length:0,retained:r.retained?r.retained.size:0}),e&&typeof e.getStats=="function"&&(s.routes=e.getStats()),t&&typeof t.getStats=="function"&&(s.debug=t.getStats()),s}var c=f;export{f as PanDebugManager,u as captureSnapshot,c as default};
