class r extends HTMLElement{constructor(){super(),this.subs=[],this.retained=new Map,this.clients=new Map}connectedCallback(){document.addEventListener("pan:publish",this.onPublish,!0),document.addEventListener("pan:request",this.onPublish,!0),document.addEventListener("pan:reply",this.onReply,!0),document.addEventListener("pan:subscribe",this.onSubscribe,!0),document.addEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.addEventListener("pan:hello",this.onHello,!0),window.__panReady=!0,document.dispatchEvent(new CustomEvent("pan:sys.ready",{bubbles:!0,composed:!0,detail:{lite:!0}})),typeof window<"u"&&(window.pan=window.pan||{},window.pan.bus=this)}disconnectedCallback(){document.removeEventListener("pan:publish",this.onPublish,!0),document.removeEventListener("pan:request",this.onPublish,!0),document.removeEventListener("pan:reply",this.onReply,!0),document.removeEventListener("pan:subscribe",this.onSubscribe,!0),document.removeEventListener("pan:unsubscribe",this.onUnsubscribe,!0),document.removeEventListener("pan:hello",this.onHello,!0),typeof window<"u"&&window.pan&&delete window.pan.bus}onHello=e=>{const t=e.detail||{};t.id&&this.clients.set(t.id,{el:this._et(e),caps:t.caps||[]})};onSubscribe=e=>{const{topics:t=[],options:n={},clientId:s}=e.detail||{},i=this._et(e);for(const o of t)this.subs.push({pattern:o,el:i,clientId:s});if(n.retained)for(const[o,u]of this.retained)t.some(d=>r.matches(o,d))&&this._deliver(i,u)};onUnsubscribe=e=>{const{topics:t=[],clientId:n}=e.detail||{},s=this._et(e);this.subs=this.subs.filter(i=>!((n?i.clientId===n:i.el===s)&&t.includes(i.pattern)))};onPublish=e=>{const t=e.detail||{},n={ts:Date.now(),id:crypto.randomUUID(),...t};n.retain&&this.retained.set(n.topic,n);for(const s of this.subs)r.matches(n.topic,s.pattern)&&this._deliver(s.el,n)};onReply=e=>{const t=e.detail||{};for(const n of this.subs)r.matches(t.topic,n.pattern)&&this._deliver(n.el,t)};_deliver(e,t){try{return!e||!e.dispatchEvent?!1:(e.dispatchEvent(new CustomEvent("pan:deliver",{detail:t,bubbles:!0,composed:!0})),!0)}catch{return!1}}_et(e){return typeof e.composedPath=="function"?e.composedPath()[0]:e.target||document}static matches(e,t){if(t==="*"||e===t)return!0;if(t&&t.includes("*")){const n=i=>i.replace(/[|\\{}()\[\]^$+?.]/g,"\\$&").replace(/\*/g,"[^.]+");return new RegExp(`^${n(t)}$`).test(e)}return!1}publish(e,t,n={}){document.dispatchEvent(new CustomEvent("pan:publish",{detail:{topic:e,data:t,...n},bubbles:!0,composed:!0}))}subscribe(e,t){e=Array.isArray(e)?e:[e];const n=`bus-direct-${crypto.randomUUID()}`,s=i=>{const o=i.detail;!o||!o.topic||e.some(u=>r.matches(o.topic,u))&&t(o)};return document.addEventListener("pan:deliver",s),document.dispatchEvent(new CustomEvent("pan:subscribe",{detail:{clientId:n,topics:e,options:{}},bubbles:!0,composed:!0})),()=>{document.removeEventListener("pan:deliver",s),document.dispatchEvent(new CustomEvent("pan:unsubscribe",{detail:{clientId:n,topics:e},bubbles:!0,composed:!0}))}}}customElements.define("pan-bus",r);var c=r;export{r as PanBusLite,c as default};
