function u(s,t){if(!t||!s)return;const e=t.split(".");let r=s;for(const n of e){if(r==null)return;r=r[n]}return r}function h(s,t,e){if(!t||!s)return;const r=t.split(".");let n=s;for(let o=0;o<r.length-1;o++){const a=r[o];if(a==="__proto__"||a==="constructor"||a==="prototype"){console.warn(`[PAN Routes] Blocked attempt to set dangerous property: ${a}`);return}(!(a in n)||typeof n[a]!="object")&&(n[a]={}),n=n[a]}const i=r[r.length-1];if(i==="__proto__"||i==="constructor"||i==="prototype"){console.warn(`[PAN Routes] Blocked attempt to set dangerous property: ${i}`);return}n[i]=e}function f(){return`route-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function d(s){if(s===null||typeof s!="object")return s;if(s instanceof Date)return new Date(s);if(s instanceof Array)return s.map(e=>d(e));const t={};for(const e in s)e==="__proto__"||e==="constructor"||e==="prototype"||s.hasOwnProperty(e)&&(t[e]=d(s[e]));return t}function l(s,t){if(!t)return!0;const{op:e,path:r,value:n,children:i,child:o}=t;try{switch(e){case"eq":return u(s,r)===n;case"neq":return u(s,r)!==n;case"gt":return u(s,r)>n;case"gte":return u(s,r)>=n;case"lt":return u(s,r)<n;case"lte":return u(s,r)<=n;case"in":return Array.isArray(n)&&n.includes(u(s,r));case"regex":{const a=u(s,r);return typeof a!="string"?!1:new RegExp(n).test(a)}case"and":return Array.isArray(i)&&i.every(a=>l(s,a));case"or":return Array.isArray(i)&&i.some(a=>l(s,a));case"not":return!l(s,o);default:return console.warn(`[PAN Routes] Unknown predicate operator: ${e}`),!1}}catch(a){return console.error("[PAN Routes] Predicate evaluation error:",a),!1}}function p(s,t){if(!t)return!0;if(t.type&&!(Array.isArray(t.type)?t.type:[t.type]).includes(s.type)||t.topic&&!(Array.isArray(t.topic)?t.topic:[t.topic]).includes(s.topic))return!1;if(t.source){const e=Array.isArray(t.source)?t.source:[t.source],r=s.meta?.source||s.source;if(!e.includes(r))return!1}if(t.tagsAny&&Array.isArray(t.tagsAny)){const e=s.meta?.tags||[];if(!t.tagsAny.some(r=>e.includes(r)))return!1}if(t.tagsAll&&Array.isArray(t.tagsAll)){const e=s.meta?.tags||[];if(!t.tagsAll.every(r=>e.includes(r)))return!1}return!(t.where&&!l(s,t.where))}function y(s,t,e){if(!t)return s;try{const{op:r}=t;switch(r){case"identity":return s;case"pick":{const n={...s};if(!t.paths||!Array.isArray(t.paths))return n;const i={},o={};for(const a of t.paths){const c=u(s,a);c!==void 0&&h(a.startsWith("payload.")?i:o,a,c)}return{...n,payload:Object.keys(i).length>0?i:n.payload,meta:Object.keys(o).length>0?o:n.meta}}case"map":{if(!t.fnId||!e.has(t.fnId))return console.warn(`[PAN Routes] Transform function not found: ${t.fnId}`),s;const n=e.get(t.fnId),i=u(s,t.path),o=n(i),a=d(s);return h(a,t.path,o),a}case"custom":return!t.fnId||!e.has(t.fnId)?(console.warn(`[PAN Routes] Transform function not found: ${t.fnId}`),s):e.get(t.fnId)(s);default:return console.warn(`[PAN Routes] Unknown transform operator: ${r}`),s}}catch(r){return console.error("[PAN Routes] Transform error:",r),s}}function A(s,t){return!s||typeof s!="string"?"":s.replace(/\{\{([^}]+)\}\}/g,(e,r)=>{const n=u(t,r.trim());return n!==void 0?String(n):e})}function g(s,t,e){const{bus:r,handlers:n,logger:i}=e;try{switch(s.type){case"EMIT":{const o={...s.message};if(s.inherit&&Array.isArray(s.inherit))for(const a of s.inherit)a==="payload"&&t.payload?o.payload={...t.payload,...o.payload}:a==="meta"&&t.meta&&(o.meta={...t.meta,...o.meta});r&&typeof r.publish=="function"&&r.publish(o.topic||o.type,o.payload,{...o,retain:o.retain||!1});break}case"FORWARD":{const o={...t};s.topic&&(o.topic=s.topic),s.typeOverride&&(o.type=s.typeOverride),r&&typeof r.publish=="function"&&r.publish(o.topic||o.type,o.payload||o.data,o);break}case"LOG":{const o=s.level||"info",a=s.template||"{{type}}: {{payload}}",c=A(a,t);i&&typeof i[o]=="function"?i[o]("[PAN Routes]",c,t):console[o]?.("[PAN Routes]",c,t)||console.log("[PAN Routes]",c,t);break}case"CALL":{if(!s.handlerId||!n.has(s.handlerId)){console.warn(`[PAN Routes] Handler not found: ${s.handlerId}`);break}n.get(s.handlerId)(t);break}default:console.warn(`[PAN Routes] Unknown action type: ${s.type}`)}}catch(o){throw console.error("[PAN Routes] Action execution error:",o),o}}class w{constructor(t=null){this.bus=t,this.routes=new Map,this.transformFns=new Map,this.handlers=new Map,this.storage=null,this.logger=null,this.changeListeners=[],this.errorListeners=[],this.enabled=!0,this.controlGuard=null,this.stats={routesEvaluated:0,routesMatched:0,actionsExecuted:0,errors:0}}add(t){try{const e={id:t.id||f(),name:t.name||`Route ${this.routes.size+1}`,enabled:t.enabled!==!1,order:t.order||0,match:t.match||{},transform:t.transform||null,actions:t.actions||[],meta:{createdBy:t.meta?.createdBy||"system",createdAt:Date.now(),updatedAt:Date.now(),tags:t.meta?.tags||[]}};if(!e.actions||e.actions.length===0)throw new Error("Route must have at least one action");return this.routes.set(e.id,e),this._notifyChange(),this._persist(),e}catch(e){throw this._handleError("ADD_ROUTE_FAILED",e,{routeInput:t}),e}}update(t,e){try{const r=this.routes.get(t);if(!r)throw new Error(`Route not found: ${t}`);const n={...r,...e,id:r.id,meta:{...r.meta,...e.meta||{},updatedAt:Date.now()}};return this.routes.set(t,n),this._notifyChange(),this._persist(),n}catch(r){throw this._handleError("UPDATE_ROUTE_FAILED",r,{id:t,patch:e}),r}}remove(t){try{const e=this.routes.delete(t);return e&&(this._notifyChange(),this._persist()),e}catch(e){throw this._handleError("REMOVE_ROUTE_FAILED",e,{id:t}),e}}enable(t){this.update(t,{enabled:!0})}disable(t){this.update(t,{enabled:!1})}get(t){return this.routes.get(t)}list(t={}){let e=Array.from(this.routes.values());return t.enabled!==void 0&&(e=e.filter(r=>r.enabled===t.enabled)),e.sort((r,n)=>r.order!==n.order?r.order-n.order:(r.meta?.createdAt||0)-(n.meta?.createdAt||0)),e}clear(){this.routes.clear(),this._notifyChange(),this._persist()}registerTransformFn(t,e){if(typeof e!="function")throw new Error("Transform must be a function");this.transformFns.set(t,e)}registerHandler(t,e){if(typeof e!="function")throw new Error("Handler must be a function");this.handlers.set(t,e)}useStorage(t){this.storage=t,t&&typeof t.load=="function"&&t.load().then(e=>{Array.isArray(e)&&e.forEach(r=>this.add(r))}).catch(e=>{console.error("[PAN Routes] Failed to load routes from storage:",e)})}useLogger(t){this.logger=t}setControlGuard(t){this.controlGuard=t}onRoutesChanged(t){return this.changeListeners.push(t),()=>{const e=this.changeListeners.indexOf(t);e!==-1&&this.changeListeners.splice(e,1)}}onError(t){return this.errorListeners.push(t),()=>{const e=this.errorListeners.indexOf(t);e!==-1&&this.errorListeners.splice(e,1)}}processMessage(t){if(!this.enabled||this.routes.size===0)return;const e=[],r=this.list({enabled:!0});for(const n of r)this.stats.routesEvaluated++,p(t,n.match)&&(this.stats.routesMatched++,e.push(n));for(const n of e)try{const i=y(t,n.transform,this.transformFns),o={bus:this.bus,handlers:this.handlers,logger:this.logger};for(const a of n.actions)g(a,i,o),this.stats.actionsExecuted++}catch(i){this._handleError("ROUTE_EXECUTION_FAILED",i,{routeId:n.id,routeName:n.name,message:t})}return e}handleControlMessage(t){if(this.controlGuard&&!this.controlGuard(t)){console.warn("[PAN Routes] Control message rejected by guard:",t);return}const{type:e,payload:r}=t;try{switch(e){case"pan.routes.add":return this.add(r.route);case"pan.routes.update":return this.update(r.id,r.patch);case"pan.routes.remove":return this.remove(r.id);case"pan.routes.enable":return this.enable(r.id),{success:!0};case"pan.routes.disable":return this.disable(r.id),{success:!0};case"pan.routes.list":return this.list(r||{});case"pan.routes.clear":return this.clear(),{success:!0};default:return console.warn(`[PAN Routes] Unknown control message type: ${e}`),null}}catch(n){throw this._handleError("CONTROL_MESSAGE_FAILED",n,{type:e,payload:r}),n}}getStats(){return{...this.stats,routeCount:this.routes.size,enabledRouteCount:this.list({enabled:!0}).length,transformFnCount:this.transformFns.size,handlerCount:this.handlers.size}}resetStats(){this.stats={routesEvaluated:0,routesMatched:0,actionsExecuted:0,errors:0}}setEnabled(t){this.enabled=t}_notifyChange(){const t=this.list();this.changeListeners.forEach(e=>{try{e(t)}catch(r){console.error("[PAN Routes] Change listener error:",r)}})}_persist(){if(this.storage&&typeof this.storage.save=="function"){const t=this.list();this.storage.save(t).catch(e=>{console.error("[PAN Routes] Failed to save routes:",e)})}}_handleError(t,e,r={}){this.stats.errors++;const n={code:t,message:e.message||String(e),details:r,timestamp:Date.now()};this.errorListeners.forEach(i=>{try{i(n)}catch(o){console.error("[PAN Routes] Error listener failed:",o)}}),console.error(`[PAN Routes] ${t}:`,e,r)}}var E=w;export{w as PanRoutesManager,E as default};
