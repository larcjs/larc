import{PanClient as h}from"../core/pan-client.mjs";class a extends HTMLElement{constructor(){super(),this.pc=new h(this),this._offs=[],this._items=[],this._nextId=1}static get observedAttributes(){return["resource","key"]}connectedCallback(){this._loadInlineData(),this._init()}disconnectedCallback(){this._offs.forEach(t=>t?.()),this._offs=[]}attributeChangedCallback(){this.isConnected&&this._init()}get resource(){return(this.getAttribute("resource")||"items").trim()}get key(){return(this.getAttribute("key")||"id").trim()}setData(t){this._items=Array.isArray(t)?[...t]:[],this._updateNextId(),this._publishListState()}getData(){return[...this._items]}_loadInlineData(){const t=this.querySelector('script[type="application/json"]');if(t?.textContent?.trim())try{const e=JSON.parse(t.textContent.trim());this._items=Array.isArray(e)?e:e.items||e.data||[],this._updateNextId()}catch(e){console.warn("[pan-static-connector] Failed to parse inline JSON:",e),this._items=[]}}_updateNextId(){const t=this._items.reduce((e,i)=>{const s=i[this.key];return typeof s=="number"&&s>e?s:e},0);this._nextId=t+1}_init(){this._offs.forEach(e=>e?.()),this._offs=[];const t=this.resource;this._offs.push(this.pc.subscribe(`${t}.list.get`,e=>this._onListGet(e))),this._offs.push(this.pc.subscribe(`${t}.item.get`,e=>this._onItemGet(e))),this._offs.push(this.pc.subscribe(`${t}.item.save`,e=>this._onItemSave(e))),this._offs.push(this.pc.subscribe(`${t}.item.delete`,e=>this._onItemDelete(e))),this._publishListState()}_publishListState(){this.pc.publish({topic:`${this.resource}.list.state`,data:{items:[...this._items]},retain:!0})}_publishItemState(t,e={}){const i=t?.[this.key]??t?.id??t;i!=null&&(e.deleted?this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{id:i,deleted:!0}}):this.pc.publish({topic:`${this.resource}.item.state.${i}`,data:{item:t},retain:!0}))}_onListGet(t){const e=[...this._items],i=t?.data?.filters||t?.data?.filter;let s=e;i&&typeof i=="object"&&(s=e.filter(r=>Object.entries(i).every(([n,o])=>o===""||o==null?!0:String(r[n]||"").toLowerCase().includes(String(o).toLowerCase())))),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,items:s}}),this._publishListState()}_onItemGet(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this._items.find(s=>s[this.key]==e);i&&this._publishItemState(i),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!!i,item:i||null}})}_onItemSave(t){let e=t?.data?.item??t?.data;if(!e||typeof e!="object"){t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!1,error:"Invalid item data"}});return}const i=e[this.key],s=i!=null?this._items.findIndex(r=>r[this.key]==i):-1;s>=0?(this._items[s]={...this._items[s],...e},e=this._items[s]):(e[this.key]==null&&(e={...e,[this.key]:this._nextId++}),this._items.push(e),this._updateNextId()),this._publishItemState(e),this._publishListState(),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:!0,item:e}})}_onItemDelete(t){const e=t?.data?.[this.key]??t?.data?.id??t?.data,i=this._items.findIndex(s=>s[this.key]==e);i>=0&&(this._items.splice(i,1),this._publishItemState(e,{deleted:!0}),this._publishListState()),t?.replyTo&&this.pc.publish({topic:t.replyTo,correlationId:t.correlationId,data:{ok:i>=0,id:e}})}}customElements.define("pan-static-connector",a);var p=a;export{a as PanStaticConnector,p as default};
