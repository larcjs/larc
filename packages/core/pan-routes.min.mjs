function u(s,e){if(!e||!s)return;const t=e.split(".");let r=s;for(const n of t){if(r==null)return;r=r[n]}return r}function h(s,e,t){if(!e||!s)return;const r=e.split(".");let n=s;for(let o=0;o<r.length-1;o++){const a=r[o];if(a==="__proto__"||a==="constructor"||a==="prototype"){console.warn(`[PAN Routes] Blocked attempt to set dangerous property: ${a}`);return}(!(a in n)||typeof n[a]!="object")&&(n[a]={}),n=n[a]}const i=r[r.length-1];if(i==="__proto__"||i==="constructor"||i==="prototype"){console.warn(`[PAN Routes] Blocked attempt to set dangerous property: ${i}`);return}n[i]=t}function f(){return`route-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function d(s){if(s===null||typeof s!="object")return s;if(s instanceof Date)return new Date(s);if(s instanceof Array)return s.map(t=>d(t));const e={};for(const t in s)s.hasOwnProperty(t)&&(e[t]=d(s[t]));return e}function l(s,e){if(!e)return!0;const{op:t,path:r,value:n,children:i,child:o}=e;try{switch(t){case"eq":return u(s,r)===n;case"neq":return u(s,r)!==n;case"gt":return u(s,r)>n;case"gte":return u(s,r)>=n;case"lt":return u(s,r)<n;case"lte":return u(s,r)<=n;case"in":return Array.isArray(n)&&n.includes(u(s,r));case"regex":{const a=u(s,r);return typeof a!="string"?!1:new RegExp(n).test(a)}case"and":return Array.isArray(i)&&i.every(a=>l(s,a));case"or":return Array.isArray(i)&&i.some(a=>l(s,a));case"not":return!l(s,o);default:return console.warn(`[PAN Routes] Unknown predicate operator: ${t}`),!1}}catch(a){return console.error("[PAN Routes] Predicate evaluation error:",a),!1}}function p(s,e){if(!e)return!0;if(e.type&&!(Array.isArray(e.type)?e.type:[e.type]).includes(s.type)||e.topic&&!(Array.isArray(e.topic)?e.topic:[e.topic]).includes(s.topic))return!1;if(e.source){const t=Array.isArray(e.source)?e.source:[e.source],r=s.meta?.source||s.source;if(!t.includes(r))return!1}if(e.tagsAny&&Array.isArray(e.tagsAny)){const t=s.meta?.tags||[];if(!e.tagsAny.some(r=>t.includes(r)))return!1}if(e.tagsAll&&Array.isArray(e.tagsAll)){const t=s.meta?.tags||[];if(!e.tagsAll.every(r=>t.includes(r)))return!1}return!(e.where&&!l(s,e.where))}function y(s,e,t){if(!e)return s;try{const{op:r}=e;switch(r){case"identity":return s;case"pick":{const n={...s};if(!e.paths||!Array.isArray(e.paths))return n;const i={},o={};for(const a of e.paths){const c=u(s,a);c!==void 0&&h(a.startsWith("payload.")?i:o,a,c)}return{...n,payload:Object.keys(i).length>0?i:n.payload,meta:Object.keys(o).length>0?o:n.meta}}case"map":{if(!e.fnId||!t.has(e.fnId))return console.warn(`[PAN Routes] Transform function not found: ${e.fnId}`),s;const n=t.get(e.fnId),i=u(s,e.path),o=n(i),a=d(s);return h(a,e.path,o),a}case"custom":return!e.fnId||!t.has(e.fnId)?(console.warn(`[PAN Routes] Transform function not found: ${e.fnId}`),s):t.get(e.fnId)(s);default:return console.warn(`[PAN Routes] Unknown transform operator: ${r}`),s}}catch(r){return console.error("[PAN Routes] Transform error:",r),s}}function A(s,e){return!s||typeof s!="string"?"":s.replace(/\{\{([^}]+)\}\}/g,(t,r)=>{const n=u(e,r.trim());return n!==void 0?String(n):t})}function g(s,e,t){const{bus:r,handlers:n,logger:i}=t;try{switch(s.type){case"EMIT":{const o={...s.message};if(s.inherit&&Array.isArray(s.inherit))for(const a of s.inherit)a==="payload"&&e.payload?o.payload={...e.payload,...o.payload}:a==="meta"&&e.meta&&(o.meta={...e.meta,...o.meta});r&&typeof r.publish=="function"&&r.publish(o.topic||o.type,o.payload,{...o,retain:o.retain||!1});break}case"FORWARD":{const o={...e};s.topic&&(o.topic=s.topic),s.typeOverride&&(o.type=s.typeOverride),r&&typeof r.publish=="function"&&r.publish(o.topic||o.type,o.payload||o.data,o);break}case"LOG":{const o=s.level||"info",a=s.template||"{{type}}: {{payload}}",c=A(a,e);i&&typeof i[o]=="function"?i[o]("[PAN Routes]",c,e):console[o]?.("[PAN Routes]",c,e)||console.log("[PAN Routes]",c,e);break}case"CALL":{if(!s.handlerId||!n.has(s.handlerId)){console.warn(`[PAN Routes] Handler not found: ${s.handlerId}`);break}n.get(s.handlerId)(e);break}default:console.warn(`[PAN Routes] Unknown action type: ${s.type}`)}}catch(o){throw console.error("[PAN Routes] Action execution error:",o),o}}class w{constructor(e=null){this.bus=e,this.routes=new Map,this.transformFns=new Map,this.handlers=new Map,this.storage=null,this.logger=null,this.changeListeners=[],this.errorListeners=[],this.enabled=!0,this.controlGuard=null,this.stats={routesEvaluated:0,routesMatched:0,actionsExecuted:0,errors:0}}add(e){try{const t={id:e.id||f(),name:e.name||`Route ${this.routes.size+1}`,enabled:e.enabled!==!1,order:e.order||0,match:e.match||{},transform:e.transform||null,actions:e.actions||[],meta:{createdBy:e.meta?.createdBy||"system",createdAt:Date.now(),updatedAt:Date.now(),tags:e.meta?.tags||[]}};if(!t.actions||t.actions.length===0)throw new Error("Route must have at least one action");return this.routes.set(t.id,t),this._notifyChange(),this._persist(),t}catch(t){throw this._handleError("ADD_ROUTE_FAILED",t,{routeInput:e}),t}}update(e,t){try{const r=this.routes.get(e);if(!r)throw new Error(`Route not found: ${e}`);const n={...r,...t,id:r.id,meta:{...r.meta,...t.meta||{},updatedAt:Date.now()}};return this.routes.set(e,n),this._notifyChange(),this._persist(),n}catch(r){throw this._handleError("UPDATE_ROUTE_FAILED",r,{id:e,patch:t}),r}}remove(e){try{const t=this.routes.delete(e);return t&&(this._notifyChange(),this._persist()),t}catch(t){throw this._handleError("REMOVE_ROUTE_FAILED",t,{id:e}),t}}enable(e){this.update(e,{enabled:!0})}disable(e){this.update(e,{enabled:!1})}get(e){return this.routes.get(e)}list(e={}){let t=Array.from(this.routes.values());return e.enabled!==void 0&&(t=t.filter(r=>r.enabled===e.enabled)),t.sort((r,n)=>r.order!==n.order?r.order-n.order:(r.meta?.createdAt||0)-(n.meta?.createdAt||0)),t}clear(){this.routes.clear(),this._notifyChange(),this._persist()}registerTransformFn(e,t){if(typeof t!="function")throw new Error("Transform must be a function");this.transformFns.set(e,t)}registerHandler(e,t){if(typeof t!="function")throw new Error("Handler must be a function");this.handlers.set(e,t)}useStorage(e){this.storage=e,e&&typeof e.load=="function"&&e.load().then(t=>{Array.isArray(t)&&t.forEach(r=>this.add(r))}).catch(t=>{console.error("[PAN Routes] Failed to load routes from storage:",t)})}useLogger(e){this.logger=e}setControlGuard(e){this.controlGuard=e}onRoutesChanged(e){return this.changeListeners.push(e),()=>{const t=this.changeListeners.indexOf(e);t!==-1&&this.changeListeners.splice(t,1)}}onError(e){return this.errorListeners.push(e),()=>{const t=this.errorListeners.indexOf(e);t!==-1&&this.errorListeners.splice(t,1)}}processMessage(e){if(!this.enabled||this.routes.size===0)return;const t=[],r=this.list({enabled:!0});for(const n of r)this.stats.routesEvaluated++,p(e,n.match)&&(this.stats.routesMatched++,t.push(n));for(const n of t)try{const i=y(e,n.transform,this.transformFns),o={bus:this.bus,handlers:this.handlers,logger:this.logger};for(const a of n.actions)g(a,i,o),this.stats.actionsExecuted++}catch(i){this._handleError("ROUTE_EXECUTION_FAILED",i,{routeId:n.id,routeName:n.name,message:e})}return t}handleControlMessage(e){if(this.controlGuard&&!this.controlGuard(e)){console.warn("[PAN Routes] Control message rejected by guard:",e);return}const{type:t,payload:r}=e;try{switch(t){case"pan.routes.add":return this.add(r.route);case"pan.routes.update":return this.update(r.id,r.patch);case"pan.routes.remove":return this.remove(r.id);case"pan.routes.enable":return this.enable(r.id),{success:!0};case"pan.routes.disable":return this.disable(r.id),{success:!0};case"pan.routes.list":return this.list(r||{});case"pan.routes.clear":return this.clear(),{success:!0};default:return console.warn(`[PAN Routes] Unknown control message type: ${t}`),null}}catch(n){throw this._handleError("CONTROL_MESSAGE_FAILED",n,{type:t,payload:r}),n}}getStats(){return{...this.stats,routeCount:this.routes.size,enabledRouteCount:this.list({enabled:!0}).length,transformFnCount:this.transformFns.size,handlerCount:this.handlers.size}}resetStats(){this.stats={routesEvaluated:0,routesMatched:0,actionsExecuted:0,errors:0}}setEnabled(e){this.enabled=e}_notifyChange(){const e=this.list();this.changeListeners.forEach(t=>{try{t(e)}catch(r){console.error("[PAN Routes] Change listener error:",r)}})}_persist(){if(this.storage&&typeof this.storage.save=="function"){const e=this.list();this.storage.save(e).catch(t=>{console.error("[PAN Routes] Failed to save routes:",t)})}}_handleError(e,t,r={}){this.stats.errors++;const n={code:e,message:t.message||String(t),details:r,timestamp:Date.now()};this.errorListeners.forEach(i=>{try{i(n)}catch(o){console.error("[PAN Routes] Error listener failed:",o)}}),console.error(`[PAN Routes] ${e}:`,t,r)}}var E=w;export{w as PanRoutesManager,E as default};
