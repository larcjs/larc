<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@larcjs/core-lite Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>@larcjs/core-lite Test</h1>
  <p>Testing the 9KB lightweight messaging bus</p>

  <div id="status"></div>

  <button id="publishBtn">Publish Message</button>
  <button id="publishRetainBtn">Publish Retained</button>

  <div id="messages"></div>

  <script type="module">
    // Import core-lite
    import './src/pan.mjs';

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');

    function addStatus(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      statusEl.appendChild(div);
    }

    function addMessage(msg) {
      const div = document.createElement('div');
      div.className = 'status info';
      div.innerHTML = `<strong>${msg.topic}</strong>: ${JSON.stringify(msg.data || msg.payload)}`;
      messagesEl.appendChild(div);
    }

    // Wait for bus to be ready
    document.addEventListener('pan:sys.ready', (e) => {
      addStatus('âœ… PAN Bus ready!', 'success');
      addStatus(`Version: ${e.detail.lite ? 'Lite' : 'Enhanced'}`, 'info');

      // Subscribe to test messages
      document.addEventListener('pan:deliver', (e) => {
        const msg = e.detail;
        if (msg.topic && msg.topic.startsWith('test.')) {
          addMessage(msg);
        }
      });

      // Subscribe to test.* pattern
      document.dispatchEvent(new CustomEvent('pan:subscribe', {
        detail: {
          clientId: 'test-client',
          topics: ['test.*'],
          options: { retained: true }
        }
      }));

      addStatus('âœ… Subscribed to test.* messages', 'success');
    });

    // Publish button
    document.getElementById('publishBtn').addEventListener('click', () => {
      document.dispatchEvent(new CustomEvent('pan:publish', {
        detail: {
          topic: 'test.message',
          data: { text: 'Hello from core-lite!', timestamp: Date.now() }
        }
      }));
      addStatus('Published test.message', 'info');
    });

    // Publish retained button
    document.getElementById('publishRetainBtn').addEventListener('click', () => {
      document.dispatchEvent(new CustomEvent('pan:publish', {
        detail: {
          topic: 'test.retained',
          data: { text: 'Retained message!', timestamp: Date.now() },
          retain: true
        }
      }));
      addStatus('Published test.retained (retained)', 'info');
    });

    addStatus('ðŸš€ Initializing core-lite...', 'info');
  </script>
</body>
</html>
