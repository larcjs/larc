<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="LARC Project Contributors" />
  <meta name="description" content="A comprehensive reference manual for building modern web applications with LARC (Lightweight Async Reactive Components). This book covers philosophy, practical implementation, complete API reference, and quick-reference appendices." />
  <title>Building with LARC: A Reference Manual</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="/Users/cdr/Projects/larc-repos/docs/books/building-with-larc/book-style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Building with LARC: A Reference Manual</h1>
<p class="subtitle">A Comprehensive Guide to Modern Web Applications</p>
<p class="author">LARC Project Contributors</p>
<p class="date">December 2025</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction" id="toc-introduction"><span
class="toc-section-number">1</span> Introduction</a>
<ul>
<li><a href="#prerequisites" id="toc-prerequisites"><span
class="toc-section-number">1.1</span> Prerequisites</a></li>
<li><a href="#how-to-use-this-book" id="toc-how-to-use-this-book"><span
class="toc-section-number">1.2</span> How to Use This Book</a>
<ul>
<li><a href="#as-a-reference" id="toc-as-a-reference"><span
class="toc-section-number">1.2.1</span> As a Reference</a></li>
<li><a href="#book-structure" id="toc-book-structure"><span
class="toc-section-number">1.2.2</span> Book Structure</a></li>
</ul></li>
<li><a href="#conventions" id="toc-conventions"><span
class="toc-section-number">1.3</span> Conventions</a>
<ul>
<li><a href="#code-examples" id="toc-code-examples"><span
class="toc-section-number">1.3.1</span> Code Examples</a></li>
<li><a href="#typography" id="toc-typography"><span
class="toc-section-number">1.3.2</span> Typography</a></li>
<li><a href="#annotations" id="toc-annotations"><span
class="toc-section-number">1.3.3</span> Annotations</a></li>
<li><a href="#message-topics" id="toc-message-topics"><span
class="toc-section-number">1.3.4</span> Message Topics</a></li>
<li><a href="#component-naming" id="toc-component-naming"><span
class="toc-section-number">1.3.5</span> Component Naming</a></li>
<li><a href="#api-signatures" id="toc-api-signatures"><span
class="toc-section-number">1.3.6</span> API Signatures</a></li>
</ul></li>
<li><a href="#relationship-to-learning-larc"
id="toc-relationship-to-learning-larc"><span
class="toc-section-number">1.4</span> Relationship to <em>Learning
LARC</em></a></li>
<li><a href="#whats-next" id="toc-whats-next"><span
class="toc-section-number">1.5</span> What’s Next</a></li>
</ul></li>
<li><a href="#core-concepts-quick-reference"
id="toc-core-concepts-quick-reference"><span
class="toc-section-number">2</span> Core Concepts Quick Reference</a>
<ul>
<li><a href="#architecture-overview"
id="toc-architecture-overview"><span
class="toc-section-number">2.1</span> Architecture Overview</a></li>
<li><a href="#message-bus" id="toc-message-bus"><span
class="toc-section-number">2.2</span> Message Bus</a>
<ul>
<li><a href="#basic-usage" id="toc-basic-usage"><span
class="toc-section-number">2.2.1</span> Basic Usage</a></li>
<li><a href="#configuration" id="toc-configuration"><span
class="toc-section-number">2.2.2</span> Configuration</a></li>
</ul></li>
<li><a href="#pubsub-pattern" id="toc-pubsub-pattern"><span
class="toc-section-number">2.3</span> Pub/Sub Pattern</a>
<ul>
<li><a href="#message-flow" id="toc-message-flow"><span
class="toc-section-number">2.3.1</span> Message Flow</a></li>
<li><a href="#wildcards" id="toc-wildcards"><span
class="toc-section-number">2.3.2</span> Wildcards</a></li>
</ul></li>
<li><a href="#message-topics-1" id="toc-message-topics-1"><span
class="toc-section-number">2.4</span> Message Topics</a>
<ul>
<li><a href="#examples" id="toc-examples"><span
class="toc-section-number">2.4.1</span> Examples</a></li>
<li><a href="#best-practices" id="toc-best-practices"><span
class="toc-section-number">2.4.2</span> Best Practices</a></li>
</ul></li>
<li><a href="#components" id="toc-components"><span
class="toc-section-number">2.5</span> Components</a>
<ul>
<li><a href="#basic-component" id="toc-basic-component"><span
class="toc-section-number">2.5.1</span> Basic Component</a></li>
<li><a href="#lifecycle" id="toc-lifecycle"><span
class="toc-section-number">2.5.2</span> Lifecycle</a></li>
</ul></li>
<li><a href="#panclient" id="toc-panclient"><span
class="toc-section-number">2.6</span> PanClient</a>
<ul>
<li><a href="#api-summary" id="toc-api-summary"><span
class="toc-section-number">2.6.1</span> API Summary</a></li>
<li><a href="#constructor-options" id="toc-constructor-options"><span
class="toc-section-number">2.6.2</span> Constructor Options</a></li>
</ul></li>
<li><a href="#state-management" id="toc-state-management"><span
class="toc-section-number">2.7</span> State Management</a>
<ul>
<li><a href="#options" id="toc-options"><span
class="toc-section-number">2.7.1</span> Options</a></li>
</ul></li>
<li><a href="#routing" id="toc-routing"><span
class="toc-section-number">2.8</span> Routing</a></li>
<li><a href="#forms" id="toc-forms"><span
class="toc-section-number">2.9</span> Forms</a></li>
<li><a href="#data-fetching" id="toc-data-fetching"><span
class="toc-section-number">2.10</span> Data Fetching</a></li>
<li><a href="#es-modules" id="toc-es-modules"><span
class="toc-section-number">2.11</span> ES Modules</a></li>
<li><a href="#cross-references" id="toc-cross-references"><span
class="toc-section-number">2.12</span> Cross-References</a></li>
<li><a href="#quick-start" id="toc-quick-start"><span
class="toc-section-number">2.13</span> Quick Start</a></li>
</ul></li>
<li><a href="#getting-started" id="toc-getting-started"><span
class="toc-section-number">3</span> Getting Started</a>
<ul>
<li><a href="#installation" id="toc-installation"><span
class="toc-section-number">3.1</span> Installation</a>
<ul>
<li><a href="#via-cdn-no-build-tools"
id="toc-via-cdn-no-build-tools"><span
class="toc-section-number">3.1.1</span> Via CDN (No Build
Tools)</a></li>
<li><a href="#via-npm" id="toc-via-npm"><span
class="toc-section-number">3.1.2</span> Via npm</a></li>
<li><a href="#project-structure" id="toc-project-structure"><span
class="toc-section-number">3.1.3</span> Project Structure</a></li>
</ul></li>
<li><a href="#development-server" id="toc-development-server"><span
class="toc-section-number">3.2</span> Development Server</a></li>
<li><a href="#minimal-application" id="toc-minimal-application"><span
class="toc-section-number">3.3</span> Minimal Application</a></li>
<li><a href="#import-maps" id="toc-import-maps"><span
class="toc-section-number">3.4</span> Import Maps</a></li>
<li><a href="#browser-requirements" id="toc-browser-requirements"><span
class="toc-section-number">3.5</span> Browser Requirements</a></li>
<li><a href="#ide-setup" id="toc-ide-setup"><span
class="toc-section-number">3.6</span> IDE Setup</a>
<ul>
<li><a href="#vs-code-recommended" id="toc-vs-code-recommended"><span
class="toc-section-number">3.6.1</span> VS Code (Recommended)</a></li>
<li><a href="#typescript-support" id="toc-typescript-support"><span
class="toc-section-number">3.6.2</span> TypeScript Support</a></li>
</ul></li>
<li><a href="#quick-verification" id="toc-quick-verification"><span
class="toc-section-number">3.7</span> Quick Verification</a></li>
<li><a href="#next-steps" id="toc-next-steps"><span
class="toc-section-number">3.8</span> Next Steps</a></li>
<li><a href="#common-issues" id="toc-common-issues"><span
class="toc-section-number">3.9</span> Common Issues</a>
<ul>
<li><a href="#import-maps-not-working"
id="toc-import-maps-not-working"><span
class="toc-section-number">3.9.1</span> Import Maps Not Working</a></li>
<li><a href="#pan-bus-not-ready" id="toc-pan-bus-not-ready"><span
class="toc-section-number">3.9.2</span> PAN Bus Not Ready</a></li>
<li><a href="#cors-errors-with-cdn" id="toc-cors-errors-with-cdn"><span
class="toc-section-number">3.9.3</span> CORS Errors with CDN</a></li>
</ul></li>
</ul></li>
<li><a href="#state-management-1" id="toc-state-management-1"><span
class="toc-section-number">4</span> State Management</a>
<ul>
<li><a href="#overview" id="toc-overview"><span
class="toc-section-number">4.1</span> Overview</a></li>
<li><a href="#quick-example" id="toc-quick-example"><span
class="toc-section-number">4.2</span> Quick Example</a></li>
<li><a href="#persistence-strategies"
id="toc-persistence-strategies"><span
class="toc-section-number">4.3</span> Persistence Strategies</a>
<ul>
<li><a href="#when-to-use-each" id="toc-when-to-use-each"><span
class="toc-section-number">4.3.1</span> When to Use Each</a></li>
</ul></li>
<li><a href="#state-synchronization-patterns"
id="toc-state-synchronization-patterns"><span
class="toc-section-number">4.4</span> State Synchronization Patterns</a>
<ul>
<li><a href="#optimistic-updates" id="toc-optimistic-updates"><span
class="toc-section-number">4.4.1</span> Optimistic Updates</a></li>
<li><a href="#debounced-sync" id="toc-debounced-sync"><span
class="toc-section-number">4.4.2</span> Debounced Sync</a></li>
<li><a href="#polling" id="toc-polling"><span
class="toc-section-number">4.4.3</span> Polling</a></li>
</ul></li>
<li><a href="#conflict-resolution-strategies"
id="toc-conflict-resolution-strategies"><span
class="toc-section-number">4.5</span> Conflict Resolution Strategies</a>
<ul>
<li><a href="#example-timestamp-based-resolution"
id="toc-example-timestamp-based-resolution"><span
class="toc-section-number">4.5.1</span> Example: Timestamp-Based
Resolution</a></li>
</ul></li>
<li><a href="#derived-state-pattern"
id="toc-derived-state-pattern"><span
class="toc-section-number">4.6</span> Derived State Pattern</a></li>
<li><a href="#history-and-time-travel"
id="toc-history-and-time-travel"><span
class="toc-section-number">4.7</span> History and Time Travel</a></li>
<li><a href="#performance-best-practices"
id="toc-performance-best-practices"><span
class="toc-section-number">4.8</span> Performance Best
Practices</a></li>
<li><a href="#component-reference" id="toc-component-reference"><span
class="toc-section-number">4.9</span> Component Reference</a></li>
<li><a href="#complete-example-document-store-with-indexeddb"
id="toc-complete-example-document-store-with-indexeddb"><span
class="toc-section-number">4.10</span> Complete Example: Document Store
with IndexedDB</a></li>
<li><a href="#cross-references-1" id="toc-cross-references-1"><span
class="toc-section-number">4.11</span> Cross-References</a></li>
<li><a href="#common-issues-1" id="toc-common-issues-1"><span
class="toc-section-number">4.12</span> Common Issues</a>
<ul>
<li><a href="#issue-state-not-persisting"
id="toc-issue-state-not-persisting"><span
class="toc-section-number">4.12.1</span> Issue: State not
persisting</a></li>
<li><a href="#issue-race-conditions"
id="toc-issue-race-conditions"><span
class="toc-section-number">4.12.2</span> Issue: Race conditions</a></li>
<li><a href="#issue-memory-leaks-from-subscriptions"
id="toc-issue-memory-leaks-from-subscriptions"><span
class="toc-section-number">4.12.3</span> Issue: Memory leaks from
subscriptions</a></li>
<li><a href="#issue-localstorage-quota-exceeded"
id="toc-issue-localstorage-quota-exceeded"><span
class="toc-section-number">4.12.4</span> Issue: localStorage quota
exceeded</a></li>
<li><a href="#issue-stale-data-after-optimistic-update-failure"
id="toc-issue-stale-data-after-optimistic-update-failure"><span
class="toc-section-number">4.12.5</span> Issue: Stale data after
optimistic update failure</a></li>
</ul></li>
</ul></li>
<li><a href="#routing-and-navigation"
id="toc-routing-and-navigation"><span
class="toc-section-number">5</span> Routing and Navigation</a>
<ul>
<li><a href="#overview-1" id="toc-overview-1"><span
class="toc-section-number">5.1</span> Overview</a></li>
<li><a href="#quick-example-1" id="toc-quick-example-1"><span
class="toc-section-number">5.2</span> Quick Example</a></li>
<li><a href="#route-patterns" id="toc-route-patterns"><span
class="toc-section-number">5.3</span> Route Patterns</a>
<ul>
<li><a href="#route-matching-order" id="toc-route-matching-order"><span
class="toc-section-number">5.3.1</span> Route Matching Order</a></li>
<li><a href="#dynamic-parameters" id="toc-dynamic-parameters"><span
class="toc-section-number">5.3.2</span> Dynamic Parameters</a></li>
<li><a href="#nested-routes" id="toc-nested-routes"><span
class="toc-section-number">5.3.3</span> Nested Routes</a></li>
</ul></li>
<li><a href="#programmatic-navigation"
id="toc-programmatic-navigation"><span
class="toc-section-number">5.4</span> Programmatic Navigation</a>
<ul>
<li><a href="#navigate-function" id="toc-navigate-function"><span
class="toc-section-number">5.4.1</span> navigate() Function</a></li>
<li><a href="#when-to-use-replace" id="toc-when-to-use-replace"><span
class="toc-section-number">5.4.2</span> When to Use Replace</a></li>
</ul></li>
<li><a href="#navigation-guards" id="toc-navigation-guards"><span
class="toc-section-number">5.5</span> Navigation Guards</a>
<ul>
<li><a href="#auth-guard-pattern" id="toc-auth-guard-pattern"><span
class="toc-section-number">5.5.1</span> Auth Guard Pattern</a></li>
<li><a href="#component-guard-hooks"
id="toc-component-guard-hooks"><span
class="toc-section-number">5.5.2</span> Component Guard Hooks</a></li>
</ul></li>
<li><a href="#query-parameters-and-deep-linking"
id="toc-query-parameters-and-deep-linking"><span
class="toc-section-number">5.6</span> Query Parameters and Deep
Linking</a></li>
<li><a href="#hash-fragments" id="toc-hash-fragments"><span
class="toc-section-number">5.7</span> Hash Fragments</a></li>
<li><a href="#history-management" id="toc-history-management"><span
class="toc-section-number">5.8</span> History Management</a>
<ul>
<li><a href="#push-vs.-replace" id="toc-push-vs.-replace"><span
class="toc-section-number">5.8.1</span> Push vs. Replace</a></li>
<li><a href="#scroll-position-preservation"
id="toc-scroll-position-preservation"><span
class="toc-section-number">5.8.2</span> Scroll Position
Preservation</a></li>
<li><a href="#history-event-listener"
id="toc-history-event-listener"><span
class="toc-section-number">5.8.3</span> History Event Listener</a></li>
</ul></li>
<li><a href="#active-link-states" id="toc-active-link-states"><span
class="toc-section-number">5.9</span> Active Link States</a></li>
<li><a href="#seo-considerations" id="toc-seo-considerations"><span
class="toc-section-number">5.10</span> SEO Considerations</a>
<ul>
<li><a href="#update-meta-tags-on-route-change"
id="toc-update-meta-tags-on-route-change"><span
class="toc-section-number">5.10.1</span> Update Meta Tags on Route
Change</a></li>
<li><a href="#ssr-and-prerendering" id="toc-ssr-and-prerendering"><span
class="toc-section-number">5.10.2</span> SSR and Prerendering</a></li>
</ul></li>
<li><a href="#component-reference-1"
id="toc-component-reference-1"><span
class="toc-section-number">5.11</span> Component Reference</a></li>
<li><a href="#complete-example-e-commerce-app-routing"
id="toc-complete-example-e-commerce-app-routing"><span
class="toc-section-number">5.12</span> Complete Example: E-commerce App
Routing</a></li>
<li><a href="#cross-references-2" id="toc-cross-references-2"><span
class="toc-section-number">5.13</span> Cross-References</a></li>
<li><a href="#common-issues-2" id="toc-common-issues-2"><span
class="toc-section-number">5.14</span> Common Issues</a>
<ul>
<li><a href="#issue-routes-not-matching"
id="toc-issue-routes-not-matching"><span
class="toc-section-number">5.14.1</span> Issue: Routes not
matching</a></li>
<li><a href="#issue-back-button-breaks-app"
id="toc-issue-back-button-breaks-app"><span
class="toc-section-number">5.14.2</span> Issue: Back button breaks
app</a></li>
<li><a href="#issue-parameters-not-updating"
id="toc-issue-parameters-not-updating"><span
class="toc-section-number">5.14.3</span> Issue: Parameters not
updating</a></li>
<li><a href="#issue-seo-crawlers-not-indexing-pages"
id="toc-issue-seo-crawlers-not-indexing-pages"><span
class="toc-section-number">5.14.4</span> Issue: SEO crawlers not
indexing pages</a></li>
<li><a href="#issue-nested-routes-conflict"
id="toc-issue-nested-routes-conflict"><span
class="toc-section-number">5.14.5</span> Issue: Nested routes
conflict</a></li>
</ul></li>
</ul></li>
<li><a href="#forms-and-user-input" id="toc-forms-and-user-input"><span
class="toc-section-number">6</span> Forms and User Input</a>
<ul>
<li><a href="#overview-2" id="toc-overview-2"><span
class="toc-section-number">6.1</span> Overview</a></li>
<li><a href="#quick-example-2" id="toc-quick-example-2"><span
class="toc-section-number">6.2</span> Quick Example</a></li>
<li><a href="#validation-strategies"
id="toc-validation-strategies"><span
class="toc-section-number">6.3</span> Validation Strategies</a>
<ul>
<li><a href="#validation-example" id="toc-validation-example"><span
class="toc-section-number">6.3.1</span> Validation Example</a></li>
</ul></li>
<li><a href="#common-patterns" id="toc-common-patterns"><span
class="toc-section-number">6.4</span> Common Patterns</a>
<ul>
<li><a href="#pattern-1-two-way-data-binding"
id="toc-pattern-1-two-way-data-binding"><span
class="toc-section-number">6.4.1</span> Pattern 1: Two-Way Data
Binding</a></li>
<li><a href="#pattern-2-file-upload"
id="toc-pattern-2-file-upload"><span
class="toc-section-number">6.4.2</span> Pattern 2: File Upload</a></li>
<li><a href="#pattern-3-schema-driven-validation"
id="toc-pattern-3-schema-driven-validation"><span
class="toc-section-number">6.4.3</span> Pattern 3: Schema-Driven
Validation</a></li>
</ul></li>
<li><a href="#input-types-reference"
id="toc-input-types-reference"><span
class="toc-section-number">6.5</span> Input Types Reference</a></li>
<li><a href="#error-display-patterns"
id="toc-error-display-patterns"><span
class="toc-section-number">6.6</span> Error Display Patterns</a>
<ul>
<li><a href="#inline-errors" id="toc-inline-errors"><span
class="toc-section-number">6.6.1</span> Inline Errors</a></li>
<li><a href="#summary-errors" id="toc-summary-errors"><span
class="toc-section-number">6.6.2</span> Summary Errors</a></li>
</ul></li>
<li><a href="#component-reference-2"
id="toc-component-reference-2"><span
class="toc-section-number">6.7</span> Component Reference</a></li>
<li><a href="#complete-example-registration-form"
id="toc-complete-example-registration-form"><span
class="toc-section-number">6.8</span> Complete Example: Registration
Form</a></li>
<li><a href="#cross-references-3" id="toc-cross-references-3"><span
class="toc-section-number">6.9</span> Cross-References</a></li>
<li><a href="#common-issues-3" id="toc-common-issues-3"><span
class="toc-section-number">6.10</span> Common Issues</a>
<ul>
<li><a href="#issue-form-submits-on-enter-key"
id="toc-issue-form-submits-on-enter-key"><span
class="toc-section-number">6.10.1</span> Issue: Form submits on Enter
key</a></li>
<li><a href="#issue-formdata-missing-checkbox-values"
id="toc-issue-formdata-missing-checkbox-values"><span
class="toc-section-number">6.10.2</span> Issue: FormData missing
checkbox values</a></li>
<li><a href="#issue-file-upload-fails-with-large-files"
id="toc-issue-file-upload-fails-with-large-files"><span
class="toc-section-number">6.10.3</span> Issue: File upload fails with
large files</a></li>
<li><a href="#issue-validation-errors-not-clearing"
id="toc-issue-validation-errors-not-clearing"><span
class="toc-section-number">6.10.4</span> Issue: Validation errors not
clearing</a></li>
<li><a href="#issue-password-managers-not-filling-forms"
id="toc-issue-password-managers-not-filling-forms"><span
class="toc-section-number">6.10.5</span> Issue: Password managers not
filling forms</a></li>
</ul></li>
</ul></li>
<li><a href="#data-fetching-and-apis"
id="toc-data-fetching-and-apis"><span
class="toc-section-number">7</span> Data Fetching and APIs</a>
<ul>
<li><a href="#overview-3" id="toc-overview-3"><span
class="toc-section-number">7.1</span> Overview</a></li>
<li><a href="#quick-example-3" id="toc-quick-example-3"><span
class="toc-section-number">7.2</span> Quick Example</a></li>
<li><a href="#rest-api-patterns" id="toc-rest-api-patterns"><span
class="toc-section-number">7.3</span> REST API Patterns</a>
<ul>
<li><a href="#rest-example-with-error-handling"
id="toc-rest-example-with-error-handling"><span
class="toc-section-number">7.3.1</span> REST Example with Error
Handling</a></li>
</ul></li>
<li><a href="#graphql-integration" id="toc-graphql-integration"><span
class="toc-section-number">7.4</span> GraphQL Integration</a>
<ul>
<li><a href="#basic-query" id="toc-basic-query"><span
class="toc-section-number">7.4.1</span> Basic Query</a></li>
<li><a href="#mutation-example" id="toc-mutation-example"><span
class="toc-section-number">7.4.2</span> Mutation Example</a></li>
</ul></li>
<li><a href="#caching-strategies" id="toc-caching-strategies"><span
class="toc-section-number">7.5</span> Caching Strategies</a>
<ul>
<li><a href="#stale-while-revalidate-pattern"
id="toc-stale-while-revalidate-pattern"><span
class="toc-section-number">7.5.1</span> Stale-While-Revalidate
Pattern</a></li>
</ul></li>
<li><a href="#error-recovery-patterns"
id="toc-error-recovery-patterns"><span
class="toc-section-number">7.6</span> Error Recovery Patterns</a>
<ul>
<li><a href="#retry-with-exponential-backoff"
id="toc-retry-with-exponential-backoff"><span
class="toc-section-number">7.6.1</span> Retry with Exponential
Backoff</a></li>
<li><a href="#fallback-data" id="toc-fallback-data"><span
class="toc-section-number">7.6.2</span> Fallback Data</a></li>
</ul></li>
<li><a href="#loading-states" id="toc-loading-states"><span
class="toc-section-number">7.7</span> Loading States</a>
<ul>
<li><a href="#skeleton-screens" id="toc-skeleton-screens"><span
class="toc-section-number">7.7.1</span> Skeleton Screens</a></li>
<li><a href="#progressive-loading" id="toc-progressive-loading"><span
class="toc-section-number">7.7.2</span> Progressive Loading</a></li>
</ul></li>
<li><a href="#component-reference-3"
id="toc-component-reference-3"><span
class="toc-section-number">7.8</span> Component Reference</a></li>
<li><a href="#complete-example-product-search-with-caching"
id="toc-complete-example-product-search-with-caching"><span
class="toc-section-number">7.9</span> Complete Example: Product Search
with Caching</a></li>
<li><a href="#cross-references-4" id="toc-cross-references-4"><span
class="toc-section-number">7.10</span> Cross-References</a></li>
<li><a href="#common-issues-4" id="toc-common-issues-4"><span
class="toc-section-number">7.11</span> Common Issues</a>
<ul>
<li><a href="#issue-cors-errors-in-development"
id="toc-issue-cors-errors-in-development"><span
class="toc-section-number">7.11.1</span> Issue: CORS errors in
development</a></li>
<li><a href="#issue-stale-cache-data"
id="toc-issue-stale-cache-data"><span
class="toc-section-number">7.11.2</span> Issue: Stale cache
data</a></li>
<li><a href="#issue-request-waterfall"
id="toc-issue-request-waterfall"><span
class="toc-section-number">7.11.3</span> Issue: Request
waterfall</a></li>
<li><a href="#issue-memory-leaks-from-pending-requests"
id="toc-issue-memory-leaks-from-pending-requests"><span
class="toc-section-number">7.11.4</span> Issue: Memory leaks from
pending requests</a></li>
<li><a href="#issue-authentication-tokens-expired"
id="toc-issue-authentication-tokens-expired"><span
class="toc-section-number">7.11.5</span> Issue: Authentication tokens
expired</a></li>
</ul></li>
</ul></li>
<li><a href="#authentication-and-authorization"
id="toc-authentication-and-authorization"><span
class="toc-section-number">8</span> Authentication and Authorization</a>
<ul>
<li><a href="#overview-4" id="toc-overview-4"><span
class="toc-section-number">8.1</span> Overview</a></li>
<li><a href="#quick-example-4" id="toc-quick-example-4"><span
class="toc-section-number">8.2</span> Quick Example</a></li>
<li><a href="#authentication-service-api"
id="toc-authentication-service-api"><span
class="toc-section-number">8.3</span> Authentication Service API</a>
<ul>
<li><a href="#authstate-interface" id="toc-authstate-interface"><span
class="toc-section-number">8.3.1</span> AuthState Interface</a></li>
</ul></li>
<li><a href="#api-interceptor-pattern"
id="toc-api-interceptor-pattern"><span
class="toc-section-number">8.4</span> API Interceptor Pattern</a></li>
<li><a href="#protected-routes" id="toc-protected-routes"><span
class="toc-section-number">8.5</span> Protected Routes</a>
<ul>
<li><a href="#route-guard-component"
id="toc-route-guard-component"><span
class="toc-section-number">8.5.1</span> Route Guard Component</a></li>
<li><a href="#usage" id="toc-usage"><span
class="toc-section-number">8.5.2</span> Usage</a></li>
</ul></li>
<li><a href="#role-based-access-control"
id="toc-role-based-access-control"><span
class="toc-section-number">8.6</span> Role-Based Access Control</a>
<ul>
<li><a href="#rbac-configuration" id="toc-rbac-configuration"><span
class="toc-section-number">8.6.1</span> RBAC Configuration</a></li>
<li><a href="#authorization-service-api"
id="toc-authorization-service-api"><span
class="toc-section-number">8.6.2</span> Authorization Service
API</a></li>
<li><a href="#conditional-rendering"
id="toc-conditional-rendering"><span
class="toc-section-number">8.6.3</span> Conditional Rendering</a></li>
</ul></li>
<li><a href="#session-management" id="toc-session-management"><span
class="toc-section-number">8.7</span> Session Management</a>
<ul>
<li><a href="#session-timeout" id="toc-session-timeout"><span
class="toc-section-number">8.7.1</span> Session Timeout</a></li>
</ul></li>
<li><a href="#security-best-practices"
id="toc-security-best-practices"><span
class="toc-section-number">8.8</span> Security Best Practices</a>
<ul>
<li><a href="#input-validation" id="toc-input-validation"><span
class="toc-section-number">8.8.1</span> Input Validation</a></li>
<li><a href="#csrf-protection" id="toc-csrf-protection"><span
class="toc-section-number">8.8.2</span> CSRF Protection</a></li>
</ul></li>
<li><a href="#component-reference-4"
id="toc-component-reference-4"><span
class="toc-section-number">8.9</span> Component Reference</a></li>
<li><a href="#complete-example-login-form"
id="toc-complete-example-login-form"><span
class="toc-section-number">8.10</span> Complete Example: Login
Form</a></li>
<li><a href="#cross-references-5" id="toc-cross-references-5"><span
class="toc-section-number">8.11</span> Cross-References</a></li>
<li><a href="#common-issues-5" id="toc-common-issues-5"><span
class="toc-section-number">8.12</span> Common Issues</a>
<ul>
<li><a href="#issue-token-expires-during-request"
id="toc-issue-token-expires-during-request"><span
class="toc-section-number">8.12.1</span> Issue: Token expires during
request</a></li>
<li><a href="#issue-lost-authentication-on-page-refresh"
id="toc-issue-lost-authentication-on-page-refresh"><span
class="toc-section-number">8.12.2</span> Issue: Lost authentication on
page refresh</a></li>
<li><a href="#issue-infinite-redirect-loops"
id="toc-issue-infinite-redirect-loops"><span
class="toc-section-number">8.12.3</span> Issue: Infinite redirect
loops</a></li>
<li><a href="#issue-cors-errors-with-credentials"
id="toc-issue-cors-errors-with-credentials"><span
class="toc-section-number">8.12.4</span> Issue: CORS errors with
credentials</a></li>
<li><a href="#issue-xss-attacks-via-stored-tokens"
id="toc-issue-xss-attacks-via-stored-tokens"><span
class="toc-section-number">8.12.5</span> Issue: XSS attacks via stored
tokens</a></li>
</ul></li>
</ul></li>
<li><a href="#real-time-features" id="toc-real-time-features"><span
class="toc-section-number">9</span> Real-time Features</a>
<ul>
<li><a href="#overview-5" id="toc-overview-5"><span
class="toc-section-number">9.1</span> Overview</a></li>
<li><a href="#quick-example-5" id="toc-quick-example-5"><span
class="toc-section-number">9.2</span> Quick Example</a></li>
<li><a href="#websocket-client-api" id="toc-websocket-client-api"><span
class="toc-section-number">9.3</span> WebSocket Client API</a>
<ul>
<li><a href="#websocket-configuration"
id="toc-websocket-configuration"><span
class="toc-section-number">9.3.1</span> WebSocket Configuration</a></li>
<li><a href="#websocket-connection-pattern"
id="toc-websocket-connection-pattern"><span
class="toc-section-number">9.3.2</span> WebSocket Connection
Pattern</a></li>
</ul></li>
<li><a href="#server-sent-events-sse"
id="toc-server-sent-events-sse"><span
class="toc-section-number">9.4</span> Server-Sent Events (SSE)</a>
<ul>
<li><a href="#sse-client-api" id="toc-sse-client-api"><span
class="toc-section-number">9.4.1</span> SSE Client API</a></li>
<li><a href="#sse-usage-pattern" id="toc-sse-usage-pattern"><span
class="toc-section-number">9.4.2</span> SSE Usage Pattern</a></li>
</ul></li>
<li><a href="#broadcastchannel-cross-tab-communication"
id="toc-broadcastchannel-cross-tab-communication"><span
class="toc-section-number">9.5</span> BroadcastChannel: Cross-Tab
Communication</a>
<ul>
<li><a href="#broadcastchannel-api" id="toc-broadcastchannel-api"><span
class="toc-section-number">9.5.1</span> BroadcastChannel API</a></li>
<li><a href="#cross-tab-sync-patterns"
id="toc-cross-tab-sync-patterns"><span
class="toc-section-number">9.5.2</span> Cross-Tab Sync Patterns</a></li>
</ul></li>
<li><a href="#web-workers-background-processing"
id="toc-web-workers-background-processing"><span
class="toc-section-number">9.6</span> Web Workers: Background
Processing</a>
<ul>
<li><a href="#worker-creation" id="toc-worker-creation"><span
class="toc-section-number">9.6.1</span> Worker Creation</a></li>
<li><a href="#worker-manager" id="toc-worker-manager"><span
class="toc-section-number">9.6.2</span> Worker Manager</a></li>
</ul></li>
<li><a href="#real-time-component-patterns"
id="toc-real-time-component-patterns"><span
class="toc-section-number">9.7</span> Real-time Component Patterns</a>
<ul>
<li><a href="#notification-feed" id="toc-notification-feed"><span
class="toc-section-number">9.7.1</span> Notification Feed</a></li>
<li><a href="#live-activity-feed" id="toc-live-activity-feed"><span
class="toc-section-number">9.7.2</span> Live Activity Feed</a></li>
<li><a href="#collaborative-editor" id="toc-collaborative-editor"><span
class="toc-section-number">9.7.3</span> Collaborative Editor</a></li>
</ul></li>
<li><a href="#component-reference-5"
id="toc-component-reference-5"><span
class="toc-section-number">9.8</span> Component Reference</a></li>
<li><a href="#advanced-patterns" id="toc-advanced-patterns"><span
class="toc-section-number">9.9</span> Advanced Patterns</a>
<ul>
<li><a href="#optimistic-updates-1" id="toc-optimistic-updates-1"><span
class="toc-section-number">9.9.1</span> Optimistic Updates</a></li>
<li><a href="#presence-tracking" id="toc-presence-tracking"><span
class="toc-section-number">9.9.2</span> Presence Tracking</a></li>
<li><a href="#conflict-resolution" id="toc-conflict-resolution"><span
class="toc-section-number">9.9.3</span> Conflict Resolution</a></li>
</ul></li>
<li><a href="#performance-considerations"
id="toc-performance-considerations"><span
class="toc-section-number">9.10</span> Performance Considerations</a>
<ul>
<li><a href="#throttle-example" id="toc-throttle-example"><span
class="toc-section-number">9.10.1</span> Throttle Example</a></li>
</ul></li>
<li><a href="#cross-references-6" id="toc-cross-references-6"><span
class="toc-section-number">9.11</span> Cross-References</a></li>
<li><a href="#common-issues-6" id="toc-common-issues-6"><span
class="toc-section-number">9.12</span> Common Issues</a>
<ul>
<li><a href="#issue-connection-drops-on-mobilesleep"
id="toc-issue-connection-drops-on-mobilesleep"><span
class="toc-section-number">9.12.1</span> Issue: Connection drops on
mobile/sleep</a></li>
<li><a href="#issue-message-order-not-guaranteed"
id="toc-issue-message-order-not-guaranteed"><span
class="toc-section-number">9.12.2</span> Issue: Message order not
guaranteed</a></li>
<li><a href="#issue-memory-leaks-from-event-listeners"
id="toc-issue-memory-leaks-from-event-listeners"><span
class="toc-section-number">9.12.3</span> Issue: Memory leaks from event
listeners</a></li>
<li><a href="#issue-duplicate-messages-on-reconnect"
id="toc-issue-duplicate-messages-on-reconnect"><span
class="toc-section-number">9.12.4</span> Issue: Duplicate messages on
reconnect</a></li>
<li><a href="#issue-high-bandwidth-usage"
id="toc-issue-high-bandwidth-usage"><span
class="toc-section-number">9.12.5</span> Issue: High bandwidth
usage</a></li>
</ul></li>
</ul></li>
<li><a href="#file-management" id="toc-file-management"><span
class="toc-section-number">10</span> File Management</a>
<ul>
<li><a href="#overview-6" id="toc-overview-6"><span
class="toc-section-number">10.1</span> Overview</a></li>
<li><a href="#quick-example-6" id="toc-quick-example-6"><span
class="toc-section-number">10.2</span> Quick Example</a></li>
<li><a href="#filesystemservice-api"
id="toc-filesystemservice-api"><span
class="toc-section-number">10.3</span> FileSystemService API</a>
<ul>
<li><a href="#fileinfo-interface" id="toc-fileinfo-interface"><span
class="toc-section-number">10.3.1</span> FileInfo Interface</a></li>
</ul></li>
<li><a href="#common-operations" id="toc-common-operations"><span
class="toc-section-number">10.4</span> Common Operations</a>
<ul>
<li><a href="#create-and-write-file"
id="toc-create-and-write-file"><span
class="toc-section-number">10.4.1</span> Create and Write File</a></li>
<li><a href="#read-and-process-files"
id="toc-read-and-process-files"><span
class="toc-section-number">10.4.2</span> Read and Process Files</a></li>
<li><a href="#directory-operations" id="toc-directory-operations"><span
class="toc-section-number">10.4.3</span> Directory Operations</a></li>
</ul></li>
<li><a href="#storage-quota-management"
id="toc-storage-quota-management"><span
class="toc-section-number">10.5</span> Storage Quota Management</a>
<ul>
<li><a href="#check-quota" id="toc-check-quota"><span
class="toc-section-number">10.5.1</span> Check Quota</a></li>
<li><a href="#request-persistent-storage"
id="toc-request-persistent-storage"><span
class="toc-section-number">10.5.2</span> Request Persistent
Storage</a></li>
</ul></li>
<li><a href="#file-upload-pattern" id="toc-file-upload-pattern"><span
class="toc-section-number">10.6</span> File Upload Pattern</a>
<ul>
<li><a href="#drag-and-drop-upload" id="toc-drag-and-drop-upload"><span
class="toc-section-number">10.6.1</span> Drag-and-Drop Upload</a></li>
<li><a href="#upload-with-progress-tracking"
id="toc-upload-with-progress-tracking"><span
class="toc-section-number">10.6.2</span> Upload with Progress
Tracking</a></li>
</ul></li>
<li><a href="#file-download-pattern"
id="toc-file-download-pattern"><span
class="toc-section-number">10.7</span> File Download Pattern</a></li>
<li><a href="#file-browser-component"
id="toc-file-browser-component"><span
class="toc-section-number">10.8</span> File Browser Component</a></li>
<li><a href="#search-and-filter" id="toc-search-and-filter"><span
class="toc-section-number">10.9</span> Search and Filter</a></li>
<li><a href="#component-reference-6"
id="toc-component-reference-6"><span
class="toc-section-number">10.10</span> Component Reference</a></li>
<li><a href="#performance-tips" id="toc-performance-tips"><span
class="toc-section-number">10.11</span> Performance Tips</a>
<ul>
<li><a href="#streaming-example" id="toc-streaming-example"><span
class="toc-section-number">10.11.1</span> Streaming Example</a></li>
</ul></li>
<li><a href="#cross-references-7" id="toc-cross-references-7"><span
class="toc-section-number">10.12</span> Cross-References</a></li>
<li><a href="#common-issues-7" id="toc-common-issues-7"><span
class="toc-section-number">10.13</span> Common Issues</a>
<ul>
<li><a href="#issue-notfounderror-when-reading-files"
id="toc-issue-notfounderror-when-reading-files"><span
class="toc-section-number">10.13.1</span> Issue: “NotFoundError” when
reading files</a></li>
<li><a href="#issue-quotaexceedederror-on-write"
id="toc-issue-quotaexceedederror-on-write"><span
class="toc-section-number">10.13.2</span> Issue: “QuotaExceededError” on
write</a></li>
<li><a href="#issue-files-lost-after-browser-update"
id="toc-issue-files-lost-after-browser-update"><span
class="toc-section-number">10.13.3</span> Issue: Files lost after
browser update</a></li>
<li><a href="#issue-slow-directory-listing-with-many-files"
id="toc-issue-slow-directory-listing-with-many-files"><span
class="toc-section-number">10.13.4</span> Issue: Slow directory listing
with many files</a></li>
<li><a href="#issue-opfs-not-available-in-browser"
id="toc-issue-opfs-not-available-in-browser"><span
class="toc-section-number">10.13.5</span> Issue: OPFS not available in
browser</a></li>
</ul></li>
</ul></li>
<li><a href="#theming-and-styling" id="toc-theming-and-styling"><span
class="toc-section-number">11</span> Theming and Styling</a>
<ul>
<li><a href="#overview-7" id="toc-overview-7"><span
class="toc-section-number">11.1</span> Overview</a></li>
<li><a href="#quick-example-7" id="toc-quick-example-7"><span
class="toc-section-number">11.2</span> Quick Example</a></li>
<li><a href="#theme-system-structure"
id="toc-theme-system-structure"><span
class="toc-section-number">11.3</span> Theme System Structure</a>
<ul>
<li><a href="#two-tier-token-system"
id="toc-two-tier-token-system"><span
class="toc-section-number">11.3.1</span> Two-Tier Token System</a></li>
<li><a href="#standard-theme-variables"
id="toc-standard-theme-variables"><span
class="toc-section-number">11.3.2</span> Standard Theme
Variables</a></li>
</ul></li>
<li><a href="#dark-mode-implementation"
id="toc-dark-mode-implementation"><span
class="toc-section-number">11.4</span> Dark Mode Implementation</a>
<ul>
<li><a href="#manual-dark-mode-override"
id="toc-manual-dark-mode-override"><span
class="toc-section-number">11.4.1</span> Manual Dark Mode
Override</a></li>
<li><a href="#system-preference-detection"
id="toc-system-preference-detection"><span
class="toc-section-number">11.4.2</span> System Preference
Detection</a></li>
</ul></li>
<li><a href="#theme-provider-component"
id="toc-theme-provider-component"><span
class="toc-section-number">11.5</span> Theme Provider Component</a>
<ul>
<li><a href="#basic-usage-1" id="toc-basic-usage-1"><span
class="toc-section-number">11.5.1</span> Basic Usage</a></li>
<li><a href="#javascript-api" id="toc-javascript-api"><span
class="toc-section-number">11.5.2</span> JavaScript API</a></li>
<li><a href="#pan-bus-integration" id="toc-pan-bus-integration"><span
class="toc-section-number">11.5.3</span> PAN Bus Integration</a></li>
</ul></li>
<li><a href="#theme-toggle-component"
id="toc-theme-toggle-component"><span
class="toc-section-number">11.6</span> Theme Toggle Component</a></li>
<li><a href="#component-specific-theming"
id="toc-component-specific-theming"><span
class="toc-section-number">11.7</span> Component-Specific Theming</a>
<ul>
<li><a href="#shadow-dom-scoping" id="toc-shadow-dom-scoping"><span
class="toc-section-number">11.7.1</span> Shadow DOM Scoping</a></li>
</ul></li>
<li><a href="#responsive-theming" id="toc-responsive-theming"><span
class="toc-section-number">11.8</span> Responsive Theming</a>
<ul>
<li><a href="#viewport-based-variables"
id="toc-viewport-based-variables"><span
class="toc-section-number">11.8.1</span> Viewport-Based
Variables</a></li>
</ul></li>
<li><a href="#smooth-theme-transitions"
id="toc-smooth-theme-transitions"><span
class="toc-section-number">11.9</span> Smooth Theme Transitions</a></li>
<li><a href="#multi-brand-support" id="toc-multi-brand-support"><span
class="toc-section-number">11.10</span> Multi-Brand Support</a></li>
<li><a href="#accessibility" id="toc-accessibility"><span
class="toc-section-number">11.11</span> Accessibility</a>
<ul>
<li><a href="#contrast-requirements"
id="toc-contrast-requirements"><span
class="toc-section-number">11.11.1</span> Contrast Requirements</a></li>
<li><a href="#reduced-motion" id="toc-reduced-motion"><span
class="toc-section-number">11.11.2</span> Reduced Motion</a></li>
<li><a href="#high-contrast-mode" id="toc-high-contrast-mode"><span
class="toc-section-number">11.11.3</span> High Contrast Mode</a></li>
<li><a href="#screen-reader-announcements"
id="toc-screen-reader-announcements"><span
class="toc-section-number">11.11.4</span> Screen Reader
Announcements</a></li>
</ul></li>
<li><a href="#performance-tips-1" id="toc-performance-tips-1"><span
class="toc-section-number">11.12</span> Performance Tips</a>
<ul>
<li><a href="#efficient-theme-switching"
id="toc-efficient-theme-switching"><span
class="toc-section-number">11.12.1</span> Efficient Theme
Switching</a></li>
</ul></li>
<li><a href="#component-reference-7"
id="toc-component-reference-7"><span
class="toc-section-number">11.13</span> Component Reference</a></li>
<li><a href="#cross-references-8" id="toc-cross-references-8"><span
class="toc-section-number">11.14</span> Cross-References</a></li>
<li><a href="#common-issues-8" id="toc-common-issues-8"><span
class="toc-section-number">11.15</span> Common Issues</a>
<ul>
<li><a href="#issue-theme-not-applying-on-load"
id="toc-issue-theme-not-applying-on-load"><span
class="toc-section-number">11.15.1</span> Issue: Theme not applying on
load</a></li>
<li><a href="#issue-custom-properties-not-inheriting"
id="toc-issue-custom-properties-not-inheriting"><span
class="toc-section-number">11.15.2</span> Issue: Custom properties not
inheriting</a></li>
<li><a href="#issue-theme-transition-lag"
id="toc-issue-theme-transition-lag"><span
class="toc-section-number">11.15.3</span> Issue: Theme transition
lag</a></li>
<li><a href="#issue-dark-mode-colors-look-washed-out"
id="toc-issue-dark-mode-colors-look-washed-out"><span
class="toc-section-number">11.15.4</span> Issue: Dark mode colors look
washed out</a></li>
<li><a href="#issue-system-preference-not-detected"
id="toc-issue-system-preference-not-detected"><span
class="toc-section-number">11.15.5</span> Issue: System preference not
detected</a></li>
</ul></li>
</ul></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization"><span
class="toc-section-number">12</span> Performance Optimization</a>
<ul>
<li><a href="#overview-8" id="toc-overview-8"><span
class="toc-section-number">12.1</span> Overview</a></li>
<li><a href="#quick-example-8" id="toc-quick-example-8"><span
class="toc-section-number">12.2</span> Quick Example</a></li>
<li><a href="#message-bus-optimization"
id="toc-message-bus-optimization"><span
class="toc-section-number">12.3</span> Message Bus Optimization</a></li>
<li><a href="#timing-utilities" id="toc-timing-utilities"><span
class="toc-section-number">12.4</span> Timing Utilities</a>
<ul>
<li><a href="#debounce" id="toc-debounce"><span
class="toc-section-number">12.4.1</span> Debounce</a></li>
<li><a href="#throttle" id="toc-throttle"><span
class="toc-section-number">12.4.2</span> Throttle</a></li>
<li><a href="#raf-throttle" id="toc-raf-throttle"><span
class="toc-section-number">12.4.3</span> RAF Throttle</a></li>
</ul></li>
<li><a href="#lazy-loading-patterns"
id="toc-lazy-loading-patterns"><span
class="toc-section-number">12.5</span> Lazy Loading Patterns</a>
<ul>
<li><a href="#component-lazy-loading"
id="toc-component-lazy-loading"><span
class="toc-section-number">12.5.1</span> Component Lazy Loading</a></li>
<li><a href="#route-based-code-splitting"
id="toc-route-based-code-splitting"><span
class="toc-section-number">12.5.2</span> Route-Based Code
Splitting</a></li>
</ul></li>
<li><a href="#virtual-scrolling" id="toc-virtual-scrolling"><span
class="toc-section-number">12.6</span> Virtual Scrolling</a></li>
<li><a href="#memory-management" id="toc-memory-management"><span
class="toc-section-number">12.7</span> Memory Management</a>
<ul>
<li><a href="#cleanup-example" id="toc-cleanup-example"><span
class="toc-section-number">12.7.1</span> Cleanup Example</a></li>
</ul></li>
<li><a href="#bundle-size-optimization"
id="toc-bundle-size-optimization"><span
class="toc-section-number">12.8</span> Bundle Size Optimization</a>
<ul>
<li><a href="#bundle-optimization-example"
id="toc-bundle-optimization-example"><span
class="toc-section-number">12.8.1</span> Bundle Optimization
Example</a></li>
<li><a href="#build-configuration" id="toc-build-configuration"><span
class="toc-section-number">12.8.2</span> Build Configuration</a></li>
</ul></li>
<li><a href="#performance-monitoring"
id="toc-performance-monitoring"><span
class="toc-section-number">12.9</span> Performance Monitoring</a></li>
<li><a href="#component-reference-8"
id="toc-component-reference-8"><span
class="toc-section-number">12.10</span> Component Reference</a></li>
<li><a href="#complete-example" id="toc-complete-example"><span
class="toc-section-number">12.11</span> Complete Example</a></li>
<li><a href="#cross-references-9" id="toc-cross-references-9"><span
class="toc-section-number">12.12</span> Cross-References</a></li>
<li><a href="#common-issues-9" id="toc-common-issues-9"><span
class="toc-section-number">12.13</span> Common Issues</a>
<ul>
<li><a href="#high-cpu-usage-from-message-bus"
id="toc-high-cpu-usage-from-message-bus"><span
class="toc-section-number">12.13.1</span> High CPU usage from message
bus</a></li>
<li><a href="#memory-leaks-in-spas" id="toc-memory-leaks-in-spas"><span
class="toc-section-number">12.13.2</span> Memory leaks in SPAs</a></li>
<li><a href="#slow-initial-load" id="toc-slow-initial-load"><span
class="toc-section-number">12.13.3</span> Slow initial load</a></li>
<li><a href="#janky-scrolling" id="toc-janky-scrolling"><span
class="toc-section-number">12.13.4</span> Janky scrolling</a></li>
<li><a href="#large-bundle-size" id="toc-large-bundle-size"><span
class="toc-section-number">12.13.5</span> Large bundle size</a></li>
</ul></li>
</ul></li>
<li><a href="#testing-strategies" id="toc-testing-strategies"><span
class="toc-section-number">13</span> Testing Strategies</a>
<ul>
<li><a href="#overview-9" id="toc-overview-9"><span
class="toc-section-number">13.1</span> Overview</a></li>
<li><a href="#quick-example-9" id="toc-quick-example-9"><span
class="toc-section-number">13.2</span> Quick Example</a></li>
<li><a href="#test-environment-setup"
id="toc-test-environment-setup"><span
class="toc-section-number">13.3</span> Test Environment Setup</a>
<ul>
<li><a href="#vitest-configuration" id="toc-vitest-configuration"><span
class="toc-section-number">13.3.1</span> Vitest Configuration</a></li>
<li><a href="#test-setup" id="toc-test-setup"><span
class="toc-section-number">13.3.2</span> Test Setup</a></li>
</ul></li>
<li><a href="#mock-pan-bus" id="toc-mock-pan-bus"><span
class="toc-section-number">13.4</span> Mock PAN Bus</a></li>
<li><a href="#unit-testing-patterns"
id="toc-unit-testing-patterns"><span
class="toc-section-number">13.5</span> Unit Testing Patterns</a>
<ul>
<li><a href="#testing-attributes" id="toc-testing-attributes"><span
class="toc-section-number">13.5.1</span> Testing Attributes</a></li>
<li><a href="#testing-message-publishing"
id="toc-testing-message-publishing"><span
class="toc-section-number">13.5.2</span> Testing Message
Publishing</a></li>
<li><a href="#testing-message-subscriptions"
id="toc-testing-message-subscriptions"><span
class="toc-section-number">13.5.3</span> Testing Message
Subscriptions</a></li>
</ul></li>
<li><a href="#integration-testing" id="toc-integration-testing"><span
class="toc-section-number">13.6</span> Integration Testing</a></li>
<li><a href="#testing-async-operations"
id="toc-testing-async-operations"><span
class="toc-section-number">13.7</span> Testing Async Operations</a>
<ul>
<li><a href="#testing-promises" id="toc-testing-promises"><span
class="toc-section-number">13.7.1</span> Testing Promises</a></li>
<li><a href="#testing-errors" id="toc-testing-errors"><span
class="toc-section-number">13.7.2</span> Testing Errors</a></li>
<li><a href="#testing-timers" id="toc-testing-timers"><span
class="toc-section-number">13.7.3</span> Testing Timers</a></li>
</ul></li>
<li><a href="#e2e-testing-with-playwright"
id="toc-e2e-testing-with-playwright"><span
class="toc-section-number">13.8</span> E2E Testing with Playwright</a>
<ul>
<li><a href="#setup" id="toc-setup"><span
class="toc-section-number">13.8.1</span> Setup</a></li>
<li><a href="#e2e-test-example" id="toc-e2e-test-example"><span
class="toc-section-number">13.8.2</span> E2E Test Example</a></li>
<li><a href="#testing-theme-switching"
id="toc-testing-theme-switching"><span
class="toc-section-number">13.8.3</span> Testing Theme
Switching</a></li>
</ul></li>
<li><a href="#test-utilities" id="toc-test-utilities"><span
class="toc-section-number">13.9</span> Test Utilities</a>
<ul>
<li><a href="#component-test-harness"
id="toc-component-test-harness"><span
class="toc-section-number">13.9.1</span> Component Test Harness</a></li>
<li><a href="#message-helper" id="toc-message-helper"><span
class="toc-section-number">13.9.2</span> Message Helper</a></li>
</ul></li>
<li><a href="#test-coverage" id="toc-test-coverage"><span
class="toc-section-number">13.10</span> Test Coverage</a></li>
<li><a href="#testing-checklist" id="toc-testing-checklist"><span
class="toc-section-number">13.11</span> Testing Checklist</a></li>
<li><a href="#complete-example-1" id="toc-complete-example-1"><span
class="toc-section-number">13.12</span> Complete Example</a></li>
<li><a href="#component-reference-9"
id="toc-component-reference-9"><span
class="toc-section-number">13.13</span> Component Reference</a></li>
<li><a href="#cross-references-10" id="toc-cross-references-10"><span
class="toc-section-number">13.14</span> Cross-References</a></li>
<li><a href="#common-issues-10" id="toc-common-issues-10"><span
class="toc-section-number">13.15</span> Common Issues</a>
<ul>
<li><a href="#tests-failing-intermittently"
id="toc-tests-failing-intermittently"><span
class="toc-section-number">13.15.1</span> Tests failing
intermittently</a></li>
<li><a href="#mock-bus-not-working" id="toc-mock-bus-not-working"><span
class="toc-section-number">13.15.2</span> Mock bus not working</a></li>
<li><a href="#e2e-tests-timing-out" id="toc-e2e-tests-timing-out"><span
class="toc-section-number">13.15.3</span> E2E tests timing out</a></li>
<li><a href="#coverage-not-including-files"
id="toc-coverage-not-including-files"><span
class="toc-section-number">13.15.4</span> Coverage not including
files</a></li>
<li><a href="#memory-leaks-in-tests"
id="toc-memory-leaks-in-tests"><span
class="toc-section-number">13.15.5</span> Memory leaks in tests</a></li>
</ul></li>
</ul></li>
<li><a href="#error-handling-and-debugging"
id="toc-error-handling-and-debugging"><span
class="toc-section-number">14</span> Error Handling and Debugging</a>
<ul>
<li><a href="#overview-10" id="toc-overview-10"><span
class="toc-section-number">14.1</span> Overview</a></li>
<li><a href="#quick-example-10" id="toc-quick-example-10"><span
class="toc-section-number">14.2</span> Quick Example</a></li>
<li><a href="#error-handling-patterns"
id="toc-error-handling-patterns"><span
class="toc-section-number">14.3</span> Error Handling Patterns</a>
<ul>
<li><a href="#component-error-boundary"
id="toc-component-error-boundary"><span
class="toc-section-number">14.3.1</span> Component Error
Boundary</a></li>
<li><a href="#global-error-monitor" id="toc-global-error-monitor"><span
class="toc-section-number">14.3.2</span> Global Error Monitor</a></li>
</ul></li>
<li><a href="#message-tracing" id="toc-message-tracing"><span
class="toc-section-number">14.4</span> Message Tracing</a>
<ul>
<li><a href="#enable-bus-debugging" id="toc-enable-bus-debugging"><span
class="toc-section-number">14.4.1</span> Enable Bus Debugging</a></li>
<li><a href="#custom-message-tracer"
id="toc-custom-message-tracer"><span
class="toc-section-number">14.4.2</span> Custom Message Tracer</a></li>
</ul></li>
<li><a href="#structured-logging" id="toc-structured-logging"><span
class="toc-section-number">14.5</span> Structured Logging</a></li>
<li><a href="#devtools-integration" id="toc-devtools-integration"><span
class="toc-section-number">14.6</span> DevTools Integration</a>
<ul>
<li><a href="#custom-console-formatters"
id="toc-custom-console-formatters"><span
class="toc-section-number">14.6.1</span> Custom Console
Formatters</a></li>
<li><a href="#performance-monitoring-1"
id="toc-performance-monitoring-1"><span
class="toc-section-number">14.6.2</span> Performance Monitoring</a></li>
</ul></li>
<li><a href="#common-pitfalls" id="toc-common-pitfalls"><span
class="toc-section-number">14.7</span> Common Pitfalls</a>
<ul>
<li><a href="#message-type-typos" id="toc-message-type-typos"><span
class="toc-section-number">14.7.1</span> Message Type Typos</a></li>
<li><a href="#infinite-message-loops"
id="toc-infinite-message-loops"><span
class="toc-section-number">14.7.2</span> Infinite Message Loops</a></li>
<li><a href="#async-race-conditions"
id="toc-async-race-conditions"><span
class="toc-section-number">14.7.3</span> Async Race Conditions</a></li>
<li><a href="#stale-closures" id="toc-stale-closures"><span
class="toc-section-number">14.7.4</span> Stale Closures</a></li>
</ul></li>
<li><a href="#debugging-checklist" id="toc-debugging-checklist"><span
class="toc-section-number">14.8</span> Debugging Checklist</a></li>
<li><a href="#component-reference-10"
id="toc-component-reference-10"><span
class="toc-section-number">14.9</span> Component Reference</a></li>
<li><a href="#complete-example-2" id="toc-complete-example-2"><span
class="toc-section-number">14.10</span> Complete Example</a></li>
<li><a href="#cross-references-11" id="toc-cross-references-11"><span
class="toc-section-number">14.11</span> Cross-References</a></li>
<li><a href="#common-issues-11" id="toc-common-issues-11"><span
class="toc-section-number">14.12</span> Common Issues</a>
<ul>
<li><a href="#errors-not-caught" id="toc-errors-not-caught"><span
class="toc-section-number">14.12.1</span> Errors not caught</a></li>
<li><a href="#missing-stack-traces" id="toc-missing-stack-traces"><span
class="toc-section-number">14.12.2</span> Missing stack traces</a></li>
<li><a href="#too-much-logging-in-production"
id="toc-too-much-logging-in-production"><span
class="toc-section-number">14.12.3</span> Too much logging in
production</a></li>
<li><a href="#cant-reproduce-bug" id="toc-cant-reproduce-bug"><span
class="toc-section-number">14.12.4</span> Can’t reproduce bug</a></li>
<li><a href="#debug-mode-left-on" id="toc-debug-mode-left-on"><span
class="toc-section-number">14.12.5</span> Debug mode left on</a></li>
</ul></li>
</ul></li>
<li><a href="#advanced-patterns-1" id="toc-advanced-patterns-1"><span
class="toc-section-number">15</span> Advanced Patterns</a>
<ul>
<li><a href="#overview-11" id="toc-overview-11"><span
class="toc-section-number">15.1</span> Overview</a></li>
<li><a href="#quick-example-11" id="toc-quick-example-11"><span
class="toc-section-number">15.2</span> Quick Example</a></li>
<li><a href="#message-bridging-patterns"
id="toc-message-bridging-patterns"><span
class="toc-section-number">15.3</span> Message Bridging
Patterns</a></li>
<li><a href="#backend-integration-patterns"
id="toc-backend-integration-patterns"><span
class="toc-section-number">15.4</span> Backend Integration
Patterns</a></li>
<li><a href="#common-patterns-1" id="toc-common-patterns-1"><span
class="toc-section-number">15.5</span> Common Patterns</a>
<ul>
<li><a href="#pattern-1-api-gateway-component"
id="toc-pattern-1-api-gateway-component"><span
class="toc-section-number">15.5.1</span> Pattern 1: API Gateway
Component</a></li>
<li><a href="#pattern-2-micro-frontend-loader"
id="toc-pattern-2-micro-frontend-loader"><span
class="toc-section-number">15.5.2</span> Pattern 2: Micro-Frontend
Loader</a></li>
<li><a href="#pattern-3-plugin-registry-with-hooks"
id="toc-pattern-3-plugin-registry-with-hooks"><span
class="toc-section-number">15.5.3</span> Pattern 3: Plugin Registry with
Hooks</a></li>
</ul></li>
<li><a href="#architecture-tables" id="toc-architecture-tables"><span
class="toc-section-number">15.6</span> Architecture Tables</a>
<ul>
<li><a href="#multi-bus-architecture"
id="toc-multi-bus-architecture"><span
class="toc-section-number">15.6.1</span> Multi-Bus Architecture</a></li>
<li><a href="#middleware-patterns" id="toc-middleware-patterns"><span
class="toc-section-number">15.6.2</span> Middleware Patterns</a></li>
</ul></li>
<li><a href="#complete-example-3" id="toc-complete-example-3"><span
class="toc-section-number">15.7</span> Complete Example</a></li>
<li><a href="#component-reference-11"
id="toc-component-reference-11"><span
class="toc-section-number">15.8</span> Component Reference</a></li>
<li><a href="#cross-references-12" id="toc-cross-references-12"><span
class="toc-section-number">15.9</span> Cross-References</a></li>
<li><a href="#common-issues-12" id="toc-common-issues-12"><span
class="toc-section-number">15.10</span> Common Issues</a>
<ul>
<li><a href="#bridge-message-loops" id="toc-bridge-message-loops"><span
class="toc-section-number">15.10.1</span> Bridge Message Loops</a></li>
<li><a href="#plugin-hook-failures" id="toc-plugin-hook-failures"><span
class="toc-section-number">15.10.2</span> Plugin Hook Failures</a></li>
<li><a href="#websocket-reconnect-storms"
id="toc-websocket-reconnect-storms"><span
class="toc-section-number">15.10.3</span> WebSocket Reconnect
Storms</a></li>
<li><a href="#micro-frontend-memory-leaks"
id="toc-micro-frontend-memory-leaks"><span
class="toc-section-number">15.10.4</span> Micro-Frontend Memory
Leaks</a></li>
<li><a href="#middleware-performance"
id="toc-middleware-performance"><span
class="toc-section-number">15.10.5</span> Middleware
Performance</a></li>
</ul></li>
</ul></li>
<li><a href="#deployment-and-production"
id="toc-deployment-and-production"><span
class="toc-section-number">16</span> Deployment and Production</a>
<ul>
<li><a href="#overview-12" id="toc-overview-12"><span
class="toc-section-number">16.1</span> Overview</a></li>
<li><a href="#quick-example-12" id="toc-quick-example-12"><span
class="toc-section-number">16.2</span> Quick Example</a></li>
<li><a href="#build-options" id="toc-build-options"><span
class="toc-section-number">16.3</span> Build Options</a>
<ul>
<li><a href="#build-configuration-example"
id="toc-build-configuration-example"><span
class="toc-section-number">16.3.1</span> Build Configuration
Example</a></li>
</ul></li>
<li><a href="#cdn-deployment" id="toc-cdn-deployment"><span
class="toc-section-number">16.4</span> CDN Deployment</a>
<ul>
<li><a href="#platform-commands" id="toc-platform-commands"><span
class="toc-section-number">16.4.1</span> Platform Commands</a></li>
<li><a href="#cache-headers" id="toc-cache-headers"><span
class="toc-section-number">16.4.2</span> Cache Headers</a></li>
</ul></li>
<li><a href="#common-patterns-2" id="toc-common-patterns-2"><span
class="toc-section-number">16.5</span> Common Patterns</a>
<ul>
<li><a href="#pattern-1-service-worker-caching"
id="toc-pattern-1-service-worker-caching"><span
class="toc-section-number">16.5.1</span> Pattern 1: Service Worker
Caching</a></li>
<li><a href="#pattern-2-performance-monitoring"
id="toc-pattern-2-performance-monitoring"><span
class="toc-section-number">16.5.2</span> Pattern 2: Performance
Monitoring</a></li>
<li><a href="#pattern-3-error-tracking"
id="toc-pattern-3-error-tracking"><span
class="toc-section-number">16.5.3</span> Pattern 3: Error
Tracking</a></li>
<li><a href="#pattern-4-feature-flags"
id="toc-pattern-4-feature-flags"><span
class="toc-section-number">16.5.4</span> Pattern 4: Feature
Flags</a></li>
</ul></li>
<li><a href="#caching-strategies-1" id="toc-caching-strategies-1"><span
class="toc-section-number">16.6</span> Caching Strategies</a>
<ul>
<li><a href="#api-response-caching" id="toc-api-response-caching"><span
class="toc-section-number">16.6.1</span> API Response Caching</a></li>
</ul></li>
<li><a href="#performance-metrics" id="toc-performance-metrics"><span
class="toc-section-number">16.7</span> Performance Metrics</a>
<ul>
<li><a href="#core-web-vitals-targets"
id="toc-core-web-vitals-targets"><span
class="toc-section-number">16.7.1</span> Core Web Vitals
Targets</a></li>
<li><a href="#custom-performance-marks"
id="toc-custom-performance-marks"><span
class="toc-section-number">16.7.2</span> Custom Performance
Marks</a></li>
</ul></li>
<li><a href="#complete-example-4" id="toc-complete-example-4"><span
class="toc-section-number">16.8</span> Complete Example</a></li>
<li><a href="#deployment-checklist" id="toc-deployment-checklist"><span
class="toc-section-number">16.9</span> Deployment Checklist</a></li>
<li><a href="#component-reference-12"
id="toc-component-reference-12"><span
class="toc-section-number">16.10</span> Component Reference</a></li>
<li><a href="#cross-references-13" id="toc-cross-references-13"><span
class="toc-section-number">16.11</span> Cross-References</a></li>
<li><a href="#common-issues-13" id="toc-common-issues-13"><span
class="toc-section-number">16.12</span> Common Issues</a>
<ul>
<li><a href="#service-worker-not-updating"
id="toc-service-worker-not-updating"><span
class="toc-section-number">16.12.1</span> Service Worker Not
Updating</a></li>
<li><a href="#source-maps-exposed-to-public"
id="toc-source-maps-exposed-to-public"><span
class="toc-section-number">16.12.2</span> Source Maps Exposed to
Public</a></li>
<li><a href="#cache-invalidation-after-deploy"
id="toc-cache-invalidation-after-deploy"><span
class="toc-section-number">16.12.3</span> Cache Invalidation After
Deploy</a></li>
<li><a href="#performance-metrics-not-reporting"
id="toc-performance-metrics-not-reporting"><span
class="toc-section-number">16.12.4</span> Performance Metrics Not
Reporting</a></li>
<li><a href="#bundle-size-exceeds-limits"
id="toc-bundle-size-exceeds-limits"><span
class="toc-section-number">16.12.5</span> Bundle Size Exceeds
Limits</a></li>
<li><a href="#update-notifications-not-showing"
id="toc-update-notifications-not-showing"><span
class="toc-section-number">16.12.6</span> Update Notifications Not
Showing</a></li>
</ul></li>
</ul></li>
<li><a href="#core-components-reference"
id="toc-core-components-reference"><span
class="toc-section-number">17</span> Core Components Reference</a>
<ul>
<li><a href="#pan-bus" id="toc-pan-bus"><span
class="toc-section-number">17.1</span> pan-bus</a>
<ul>
<li><a href="#quick-example-13" id="toc-quick-example-13"><span
class="toc-section-number">17.1.1</span> Quick Example</a></li>
<li><a href="#attributes" id="toc-attributes"><span
class="toc-section-number">17.1.2</span> Attributes</a></li>
<li><a href="#methods" id="toc-methods"><span
class="toc-section-number">17.1.3</span> Methods</a></li>
<li><a href="#events" id="toc-events"><span
class="toc-section-number">17.1.4</span> Events</a></li>
<li><a href="#complete-example-5" id="toc-complete-example-5"><span
class="toc-section-number">17.1.5</span> Complete Example</a></li>
<li><a href="#common-issues-14" id="toc-common-issues-14"><span
class="toc-section-number">17.1.6</span> Common Issues</a></li>
<li><a href="#errors" id="toc-errors"><span
class="toc-section-number">17.1.7</span> Errors</a></li>
</ul></li>
<li><a href="#pan-theme-provider" id="toc-pan-theme-provider"><span
class="toc-section-number">17.2</span> pan-theme-provider</a>
<ul>
<li><a href="#quick-example-14" id="toc-quick-example-14"><span
class="toc-section-number">17.2.1</span> Quick Example</a></li>
<li><a href="#attributes-1" id="toc-attributes-1"><span
class="toc-section-number">17.2.2</span> Attributes</a></li>
<li><a href="#methods-1" id="toc-methods-1"><span
class="toc-section-number">17.2.3</span> Methods</a></li>
<li><a href="#events-1" id="toc-events-1"><span
class="toc-section-number">17.2.4</span> Events</a></li>
<li><a href="#complete-example-6" id="toc-complete-example-6"><span
class="toc-section-number">17.2.5</span> Complete Example</a></li>
<li><a href="#common-issues-15" id="toc-common-issues-15"><span
class="toc-section-number">17.2.6</span> Common Issues</a></li>
<li><a href="#errors-1" id="toc-errors-1"><span
class="toc-section-number">17.2.7</span> Errors</a></li>
</ul></li>
<li><a href="#pan-theme-toggle" id="toc-pan-theme-toggle"><span
class="toc-section-number">17.3</span> pan-theme-toggle</a>
<ul>
<li><a href="#quick-example-15" id="toc-quick-example-15"><span
class="toc-section-number">17.3.1</span> Quick Example</a></li>
<li><a href="#attributes-2" id="toc-attributes-2"><span
class="toc-section-number">17.3.2</span> Attributes</a></li>
<li><a href="#complete-example-7" id="toc-complete-example-7"><span
class="toc-section-number">17.3.3</span> Complete Example</a></li>
<li><a href="#common-issues-16" id="toc-common-issues-16"><span
class="toc-section-number">17.3.4</span> Common Issues</a></li>
<li><a href="#errors-2" id="toc-errors-2"><span
class="toc-section-number">17.3.5</span> Errors</a></li>
</ul></li>
<li><a href="#pan-routes" id="toc-pan-routes"><span
class="toc-section-number">17.4</span> pan-routes</a>
<ul>
<li><a href="#quick-example-16" id="toc-quick-example-16"><span
class="toc-section-number">17.4.1</span> Quick Example</a></li>
<li><a href="#methods-2" id="toc-methods-2"><span
class="toc-section-number">17.4.2</span> Methods</a></li>
<li><a href="#route-configuration" id="toc-route-configuration"><span
class="toc-section-number">17.4.3</span> Route Configuration</a></li>
<li><a href="#match-predicates" id="toc-match-predicates"><span
class="toc-section-number">17.4.4</span> Match Predicates</a></li>
<li><a href="#transform-operations" id="toc-transform-operations"><span
class="toc-section-number">17.4.5</span> Transform Operations</a></li>
<li><a href="#actions" id="toc-actions"><span
class="toc-section-number">17.4.6</span> Actions</a></li>
<li><a href="#complete-example-8" id="toc-complete-example-8"><span
class="toc-section-number">17.4.7</span> Complete Example</a></li>
<li><a href="#common-issues-17" id="toc-common-issues-17"><span
class="toc-section-number">17.4.8</span> Common Issues</a></li>
<li><a href="#errors-3" id="toc-errors-3"><span
class="toc-section-number">17.4.9</span> Errors</a></li>
</ul></li>
<li><a href="#summary" id="toc-summary"><span
class="toc-section-number">17.5</span> Summary</a></li>
</ul></li>
<li><a href="#data-components-reference"
id="toc-data-components-reference"><span
class="toc-section-number">18</span> Data Components Reference</a>
<ul>
<li><a href="#pan-store" id="toc-pan-store"><span
class="toc-section-number">18.1</span> pan-store</a>
<ul>
<li><a href="#quick-example-17" id="toc-quick-example-17"><span
class="toc-section-number">18.1.1</span> Quick Example</a></li>
<li><a href="#api" id="toc-api"><span
class="toc-section-number">18.1.2</span> API</a></li>
<li><a href="#events-2" id="toc-events-2"><span
class="toc-section-number">18.1.3</span> Events</a></li>
<li><a href="#bindelement-store-mapping-options"
id="toc-bindelement-store-mapping-options"><span
class="toc-section-number">18.1.4</span> bind(element, store, mapping,
options)</a></li>
<li><a href="#complete-example-9" id="toc-complete-example-9"><span
class="toc-section-number">18.1.5</span> Complete Example</a></li>
<li><a href="#errors-4" id="toc-errors-4"><span
class="toc-section-number">18.1.6</span> Errors</a></li>
<li><a href="#common-issues-18" id="toc-common-issues-18"><span
class="toc-section-number">18.1.7</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-idb" id="toc-pan-idb"><span
class="toc-section-number">18.2</span> pan-idb</a>
<ul>
<li><a href="#quick-example-18" id="toc-quick-example-18"><span
class="toc-section-number">18.2.1</span> Quick Example</a></li>
<li><a href="#attributes-3" id="toc-attributes-3"><span
class="toc-section-number">18.2.2</span> Attributes</a></li>
<li><a href="#pan-topics" id="toc-pan-topics"><span
class="toc-section-number">18.2.3</span> PAN Topics</a></li>
<li><a href="#methods-3" id="toc-methods-3"><span
class="toc-section-number">18.2.4</span> Methods</a></li>
<li><a href="#complete-example-10" id="toc-complete-example-10"><span
class="toc-section-number">18.2.5</span> Complete Example</a></li>
<li><a href="#errors-5" id="toc-errors-5"><span
class="toc-section-number">18.2.6</span> Errors</a></li>
<li><a href="#common-issues-19" id="toc-common-issues-19"><span
class="toc-section-number">18.2.7</span> Common Issues</a></li>
</ul></li>
<li><a href="#summary-1" id="toc-summary-1"><span
class="toc-section-number">18.3</span> Summary</a></li>
</ul></li>
<li><a href="#ui-components-reference"
id="toc-ui-components-reference"><span
class="toc-section-number">19</span> UI Components Reference</a>
<ul>
<li><a href="#pan-files" id="toc-pan-files"><span
class="toc-section-number">19.1</span> pan-files</a>
<ul>
<li><a href="#quick-example-19" id="toc-quick-example-19"><span
class="toc-section-number">19.1.1</span> Quick Example</a></li>
<li><a href="#attributes-4" id="toc-attributes-4"><span
class="toc-section-number">19.1.2</span> Attributes</a></li>
<li><a href="#methods-4" id="toc-methods-4"><span
class="toc-section-number">19.1.3</span> Methods</a></li>
<li><a href="#pan-events" id="toc-pan-events"><span
class="toc-section-number">19.1.4</span> PAN Events</a></li>
<li><a href="#complete-example-11" id="toc-complete-example-11"><span
class="toc-section-number">19.1.5</span> Complete Example</a></li>
<li><a href="#errors-6" id="toc-errors-6"><span
class="toc-section-number">19.1.6</span> Errors</a></li>
<li><a href="#common-issues-20" id="toc-common-issues-20"><span
class="toc-section-number">19.1.7</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-markdown-editor" id="toc-pan-markdown-editor"><span
class="toc-section-number">19.2</span> pan-markdown-editor</a>
<ul>
<li><a href="#quick-example-20" id="toc-quick-example-20"><span
class="toc-section-number">19.2.1</span> Quick Example</a></li>
<li><a href="#attributes-5" id="toc-attributes-5"><span
class="toc-section-number">19.2.2</span> Attributes</a></li>
<li><a href="#methods-5" id="toc-methods-5"><span
class="toc-section-number">19.2.3</span> Methods</a></li>
<li><a href="#toolbar-actions" id="toc-toolbar-actions"><span
class="toc-section-number">19.2.4</span> Toolbar Actions</a></li>
<li><a href="#pan-events-1" id="toc-pan-events-1"><span
class="toc-section-number">19.2.5</span> PAN Events</a></li>
<li><a href="#complete-example-12" id="toc-complete-example-12"><span
class="toc-section-number">19.2.6</span> Complete Example</a></li>
<li><a href="#errors-7" id="toc-errors-7"><span
class="toc-section-number">19.2.7</span> Errors</a></li>
<li><a href="#common-issues-21" id="toc-common-issues-21"><span
class="toc-section-number">19.2.8</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-markdown-renderer"
id="toc-pan-markdown-renderer"><span
class="toc-section-number">19.3</span> pan-markdown-renderer</a>
<ul>
<li><a href="#quick-example-21" id="toc-quick-example-21"><span
class="toc-section-number">19.3.1</span> Quick Example</a></li>
<li><a href="#pan-events-2" id="toc-pan-events-2"><span
class="toc-section-number">19.3.2</span> PAN Events</a></li>
<li><a href="#complete-example-13" id="toc-complete-example-13"><span
class="toc-section-number">19.3.3</span> Complete Example</a></li>
<li><a href="#errors-8" id="toc-errors-8"><span
class="toc-section-number">19.3.4</span> Errors</a></li>
<li><a href="#common-issues-22" id="toc-common-issues-22"><span
class="toc-section-number">19.3.5</span> Common Issues</a></li>
</ul></li>
<li><a href="#summary-2" id="toc-summary-2"><span
class="toc-section-number">19.4</span> Summary</a></li>
</ul></li>
<li><a href="#integration-components-reference"
id="toc-integration-components-reference"><span
class="toc-section-number">20</span> Integration Components
Reference</a>
<ul>
<li><a href="#pan-data-connector" id="toc-pan-data-connector"><span
class="toc-section-number">20.1</span> pan-data-connector</a>
<ul>
<li><a href="#quick-example-22" id="toc-quick-example-22"><span
class="toc-section-number">20.1.1</span> Quick Example</a></li>
<li><a href="#attributes-6" id="toc-attributes-6"><span
class="toc-section-number">20.1.2</span> Attributes</a></li>
<li><a href="#pan-topics-1" id="toc-pan-topics-1"><span
class="toc-section-number">20.1.3</span> PAN Topics</a></li>
<li><a href="#complete-example-14" id="toc-complete-example-14"><span
class="toc-section-number">20.1.4</span> Complete Example</a></li>
<li><a href="#errors-9" id="toc-errors-9"><span
class="toc-section-number">20.1.5</span> Errors</a></li>
<li><a href="#common-issues-23" id="toc-common-issues-23"><span
class="toc-section-number">20.1.6</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-graphql-connector"
id="toc-pan-graphql-connector"><span
class="toc-section-number">20.2</span> pan-graphql-connector</a>
<ul>
<li><a href="#quick-example-23" id="toc-quick-example-23"><span
class="toc-section-number">20.2.1</span> Quick Example</a></li>
<li><a href="#attributes-7" id="toc-attributes-7"><span
class="toc-section-number">20.2.2</span> Attributes</a></li>
<li><a href="#pan-topics-2" id="toc-pan-topics-2"><span
class="toc-section-number">20.2.3</span> PAN Topics</a></li>
<li><a href="#complete-example-15" id="toc-complete-example-15"><span
class="toc-section-number">20.2.4</span> Complete Example</a></li>
<li><a href="#errors-10" id="toc-errors-10"><span
class="toc-section-number">20.2.5</span> Errors</a></li>
<li><a href="#common-issues-24" id="toc-common-issues-24"><span
class="toc-section-number">20.2.6</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-websocket" id="toc-pan-websocket"><span
class="toc-section-number">20.3</span> pan-websocket</a>
<ul>
<li><a href="#quick-example-24" id="toc-quick-example-24"><span
class="toc-section-number">20.3.1</span> Quick Example</a></li>
<li><a href="#attributes-8" id="toc-attributes-8"><span
class="toc-section-number">20.3.2</span> Attributes</a></li>
<li><a href="#methods-6" id="toc-methods-6"><span
class="toc-section-number">20.3.3</span> Methods</a></li>
<li><a href="#pan-topics-3" id="toc-pan-topics-3"><span
class="toc-section-number">20.3.4</span> PAN Topics</a></li>
<li><a href="#complete-example-16" id="toc-complete-example-16"><span
class="toc-section-number">20.3.5</span> Complete Example</a></li>
<li><a href="#errors-11" id="toc-errors-11"><span
class="toc-section-number">20.3.6</span> Errors</a></li>
<li><a href="#common-issues-25" id="toc-common-issues-25"><span
class="toc-section-number">20.3.7</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-sse" id="toc-pan-sse"><span
class="toc-section-number">20.4</span> pan-sse</a>
<ul>
<li><a href="#quick-example-25" id="toc-quick-example-25"><span
class="toc-section-number">20.4.1</span> Quick Example</a></li>
<li><a href="#attributes-9" id="toc-attributes-9"><span
class="toc-section-number">20.4.2</span> Attributes</a></li>
<li><a href="#methods-7" id="toc-methods-7"><span
class="toc-section-number">20.4.3</span> Methods</a></li>
<li><a href="#pan-topics-4" id="toc-pan-topics-4"><span
class="toc-section-number">20.4.4</span> PAN Topics</a></li>
<li><a href="#complete-example-17" id="toc-complete-example-17"><span
class="toc-section-number">20.4.5</span> Complete Example</a></li>
<li><a href="#errors-12" id="toc-errors-12"><span
class="toc-section-number">20.4.6</span> Errors</a></li>
<li><a href="#common-issues-26" id="toc-common-issues-26"><span
class="toc-section-number">20.4.7</span> Common Issues</a></li>
</ul></li>
<li><a href="#summary-3" id="toc-summary-3"><span
class="toc-section-number">20.5</span> Summary</a></li>
</ul></li>
<li><a href="#utility-components-reference"
id="toc-utility-components-reference"><span
class="toc-section-number">21</span> Utility Components Reference</a>
<ul>
<li><a href="#pan-debug" id="toc-pan-debug"><span
class="toc-section-number">21.1</span> pan-debug</a>
<ul>
<li><a href="#quick-example-26" id="toc-quick-example-26"><span
class="toc-section-number">21.1.1</span> Quick Example</a></li>
<li><a href="#api-1" id="toc-api-1"><span
class="toc-section-number">21.1.2</span> API</a></li>
<li><a href="#complete-example-18" id="toc-complete-example-18"><span
class="toc-section-number">21.1.3</span> Complete Example</a></li>
<li><a href="#helper-functions" id="toc-helper-functions"><span
class="toc-section-number">21.1.4</span> Helper Functions</a></li>
<li><a href="#errors-13" id="toc-errors-13"><span
class="toc-section-number">21.1.5</span> Errors</a></li>
<li><a href="#common-issues-27" id="toc-common-issues-27"><span
class="toc-section-number">21.1.6</span> Common Issues</a></li>
</ul></li>
<li><a href="#pan-forwarder" id="toc-pan-forwarder"><span
class="toc-section-number">21.2</span> pan-forwarder</a>
<ul>
<li><a href="#quick-example-27" id="toc-quick-example-27"><span
class="toc-section-number">21.2.1</span> Quick Example</a></li>
<li><a href="#attributes-10" id="toc-attributes-10"><span
class="toc-section-number">21.2.2</span> Attributes</a></li>
<li><a href="#headers-configuration"
id="toc-headers-configuration"><span
class="toc-section-number">21.2.3</span> Headers Configuration</a></li>
<li><a href="#request-format" id="toc-request-format"><span
class="toc-section-number">21.2.4</span> Request Format</a></li>
<li><a href="#complete-example-19" id="toc-complete-example-19"><span
class="toc-section-number">21.2.5</span> Complete Example</a></li>
<li><a href="#server-side-example" id="toc-server-side-example"><span
class="toc-section-number">21.2.6</span> Server-Side Example</a></li>
<li><a href="#pan-events-3" id="toc-pan-events-3"><span
class="toc-section-number">21.2.7</span> PAN Events</a></li>
<li><a href="#errors-14" id="toc-errors-14"><span
class="toc-section-number">21.2.8</span> Errors</a></li>
<li><a href="#common-issues-28" id="toc-common-issues-28"><span
class="toc-section-number">21.2.9</span> Common Issues</a></li>
</ul></li>
<li><a href="#summary-4" id="toc-summary-4"><span
class="toc-section-number">21.3</span> Summary</a></li>
</ul></li>
<li><a href="#message-topics-reference"
id="toc-message-topics-reference"><span
class="toc-section-number">22</span> Message Topics Reference</a>
<ul>
<li><a href="#topic-format-and-structure"
id="toc-topic-format-and-structure"><span
class="toc-section-number">22.1</span> Topic Format and Structure</a>
<ul>
<li><a href="#standard-format" id="toc-standard-format"><span
class="toc-section-number">22.1.1</span> Standard Format</a></li>
<li><a href="#topic-examples" id="toc-topic-examples"><span
class="toc-section-number">22.1.2</span> Topic Examples</a></li>
<li><a href="#naming-rules" id="toc-naming-rules"><span
class="toc-section-number">22.1.3</span> Naming Rules</a></li>
</ul></li>
<li><a href="#topic-patterns-and-matching"
id="toc-topic-patterns-and-matching"><span
class="toc-section-number">22.2</span> Topic Patterns and Matching</a>
<ul>
<li><a href="#exact-match" id="toc-exact-match"><span
class="toc-section-number">22.2.1</span> Exact Match</a></li>
<li><a href="#single-segment-wildcard"
id="toc-single-segment-wildcard"><span
class="toc-section-number">22.2.2</span> Single-Segment
Wildcard</a></li>
<li><a href="#global-wildcard" id="toc-global-wildcard"><span
class="toc-section-number">22.2.3</span> Global Wildcard</a></li>
<li><a href="#pattern-matching-examples"
id="toc-pattern-matching-examples"><span
class="toc-section-number">22.2.4</span> Pattern Matching
Examples</a></li>
</ul></li>
<li><a href="#reserved-topic-namespaces"
id="toc-reserved-topic-namespaces"><span
class="toc-section-number">22.3</span> Reserved Topic Namespaces</a>
<ul>
<li><a href="#pan-namespace-system-internal"
id="toc-pan-namespace-system-internal"><span
class="toc-section-number">22.3.1</span> pan:* Namespace (System
Internal)</a></li>
<li><a href="#sys-namespace-system-reserved"
id="toc-sys-namespace-system-reserved"><span
class="toc-section-number">22.3.2</span> sys:* Namespace (System
Reserved)</a></li>
<li><a href="#application-namespaces"
id="toc-application-namespaces"><span
class="toc-section-number">22.3.3</span> Application Namespaces</a></li>
</ul></li>
<li><a href="#crud-topic-patterns" id="toc-crud-topic-patterns"><span
class="toc-section-number">22.4</span> CRUD Topic Patterns</a>
<ul>
<li><a href="#list-operations" id="toc-list-operations"><span
class="toc-section-number">22.4.1</span> List Operations</a></li>
<li><a href="#item-operations" id="toc-item-operations"><span
class="toc-section-number">22.4.2</span> Item Operations</a></li>
<li><a href="#item-events" id="toc-item-events"><span
class="toc-section-number">22.4.3</span> Item Events</a></li>
<li><a href="#per-item-state" id="toc-per-item-state"><span
class="toc-section-number">22.4.4</span> Per-Item State</a></li>
</ul></li>
<li><a href="#state-management-topics"
id="toc-state-management-topics"><span
class="toc-section-number">22.5</span> State Management Topics</a>
<ul>
<li><a href="#global-state" id="toc-global-state"><span
class="toc-section-number">22.5.1</span> Global State</a></li>
<li><a href="#scoped-state" id="toc-scoped-state"><span
class="toc-section-number">22.5.2</span> Scoped State</a></li>
</ul></li>
<li><a href="#events-vs-commands" id="toc-events-vs-commands"><span
class="toc-section-number">22.6</span> Events vs Commands</a>
<ul>
<li><a href="#events-3" id="toc-events-3"><span
class="toc-section-number">22.6.1</span> Events</a></li>
<li><a href="#commands" id="toc-commands"><span
class="toc-section-number">22.6.2</span> Commands</a></li>
</ul></li>
<li><a href="#domain-specific-patterns"
id="toc-domain-specific-patterns"><span
class="toc-section-number">22.7</span> Domain-Specific Patterns</a>
<ul>
<li><a href="#authentication" id="toc-authentication"><span
class="toc-section-number">22.7.1</span> Authentication</a></li>
<li><a href="#navigation" id="toc-navigation"><span
class="toc-section-number">22.7.2</span> Navigation</a></li>
<li><a href="#ui-components" id="toc-ui-components"><span
class="toc-section-number">22.7.3</span> UI Components</a></li>
<li><a href="#forms-1" id="toc-forms-1"><span
class="toc-section-number">22.7.4</span> Forms</a></li>
<li><a href="#data-synchronization" id="toc-data-synchronization"><span
class="toc-section-number">22.7.5</span> Data Synchronization</a></li>
</ul></li>
<li><a href="#best-practices-1" id="toc-best-practices-1"><span
class="toc-section-number">22.8</span> Best Practices</a>
<ul>
<li><a href="#topic-naming" id="toc-topic-naming"><span
class="toc-section-number">22.8.1</span> Topic Naming</a></li>
<li><a href="#topic-catalog" id="toc-topic-catalog"><span
class="toc-section-number">22.8.2</span> Topic Catalog</a></li>
<li><a href="#performance-considerations-2"
id="toc-performance-considerations-2"><span
class="toc-section-number">22.8.3</span> Performance
Considerations</a></li>
</ul></li>
<li><a href="#summary-5" id="toc-summary-5"><span
class="toc-section-number">22.9</span> Summary</a></li>
</ul></li>
<li><a href="#event-envelope-specification"
id="toc-event-envelope-specification"><span
class="toc-section-number">23</span> Event Envelope Specification</a>
<ul>
<li><a href="#overview-13" id="toc-overview-13"><span
class="toc-section-number">23.1</span> Overview</a></li>
<li><a href="#message-envelope-structure"
id="toc-message-envelope-structure"><span
class="toc-section-number">23.2</span> Message Envelope Structure</a>
<ul>
<li><a href="#complete-format" id="toc-complete-format"><span
class="toc-section-number">23.2.1</span> Complete Format</a></li>
<li><a href="#minimal-message" id="toc-minimal-message"><span
class="toc-section-number">23.2.2</span> Minimal Message</a></li>
</ul></li>
<li><a href="#field-specifications" id="toc-field-specifications"><span
class="toc-section-number">23.3</span> Field Specifications</a>
<ul>
<li><a href="#topic-required" id="toc-topic-required"><span
class="toc-section-number">23.3.1</span> topic (required)</a></li>
<li><a href="#data-required" id="toc-data-required"><span
class="toc-section-number">23.3.2</span> data (required)</a></li>
<li><a href="#id-optional-auto-generated"
id="toc-id-optional-auto-generated"><span
class="toc-section-number">23.3.3</span> id (optional,
auto-generated)</a></li>
<li><a href="#ts-optional-auto-generated"
id="toc-ts-optional-auto-generated"><span
class="toc-section-number">23.3.4</span> ts (optional,
auto-generated)</a></li>
<li><a href="#retain-optional" id="toc-retain-optional"><span
class="toc-section-number">23.3.5</span> retain (optional)</a></li>
<li><a href="#replyto-optional" id="toc-replyto-optional"><span
class="toc-section-number">23.3.6</span> replyTo (optional)</a></li>
<li><a href="#correlationid-optional"
id="toc-correlationid-optional"><span
class="toc-section-number">23.3.7</span> correlationId
(optional)</a></li>
<li><a href="#headers-optional" id="toc-headers-optional"><span
class="toc-section-number">23.3.8</span> headers (optional)</a></li>
<li><a href="#clientid-internal" id="toc-clientid-internal"><span
class="toc-section-number">23.3.9</span> clientId (internal)</a></li>
</ul></li>
<li><a href="#message-examples" id="toc-message-examples"><span
class="toc-section-number">23.4</span> Message Examples</a>
<ul>
<li><a href="#simple-event" id="toc-simple-event"><span
class="toc-section-number">23.4.1</span> Simple Event</a></li>
<li><a href="#retained-state" id="toc-retained-state"><span
class="toc-section-number">23.4.2</span> Retained State</a></li>
<li><a href="#request-message" id="toc-request-message"><span
class="toc-section-number">23.4.3</span> Request Message</a></li>
<li><a href="#reply-message" id="toc-reply-message"><span
class="toc-section-number">23.4.4</span> Reply Message</a></li>
<li><a href="#message-with-headers" id="toc-message-with-headers"><span
class="toc-section-number">23.4.5</span> Message with Headers</a></li>
<li><a href="#error-response" id="toc-error-response"><span
class="toc-section-number">23.4.6</span> Error Response</a></li>
</ul></li>
<li><a href="#response-payload-conventions"
id="toc-response-payload-conventions"><span
class="toc-section-number">23.5</span> Response Payload Conventions</a>
<ul>
<li><a href="#success-response" id="toc-success-response"><span
class="toc-section-number">23.5.1</span> Success Response</a></li>
<li><a href="#error-response-1" id="toc-error-response-1"><span
class="toc-section-number">23.5.2</span> Error Response</a></li>
<li><a href="#example-error-codes" id="toc-example-error-codes"><span
class="toc-section-number">23.5.3</span> Example Error Codes</a></li>
</ul></li>
<li><a href="#message-size-limits" id="toc-message-size-limits"><span
class="toc-section-number">23.6</span> Message Size Limits</a>
<ul>
<li><a href="#default-limits" id="toc-default-limits"><span
class="toc-section-number">23.6.1</span> Default Limits</a></li>
<li><a href="#configuration-1" id="toc-configuration-1"><span
class="toc-section-number">23.6.2</span> Configuration</a></li>
<li><a href="#size-estimation" id="toc-size-estimation"><span
class="toc-section-number">23.6.3</span> Size Estimation</a></li>
<li><a href="#handling-size-limits" id="toc-handling-size-limits"><span
class="toc-section-number">23.6.4</span> Handling Size Limits</a></li>
</ul></li>
<li><a href="#validation" id="toc-validation"><span
class="toc-section-number">23.7</span> Validation</a>
<ul>
<li><a href="#topic-validation" id="toc-topic-validation"><span
class="toc-section-number">23.7.1</span> Topic Validation</a></li>
<li><a href="#data-validation" id="toc-data-validation"><span
class="toc-section-number">23.7.2</span> Data Validation</a></li>
<li><a href="#size-validation" id="toc-size-validation"><span
class="toc-section-number">23.7.3</span> Size Validation</a></li>
</ul></li>
<li><a href="#internal-system-messages"
id="toc-internal-system-messages"><span
class="toc-section-number">23.8</span> Internal System Messages</a>
<ul>
<li><a href="#pansys.ready" id="toc-pansys.ready"><span
class="toc-section-number">23.8.1</span> pan:sys.ready</a></li>
<li><a href="#pansys.error" id="toc-pansys.error"><span
class="toc-section-number">23.8.2</span> pan:sys.error</a></li>
<li><a href="#pansys.stats" id="toc-pansys.stats"><span
class="toc-section-number">23.8.3</span> pan:sys.stats</a></li>
</ul></li>
<li><a href="#summary-6" id="toc-summary-6"><span
class="toc-section-number">23.9</span> Summary</a></li>
</ul></li>
<li><a href="#configuration-options"
id="toc-configuration-options"><span
class="toc-section-number">24</span> Configuration Options</a>
<ul>
<li><a href="#pan-bus-configuration"
id="toc-pan-bus-configuration"><span
class="toc-section-number">24.1</span> PAN Bus Configuration</a>
<ul>
<li><a href="#attribute-reference" id="toc-attribute-reference"><span
class="toc-section-number">24.1.1</span> Attribute Reference</a></li>
<li><a href="#complete-configuration-example"
id="toc-complete-configuration-example"><span
class="toc-section-number">24.1.2</span> Complete Configuration
Example</a></li>
</ul></li>
<li><a href="#panclient-configuration"
id="toc-panclient-configuration"><span
class="toc-section-number">24.2</span> PanClient Configuration</a>
<ul>
<li><a href="#constructor-options-1"
id="toc-constructor-options-1"><span
class="toc-section-number">24.2.1</span> Constructor Options</a></li>
<li><a href="#subscription-options" id="toc-subscription-options"><span
class="toc-section-number">24.2.2</span> Subscription Options</a></li>
<li><a href="#request-options" id="toc-request-options"><span
class="toc-section-number">24.2.3</span> Request Options</a></li>
</ul></li>
<li><a href="#component-configuration"
id="toc-component-configuration"><span
class="toc-section-number">24.3</span> Component Configuration</a>
<ul>
<li><a href="#standard-attributes" id="toc-standard-attributes"><span
class="toc-section-number">24.3.1</span> Standard Attributes</a></li>
<li><a href="#component-specific-configuration"
id="toc-component-specific-configuration"><span
class="toc-section-number">24.3.2</span> Component-Specific
Configuration</a></li>
</ul></li>
<li><a href="#global-configuration" id="toc-global-configuration"><span
class="toc-section-number">24.4</span> Global Configuration</a>
<ul>
<li><a href="#window-configuration" id="toc-window-configuration"><span
class="toc-section-number">24.4.1</span> Window Configuration</a></li>
<li><a href="#feature-flags" id="toc-feature-flags"><span
class="toc-section-number">24.4.2</span> Feature Flags</a></li>
</ul></li>
<li><a href="#environment-variables"
id="toc-environment-variables"><span
class="toc-section-number">24.5</span> Environment Variables</a>
<ul>
<li><a href="#node_env" id="toc-node_env"><span
class="toc-section-number">24.5.1</span> NODE_ENV</a></li>
<li><a href="#larc_debug" id="toc-larc_debug"><span
class="toc-section-number">24.5.2</span> LARC_DEBUG</a></li>
<li><a href="#larc_max_retained" id="toc-larc_max_retained"><span
class="toc-section-number">24.5.3</span> LARC_MAX_RETAINED</a></li>
<li><a href="#larc_rate_limit" id="toc-larc_rate_limit"><span
class="toc-section-number">24.5.4</span> LARC_RATE_LIMIT</a></li>
</ul></li>
<li><a href="#configuration-profiles"
id="toc-configuration-profiles"><span
class="toc-section-number">24.6</span> Configuration Profiles</a>
<ul>
<li><a href="#development-profile" id="toc-development-profile"><span
class="toc-section-number">24.6.1</span> Development Profile</a></li>
<li><a href="#production-profile" id="toc-production-profile"><span
class="toc-section-number">24.6.2</span> Production Profile</a></li>
<li><a href="#high-throughput-profile"
id="toc-high-throughput-profile"><span
class="toc-section-number">24.6.3</span> High-Throughput
Profile</a></li>
<li><a href="#memory-constrained-profile"
id="toc-memory-constrained-profile"><span
class="toc-section-number">24.6.4</span> Memory-Constrained
Profile</a></li>
<li><a href="#testing-profile" id="toc-testing-profile"><span
class="toc-section-number">24.6.5</span> Testing Profile</a></li>
</ul></li>
<li><a href="#runtime-configuration"
id="toc-runtime-configuration"><span
class="toc-section-number">24.7</span> Runtime Configuration</a>
<ul>
<li><a href="#get-current-configuration"
id="toc-get-current-configuration"><span
class="toc-section-number">24.7.1</span> Get Current
Configuration</a></li>
<li><a href="#clear-retained-messages"
id="toc-clear-retained-messages"><span
class="toc-section-number">24.7.2</span> Clear Retained
Messages</a></li>
<li><a href="#get-statistics" id="toc-get-statistics"><span
class="toc-section-number">24.7.3</span> Get Statistics</a></li>
</ul></li>
<li><a href="#configuration-best-practices"
id="toc-configuration-best-practices"><span
class="toc-section-number">24.8</span> Configuration Best Practices</a>
<ul>
<li><a href="#start-conservative" id="toc-start-conservative"><span
class="toc-section-number">24.8.1</span> Start Conservative</a></li>
<li><a href="#monitor-and-tune" id="toc-monitor-and-tune"><span
class="toc-section-number">24.8.2</span> Monitor and Tune</a></li>
<li><a href="#environment-specific-configuration"
id="toc-environment-specific-configuration"><span
class="toc-section-number">24.8.3</span> Environment-Specific
Configuration</a></li>
<li><a href="#document-your-configuration"
id="toc-document-your-configuration"><span
class="toc-section-number">24.8.4</span> Document Your
Configuration</a></li>
</ul></li>
<li><a href="#configuration-checklist"
id="toc-configuration-checklist"><span
class="toc-section-number">24.9</span> Configuration Checklist</a></li>
<li><a href="#summary-7" id="toc-summary-7"><span
class="toc-section-number">24.10</span> Summary</a></li>
</ul></li>
<li><a href="#migration-guide" id="toc-migration-guide"><span
class="toc-section-number">25</span> Migration Guide</a>
<ul>
<li><a href="#general-migration-strategy"
id="toc-general-migration-strategy"><span
class="toc-section-number">25.1</span> General Migration
Strategy</a></li>
<li><a href="#version-0.x-to-1.0-migration"
id="toc-version-0.x-to-1.0-migration"><span
class="toc-section-number">25.2</span> Version 0.x to 1.0 Migration</a>
<ul>
<li><a href="#component-registration-changes"
id="toc-component-registration-changes"><span
class="toc-section-number">25.2.1</span> Component Registration
Changes</a></li>
<li><a href="#pan-bus-api-refinement"
id="toc-pan-bus-api-refinement"><span
class="toc-section-number">25.2.2</span> PAN Bus API Refinement</a></li>
<li><a href="#attribute-handling" id="toc-attribute-handling"><span
class="toc-section-number">25.2.3</span> Attribute Handling</a></li>
</ul></li>
<li><a href="#version-1.x-to-2.0-migration"
id="toc-version-1.x-to-2.0-migration"><span
class="toc-section-number">25.3</span> Version 1.x to 2.0 Migration</a>
<ul>
<li><a href="#typescript-integration"
id="toc-typescript-integration"><span
class="toc-section-number">25.3.1</span> TypeScript Integration</a></li>
<li><a href="#shadow-dom-adoption" id="toc-shadow-dom-adoption"><span
class="toc-section-number">25.3.2</span> Shadow DOM Adoption</a></li>
<li><a href="#async-component-initialization"
id="toc-async-component-initialization"><span
class="toc-section-number">25.3.3</span> Async Component
Initialization</a></li>
</ul></li>
<li><a href="#version-2.x-to-3.0-migration"
id="toc-version-2.x-to-3.0-migration"><span
class="toc-section-number">25.4</span> Version 2.x to 3.0 Migration</a>
<ul>
<li><a href="#reactive-state-management"
id="toc-reactive-state-management"><span
class="toc-section-number">25.4.1</span> Reactive State
Management</a></li>
<li><a href="#pan-bus-namespacing" id="toc-pan-bus-namespacing"><span
class="toc-section-number">25.4.2</span> PAN Bus Namespacing</a></li>
<li><a href="#performance-optimizations"
id="toc-performance-optimizations"><span
class="toc-section-number">25.4.3</span> Performance
Optimizations</a></li>
</ul></li>
<li><a href="#deprecation-timeline" id="toc-deprecation-timeline"><span
class="toc-section-number">25.5</span> Deprecation Timeline</a>
<ul>
<li><a href="#currently-deprecated-remove-in-4.0"
id="toc-currently-deprecated-remove-in-4.0"><span
class="toc-section-number">25.5.1</span> Currently Deprecated (Remove in
4.0)</a></li>
<li><a href="#planned-deprecations-4.0"
id="toc-planned-deprecations-4.0"><span
class="toc-section-number">25.5.2</span> Planned Deprecations
(4.0+)</a></li>
</ul></li>
<li><a href="#breaking-changes-checklist"
id="toc-breaking-changes-checklist"><span
class="toc-section-number">25.6</span> Breaking Changes
Checklist</a></li>
<li><a href="#migration-tools" id="toc-migration-tools"><span
class="toc-section-number">25.7</span> Migration Tools</a>
<ul>
<li><a href="#automated-refactoring"
id="toc-automated-refactoring"><span
class="toc-section-number">25.7.1</span> Automated Refactoring</a></li>
<li><a href="#manual-review-points" id="toc-manual-review-points"><span
class="toc-section-number">25.7.2</span> Manual Review Points</a></li>
</ul></li>
<li><a href="#rollback-strategy" id="toc-rollback-strategy"><span
class="toc-section-number">25.8</span> Rollback Strategy</a></li>
<li><a href="#getting-help" id="toc-getting-help"><span
class="toc-section-number">25.9</span> Getting Help</a></li>
</ul></li>
<li><a href="#recipes-and-patterns" id="toc-recipes-and-patterns"><span
class="toc-section-number">26</span> Recipes and Patterns</a>
<ul>
<li><a href="#recipe-1-lazy-loading-components"
id="toc-recipe-1-lazy-loading-components"><span
class="toc-section-number">26.1</span> Recipe 1: Lazy-Loading
Components</a></li>
<li><a href="#recipe-2-form-validation-component"
id="toc-recipe-2-form-validation-component"><span
class="toc-section-number">26.2</span> Recipe 2: Form Validation
Component</a></li>
<li><a href="#recipe-3-infinite-scroll-list"
id="toc-recipe-3-infinite-scroll-list"><span
class="toc-section-number">26.3</span> Recipe 3: Infinite Scroll
List</a></li>
<li><a href="#recipe-4-toast-notification-system"
id="toc-recipe-4-toast-notification-system"><span
class="toc-section-number">26.4</span> Recipe 4: Toast Notification
System</a></li>
<li><a href="#recipe-5-debounced-search-input"
id="toc-recipe-5-debounced-search-input"><span
class="toc-section-number">26.5</span> Recipe 5: Debounced Search
Input</a></li>
<li><a href="#recipe-6-modal-dialog"
id="toc-recipe-6-modal-dialog"><span
class="toc-section-number">26.6</span> Recipe 6: Modal Dialog</a></li>
<li><a href="#recipe-7-state-persistence"
id="toc-recipe-7-state-persistence"><span
class="toc-section-number">26.7</span> Recipe 7: State
Persistence</a></li>
<li><a href="#recipe-8-drag-and-drop"
id="toc-recipe-8-drag-and-drop"><span
class="toc-section-number">26.8</span> Recipe 8: Drag and Drop</a></li>
<li><a href="#recipe-9-responsive-image"
id="toc-recipe-9-responsive-image"><span
class="toc-section-number">26.9</span> Recipe 9: Responsive
Image</a></li>
<li><a href="#recipe-10-event-bus-bridge"
id="toc-recipe-10-event-bus-bridge"><span
class="toc-section-number">26.10</span> Recipe 10: Event Bus
Bridge</a></li>
<li><a href="#recipe-11-file-upload-with-progress"
id="toc-recipe-11-file-upload-with-progress"><span
class="toc-section-number">26.11</span> Recipe 11: File Upload with
Progress</a></li>
<li><a href="#recipe-12-autocomplete-input"
id="toc-recipe-12-autocomplete-input"><span
class="toc-section-number">26.12</span> Recipe 12: Autocomplete
Input</a></li>
<li><a href="#recipe-13-sortable-data-table"
id="toc-recipe-13-sortable-data-table"><span
class="toc-section-number">26.13</span> Recipe 13: Sortable Data
Table</a></li>
<li><a href="#recipe-14-tabs-component"
id="toc-recipe-14-tabs-component"><span
class="toc-section-number">26.14</span> Recipe 14: Tabs
Component</a></li>
<li><a href="#recipe-15-accordion-component"
id="toc-recipe-15-accordion-component"><span
class="toc-section-number">26.15</span> Recipe 15: Accordion
Component</a></li>
<li><a href="#recipe-16-context-menu"
id="toc-recipe-16-context-menu"><span
class="toc-section-number">26.16</span> Recipe 16: Context Menu</a></li>
<li><a href="#recipe-17-copy-to-clipboard"
id="toc-recipe-17-copy-to-clipboard"><span
class="toc-section-number">26.17</span> Recipe 17: Copy to
Clipboard</a></li>
<li><a href="#recipe-18-dark-mode-toggle"
id="toc-recipe-18-dark-mode-toggle"><span
class="toc-section-number">26.18</span> Recipe 18: Dark Mode
Toggle</a></li>
<li><a href="#recipe-19-skeleton-loader"
id="toc-recipe-19-skeleton-loader"><span
class="toc-section-number">26.19</span> Recipe 19: Skeleton
Loader</a></li>
<li><a href="#recipe-20-countdown-timer"
id="toc-recipe-20-countdown-timer"><span
class="toc-section-number">26.20</span> Recipe 20: Countdown
Timer</a></li>
<li><a href="#recipe-21-progress-bar"
id="toc-recipe-21-progress-bar"><span
class="toc-section-number">26.21</span> Recipe 21: Progress Bar</a></li>
<li><a href="#common-patterns-3" id="toc-common-patterns-3"><span
class="toc-section-number">26.22</span> Common Patterns</a>
<ul>
<li><a href="#pattern-component-composition"
id="toc-pattern-component-composition"><span
class="toc-section-number">26.22.1</span> Pattern: Component
Composition</a></li>
<li><a href="#pattern-higher-order-components"
id="toc-pattern-higher-order-components"><span
class="toc-section-number">26.22.2</span> Pattern: Higher-Order
Components</a></li>
<li><a href="#pattern-singleton-services"
id="toc-pattern-singleton-services"><span
class="toc-section-number">26.22.3</span> Pattern: Singleton
Services</a></li>
</ul></li>
<li><a href="#anti-patterns-to-avoid"
id="toc-anti-patterns-to-avoid"><span
class="toc-section-number">26.23</span> Anti-Patterns to Avoid</a>
<ul>
<li><a href="#anti-pattern-tight-coupling"
id="toc-anti-pattern-tight-coupling"><span
class="toc-section-number">26.23.1</span> Anti-Pattern: Tight
Coupling</a></li>
<li><a href="#anti-pattern-massive-components"
id="toc-anti-pattern-massive-components"><span
class="toc-section-number">26.23.2</span> Anti-Pattern: Massive
Components</a></li>
<li><a href="#anti-pattern-ignoring-lifecycle"
id="toc-anti-pattern-ignoring-lifecycle"><span
class="toc-section-number">26.23.3</span> Anti-Pattern: Ignoring
Lifecycle</a></li>
<li><a href="#anti-pattern-manual-memory-leaks"
id="toc-anti-pattern-manual-memory-leaks"><span
class="toc-section-number">26.23.4</span> Anti-Pattern: Manual Memory
Leaks</a></li>
</ul></li>
</ul></li>
<li><a href="#glossary" id="toc-glossary"><span
class="toc-section-number">27</span> Glossary</a>
<ul>
<li><a href="#a" id="toc-a"><span class="toc-section-number">27.1</span>
A</a></li>
<li><a href="#b" id="toc-b"><span class="toc-section-number">27.2</span>
B</a></li>
<li><a href="#c" id="toc-c"><span class="toc-section-number">27.3</span>
C</a></li>
<li><a href="#d" id="toc-d"><span class="toc-section-number">27.4</span>
D</a></li>
<li><a href="#e" id="toc-e"><span class="toc-section-number">27.5</span>
E</a></li>
<li><a href="#f" id="toc-f"><span class="toc-section-number">27.6</span>
F</a></li>
<li><a href="#h" id="toc-h"><span class="toc-section-number">27.7</span>
H</a></li>
<li><a href="#i" id="toc-i"><span class="toc-section-number">27.8</span>
I</a></li>
<li><a href="#l" id="toc-l"><span class="toc-section-number">27.9</span>
L</a></li>
<li><a href="#m" id="toc-m"><span
class="toc-section-number">27.10</span> M</a></li>
<li><a href="#n" id="toc-n"><span
class="toc-section-number">27.11</span> N</a></li>
<li><a href="#o" id="toc-o"><span
class="toc-section-number">27.12</span> O</a></li>
<li><a href="#p" id="toc-p"><span
class="toc-section-number">27.13</span> P</a></li>
<li><a href="#r" id="toc-r"><span
class="toc-section-number">27.14</span> R</a></li>
<li><a href="#s" id="toc-s"><span
class="toc-section-number">27.15</span> S</a></li>
<li><a href="#t" id="toc-t"><span
class="toc-section-number">27.16</span> T</a></li>
<li><a href="#u" id="toc-u"><span
class="toc-section-number">27.17</span> U</a></li>
<li><a href="#v" id="toc-v"><span
class="toc-section-number">27.18</span> V</a></li>
<li><a href="#w" id="toc-w"><span
class="toc-section-number">27.19</span> W</a></li>
<li><a href="#larc-specific-terms" id="toc-larc-specific-terms"><span
class="toc-section-number">27.20</span> LARC-Specific Terms</a></li>
<li><a href="#web-standards-references"
id="toc-web-standards-references"><span
class="toc-section-number">27.21</span> Web Standards
References</a></li>
<li><a href="#acronyms-and-abbreviations"
id="toc-acronyms-and-abbreviations"><span
class="toc-section-number">27.22</span> Acronyms and
Abbreviations</a></li>
<li><a href="#related-concepts" id="toc-related-concepts"><span
class="toc-section-number">27.23</span> Related Concepts</a></li>
<li><a href="#further-reading" id="toc-further-reading"><span
class="toc-section-number">27.24</span> Further Reading</a></li>
</ul></li>
<li><a href="#resources" id="toc-resources"><span
class="toc-section-number">28</span> Resources</a>
<ul>
<li><a href="#official-documentation"
id="toc-official-documentation"><span
class="toc-section-number">28.1</span> Official Documentation</a>
<ul>
<li><a href="#primary-documentation"
id="toc-primary-documentation"><span
class="toc-section-number">28.1.1</span> Primary Documentation</a></li>
<li><a href="#companion-books" id="toc-companion-books"><span
class="toc-section-number">28.1.2</span> Companion Books</a></li>
</ul></li>
<li><a href="#community-resources" id="toc-community-resources"><span
class="toc-section-number">28.2</span> Community Resources</a>
<ul>
<li><a href="#forums-and-discussion"
id="toc-forums-and-discussion"><span
class="toc-section-number">28.2.1</span> Forums and Discussion</a></li>
<li><a href="#social-media" id="toc-social-media"><span
class="toc-section-number">28.2.2</span> Social Media</a></li>
</ul></li>
<li><a href="#code-examples-and-templates"
id="toc-code-examples-and-templates"><span
class="toc-section-number">28.3</span> Code Examples and Templates</a>
<ul>
<li><a href="#example-applications" id="toc-example-applications"><span
class="toc-section-number">28.3.1</span> Example Applications</a></li>
<li><a href="#component-showcases" id="toc-component-showcases"><span
class="toc-section-number">28.3.2</span> Component Showcases</a></li>
</ul></li>
<li><a href="#development-tools" id="toc-development-tools"><span
class="toc-section-number">28.4</span> Development Tools</a>
<ul>
<li><a href="#browser-extensions" id="toc-browser-extensions"><span
class="toc-section-number">28.4.1</span> Browser Extensions</a></li>
<li><a href="#editor-extensions" id="toc-editor-extensions"><span
class="toc-section-number">28.4.2</span> Editor Extensions</a></li>
<li><a href="#command-line-tools" id="toc-command-line-tools"><span
class="toc-section-number">28.4.3</span> Command-Line Tools</a></li>
</ul></li>
<li><a href="#learning-resources" id="toc-learning-resources"><span
class="toc-section-number">28.5</span> Learning Resources</a>
<ul>
<li><a href="#video-tutorials" id="toc-video-tutorials"><span
class="toc-section-number">28.5.1</span> Video Tutorials</a></li>
<li><a href="#blog-posts-and-articles"
id="toc-blog-posts-and-articles"><span
class="toc-section-number">28.5.2</span> Blog Posts and
Articles</a></li>
<li><a href="#podcasts" id="toc-podcasts"><span
class="toc-section-number">28.5.3</span> Podcasts</a></li>
</ul></li>
<li><a href="#related-projects-and-technologies"
id="toc-related-projects-and-technologies"><span
class="toc-section-number">28.6</span> Related Projects and
Technologies</a>
<ul>
<li><a href="#web-components-standards"
id="toc-web-components-standards"><span
class="toc-section-number">28.6.1</span> Web Components
Standards</a></li>
<li><a href="#message-bus-patterns" id="toc-message-bus-patterns"><span
class="toc-section-number">28.6.2</span> Message Bus Patterns</a></li>
<li><a href="#complementary-technologies"
id="toc-complementary-technologies"><span
class="toc-section-number">28.6.3</span> Complementary
Technologies</a></li>
</ul></li>
<li><a href="#backend-integration" id="toc-backend-integration"><span
class="toc-section-number">28.7</span> Backend Integration</a>
<ul>
<li><a href="#larc-compatible-backends"
id="toc-larc-compatible-backends"><span
class="toc-section-number">28.7.1</span> LARC-Compatible
Backends</a></li>
<li><a href="#api-design-guides" id="toc-api-design-guides"><span
class="toc-section-number">28.7.2</span> API Design Guides</a></li>
</ul></li>
<li><a href="#testing-and-quality" id="toc-testing-and-quality"><span
class="toc-section-number">28.8</span> Testing and Quality</a>
<ul>
<li><a href="#testing-resources" id="toc-testing-resources"><span
class="toc-section-number">28.8.1</span> Testing Resources</a></li>
<li><a href="#performance-resources"
id="toc-performance-resources"><span
class="toc-section-number">28.8.2</span> Performance Resources</a></li>
</ul></li>
<li><a href="#contributing-and-extending"
id="toc-contributing-and-extending"><span
class="toc-section-number">28.9</span> Contributing and Extending</a>
<ul>
<li><a href="#contribution-guides" id="toc-contribution-guides"><span
class="toc-section-number">28.9.1</span> Contribution Guides</a></li>
<li><a href="#governance-and-roadmap"
id="toc-governance-and-roadmap"><span
class="toc-section-number">28.9.2</span> Governance and Roadmap</a></li>
</ul></li>
<li><a href="#package-registries" id="toc-package-registries"><span
class="toc-section-number">28.10</span> Package Registries</a>
<ul>
<li><a href="#npm-packages" id="toc-npm-packages"><span
class="toc-section-number">28.10.1</span> NPM Packages</a></li>
<li><a href="#cdn-distributions" id="toc-cdn-distributions"><span
class="toc-section-number">28.10.2</span> CDN Distributions</a></li>
</ul></li>
<li><a href="#books-and-long-form-resources"
id="toc-books-and-long-form-resources"><span
class="toc-section-number">28.11</span> Books and Long-Form
Resources</a>
<ul>
<li><a href="#recommended-reading" id="toc-recommended-reading"><span
class="toc-section-number">28.11.1</span> Recommended Reading</a></li>
<li><a href="#academic-papers" id="toc-academic-papers"><span
class="toc-section-number">28.11.2</span> Academic Papers</a></li>
</ul></li>
<li><a href="#deployment-and-hosting"
id="toc-deployment-and-hosting"><span
class="toc-section-number">28.12</span> Deployment and Hosting</a>
<ul>
<li><a href="#hosting-platforms" id="toc-hosting-platforms"><span
class="toc-section-number">28.12.1</span> Hosting Platforms</a></li>
<li><a href="#deployment-guides" id="toc-deployment-guides"><span
class="toc-section-number">28.12.2</span> Deployment Guides</a></li>
</ul></li>
<li><a href="#events-and-training" id="toc-events-and-training"><span
class="toc-section-number">28.13</span> Events and Training</a>
<ul>
<li><a href="#conferences" id="toc-conferences"><span
class="toc-section-number">28.13.1</span> Conferences</a></li>
<li><a href="#workshops-and-training"
id="toc-workshops-and-training"><span
class="toc-section-number">28.13.2</span> Workshops and
Training</a></li>
</ul></li>
<li><a href="#community-projects" id="toc-community-projects"><span
class="toc-section-number">28.14</span> Community Projects</a>
<ul>
<li><a href="#notable-applications-built-with-larc"
id="toc-notable-applications-built-with-larc"><span
class="toc-section-number">28.14.1</span> Notable Applications Built
with LARC</a></li>
<li><a href="#open-source-projects" id="toc-open-source-projects"><span
class="toc-section-number">28.14.2</span> Open Source Projects</a></li>
</ul></li>
<li><a href="#stay-updated" id="toc-stay-updated"><span
class="toc-section-number">28.15</span> Stay Updated</a>
<ul>
<li><a href="#newsletters" id="toc-newsletters"><span
class="toc-section-number">28.15.1</span> Newsletters</a></li>
<li><a href="#release-notes" id="toc-release-notes"><span
class="toc-section-number">28.15.2</span> Release Notes</a></li>
</ul></li>
<li><a href="#getting-help-1" id="toc-getting-help-1"><span
class="toc-section-number">28.16</span> Getting Help</a>
<ul>
<li><a href="#support-options" id="toc-support-options"><span
class="toc-section-number">28.16.1</span> Support Options</a></li>
</ul></li>
</ul></li>
<li><a href="#index" id="toc-index"><span
class="toc-section-number">29</span> Index</a>
<ul>
<li><a href="#a-1" id="toc-a-1"><span
class="toc-section-number">29.1</span> A</a></li>
<li><a href="#b-1" id="toc-b-1"><span
class="toc-section-number">29.2</span> B</a></li>
<li><a href="#c-1" id="toc-c-1"><span
class="toc-section-number">29.3</span> C</a></li>
<li><a href="#d-1" id="toc-d-1"><span
class="toc-section-number">29.4</span> D</a></li>
<li><a href="#e-1" id="toc-e-1"><span
class="toc-section-number">29.5</span> E</a></li>
<li><a href="#f-1" id="toc-f-1"><span
class="toc-section-number">29.6</span> F</a></li>
<li><a href="#g" id="toc-g"><span class="toc-section-number">29.7</span>
G</a></li>
<li><a href="#h-1" id="toc-h-1"><span
class="toc-section-number">29.8</span> H</a></li>
<li><a href="#i-1" id="toc-i-1"><span
class="toc-section-number">29.9</span> I</a></li>
<li><a href="#j" id="toc-j"><span
class="toc-section-number">29.10</span> J</a></li>
<li><a href="#k" id="toc-k"><span
class="toc-section-number">29.11</span> K</a></li>
<li><a href="#l-1" id="toc-l-1"><span
class="toc-section-number">29.12</span> L</a></li>
<li><a href="#m-1" id="toc-m-1"><span
class="toc-section-number">29.13</span> M</a></li>
<li><a href="#n-1" id="toc-n-1"><span
class="toc-section-number">29.14</span> N</a></li>
<li><a href="#o-1" id="toc-o-1"><span
class="toc-section-number">29.15</span> O</a></li>
<li><a href="#p-1" id="toc-p-1"><span
class="toc-section-number">29.16</span> P</a></li>
<li><a href="#q" id="toc-q"><span
class="toc-section-number">29.17</span> Q</a></li>
<li><a href="#r-1" id="toc-r-1"><span
class="toc-section-number">29.18</span> R</a></li>
<li><a href="#s-1" id="toc-s-1"><span
class="toc-section-number">29.19</span> S</a></li>
<li><a href="#t-1" id="toc-t-1"><span
class="toc-section-number">29.20</span> T</a></li>
<li><a href="#u-1" id="toc-u-1"><span
class="toc-section-number">29.21</span> U</a></li>
<li><a href="#v-1" id="toc-v-1"><span
class="toc-section-number">29.22</span> V</a></li>
<li><a href="#w-1" id="toc-w-1"><span
class="toc-section-number">29.23</span> W</a></li>
<li><a href="#x" id="toc-x"><span
class="toc-section-number">29.24</span> X</a></li>
<li><a href="#y" id="toc-y"><span
class="toc-section-number">29.25</span> Y</a></li>
<li><a href="#z" id="toc-z"><span
class="toc-section-number">29.26</span> Z</a></li>
<li><a href="#appendices" id="toc-appendices"><span
class="toc-section-number">29.27</span> Appendices</a></li>
<li><a href="#components-quick-reference"
id="toc-components-quick-reference"><span
class="toc-section-number">29.28</span> Components Quick
Reference</a></li>
</ul></li>
<li><a href="#colophon" id="toc-colophon"><span
class="toc-section-number">30</span> Colophon</a>
<ul>
<li><a href="#about-the-cover-animal"
id="toc-about-the-cover-animal"><span
class="toc-section-number">30.1</span> About the Cover Animal</a></li>
<li><a href="#about-the-cover-illustration"
id="toc-about-the-cover-illustration"><span
class="toc-section-number">30.2</span> About the Cover
Illustration</a></li>
<li><a href="#fonts" id="toc-fonts"><span
class="toc-section-number">30.3</span> Fonts</a></li>
<li><a href="#production-notes" id="toc-production-notes"><span
class="toc-section-number">30.4</span> Production Notes</a></li>
<li><a href="#acknowledgments" id="toc-acknowledgments"><span
class="toc-section-number">30.5</span> Acknowledgments</a></li>
</ul></li>
<li><a href="#learning-larc" id="toc-learning-larc"><span
class="toc-section-number">31</span> Learning LARC</a>
<ul>
<li><a href="#the-web-has-grown-up.-its-time-our-apps-did-too."
id="toc-the-web-has-grown-up.-its-time-our-apps-did-too."><span
class="toc-section-number">31.1</span> The Web Has Grown Up. It’s Time
Our Apps Did Too.</a></li>
<li><a href="#about-the-author" id="toc-about-the-author"><span
class="toc-section-number">31.2</span> About the Author</a></li>
</ul></li>
</ul>
</nav>
<h1 data-number="1" id="introduction"><span
class="header-section-number">1</span> Introduction</h1>
<p><em>Building with LARC</em> is a comprehensive reference manual for
the Lightweight Asynchronous Relay Core (LARC) framework. This book
documents LARC’s architecture, components, APIs, and patterns for
experienced developers who need detailed technical reference
material.</p>
<h2 data-number="1.1" id="prerequisites"><span
class="header-section-number">1.1</span> Prerequisites</h2>
<p><strong>This is a reference manual, not a tutorial.</strong> Before
using this book, you should:</p>
<ol type="1">
<li><p><strong>Read <em>Learning LARC</em> first</strong> — The
companion tutorial book teaches LARC concepts, architecture, and
development patterns through hands-on examples.</p></li>
<li><p><strong>Have web development experience</strong> — Familiarity
with JavaScript (ES6+), HTML5, CSS3, Web Components, HTTP/REST APIs, and
browser development tools.</p></li>
<li><p><strong>Understand LARC basics</strong> — Core concepts (PAN bus,
pub/sub messaging, component lifecycle) covered in <em>Learning
LARC</em> Chapters 1-5.</p></li>
</ol>
<p>If you’re new to LARC, start with <em>Learning LARC</em>. This
reference assumes you already know how to build LARC applications and
need API documentation or implementation details.</p>
<h2 data-number="1.2" id="how-to-use-this-book"><span
class="header-section-number">1.2</span> How to Use This Book</h2>
<h3 data-number="1.2.1" id="as-a-reference"><span
class="header-section-number">1.2.1</span> As a Reference</h3>
<p>Jump directly to chapters covering your current need:</p>
<ul>
<li><strong>Quick lookup</strong>: Use Part I (Chapters 1-3) for
architecture overview and configuration</li>
<li><strong>Task-specific</strong>: Part II (Chapters 4-16) covers
specific features (state, routing, forms, etc.)</li>
<li><strong>Component APIs</strong>: Part III (Chapters 17-21) provides
exhaustive component documentation</li>
<li><strong>Quick reference</strong>: Part IV (Appendices A-G) for
message topics, patterns, glossary</li>
</ul>
<h3 data-number="1.2.2" id="book-structure"><span
class="header-section-number">1.2.2</span> Book Structure</h3>
<p><strong>Part I: Quick Reference</strong> (Chapters 1-3) -
Architecture overview, message patterns, configuration options</p>
<p><strong>Part II: Feature Implementation</strong> (Chapters 4-16) -
State management, routing, forms, APIs, authentication, real-time
features, file management, theming, performance, testing, debugging,
patterns, deployment</p>
<p><strong>Part III: Component Reference</strong> (Chapters 17-21) -
Complete API documentation for core, data, UI, integration, and utility
components</p>
<p><strong>Part IV: Appendices</strong> (A-G) - Message topics, event
envelope spec, configuration, migration guide, recipes, glossary,
resources</p>
<h2 data-number="1.3" id="conventions"><span
class="header-section-number">1.3</span> Conventions</h2>
<h3 data-number="1.3.1" id="code-examples"><span
class="header-section-number">1.3.1</span> Code Examples</h3>
<p><strong>Inline code</strong>: <code>component-name</code>,
<code>attribute="value"</code>, <code>methodName()</code></p>
<p><strong>Code blocks</strong>:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// JavaScript examples</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- HTML examples --&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-card</span><span class="ot"> title</span><span class="op">=</span><span class="st">&quot;Example&quot;</span><span class="dt">&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Content<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-card</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Command line</strong>:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> npm install @larcjs/core</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 <span class="at">-m</span> http.server 8000</span></code></pre></div>
<p>The <code>$</code> is the shell prompt — don’t type it.</p>
<h3 data-number="1.3.2" id="typography"><span
class="header-section-number">1.3.2</span> Typography</h3>
<ul>
<li><strong>Bold</strong>: New terms, emphasis, UI elements</li>
<li><em>Italic</em>: File names, URLs, emphasis</li>
<li><code>Constant width</code>: Code, commands, components,
attributes</li>
</ul>
<h3 data-number="1.3.3" id="annotations"><span
class="header-section-number">1.3.3</span> Annotations</h3>
<blockquote>
<p><strong>NOTE</strong>: Additional context or clarification</p>
</blockquote>
<blockquote>
<p><strong>WARNING</strong>: Common mistakes or surprising behavior</p>
</blockquote>
<blockquote>
<p><strong>TIP</strong>: Practical advice from experience</p>
</blockquote>
<h3 data-number="1.3.4" id="message-topics"><span
class="header-section-number">1.3.4</span> Message Topics</h3>
<p>LARC uses hierarchical dot notation:</p>
<pre><code>namespace.entity.action</code></pre>
<p>Examples:</p>
<ul>
<li><code>user.auth.login</code> — User login event</li>
<li><code>cart.items.add</code> — Add cart item</li>
<li><code>user.*</code> — Wildcard: all user events</li>
</ul>
<p>See Appendix A for complete topic registry.</p>
<h3 data-number="1.3.5" id="component-naming"><span
class="header-section-number">1.3.5</span> Component Naming</h3>
<ul>
<li>All lowercase with hyphens: <code>pan-button</code>,
<code>pan-card</code></li>
<li>Core components use <code>pan-</code> prefix</li>
<li>Custom components use your own prefix or none</li>
</ul>
<h3 data-number="1.3.6" id="api-signatures"><span
class="header-section-number">1.3.6</span> API Signatures</h3>
<p>Type annotations for clarity (not actual TypeScript):</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">publish</span>(topic<span class="op">:</span> string<span class="op">,</span> payload<span class="op">:</span> any<span class="op">,</span> options<span class="op">?:</span> object)<span class="op">:</span> <span class="kw">void</span></span></code></pre></div>
<p>TypeScript users: See <code>@larcjs/core-types</code> for official
definitions.</p>
<h2 data-number="1.4" id="relationship-to-learning-larc"><span
class="header-section-number">1.4</span> Relationship to <em>Learning
LARC</em></h2>
<table>
<thead>
<tr>
<th></th>
<th>Learning LARC</th>
<th>Building with LARC</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Purpose</strong></td>
<td>Tutorial</td>
<td>Reference</td>
</tr>
<tr>
<td><strong>Audience</strong></td>
<td>Beginners</td>
<td>Experienced developers</td>
</tr>
<tr>
<td><strong>Style</strong></td>
<td>Narrative, progressive</td>
<td>Dense, lookup-focused</td>
</tr>
<tr>
<td><strong>Coverage</strong></td>
<td>Curated essentials</td>
<td>Comprehensive</td>
</tr>
<tr>
<td><strong>When to use</strong></td>
<td>Learning concepts</td>
<td>Building applications</td>
</tr>
</tbody>
</table>
<p><strong>New to LARC?</strong> Complete <em>Learning LARC</em> before
using this reference.</p>
<p><strong>Experienced?</strong> This book is your primary resource.</p>
<p><strong>Learning specific features?</strong> Check <em>Learning
LARC</em> for tutorials, then this book for complete details.</p>
<h2 data-number="1.5" id="whats-next"><span
class="header-section-number">1.5</span> What’s Next</h2>
<ul>
<li><strong>Chapter 2</strong>: Architecture overview and core concepts
reference</li>
<li><strong>Chapter 3</strong>: Getting started — quick installation and
setup</li>
<li><strong>Chapters 4-16</strong>: Task-specific implementation
guides</li>
<li><strong>Chapters 17-21</strong>: Complete component API
reference</li>
<li><strong>Appendices</strong>: Quick lookup tables and reference
material</li>
</ul>
<p>All examples available at
<code>github.com/larcjs/building-with-larc-examples</code></p>
<h1 data-number="2" id="core-concepts-quick-reference"><span
class="header-section-number">2</span> Core Concepts Quick
Reference</h1>
<p>This chapter provides quick lookup for LARC’s core concepts. For
tutorials and detailed explanations, see <em>Learning LARC</em> Chapters
2-5.</p>
<h2 data-number="2.1" id="architecture-overview"><span
class="header-section-number">2.1</span> Architecture Overview</h2>
<p>LARC applications consist of:</p>
<ol type="1">
<li><strong>PAN Bus</strong> (<code>&lt;pan-bus&gt;</code>) — Message
routing system</li>
<li><strong>Components</strong> — Web Components that publish/subscribe
to messages</li>
<li><strong>PanClient</strong> — Helper library for working with the
bus</li>
<li><strong>Message Topics</strong> — Hierarchical namespaces for
routing</li>
</ol>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">my-app</span><span class="dt">&gt;&lt;/</span><span class="kw">my-app</span><span class="dt">&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;/app.mjs&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="2.2" id="message-bus"><span
class="header-section-number">2.2</span> Message Bus</h2>
<p><strong>What</strong>: DOM-based pub/sub system for component
communication <strong>Element</strong>: <code>&lt;pan-bus&gt;</code>
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 5
<strong>Reference</strong>: Chapter 17</p>
<h3 data-number="2.2.1" id="basic-usage"><span
class="header-section-number">2.2.1</span> Basic Usage</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client<span class="op">.</span><span class="fu">ready</span>()<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;user.login&#39;</span><span class="op">,</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User logged in:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">userId</span>)<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="2.2.2" id="configuration"><span
class="header-section-number">2.2.2</span> Configuration</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>max-retained</code></td>
<td>number</td>
<td>1000</td>
<td>Maximum retained messages</td>
</tr>
<tr>
<td><code>max-message-size</code></td>
<td>number</td>
<td>1MB</td>
<td>Maximum message size in bytes</td>
</tr>
<tr>
<td><code>debug</code></td>
<td>boolean</td>
<td>false</td>
<td>Enable debug logging</td>
</tr>
<tr>
<td><code>allow-global-wildcard</code></td>
<td>boolean</td>
<td>true</td>
<td>Allow <code>*</code> wildcard subscriptions</td>
</tr>
</tbody>
</table>
<p>See Chapter 17 for complete pan-bus documentation.</p>
<h2 data-number="2.3" id="pubsub-pattern"><span
class="header-section-number">2.3</span> Pub/Sub Pattern</h2>
<p><strong>What</strong>: Decoupled component communication via topics
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 5</p>
<h3 data-number="2.3.1" id="message-flow"><span
class="header-section-number">2.3.1</span> Message Flow</h3>
<pre><code>Publisher → PAN Bus → Subscribers</code></pre>
<ol type="1">
<li>Component publishes message to topic</li>
<li>Bus routes message to all subscribers of that topic</li>
<li>Subscribers receive message and react</li>
</ol>
<h3 data-number="2.3.2" id="wildcards"><span
class="header-section-number">2.3.2</span> Wildcards</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Matches</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user.*</code></td>
<td>All user events</td>
<td><code>user.login</code>, <code>user.logout</code></td>
</tr>
<tr>
<td><code>*.error</code></td>
<td>All error events</td>
<td><code>api.error</code>, <code>db.error</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>All events</td>
<td>Everything (use sparingly)</td>
</tr>
</tbody>
</table>
<h2 data-number="2.4" id="message-topics-1"><span
class="header-section-number">2.4</span> Message Topics</h2>
<p><strong>Convention</strong>: <code>namespace.entity.action</code></p>
<h3 data-number="2.4.1" id="examples"><span
class="header-section-number">2.4.1</span> Examples</h3>
<pre><code>user.auth.login
user.profile.update
cart.items.add
cart.checkout.start
api.users.error
theme.changed</code></pre>
<h3 data-number="2.4.2" id="best-practices"><span
class="header-section-number">2.4.2</span> Best Practices</h3>
<ul>
<li>Use lowercase with dots as separators</li>
<li>Past tense for events: <code>user.logged-in</code> not
<code>user.login</code></li>
<li>Present for commands: <code>cart.checkout.start</code></li>
<li>Namespace by domain: <code>api.*</code>, <code>user.*</code>,
<code>cart.*</code></li>
</ul>
<p>See Appendix A for complete topic registry.</p>
<h2 data-number="2.5" id="components"><span
class="header-section-number">2.5</span> Components</h2>
<p><strong>What</strong>: Web Components that use PAN bus for
communication <strong>Tutorial</strong>: <em>Learning LARC</em> Chapter
4 <strong>Reference</strong>: Chapters 17-21</p>
<h3 data-number="2.5.1" id="basic-component"><span
class="header-section-number">2.5.1</span> Basic Component</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to messages</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.updated&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Publish messages</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchAction</span>()<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dispatchAction</span>() {</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;action.triggered&#39;</span><span class="op">,</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> { <span class="dt">componentId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span> }</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PanClient automatically cleans up subscriptions</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-component&#39;</span><span class="op">,</span> MyComponent)<span class="op">;</span></span></code></pre></div>
<h3 data-number="2.5.2" id="lifecycle"><span
class="header-section-number">2.5.2</span> Lifecycle</h3>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 40%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Callback</th>
<th>When Called</th>
<th>Use For</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>constructor()</code></td>
<td>Element created</td>
<td>Initialize properties</td>
</tr>
<tr>
<td><code>connectedCallback()</code></td>
<td>Added to DOM</td>
<td>Subscribe, render, fetch data</td>
</tr>
<tr>
<td><code>disconnectedCallback()</code></td>
<td>Removed from DOM</td>
<td>Cleanup (automatic with PanClient)</td>
</tr>
<tr>
<td><code>attributeChangedCallback()</code></td>
<td>Attribute changes</td>
<td>Re-render on attribute updates</td>
</tr>
</tbody>
</table>
<h2 data-number="2.6" id="panclient"><span
class="header-section-number">2.6</span> PanClient</h2>
<p><strong>What</strong>: Helper library for working with PAN bus
<strong>Import</strong>:
<code>import { PanClient } from '@larc/core'</code>
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 5
<strong>Reference</strong>: Chapter 17</p>
<h3 data-number="2.6.1" id="api-summary"><span
class="header-section-number">2.6.1</span> API Summary</h3>
<div class="sourceCode" id="cb11"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(element)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Wait for bus ready</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client<span class="op">.</span><span class="fu">ready</span>()<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish message</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({ topic<span class="op">,</span> data<span class="op">,</span> <span class="op">...</span>options })<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to topic</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(topic<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Request/response pattern</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(topic<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Respond to requests</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">respond</span>(topic<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Unsubscribe (usually automatic)</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsubscribe <span class="op">=</span> client<span class="op">.</span><span class="fu">subscribe</span>(topic<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="fu">unsubscribe</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="2.6.2" id="constructor-options"><span
class="header-section-number">2.6.2</span> Constructor Options</h3>
<div class="sourceCode" id="cb12"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">PanClient</span>(element<span class="op">,</span> options)</span></code></pre></div>
<table>
<thead>
<tr>
<th>Option</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>element</code></td>
<td>HTMLElement</td>
<td>null</td>
<td>Owner element (auto-cleanup)</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>number</td>
<td>5000</td>
<td>Request timeout (ms)</td>
</tr>
<tr>
<td><code>debug</code></td>
<td>boolean</td>
<td>false</td>
<td>Enable debug logging</td>
</tr>
</tbody>
</table>
<h2 data-number="2.7" id="state-management"><span
class="header-section-number">2.7</span> State Management</h2>
<p><strong>What</strong>: Reactive data stores for shared state
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 6
<strong>Reference</strong>: Chapter 18</p>
<h3 data-number="2.7.1" id="options"><span
class="header-section-number">2.7.1</span> Options</h3>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Use For</th>
<th>Component</th>
</tr>
</thead>
<tbody>
<tr>
<td>Component-local</td>
<td>UI state, temp values</td>
<td>N/A</td>
</tr>
<tr>
<td>Shared objects</td>
<td>App config, settings</td>
<td>N/A</td>
</tr>
<tr>
<td><code>pan-store</code></td>
<td>Reactive shared state</td>
<td>Chapter 18</td>
</tr>
<tr>
<td><code>pan-idb</code></td>
<td>Persistent IndexedDB</td>
<td>Chapter 18</td>
</tr>
<tr>
<td>LocalStorage</td>
<td>Simple persistence</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h2 data-number="2.8" id="routing"><span
class="header-section-number">2.8</span> Routing</h2>
<p><strong>What</strong>: URL-based navigation
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 9
<strong>Reference</strong>: Chapter 18</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Message-based routing</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;app.navigate&#39;</span><span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/users/123&#39;</span> }</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>See Chapter 18 for <code>pan-router</code> component
documentation.</p>
<h2 data-number="2.9" id="forms"><span
class="header-section-number">2.9</span> Forms</h2>
<p><strong>What</strong>: Form handling and validation
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 10
<strong>Reference</strong>: Chapter 19</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-form</span><span class="ot"> submit-topic</span><span class="op">=</span><span class="st">&quot;form.submitted&quot;</span><span class="dt">&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-input</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> required</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-input</span><span class="dt">&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-button</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="dt">&gt;</span>Submit<span class="dt">&lt;/</span><span class="kw">pan-button</span><span class="dt">&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-form</span><span class="dt">&gt;</span></span></code></pre></div>
<p>See Chapter 19 for form component documentation.</p>
<h2 data-number="2.10" id="data-fetching"><span
class="header-section-number">2.10</span> Data Fetching</h2>
<p><strong>What</strong>: API integration patterns
<strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 11
<strong>Reference</strong>: Chapter 20</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Via PanClient</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;api.users.list&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Via pan-fetch component</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;api.fetch&#39;</span><span class="op">,</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;/api/users&#39;</span><span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;GET&#39;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>See Chapter 20 for integration components.</p>
<h2 data-number="2.11" id="es-modules"><span
class="header-section-number">2.11</span> ES Modules</h2>
<p>LARC uses standard ES modules:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Import from CDN</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;https://cdn.jsdelivr.net/npm/@larcjs/core/pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Import from local</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;/core/pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Use import maps (recommended)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>script type<span class="op">=</span><span class="st">&quot;importmap&quot;</span><span class="op">&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larc/core&quot;</span><span class="op">:</span> <span class="st">&quot;/core/pan-client.mjs&quot;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>script<span class="op">&gt;</span></span></code></pre></div>
<h2 data-number="2.12" id="cross-references"><span
class="header-section-number">2.12</span> Cross-References</h2>
<ul>
<li><strong>Tutorials</strong>: <em>Learning LARC</em> Chapters 2-5</li>
<li><strong>PAN Bus API</strong>: Chapter 17 (pan-bus)</li>
<li><strong>Component Reference</strong>: Chapters 17-21</li>
<li><strong>Message Topics</strong>: Appendix A</li>
<li><strong>Configuration</strong>: Appendix C</li>
<li><strong>Patterns &amp; Recipes</strong>: Appendix E</li>
</ul>
<h2 data-number="2.13" id="quick-start"><span
class="header-section-number">2.13</span> Quick Start</h2>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install @larcjs/core</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or use CDN</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ex">https://cdn.jsdelivr.net/npm/@larcjs/core@latest/pan-bus.mjs</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larc/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@latest/pan-client.mjs&quot;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">my-app</span><span class="dt">&gt;&lt;/</span><span class="kw">my-app</span><span class="dt">&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> MyApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">connectedCallback</span>() {</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">client</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;h1&gt;Hello LARC!&lt;/h1&gt;&#39;</span><span class="op">;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-app&#39;</span><span class="op">,</span> MyApp)<span class="op">;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p>For detailed tutorials, see <em>Learning LARC</em> Chapter 3 (Getting
Started).</p>
<h1 data-number="3" id="getting-started"><span
class="header-section-number">3</span> Getting Started</h1>
<p>Quick installation and setup reference. For detailed tutorials, see
<em>Learning LARC</em> Chapter 3.</p>
<h2 data-number="3.1" id="installation"><span
class="header-section-number">3.1</span> Installation</h2>
<h3 data-number="3.1.1" id="via-cdn-no-build-tools"><span
class="header-section-number">3.1.1</span> Via CDN (No Build Tools)</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larc/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2/pan-client.mjs&quot;</span><span class="op">,</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larc/ui&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/ui@2/&quot;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">my-app</span><span class="dt">&gt;&lt;/</span><span class="kw">my-app</span><span class="dt">&gt;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> MyApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">connectedCallback</span>() {</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;h1&gt;Hello LARC!&lt;/h1&gt;&#39;</span><span class="op">;</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-app&#39;</span><span class="op">,</span> MyApp)<span class="op">;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="3.1.2" id="via-npm"><span
class="header-section-number">3.1.2</span> Via npm</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install @larcjs/core @larcjs/ui</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In your module</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;@larcjs/ui/pan-button.mjs&#39;</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="3.1.3" id="project-structure"><span
class="header-section-number">3.1.3</span> Project Structure</h3>
<pre><code>my-app/
├── index.html
├── app.mjs
├── components/
│   ├── my-component.mjs
│   └── another-component.mjs
└── styles/
    └── main.css</code></pre>
<h2 data-number="3.2" id="development-server"><span
class="header-section-number">3.2</span> Development Server</h2>
<p>Any static file server works:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> http.server 8000</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Node.js</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> http-server <span class="at">-p</span> 8000</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># PHP</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ex">php</span> <span class="at">-S</span> localhost:8000</span></code></pre></div>
<h2 data-number="3.3" id="minimal-application"><span
class="header-section-number">3.3</span> Minimal Application</h2>
<div class="sourceCode" id="cb24"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- index.html --&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">&quot;UTF-8&quot;</span><span class="dt">&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="dt">&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>LARC App<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larc/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2/pan-client.mjs&quot;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">my-app</span><span class="dt">&gt;&lt;/</span><span class="kw">my-app</span><span class="dt">&gt;</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;/app.mjs&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app.mjs</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to events</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.ready&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;App is ready!&#39;</span>)<span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h1&gt;My LARC Application&lt;/h1&gt;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button id=&quot;test-btn&quot;&gt;Test PAN Bus&lt;/button&gt;</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add event listener</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#test-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;button.clicked&#39;</span><span class="op">,</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> { <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() }</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-app&#39;</span><span class="op">,</span> MyApp)<span class="op">;</span></span></code></pre></div>
<h2 data-number="3.4" id="import-maps"><span
class="header-section-number">3.4</span> Import Maps</h2>
<p>Define module aliases for cleaner imports:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larc/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2/pan-client.mjs&quot;</span><span class="op">,</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larc/ui&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/ui@2/&quot;</span><span class="op">,</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@/&quot;</span><span class="op">:</span> <span class="st">&quot;./src/&quot;</span><span class="op">,</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;components/&quot;</span><span class="op">:</span> <span class="st">&quot;./components/&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Then use:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;@larc/ui/pan-button.mjs&#39;</span><span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MyComponent <span class="im">from</span> <span class="st">&#39;@/my-component.mjs&#39;</span><span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Header <span class="im">from</span> <span class="st">&#39;components/header.mjs&#39;</span><span class="op">;</span></span></code></pre></div>
<h2 data-number="3.5" id="browser-requirements"><span
class="header-section-number">3.5</span> Browser Requirements</h2>
<table>
<thead>
<tr>
<th>Browser</th>
<th>Minimum Version</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chrome</td>
<td>90+</td>
<td>Full support</td>
</tr>
<tr>
<td>Firefox</td>
<td>88+</td>
<td>Full support</td>
</tr>
<tr>
<td>Safari</td>
<td>14+</td>
<td>Full support</td>
</tr>
<tr>
<td>Edge</td>
<td>90+</td>
<td>Full support</td>
</tr>
</tbody>
</table>
<p><strong>Required features:</strong> - Custom Elements v1 - Shadow DOM
v1 - ES Modules - Import Maps</p>
<p>Check support: <code>caniuse.com/custom-elementsv1</code></p>
<h2 data-number="3.6" id="ide-setup"><span
class="header-section-number">3.6</span> IDE Setup</h2>
<h3 data-number="3.6.1" id="vs-code-recommended"><span
class="header-section-number">3.6.1</span> VS Code (Recommended)</h3>
<p>Install extensions:</p>
<ul>
<li><strong>LARC Extension</strong> — Snippets, IntelliSense</li>
<li><strong>ESLint</strong> — Code linting</li>
<li><strong>Prettier</strong> — Code formatting</li>
<li><strong>Live Server</strong> — Development server</li>
</ul>
<h3 data-number="3.6.2" id="typescript-support"><span
class="header-section-number">3.6.2</span> TypeScript Support</h3>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">--save-dev</span> @larcjs/core-types</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// my-component.ts</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="im">type</span> { Message } <span class="im">from</span> <span class="st">&#39;@larcjs/core-types&#39;</span><span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> client<span class="op">:</span> PanClient<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>()<span class="op">:</span> <span class="dt">void</span> {</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.updated&#39;</span><span class="op">,</span> (msg<span class="op">:</span> Message) <span class="kw">=&gt;</span> {</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="3.7" id="quick-verification"><span
class="header-section-number">3.7</span> Quick Verification</h2>
<p>Test your setup:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Open browser console</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client<span class="op">.</span><span class="fu">ready</span>()<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;test&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Received:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>))<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({ <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;test&#39;</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> { <span class="dt">hello</span><span class="op">:</span> <span class="st">&#39;world&#39;</span> } })<span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Should log: Received: { hello: &#39;world&#39; }</span></span></code></pre></div>
<h2 data-number="3.8" id="next-steps"><span
class="header-section-number">3.8</span> Next Steps</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 3 for
step-by-step guide</li>
<li><strong>Core concepts</strong>: Chapter 2 for quick reference</li>
<li><strong>Components</strong>: Chapters 17-21 for API
documentation</li>
<li><strong>Examples</strong>:
<code>github.com/larcjs/examples</code></li>
</ul>
<h2 data-number="3.9" id="common-issues"><span
class="header-section-number">3.9</span> Common Issues</h2>
<h3 data-number="3.9.1" id="import-maps-not-working"><span
class="header-section-number">3.9.1</span> Import Maps Not Working</h3>
<p><strong>Problem</strong>: Imports fail with “Failed to resolve module
specifier” <strong>Solution</strong>: Ensure import maps are in
<code>&lt;head&gt;</code> before any module scripts</p>
<h3 data-number="3.9.2" id="pan-bus-not-ready"><span
class="header-section-number">3.9.2</span> PAN Bus Not Ready</h3>
<p><strong>Problem</strong>: <code>client.ready()</code> never resolves
<strong>Solution</strong>: Verify <code>&lt;pan-bus&gt;</code> element
is in DOM before creating PanClient</p>
<h3 data-number="3.9.3" id="cors-errors-with-cdn"><span
class="header-section-number">3.9.3</span> CORS Errors with CDN</h3>
<p><strong>Problem</strong>: Module loading fails with CORS error
<strong>Solution</strong>: Use a local development server, not
<code>file://</code> protocol</p>
<p>See <em>Learning LARC</em> Chapter 3 for detailed
troubleshooting.</p>
<h1 data-number="4" id="state-management-1"><span
class="header-section-number">4</span> State Management</h1>
<p>Quick reference for state management patterns in LARC applications.
For detailed tutorials, see <em>Learning LARC</em> Chapter 6.</p>
<h2 data-number="4.1" id="overview"><span
class="header-section-number">4.1</span> Overview</h2>
<p>State management is the practice of tracking application data across
components. LARC distinguishes between <strong>local state</strong>
(component-specific) and <strong>shared state</strong>
(application-wide), using the PAN bus for state synchronization.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>Local state: Component properties, ephemeral</li>
<li>Shared state: Store components, persisted via localStorage,
IndexedDB, or OPFS</li>
<li>State stores: Components that manage and publish shared state</li>
<li>Synchronization: Optimistic updates, debouncing, polling, conflict
resolution</li>
</ul>
<h2 data-number="4.2" id="quick-example"><span
class="header-section-number">4.2</span> Quick Example</h2>
<div class="sourceCode" id="cb31"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// State store component</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserStore <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentUser</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> [</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subscribe</span>(<span class="st">&#39;auth.login.success&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">setUser</span>(msg<span class="op">.</span><span class="at">data</span>))<span class="op">,</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subscribe</span>(<span class="st">&#39;auth.logout&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">setUser</span>(<span class="kw">null</span>))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadPersistedUser</span>()<span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setUser</span>(user) {</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentUser</span> <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;user.current&#39;</span><span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (user) {</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;currentUser&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(user))<span class="op">;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="st">&#39;currentUser&#39;</span>)<span class="op">;</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadPersistedUser</span>() {</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stored <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;currentUser&#39;</span>)<span class="op">;</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (stored) {</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setUser</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(stored))<span class="op">;</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load user:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">forEach</span>(unsub <span class="kw">=&gt;</span> <span class="fu">unsub</span>())<span class="op">;</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-store&#39;</span><span class="op">,</span> UserStore)<span class="op">;</span></span></code></pre></div>
<h2 data-number="4.3" id="persistence-strategies"><span
class="header-section-number">4.3</span> Persistence Strategies</h2>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 27%" />
<col style="width: 25%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>Size Limit</th>
<th>API Style</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>localStorage</strong></td>
<td>5-10 MB</td>
<td>Synchronous</td>
<td>Small settings, simple data</td>
</tr>
<tr>
<td><strong>IndexedDB</strong></td>
<td>100s of MB</td>
<td>Async (Promise)</td>
<td>Structured data, queries</td>
</tr>
<tr>
<td><strong>OPFS</strong></td>
<td>GB+</td>
<td>Async (File API)</td>
<td>Large files, binary data</td>
</tr>
</tbody>
</table>
<h3 data-number="4.3.1" id="when-to-use-each"><span
class="header-section-number">4.3.1</span> When to Use Each</h3>
<ul>
<li><strong>localStorage</strong>: Settings, themes, small JSON (&lt;
100 KB)</li>
<li><strong>IndexedDB</strong>: Documents, cached API responses,
structured records</li>
<li><strong>OPFS</strong>: Images, videos, large text files, application
data files</li>
</ul>
<h2 data-number="4.4" id="state-synchronization-patterns"><span
class="header-section-number">4.4</span> State Synchronization
Patterns</h2>
<h3 data-number="4.4.1" id="optimistic-updates"><span
class="header-section-number">4.4.1</span> Optimistic Updates</h3>
<table>
<thead>
<tr>
<th>Step</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Update local state immediately</td>
</tr>
<tr>
<td>2</td>
<td>Publish updated state to UI</td>
</tr>
<tr>
<td>3</td>
<td>Sync to server in background</td>
</tr>
<tr>
<td>4</td>
<td>On success: Publish confirmation</td>
</tr>
<tr>
<td>5</td>
<td>On error: Rollback and publish error</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb32"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">addTodo</span>(todo) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1-2: Optimistic update</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> temp <span class="op">=</span> { <span class="dt">id</span><span class="op">:</span> <span class="vs">`temp-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="op">...</span>todo }<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">push</span>(temp)<span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;todos.loaded&#39;</span><span class="op">,</span> { <span class="dt">todos</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> })<span class="op">;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 3: Sync to server</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/todos&#39;</span><span class="op">,</span> {</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(todo)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> saved <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 4: Replace temp with server ID</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">map</span>(t <span class="kw">=&gt;</span> t<span class="op">.</span><span class="at">id</span> <span class="op">===</span> temp<span class="op">.</span><span class="at">id</span> <span class="op">?</span> saved <span class="op">:</span> t)<span class="op">;</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;todos.loaded&#39;</span><span class="op">,</span> { <span class="dt">todos</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> })<span class="op">;</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 5: Rollback on error</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">filter</span>(t <span class="kw">=&gt;</span> t<span class="op">.</span><span class="at">id</span> <span class="op">!==</span> temp<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;todos.loaded&#39;</span><span class="op">,</span> { <span class="dt">todos</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> })<span class="op">;</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;todo.error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.4.2" id="debounced-sync"><span
class="header-section-number">4.4.2</span> Debounced Sync</h3>
<p>For high-frequency updates (e.g., text editor), debounce server sync
while updating UI immediately:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">updateContent</span>(content) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> content<span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;editor.content.updated&#39;</span><span class="op">,</span> { content })<span class="op">;</span> <span class="co">// Immediate UI update</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">syncTimer</span>)<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">syncTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">syncToServer</span>()<span class="op">;</span> <span class="co">// Delayed server sync</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.4.3" id="polling"><span
class="header-section-number">4.4.3</span> Polling</h3>
<p>Poll server periodically for updates without WebSockets:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startPolling</span>() {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">fetchNotifications</span>()<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">pollTimer</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">fetchNotifications</span>()<span class="op">;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span> <span class="co">// Every 30 seconds</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.5" id="conflict-resolution-strategies"><span
class="header-section-number">4.5</span> Conflict Resolution
Strategies</h2>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 39%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Last Write Wins</strong></td>
<td>Most recent update overwrites</td>
<td>Simple apps, rare conflicts</td>
</tr>
<tr>
<td><strong>Timestamps</strong></td>
<td>Keep update with newest timestamp</td>
<td>Async updates, out-of-order messages</td>
</tr>
<tr>
<td><strong>Version Vectors</strong></td>
<td>Track causality across clients</td>
<td>Distributed systems, offline-first</td>
</tr>
<tr>
<td><strong>User Intervention</strong></td>
<td>Detect conflict, prompt user</td>
<td>Collaborative apps, important data</td>
</tr>
</tbody>
</table>
<h3 data-number="4.5.1" id="example-timestamp-based-resolution"><span
class="header-section-number">4.5.1</span> Example: Timestamp-Based
Resolution</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> <span class="fu">subscribe</span>(<span class="st">&#39;data.update&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { key<span class="op">,</span> value<span class="op">,</span> timestamp } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only apply if newer</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">timestamps</span>[key] <span class="op">||</span> timestamp <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">timestamps</span>[key]) {</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">data</span>[key] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">timestamps</span>[key] <span class="op">=</span> timestamp<span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;data.current&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.6" id="derived-state-pattern"><span
class="header-section-number">4.6</span> Derived State Pattern</h2>
<p>Compute derived state from source state rather than storing
redundantly:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">publishDerivedState</span>() {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> itemCount <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">quantity</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> subtotal <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> (item<span class="op">.</span><span class="at">price</span> <span class="op">*</span> item<span class="op">.</span><span class="at">quantity</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tax <span class="op">=</span> subtotal <span class="op">*</span> <span class="fl">0.08</span><span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> total <span class="op">=</span> subtotal <span class="op">+</span> tax<span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;cart.state&#39;</span><span class="op">,</span> {</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">,</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    itemCount<span class="op">,</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    subtotal<span class="op">,</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    tax<span class="op">,</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    total</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.7" id="history-and-time-travel"><span
class="header-section-number">4.7</span> History and Time Travel</h2>
<p>Implement undo/redo by maintaining state snapshots:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addSnapshot</span>(state) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">history</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentIndex</span> <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">push</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(state)))<span class="op">;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">currentIndex</span><span class="op">++;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxHistory</span>) {</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentIndex</span><span class="op">--;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;state.current&#39;</span><span class="op">,</span> state)<span class="op">;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;state.history.updated&#39;</span><span class="op">,</span> {</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canUndo</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentIndex</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">canRedo</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentIndex</span> <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.8" id="performance-best-practices"><span
class="header-section-number">4.8</span> Performance Best Practices</h2>
<table>
<thead>
<tr>
<th>Practice</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Minimize updates</td>
<td>Only publish when state actually changes</td>
</tr>
<tr>
<td>Batch updates</td>
<td>Combine multiple field changes into single message</td>
</tr>
<tr>
<td>Immutable updates</td>
<td>Create new objects, don’t mutate</td>
</tr>
<tr>
<td>Debounce high-frequency</td>
<td>Don’t publish every keystroke</td>
</tr>
<tr>
<td>Lazy load</td>
<td>Load data on demand</td>
</tr>
<tr>
<td>Prune old data</td>
<td>Remove stale data to prevent memory bloat</td>
</tr>
</tbody>
</table>
<h2 data-number="4.9" id="component-reference"><span
class="header-section-number">4.9</span> Component Reference</h2>
<ul>
<li><strong>pan-store</strong>: Reactive state store with persistence -
See Chapter 18</li>
<li><strong>pan-idb</strong>: IndexedDB wrapper component - See Chapter
18</li>
</ul>
<h2 data-number="4.10"
id="complete-example-document-store-with-indexeddb"><span
class="header-section-number">4.10</span> Complete Example: Document
Store with IndexedDB</h2>
<div class="sourceCode" id="cb38"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DocumentStore <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">IndexedDBStore</span>(<span class="st">&#39;app-db&#39;</span><span class="op">,</span> <span class="st">&#39;documents&#39;</span>)<span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> [</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subscribe</span>(<span class="st">&#39;document.save&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">saveDocument</span>(msg<span class="op">.</span><span class="at">data</span>))<span class="op">,</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subscribe</span>(<span class="st">&#39;document.delete&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">deleteDocument</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>))<span class="op">,</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">subscribe</span>(<span class="st">&#39;document.load&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadDocument</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>))</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadAllDocuments</span>()<span class="op">;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadAllDocuments</span>() {</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;documents.loaded&#39;</span><span class="op">,</span> { <span class="dt">documents</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> })<span class="op">;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load documents:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;documents.error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">saveDocument</span>(<span class="bu">document</span>) {</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">put</span>(<span class="bu">document</span>)<span class="op">;</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.saved&#39;</span><span class="op">,</span> { <span class="bu">document</span> })<span class="op">;</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;documents.loaded&#39;</span><span class="op">,</span> { <span class="dt">documents</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> })<span class="op">;</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to save document:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">deleteDocument</span>(id) {</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">delete</span>(id)<span class="op">;</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.deleted&#39;</span><span class="op">,</span> { id })<span class="op">;</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;documents.loaded&#39;</span><span class="op">,</span> { <span class="dt">documents</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">documents</span> })<span class="op">;</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to delete document:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadDocument</span>(id) {</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> <span class="bu">document</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">get</span>(id)<span class="op">;</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.loaded&#39;</span><span class="op">,</span> { <span class="bu">document</span> })<span class="op">;</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load document:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(<span class="st">&#39;document.error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">forEach</span>(unsub <span class="kw">=&gt;</span> <span class="fu">unsub</span>())<span class="op">;</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;document-store&#39;</span><span class="op">,</span> DocumentStore)<span class="op">;</span></span></code></pre></div>
<h2 data-number="4.11" id="cross-references-1"><span
class="header-section-number">4.11</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 6 (State
Management)</li>
<li><strong>Components</strong>: Chapter 18 (pan-store, pan-idb)</li>
<li><strong>Patterns</strong>: Appendix E (Message Patterns)</li>
<li><strong>Related</strong>: Chapter 5 (Routing), Chapter 7 (Data
Fetching)</li>
</ul>
<h2 data-number="4.12" id="common-issues-1"><span
class="header-section-number">4.12</span> Common Issues</h2>
<h3 data-number="4.12.1" id="issue-state-not-persisting"><span
class="header-section-number">4.12.1</span> Issue: State not
persisting</h3>
<p><strong>Problem</strong>: Data lost on page reload
<strong>Solution</strong>: Ensure <code>loadPersistedUser()</code>
called in <code>connectedCallback()</code> and storage API used
correctly</p>
<h3 data-number="4.12.2" id="issue-race-conditions"><span
class="header-section-number">4.12.2</span> Issue: Race conditions</h3>
<p><strong>Problem</strong>: Concurrent updates causing inconsistent
state <strong>Solution</strong>: Use timestamps or version vectors,
implement conflict resolution strategy</p>
<h3 data-number="4.12.3"
id="issue-memory-leaks-from-subscriptions"><span
class="header-section-number">4.12.3</span> Issue: Memory leaks from
subscriptions</h3>
<p><strong>Problem</strong>: Memory grows over time
<strong>Solution</strong>: Always unsubscribe in
<code>disconnectedCallback()</code>, store subscription functions</p>
<h3 data-number="4.12.4" id="issue-localstorage-quota-exceeded"><span
class="header-section-number">4.12.4</span> Issue: localStorage quota
exceeded</h3>
<p><strong>Problem</strong>: <code>QuotaExceededError</code> thrown
<strong>Solution</strong>: Migrate to IndexedDB for larger data,
implement data pruning strategy</p>
<h3 data-number="4.12.5"
id="issue-stale-data-after-optimistic-update-failure"><span
class="header-section-number">4.12.5</span> Issue: Stale data after
optimistic update failure</h3>
<p><strong>Problem</strong>: UI shows incorrect state after server error
<strong>Solution</strong>: Implement rollback in catch block, publish
error state</p>
<p>See <em>Learning LARC</em> Chapter 6 for detailed troubleshooting and
advanced patterns.</p>
<h1 data-number="5" id="routing-and-navigation"><span
class="header-section-number">5</span> Routing and Navigation</h1>
<p>Quick reference for client-side routing with LARC’s
<code>pan-routes</code> component. For detailed tutorials, see
<em>Learning LARC</em> Chapter 9.</p>
<h2 data-number="5.1" id="overview-1"><span
class="header-section-number">5.1</span> Overview</h2>
<p>Client-side routing updates the URL and renders components without
full page reloads. LARC’s <code>pan-routes</code> component matches URL
patterns to components, enabling seamless navigation experiences.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>Route patterns: Map URLs to components</li>
<li>Dynamic parameters: Extract values from URLs (<code>:id</code>,
<code>:username</code>)</li>
<li>Navigation guards: Control access to routes</li>
<li>Deep linking: Encode application state in URLs</li>
<li>History management: Push vs. replace navigation</li>
</ul>
<h2 data-number="5.2" id="quick-example-1"><span
class="header-section-number">5.2</span> Quick Example</h2>
<div class="sourceCode" id="cb39"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-app</span><span class="dt">&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-routes</span><span class="dt">&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;home-view&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/products&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;product-list&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/products/:id&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;product-detail&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;*&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;not-found-view&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-routes</span><span class="dt">&gt;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-app</span><span class="dt">&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductDetail <span class="kw">extends</span> LarcComponent {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRoute</span>(params) {</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// params.id extracted from URL</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadProduct</span>(params<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadProduct</span>(id) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/products/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">product</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.3" id="route-patterns"><span
class="header-section-number">5.3</span> Route Patterns</h2>
<h3 data-number="5.3.1" id="route-matching-order"><span
class="header-section-number">5.3.1</span> Route Matching Order</h3>
<p>Routes evaluate <strong>top to bottom</strong>. Place specific routes
before general ones:</p>
<table>
<thead>
<tr>
<th>Priority</th>
<th>Pattern</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><code>/login</code></td>
<td>Exact static paths first</td>
</tr>
<tr>
<td>2</td>
<td><code>/products/new</code></td>
<td>Static before dynamic</td>
</tr>
<tr>
<td>3</td>
<td><code>/products/:id</code></td>
<td>Dynamic parameters</td>
</tr>
<tr>
<td>4</td>
<td><code>/admin/:section</code></td>
<td>General patterns</td>
</tr>
<tr>
<td>5</td>
<td><code>*</code></td>
<td>Catch-all (404) last</td>
</tr>
</tbody>
</table>
<h3 data-number="5.3.2" id="dynamic-parameters"><span
class="header-section-number">5.3.2</span> Dynamic Parameters</h3>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 32%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Example URL</th>
<th>Extracted Params</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/products/:id</code></td>
<td><code>/products/123</code></td>
<td><code>{ id: '123' }</code></td>
</tr>
<tr>
<td><code>/users/:username</code></td>
<td><code>/users/alice</code></td>
<td><code>{ username: 'alice' }</code></td>
</tr>
<tr>
<td><code>/posts/:year/:month/:slug</code></td>
<td><code>/posts/2024/12/hello</code></td>
<td><code>{ year: '2024', month: '12', slug: 'hello' }</code></td>
</tr>
<tr>
<td><code>/store/:category/:subcategory/:id</code></td>
<td><code>/store/electronics/phones/456</code></td>
<td><code>{ category: 'electronics', subcategory: 'phones', id: '456' }</code></td>
</tr>
</tbody>
</table>
<h3 data-number="5.3.3" id="nested-routes"><span
class="header-section-number">5.3.3</span> Nested Routes</h3>
<p>Use wildcard suffix (<code>*</code>) for nested route sections:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-routes</span><span class="dt">&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;home-view&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/products*&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;product-section&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/admin*&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;admin-section&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-routes</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Product section contains its own sub-routes:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductSection <span class="kw">extends</span> LarcComponent {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;product-section&quot;&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;nav class=&quot;sidebar&quot;&gt;...&lt;/nav&gt;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;main&gt;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;pan-routes&gt;</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/products&quot; component=&quot;product-list&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/products/new&quot; component=&quot;product-form&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/products/:id&quot; component=&quot;product-detail&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/pan-routes&gt;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/main&gt;</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.4" id="programmatic-navigation"><span
class="header-section-number">5.4</span> Programmatic Navigation</h2>
<h3 data-number="5.4.1" id="navigate-function"><span
class="header-section-number">5.4.1</span> navigate() Function</h3>
<div class="sourceCode" id="cb43"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { navigate } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic navigation</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="st">&#39;/products/123&#39;</span>)<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace current history entry (don&#39;t add to back button)</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="st">&#39;/login&#39;</span><span class="op">,</span> { <span class="dt">replace</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Navigate back/forward</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">;</span>  <span class="co">// Back one page</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="dv">1</span>)<span class="op">;</span>   <span class="co">// Forward one page</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="op">-</span><span class="dv">2</span>)<span class="op">;</span>  <span class="co">// Back two pages</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Navigation after form submission</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">handleLogin</span>(<span class="bu">event</span>) {</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/login&#39;</span><span class="op">,</span> { <span class="co">/*...*/</span> })<span class="op">;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">navigate</span>(<span class="st">&#39;/dashboard&#39;</span>)<span class="op">;</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Invalid credentials&#39;</span>)<span class="op">;</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.4.2" id="when-to-use-replace"><span
class="header-section-number">5.4.2</span> When to Use Replace</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Use Replace</th>
</tr>
</thead>
<tbody>
<tr>
<td>Login redirects</td>
<td>Yes - Skip intermediate loading pages</td>
</tr>
<tr>
<td>Fixing invalid URLs</td>
<td>Yes - User shouldn’t return to bad URL</td>
</tr>
<tr>
<td>Multi-step wizards</td>
<td>No - Allow back navigation between steps</td>
</tr>
<tr>
<td>Normal navigation</td>
<td>No - Default push behavior</td>
</tr>
</tbody>
</table>
<h2 data-number="5.5" id="navigation-guards"><span
class="header-section-number">5.5</span> Navigation Guards</h2>
<p>Control access to routes based on authentication, roles, or
state.</p>
<h3 data-number="5.5.1" id="auth-guard-pattern"><span
class="header-section-number">5.5.1</span> Auth Guard Pattern</h3>
<div class="sourceCode" id="cb44"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthGuard {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadUserFromStorage</span>()<span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadUserFromStorage</span>() {</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stored <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;user&#39;</span>)<span class="op">;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (stored) <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(stored)<span class="op">;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">canActivate</span>(route) {</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span>) {</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">navigate</span>(<span class="st">&#39;/login?redirect=&#39;</span> <span class="op">+</span> <span class="pp">encodeURIComponent</span>(route<span class="op">.</span><span class="at">path</span>))<span class="op">;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">requiresRole</span>(role) {</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">roles</span><span class="op">.</span><span class="fu">includes</span>(role)<span class="op">;</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authGuard <span class="op">=</span> <span class="kw">new</span> <span class="fu">AuthGuard</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.5.2" id="component-guard-hooks"><span
class="header-section-number">5.5.2</span> Component Guard Hooks</h3>
<div class="sourceCode" id="cb45"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DashboardView <span class="kw">extends</span> LarcComponent {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeRoute</span>(params) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>authGuard<span class="op">.</span><span class="fu">canActivate</span>(<span class="kw">this</span><span class="op">.</span><span class="at">route</span>)) {</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> <span class="co">// Cancel navigation</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span> <span class="co">// Allow navigation</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRoute</span>(params) {</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadDashboardData</span>()<span class="op">;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AdminPanel <span class="kw">extends</span> LarcComponent {</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeRoute</span>(params) {</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>authGuard<span class="op">.</span><span class="fu">requiresRole</span>(<span class="st">&#39;admin&#39;</span>)) {</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">navigate</span>(<span class="st">&#39;/unauthorized&#39;</span>)<span class="op">;</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PostEditor <span class="kw">extends</span> LarcComponent {</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeRouteLeave</span>(to<span class="op">,</span> <span class="im">from</span>) {</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">isDirty</span>) {</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">confirm</span>(<span class="st">&#39;You have unsaved changes. Leave anyway?&#39;</span>)<span class="op">;</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.6" id="query-parameters-and-deep-linking"><span
class="header-section-number">5.6</span> Query Parameters and Deep
Linking</h2>
<p>Encode filters, search, pagination in URLs for bookmarkable
state.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductList <span class="kw">extends</span> LarcComponent {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onRoute</span>(params<span class="op">,</span> query) {</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> {</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>      category <span class="op">=</span> <span class="st">&#39;all&#39;</span><span class="op">,</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>      sort <span class="op">=</span> <span class="st">&#39;name&#39;</span><span class="op">,</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>      page <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>      search <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    } <span class="op">=</span> query<span class="op">;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadProducts</span>({ category<span class="op">,</span> sort<span class="op">,</span> page<span class="op">,</span> search })<span class="op">;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleFilterChange</span>(category) {</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentQuery <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getQueryParams</span>()<span class="op">;</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">navigate</span>(<span class="vs">`/products?</span><span class="sc">${</span><span class="kw">new</span> <span class="fu">URLSearchParams</span>({</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>currentQuery<span class="op">,</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>      category<span class="op">,</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    })<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getQueryParams</span>() {</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.7" id="hash-fragments"><span
class="header-section-number">5.7</span> Hash Fragments</h2>
<p>Use for section scrolling and anchors:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DocumentationView <span class="kw">extends</span> LarcComponent {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">afterRender</span>() {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> hash <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">hash</span><span class="op">;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (hash) {</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> element <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(hash)<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (element) {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        element<span class="op">.</span><span class="fu">scrollIntoView</span>({ <span class="dt">behavior</span><span class="op">:</span> <span class="st">&#39;smooth&#39;</span> })<span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;article&gt;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Content...&lt;/p&gt;</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h2 id=&quot;getting-started&quot;&gt;Getting Started&lt;/h2&gt;</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;More content...&lt;/p&gt;</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;nav&gt;</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;a href=&quot;#introduction&quot;&gt;Introduction&lt;/a&gt;</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;a href=&quot;#getting-started&quot;&gt;Getting Started&lt;/a&gt;</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/nav&gt;</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/article&gt;</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.8" id="history-management"><span
class="header-section-number">5.8</span> History Management</h2>
<h3 data-number="5.8.1" id="push-vs.-replace"><span
class="header-section-number">5.8.1</span> Push vs. Replace</h3>
<div class="sourceCode" id="cb48"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Push (default): Adds to history, back button works</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="st">&#39;/products/123&#39;</span>)<span class="op">;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace: Replaces current entry, skips this page on back</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">navigate</span>(<span class="st">&#39;/login&#39;</span><span class="op">,</span> { <span class="dt">replace</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.8.2" id="scroll-position-preservation"><span
class="header-section-number">5.8.2</span> Scroll Position
Preservation</h3>
<div class="sourceCode" id="cb49"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ScrollManager {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">positions</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupListeners</span>()<span class="op">;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupListeners</span>() {</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;beforeunload&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">savePosition</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">restorePosition</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">savePosition</span>(path) {</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">positions</span><span class="op">.</span><span class="fu">set</span>(path<span class="op">,</span> {</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">x</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">scrollX</span><span class="op">,</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">y</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">scrollY</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">restorePosition</span>(path) {</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> position <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">positions</span><span class="op">.</span><span class="fu">get</span>(path)<span class="op">;</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (position) {</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="fu">scrollTo</span>(position<span class="op">.</span><span class="at">x</span><span class="op">,</span> position<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="fu">scrollTo</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.8.3" id="history-event-listener"><span
class="header-section-number">5.8.3</span> History Event Listener</h3>
<div class="sourceCode" id="cb50"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;popstate&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// User clicked back/forward button</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">handleNavigation</span>(<span class="bu">event</span><span class="op">.</span><span class="at">state</span>)<span class="op">;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.9" id="active-link-states"><span
class="header-section-number">5.9</span> Active Link States</h2>
<p>Highlight current route in navigation:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NavBar <span class="kw">extends</span> LarcComponent {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span> <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span><span class="op">;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;popstate&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span> <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span><span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isActive</span>(path) {</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span> <span class="op">===</span> path<span class="op">;</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isActivePrefix</span>(prefix) {</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span><span class="op">.</span><span class="fu">startsWith</span>(prefix)<span class="op">;</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;nav&gt;</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;a href=&quot;/&quot; class=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">isActive</span>(<span class="st">&#39;/&#39;</span>) <span class="op">?</span> <span class="st">&#39;active&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;Home&lt;/a&gt;</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;a href=&quot;/products&quot; class=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">isActivePrefix</span>(<span class="st">&#39;/products&#39;</span>) <span class="op">?</span> <span class="st">&#39;active&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;Products&lt;/a&gt;</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;a href=&quot;/about&quot; class=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">isActive</span>(<span class="st">&#39;/about&#39;</span>) <span class="op">?</span> <span class="st">&#39;active&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;About&lt;/a&gt;</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/nav&gt;</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.10" id="seo-considerations"><span
class="header-section-number">5.10</span> SEO Considerations</h2>
<h3 data-number="5.10.1" id="update-meta-tags-on-route-change"><span
class="header-section-number">5.10.1</span> Update Meta Tags on Route
Change</h3>
<div class="sourceCode" id="cb52"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SEOManager {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateMeta</span>(route<span class="op">,</span> data) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">title</span> <span class="op">=</span> data<span class="op">.</span><span class="at">title</span> <span class="op">||</span> <span class="st">&#39;Default Title&#39;</span><span class="op">;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setMetaTag</span>(<span class="st">&#39;description&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">description</span> <span class="op">||</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setMetaTag</span>(<span class="st">&#39;og:title&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">title</span>)<span class="op">;</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setMetaTag</span>(<span class="st">&#39;og:description&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">description</span>)<span class="op">;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setMetaTag</span>(<span class="st">&#39;og:url&#39;</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span>)<span class="op">;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setLinkTag</span>(<span class="st">&#39;canonical&#39;</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span>)<span class="op">;</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setMetaTag</span>(name<span class="op">,</span> content) {</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`meta[name=&quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;]`</span>) <span class="op">||</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`meta[property=&quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>element) {</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>      element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;meta&#39;</span>)<span class="op">;</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> attr <span class="op">=</span> name<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;og:&#39;</span>) <span class="op">?</span> <span class="st">&#39;property&#39;</span> <span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">;</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="fu">setAttribute</span>(attr<span class="op">,</span> name)<span class="op">;</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="at">head</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;content&#39;</span><span class="op">,</span> content)<span class="op">;</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setLinkTag</span>(rel<span class="op">,</span> href) {</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`link[rel=&quot;</span><span class="sc">${</span>rel<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>element) {</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>      element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;link&#39;</span>)<span class="op">;</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>      element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;rel&#39;</span><span class="op">,</span> rel)<span class="op">;</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="at">head</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;href&#39;</span><span class="op">,</span> href)<span class="op">;</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> seoManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">SEOManager</span>()<span class="op">;</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductDetail <span class="kw">extends</span> LarcComponent {</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">onRoute</span>(params) {</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> product <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadProduct</span>(params<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    seoManager<span class="op">.</span><span class="fu">updateMeta</span>(<span class="kw">this</span><span class="op">.</span><span class="at">route</span><span class="op">,</span> {</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>product<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> - Our Store`</span><span class="op">,</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">description</span><span class="op">:</span> product<span class="op">.</span><span class="at">description</span><span class="op">,</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">image</span><span class="op">:</span> product<span class="op">.</span><span class="at">imageUrl</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.10.2" id="ssr-and-prerendering"><span
class="header-section-number">5.10.2</span> SSR and Prerendering</h3>
<p>For maximum SEO, consider:</p>
<ul>
<li><strong>Server-side rendering (SSR)</strong>: Render initial HTML on
server</li>
<li><strong>Static prerendering</strong>: Generate HTML at build time
for static routes</li>
<li><strong>Dynamic rendering</strong>: Serve prerendered HTML to
crawlers, SPA to users</li>
</ul>
<p>See Appendix C (Deployment) for SSR and prerendering strategies.</p>
<h2 data-number="5.11" id="component-reference-1"><span
class="header-section-number">5.11</span> Component Reference</h2>
<p>See Chapter 18 for pan-routes API documentation and message
patterns.</p>
<h2 data-number="5.12"
id="complete-example-e-commerce-app-routing"><span
class="header-section-number">5.12</span> Complete Example: E-commerce
App Routing</h2>
<div class="sourceCode" id="cb53"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { LarcComponent<span class="op">,</span> navigate } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MainApp <span class="kw">extends</span> LarcComponent {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">authGuard</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AuthGuard</span>()<span class="op">;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">seoManager</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">SEOManager</span>()<span class="op">;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">scrollManager</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">ScrollManager</span>()<span class="op">;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupNavigation</span>()<span class="op">;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupNavigation</span>() {</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;popstate&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;app&quot;&gt;</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;app-header&gt;&lt;/app-header&gt;</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;main&gt;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;pan-routes&gt;</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/&quot; component=&quot;home-view&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/products&quot; component=&quot;product-list&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/products/:id&quot; component=&quot;product-detail&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/cart&quot; component=&quot;shopping-cart&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/checkout&quot; component=&quot;checkout-view&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;/account*&quot; component=&quot;account-section&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-route path=&quot;*&quot; component=&quot;not-found-view&quot;&gt;&lt;/pan-route&gt;</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/pan-routes&gt;</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/main&gt;</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;app-footer&gt;&lt;/app-footer&gt;</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;main-app&#39;</span><span class="op">,</span> MainApp)<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.13" id="cross-references-2"><span
class="header-section-number">5.13</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 9 (Routing
and Navigation)</li>
<li><strong>Components</strong>: Chapter 18 (pan-routes API)</li>
<li><strong>Patterns</strong>: Appendix E (Navigation Patterns)</li>
<li><strong>Related</strong>: Chapter 4 (State Management), Chapter 16
(Deployment/SEO)</li>
</ul>
<h2 data-number="5.14" id="common-issues-2"><span
class="header-section-number">5.14</span> Common Issues</h2>
<h3 data-number="5.14.1" id="issue-routes-not-matching"><span
class="header-section-number">5.14.1</span> Issue: Routes not
matching</h3>
<p><strong>Problem</strong>: URL changes but component doesn’t render
<strong>Solution</strong>: Check route order (specific before general),
ensure pan-routes is in DOM</p>
<h3 data-number="5.14.2" id="issue-back-button-breaks-app"><span
class="header-section-number">5.14.2</span> Issue: Back button breaks
app</h3>
<p><strong>Problem</strong>: Clicking back causes errors or blank page
<strong>Solution</strong>: Implement proper cleanup in
<code>disconnectedCallback()</code>, save/restore scroll position</p>
<h3 data-number="5.14.3" id="issue-parameters-not-updating"><span
class="header-section-number">5.14.3</span> Issue: Parameters not
updating</h3>
<p><strong>Problem</strong>: Component doesn’t re-render when URL params
change <strong>Solution</strong>: Implement <code>onRoute(params)</code>
lifecycle hook to react to param changes</p>
<h3 data-number="5.14.4"
id="issue-seo-crawlers-not-indexing-pages"><span
class="header-section-number">5.14.4</span> Issue: SEO crawlers not
indexing pages</h3>
<p><strong>Problem</strong>: Search engines see empty content
<strong>Solution</strong>: Implement SSR or prerendering, ensure meta
tags update correctly</p>
<h3 data-number="5.14.5" id="issue-nested-routes-conflict"><span
class="header-section-number">5.14.5</span> Issue: Nested routes
conflict</h3>
<p><strong>Problem</strong>: Child routes override parent routes
<strong>Solution</strong>: Use wildcard suffix (<code>*</code>) in
parent route pattern, ensure child patterns are more specific</p>
<p>See <em>Learning LARC</em> Chapter 9 for detailed troubleshooting and
advanced routing patterns.</p>
<h1 data-number="6" id="forms-and-user-input"><span
class="header-section-number">6</span> Forms and User Input</h1>
<p>Quick reference for form handling in LARC applications. For detailed
tutorials, see <em>Learning LARC</em> Chapter 10.</p>
<h2 data-number="6.1" id="overview-2"><span
class="header-section-number">6.1</span> Overview</h2>
<p>Forms enable user input through validation, submission handling, and
error feedback. LARC uses standard HTML forms with JavaScript event
handling—no magic, no framework-specific syntax.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>FormData API: Extract values from form inputs</li>
<li>Validation strategies: Client-side and server-side validation</li>
<li>Loading states: Provide feedback during async operations</li>
<li>Error handling: Display meaningful messages</li>
<li>File uploads: Handle files with modern APIs</li>
</ul>
<h2 data-number="6.2" id="quick-example-2"><span
class="header-section-number">6.2</span> Quick Example</h2>
<div class="sourceCode" id="cb54"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginForm <span class="kw">extends</span> LarcComponent {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(<span class="bu">event</span>) {</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">event</span><span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(<span class="bu">event</span><span class="op">.</span><span class="at">target</span>)<span class="op">;</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> credentials <span class="op">=</span> {</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;email&#39;</span>)<span class="op">,</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">password</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;password&#39;</span>)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/login&#39;</span><span class="op">,</span> {</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(credentials)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(user))<span class="op">;</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">navigate</span>(<span class="st">&#39;/dashboard&#39;</span>)<span class="op">;</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="st">&#39;Invalid credentials&#39;</span><span class="op">;</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="st">&#39;Network error. Please try again.&#39;</span><span class="op">;</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form onsubmit=&quot;this.handleSubmit(event)&quot;&gt;</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;email&quot; name=&quot;email&quot; required autocomplete=&quot;email&quot;&gt;</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;password&quot; name=&quot;password&quot; required&gt;</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; ?disabled=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;Logging in...&#39;</span> <span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="sc">}</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.3" id="validation-strategies"><span
class="header-section-number">6.3</span> Validation Strategies</h2>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 18%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>When</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTML5 validation</strong></td>
<td>Simple cases</td>
<td>Use <code>required</code>, <code>pattern</code>, <code>min</code>,
<code>max</code> attributes</td>
</tr>
<tr>
<td><strong>Client-side JS</strong></td>
<td>Immediate feedback</td>
<td>Validate on <code>input</code> or <code>blur</code> events</td>
</tr>
<tr>
<td><strong>Server-side</strong></td>
<td>Final authority</td>
<td>Always validate on server, return errors</td>
</tr>
<tr>
<td><strong>Schema validation</strong></td>
<td>Complex forms</td>
<td>Use libraries like Zod, Yup, or JSON Schema</td>
</tr>
</tbody>
</table>
<h3 data-number="6.3.1" id="validation-example"><span
class="header-section-number">6.3.1</span> Validation Example</h3>
<div class="sourceCode" id="cb55"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">validateEmail</span>(email) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pattern <span class="op">=</span> <span class="ss">/</span><span class="sc">^[^\s@]+</span><span class="ss">@</span><span class="sc">[^\s@]+\.[^\s@]+$</span><span class="ss">/</span><span class="op">;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> pattern<span class="op">.</span><span class="fu">test</span>(email)<span class="op">;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="fu">handleInput</span>(<span class="bu">event</span>) {</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> email <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> isValid <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateEmail</span>(email)<span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> errorEl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.email-error&#39;</span>)<span class="op">;</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  errorEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> isValid <span class="op">?</span> <span class="st">&#39;&#39;</span> <span class="op">:</span> <span class="st">&#39;Invalid email format&#39;</span><span class="op">;</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  errorEl<span class="op">.</span><span class="at">hidden</span> <span class="op">=</span> isValid<span class="op">;</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.4" id="common-patterns"><span
class="header-section-number">6.4</span> Common Patterns</h2>
<h3 data-number="6.4.1" id="pattern-1-two-way-data-binding"><span
class="header-section-number">6.4.1</span> Pattern 1: Two-Way Data
Binding</h3>
<div class="sourceCode" id="cb56"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> LarcComponent {</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">bio</span><span class="op">:</span> <span class="st">&#39;&#39;</span> }<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleInput</span>(field<span class="op">,</span> <span class="bu">event</span>) {</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span>[field] <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updatePreview</span>()<span class="op">;</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;text&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot; </span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="vs">               oninput=&quot;this.handleInput(&#39;name&#39;, event)&quot;&gt;</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;textarea oninput=&quot;this.handleInput(&#39;bio&#39;, event)&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">bio</span><span class="sc">}</span><span class="vs">&lt;/textarea&gt;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;preview&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">bio</span> <span class="op">||</span> <span class="st">&#39;No bio&#39;</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="6.4.2" id="pattern-2-file-upload"><span
class="header-section-number">6.4.2</span> Pattern 2: File Upload</h3>
<div class="sourceCode" id="cb57"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">handleFileUpload</span>(<span class="bu">event</span>) {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>file) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  formData<span class="op">.</span><span class="fu">append</span>(<span class="st">&#39;file&#39;</span><span class="op">,</span> file)<span class="op">;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/upload&#39;</span><span class="op">,</span> {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> formData</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleUploadSuccess</span>(result)<span class="op">;</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Upload failed&#39;</span>)<span class="op">;</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="6.4.3" id="pattern-3-schema-driven-validation"><span
class="header-section-number">6.4.3</span> Pattern 3: Schema-Driven
Validation</h3>
<div class="sourceCode" id="cb58"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { z } <span class="im">from</span> <span class="st">&#39;zod&#39;</span><span class="op">;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userSchema <span class="op">=</span> z<span class="op">.</span><span class="fu">object</span>({</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">email</span>()<span class="op">,</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">password</span><span class="op">:</span> z<span class="op">.</span><span class="fu">string</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">8</span>)<span class="op">,</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">age</span><span class="op">:</span> z<span class="op">.</span><span class="fu">number</span>()<span class="op">.</span><span class="fu">min</span>(<span class="dv">13</span>)<span class="op">.</span><span class="fu">max</span>(<span class="dv">120</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">handleSubmit</span>(<span class="bu">event</span>) {</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> {</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;email&#39;</span>)<span class="op">,</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">password</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;password&#39;</span>)<span class="op">,</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">age</span><span class="op">:</span> <span class="pp">parseInt</span>(formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;age&#39;</span>))</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validated <span class="op">=</span> userSchema<span class="op">.</span><span class="fu">parse</span>(data)<span class="op">;</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">submitForm</span>(validated)<span class="op">;</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">displayValidationErrors</span>(err<span class="op">.</span><span class="at">errors</span>)<span class="op">;</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.5" id="input-types-reference"><span
class="header-section-number">6.5</span> Input Types Reference</h2>
<table>
<thead>
<tr>
<th>Type</th>
<th>Use Case</th>
<th>Validation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>text</code></td>
<td>General text input</td>
<td><code>pattern</code>, <code>minlength</code>,
<code>maxlength</code></td>
</tr>
<tr>
<td><code>email</code></td>
<td>Email addresses</td>
<td>Built-in email validation</td>
</tr>
<tr>
<td><code>password</code></td>
<td>Passwords</td>
<td><code>minlength</code>, autocomplete hints</td>
</tr>
<tr>
<td><code>number</code></td>
<td>Numeric input</td>
<td><code>min</code>, <code>max</code>, <code>step</code></td>
</tr>
<tr>
<td><code>tel</code></td>
<td>Phone numbers</td>
<td><code>pattern</code> for format</td>
</tr>
<tr>
<td><code>url</code></td>
<td>URLs</td>
<td>Built-in URL validation</td>
</tr>
<tr>
<td><code>date</code></td>
<td>Dates</td>
<td><code>min</code>, <code>max</code> for range</td>
</tr>
<tr>
<td><code>file</code></td>
<td>File upload</td>
<td><code>accept</code> for file types</td>
</tr>
<tr>
<td><code>checkbox</code></td>
<td>Boolean choice</td>
<td>Check <code>.checked</code> property</td>
</tr>
<tr>
<td><code>radio</code></td>
<td>Single choice</td>
<td>Group by <code>name</code> attribute</td>
</tr>
<tr>
<td><code>select</code></td>
<td>Dropdown choice</td>
<td>Multiple with <code>multiple</code> attribute</td>
</tr>
</tbody>
</table>
<h2 data-number="6.6" id="error-display-patterns"><span
class="header-section-number">6.6</span> Error Display Patterns</h2>
<h3 data-number="6.6.1" id="inline-errors"><span
class="header-section-number">6.6.1</span> Inline Errors</h3>
<div class="sourceCode" id="cb59"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">template</span>() {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot;&gt;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span class=&quot;error&quot; ?hidden=&quot;</span><span class="sc">${</span><span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/span&gt;</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="6.6.2" id="summary-errors"><span
class="header-section-number">6.6.2</span> Summary Errors</h3>
<div class="sourceCode" id="cb60"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">template</span>() {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;error-summary&quot;&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;Please fix the following errors:&lt;/h3&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;ul&gt;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="fu">map</span>(err <span class="kw">=&gt;</span> <span class="vs">`&lt;li&gt;</span><span class="sc">${</span>err<span class="sc">}</span><span class="vs">&lt;/li&gt;`</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/ul&gt;</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;form&gt;...&lt;/form&gt;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.7" id="component-reference-2"><span
class="header-section-number">6.7</span> Component Reference</h2>
<ul>
<li><strong>pan-files</strong>: File upload component - See Chapter
19</li>
<li><strong>pan-markdown-editor</strong>: Rich text editing - See
Chapter 19</li>
</ul>
<h2 data-number="6.8" id="complete-example-registration-form"><span
class="header-section-number">6.8</span> Complete Example: Registration
Form</h2>
<div class="sourceCode" id="cb61"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RegistrationForm <span class="kw">extends</span> LarcComponent {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate</span>(data) {</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>data<span class="op">.</span><span class="at">email</span> <span class="op">||</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">validateEmail</span>(data<span class="op">.</span><span class="at">email</span>)) {</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">email</span> <span class="op">=</span> <span class="st">&#39;Valid email required&#39;</span><span class="op">;</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>data<span class="op">.</span><span class="at">password</span> <span class="op">||</span> data<span class="op">.</span><span class="at">password</span><span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">8</span>) {</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">password</span> <span class="op">=</span> <span class="st">&#39;Password must be at least 8 characters&#39;</span><span class="op">;</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">password</span> <span class="op">!==</span> data<span class="op">.</span><span class="at">confirmPassword</span>) {</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">confirmPassword</span> <span class="op">=</span> <span class="st">&#39;Passwords must match&#39;</span><span class="op">;</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(errors)<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> errors<span class="op">;</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(<span class="bu">event</span>) {</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">event</span><span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(<span class="bu">event</span><span class="op">.</span><span class="at">target</span>)<span class="op">;</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> {</span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;email&#39;</span>)<span class="op">,</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">password</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;password&#39;</span>)<span class="op">,</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">confirmPassword</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;confirmPassword&#39;</span>)<span class="op">,</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">terms</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;terms&#39;</span>) <span class="op">===</span> <span class="st">&#39;on&#39;</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Client-side validation</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validationErrors <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validate</span>(data)<span class="op">;</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (validationErrors) {</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> validationErrors<span class="op">;</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Submit to server</span></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/register&#39;</span><span class="op">,</span> {</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">email</span><span class="op">:</span> data<span class="op">.</span><span class="at">email</span><span class="op">,</span> <span class="dt">password</span><span class="op">:</span> data<span class="op">.</span><span class="at">password</span> })</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">navigate</span>(<span class="st">&#39;/welcome&#39;</span>)<span class="op">;</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> { <span class="dt">general</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }<span class="op">;</span></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> { <span class="dt">general</span><span class="op">:</span> <span class="st">&#39;Network error. Please try again.&#39;</span> }<span class="op">;</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form class=&quot;registration-form&quot; onsubmit=&quot;this.handleSubmit(event)&quot;&gt;</span></span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h2&gt;Create Account&lt;/h2&gt;</span></span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">general</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;error-banner&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">general</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span></span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; required&gt;</span></span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span> <span class="op">?</span> <span class="vs">`&lt;span class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/span&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; id=&quot;password&quot; name=&quot;password&quot; required&gt;</span></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">password</span> <span class="op">?</span> <span class="vs">`&lt;span class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">password</span><span class="sc">}</span><span class="vs">&lt;/span&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;confirmPassword&quot;&gt;Confirm Password&lt;/label&gt;</span></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; id=&quot;confirmPassword&quot; name=&quot;confirmPassword&quot; required&gt;</span></span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">confirmPassword</span> <span class="op">?</span> <span class="vs">`&lt;span class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">confirmPassword</span><span class="sc">}</span><span class="vs">&lt;/span&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label&gt;</span></span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;checkbox&quot; name=&quot;terms&quot; required&gt;</span></span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a><span class="vs">            I agree to the Terms of Service</span></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/label&gt;</span></span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; ?disabled=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;Creating account...&#39;</span> <span class="op">:</span> <span class="st">&#39;Sign Up&#39;</span><span class="sc">}</span></span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;registration-form&#39;</span><span class="op">,</span> RegistrationForm)<span class="op">;</span></span></code></pre></div>
<h2 data-number="6.9" id="cross-references-3"><span
class="header-section-number">6.9</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 10 (Forms
and User Input)</li>
<li><strong>Components</strong>: Chapter 19 (pan-files,
pan-markdown-editor)</li>
<li><strong>Patterns</strong>: Appendix E (Form Patterns)</li>
<li><strong>Related</strong>: Chapter 4 (State Management), Chapter 14
(Error Handling)</li>
</ul>
<h2 data-number="6.10" id="common-issues-3"><span
class="header-section-number">6.10</span> Common Issues</h2>
<h3 data-number="6.10.1" id="issue-form-submits-on-enter-key"><span
class="header-section-number">6.10.1</span> Issue: Form submits on Enter
key</h3>
<p><strong>Problem</strong>: Single-line inputs trigger form submission
<strong>Solution</strong>: Use <code>onsubmit</code> handler with
<code>preventDefault()</code>, not button click handlers</p>
<h3 data-number="6.10.2"
id="issue-formdata-missing-checkbox-values"><span
class="header-section-number">6.10.2</span> Issue: FormData missing
checkbox values</h3>
<p><strong>Problem</strong>: Unchecked checkboxes don’t appear in
FormData <strong>Solution</strong>: Check for <code>null</code> or use
<code>.get('field') === 'on'</code> pattern</p>
<h3 data-number="6.10.3"
id="issue-file-upload-fails-with-large-files"><span
class="header-section-number">6.10.3</span> Issue: File upload fails
with large files</h3>
<p><strong>Problem</strong>: Request timeout or server rejects large
payloads <strong>Solution</strong>: Implement chunked upload or use
signed URLs for direct S3 upload</p>
<h3 data-number="6.10.4" id="issue-validation-errors-not-clearing"><span
class="header-section-number">6.10.4</span> Issue: Validation errors not
clearing</h3>
<p><strong>Problem</strong>: Error messages persist after fixing input
<strong>Solution</strong>: Clear errors object before revalidation, or
validate on input event</p>
<h3 data-number="6.10.5"
id="issue-password-managers-not-filling-forms"><span
class="header-section-number">6.10.5</span> Issue: Password managers not
filling forms</h3>
<p><strong>Problem</strong>: Autocomplete not working correctly
<strong>Solution</strong>: Use proper <code>autocomplete</code>
attributes (<code>email</code>, <code>current-password</code>,
<code>new-password</code>)</p>
<p>See <em>Learning LARC</em> Chapter 10 for detailed form patterns and
advanced validation strategies.</p>
<h1 data-number="7" id="data-fetching-and-apis"><span
class="header-section-number">7</span> Data Fetching and APIs</h1>
<p>Quick reference for API integration and data fetching in LARC
applications. For detailed tutorials, see <em>Learning LARC</em> Chapter
11.</p>
<h2 data-number="7.1" id="overview-3"><span
class="header-section-number">7.1</span> Overview</h2>
<p>Modern web applications fetch data from APIs using REST, GraphQL, or
WebSockets. LARC provides components and patterns for handling async
data loading, caching, error recovery, and real-time updates.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>REST APIs: Standard HTTP methods (GET, POST, PUT, DELETE)</li>
<li>GraphQL: Query-based data fetching with precise field selection</li>
<li>Error handling: Retry logic, fallbacks, user feedback</li>
<li>Caching strategies: In-memory, localStorage, IndexedDB</li>
<li>Loading states: Skeleton screens, spinners, optimistic updates</li>
</ul>
<h2 data-number="7.2" id="quick-example-3"><span
class="header-section-number">7.2</span> Quick Example</h2>
<div class="sourceCode" id="cb62"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductList <span class="kw">extends</span> LarcComponent {</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadProducts</span>()<span class="op">;</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadProducts</span>() {</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/products&#39;</span>)<span class="op">;</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to load products&#39;</span>)<span class="op">;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> err<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">loading</span>) <span class="cf">return</span> <span class="st">&#39;&lt;div class=&quot;spinner&quot;&gt;Loading...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">error</span>) <span class="cf">return</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;product-list&quot;&gt;</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;product-card&quot;&gt;</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;h3&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;p&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">price</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.3" id="rest-api-patterns"><span
class="header-section-number">7.3</span> REST API Patterns</h2>
<table>
<thead>
<tr>
<th>HTTP Method</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Fetch data</td>
<td><code>GET /api/products?category=electronics</code></td>
</tr>
<tr>
<td>POST</td>
<td>Create resource</td>
<td><code>POST /api/products</code> + body</td>
</tr>
<tr>
<td>PUT</td>
<td>Replace resource</td>
<td><code>PUT /api/products/123</code> + body</td>
</tr>
<tr>
<td>PATCH</td>
<td>Update fields</td>
<td><code>PATCH /api/products/123</code> + partial body</td>
</tr>
<tr>
<td>DELETE</td>
<td>Remove resource</td>
<td><code>DELETE /api/products/123</code></td>
</tr>
</tbody>
</table>
<h3 data-number="7.3.1" id="rest-example-with-error-handling"><span
class="header-section-number">7.3.1</span> REST Example with Error
Handling</h3>
<div class="sourceCode" id="cb63"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">createProduct</span>(data) {</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/products&#39;</span><span class="op">,</span> {</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(error<span class="op">.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Failed to create product&#39;</span>)<span class="op">;</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Create product failed:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.4" id="graphql-integration"><span
class="header-section-number">7.4</span> GraphQL Integration</h2>
<h3 data-number="7.4.1" id="basic-query"><span
class="header-section-number">7.4.1</span> Basic Query</h3>
<div class="sourceCode" id="cb64"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">fetchUser</span>(userId) {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    query GetUser($id: ID!) {</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      user(id: $id) {</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        id</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        name</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        email</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        posts {</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          id</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          title</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    }</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/graphql&#39;</span><span class="op">,</span> {</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>      query<span class="op">,</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">variables</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> userId }</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (result<span class="op">.</span><span class="at">errors</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(result<span class="op">.</span><span class="at">errors</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">user</span><span class="op">;</span></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="7.4.2" id="mutation-example"><span
class="header-section-number">7.4.2</span> Mutation Example</h3>
<div class="sourceCode" id="cb65"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">updateUser</span>(userId<span class="op">,</span> updates) {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mutation <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    mutation UpdateUser($id: ID!, $input: UserInput!) {</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      updateUser(id: $id, input: $input) {</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        id</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        name</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        email</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    }</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/graphql&#39;</span><span class="op">,</span> {</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">query</span><span class="op">:</span> mutation<span class="op">,</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">variables</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> userId<span class="op">,</span> <span class="dt">input</span><span class="op">:</span> updates }</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (result<span class="op">.</span><span class="at">errors</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(result<span class="op">.</span><span class="at">errors</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">updateUser</span><span class="op">;</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.5" id="caching-strategies"><span
class="header-section-number">7.5</span> Caching Strategies</h2>
<table style="width:100%;">
<colgroup>
<col style="width: 28%" />
<col style="width: 42%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>Implementation</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>In-memory</strong></td>
<td>Store in component property</td>
<td>Session-only data</td>
</tr>
<tr>
<td><strong>localStorage</strong></td>
<td><code>localStorage.setItem()</code></td>
<td>Small datasets, settings</td>
</tr>
<tr>
<td><strong>IndexedDB</strong></td>
<td><code>pan-idb</code> component</td>
<td>Large datasets, offline support</td>
</tr>
<tr>
<td><strong>HTTP cache</strong></td>
<td><code>Cache-Control</code> headers</td>
<td>Static assets, CDN content</td>
</tr>
<tr>
<td><strong>Stale-while-revalidate</strong></td>
<td>Show cached + fetch fresh</td>
<td>Balance speed + freshness</td>
</tr>
</tbody>
</table>
<h3 data-number="7.5.1" id="stale-while-revalidate-pattern"><span
class="header-section-number">7.5.1</span> Stale-While-Revalidate
Pattern</h3>
<div class="sourceCode" id="cb66"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">loadProducts</span>() {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show cached data immediately</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getCache</span>(<span class="st">&#39;products&#39;</span>)<span class="op">;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cached) {</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> cached<span class="op">;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fetch fresh data in background</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/products&#39;</span>)<span class="op">;</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fresh <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> fresh<span class="op">;</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setCache</span>(<span class="st">&#39;products&#39;</span><span class="op">,</span> fresh<span class="op">,</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span> <span class="co">// 5 min TTL</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep showing cached data on error</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>cached) {</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> err<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="fu">getCache</span>(key) {</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> item <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="vs">`cache:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>item) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { data<span class="op">,</span> expires } <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(item)<span class="op">;</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">&gt;</span> expires) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="fu">setCache</span>(key<span class="op">,</span> data<span class="op">,</span> ttl) {</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>  localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="vs">`cache:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>    data<span class="op">,</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">expires</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> ttl</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.6" id="error-recovery-patterns"><span
class="header-section-number">7.6</span> Error Recovery Patterns</h2>
<h3 data-number="7.6.1" id="retry-with-exponential-backoff"><span
class="header-section-number">7.6.1</span> Retry with Exponential
Backoff</h3>
<div class="sourceCode" id="cb67"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">fetchWithRetry</span>(url<span class="op">,</span> options <span class="op">=</span> {}<span class="op">,</span> maxRetries <span class="op">=</span> <span class="dv">3</span>) {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> maxRetries<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) <span class="cf">return</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">500</span> <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> maxRetries <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Retry on server errors</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> i) <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 1s, 2s, 4s</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> delay))<span class="op">;</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`HTTP </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="op">===</span> maxRetries <span class="op">-</span> <span class="dv">1</span>) <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> i) <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> delay))<span class="op">;</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="7.6.2" id="fallback-data"><span
class="header-section-number">7.6.2</span> Fallback Data</h3>
<div class="sourceCode" id="cb68"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">loadProducts</span>() {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/products&#39;</span>)<span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;API failed, using fallback data:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getFallbackProducts</span>()<span class="op">;</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="fu">getFallbackProducts</span>() {</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Product 1&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="fl">19.99</span> }<span class="op">,</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Product 2&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="fl">29.99</span> }</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.7" id="loading-states"><span
class="header-section-number">7.7</span> Loading States</h2>
<h3 data-number="7.7.1" id="skeleton-screens"><span
class="header-section-number">7.7.1</span> Skeleton Screens</h3>
<div class="sourceCode" id="cb69"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">template</span>() {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">loading</span>) {</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;product-list&quot;&gt;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="bu">Array</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">map</span>(() <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;product-card skeleton&quot;&gt;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;skeleton-title&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;skeleton-text&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;skeleton-price&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderProducts</span>()<span class="op">;</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="7.7.2" id="progressive-loading"><span
class="header-section-number">7.7.2</span> Progressive Loading</h3>
<div class="sourceCode" id="cb70"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Load critical data first</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadSummary</span>()<span class="op">;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Load details in background</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadDetails</span>()<span class="op">;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.8" id="component-reference-3"><span
class="header-section-number">7.8</span> Component Reference</h2>
<ul>
<li><strong>pan-data-connector</strong>: REST API integration - See
Chapter 20</li>
<li><strong>pan-graphql-connector</strong>: GraphQL integration - See
Chapter 20</li>
<li><strong>pan-websocket</strong>: WebSocket connection management -
See Chapter 20</li>
<li><strong>pan-idb</strong>: IndexedDB caching - See Chapter 18</li>
</ul>
<h2 data-number="7.9"
id="complete-example-product-search-with-caching"><span
class="header-section-number">7.9</span> Complete Example: Product
Search with Caching</h2>
<div class="sourceCode" id="cb71"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductSearch <span class="kw">extends</span> LarcComponent {</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">searchTerm</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load cached results</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getCache</span>(<span class="st">&#39;products-all&#39;</span>)<span class="op">;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached) {</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> cached<span class="op">;</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fetch fresh data</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadProducts</span>()<span class="op">;</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadProducts</span>(search <span class="op">=</span> <span class="st">&#39;&#39;</span>) {</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> url <span class="op">=</span> search</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">?</span> <span class="vs">`/api/products/search?q=</span><span class="sc">${</span><span class="pp">encodeURIComponent</span>(search)<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span> <span class="st">&#39;/api/products&#39;</span><span class="op">;</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url)<span class="op">;</span></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Search failed&#39;</span>)<span class="op">;</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Cache full product list only</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>search) {</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setCache</span>(<span class="st">&#39;products-all&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">,</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> err<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleSearchInput</span>(<span class="bu">event</span>) {</span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">searchTerm</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounce search</span></span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span>)<span class="op">;</span></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadProducts</span>(<span class="kw">this</span><span class="op">.</span><span class="at">searchTerm</span>)<span class="op">;</span></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCache</span>(key) {</span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> item <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="vs">`cache:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>item) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { data<span class="op">,</span> expires } <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(item)<span class="op">;</span></span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">&lt;</span> expires <span class="op">?</span> data <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setCache</span>(key<span class="op">,</span> data<span class="op">,</span> ttl) {</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="vs">`cache:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a>      <span class="dt">expires</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> ttl</span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">template</span>() {</span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;product-search&quot;&gt;</span></span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input</span></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a><span class="vs">          type=&quot;search&quot;</span></span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          placeholder=&quot;Search products...&quot;</span></span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">searchTerm</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          oninput=&quot;this.handleSearchInput(event)&quot;&gt;</span></span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;&lt;div class=&quot;spinner&quot;&gt;Searching...&lt;/div&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;product-grid&quot;&gt;</span></span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">map</span>(product <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;product-card&quot;&gt;</span></span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;img src=&quot;</span><span class="sc">${</span>product<span class="op">.</span><span class="at">image</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span>product<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;h3&gt;</span><span class="sc">${</span>product<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;p class=&quot;price&quot;&gt;$</span><span class="sc">${</span>product<span class="op">.</span><span class="at">price</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;button onclick=&quot;addToCart(</span><span class="sc">${</span>product<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;Add to Cart&lt;/button&gt;</span></span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb71-97"><a href="#cb71-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-98"><a href="#cb71-98" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;</span></span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span>div <span class="kw">class</span><span class="op">=</span><span class="st">&quot;no-results&quot;</span><span class="op">&gt;</span>No products found<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39; : &#39;&#39;}</span></span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a>    <span class="vs">`;</span></span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a><span class="vs">  }</span></span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a><span class="vs">}</span></span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a><span class="vs">customElements.define(&#39;product-search&#39;, ProductSearch);</span></span></code></pre></div>
<h2 data-number="7.10" id="cross-references-4"><span
class="header-section-number">7.10</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 11 (Data
Fetching and APIs)</li>
<li><strong>Components</strong>: Chapter 20 (pan-data-connector,
pan-graphql-connector, pan-websocket)</li>
<li><strong>Patterns</strong>: Appendix E (API Integration
Patterns)</li>
<li><strong>Related</strong>: Chapter 4 (State Management), Chapter 9
(Realtime Features)</li>
</ul>
<h2 data-number="7.11" id="common-issues-4"><span
class="header-section-number">7.11</span> Common Issues</h2>
<h3 data-number="7.11.1" id="issue-cors-errors-in-development"><span
class="header-section-number">7.11.1</span> Issue: CORS errors in
development</h3>
<p><strong>Problem</strong>: <code>Access-Control-Allow-Origin</code>
errors <strong>Solution</strong>: Configure dev server proxy or add CORS
headers to API</p>
<h3 data-number="7.11.2" id="issue-stale-cache-data"><span
class="header-section-number">7.11.2</span> Issue: Stale cache data</h3>
<p><strong>Problem</strong>: Users see outdated information
<strong>Solution</strong>: Implement cache invalidation with TTL,
version keys, or manual clear</p>
<h3 data-number="7.11.3" id="issue-request-waterfall"><span
class="header-section-number">7.11.3</span> Issue: Request
waterfall</h3>
<p><strong>Problem</strong>: Sequential requests slow down page load
<strong>Solution</strong>: Batch requests, use GraphQL, or fetch data in
parallel</p>
<h3 data-number="7.11.4"
id="issue-memory-leaks-from-pending-requests"><span
class="header-section-number">7.11.4</span> Issue: Memory leaks from
pending requests</h3>
<p><strong>Problem</strong>: Component unmounts but fetch continues
<strong>Solution</strong>: Use AbortController to cancel requests in
<code>disconnectedCallback()</code></p>
<h3 data-number="7.11.5" id="issue-authentication-tokens-expired"><span
class="header-section-number">7.11.5</span> Issue: Authentication tokens
expired</h3>
<p><strong>Problem</strong>: 401 errors on API calls
<strong>Solution</strong>: Implement token refresh interceptor before
retrying failed requests</p>
<p>See <em>Learning LARC</em> Chapter 11 for detailed API patterns,
authentication flows, and advanced caching strategies.</p>
<h1 data-number="8" id="authentication-and-authorization"><span
class="header-section-number">8</span> Authentication and
Authorization</h1>
<p>Quick reference for authentication and authorization patterns in LARC
applications. For detailed tutorials, see <em>Learning LARC</em> Chapter
12.</p>
<h2 data-number="8.1" id="overview-4"><span
class="header-section-number">8.1</span> Overview</h2>
<p>Authentication verifies user identity (“who are you?”) while
authorization determines permissions (“what can you do?”). LARC
applications typically use JWT tokens for authentication and role-based
access control (RBAC) for authorization.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>JWT tokens: Cryptographically signed identity tokens with
claims</li>
<li>Token refresh: Automatic renewal before expiry</li>
<li>Protected routes: Enforce authentication/authorization
requirements</li>
<li>RBAC: Role-based permission system with inheritance</li>
<li>Session management: Timeout, activity tracking, secure storage</li>
</ul>
<h2 data-number="8.2" id="quick-example-4"><span
class="header-section-number">8.2</span> Quick Example</h2>
<div class="sourceCode" id="cb72"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize authentication</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { authService } <span class="im">from</span> <span class="st">&#39;./services/auth.js&#39;</span><span class="op">;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> authService<span class="op">.</span><span class="fu">initialize</span>()<span class="op">;</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (authService<span class="op">.</span><span class="fu">getState</span>()<span class="op">.</span><span class="at">isAuthenticated</span>) {</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// User logged in</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User:&#39;</span><span class="op">,</span> authService<span class="op">.</span><span class="fu">getState</span>()<span class="op">.</span><span class="at">user</span>)<span class="op">;</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Redirect to login</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/login&#39;</span><span class="op">;</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Login</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> success <span class="op">=</span> <span class="cf">await</span> authService<span class="op">.</span><span class="fu">login</span>({</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">username</span><span class="op">:</span> <span class="st">&#39;alice&#39;</span><span class="op">,</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;secret123&#39;</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Check permissions</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (authService<span class="op">.</span><span class="fu">hasRole</span>(<span class="st">&#39;admin&#39;</span>)) {</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Show admin features</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.3" id="authentication-service-api"><span
class="header-section-number">8.3</span> Authentication Service API</h2>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>initialize()</code></td>
<td>-</td>
<td>Promise&lt;boolean&gt;</td>
<td>Load stored tokens, verify, auto-refresh if needed</td>
</tr>
<tr>
<td><code>login(credentials)</code></td>
<td>{username, password}</td>
<td>Promise&lt;boolean&gt;</td>
<td>Authenticate and store tokens</td>
</tr>
<tr>
<td><code>logout()</code></td>
<td>-</td>
<td>void</td>
<td>Clear tokens and state</td>
</tr>
<tr>
<td><code>getState()</code></td>
<td>-</td>
<td>AuthState</td>
<td>Get current authentication state</td>
</tr>
<tr>
<td><code>getAccessToken()</code></td>
<td>-</td>
<td>string|null</td>
<td>Get token for API requests</td>
</tr>
<tr>
<td><code>hasRole(role)</code></td>
<td>role: string</td>
<td>boolean</td>
<td>Check if user has role</td>
</tr>
<tr>
<td><code>hasPermission(perm)</code></td>
<td>permission: string</td>
<td>boolean</td>
<td>Check if user has permission</td>
</tr>
</tbody>
</table>
<h3 data-number="8.3.1" id="authstate-interface"><span
class="header-section-number">8.3.1</span> AuthState Interface</h3>
<div class="sourceCode" id="cb73"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> AuthState {</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  isAuthenticated<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  user<span class="op">:</span> UserClaims <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  tokens<span class="op">:</span> AuthTokens <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> UserClaims {</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  userId<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  username<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  roles<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  permissions<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> AuthTokens {</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  accessToken<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  refreshToken<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>  expiresIn<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.4" id="api-interceptor-pattern"><span
class="header-section-number">8.4</span> API Interceptor Pattern</h2>
<p>Automatically add authentication headers to requests:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add bearer token to requests</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>api<span class="op">.</span><span class="at">interceptors</span><span class="op">.</span><span class="at">request</span><span class="op">.</span><span class="fu">use</span>(<span class="kw">async</span> (config) <span class="kw">=&gt;</span> {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> authService<span class="op">.</span><span class="fu">getAccessToken</span>()<span class="op">;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (token) {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">Authorization</span> <span class="op">=</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> config<span class="op">;</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle 401 by refreshing token</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>api<span class="op">.</span><span class="at">interceptors</span><span class="op">.</span><span class="at">response</span><span class="op">.</span><span class="fu">use</span>(</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  (response) <span class="kw">=&gt;</span> response<span class="op">,</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> (error) <span class="kw">=&gt;</span> {</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">response</span><span class="op">?.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">401</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>error<span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="at">_retry</span>) {</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>      error<span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="at">_retry</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> authService<span class="op">.</span><span class="fu">refreshAccessToken</span>()<span class="op">;</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> newToken <span class="op">=</span> authService<span class="op">.</span><span class="fu">getAccessToken</span>()<span class="op">;</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>      error<span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">Authorization</span> <span class="op">=</span> <span class="vs">`Bearer </span><span class="sc">${</span>newToken<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">api</span>(error<span class="op">.</span><span class="at">config</span>)<span class="op">;</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">reject</span>(error)<span class="op">;</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.5" id="protected-routes"><span
class="header-section-number">8.5</span> Protected Routes</h2>
<h3 data-number="8.5.1" id="route-guard-component"><span
class="header-section-number">8.5.1</span> Route Guard Component</h3>
<div class="sourceCode" id="cb75"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProtectedRoute <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> state <span class="op">=</span> authService<span class="op">.</span><span class="fu">getState</span>()<span class="op">;</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>state<span class="op">.</span><span class="at">isAuthenticated</span>) {</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> redirect <span class="op">=</span> <span class="pp">encodeURIComponent</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="vs">`/login?redirect=</span><span class="sc">${</span>redirect<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check roles</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> requiredRoles <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;roles&#39;</span>)<span class="op">?.</span><span class="fu">split</span>(<span class="st">&#39;,&#39;</span>) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (requiredRoles<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> hasRole <span class="op">=</span> requiredRoles<span class="op">.</span><span class="fu">some</span>(r <span class="kw">=&gt;</span> authService<span class="op">.</span><span class="fu">hasRole</span>(r))<span class="op">;</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>hasRole) {</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/forbidden&#39;</span><span class="op">;</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;protected-route&#39;</span><span class="op">,</span> ProtectedRoute)<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.5.2" id="usage"><span
class="header-section-number">8.5.2</span> Usage</h3>
<div class="sourceCode" id="cb76"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Public route --&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;home-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">route</span><span class="dt">&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Requires authentication --&gt;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/dashboard&quot;</span><span class="dt">&gt;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">protected-route</span><span class="dt">&gt;</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">dashboard-page</span><span class="dt">&gt;&lt;/</span><span class="kw">dashboard-page</span><span class="dt">&gt;</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">protected-route</span><span class="dt">&gt;</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">route</span><span class="dt">&gt;</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Requires admin role --&gt;</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/admin&quot;</span><span class="dt">&gt;</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">protected-route</span><span class="ot"> roles</span><span class="op">=</span><span class="st">&quot;admin&quot;</span><span class="dt">&gt;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">admin-panel</span><span class="dt">&gt;&lt;/</span><span class="kw">admin-panel</span><span class="dt">&gt;</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">protected-route</span><span class="dt">&gt;</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">route</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="8.6" id="role-based-access-control"><span
class="header-section-number">8.6</span> Role-Based Access Control</h2>
<h3 data-number="8.6.1" id="rbac-configuration"><span
class="header-section-number">8.6.1</span> RBAC Configuration</h3>
<div class="sourceCode" id="cb77"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ROLES <span class="op">=</span> {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">guest</span><span class="op">:</span> {</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;guest&#39;</span><span class="op">,</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">permissions</span><span class="op">:</span> [</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;content&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;public&#39;</span> }</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> {</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;user&#39;</span><span class="op">,</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inherits</span><span class="op">:</span> [<span class="st">&#39;guest&#39;</span>]<span class="op">,</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">permissions</span><span class="op">:</span> [</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;profile&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;own&#39;</span> }<span class="op">,</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;profile&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;update&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;own&#39;</span> }<span class="op">,</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;content&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;own&#39;</span> }</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">moderator</span><span class="op">:</span> {</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;moderator&#39;</span><span class="op">,</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inherits</span><span class="op">:</span> [<span class="st">&#39;user&#39;</span>]<span class="op">,</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">permissions</span><span class="op">:</span> [</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;content&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;update&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;all&#39;</span> }<span class="op">,</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;content&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;delete&#39;</span><span class="op">,</span> <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;all&#39;</span> }</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">admin</span><span class="op">:</span> {</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;admin&#39;</span><span class="op">,</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">inherits</span><span class="op">:</span> [<span class="st">&#39;moderator&#39;</span>]<span class="op">,</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">permissions</span><span class="op">:</span> [</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;users&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;create&#39;</span> }<span class="op">,</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;users&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;update&#39;</span> }<span class="op">,</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;users&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;delete&#39;</span> }<span class="op">,</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">resource</span><span class="op">:</span> <span class="st">&#39;settings&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;update&#39;</span> }</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.6.2" id="authorization-service-api"><span
class="header-section-number">8.6.2</span> Authorization Service
API</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getPermissions(roleId)</code></td>
<td>roleId: string</td>
<td>Permission[]</td>
<td>Get all permissions (including inherited)</td>
</tr>
<tr>
<td><code>hasPermission(roles, resource, action, scope?)</code></td>
<td>roles: string[], resource: string, action: string, scope?:
string</td>
<td>boolean</td>
<td>Check if any role has permission</td>
</tr>
<tr>
<td><code>canAccess(roles, resource, action, ownerId?, userId?)</code></td>
<td>roles: string[], resource: string, action: string, ownerId?: string,
userId?: string</td>
<td>boolean</td>
<td>Check access with ownership</td>
</tr>
</tbody>
</table>
<h3 data-number="8.6.3" id="conditional-rendering"><span
class="header-section-number">8.6.3</span> Conditional Rendering</h3>
<div class="sourceCode" id="cb78"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthorizedContent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> resource <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;resource&#39;</span>)<span class="op">;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> action <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;action&#39;</span>)<span class="op">;</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> state <span class="op">=</span> authService<span class="op">.</span><span class="fu">getState</span>()<span class="op">;</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> authorized <span class="op">=</span> state<span class="op">.</span><span class="at">user</span> <span class="op">&amp;&amp;</span> </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>      authz<span class="op">.</span><span class="fu">hasPermission</span>(state<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">roles</span><span class="op">,</span> resource<span class="op">,</span> action)<span class="op">;</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>authorized) {</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;authorized-content&#39;</span><span class="op">,</span> AuthorizedContent)<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.7" id="session-management"><span
class="header-section-number">8.7</span> Session Management</h2>
<h3 data-number="8.7.1" id="session-timeout"><span
class="header-section-number">8.7.1</span> Session Timeout</h3>
<div class="sourceCode" id="cb79"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionManager {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(timeoutMinutes<span class="op">,</span> warningMinutes) {</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">timeoutMinutes</span> <span class="op">=</span> timeoutMinutes<span class="op">;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">warningMinutes</span> <span class="op">=</span> warningMinutes<span class="op">;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupActivityListeners</span>()<span class="op">;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">start</span>() {</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">resetTimeout</span>()<span class="op">;</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetTimeout</span>() {</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">timeoutId</span>)<span class="op">;</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">warningId</span>)<span class="op">;</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Warning before timeout</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> warningMs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">warningMinutes</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">warningId</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showWarning</span>()<span class="op">;</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> warningMs)<span class="op">;</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Logout on timeout</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> timeoutMs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">timeoutMinutes</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">timeoutId</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>      authService<span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/login?reason=timeout&#39;</span><span class="op">;</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> timeoutMs)<span class="op">;</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupActivityListeners</span>() {</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>    [<span class="st">&#39;mousedown&#39;</span><span class="op">,</span> <span class="st">&#39;keydown&#39;</span><span class="op">,</span> <span class="st">&#39;scroll&#39;</span><span class="op">,</span> <span class="st">&#39;touchstart&#39;</span>]<span class="op">.</span><span class="fu">forEach</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="bu">event</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (authService<span class="op">.</span><span class="fu">getState</span>()<span class="op">.</span><span class="at">isAuthenticated</span>) {</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">resetTimeout</span>()<span class="op">;</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> { <span class="dt">passive</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize with 30-minute timeout</span></span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sessionManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">SessionManager</span>(<span class="dv">30</span><span class="op">,</span> <span class="dv">25</span>)<span class="op">;</span></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>sessionManager<span class="op">.</span><span class="fu">start</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.8" id="security-best-practices"><span
class="header-section-number">8.8</span> Security Best Practices</h2>
<h3 data-number="8.8.1" id="input-validation"><span
class="header-section-number">8.8.1</span> Input Validation</h3>
<div class="sourceCode" id="cb80"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> validators <span class="op">=</span> {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> (value) <span class="kw">=&gt;</span> <span class="ss">/</span><span class="sc">^[^\s@]+</span><span class="ss">@</span><span class="sc">[^\s@]+\.[^\s@]+$</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)<span class="op">,</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">password</span><span class="op">:</span> (value) <span class="kw">=&gt;</span> {</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">8</span>) errors<span class="op">.</span><span class="fu">push</span>(<span class="st">&#39;8+ characters required&#39;</span>)<span class="op">;</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">[A-Z]</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)) errors<span class="op">.</span><span class="fu">push</span>(<span class="st">&#39;Uppercase required&#39;</span>)<span class="op">;</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">[a-z]</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)) errors<span class="op">.</span><span class="fu">push</span>(<span class="st">&#39;Lowercase required&#39;</span>)<span class="op">;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">[0-9]</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)) errors<span class="op">.</span><span class="fu">push</span>(<span class="st">&#39;Number required&#39;</span>)<span class="op">;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">[^A-Za-z0-9]</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)) errors<span class="op">.</span><span class="fu">push</span>(<span class="st">&#39;Special char required&#39;</span>)<span class="op">;</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">valid</span><span class="op">:</span> errors<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span><span class="op">,</span> errors }<span class="op">;</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sanitize</span><span class="op">:</span> (value) <span class="kw">=&gt;</span> </span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    value<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">[&lt;&gt;]</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>         <span class="op">.</span><span class="fu">replace</span>(<span class="ss">/javascript:/gi</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>         <span class="op">.</span><span class="fu">trim</span>()</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.8.2" id="csrf-protection"><span
class="header-section-number">8.8.2</span> CSRF Protection</h3>
<div class="sourceCode" id="cb81"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CSRFProtection {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generateToken</span>() {</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">randomString</span>(<span class="dv">32</span>)<span class="op">;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;csrf-token&#39;</span><span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getToken</span>() {</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sessionStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;csrf-token&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addToHeaders</span>(headers) {</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>headers<span class="op">,</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;X-CSRF-Token&#39;</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getToken</span>()</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">randomString</span>(length) {</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chars <span class="op">=</span> <span class="st">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;</span><span class="op">;</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> array <span class="op">=</span> <span class="kw">new</span> <span class="bu">Uint8Array</span>(length)<span class="op">;</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    crypto<span class="op">.</span><span class="fu">getRandomValues</span>(array)<span class="op">;</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(array)<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> chars[x <span class="op">%</span> chars<span class="op">.</span><span class="at">length</span>])<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> csrf <span class="op">=</span> <span class="kw">new</span> <span class="fu">CSRFProtection</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.9" id="component-reference-4"><span
class="header-section-number">8.9</span> Component Reference</h2>
<p>See Chapter 20 for authentication-related components:</p>
<ul>
<li><strong>pan-auth</strong>: Complete authentication component</li>
<li><strong>pan-user-menu</strong>: User profile dropdown with
logout</li>
</ul>
<h2 data-number="8.10" id="complete-example-login-form"><span
class="header-section-number">8.10</span> Complete Example: Login
Form</h2>
<div class="sourceCode" id="cb82"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">username</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    csrf<span class="op">.</span><span class="fu">generateToken</span>()<span class="op">;</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(e) {</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> success <span class="op">=</span> <span class="cf">await</span> authService<span class="op">.</span><span class="fu">login</span>({</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">username</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">username</span><span class="op">,</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">password</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (success) {</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> redirect <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;redirect&#39;</span>) <span class="op">||</span> <span class="st">&#39;/dashboard&#39;</span><span class="op">;</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> redirect<span class="op">;</span></span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="st">&#39;Invalid credentials&#39;</span><span class="op">;</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="st">&#39;Login failed. Try again.&#39;</span><span class="op">;</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form class=&quot;login-form&quot;&gt;</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;label&gt;</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          Username</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input name=&quot;username&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">username</span><span class="sc">}</span><span class="vs">&quot; required&gt;</span></span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/label&gt;</span></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;label&gt;</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          Password</span></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; name=&quot;password&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span><span class="sc">}</span><span class="vs">&quot; required&gt;</span></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/label&gt;</span></span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;disabled&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&gt;</span></span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;Signing in...&#39;</span> <span class="op">:</span> <span class="st">&#39;Sign In&#39;</span><span class="sc">}</span></span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>(e))<span class="op">;</span></span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[name=&quot;username&quot;]&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">username</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[name=&quot;password&quot;]&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb82-69"><a href="#cb82-69" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb82-70"><a href="#cb82-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-71"><a href="#cb82-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-72"><a href="#cb82-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-73"><a href="#cb82-73" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;login-form&#39;</span><span class="op">,</span> LoginForm)<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.11" id="cross-references-5"><span
class="header-section-number">8.11</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 12
(Authentication and Authorization)</li>
<li><strong>Components</strong>: Chapter 20 (pan-auth,
pan-user-menu)</li>
<li><strong>Patterns</strong>: Appendix E (Security Patterns)</li>
<li><strong>Related</strong>: Chapter 7 (API Authentication), Chapter 9
(WebSocket Authentication)</li>
</ul>
<h2 data-number="8.12" id="common-issues-5"><span
class="header-section-number">8.12</span> Common Issues</h2>
<h3 data-number="8.12.1" id="issue-token-expires-during-request"><span
class="header-section-number">8.12.1</span> Issue: Token expires during
request</h3>
<p><strong>Problem</strong>: 401 errors on long-running requests
<strong>Solution</strong>: Refresh token before expiry (subtract 5
minutes from expiry time)</p>
<h3 data-number="8.12.2"
id="issue-lost-authentication-on-page-refresh"><span
class="header-section-number">8.12.2</span> Issue: Lost authentication
on page refresh</h3>
<p><strong>Problem</strong>: User logged out after reload
<strong>Solution</strong>: Call <code>authService.initialize()</code> on
app startup to restore session</p>
<h3 data-number="8.12.3" id="issue-infinite-redirect-loops"><span
class="header-section-number">8.12.3</span> Issue: Infinite redirect
loops</h3>
<p><strong>Problem</strong>: Protected route redirects to login, login
redirects to protected route <strong>Solution</strong>: Check
authentication before redirect; use redirect parameter correctly</p>
<h3 data-number="8.12.4" id="issue-cors-errors-with-credentials"><span
class="header-section-number">8.12.4</span> Issue: CORS errors with
credentials</h3>
<p><strong>Problem</strong>:
<code>Access-Control-Allow-Credentials</code> errors
<strong>Solution</strong>: Set <code>credentials: 'include'</code> in
fetch options, enable CORS on server</p>
<h3 data-number="8.12.5" id="issue-xss-attacks-via-stored-tokens"><span
class="header-section-number">8.12.5</span> Issue: XSS attacks via
stored tokens</h3>
<p><strong>Problem</strong>: Token accessible via JavaScript
<strong>Solution</strong>: Use httpOnly cookies for refresh tokens;
store access tokens in memory when possible</p>
<p>See <em>Learning LARC</em> Chapter 12 for complete authentication
flows, OAuth integration, and multi-factor authentication patterns.</p>
<h1 data-number="9" id="real-time-features"><span
class="header-section-number">9</span> Real-time Features</h1>
<p>Quick reference for real-time communication patterns in LARC
applications. For detailed tutorials, see <em>Learning LARC</em> Chapter
11.</p>
<h2 data-number="9.1" id="overview-5"><span
class="header-section-number">9.1</span> Overview</h2>
<p>Real-time features enable live data updates without page reloads
using WebSockets, Server-Sent Events (SSE), BroadcastChannel for
cross-tab sync, and Web Workers for background processing.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>WebSockets: Full-duplex bidirectional communication</li>
<li>SSE: One-way server-to-client streaming</li>
<li>BroadcastChannel: Cross-tab/window messaging</li>
<li>Web Workers: Background thread processing</li>
<li>Heartbeat: Keep-alive mechanism to detect disconnections</li>
<li>Reconnection: Automatic recovery from connection failures</li>
</ul>
<h2 data-number="9.2" id="quick-example-5"><span
class="header-section-number">9.2</span> Quick Example</h2>
<div class="sourceCode" id="cb83"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket connection</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { wsClient } <span class="im">from</span> <span class="st">&#39;./services/websocket-client.js&#39;</span><span class="op">;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> wsClient<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to events</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;New notification:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Send message</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;chat.message&#39;</span><span class="op">,</span> { <span class="dt">text</span><span class="op">:</span> <span class="st">&#39;Hello!&#39;</span> })<span class="op">;</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Check connection</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (wsClient<span class="op">.</span><span class="fu">isConnected</span>()) {</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Connected</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="9.3" id="websocket-client-api"><span
class="header-section-number">9.3</span> WebSocket Client API</h2>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect()</code></td>
<td>-</td>
<td>Promise&lt;void&gt;</td>
<td>Connect to WebSocket server</td>
</tr>
<tr>
<td><code>disconnect()</code></td>
<td>-</td>
<td>void</td>
<td>Close connection</td>
</tr>
<tr>
<td><code>send(type, payload)</code></td>
<td>type: string, payload: any</td>
<td>void</td>
<td>Send message to server</td>
</tr>
<tr>
<td><code>on(type, handler)</code></td>
<td>type: string, handler: Function</td>
<td>Function</td>
<td>Subscribe to message type (returns unsubscribe)</td>
</tr>
<tr>
<td><code>isConnected()</code></td>
<td>-</td>
<td>boolean</td>
<td>Check connection status</td>
</tr>
</tbody>
</table>
<h3 data-number="9.3.1" id="websocket-configuration"><span
class="header-section-number">9.3.1</span> WebSocket Configuration</h3>
<div class="sourceCode" id="cb84"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WebSocketClient {</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(config) {</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">config</span> <span class="op">=</span> {</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;ws://localhost:3000/ws&#39;</span><span class="op">,</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reconnectInterval</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span>        <span class="co">// Delay between reconnect attempts</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">maxReconnectAttempts</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span>       <span class="co">// Max reconnection attempts</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">heartbeatInterval</span><span class="op">:</span> <span class="dv">30000</span><span class="op">,</span>       <span class="co">// Heartbeat ping interval</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>config</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="9.3.2" id="websocket-connection-pattern"><span
class="header-section-number">9.3.2</span> WebSocket Connection
Pattern</h3>
<div class="sourceCode" id="cb85"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wsClient <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebSocketClient</span>({</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;ws://localhost:3000/ws&#39;</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Connection lifecycle</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Connected&#39;</span>)<span class="op">;</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;disconnected&#39;</span><span class="op">,</span> ({ code<span class="op">,</span> reason }) <span class="kw">=&gt;</span> {</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Disconnected:&#39;</span><span class="op">,</span> code<span class="op">,</span> reason)<span class="op">;</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> ({ error }) <span class="kw">=&gt;</span> {</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;WebSocket error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;reconnect-failed&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Reconnection failed&#39;</span>)<span class="op">;</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> wsClient<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.4" id="server-sent-events-sse"><span
class="header-section-number">9.4</span> Server-Sent Events (SSE)</h2>
<p>SSE provides one-way server-to-client streaming over HTTP. Simpler
than WebSockets, automatic reconnection, works with existing HTTP
infrastructure.</p>
<h3 data-number="9.4.1" id="sse-client-api"><span
class="header-section-number">9.4.1</span> SSE Client API</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect()</code></td>
<td>-</td>
<td>void</td>
<td>Connect to SSE endpoint</td>
</tr>
<tr>
<td><code>disconnect()</code></td>
<td>-</td>
<td>void</td>
<td>Close connection</td>
</tr>
<tr>
<td><code>on(eventName, handler)</code></td>
<td>eventName: string, handler: Function</td>
<td>Function</td>
<td>Subscribe to named events</td>
</tr>
<tr>
<td><code>isConnected()</code></td>
<td>-</td>
<td>boolean</td>
<td>Check connection status</td>
</tr>
</tbody>
</table>
<h3 data-number="9.4.2" id="sse-usage-pattern"><span
class="header-section-number">9.4.2</span> SSE Usage Pattern</h3>
<div class="sourceCode" id="cb86"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { SSEClient } <span class="im">from</span> <span class="st">&#39;./services/sse-client.js&#39;</span><span class="op">;</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sseClient <span class="op">=</span> <span class="kw">new</span> <span class="fu">SSEClient</span>({</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;/api/events&#39;</span><span class="op">,</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">withCredentials</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reconnectDelay</span><span class="op">:</span> <span class="dv">3000</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>sseClient<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to named events</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>sseClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;activity&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Activity:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>sseClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Notification:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Connection events</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>sseClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;SSE connected&#39;</span>))<span class="op">;</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>sseClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;disconnected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;SSE disconnected&#39;</span>))<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.5"
id="broadcastchannel-cross-tab-communication"><span
class="header-section-number">9.5</span> BroadcastChannel: Cross-Tab
Communication</h2>
<p>Synchronize state across browser tabs and windows.</p>
<h3 data-number="9.5.1" id="broadcastchannel-api"><span
class="header-section-number">9.5.1</span> BroadcastChannel API</h3>
<div class="sourceCode" id="cb87"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TabSyncService {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(channelName <span class="op">=</span> <span class="st">&#39;app-sync&#39;</span>) {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">channel</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">BroadcastChannel</span>(channelName)<span class="op">;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">tabId</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">generateTabId</span>()<span class="op">;</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">channel</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleMessage</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">broadcast</span>(type<span class="op">,</span> payload) {</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">channel</span><span class="op">.</span><span class="fu">postMessage</span>({</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>      type<span class="op">,</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>      payload<span class="op">,</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tabId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">tabId</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on</span>(type<span class="op">,</span> handler) {</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to message type</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> tabSync <span class="op">=</span> <span class="kw">new</span> <span class="fu">TabSyncService</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="9.5.2" id="cross-tab-sync-patterns"><span
class="header-section-number">9.5.2</span> Cross-Tab Sync Patterns</h3>
<div class="sourceCode" id="cb88"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync authentication state</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>tabSync<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;auth-logout&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  authService<span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/login&#39;</span><span class="op">;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>tabSync<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;auth-login&#39;</span><span class="op">,</span> (user) <span class="kw">=&gt;</span> {</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Broadcast logout to other tabs</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>tabSync<span class="op">.</span><span class="fu">broadcast</span>(<span class="st">&#39;auth-logout&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync data changes</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>tabSync<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;data-updated&#39;</span><span class="op">,</span> ({ resource<span class="op">,</span> id }) <span class="kw">=&gt;</span> {</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Refresh data in this tab</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reloadResource</span>(resource<span class="op">,</span> id)<span class="op">;</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.6" id="web-workers-background-processing"><span
class="header-section-number">9.6</span> Web Workers: Background
Processing</h2>
<p>Run JavaScript in background threads without blocking UI.</p>
<h3 data-number="9.6.1" id="worker-creation"><span
class="header-section-number">9.6.1</span> Worker Creation</h3>
<div class="sourceCode" id="cb89"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">// worker.js</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { id<span class="op">,</span> type<span class="op">,</span> data<span class="op">,</span> options } <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result<span class="op">;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (type) {</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;sort&#39;</span><span class="op">:</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="fu">sortData</span>(data<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;filter&#39;</span><span class="op">:</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="fu">filterData</span>(data<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;aggregate&#39;</span><span class="op">:</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="fu">aggregateData</span>(data<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    self<span class="op">.</span><span class="fu">postMessage</span>({ id<span class="op">,</span> result })<span class="op">;</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>    self<span class="op">.</span><span class="fu">postMessage</span>({ id<span class="op">,</span> <span class="dt">result</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sortData</span>(data<span class="op">,</span> options) {</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { field<span class="op">,</span> order <span class="op">=</span> <span class="st">&#39;asc&#39;</span> } <span class="op">=</span> options<span class="op">;</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">...</span>data]<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> comparison <span class="op">=</span> a[field] <span class="op">&lt;</span> b[field] <span class="op">?</span> <span class="op">-</span><span class="dv">1</span> <span class="op">:</span> a[field] <span class="op">&gt;</span> b[field] <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> order <span class="op">===</span> <span class="st">&#39;asc&#39;</span> <span class="op">?</span> comparison <span class="op">:</span> <span class="op">-</span>comparison<span class="op">;</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="9.6.2" id="worker-manager"><span
class="header-section-number">9.6.2</span> Worker Manager</h3>
<div class="sourceCode" id="cb90"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WorkerManager {</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(workerUrl) {</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">worker</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Worker</span>(workerUrl)<span class="op">;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">worker</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { id<span class="op">,</span> result<span class="op">,</span> error } <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pending <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">get</span>(id)<span class="op">;</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (pending) {</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">delete</span>(id)<span class="op">;</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        error <span class="op">?</span> pending<span class="op">.</span><span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(error)) <span class="op">:</span> pending<span class="op">.</span><span class="fu">resolve</span>(result)<span class="op">;</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="bu">process</span>(type<span class="op">,</span> data<span class="op">,</span> options) {</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> id <span class="op">=</span> <span class="vs">`req-</span><span class="sc">${</span><span class="op">++</span><span class="kw">this</span><span class="op">.</span><span class="at">requestId</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> { resolve<span class="op">,</span> reject })<span class="op">;</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">worker</span><span class="op">.</span><span class="fu">postMessage</span>({ id<span class="op">,</span> type<span class="op">,</span> data<span class="op">,</span> options })<span class="op">;</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">has</span>(id)) {</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">delete</span>(id)<span class="op">;</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Request timeout&#39;</span>))<span class="op">;</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">terminate</span>() {</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">worker</span><span class="op">.</span><span class="fu">terminate</span>()<span class="op">;</span></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">forEach</span>(({ reject }) <span class="kw">=&gt;</span> {</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Worker terminated&#39;</span>))<span class="op">;</span></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pendingRequests</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dataWorker <span class="op">=</span> <span class="kw">new</span> <span class="fu">WorkerManager</span>(<span class="st">&#39;/workers/data-processor.js&#39;</span>)<span class="op">;</span></span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Use worker</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sorted <span class="op">=</span> <span class="cf">await</span> dataWorker<span class="op">.</span><span class="fu">process</span>(<span class="st">&#39;sort&#39;</span><span class="op">,</span> data<span class="op">,</span> {</span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">field</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span></span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">order</span><span class="op">:</span> <span class="st">&#39;asc&#39;</span></span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.7" id="real-time-component-patterns"><span
class="header-section-number">9.7</span> Real-time Component
Patterns</h2>
<h3 data-number="9.7.1" id="notification-feed"><span
class="header-section-number">9.7.1</span> Notification Feed</h3>
<div class="sourceCode" id="cb91"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotificationFeed <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">notifications</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> (notification) <span class="kw">=&gt;</span> {</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">notifications</span><span class="op">.</span><span class="fu">unshift</span>(notification)<span class="op">;</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Auto-dismiss after 5s</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">removeNotification</span>(notification<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;notifications&quot;&gt;</span></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">notifications</span><span class="op">.</span><span class="fu">map</span>(n <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;notification </span><span class="sc">${</span>n<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;strong&gt;</span><span class="sc">${</span>n<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/strong&gt;</span></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;p&gt;</span><span class="sc">${</span>n<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;notification-feed&#39;</span><span class="op">,</span> NotificationFeed)<span class="op">;</span></span></code></pre></div>
<h3 data-number="9.7.2" id="live-activity-feed"><span
class="header-section-number">9.7.2</span> Live Activity Feed</h3>
<div class="sourceCode" id="cb92"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ActivityFeed <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">activities</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load initial data</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/activities&#39;</span>)<span class="op">;</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">activities</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to live updates</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    sseClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;activity&#39;</span><span class="op">,</span> (activity) <span class="kw">=&gt;</span> {</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">activities</span><span class="op">.</span><span class="fu">unshift</span>(activity)<span class="op">;</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">activities</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">activities</span><span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="co">// Limit</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;activities&quot;&gt;</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">activities</span><span class="op">.</span><span class="fu">map</span>(a <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;activity&quot;&gt;</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;strong&gt;</span><span class="sc">${</span>a<span class="op">.</span><span class="at">userName</span><span class="sc">}</span><span class="vs">&lt;/strong&gt; </span><span class="sc">${</span>a<span class="op">.</span><span class="at">action</span><span class="sc">}</span><span class="vs"> &lt;em&gt;</span><span class="sc">${</span>a<span class="op">.</span><span class="at">target</span><span class="sc">}</span><span class="vs">&lt;/em&gt;</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;time&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatTime</span>(a<span class="op">.</span><span class="at">timestamp</span>)<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatTime</span>(timestamp) {</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> diff <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> timestamp<span class="op">;</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&lt;</span> <span class="dv">60000</span>) <span class="cf">return</span> <span class="st">&#39;Just now&#39;</span><span class="op">;</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&lt;</span> <span class="dv">3600000</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(diff <span class="op">/</span> <span class="dv">60000</span>)<span class="sc">}</span><span class="vs">m ago`</span><span class="op">;</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Date</span>(timestamp)<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="op">;</span></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;activity-feed&#39;</span><span class="op">,</span> ActivityFeed)<span class="op">;</span></span></code></pre></div>
<h3 data-number="9.7.3" id="collaborative-editor"><span
class="header-section-number">9.7.3</span> Collaborative Editor</h3>
<div class="sourceCode" id="cb93"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CollaborativeEditor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">docId</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;doc-id&#39;</span>)<span class="op">;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">collaborators</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Join document</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;join-document&#39;</span><span class="op">,</span> { <span class="dt">docId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">docId</span> })<span class="op">;</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to updates</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;document-update&#39;</span><span class="op">,</span> (update) <span class="kw">=&gt;</span> {</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">isLocalUpdate</span>) {</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> update<span class="op">.</span><span class="at">content</span><span class="op">;</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;collaborator-joined&#39;</span><span class="op">,</span> (collab) <span class="kw">=&gt;</span> {</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">collaborators</span><span class="op">.</span><span class="fu">set</span>(collab<span class="op">.</span><span class="at">userId</span><span class="op">,</span> collab)<span class="op">;</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;collaborator-left&#39;</span><span class="op">,</span> ({ userId }) <span class="kw">=&gt;</span> {</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">collaborators</span><span class="op">.</span><span class="fu">delete</span>(userId)<span class="op">;</span></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleInput</span>(e) {</span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">isLocalUpdate</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;document-update&#39;</span><span class="op">,</span> {</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">docId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">docId</span><span class="op">,</span></span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">content</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">content</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> { <span class="kw">this</span><span class="op">.</span><span class="at">isLocalUpdate</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;editor&quot;&gt;</span></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;collaborators&quot;&gt;</span></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">collaborators</span><span class="op">.</span><span class="fu">values</span>())<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;badge&quot;&gt;</span><span class="sc">${</span>c<span class="op">.</span><span class="at">name</span>[<span class="dv">0</span>]<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;textarea&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">content</span><span class="sc">}</span><span class="vs">&lt;/textarea&gt;</span></span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;textarea&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleInput</span>(e))<span class="op">;</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;collaborative-editor&#39;</span><span class="op">,</span> CollaborativeEditor)<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.8" id="component-reference-5"><span
class="header-section-number">9.8</span> Component Reference</h2>
<p>See Chapter 20 for real-time components:</p>
<ul>
<li><strong>pan-websocket</strong>: WebSocket connection management</li>
<li><strong>pan-sse</strong>: Server-Sent Events integration</li>
<li><strong>pan-live-data</strong>: Auto-refreshing data display</li>
</ul>
<h2 data-number="9.9" id="advanced-patterns"><span
class="header-section-number">9.9</span> Advanced Patterns</h2>
<h3 data-number="9.9.1" id="optimistic-updates-1"><span
class="header-section-number">9.9.1</span> Optimistic Updates</h3>
<div class="sourceCode" id="cb94"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimisticList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">addItem</span>(item) {</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to UI immediately (optimistic)</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">push</span>({ <span class="op">...</span>item<span class="op">,</span> <span class="dt">pending</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Send to server</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/items&#39;</span><span class="op">,</span> {</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(item)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> serverItem <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace pending with server version</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> index <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">findIndex</span>(i <span class="kw">=&gt;</span> i<span class="op">.</span><span class="at">pending</span>)<span class="op">;</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span>[index] <span class="op">=</span> serverItem<span class="op">;</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Rollback on error</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">filter</span>(i <span class="kw">=&gt;</span> <span class="op">!</span>i<span class="op">.</span><span class="at">pending</span>)<span class="op">;</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">alert</span>(<span class="st">&#39;Failed to add item&#39;</span>)<span class="op">;</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="9.9.2" id="presence-tracking"><span
class="header-section-number">9.9.2</span> Presence Tracking</h3>
<div class="sourceCode" id="cb95"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PresenceTracker {</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">users</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;presence-update&#39;</span><span class="op">,</span> ({ userId<span class="op">,</span> status }) <span class="kw">=&gt;</span> {</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">set</span>(userId<span class="op">,</span> { userId<span class="op">,</span> status<span class="op">,</span> <span class="dt">lastSeen</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">notifySubscribers</span>()<span class="op">;</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    wsClient<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;presence-offline&#39;</span><span class="op">,</span> ({ userId }) <span class="kw">=&gt;</span> {</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">delete</span>(userId)<span class="op">;</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">notifySubscribers</span>()<span class="op">;</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send heartbeat</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>      wsClient<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;presence-heartbeat&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getOnlineUsers</span>() {</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">values</span>())<span class="op">.</span><span class="fu">filter</span>(u <span class="kw">=&gt;</span> u<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="st">&#39;online&#39;</span>)<span class="op">;</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="9.9.3" id="conflict-resolution"><span
class="header-section-number">9.9.3</span> Conflict Resolution</h3>
<div class="sourceCode" id="cb96"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConflictResolver {</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleUpdate</span>(localVersion<span class="op">,</span> remoteVersion) {</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (localVersion<span class="op">.</span><span class="at">timestamp</span> <span class="op">&gt;</span> remoteVersion<span class="op">.</span><span class="at">timestamp</span>) {</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Local wins - send to server</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">sendUpdate</span>(localVersion)<span class="op">;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (localVersion<span class="op">.</span><span class="at">timestamp</span> <span class="op">&lt;</span> remoteVersion<span class="op">.</span><span class="at">timestamp</span>) {</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Remote wins - apply locally</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyUpdate</span>(remoteVersion)<span class="op">;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Timestamps equal - merge</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> merged <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">merge</span>(localVersion<span class="op">,</span> remoteVersion)<span class="op">;</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyUpdate</span>(merged)<span class="op">;</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">merge</span>(local<span class="op">,</span> remote) {</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Last-write-wins per field</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>remote<span class="op">,</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span><span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(local)<span class="op">.</span><span class="fu">reduce</span>((acc<span class="op">,</span> [key<span class="op">,</span> value]) <span class="kw">=&gt;</span> {</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (local[<span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">_timestamp`</span>] <span class="op">&gt;</span> remote[<span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">_timestamp`</span>]) {</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>          acc[key] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> acc<span class="op">;</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> {})</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="9.10" id="performance-considerations"><span
class="header-section-number">9.10</span> Performance
Considerations</h2>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 27%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Strategy</th>
<th>Use Case</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Throttling</strong></td>
<td>High-frequency events (scroll, mousemove)</td>
<td>Send update max once per 100-500ms</td>
</tr>
<tr>
<td><strong>Debouncing</strong></td>
<td>Text input</td>
<td>Send update after 300ms of inactivity</td>
</tr>
<tr>
<td><strong>Batching</strong></td>
<td>Multiple updates</td>
<td>Accumulate and send in single message</td>
</tr>
<tr>
<td><strong>Compression</strong></td>
<td>Large payloads</td>
<td>Use MessagePack or gzip compression</td>
</tr>
<tr>
<td><strong>Selective sync</strong></td>
<td>Large datasets</td>
<td>Only sync visible/relevant data</td>
</tr>
</tbody>
</table>
<h3 data-number="9.10.1" id="throttle-example"><span
class="header-section-number">9.10.1</span> Throttle Example</h3>
<div class="sourceCode" id="cb97"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThrottledInput <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> lastSent <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> throttleMs <span class="op">=</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (now <span class="op">-</span> lastSent <span class="op">&gt;=</span> throttleMs) {</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>        wsClient<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;input-update&#39;</span><span class="op">,</span> { <span class="dt">value</span><span class="op">:</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span> })<span class="op">;</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        lastSent <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="9.11" id="cross-references-6"><span
class="header-section-number">9.11</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 11
(Real-time Features)</li>
<li><strong>Components</strong>: Chapter 20 (pan-websocket, pan-sse,
pan-live-data)</li>
<li><strong>Patterns</strong>: Appendix E (Real-time Patterns)</li>
<li><strong>Related</strong>: Chapter 7 (API Integration), Chapter 12
(Performance)</li>
</ul>
<h2 data-number="9.12" id="common-issues-6"><span
class="header-section-number">9.12</span> Common Issues</h2>
<h3 data-number="9.12.1"
id="issue-connection-drops-on-mobilesleep"><span
class="header-section-number">9.12.1</span> Issue: Connection drops on
mobile/sleep</h3>
<p><strong>Problem</strong>: WebSocket closes when device sleeps
<strong>Solution</strong>: Implement heartbeat + reconnection; use SSE
for mobile</p>
<h3 data-number="9.12.2" id="issue-message-order-not-guaranteed"><span
class="header-section-number">9.12.2</span> Issue: Message order not
guaranteed</h3>
<p><strong>Problem</strong>: Messages arrive out of sequence
<strong>Solution</strong>: Add sequence numbers; buffer and reorder on
client</p>
<h3 data-number="9.12.3"
id="issue-memory-leaks-from-event-listeners"><span
class="header-section-number">9.12.3</span> Issue: Memory leaks from
event listeners</h3>
<p><strong>Problem</strong>: Component unmounts but listeners remain
<strong>Solution</strong>: Always unsubscribe in
<code>disconnectedCallback()</code></p>
<h3 data-number="9.12.4"
id="issue-duplicate-messages-on-reconnect"><span
class="header-section-number">9.12.4</span> Issue: Duplicate messages on
reconnect</h3>
<p><strong>Problem</strong>: Server resends messages after reconnection
<strong>Solution</strong>: Track message IDs; deduplicate on client</p>
<h3 data-number="9.12.5" id="issue-high-bandwidth-usage"><span
class="header-section-number">9.12.5</span> Issue: High bandwidth
usage</h3>
<p><strong>Problem</strong>: Too many messages or large payloads
<strong>Solution</strong>: Throttle updates; compress payloads; batch
messages</p>
<p>See <em>Learning LARC</em> Chapter 11 for complete real-time
patterns, WebSocket authentication, and scaling strategies.</p>
<h1 data-number="10" id="file-management"><span
class="header-section-number">10</span> File Management</h1>
<p>Quick reference for file management and OPFS (Origin Private File
System) in LARC applications. For detailed tutorials, see <em>Learning
LARC</em> Chapter 11.</p>
<h2 data-number="10.1" id="overview-6"><span
class="header-section-number">10.1</span> Overview</h2>
<p>OPFS provides browser-based file storage with high performance, large
capacity (GB+), and persistence across sessions. Unlike localStorage
(5-10MB) or IndexedDB, OPFS offers native file system operations ideal
for offline-first apps and large file handling.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>OPFS: Origin Private File System - browser’s private file
storage</li>
<li>FileSystemDirectoryHandle: Directory reference for operations</li>
<li>FileSystemFileHandle: File reference for read/write operations</li>
<li>Storage quota: Browser-managed space limits (best-effort
persistence)</li>
<li>Streaming: Handle large files without loading into memory</li>
</ul>
<h2 data-number="10.2" id="quick-example-6"><span
class="header-section-number">10.2</span> Quick Example</h2>
<div class="sourceCode" id="cb98"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize OPFS</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">root</span> <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">getDirectory</span>()<span class="op">;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Write file</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fileHandle <span class="op">=</span> <span class="cf">await</span> <span class="bu">root</span><span class="op">.</span><span class="fu">getFileHandle</span>(<span class="st">&#39;notes.txt&#39;</span><span class="op">,</span> { <span class="dt">create</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> writable <span class="op">=</span> <span class="cf">await</span> fileHandle<span class="op">.</span><span class="fu">createWritable</span>()<span class="op">;</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> writable<span class="op">.</span><span class="fu">write</span>(<span class="st">&#39;Hello OPFS!&#39;</span>)<span class="op">;</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> writable<span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Read file</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> fileHandle<span class="op">.</span><span class="fu">getFile</span>()<span class="op">;</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> <span class="cf">await</span> file<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(text)<span class="op">;</span> <span class="co">// &quot;Hello OPFS!&quot;</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">// List files</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="cf">await</span> (<span class="kw">const</span> [name<span class="op">,</span> handle] <span class="kw">of</span> <span class="bu">root</span><span class="op">.</span><span class="fu">entries</span>()) {</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(name<span class="op">,</span> handle<span class="op">.</span><span class="at">kind</span>)<span class="op">;</span> <span class="co">// &#39;notes.txt&#39; &#39;file&#39;</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.3" id="filesystemservice-api"><span
class="header-section-number">10.3</span> FileSystemService API</h2>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>initialize()</code></td>
<td>-</td>
<td>Promise&lt;void&gt;</td>
<td>Initialize OPFS root handle</td>
</tr>
<tr>
<td><code>createDirectory(path)</code></td>
<td>path: string</td>
<td>Promise&lt;DirectoryHandle&gt;</td>
<td>Create directory (recursive)</td>
</tr>
<tr>
<td><code>getDirectory(path)</code></td>
<td>path: string</td>
<td>Promise&lt;DirectoryHandle&gt;</td>
<td>Get existing directory</td>
</tr>
<tr>
<td><code>listFiles(path)</code></td>
<td>path?: string</td>
<td>Promise&lt;FileInfo[]&gt;</td>
<td>List files in directory</td>
</tr>
<tr>
<td><code>listDirectories(path)</code></td>
<td>path?: string</td>
<td>Promise&lt;DirectoryInfo[]&gt;</td>
<td>List subdirectories</td>
</tr>
<tr>
<td><code>writeFile(path, name, content)</code></td>
<td>path: string, name: string, content: Blob|ArrayBuffer|string</td>
<td>Promise&lt;void&gt;</td>
<td>Write or update file</td>
</tr>
<tr>
<td><code>readFile(path, name)</code></td>
<td>path: string, name: string</td>
<td>Promise&lt;File&gt;</td>
<td>Read file contents</td>
</tr>
<tr>
<td><code>deleteFile(path, name)</code></td>
<td>path: string, name: string</td>
<td>Promise&lt;void&gt;</td>
<td>Delete file</td>
</tr>
<tr>
<td><code>deleteDirectory(path, recursive?)</code></td>
<td>path: string, recursive?: boolean</td>
<td>Promise&lt;void&gt;</td>
<td>Delete directory</td>
</tr>
<tr>
<td><code>fileExists(path, name)</code></td>
<td>path: string, name: string</td>
<td>Promise&lt;boolean&gt;</td>
<td>Check if file exists</td>
</tr>
<tr>
<td><code>copyFile(src, dest)</code></td>
<td>sourcePath: string, sourceFile: string, destPath: string, destFile:
string</td>
<td>Promise&lt;void&gt;</td>
<td>Copy file</td>
</tr>
<tr>
<td><code>moveFile(src, dest)</code></td>
<td>sourcePath: string, sourceFile: string, destPath: string, destFile:
string</td>
<td>Promise&lt;void&gt;</td>
<td>Move file</td>
</tr>
<tr>
<td><code>getStorageInfo()</code></td>
<td>-</td>
<td>Promise&lt;StorageInfo&gt;</td>
<td>Get quota and usage stats</td>
</tr>
<tr>
<td><code>getDirectorySize(path)</code></td>
<td>path?: string</td>
<td>Promise&lt;number&gt;</td>
<td>Calculate total size (bytes)</td>
</tr>
</tbody>
</table>
<h3 data-number="10.3.1" id="fileinfo-interface"><span
class="header-section-number">10.3.1</span> FileInfo Interface</h3>
<div class="sourceCode" id="cb99"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> FileInfo {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  size<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  type<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  handle<span class="op">:</span> FileSystemFileHandle<span class="op">;</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  lastModified<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.4" id="common-operations"><span
class="header-section-number">10.4</span> Common Operations</h2>
<h3 data-number="10.4.1" id="create-and-write-file"><span
class="header-section-number">10.4.1</span> Create and Write File</h3>
<div class="sourceCode" id="cb100"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fileSystem <span class="op">=</span> <span class="kw">new</span> <span class="fu">FileSystemService</span>()<span class="op">;</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">initialize</span>()<span class="op">;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Write text</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">writeFile</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="st">&#39;note.txt&#39;</span><span class="op">,</span> <span class="st">&#39;Hello World&#39;</span>)<span class="op">;</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Write binary</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> blob <span class="op">=</span> <span class="kw">new</span> <span class="bu">Blob</span>([<span class="st">&#39;data&#39;</span>]<span class="op">,</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;application/octet-stream&#39;</span> })<span class="op">;</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">writeFile</span>(<span class="st">&#39;/documents&#39;</span><span class="op">,</span> <span class="st">&#39;file.bin&#39;</span><span class="op">,</span> blob)<span class="op">;</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Write ArrayBuffer</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> buffer <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayBuffer</span>(<span class="dv">1024</span>)<span class="op">;</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">writeFile</span>(<span class="st">&#39;/data&#39;</span><span class="op">,</span> <span class="st">&#39;binary.dat&#39;</span><span class="op">,</span> buffer)<span class="op">;</span></span></code></pre></div>
<h3 data-number="10.4.2" id="read-and-process-files"><span
class="header-section-number">10.4.2</span> Read and Process Files</h3>
<div class="sourceCode" id="cb101"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Read file</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">readFile</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="st">&#39;note.txt&#39;</span>)<span class="op">;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> <span class="cf">await</span> file<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Stream large files</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">readFile</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="st">&#39;large-file.mp4&#39;</span>)<span class="op">;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stream <span class="op">=</span> file<span class="op">.</span><span class="fu">stream</span>()<span class="op">;</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> reader <span class="op">=</span> stream<span class="op">.</span><span class="fu">getReader</span>()<span class="op">;</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { done<span class="op">,</span> value } <span class="op">=</span> <span class="cf">await</span> reader<span class="op">.</span><span class="fu">read</span>()<span class="op">;</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (done) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">processChunk</span>(value)<span class="op">;</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="10.4.3" id="directory-operations"><span
class="header-section-number">10.4.3</span> Directory Operations</h3>
<div class="sourceCode" id="cb102"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create nested directories</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">createDirectory</span>(<span class="st">&#39;/documents/2024/reports&#39;</span>)<span class="op">;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co">// List with filtering</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> files <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">listFiles</span>(<span class="st">&#39;/documents&#39;</span>)<span class="op">;</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> images <span class="op">=</span> files<span class="op">.</span><span class="fu">filter</span>(f <span class="kw">=&gt;</span> f<span class="op">.</span><span class="at">type</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;image/&#39;</span>))<span class="op">;</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Recursive size calculation</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> size <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">getDirectorySize</span>(<span class="st">&#39;/documents&#39;</span>)<span class="op">;</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Total: </span><span class="sc">${</span>size<span class="sc">}</span><span class="vs"> bytes`</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.5" id="storage-quota-management"><span
class="header-section-number">10.5</span> Storage Quota Management</h2>
<h3 data-number="10.5.1" id="check-quota"><span
class="header-section-number">10.5.1</span> Check Quota</h3>
<div class="sourceCode" id="cb103"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { usage<span class="op">,</span> quota<span class="op">,</span> percentUsed } <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">getStorageInfo</span>()<span class="op">;</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Used: </span><span class="sc">${</span>usage<span class="sc">}</span><span class="vs"> / </span><span class="sc">${</span>quota<span class="sc">}</span><span class="vs"> bytes (</span><span class="sc">${</span>percentUsed<span class="sc">}</span><span class="vs">%)`</span>)<span class="op">;</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (percentUsed <span class="op">&gt;</span> <span class="dv">75</span>) {</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alert</span>(<span class="st">&#39;Running low on storage&#39;</span>)<span class="op">;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="10.5.2" id="request-persistent-storage"><span
class="header-section-number">10.5.2</span> Request Persistent
Storage</h3>
<div class="sourceCode" id="cb104"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Request persistence (prevents automatic eviction)</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">?.</span><span class="at">persist</span>) {</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> isPersisted <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">persist</span>()<span class="op">;</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Persistent:&#39;</span><span class="op">,</span> isPersisted)<span class="op">;</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Check current persistence status</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">?.</span><span class="at">persisted</span>) {</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> persisted <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">persisted</span>()<span class="op">;</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Currently persisted:&#39;</span><span class="op">,</span> persisted)<span class="op">;</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.6" id="file-upload-pattern"><span
class="header-section-number">10.6</span> File Upload Pattern</h2>
<h3 data-number="10.6.1" id="drag-and-drop-upload"><span
class="header-section-number">10.6.1</span> Drag-and-Drop Upload</h3>
<div class="sourceCode" id="cb105"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileUploadComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;drop&#39;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> files <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(e<span class="op">.</span><span class="at">dataTransfer</span><span class="op">.</span><span class="at">files</span>)<span class="op">;</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> file <span class="kw">of</span> files) {</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">uploadFile</span>(file)<span class="op">;</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragover&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> e<span class="op">.</span><span class="fu">preventDefault</span>())<span class="op">;</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">uploadFile</span>(file) {</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> file<span class="op">.</span><span class="fu">arrayBuffer</span>()<span class="op">;</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">writeFile</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> file<span class="op">.</span><span class="at">name</span><span class="op">,</span> content)<span class="op">;</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;file-uploaded&#39;</span><span class="op">,</span> { </span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>      <span class="dt">detail</span><span class="op">:</span> { <span class="dt">name</span><span class="op">:</span> file<span class="op">.</span><span class="at">name</span><span class="op">,</span> <span class="dt">size</span><span class="op">:</span> file<span class="op">.</span><span class="at">size</span> }</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="10.6.2" id="upload-with-progress-tracking"><span
class="header-section-number">10.6.2</span> Upload with Progress
Tracking</h3>
<div class="sourceCode" id="cb106"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">uploadWithProgress</span>(file<span class="op">,</span> onProgress) {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chunkSize <span class="op">=</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// 1MB chunks</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chunks <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>(file<span class="op">.</span><span class="at">size</span> <span class="op">/</span> chunkSize)<span class="op">;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> fileHandle <span class="op">=</span> <span class="cf">await</span> <span class="bu">root</span><span class="op">.</span><span class="fu">getFileHandle</span>(file<span class="op">.</span><span class="at">name</span><span class="op">,</span> { <span class="dt">create</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> writable <span class="op">=</span> <span class="cf">await</span> fileHandle<span class="op">.</span><span class="fu">createWritable</span>()<span class="op">;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> chunks<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> start <span class="op">=</span> i <span class="op">*</span> chunkSize<span class="op">;</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> end <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(start <span class="op">+</span> chunkSize<span class="op">,</span> file<span class="op">.</span><span class="at">size</span>)<span class="op">;</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> chunk <span class="op">=</span> file<span class="op">.</span><span class="fu">slice</span>(start<span class="op">,</span> end)<span class="op">;</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> writable<span class="op">.</span><span class="fu">write</span>(chunk)<span class="op">;</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onProgress</span>((i <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> chunks <span class="op">*</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> writable<span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">uploadWithProgress</span>(file<span class="op">,</span> (percent) <span class="kw">=&gt;</span> {</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Upload: </span><span class="sc">${</span>percent<span class="sc">}</span><span class="vs">%`</span>)<span class="op">;</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.7" id="file-download-pattern"><span
class="header-section-number">10.7</span> File Download Pattern</h2>
<div class="sourceCode" id="cb107"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">downloadFile</span>(path<span class="op">,</span> fileName) {</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">readFile</span>(path<span class="op">,</span> fileName)<span class="op">;</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(file)<span class="op">;</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)<span class="op">;</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> fileName<span class="op">;</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>  URL<span class="op">.</span><span class="fu">revokeObjectURL</span>(url)<span class="op">;</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.8" id="file-browser-component"><span
class="header-section-number">10.8</span> File Browser Component</h2>
<div class="sourceCode" id="cb108"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileBrowser <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span> <span class="op">=</span> <span class="st">&#39;/&#39;</span><span class="op">;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">render</span>() {</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> files <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">listFiles</span>(<span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span>)<span class="op">;</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dirs <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">listDirectories</span>(<span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span>)<span class="op">;</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;breadcrumb&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">currentPath</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>dirs<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;dir&quot; onclick=&quot;navigate(&#39;</span><span class="sc">${</span>d<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&#39;)&quot;&gt;</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          📁 </span><span class="sc">${</span>d<span class="op">.</span><span class="at">name</span><span class="sc">}</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;file&quot; onclick=&quot;open(&#39;</span><span class="sc">${</span>f<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&#39;)&quot;&gt;</span></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getIcon</span>(f<span class="op">.</span><span class="at">type</span>)<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>f<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatSize</span>(f<span class="op">.</span><span class="at">size</span>)<span class="sc">}</span><span class="vs">)</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getIcon</span>(type) {</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;image/&#39;</span>)) <span class="cf">return</span> <span class="st">&#39;🖼️&#39;</span><span class="op">;</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;video/&#39;</span>)) <span class="cf">return</span> <span class="st">&#39;🎬&#39;</span><span class="op">;</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;audio/&#39;</span>)) <span class="cf">return</span> <span class="st">&#39;🎵&#39;</span><span class="op">;</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type <span class="op">===</span> <span class="st">&#39;application/pdf&#39;</span>) <span class="cf">return</span> <span class="st">&#39;📄&#39;</span><span class="op">;</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;📄&#39;</span><span class="op">;</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatSize</span>(bytes) {</span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> units <span class="op">=</span> [<span class="st">&#39;B&#39;</span><span class="op">,</span> <span class="st">&#39;KB&#39;</span><span class="op">,</span> <span class="st">&#39;MB&#39;</span><span class="op">,</span> <span class="st">&#39;GB&#39;</span>]<span class="op">;</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> size <span class="op">=</span> bytes<span class="op">;</span></span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> unitIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (size <span class="op">&gt;=</span> <span class="dv">1024</span> <span class="op">&amp;&amp;</span> unitIndex <span class="op">&lt;</span> units<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>      size <span class="op">/=</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>      unitIndex<span class="op">++;</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span>size<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>units[unitIndex]<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;file-browser&#39;</span><span class="op">,</span> FileBrowser)<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.9" id="search-and-filter"><span
class="header-section-number">10.9</span> Search and Filter</h2>
<div class="sourceCode" id="cb109"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileSearch {</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">search</span>(query<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> results <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">searchDirectory</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> query<span class="op">,</span> options<span class="op">,</span> results)<span class="op">;</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">score</span> <span class="op">-</span> a<span class="op">.</span><span class="at">score</span>)<span class="op">;</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">searchDirectory</span>(path<span class="op">,</span> query<span class="op">,</span> options<span class="op">,</span> results) {</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> files <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">listFiles</span>(path)<span class="op">;</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> file <span class="kw">of</span> files) {</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> score <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">matchFile</span>(file<span class="op">,</span> query<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (score <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>        results<span class="op">.</span><span class="fu">push</span>({ file<span class="op">,</span> path<span class="op">,</span> score })<span class="op">;</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (options<span class="op">.</span><span class="at">recursive</span>) {</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> dirs <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">listDirectories</span>(path)<span class="op">;</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> dir <span class="kw">of</span> dirs) {</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> subPath <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">/</span><span class="sc">${</span>dir<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span><span class="op">.</span><span class="fu">replace</span>(<span class="st">&#39;//&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="op">;</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">searchDirectory</span>(subPath<span class="op">,</span> query<span class="op">,</span> options<span class="op">,</span> results)<span class="op">;</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matchFile</span>(file<span class="op">,</span> query<span class="op">,</span> options) {</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> name <span class="op">=</span> file<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> q <span class="op">=</span> query<span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> score <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> q) score <span class="op">+=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (name<span class="op">.</span><span class="fu">startsWith</span>(q)) score <span class="op">+=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (name<span class="op">.</span><span class="fu">includes</span>(q)) score <span class="op">+=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter by type</span></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (options<span class="op">.</span><span class="at">types</span><span class="op">?.</span><span class="at">length</span>) {</span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> matches <span class="op">=</span> options<span class="op">.</span><span class="at">types</span><span class="op">.</span><span class="fu">some</span>(t <span class="kw">=&gt;</span> file<span class="op">.</span><span class="at">type</span><span class="op">.</span><span class="fu">startsWith</span>(t))<span class="op">;</span></span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>matches) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>      score <span class="op">+=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter by size</span></span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (options<span class="op">.</span><span class="at">minSize</span> <span class="op">&amp;&amp;</span> file<span class="op">.</span><span class="at">size</span> <span class="op">&lt;</span> options<span class="op">.</span><span class="at">minSize</span>) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (options<span class="op">.</span><span class="at">maxSize</span> <span class="op">&amp;&amp;</span> file<span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> options<span class="op">.</span><span class="at">maxSize</span>) <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> score<span class="op">;</span></span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fileSearch <span class="op">=</span> <span class="kw">new</span> <span class="fu">FileSearch</span>()<span class="op">;</span></span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-55"><a href="#cb109-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb109-56"><a href="#cb109-56" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> fileSearch<span class="op">.</span><span class="fu">search</span>(<span class="st">&#39;photo&#39;</span><span class="op">,</span> {</span>
<span id="cb109-57"><a href="#cb109-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">types</span><span class="op">:</span> [<span class="st">&#39;image/&#39;</span>]<span class="op">,</span></span>
<span id="cb109-58"><a href="#cb109-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minSize</span><span class="op">:</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">100</span><span class="op">,</span> <span class="co">// 100KB min</span></span>
<span id="cb109-59"><a href="#cb109-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">recursive</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb109-60"><a href="#cb109-60" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.10" id="component-reference-6"><span
class="header-section-number">10.10</span> Component Reference</h2>
<p>See Chapter 19 for file management UI components:</p>
<ul>
<li><strong>pan-files</strong>: Complete file manager with browser,
upload, quota display</li>
<li><strong>pan-file-picker</strong>: File selection dialog</li>
<li><strong>pan-image-viewer</strong>: Image preview and editing</li>
</ul>
<h2 data-number="10.11" id="performance-tips"><span
class="header-section-number">10.11</span> Performance Tips</h2>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 41%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Optimization</th>
<th>Implementation</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Stream large files</strong></td>
<td>Use <code>file.stream()</code> instead of
<code>file.arrayBuffer()</code></td>
<td>Reduce memory usage</td>
</tr>
<tr>
<td><strong>Batch operations</strong></td>
<td>Group multiple writes in single transaction</td>
<td>Improve write speed</td>
</tr>
<tr>
<td><strong>Cache handles</strong></td>
<td>Store FileSystemHandle references</td>
<td>Reduce lookup overhead</td>
</tr>
<tr>
<td><strong>Lazy loading</strong></td>
<td>Load directory contents on demand</td>
<td>Faster initial render</td>
</tr>
<tr>
<td><strong>Background cleanup</strong></td>
<td>Delete temp files in Web Worker</td>
<td>Non-blocking UI</td>
</tr>
</tbody>
</table>
<h3 data-number="10.11.1" id="streaming-example"><span
class="header-section-number">10.11.1</span> Streaming Example</h3>
<div class="sourceCode" id="cb110"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">processLargeFile</span>(path<span class="op">,</span> fileName) {</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> fileSystem<span class="op">.</span><span class="fu">readFile</span>(path<span class="op">,</span> fileName)<span class="op">;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stream <span class="op">=</span> file<span class="op">.</span><span class="fu">stream</span>()<span class="op">;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> reader <span class="op">=</span> stream<span class="op">.</span><span class="fu">getReader</span>()<span class="op">;</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> bytesProcessed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { done<span class="op">,</span> value } <span class="op">=</span> <span class="cf">await</span> reader<span class="op">.</span><span class="fu">read</span>()<span class="op">;</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (done) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">processChunk</span>(value)<span class="op">;</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    bytesProcessed <span class="op">+=</span> value<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateProgress</span>(bytesProcessed <span class="op">/</span> file<span class="op">.</span><span class="at">size</span>)<span class="op">;</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.12" id="cross-references-7"><span
class="header-section-number">10.12</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 11 (File
Management and OPFS)</li>
<li><strong>Components</strong>: Chapter 19 (pan-files, pan-file-picker,
pan-image-viewer)</li>
<li><strong>Patterns</strong>: Appendix E (File Management
Patterns)</li>
<li><strong>Related</strong>: Chapter 4 (State Management - IndexedDB),
Chapter 12 (Performance)</li>
</ul>
<h2 data-number="10.13" id="common-issues-7"><span
class="header-section-number">10.13</span> Common Issues</h2>
<h3 data-number="10.13.1"
id="issue-notfounderror-when-reading-files"><span
class="header-section-number">10.13.1</span> Issue: “NotFoundError” when
reading files</h3>
<p><strong>Problem</strong>: File or directory doesn’t exist
<strong>Solution</strong>: Check existence with
<code>fileExists()</code> before reading; handle errors gracefully</p>
<h3 data-number="10.13.2" id="issue-quotaexceedederror-on-write"><span
class="header-section-number">10.13.2</span> Issue: “QuotaExceededError”
on write</h3>
<p><strong>Problem</strong>: Storage quota exceeded
<strong>Solution</strong>: Check available space before write; request
persistent storage; implement cleanup</p>
<h3 data-number="10.13.3"
id="issue-files-lost-after-browser-update"><span
class="header-section-number">10.13.3</span> Issue: Files lost after
browser update</h3>
<p><strong>Problem</strong>: Non-persistent storage evicted
<strong>Solution</strong>: Request persistence via
<code>navigator.storage.persist()</code>; implement cloud backup</p>
<h3 data-number="10.13.4"
id="issue-slow-directory-listing-with-many-files"><span
class="header-section-number">10.13.4</span> Issue: Slow directory
listing with many files</h3>
<p><strong>Problem</strong>: Synchronous iteration blocks UI
<strong>Solution</strong>: Paginate results; use Web Worker for
processing; implement virtual scrolling</p>
<h3 data-number="10.13.5" id="issue-opfs-not-available-in-browser"><span
class="header-section-number">10.13.5</span> Issue: OPFS not available
in browser</h3>
<p><strong>Problem</strong>: Older browser or insecure context
(non-HTTPS) <strong>Solution</strong>: Feature detect
<code>navigator.storage?.getDirectory</code>; provide fallback
(IndexedDB)</p>
<p>See <em>Learning LARC</em> Chapter 11 for complete file management
patterns, image processing, and cloud sync strategies.</p>
<h1 data-number="11" id="theming-and-styling"><span
class="header-section-number">11</span> Theming and Styling</h1>
<p>Quick reference for theming and styling patterns in LARC
applications. For detailed tutorials, see <em>Learning LARC</em> Chapter
15.</p>
<h2 data-number="11.1" id="overview-7"><span
class="header-section-number">11.1</span> Overview</h2>
<p>LARC applications use CSS custom properties (variables) for themeable
styling, supporting light/dark modes, system preferences, and dynamic
theme switching via the PAN bus. The pan-theme-provider component
manages global theme state.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>CSS custom properties: Runtime-modifiable variables
(–color-primary)</li>
<li>Semantic tokens: Meaningful names (–color-text-primary, not
–gray-900)</li>
<li>Theme provider: Component managing theme state via PAN bus</li>
<li>System preference: Respect prefers-color-scheme media query</li>
<li>Scoped themes: Component-specific styling independent of global
theme</li>
</ul>
<h2 data-number="11.2" id="quick-example-7"><span
class="header-section-number">11.2</span> Quick Example</h2>
<div class="sourceCode" id="cb111"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Define theme variables */</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-primary</span><span class="ch">:</span> <span class="cn">#3b82f6</span><span class="op">;</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg</span><span class="ch">:</span> <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="ex">]</span> {</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text</span><span class="ch">:</span> <span class="cn">#f9fafb</span><span class="op">;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* Use in components */</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>button {</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--color-primary</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">color</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--color-bg</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb112"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-provider</span><span class="ot"> theme</span><span class="op">=</span><span class="st">&quot;auto&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-provider</span><span class="dt">&gt;</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="11.3" id="theme-system-structure"><span
class="header-section-number">11.3</span> Theme System Structure</h2>
<h3 data-number="11.3.1" id="two-tier-token-system"><span
class="header-section-number">11.3.1</span> Two-Tier Token System</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 37%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Tier</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Primitives</strong></td>
<td>Raw color values</td>
<td><code>--blue-500: #3b82f6</code></td>
</tr>
<tr>
<td><strong>Semantic</strong></td>
<td>Meaningful tokens</td>
<td><code>--color-primary: var(--blue-500)</code></td>
</tr>
</tbody>
</table>
<p>Components use <strong>semantic tokens only</strong>, never
primitives. This allows theme changes without updating components.</p>
<h3 data-number="11.3.2" id="standard-theme-variables"><span
class="header-section-number">11.3.2</span> Standard Theme
Variables</h3>
<div class="sourceCode" id="cb113"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Colors */</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-primary</span><span class="ch">:</span> <span class="cn">#3b82f6</span><span class="op">;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-secondary</span><span class="ch">:</span> <span class="cn">#6b7280</span><span class="op">;</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-secondary</span><span class="ch">:</span> <span class="cn">#f9fafb</span><span class="op">;</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-border</span><span class="ch">:</span> <span class="cn">#e5e7eb</span><span class="op">;</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Typography */</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-family-base</span><span class="ch">:</span> <span class="dv">system-ui</span><span class="op">,</span> <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-size-base</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-weight-normal</span><span class="ch">:</span> <span class="dv">400</span><span class="op">;</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-weight-bold</span><span class="ch">:</span> <span class="dv">700</span><span class="op">;</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">--line-height-normal</span><span class="ch">:</span> <span class="dv">1.5</span><span class="op">;</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Spacing */</span></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-xs</span><span class="ch">:</span> <span class="dv">0.25</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-sm</span><span class="ch">:</span> <span class="dv">0.5</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-md</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-lg</span><span class="ch">:</span> <span class="dv">1.5</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-xl</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Borders &amp; Shadows */</span></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-radius</span><span class="ch">:</span> <span class="dv">0.5</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-width</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>  <span class="va">--shadow-sm</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">0</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0.05</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>  <span class="va">--shadow-lg</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">10</span><span class="dt">px</span> <span class="dv">15</span><span class="dt">px</span> <span class="dv">-3</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0.1</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Transitions */</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>  <span class="va">--transition-fast</span><span class="ch">:</span> <span class="dv">150</span><span class="dt">ms</span> <span class="dv">ease-in-out</span><span class="op">;</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>  <span class="va">--transition-base</span><span class="ch">:</span> <span class="dv">250</span><span class="dt">ms</span> <span class="dv">ease-in-out</span><span class="op">;</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.4" id="dark-mode-implementation"><span
class="header-section-number">11.4</span> Dark Mode Implementation</h2>
<h3 data-number="11.4.1" id="manual-dark-mode-override"><span
class="header-section-number">11.4.1</span> Manual Dark Mode
Override</h3>
<div class="sourceCode" id="cb114"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="ex">]</span> {</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#f9fafb</span><span class="op">;</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-secondary</span><span class="ch">:</span> <span class="cn">#d1d5db</span><span class="op">;</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-secondary</span><span class="ch">:</span> <span class="cn">#1f2937</span><span class="op">;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-border</span><span class="ch">:</span> <span class="cn">#374151</span><span class="op">;</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">--shadow-sm</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">0</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0.3</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">--shadow-lg</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">10</span><span class="dt">px</span> <span class="dv">15</span><span class="dt">px</span> <span class="dv">-3</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0.5</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.4.2" id="system-preference-detection"><span
class="header-section-number">11.4.2</span> System Preference
Detection</h3>
<div class="sourceCode" id="cb115"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">prefers-color-scheme</span><span class="ch">:</span> <span class="dv">dark</span><span class="fu">)</span> {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root:not(</span><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;light&quot;</span><span class="ex">]</span><span class="in">)</span> {</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#f9fafb</span><span class="op">;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* ... other dark mode overrides */</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.5" id="theme-provider-component"><span
class="header-section-number">11.5</span> Theme Provider Component</h2>
<p>See Chapter 17 for full API documentation of
<code>pan-theme-provider</code>.</p>
<h3 data-number="11.5.1" id="basic-usage-1"><span
class="header-section-number">11.5.1</span> Basic Usage</h3>
<div class="sourceCode" id="cb116"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-provider</span><span class="ot"> theme</span><span class="op">=</span><span class="st">&quot;auto&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-provider</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="11.5.2" id="javascript-api"><span
class="header-section-number">11.5.2</span> JavaScript API</h3>
<div class="sourceCode" id="cb117"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> provider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Set theme</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>provider<span class="op">.</span><span class="fu">setTheme</span>(<span class="st">&#39;dark&#39;</span>)<span class="op">;</span> <span class="co">// &#39;light&#39;, &#39;dark&#39;, or &#39;auto&#39;</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current theme</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> theme <span class="op">=</span> provider<span class="op">.</span><span class="fu">getTheme</span>()<span class="op">;</span> <span class="co">// Returns setting (&#39;auto&#39;)</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> effective <span class="op">=</span> provider<span class="op">.</span><span class="fu">getEffectiveTheme</span>()<span class="op">;</span> <span class="co">// Returns actual (&#39;dark&#39;)</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for changes</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>provider<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;theme-change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Theme:&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="11.5.3" id="pan-bus-integration"><span
class="header-section-number">11.5.3</span> PAN Bus Integration</h3>
<div class="sourceCode" id="cb118"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { bus } <span class="im">from</span> <span class="st">&#39;/core/pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to theme changes</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;theme.changed&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;New theme:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">effective</span>)<span class="op">;</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Request theme change</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;theme.change&#39;</span><span class="op">,</span> { <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> })<span class="op">;</span></span></code></pre></div>
<h2 data-number="11.6" id="theme-toggle-component"><span
class="header-section-number">11.6</span> Theme Toggle Component</h2>
<div class="sourceCode" id="cb119"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Icon button (default) --&gt;</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Button with label --&gt;</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="ot"> variant</span><span class="op">=</span><span class="st">&quot;button&quot;</span><span class="ot"> label</span><span class="op">=</span><span class="st">&quot;Theme&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Dropdown with all options --&gt;</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="ot"> variant</span><span class="op">=</span><span class="st">&quot;dropdown&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="11.7" id="component-specific-theming"><span
class="header-section-number">11.7</span> Component-Specific
Theming</h2>
<h3 data-number="11.7.1" id="shadow-dom-scoping"><span
class="header-section-number">11.7.1</span> Shadow DOM Scoping</h3>
<div class="sourceCode" id="cb120"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BrandedCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          --card-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          --card-text: #ffffff;</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        .card {</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--card-bg);</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: var(--card-text);</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--space-lg);</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: var(--border-radius);</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* Allow customization */</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([variant=&quot;flat&quot;]) {</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          --card-bg: var(--color-bg-secondary);</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          --card-text: var(--color-text-primary);</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/div&gt;</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.8" id="responsive-theming"><span
class="header-section-number">11.8</span> Responsive Theming</h2>
<h3 data-number="11.8.1" id="viewport-based-variables"><span
class="header-section-number">11.8.1</span> Viewport-Based
Variables</h3>
<div class="sourceCode" id="cb121"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-page</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--space-md</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-display</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--font-size-2xl</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">min-width</span><span class="ch">:</span> <span class="dv">768</span><span class="dt">px</span><span class="fu">)</span> {</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root</span> {</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">--space-page</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--space-xl</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">--font-display</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--font-size-3xl</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">min-width</span><span class="ch">:</span> <span class="dv">1024</span><span class="dt">px</span><span class="fu">)</span> {</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root</span> {</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">--space-page</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--space-2xl</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">--font-display</span><span class="ch">:</span> <span class="dv">2.5</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="fu">.container</span> {</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">padding</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--space-page</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.9" id="smooth-theme-transitions"><span
class="header-section-number">11.9</span> Smooth Theme Transitions</h2>
<div class="sourceCode" id="cb122"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span> {</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">transition</span><span class="ch">:</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">background-color </span><span class="fu">var(</span><span class="va">--transition-base</span><span class="fu">)</span><span class="op">,</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">border-color </span><span class="fu">var(</span><span class="va">--transition-base</span><span class="fu">)</span><span class="op">,</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">color</span> <span class="fu">var(</span><span class="va">--transition-base</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co">/* Disable on page load */</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="fu">.no-transitions</span> <span class="op">*</span> {</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">transition</span><span class="ch">:</span> <span class="dv">none</span> <span class="at">!important</span><span class="op">;</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="co">/* Respect user preference */</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">prefers-reduced-motion</span><span class="ch">:</span> <span class="dv">reduce</span><span class="fu">)</span> {</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span> {</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">transition</span><span class="ch">:</span> <span class="dv">none</span> <span class="at">!important</span><span class="op">;</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb123"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Disable transitions during initial theme apply</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;no-transitions&#39;</span>)<span class="op">;</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;no-transitions&#39;</span>)<span class="op">;</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="11.10" id="multi-brand-support"><span
class="header-section-number">11.10</span> Multi-Brand Support</h2>
<div class="sourceCode" id="cb124"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-primary</span><span class="ch">:</span> <span class="cn">#667eea</span><span class="op">;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-logo</span><span class="ch">:</span> <span class="fu">url(</span><span class="st">&#39;/logos/default.svg&#39;</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-brand</span><span class="op">=</span><span class="st">&quot;acme&quot;</span><span class="ex">]</span> {</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-primary</span><span class="ch">:</span> <span class="cn">#10b981</span><span class="op">;</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-logo</span><span class="ch">:</span> <span class="fu">url(</span><span class="st">&#39;/logos/acme.svg&#39;</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-brand</span><span class="op">=</span><span class="st">&quot;techstart&quot;</span><span class="ex">]</span> {</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-primary</span><span class="ch">:</span> <span class="cn">#f59e0b</span><span class="op">;</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">--brand-logo</span><span class="ch">:</span> <span class="fu">url(</span><span class="st">&#39;/logos/techstart.svg&#39;</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a><span class="fu">.brand-button</span> {</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--brand-primary</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Switch brands</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-brand&#39;</span><span class="op">,</span> <span class="st">&#39;acme&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="11.11" id="accessibility"><span
class="header-section-number">11.11</span> Accessibility</h2>
<h3 data-number="11.11.1" id="contrast-requirements"><span
class="header-section-number">11.11.1</span> Contrast Requirements</h3>
<p>Maintain WCAG contrast ratios:</p>
<ul>
<li><strong>AA Normal text</strong>: 4.5:1 minimum</li>
<li><strong>AA Large text</strong>: 3:1 minimum<br />
</li>
<li><strong>AAA Normal text</strong>: 7:1 minimum</li>
</ul>
<div class="sourceCode" id="cb126"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Good contrast */</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span> <span class="co">/* 16.3:1 on white */</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="ex">]</span> {</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#f9fafb</span><span class="op">;</span> <span class="co">/* 17.5:1 on dark */</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#111827</span><span class="op">;</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.11.2" id="reduced-motion"><span
class="header-section-number">11.11.2</span> Reduced Motion</h3>
<div class="sourceCode" id="cb127"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">prefers-reduced-motion</span><span class="ch">:</span> <span class="dv">reduce</span><span class="fu">)</span> {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">*,</span> <span class="op">*</span><span class="in">::before</span><span class="op">,</span> <span class="op">*</span><span class="in">::after</span> {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">animation-duration</span><span class="ch">:</span> <span class="dv">0.01</span><span class="dt">ms</span> <span class="at">!important</span><span class="op">;</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">animation-iteration-count</span><span class="ch">:</span> <span class="dv">1</span> <span class="at">!important</span><span class="op">;</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">transition-duration</span><span class="ch">:</span> <span class="dv">0.01</span><span class="dt">ms</span> <span class="at">!important</span><span class="op">;</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.11.3" id="high-contrast-mode"><span
class="header-section-number">11.11.3</span> High Contrast Mode</h3>
<div class="sourceCode" id="cb128"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="im">@media</span> <span class="fu">(</span><span class="kw">prefers-contrast</span><span class="ch">:</span> <span class="dv">high</span><span class="fu">)</span> {</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root</span> {</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">--color-text-primary</span><span class="ch">:</span> <span class="cn">#000000</span><span class="op">;</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">--color-bg-primary</span><span class="ch">:</span> <span class="cn">#ffffff</span><span class="op">;</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">--color-border</span><span class="ch">:</span> <span class="cn">#000000</span><span class="op">;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">--border-width</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.11.4" id="screen-reader-announcements"><span
class="header-section-number">11.11.4</span> Screen Reader
Announcements</h3>
<div class="sourceCode" id="cb129"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">announceThemeChange</span>(theme) {</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> announcement <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>  announcement<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;role&#39;</span><span class="op">,</span> <span class="st">&#39;status&#39;</span>)<span class="op">;</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>  announcement<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;aria-live&#39;</span><span class="op">,</span> <span class="st">&#39;polite&#39;</span>)<span class="op">;</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  announcement<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;sr-only&#39;</span><span class="op">;</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>  announcement<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Theme changed to </span><span class="sc">${</span>theme<span class="sc">}</span><span class="vs"> mode`</span><span class="op">;</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(announcement)<span class="op">;</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> announcement<span class="op">.</span><span class="fu">remove</span>()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.12" id="performance-tips-1"><span
class="header-section-number">11.12</span> Performance Tips</h2>
<table>
<colgroup>
<col style="width: 60%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>Optimization</th>
<th>Benefit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Use data attributes for theme switching</td>
<td>Single change triggers all updates</td>
</tr>
<tr>
<td>Avoid deep custom property nesting</td>
<td>Reduces lookup cost</td>
</tr>
<tr>
<td>Transition specific properties only</td>
<td>Better performance than <code>all</code></td>
</tr>
<tr>
<td>Use CSS containment</td>
<td>Helps browser optimize rendering</td>
</tr>
</tbody>
</table>
<h3 data-number="11.12.1" id="efficient-theme-switching"><span
class="header-section-number">11.12.1</span> Efficient Theme
Switching</h3>
<div class="sourceCode" id="cb130"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good - single attribute change</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> <span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad - multiple property changes</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="fu">setProperty</span>(<span class="st">&#39;--color-text&#39;</span><span class="op">,</span> <span class="st">&#39;#fff&#39;</span>)<span class="op">;</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="fu">setProperty</span>(<span class="st">&#39;--color-bg&#39;</span><span class="op">,</span> <span class="st">&#39;#000&#39;</span>)<span class="op">;</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ... dozens more</span></span></code></pre></div>
<h2 data-number="11.13" id="component-reference-7"><span
class="header-section-number">11.13</span> Component Reference</h2>
<p>See Chapter 17 for complete API documentation:</p>
<ul>
<li><strong>pan-theme-provider</strong>: Global theme management</li>
<li><strong>pan-theme-toggle</strong>: Theme switcher UI control</li>
</ul>
<h2 data-number="11.14" id="cross-references-8"><span
class="header-section-number">11.14</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 15
(Theming and Styling)</li>
<li><strong>Components</strong>: Chapter 17 (pan-theme-provider,
pan-theme-toggle)</li>
<li><strong>Patterns</strong>: Appendix E (Theming Patterns)</li>
<li><strong>Related</strong>: Chapter 19 (UI Components)</li>
</ul>
<h2 data-number="11.15" id="common-issues-8"><span
class="header-section-number">11.15</span> Common Issues</h2>
<h3 data-number="11.15.1" id="issue-theme-not-applying-on-load"><span
class="header-section-number">11.15.1</span> Issue: Theme not applying
on load</h3>
<p><strong>Problem</strong>: Flash of unstyled content
<strong>Solution</strong>: Apply theme in inline
<code>&lt;script&gt;</code> before loading components; add
<code>no-transitions</code> class during initial load</p>
<h3 data-number="11.15.2"
id="issue-custom-properties-not-inheriting"><span
class="header-section-number">11.15.2</span> Issue: Custom properties
not inheriting</h3>
<p><strong>Problem</strong>: Shadow DOM doesn’t inherit all properties
<strong>Solution</strong>: Explicitly pass needed properties through;
use CSS <code>:host</code> context</p>
<h3 data-number="11.15.3" id="issue-theme-transition-lag"><span
class="header-section-number">11.15.3</span> Issue: Theme transition
lag</h3>
<p><strong>Problem</strong>: Too many properties transitioning
<strong>Solution</strong>: Transition only color-related properties; use
<code>prefers-reduced-motion</code> to disable</p>
<h3 data-number="11.15.4"
id="issue-dark-mode-colors-look-washed-out"><span
class="header-section-number">11.15.4</span> Issue: Dark mode colors
look washed out</h3>
<p><strong>Problem</strong>: Using same colors as light mode
<strong>Solution</strong>: Use slightly desaturated colors in dark mode;
adjust shadows to be darker</p>
<h3 data-number="11.15.5"
id="issue-system-preference-not-detected"><span
class="header-section-number">11.15.5</span> Issue: System preference
not detected</h3>
<p><strong>Problem</strong>: <code>prefers-color-scheme</code> not
working <strong>Solution</strong>: Ensure HTTPS context; check browser
support; verify media query syntax</p>
<p>See <em>Learning LARC</em> Chapter 15 for complete theming
strategies, advanced CSS patterns, and design system integration.</p>
<h1 data-number="12" id="performance-optimization"><span
class="header-section-number">12</span> Performance Optimization</h1>
<p>Quick reference for performance optimization in LARC applications.
For detailed tutorials, see <em>Learning LARC</em> Chapter 15.</p>
<h2 data-number="12.1" id="overview-8"><span
class="header-section-number">12.1</span> Overview</h2>
<p>Optimize LARC applications through efficient message patterns, lazy
loading, virtual scrolling, and memory management. Performance
optimization focuses on user-perceived speed: initial load time,
interaction responsiveness, and smooth animations.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>Message filtering and throttling to reduce bus overhead</li>
<li>Lazy loading components and routes for faster initial load</li>
<li>Virtual scrolling to handle large data sets efficiently</li>
<li>Debouncing/throttling high-frequency events</li>
<li>Memory leak prevention through proper cleanup</li>
<li>Bundle size optimization with tree shaking and code splitting</li>
</ul>
<h2 data-number="12.2" id="quick-example-8"><span
class="header-section-number">12.2</span> Quick Example</h2>
<div class="sourceCode" id="cb131"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { debounce<span class="op">,</span> throttle } <span class="im">from</span> <span class="st">&#39;../utils/timing.js&#39;</span><span class="op">;</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedSearch <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounce search input (wait for typing to stop)</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> debouncedSearch <span class="op">=</span> <span class="fu">debounce</span>((value) <span class="kw">=&gt;</span> {</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;search.query&#39;</span><span class="op">,</span> { <span class="dt">query</span><span class="op">:</span> value })<span class="op">;</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">debouncedSearch</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Throttle scroll tracking (limit frequency)</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> throttledScroll <span class="op">=</span> <span class="fu">throttle</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;scroll.position&#39;</span><span class="op">,</span> { <span class="dt">y</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">scrollY</span> })<span class="op">;</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> throttledScroll)<span class="op">;</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.3" id="message-bus-optimization"><span
class="header-section-number">12.3</span> Message Bus Optimization</h2>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 40%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>Specific subscriptions</td>
<td>Subscribe to <code>user.*</code> not <code>*</code></td>
<td>Reduce handler invocations</td>
</tr>
<tr>
<td>Early returns</td>
<td>Check message relevance first</td>
<td>Skip expensive processing</td>
</tr>
<tr>
<td>Unsubscribe aggressively</td>
<td>Unsubscribe when done</td>
<td>Reduce memory and CPU overhead</td>
</tr>
<tr>
<td>Throttle publishers</td>
<td>Limit publish frequency (50-100ms)</td>
<td>Mouse/scroll events</td>
</tr>
<tr>
<td>Debounce publishers</td>
<td>Wait for pause (300ms)</td>
<td>User input, search</td>
</tr>
<tr>
<td>Batch messages</td>
<td>Publish array not individual items</td>
<td>Bulk updates</td>
</tr>
</tbody>
</table>
<p><strong>Throttle vs Debounce</strong>:</p>
<ul>
<li><strong>Throttle</strong>: Guarantees function runs at most once per
interval (good for scroll)</li>
<li><strong>Debounce</strong>: Waits for pause before running (good for
search input)</li>
</ul>
<h2 data-number="12.4" id="timing-utilities"><span
class="header-section-number">12.4</span> Timing Utilities</h2>
<h3 data-number="12.4.1" id="debounce"><span
class="header-section-number">12.4.1</span> Debounce</h3>
<div class="sourceCode" id="cb132"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">// utils/debounce.js</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">debounce</span>(fn<span class="op">,</span> delay) {</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> timeoutId <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> debounced <span class="op">=</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  debounced<span class="op">.</span><span class="at">cancel</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> debounced<span class="op">;</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="12.4.2" id="throttle"><span
class="header-section-number">12.4.2</span> Throttle</h3>
<div class="sourceCode" id="cb133"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">// utils/throttle.js</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">throttle</span>(fn<span class="op">,</span> interval) {</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lastCall <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (now <span class="op">-</span> lastCall <span class="op">&gt;=</span> interval) {</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>      lastCall <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>      fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="12.4.3" id="raf-throttle"><span
class="header-section-number">12.4.3</span> RAF Throttle</h3>
<div class="sourceCode" id="cb134"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">// utils/raf-throttle.js</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> RAFThrottle {</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(callback) {</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">callback</span> <span class="op">=</span> callback<span class="op">;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">rafId</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trigger</span>(<span class="op">...</span>args) {</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">rafId</span> <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">rafId</span> <span class="op">=</span> <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">callback</span>(<span class="op">...</span>args)<span class="op">;</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">rafId</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cancel</span>() {</span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">rafId</span>) <span class="fu">cancelAnimationFrame</span>(<span class="kw">this</span><span class="op">.</span><span class="at">rafId</span>)<span class="op">;</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.5" id="lazy-loading-patterns"><span
class="header-section-number">12.5</span> Lazy Loading Patterns</h2>
<h3 data-number="12.5.1" id="component-lazy-loading"><span
class="header-section-number">12.5.1</span> Component Lazy Loading</h3>
<div class="sourceCode" id="cb135"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load component when near viewport</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LazyLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> componentName <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;component&#39;</span>)<span class="op">;</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> margin <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;load-distance&#39;</span>) <span class="op">||</span> <span class="st">&#39;600px&#39;</span><span class="op">;</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>(</span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">async</span> (entries) <span class="kw">=&gt;</span> {</span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (entries[<span class="dv">0</span>]<span class="op">.</span><span class="at">isIntersecting</span>) {</span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> <span class="im">import</span>(<span class="vs">`./components/</span><span class="sc">${</span>componentName<span class="sc">}</span><span class="vs">.mjs`</span>)<span class="op">;</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> component <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(componentName)<span class="op">;</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">replaceWith</span>(component)<span class="op">;</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">rootMargin</span><span class="op">:</span> margin }</span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span><span class="op">.</span><span class="fu">observe</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">lazy-loader</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;heavy-chart&quot;</span><span class="ot"> load-distance</span><span class="op">=</span><span class="st">&quot;400px&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">lazy-loader</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="12.5.2" id="route-based-code-splitting"><span
class="header-section-number">12.5.2</span> Route-Based Code
Splitting</h3>
<div class="sourceCode" id="cb137"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app-router.mjs</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> routeMap <span class="op">=</span> {</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/home-page.mjs&#39;</span>)<span class="op">,</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/profile&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/profile-page.mjs&#39;</span>)<span class="op">,</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/settings&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/settings-page.mjs&#39;</span>)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppRouter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadRoute</span>(route) {</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loader <span class="op">=</span> routeMap[route]<span class="op">;</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (loader) {</span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">loader</span>()<span class="op">;</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getComponentName</span>(route)<span class="sc">}</span><span class="vs">&gt;&lt;/&gt;`</span><span class="op">;</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.6" id="virtual-scrolling"><span
class="header-section-number">12.6</span> Virtual Scrolling</h2>
<p>For lists with 1,000+ items, render only visible rows:</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VirtualList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span> <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">containerHeight</span> <span class="op">=</span> <span class="dv">600</span><span class="op">;</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> visibleCount <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>(<span class="kw">this</span><span class="op">.</span><span class="at">containerHeight</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span>) <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span>)<span class="op">;</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> endIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span><span class="op">,</span> startIndex <span class="op">+</span> visibleCount)<span class="op">;</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> visibleItems <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">slice</span>(startIndex<span class="op">,</span> endIndex)<span class="op">;</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> totalHeight <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="op">;</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> offsetY <span class="op">=</span> startIndex <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="op">;</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">containerHeight</span><span class="sc">}</span><span class="vs">px; overflow-y: auto;&quot;&gt;</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style=&quot;height: </span><span class="sc">${</span>totalHeight<span class="sc">}</span><span class="vs">px; position: relative;&quot;&gt;</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style=&quot;position: absolute; top: </span><span class="sc">${</span>offsetY<span class="sc">}</span><span class="vs">px;&quot;&gt;</span></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>visibleItems<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderItem</span>(item))<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;div&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">scrollTop</span><span class="op">;</span></span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderItem</span>(item) {</span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`&lt;div style=&quot;height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;&quot;&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">virtual-list</span><span class="ot"> item-height</span><span class="op">=</span><span class="st">&quot;60&quot;</span><span class="ot"> container-height</span><span class="op">=</span><span class="st">&quot;600&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">virtual-list</span><span class="dt">&gt;</span></span></code></pre></div>
<p>See <strong>pan-virtual-list</strong> (Chapter 19) for
production-ready virtual list component.</p>
<h2 data-number="12.7" id="memory-management"><span
class="header-section-number">12.7</span> Memory Management</h2>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 41%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unsubscribe in <code>disconnectedCallback</code></td>
<td>Clean up PAN subscriptions</td>
<td><code>this.unsubscribe()</code></td>
</tr>
<tr>
<td>Remove event listeners</td>
<td>Clean up DOM listeners</td>
<td><code>removeEventListener()</code></td>
</tr>
<tr>
<td>Clear timers/intervals</td>
<td>Stop periodic tasks</td>
<td><code>clearInterval()</code></td>
</tr>
<tr>
<td>Cancel pending fetches</td>
<td>Abort ongoing requests</td>
<td><code>AbortController.abort()</code></td>
</tr>
<tr>
<td>Use WeakMap for caches</td>
<td>Auto-cleanup with GC</td>
<td><code>new WeakMap()</code></td>
</tr>
</tbody>
</table>
<h3 data-number="12.7.1" id="cleanup-example"><span
class="header-section-number">12.7.1</span> Cleanup Example</h3>
<div class="sourceCode" id="cb140"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LeakFreeComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to bus</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.updated&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleData</span>)<span class="op">;</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add event listener</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set interval</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">intervalId</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">update</span>()<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fetch with abort controller</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span><span class="op">,</span> { <span class="dt">signal</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="at">signal</span> })<span class="op">;</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up everything</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">intervalId</span>)<span class="op">;</span></span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.8" id="bundle-size-optimization"><span
class="header-section-number">12.8</span> Bundle Size Optimization</h2>
<table>
<thead>
<tr>
<th>Technique</th>
<th>Description</th>
<th>Savings</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tree shaking</td>
<td>Remove unused exports</td>
<td>20-40%</td>
</tr>
<tr>
<td>Dynamic imports</td>
<td>Load code on demand</td>
<td>Initial: 50-70%</td>
</tr>
<tr>
<td>Minification</td>
<td>Compress code</td>
<td>30-50%</td>
</tr>
<tr>
<td>Gzip/Brotli</td>
<td>Server compression</td>
<td>70-80%</td>
</tr>
<tr>
<td>Dependency auditing</td>
<td>Replace heavy libs</td>
<td>Varies</td>
</tr>
</tbody>
</table>
<h3 data-number="12.8.1" id="bundle-optimization-example"><span
class="header-section-number">12.8.1</span> Bundle Optimization
Example</h3>
<div class="sourceCode" id="cb141"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Before: import everything</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> moment <span class="im">from</span> <span class="st">&#39;moment&#39;</span><span class="op">;</span> <span class="co">// 231 kB</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">// After: use native APIs</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> formatter <span class="op">=</span> <span class="kw">new</span> <span class="bu">Intl</span><span class="op">.</span><span class="fu">DateTimeFormat</span>(<span class="st">&#39;en-US&#39;</span><span class="op">,</span> {</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">year</span><span class="op">:</span> <span class="st">&#39;numeric&#39;</span><span class="op">,</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">month</span><span class="op">:</span> <span class="st">&#39;long&#39;</span><span class="op">,</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">day</span><span class="op">:</span> <span class="st">&#39;numeric&#39;</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>formatter<span class="op">.</span><span class="fu">format</span>(<span class="kw">new</span> <span class="bu">Date</span>())<span class="op">;</span> <span class="co">// 0 kB</span></span></code></pre></div>
<h3 data-number="12.8.2" id="build-configuration"><span
class="header-section-number">12.8.2</span> Build Configuration</h3>
<div class="sourceCode" id="cb142"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="st">&quot;esbuild src/app.js --bundle --minify --splitting --outdir=dist&quot;</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="12.9" id="performance-monitoring"><span
class="header-section-number">12.9</span> Performance Monitoring</h2>
<div class="sourceCode" id="cb143"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PerformanceMonitor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Navigation timing</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> nav <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByType</span>(<span class="st">&#39;navigation&#39;</span>)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>({</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;DNS&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">domainLookupEnd</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">domainLookupStart</span><span class="op">,</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;TCP&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">connectEnd</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">connectStart</span><span class="op">,</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Request&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">responseStart</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">requestStart</span><span class="op">,</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Response&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">responseEnd</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">responseStart</span><span class="op">,</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;DOM&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">domComplete</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">domLoading</span><span class="op">,</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Total&#39;</span><span class="op">:</span> nav<span class="op">.</span><span class="at">loadEventEnd</span> <span class="op">-</span> nav<span class="op">.</span><span class="at">fetchStart</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Long task detection</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> list<span class="op">.</span><span class="fu">getEntries</span>()) {</span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (entry<span class="op">.</span><span class="at">duration</span> <span class="op">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Long task: </span><span class="sc">${</span>entry<span class="op">.</span><span class="at">duration</span><span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;longtask&#39;</span>] })<span class="op">;</span></span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Core Web Vitals</span></span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> list<span class="op">.</span><span class="fu">getEntries</span>()) {</span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>entry<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>entry<span class="op">.</span><span class="at">value</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;largest-contentful-paint&#39;</span><span class="op">,</span> <span class="st">&#39;first-input&#39;</span>] })<span class="op">;</span></span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.10" id="component-reference-8"><span
class="header-section-number">12.10</span> Component Reference</h2>
<p>See Chapter 19 for performance-optimized UI components:</p>
<ul>
<li><strong>pan-virtual-list</strong>: Production virtual scrolling</li>
<li><strong>pan-lazy-image</strong>: Lazy image loading with
IntersectionObserver</li>
<li><strong>pan-suspense</strong>: Loading states and code
splitting</li>
</ul>
<h2 data-number="12.11" id="complete-example"><span
class="header-section-number">12.11</span> Complete Example</h2>
<div class="sourceCode" id="cb144"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimized data table with virtual scrolling and search</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedDataTable <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">filteredItems</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to data</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;table.data&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span><span class="op">;</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">filteredItems</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">;</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounced search</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> debouncedFilter <span class="op">=</span> <span class="fu">debounce</span>((query) <span class="kw">=&gt;</span> {</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">filteredItems</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">filter</span>(item <span class="kw">=&gt;</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>        item<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">.</span><span class="fu">includes</span>(query<span class="op">.</span><span class="fu">toLowerCase</span>())</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;input type=&quot;text&quot; placeholder=&quot;Search...&quot; /&gt;</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;virtual-list item-height=&quot;50&quot; container-height=&quot;600&quot;&gt;&lt;/virtual-list&gt;</span></span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">debouncedFilter</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> list <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;virtual-list&#39;</span>)<span class="op">;</span></span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;virtual-list.items&#39;</span><span class="op">,</span> { <span class="dt">items</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">filteredItems</span> })<span class="op">;</span></span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;optimized-data-table&#39;</span><span class="op">,</span> OptimizedDataTable)<span class="op">;</span></span></code></pre></div>
<h2 data-number="12.12" id="cross-references-9"><span
class="header-section-number">12.12</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 15
(Performance)</li>
<li><strong>Components</strong>: Chapter 19 (pan-virtual-list,
pan-lazy-image)</li>
<li><strong>Patterns</strong>: Appendix E (Message patterns,
optimization strategies)</li>
<li><strong>Related</strong>: Chapter 13 (Testing), Chapter 14
(Debugging)</li>
</ul>
<h2 data-number="12.13" id="common-issues-9"><span
class="header-section-number">12.13</span> Common Issues</h2>
<h3 data-number="12.13.1" id="high-cpu-usage-from-message-bus"><span
class="header-section-number">12.13.1</span> High CPU usage from message
bus</h3>
<p><strong>Problem</strong>: Too many subscriptions or wildcard
patterns<br />
<strong>Solution</strong>: Use specific topics, unsubscribe
aggressively, profile with <code>pan-debug</code></p>
<h3 data-number="12.13.2" id="memory-leaks-in-spas"><span
class="header-section-number">12.13.2</span> Memory leaks in SPAs</h3>
<p><strong>Problem</strong>: Components not cleaning up
subscriptions/listeners<br />
<strong>Solution</strong>: Always implement
<code>disconnectedCallback()</code> cleanup pattern</p>
<h3 data-number="12.13.3" id="slow-initial-load"><span
class="header-section-number">12.13.3</span> Slow initial load</h3>
<p><strong>Problem</strong>: Loading all code upfront<br />
<strong>Solution</strong>: Lazy load routes/components, code split with
dynamic imports</p>
<h3 data-number="12.13.4" id="janky-scrolling"><span
class="header-section-number">12.13.4</span> Janky scrolling</h3>
<p><strong>Problem</strong>: Heavy computations on scroll events<br />
<strong>Solution</strong>: Use RAF throttle, virtual scrolling for
lists, passive event listeners</p>
<h3 data-number="12.13.5" id="large-bundle-size"><span
class="header-section-number">12.13.5</span> Large bundle size</h3>
<p><strong>Problem</strong>: Including entire libraries for small
features<br />
<strong>Solution</strong>: Tree shake, use native APIs, check
bundlephobia.com before adding dependencies</p>
<h1 data-number="13" id="testing-strategies"><span
class="header-section-number">13</span> Testing Strategies</h1>
<p>Quick reference for testing LARC applications. For detailed
tutorials, see <em>Learning LARC</em> Chapter 14.</p>
<h2 data-number="13.1" id="overview-9"><span
class="header-section-number">13.1</span> Overview</h2>
<p>Test LARC applications using unit tests for components, integration
tests for message flows, and E2E tests for complete workflows.
Message-driven architecture simplifies testing through decoupling and
observable side effects.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>Testing pyramid: Many unit tests, some integration tests, few E2E
tests</li>
<li>Mock PAN bus for isolated component testing</li>
<li>Test message flows between components</li>
<li>Use fake timers for interval/timeout testing</li>
<li>E2E tests verify complete user workflows in real browsers</li>
</ul>
<h2 data-number="13.2" id="quick-example-9"><span
class="header-section-number">13.2</span> Quick Example</h2>
<div class="sourceCode" id="cb145"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { describe<span class="op">,</span> it<span class="op">,</span> expect<span class="op">,</span> beforeEach } <span class="im">from</span> <span class="st">&#39;vitest&#39;</span><span class="op">;</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { CounterButton } <span class="im">from</span> <span class="st">&#39;../components/counter-button.mjs&#39;</span><span class="op">;</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;CounterButton&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> element<span class="op">;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>    element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;counter-button&#39;</span>)<span class="op">;</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should increment count when clicked&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> button <span class="op">=</span> element<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">;</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(element<span class="op">.</span><span class="at">count</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>    button<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(element<span class="op">.</span><span class="at">count</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a>    button<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(element<span class="op">.</span><span class="at">count</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb145-20"><a href="#cb145-20" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb145-21"><a href="#cb145-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.3" id="test-environment-setup"><span
class="header-section-number">13.3</span> Test Environment Setup</h2>
<h3 data-number="13.3.1" id="vitest-configuration"><span
class="header-section-number">13.3.1</span> Vitest Configuration</h3>
<div class="sourceCode" id="cb146"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">// vitest.config.js</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { defineConfig } <span class="im">from</span> <span class="st">&#39;vitest/config&#39;</span><span class="op">;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="fu">defineConfig</span>({</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">test</span><span class="op">:</span> {</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">environment</span><span class="op">:</span> <span class="st">&#39;happy-dom&#39;</span><span class="op">,</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">globals</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">setupFiles</span><span class="op">:</span> [<span class="st">&#39;./tests/setup.js&#39;</span>]</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.3.2" id="test-setup"><span
class="header-section-number">13.3.2</span> Test Setup</h3>
<div class="sourceCode" id="cb147"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/setup.js</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { beforeEach<span class="op">,</span> afterEach } <span class="im">from</span> <span class="st">&#39;vitest&#39;</span><span class="op">;</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MockBus } <span class="im">from</span> <span class="st">&#39;./mocks/mock-bus.js&#39;</span><span class="op">;</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> mockBus<span class="op">;</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>  mockBus <span class="op">=</span> <span class="kw">new</span> <span class="fu">MockBus</span>()<span class="op">;</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">publish</span> <span class="op">=</span> mockBus<span class="op">.</span><span class="at">publish</span><span class="op">.</span><span class="fu">bind</span>(mockBus)<span class="op">;</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">subscribe</span> <span class="op">=</span> mockBus<span class="op">.</span><span class="at">subscribe</span><span class="op">.</span><span class="fu">bind</span>(mockBus)<span class="op">;</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a><span class="fu">afterEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>  mockBus<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">getMockBus</span>() {</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mockBus<span class="op">;</span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="13.4" id="mock-pan-bus"><span
class="header-section-number">13.4</span> Mock PAN Bus</h2>
<div class="sourceCode" id="cb148"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/mocks/mock-bus.js</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MockBus {</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">published</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(topic<span class="op">,</span> data) {</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">published</span><span class="op">.</span><span class="fu">push</span>({ topic<span class="op">,</span> data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Trigger subscriptions</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(topic) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>    handlers<span class="op">.</span><span class="fu">forEach</span>(handler <span class="kw">=&gt;</span> <span class="fu">handler</span>({ topic<span class="op">,</span> data }))<span class="op">;</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Trigger wildcard subscriptions</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">getWildcardHandlers</span>(topic)<span class="op">.</span><span class="fu">forEach</span>(handler <span class="kw">=&gt;</span> {</span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">handler</span>({ topic<span class="op">,</span> data })<span class="op">;</span></span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span>(pattern<span class="op">,</span> handler) {</span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">has</span>(pattern)) {</span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">set</span>(pattern<span class="op">,</span> [])<span class="op">;</span></span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(pattern)<span class="op">.</span><span class="fu">push</span>(handler)<span class="op">;</span></span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return unsubscribe function</span></span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(pattern)<span class="op">;</span></span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> index <span class="op">=</span> handlers<span class="op">.</span><span class="fu">indexOf</span>(handler)<span class="op">;</span></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (index <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) handlers<span class="op">.</span><span class="fu">splice</span>(index<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getWildcardHandlers</span>(topic) {</span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> handlers <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [pattern<span class="op">,</span> patternHandlers] <span class="kw">of</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span>) {</span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">matchesPattern</span>(topic<span class="op">,</span> pattern)) {</span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a>        handlers<span class="op">.</span><span class="fu">push</span>(<span class="op">...</span>patternHandlers)<span class="op">;</span></span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb148-42"><a href="#cb148-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb148-43"><a href="#cb148-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> handlers<span class="op">;</span></span>
<span id="cb148-44"><a href="#cb148-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-45"><a href="#cb148-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-46"><a href="#cb148-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matchesPattern</span>(topic<span class="op">,</span> pattern) {</span>
<span id="cb148-47"><a href="#cb148-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pattern <span class="op">===</span> <span class="st">&#39;*&#39;</span>) <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb148-48"><a href="#cb148-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pattern <span class="op">===</span> topic) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb148-49"><a href="#cb148-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-50"><a href="#cb148-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> patternParts <span class="op">=</span> pattern<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">;</span></span>
<span id="cb148-51"><a href="#cb148-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> topicParts <span class="op">=</span> topic<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">;</span></span>
<span id="cb148-52"><a href="#cb148-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-53"><a href="#cb148-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (patternParts<span class="op">.</span><span class="at">length</span> <span class="op">!==</span> topicParts<span class="op">.</span><span class="at">length</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb148-54"><a href="#cb148-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb148-55"><a href="#cb148-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patternParts<span class="op">.</span><span class="fu">every</span>((part<span class="op">,</span> i) <span class="kw">=&gt;</span> </span>
<span id="cb148-56"><a href="#cb148-56" aria-hidden="true" tabindex="-1"></a>      part <span class="op">===</span> <span class="st">&#39;*&#39;</span> <span class="op">||</span> part <span class="op">===</span> topicParts[i]</span>
<span id="cb148-57"><a href="#cb148-57" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb148-58"><a href="#cb148-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-59"><a href="#cb148-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-60"><a href="#cb148-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reset</span>() {</span>
<span id="cb148-61"><a href="#cb148-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb148-62"><a href="#cb148-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">published</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb148-63"><a href="#cb148-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-64"><a href="#cb148-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-65"><a href="#cb148-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Test helpers</span></span>
<span id="cb148-66"><a href="#cb148-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getPublished</span>(topic) {</span>
<span id="cb148-67"><a href="#cb148-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">published</span><span class="op">.</span><span class="fu">filter</span>(msg <span class="kw">=&gt;</span> msg<span class="op">.</span><span class="at">topic</span> <span class="op">===</span> topic)<span class="op">;</span></span>
<span id="cb148-68"><a href="#cb148-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-69"><a href="#cb148-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-70"><a href="#cb148-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getLastPublished</span>(topic) {</span>
<span id="cb148-71"><a href="#cb148-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> messages <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getPublished</span>(topic)<span class="op">;</span></span>
<span id="cb148-72"><a href="#cb148-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> messages[messages<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb148-73"><a href="#cb148-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-74"><a href="#cb148-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-75"><a href="#cb148-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wasPublished</span>(topic<span class="op">,</span> data) {</span>
<span id="cb148-76"><a href="#cb148-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">published</span><span class="op">.</span><span class="fu">some</span>(msg <span class="kw">=&gt;</span></span>
<span id="cb148-77"><a href="#cb148-77" aria-hidden="true" tabindex="-1"></a>      msg<span class="op">.</span><span class="at">topic</span> <span class="op">===</span> topic <span class="op">&amp;&amp;</span></span>
<span id="cb148-78"><a href="#cb148-78" aria-hidden="true" tabindex="-1"></a>      <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span>) <span class="op">===</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb148-79"><a href="#cb148-79" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb148-80"><a href="#cb148-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-81"><a href="#cb148-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-82"><a href="#cb148-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-83"><a href="#cb148-83" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> { MockBus }<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.5" id="unit-testing-patterns"><span
class="header-section-number">13.5</span> Unit Testing Patterns</h2>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 41%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Component creation</td>
<td>Create and mount component</td>
<td><code>document.createElement('my-component')</code></td>
</tr>
<tr>
<td>Attribute testing</td>
<td>Test attribute changes</td>
<td><code>element.setAttribute('value', 'test')</code></td>
</tr>
<tr>
<td>Event testing</td>
<td>Simulate user interactions</td>
<td><code>button.click()</code></td>
</tr>
<tr>
<td>Spy methods</td>
<td>Verify method calls</td>
<td><code>vi.spyOn(element, 'method')</code></td>
</tr>
<tr>
<td>Mock fetch</td>
<td>Stub network requests</td>
<td><code>global.fetch = vi.fn()</code></td>
</tr>
</tbody>
</table>
<h3 data-number="13.5.1" id="testing-attributes"><span
class="header-section-number">13.5.1</span> Testing Attributes</h3>
<div class="sourceCode" id="cb149"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should update when attributes change&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;username&#39;</span><span class="op">,</span> <span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(element<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;username&#39;</span><span class="op">,</span> <span class="st">&#39;Bob&#39;</span>)<span class="op">;</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(element<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;Bob&#39;</span>)<span class="op">;</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(element<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.5.2" id="testing-message-publishing"><span
class="header-section-number">13.5.2</span> Testing Message
Publishing</h3>
<div class="sourceCode" id="cb150"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should publish notification&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> mockBus <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">;</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  element<span class="op">.</span><span class="fu">showNotification</span>(<span class="st">&#39;Hello&#39;</span>)<span class="op">;</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> published <span class="op">=</span> mockBus<span class="op">.</span><span class="fu">getLastPublished</span>(<span class="st">&#39;notification.show&#39;</span>)<span class="op">;</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(published)<span class="op">.</span><span class="fu">toBeDefined</span>()<span class="op">;</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(published<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">message</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="st">&#39;Hello&#39;</span>)<span class="op">;</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.5.3" id="testing-message-subscriptions"><span
class="header-section-number">13.5.3</span> Testing Message
Subscriptions</h3>
<div class="sourceCode" id="cb151"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should update on message&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(<span class="st">&#39;data.updated&#39;</span><span class="op">,</span> { <span class="dt">value</span><span class="op">:</span> <span class="dv">42</span> })<span class="op">;</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(element<span class="op">.</span><span class="at">value</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(element<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;42&#39;</span>)<span class="op">;</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.6" id="integration-testing"><span
class="header-section-number">13.6</span> Integration Testing</h2>
<p>Test multiple components communicating via PAN bus:</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Shopping Cart Integration&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> catalog<span class="op">,</span> cart<span class="op">,</span> badge<span class="op">;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    catalog <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;product-catalog&#39;</span>)<span class="op">;</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    cart <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;shopping-cart&#39;</span>)<span class="op">;</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>    badge <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;cart-badge&#39;</span>)<span class="op">;</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">append</span>(catalog<span class="op">,</span> cart<span class="op">,</span> badge)<span class="op">;</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should update cart and badge when product added&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;cart.item.added&#39;</span><span class="op">,</span> {</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">productId</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Widget&#39;</span><span class="op">,</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">price</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(cart<span class="op">.</span><span class="at">items</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(cart<span class="op">.</span><span class="at">items</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">name</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="st">&#39;Widget&#39;</span>)<span class="op">;</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(badge<span class="op">.</span><span class="at">itemCount</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should publish cart.updated message&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mockBus <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">;</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">publish</span>(<span class="st">&#39;cart.item.added&#39;</span><span class="op">,</span> {</span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">productId</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Widget&#39;</span><span class="op">,</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">price</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> updated <span class="op">=</span> mockBus<span class="op">.</span><span class="fu">getLastPublished</span>(<span class="st">&#39;cart.updated&#39;</span>)<span class="op">;</span></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(updated<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(updated<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">total</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.7" id="testing-async-operations"><span
class="header-section-number">13.7</span> Testing Async Operations</h2>
<h3 data-number="13.7.1" id="testing-promises"><span
class="header-section-number">13.7.1</span> Testing Promises</h3>
<div class="sourceCode" id="cb153"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should load data&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> vi<span class="op">.</span><span class="fu">fn</span>()<span class="op">.</span><span class="fu">mockResolvedValueOnce</span>({</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">json</span><span class="op">:</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> ({ <span class="dt">items</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>] })</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;data-loader&#39;</span>)<span class="op">;</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> vi<span class="op">.</span><span class="fu">waitFor</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loaded <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">.</span><span class="fu">getLastPublished</span>(<span class="st">&#39;data.loaded&#39;</span>)<span class="op">;</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(loaded)<span class="op">.</span><span class="fu">toBeDefined</span>()<span class="op">;</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(loaded<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">.</span><span class="fu">toEqual</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.7.2" id="testing-errors"><span
class="header-section-number">13.7.2</span> Testing Errors</h3>
<div class="sourceCode" id="cb154"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should handle fetch errors&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> vi<span class="op">.</span><span class="fu">fn</span>()<span class="op">.</span><span class="fu">mockRejectedValueOnce</span>(</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Network error&#39;</span>)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;data-loader&#39;</span>)<span class="op">;</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> error <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">.</span><span class="fu">getLastPublished</span>(<span class="st">&#39;data.error&#39;</span>)<span class="op">;</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(error<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="st">&#39;Network error&#39;</span>)<span class="op">;</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.7.3" id="testing-timers"><span
class="header-section-number">13.7.3</span> Testing Timers</h3>
<div class="sourceCode" id="cb155"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;should save at intervals&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  vi<span class="op">.</span><span class="fu">useFakeTimers</span>()<span class="op">;</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;auto-saver&#39;</span>)<span class="op">;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>  vi<span class="op">.</span><span class="fu">advanceTimersByTime</span>(<span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(<span class="fu">getMockBus</span>()<span class="op">.</span><span class="fu">getPublished</span>(<span class="st">&#39;data.save&#39;</span>))<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  vi<span class="op">.</span><span class="fu">advanceTimersByTime</span>(<span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(<span class="fu">getMockBus</span>()<span class="op">.</span><span class="fu">getPublished</span>(<span class="st">&#39;data.save&#39;</span>))<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>  vi<span class="op">.</span><span class="fu">useRealTimers</span>()<span class="op">;</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.8" id="e2e-testing-with-playwright"><span
class="header-section-number">13.8</span> E2E Testing with
Playwright</h2>
<h3 data-number="13.8.1" id="setup"><span
class="header-section-number">13.8.1</span> Setup</h3>
<div class="sourceCode" id="cb156"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-D</span> @playwright/test</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> playwright install</span></code></pre></div>
<h3 data-number="13.8.2" id="e2e-test-example"><span
class="header-section-number">13.8.2</span> E2E Test Example</h3>
<div class="sourceCode" id="cb157"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/e2e/shopping-cart.spec.js</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { test<span class="op">,</span> expect } <span class="im">from</span> <span class="st">&#39;@playwright/test&#39;</span><span class="op">;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">describe</span>(<span class="st">&#39;Shopping Cart&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  test<span class="op">.</span><span class="fu">beforeEach</span>(<span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;http://localhost:3000&#39;</span>)<span class="op">;</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;should add item to cart&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">click</span>(<span class="st">&#39;button:has-text(&quot;Add to Cart&quot;)&#39;</span>)<span class="op">;</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> badge <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;cart-badge&#39;</span>)<span class="op">;</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(badge)<span class="op">.</span><span class="fu">toContainText</span>(<span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cart <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;shopping-cart&#39;</span>)<span class="op">;</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(cart)<span class="op">.</span><span class="fu">toContainText</span>(<span class="st">&#39;Widget&#39;</span>)<span class="op">;</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(cart)<span class="op">.</span><span class="fu">toContainText</span>(<span class="st">&#39;$10&#39;</span>)<span class="op">;</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;should persist cart after reload&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">click</span>(<span class="st">&#39;button:has-text(&quot;Add to Cart&quot;)&#39;</span>)<span class="op">;</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cart <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;shopping-cart&#39;</span>)<span class="op">;</span></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(cart)<span class="op">.</span><span class="fu">toContainText</span>(<span class="st">&#39;Widget&#39;</span>)<span class="op">;</span></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.8.3" id="testing-theme-switching"><span
class="header-section-number">13.8.3</span> Testing Theme Switching</h3>
<div class="sourceCode" id="cb158"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test</span>(<span class="st">&#39;should toggle dark mode&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;http://localhost:3000&#39;</span>)<span class="op">;</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> html <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;html&#39;</span>)<span class="op">;</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">expect</span>(html)<span class="op">.</span><span class="fu">toHaveAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> <span class="st">&#39;light&#39;</span>)<span class="op">;</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> page<span class="op">.</span><span class="fu">click</span>(<span class="st">&#39;button:has-text(&quot;Dark&quot;)&#39;</span>)<span class="op">;</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">expect</span>(html)<span class="op">.</span><span class="fu">toHaveAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> <span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> page<span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">expect</span>(html)<span class="op">.</span><span class="fu">toHaveAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> <span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.9" id="test-utilities"><span
class="header-section-number">13.9</span> Test Utilities</h2>
<h3 data-number="13.9.1" id="component-test-harness"><span
class="header-section-number">13.9.1</span> Component Test Harness</h3>
<div class="sourceCode" id="cb159"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/utils/component-harness.js</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ComponentHarness {</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(tagName<span class="op">,</span> attributes <span class="op">=</span> {}) {</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">element</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(tagName)<span class="op">;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [key<span class="op">,</span> value] <span class="kw">of</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(attributes)) {</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">setAttribute</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(<span class="kw">this</span><span class="op">.</span><span class="at">element</span>)<span class="op">;</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">query</span>(selector) {</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">querySelector</span>(selector)<span class="op">;</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>() {</span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">trim</span>()<span class="op">;</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">click</span>(selector) {</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> selector <span class="op">?</span> <span class="kw">this</span><span class="op">.</span><span class="fu">query</span>(selector) <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">;</span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">type</span>(selector<span class="op">,</span> value) {</span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">query</span>(selector)<span class="op">;</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">Event</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> { <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span> }))<span class="op">;</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">waitFor</span>(condition<span class="op">,</span> timeout <span class="op">=</span> <span class="dv">1000</span>) {</span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> start <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> start <span class="op">&lt;</span> timeout) {</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">condition</span>(<span class="kw">this</span><span class="op">.</span><span class="at">element</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">50</span>))<span class="op">;</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Timeout waiting for condition&#39;</span>)<span class="op">;</span></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">destroy</span>() {</span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">element</span><span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> { ComponentHarness }<span class="op">;</span></span></code></pre></div>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> harness <span class="op">=</span> <span class="kw">new</span> <span class="fu">ComponentHarness</span>(<span class="st">&#39;user-profile&#39;</span><span class="op">,</span> { <span class="st">&#39;user-id&#39;</span><span class="op">:</span> <span class="st">&#39;123&#39;</span> })<span class="op">;</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> harness<span class="op">.</span><span class="fu">waitFor</span>(el <span class="kw">=&gt;</span> el<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;Alice&#39;</span>))<span class="op">;</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">expect</span>(harness<span class="op">.</span><span class="fu">text</span>())<span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>harness<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.9.2" id="message-helper"><span
class="header-section-number">13.9.2</span> Message Helper</h3>
<div class="sourceCode" id="cb161"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/utils/message-helper.js</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MessageHelper {</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">bus</span> <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">;</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">publishAndWait</span>(publishTopic<span class="op">,</span> publishData<span class="op">,</span> waitTopic<span class="op">,</span> timeout <span class="op">=</span> <span class="dv">1000</span>) {</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Timeout waiting for </span><span class="sc">${</span>waitTopic<span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> timeout)<span class="op">;</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> unsubscribe <span class="op">=</span> <span class="fu">subscribe</span>(waitTopic<span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>        <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">publish</span>(publishTopic<span class="op">,</span> publishData)<span class="op">;</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assertPublished</span>(topic<span class="op">,</span> data <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> messages <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">bus</span><span class="op">.</span><span class="fu">getPublished</span>(topic)<span class="op">;</span></span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (messages<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Expected message on topic &quot;</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">&quot;`</span>)<span class="op">;</span></span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data <span class="op">!==</span> <span class="kw">null</span>) {</span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> match <span class="op">=</span> messages<span class="op">.</span><span class="fu">some</span>(msg <span class="kw">=&gt;</span></span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span>) <span class="op">===</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>match) {</span>
<span id="cb161-37"><a href="#cb161-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Expected message with data </span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb161-38"><a href="#cb161-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb161-39"><a href="#cb161-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-40"><a href="#cb161-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-41"><a href="#cb161-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb161-42"><a href="#cb161-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-43"><a href="#cb161-43" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> { MessageHelper }<span class="op">;</span></span></code></pre></div>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> helper <span class="op">=</span> <span class="kw">new</span> <span class="fu">MessageHelper</span>()<span class="op">;</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> helper<span class="op">.</span><span class="fu">publishAndWait</span>(</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;data.request&#39;</span><span class="op">,</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;data.response&#39;</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="fu">expect</span>(response<span class="op">.</span><span class="at">id</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">123</span>)<span class="op">;</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>helper<span class="op">.</span><span class="fu">assertPublished</span>(<span class="st">&#39;data.request&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.10" id="test-coverage"><span
class="header-section-number">13.10</span> Test Coverage</h2>
<p>Run tests with coverage:</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-D</span> @vitest/coverage-v8</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> vitest <span class="at">--coverage</span></span></code></pre></div>
<p><strong>Coverage Targets</strong>:</p>
<ul>
<li>Overall: 80%+</li>
<li>Critical paths (auth, payments): 100%</li>
<li>UI glue code: 50-70% acceptable</li>
</ul>
<h2 data-number="13.11" id="testing-checklist"><span
class="header-section-number">13.11</span> Testing Checklist</h2>
<table>
<thead>
<tr>
<th>Area</th>
<th>Unit Tests</th>
<th>Integration Tests</th>
<th>E2E Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td>Components render correctly</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Attributes update DOM</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Messages published</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Messages received</td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Multi-component flows</td>
<td></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>Message patterns</td>
<td></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>User workflows</td>
<td></td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td>Persistence</td>
<td></td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td>Theme switching</td>
<td></td>
<td></td>
<td>✓</td>
</tr>
</tbody>
</table>
<h2 data-number="13.12" id="complete-example-1"><span
class="header-section-number">13.12</span> Complete Example</h2>
<div class="sourceCode" id="cb164"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Full test suite for notification system</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { describe<span class="op">,</span> it<span class="op">,</span> expect<span class="op">,</span> beforeEach<span class="op">,</span> vi } <span class="im">from</span> <span class="st">&#39;vitest&#39;</span><span class="op">;</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { NotificationDisplay } <span class="im">from</span> <span class="st">&#39;../components/notification-display.mjs&#39;</span><span class="op">;</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { NotificationService } <span class="im">from</span> <span class="st">&#39;../services/notification-service.mjs&#39;</span><span class="op">;</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { getMockBus } <span class="im">from</span> <span class="st">&#39;./setup.js&#39;</span><span class="op">;</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Notification System&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> display<span class="op">,</span> service<span class="op">,</span> mockBus<span class="op">;</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>    mockBus <span class="op">=</span> <span class="fu">getMockBus</span>()<span class="op">;</span></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    display <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;notification-display&#39;</span>)<span class="op">;</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> <span class="kw">new</span> <span class="fu">NotificationService</span>()<span class="op">;</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(display)<span class="op">;</span></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should show notification&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Hello&#39;</span><span class="op">,</span> <span class="st">&#39;info&#39;</span>)<span class="op">;</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(display<span class="op">.</span><span class="at">notifications</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(display<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="fu">toContain</span>(<span class="st">&#39;Hello&#39;</span>)<span class="op">;</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should auto-dismiss after timeout&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>    vi<span class="op">.</span><span class="fu">useFakeTimers</span>()<span class="op">;</span></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Temporary&#39;</span><span class="op">,</span> <span class="st">&#39;info&#39;</span><span class="op">,</span> { <span class="dt">duration</span><span class="op">:</span> <span class="dv">3000</span> })<span class="op">;</span></span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(display<span class="op">.</span><span class="at">notifications</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a>    vi<span class="op">.</span><span class="fu">advanceTimersByTime</span>(<span class="dv">3000</span>)<span class="op">;</span></span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> vi<span class="op">.</span><span class="fu">waitFor</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(display<span class="op">.</span><span class="at">notifications</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a>    vi<span class="op">.</span><span class="fu">useRealTimers</span>()<span class="op">;</span></span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should handle multiple notifications&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;First&#39;</span><span class="op">,</span> <span class="st">&#39;info&#39;</span>)<span class="op">;</span></span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Second&#39;</span><span class="op">,</span> <span class="st">&#39;warning&#39;</span>)<span class="op">;</span></span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Third&#39;</span><span class="op">,</span> <span class="st">&#39;error&#39;</span>)<span class="op">;</span></span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(display<span class="op">.</span><span class="at">notifications</span>)<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb164-48"><a href="#cb164-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(mockBus<span class="op">.</span><span class="fu">getPublished</span>(<span class="st">&#39;notification.show&#39;</span>))<span class="op">.</span><span class="fu">toHaveLength</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb164-49"><a href="#cb164-49" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb164-50"><a href="#cb164-50" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.13" id="component-reference-9"><span
class="header-section-number">13.13</span> Component Reference</h2>
<p>See Chapter 17 (pan-bus) for testing message patterns.</p>
<h2 data-number="13.14" id="cross-references-10"><span
class="header-section-number">13.14</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 14
(Testing)</li>
<li><strong>Components</strong>: Chapter 17 (pan-bus testing
helpers)</li>
<li><strong>Patterns</strong>: Appendix E (Test patterns)</li>
<li><strong>Related</strong>: Chapter 12 (Performance), Chapter 14
(Debugging)</li>
</ul>
<h2 data-number="13.15" id="common-issues-10"><span
class="header-section-number">13.15</span> Common Issues</h2>
<h3 data-number="13.15.1" id="tests-failing-intermittently"><span
class="header-section-number">13.15.1</span> Tests failing
intermittently</h3>
<p><strong>Problem</strong>: Race conditions in async tests<br />
<strong>Solution</strong>: Use <code>vi.waitFor()</code> or
<code>await</code> properly, avoid fixed timeouts</p>
<h3 data-number="13.15.2" id="mock-bus-not-working"><span
class="header-section-number">13.15.2</span> Mock bus not working</h3>
<p><strong>Problem</strong>: Components using global
<code>publish</code>/<code>subscribe</code> before mock setup<br />
<strong>Solution</strong>: Import components after mock setup in
<code>beforeEach</code>, use dynamic imports</p>
<h3 data-number="13.15.3" id="e2e-tests-timing-out"><span
class="header-section-number">13.15.3</span> E2E tests timing out</h3>
<p><strong>Problem</strong>: Waiting for elements that never
appear<br />
<strong>Solution</strong>: Use Playwright’s auto-waiting, check network
requests, verify app is running</p>
<h3 data-number="13.15.4" id="coverage-not-including-files"><span
class="header-section-number">13.15.4</span> Coverage not including
files</h3>
<p><strong>Problem</strong>: Files not imported by tests<br />
<strong>Solution</strong>: Add files to test suite or use coverage
include patterns</p>
<h3 data-number="13.15.5" id="memory-leaks-in-tests"><span
class="header-section-number">13.15.5</span> Memory leaks in tests</h3>
<p><strong>Problem</strong>: Components not cleaned up<br />
<strong>Solution</strong>: Always remove components in
<code>afterEach</code>, clear timers with
<code>vi.useRealTimers()</code></p>
<h1 data-number="14" id="error-handling-and-debugging"><span
class="header-section-number">14</span> Error Handling and
Debugging</h1>
<p>Quick reference for error handling and debugging in LARC
applications. For detailed tutorials, see <em>Learning LARC</em> Chapter
14.</p>
<h2 data-number="14.1" id="overview-10"><span
class="header-section-number">14.1</span> Overview</h2>
<p>Handle errors gracefully through component-level error boundaries,
centralized error monitoring, and message tracing. LARC’s isolated
component architecture naturally contains errors, preventing cascading
failures.</p>
<p><strong>Key Concepts</strong>:</p>
<ul>
<li>Error boundaries contain failures within components</li>
<li>Global error handlers monitor application health</li>
<li>Message tracing tracks pub/sub flows</li>
<li>Structured logging provides debugging context</li>
<li>DevTools integration for professional debugging</li>
</ul>
<h2 data-number="14.2" id="quick-example-10"><span
class="header-section-number">14.2</span> Quick Example</h2>
<div class="sourceCode" id="cb165"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResilientComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.fetch&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchData</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.loaded&#39;</span><span class="op">,</span> { data })<span class="op">;</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.error&#39;</span><span class="op">,</span> {</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">component</span><span class="op">:</span> <span class="st">&#39;ResilientComponent&#39;</span><span class="op">,</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">context</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span> }</span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error)<span class="op">;</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(error) {</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;error&quot;&gt;</span></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        Error: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button onclick=&quot;location.reload()&quot;&gt;Retry&lt;/button&gt;</span></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.3" id="error-handling-patterns"><span
class="header-section-number">14.3</span> Error Handling Patterns</h2>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 40%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Description</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>Try-catch blocks</td>
<td>Catch synchronous errors</td>
<td>Immediate operations</td>
</tr>
<tr>
<td>Promise <code>.catch()</code></td>
<td>Handle async errors</td>
<td>Fetch, timeouts</td>
</tr>
<tr>
<td>Error boundaries</td>
<td>Contain component failures</td>
<td>Prevent cascading failures</td>
</tr>
<tr>
<td>Global error handler</td>
<td>Catch unhandled errors</td>
<td>Last line of defense</td>
</tr>
<tr>
<td>Error messages</td>
<td>Publish via PAN bus</td>
<td>Centralized monitoring</td>
</tr>
</tbody>
</table>
<h3 data-number="14.3.1" id="component-error-boundary"><span
class="header-section-number">14.3.1</span> Component Error
Boundary</h3>
<div class="sourceCode" id="cb166"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorBoundary <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">renderContent</span>()<span class="op">;</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Catch errors from child components</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> e<span class="op">.</span><span class="at">error</span> <span class="op">||</span> e<span class="op">;</span></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderContent</span>()<span class="op">;</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">stopPropagation</span>()<span class="op">;</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderContent</span>() {</span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">error</span>) {</span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;error-boundary&quot;&gt;</span></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;Something went wrong&lt;/h3&gt;</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span><span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;location.reload()&quot;&gt;Reload&lt;/button&gt;</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="14.3.2" id="global-error-monitor"><span
class="header-section-number">14.3.2</span> Global Error Monitor</h3>
<div class="sourceCode" id="cb167"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorMonitor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to error messages</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logError</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Catch global errors</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logError</span>({</span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> e<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source</span><span class="op">:</span> e<span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">line</span><span class="op">:</span> e<span class="op">.</span><span class="at">lineno</span></span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Catch promise rejections</span></span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;unhandledrejection&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logError</span>({</span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> e<span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Promise rejected&#39;</span><span class="op">,</span></span>
<span id="cb167-26"><a href="#cb167-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stack</span><span class="op">:</span> e<span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">stack</span></span>
<span id="cb167-27"><a href="#cb167-27" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb167-28"><a href="#cb167-28" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb167-29"><a href="#cb167-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-30"><a href="#cb167-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-31"><a href="#cb167-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logError</span>(error) {</span>
<span id="cb167-32"><a href="#cb167-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> entry <span class="op">=</span> {</span>
<span id="cb167-33"><a href="#cb167-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>error<span class="op">,</span></span>
<span id="cb167-34"><a href="#cb167-34" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb167-35"><a href="#cb167-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> location<span class="op">.</span><span class="at">href</span></span>
<span id="cb167-36"><a href="#cb167-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb167-37"><a href="#cb167-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-38"><a href="#cb167-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="fu">push</span>(entry)<span class="op">;</span></span>
<span id="cb167-39"><a href="#cb167-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;[App Error]&#39;</span><span class="op">,</span> entry)<span class="op">;</span></span>
<span id="cb167-40"><a href="#cb167-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-41"><a href="#cb167-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send to error tracking service</span></span>
<span id="cb167-42"><a href="#cb167-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">reportError</span>(entry)<span class="op">;</span></span>
<span id="cb167-43"><a href="#cb167-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-44"><a href="#cb167-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-45"><a href="#cb167-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reportError</span>(error) {</span>
<span id="cb167-46"><a href="#cb167-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">window</span><span class="op">.</span><span class="at">errorTracker</span>) {</span>
<span id="cb167-47"><a href="#cb167-47" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">errorTracker</span><span class="op">.</span><span class="fu">captureException</span>(error)<span class="op">;</span></span>
<span id="cb167-48"><a href="#cb167-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb167-49"><a href="#cb167-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-50"><a href="#cb167-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.4" id="message-tracing"><span
class="header-section-number">14.4</span> Message Tracing</h2>
<h3 data-number="14.4.1" id="enable-bus-debugging"><span
class="header-section-number">14.4.1</span> Enable Bus Debugging</h3>
<div class="sourceCode" id="cb168"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="ot"> enable-tracing</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="14.4.2" id="custom-message-tracer"><span
class="header-section-number">14.4.2</span> Custom Message Tracer</h3>
<div class="sourceCode" id="cb169"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MessageTracer <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">log</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">tracing</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">tracing</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">log</span><span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">topic</span><span class="op">:</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span><span class="op">,</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`%c[MSG] </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color: blue; font-weight: bold&#39;</span><span class="op">,</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>        msg<span class="op">.</span><span class="at">data</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">startTracing</span>() {</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">tracing</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">log</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopTracing</span>() {</span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">tracing</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">log</span><span class="op">;</span></span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exportLog</span>() {</span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> blob <span class="op">=</span> <span class="kw">new</span> <span class="bu">Blob</span>([<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">log</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)]<span class="op">,</span> {</span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span></span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob)<span class="op">;</span></span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)<span class="op">;</span></span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="vs">`message-trace-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">.json`</span><span class="op">;</span></span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.5" id="structured-logging"><span
class="header-section-number">14.5</span> Structured Logging</h2>
<div class="sourceCode" id="cb170"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Logger {</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">level</span> <span class="op">=</span> <span class="st">&#39;info&#39;</span><span class="op">;</span> <span class="co">// debug, info, warn, error</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span>(level<span class="op">,</span> message<span class="op">,</span> context <span class="op">=</span> {}) {</span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">shouldLog</span>(level)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> entry <span class="op">=</span> {</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>      level<span class="op">,</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>      message<span class="op">,</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>      context<span class="op">,</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sessionId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getSessionId</span>()</span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">output</span>(entry)<span class="op">;</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">send</span>(entry)<span class="op">;</span></span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shouldLog</span>(level) {</span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> levels <span class="op">=</span> [<span class="st">&#39;debug&#39;</span><span class="op">,</span> <span class="st">&#39;info&#39;</span><span class="op">,</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span> <span class="st">&#39;error&#39;</span>]<span class="op">;</span></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> levels<span class="op">.</span><span class="fu">indexOf</span>(level) <span class="op">&gt;=</span> levels<span class="op">.</span><span class="fu">indexOf</span>(<span class="kw">this</span><span class="op">.</span><span class="at">level</span>)<span class="op">;</span></span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">output</span>(entry) {</span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> styles <span class="op">=</span> {</span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">debug</span><span class="op">:</span> <span class="st">&#39;color: gray&#39;</span><span class="op">,</span></span>
<span id="cb170-29"><a href="#cb170-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">info</span><span class="op">:</span> <span class="st">&#39;color: blue&#39;</span><span class="op">,</span></span>
<span id="cb170-30"><a href="#cb170-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">warn</span><span class="op">:</span> <span class="st">&#39;color: orange&#39;</span><span class="op">,</span></span>
<span id="cb170-31"><a href="#cb170-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;color: red; font-weight: bold&#39;</span></span>
<span id="cb170-32"><a href="#cb170-32" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb170-33"><a href="#cb170-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-34"><a href="#cb170-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb170-35"><a href="#cb170-35" aria-hidden="true" tabindex="-1"></a>      <span class="vs">`%c[</span><span class="sc">${</span>entry<span class="op">.</span><span class="at">level</span><span class="op">.</span><span class="fu">toUpperCase</span>()<span class="sc">}</span><span class="vs">] </span><span class="sc">${</span>entry<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb170-36"><a href="#cb170-36" aria-hidden="true" tabindex="-1"></a>      styles[entry<span class="op">.</span><span class="at">level</span>]<span class="op">,</span></span>
<span id="cb170-37"><a href="#cb170-37" aria-hidden="true" tabindex="-1"></a>      entry<span class="op">.</span><span class="at">context</span></span>
<span id="cb170-38"><a href="#cb170-38" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb170-39"><a href="#cb170-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-40"><a href="#cb170-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-41"><a href="#cb170-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">send</span>(entry) {</span>
<span id="cb170-42"><a href="#cb170-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (entry<span class="op">.</span><span class="at">level</span> <span class="op">===</span> <span class="st">&#39;error&#39;</span> <span class="op">||</span> entry<span class="op">.</span><span class="at">level</span> <span class="op">===</span> <span class="st">&#39;warn&#39;</span>) {</span>
<span id="cb170-43"><a href="#cb170-43" aria-hidden="true" tabindex="-1"></a>      <span class="bu">navigator</span><span class="op">.</span><span class="fu">sendBeacon</span>(<span class="st">&#39;/api/logs&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(entry))<span class="op">;</span></span>
<span id="cb170-44"><a href="#cb170-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb170-45"><a href="#cb170-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-46"><a href="#cb170-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-47"><a href="#cb170-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSessionId</span>() {</span>
<span id="cb170-48"><a href="#cb170-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sessionStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;sessionId&#39;</span>) <span class="op">||</span> <span class="st">&#39;unknown&#39;</span><span class="op">;</span></span>
<span id="cb170-49"><a href="#cb170-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-50"><a href="#cb170-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-51"><a href="#cb170-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">debug</span>(message<span class="op">,</span> context) { <span class="kw">this</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;debug&#39;</span><span class="op">,</span> message<span class="op">,</span> context)<span class="op">;</span> }</span>
<span id="cb170-52"><a href="#cb170-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">info</span>(message<span class="op">,</span> context) { <span class="kw">this</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;info&#39;</span><span class="op">,</span> message<span class="op">,</span> context)<span class="op">;</span> }</span>
<span id="cb170-53"><a href="#cb170-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warn</span>(message<span class="op">,</span> context) { <span class="kw">this</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;warn&#39;</span><span class="op">,</span> message<span class="op">,</span> context)<span class="op">;</span> }</span>
<span id="cb170-54"><a href="#cb170-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">error</span>(message<span class="op">,</span> context) { <span class="kw">this</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> message<span class="op">,</span> context)<span class="op">;</span> }</span>
<span id="cb170-55"><a href="#cb170-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb170-56"><a href="#cb170-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-57"><a href="#cb170-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Global logger instance</span></span>
<span id="cb170-58"><a href="#cb170-58" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> logger <span class="op">=</span> <span class="kw">new</span> <span class="fu">Logger</span>()<span class="op">;</span></span>
<span id="cb170-59"><a href="#cb170-59" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> { logger }<span class="op">;</span></span></code></pre></div>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { logger } <span class="im">from</span> <span class="st">&#39;./logger.js&#39;</span><span class="op">;</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserService {</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">login</span>(username<span class="op">,</span> password) {</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>    logger<span class="op">.</span><span class="fu">info</span>(<span class="st">&#39;User login attempt&#39;</span><span class="op">,</span> { username })<span class="op">;</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/login&#39;</span><span class="op">,</span> {</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ username<span class="op">,</span> password })</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Login failed&#39;</span>)<span class="op">;</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">.</span><span class="fu">info</span>(<span class="st">&#39;User logged in&#39;</span><span class="op">,</span> { username<span class="op">,</span> <span class="dt">userId</span><span class="op">:</span> data<span class="op">.</span><span class="at">userId</span> })<span class="op">;</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>      logger<span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Login failed&#39;</span><span class="op">,</span> { username<span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.6" id="devtools-integration"><span
class="header-section-number">14.6</span> DevTools Integration</h2>
<h3 data-number="14.6.1" id="custom-console-formatters"><span
class="header-section-number">14.6.1</span> Custom Console
Formatters</h3>
<div class="sourceCode" id="cb172"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Enable custom formatters in Chrome DevTools</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">window</span><span class="op">.</span><span class="at">devtoolsFormatters</span>) {</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">devtoolsFormatters</span><span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">header</span>(obj) {</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>obj<span class="op">?.</span><span class="at">__larcMessage</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [<span class="st">&#39;div&#39;</span><span class="op">,</span> { <span class="dt">style</span><span class="op">:</span> <span class="st">&#39;color: #00f; font-weight: bold&#39;</span> }<span class="op">,</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`[LARC] </span><span class="sc">${</span>obj<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">;</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hasBody</span>(obj) {</span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> obj<span class="op">?.</span><span class="at">__larcMessage</span><span class="op">;</span></span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">body</span>(obj) {</span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> [<span class="st">&#39;div&#39;</span><span class="op">,</span> {}<span class="op">,</span></span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>        [<span class="st">&#39;div&#39;</span><span class="op">,</span> {}<span class="op">,</span> <span class="vs">`Topic: </span><span class="sc">${</span>obj<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">`</span>]<span class="op">,</span></span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>        [<span class="st">&#39;div&#39;</span><span class="op">,</span> {}<span class="op">,</span> <span class="vs">`Data: `</span><span class="op">,</span> [<span class="st">&#39;object&#39;</span><span class="op">,</span> { <span class="dt">object</span><span class="op">:</span> obj<span class="op">.</span><span class="at">data</span> }]]<span class="op">,</span></span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>        [<span class="st">&#39;div&#39;</span><span class="op">,</span> {}<span class="op">,</span> <span class="vs">`Time: </span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(obj<span class="op">.</span><span class="at">timestamp</span>)<span class="op">.</span><span class="fu">toISOString</span>()<span class="sc">}</span><span class="vs">`</span>]</span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a>      ]<span class="op">;</span></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="14.6.2" id="performance-monitoring-1"><span
class="header-section-number">14.6.2</span> Performance Monitoring</h3>
<div class="sourceCode" id="cb173"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PerformanceMonitor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> mark <span class="op">=</span> <span class="vs">`msg-</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>      <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(mark)<span class="op">;</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">performance</span><span class="op">.</span><span class="fu">measure</span>(msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> mark)<span class="op">;</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> entries <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByType</span>(<span class="st">&#39;measure&#39;</span>)<span class="op">;</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> latest <span class="op">=</span> entries[entries<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (latest<span class="op">.</span><span class="at">duration</span> <span class="op">&gt;</span> <span class="dv">16</span>) { <span class="co">// Slower than 60fps</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Slow handler: </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs"> took </span><span class="sc">${</span>latest<span class="op">.</span><span class="at">duration</span><span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>          bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;performance.warning&#39;</span><span class="op">,</span> {</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">topic</span><span class="op">:</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">duration</span><span class="op">:</span> latest<span class="op">.</span><span class="at">duration</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">performance</span><span class="op">.</span><span class="fu">clearMarks</span>(mark)<span class="op">;</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">performance</span><span class="op">.</span><span class="fu">clearMeasures</span>(msg<span class="op">.</span><span class="at">topic</span>)<span class="op">;</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.7" id="common-pitfalls"><span
class="header-section-number">14.7</span> Common Pitfalls</h2>
<h3 data-number="14.7.1" id="message-type-typos"><span
class="header-section-number">14.7.1</span> Message Type Typos</h3>
<p><strong>Problem</strong>: Misspelled message topics<br />
<strong>Solution</strong>: Use constants</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co">// messages.js</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> MSG <span class="op">=</span> {</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">USER_LOGIN</span><span class="op">:</span> <span class="st">&#39;user.login&#39;</span><span class="op">,</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">USER_LOGOUT</span><span class="op">:</span> <span class="st">&#39;user.logout&#39;</span><span class="op">,</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">CART_UPDATE</span><span class="op">:</span> <span class="st">&#39;cart.update&#39;</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { MSG } <span class="im">from</span> <span class="st">&#39;./messages.js&#39;</span><span class="op">;</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(MSG<span class="op">.</span><span class="at">USER_LOGIN</span><span class="op">,</span> { <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(MSG<span class="op">.</span><span class="at">USER_LOGIN</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> { <span class="co">/* works */</span> })<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.7.2" id="infinite-message-loops"><span
class="header-section-number">14.7.2</span> Infinite Message Loops</h3>
<p><strong>Problem</strong>: A → B → A → B forever<br />
<strong>Solution</strong>: Loop detection</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoopDetector <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stack</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">stack</span><span class="op">.</span><span class="fu">push</span>(msg<span class="op">.</span><span class="at">topic</span>)<span class="op">;</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> recent <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">stack</span><span class="op">.</span><span class="fu">slice</span>(<span class="op">-</span><span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> counts <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>      recent<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> counts[t] <span class="op">=</span> (counts[t] <span class="op">||</span> <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(counts)<span class="op">.</span><span class="fu">some</span>(c <span class="kw">=&gt;</span> c <span class="op">&gt;=</span> <span class="dv">3</span>)) {</span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Message loop detected:&#39;</span><span class="op">,</span> recent)<span class="op">;</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;system.loop-detected&#39;</span><span class="op">,</span> { <span class="dt">sequence</span><span class="op">:</span> recent })<span class="op">;</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">stack</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="14.7.3" id="async-race-conditions"><span
class="header-section-number">14.7.3</span> Async Race Conditions</h3>
<p><strong>Problem</strong>: Multiple overlapping async operations<br />
<strong>Solution</strong>: Request ID tracking</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadData</span>(id) {</span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentRequest <span class="op">=</span> <span class="op">++</span><span class="kw">this</span><span class="op">.</span><span class="at">requestId</span><span class="op">;</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/data/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Only update if still the latest request</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (currentRequest <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span>) {</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (currentRequest <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span>) {</span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error)<span class="op">;</span></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="14.7.4" id="stale-closures"><span
class="header-section-number">14.7.4</span> Stale Closures</h3>
<p><strong>Problem</strong>: Handler captures old state<br />
<strong>Solution</strong>: Always access <code>this.state</code>
directly</p>
<div class="sourceCode" id="cb177"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BadCounter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> count <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">;</span> <span class="co">// Captured at registration time</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;log&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(count)<span class="op">;</span> <span class="co">// Always logs initial value</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Good</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GoodCounter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;log&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">this</span><span class="op">.</span><span class="at">count</span>)<span class="op">;</span> <span class="co">// Always current value</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.8" id="debugging-checklist"><span
class="header-section-number">14.8</span> Debugging Checklist</h2>
<p>When something goes wrong:</p>
<ol type="1">
<li><strong>Is the message being sent?</strong>
<ul>
<li>Add <code>console.log()</code> before <code>publish()</code></li>
<li>Check MessageTracer</li>
</ul></li>
<li><strong>Is the topic correct?</strong>
<ul>
<li>Use message constants</li>
<li>Check for typos</li>
</ul></li>
<li><strong>Is the handler registered?</strong>
<ul>
<li>Verify <code>subscribe()</code> is called</li>
<li>Check component is mounted</li>
</ul></li>
<li><strong>Is the handler called?</strong>
<ul>
<li>Add breakpoint or <code>console.log()</code></li>
<li>Check wildcard patterns</li>
</ul></li>
<li><strong>Is state updating?</strong>
<ul>
<li>Log before/after changes</li>
<li>Check property names</li>
</ul></li>
<li><strong>Is render triggered?</strong>
<ul>
<li>Verify render method runs</li>
<li>Check for errors in render</li>
</ul></li>
<li><strong>Are there async issues?</strong>
<ul>
<li>Use request IDs</li>
<li>Check Promise handling</li>
</ul></li>
<li><strong>Is there a loop?</strong>
<ul>
<li>Use LoopDetector</li>
<li>Review message flow</li>
</ul></li>
</ol>
<h2 data-number="14.9" id="component-reference-10"><span
class="header-section-number">14.9</span> Component Reference</h2>
<p>See <strong>pan-debug</strong> (Chapter 21) for browser-based
debugging tools.</p>
<h2 data-number="14.10" id="complete-example-2"><span
class="header-section-number">14.10</span> Complete Example</h2>
<div class="sourceCode" id="cb178"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Full error handling setup</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global error monitor</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errorMonitor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;error-monitor&#39;</span>)<span class="op">;</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(errorMonitor)<span class="op">;</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Message tracer (dev only)</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="im">import</span><span class="op">.</span><span class="at">meta</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">DEV</span>) {</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> tracer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;message-tracer&#39;</span>)<span class="op">;</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>      tracer<span class="op">.</span><span class="fu">startTracing</span>()<span class="op">;</span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(tracer)<span class="op">;</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Loop detector</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loopDetector <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;loop-detector&#39;</span>)<span class="op">;</span></span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(loopDetector)<span class="op">;</span></span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Performance monitor</span></span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> perfMonitor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;performance-monitor&#39;</span>)<span class="op">;</span></span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(perfMonitor)<span class="op">;</span></span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to errors</span></span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showErrorNotification</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-29"><a href="#cb178-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showErrorNotification</span>(error) {</span>
<span id="cb178-30"><a href="#cb178-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> notification <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb178-31"><a href="#cb178-31" aria-hidden="true" tabindex="-1"></a>    notification<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;error-notification&#39;</span><span class="op">;</span></span>
<span id="cb178-32"><a href="#cb178-32" aria-hidden="true" tabindex="-1"></a>    notification<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> error<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb178-33"><a href="#cb178-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(notification)<span class="op">;</span></span>
<span id="cb178-34"><a href="#cb178-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-35"><a href="#cb178-35" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> notification<span class="op">.</span><span class="fu">remove</span>()<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb178-36"><a href="#cb178-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-37"><a href="#cb178-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="14.11" id="cross-references-11"><span
class="header-section-number">14.11</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 14 (Error
Handling &amp; Debugging)</li>
<li><strong>Components</strong>: Chapter 21 (pan-debug)</li>
<li><strong>Patterns</strong>: Appendix E (Error patterns)</li>
<li><strong>Related</strong>: Chapter 12 (Performance), Chapter 13
(Testing)</li>
</ul>
<h2 data-number="14.12" id="common-issues-11"><span
class="header-section-number">14.12</span> Common Issues</h2>
<h3 data-number="14.12.1" id="errors-not-caught"><span
class="header-section-number">14.12.1</span> Errors not caught</h3>
<p><strong>Problem</strong>: Errors in async code not handled<br />
<strong>Solution</strong>: Always use try-catch or
<code>.catch()</code>, add global error handlers</p>
<h3 data-number="14.12.2" id="missing-stack-traces"><span
class="header-section-number">14.12.2</span> Missing stack traces</h3>
<p><strong>Problem</strong>: Error stack is lost<br />
<strong>Solution</strong>: Preserve <code>error.stack</code> when
re-throwing or logging</p>
<h3 data-number="14.12.3" id="too-much-logging-in-production"><span
class="header-section-number">14.12.3</span> Too much logging in
production</h3>
<p><strong>Problem</strong>: Console spam, performance impact<br />
<strong>Solution</strong>: Set log level to ‘warn’ or ‘error’ in
production, use conditional logging</p>
<h3 data-number="14.12.4" id="cant-reproduce-bug"><span
class="header-section-number">14.12.4</span> Can’t reproduce bug</h3>
<p><strong>Problem</strong>: Error only happens for some users<br />
<strong>Solution</strong>: Add user context to logs, enable remote error
tracking (Sentry, LogRocket)</p>
<h3 data-number="14.12.5" id="debug-mode-left-on"><span
class="header-section-number">14.12.5</span> Debug mode left on</h3>
<p><strong>Problem</strong>: Debug code in production<br />
<strong>Solution</strong>: Use environment variables, build-time dead
code elimination</p>
<h1 data-number="15" id="advanced-patterns-1"><span
class="header-section-number">15</span> Advanced Patterns</h1>
<p>Quick reference for advanced LARC architecture patterns. For detailed
tutorials, see <em>Learning LARC</em> Chapter 7.</p>
<h2 data-number="15.1" id="overview-11"><span
class="header-section-number">15.1</span> Overview</h2>
<p>Advanced patterns for complex scenarios: message bridging, multi-bus
architectures, backend integration, micro-frontends, and plugin systems.
These patterns solve scalability and modularity challenges in large
applications.</p>
<p><strong>Key Concepts:</strong> - Message bridging between buses -
Domain-segregated architectures - API gateway patterns - Micro-frontend
integration - Plugin/middleware systems</p>
<h2 data-number="15.2" id="quick-example-11"><span
class="header-section-number">15.2</span> Quick Example</h2>
<div class="sourceCode" id="cb179"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bidirectional bridge between two buses</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BidirectionalBridge {</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(busA<span class="op">,</span> busB<span class="op">,</span> config) {</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">busA</span> <span class="op">=</span> busA<span class="op">;</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">busB</span> <span class="op">=</span> busB<span class="op">;</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forward A → B</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="at">aToB</span><span class="op">.</span><span class="fu">forEach</span>(type <span class="kw">=&gt;</span> {</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>      busA<span class="op">.</span><span class="fu">subscribe</span>(type<span class="op">,</span> msg <span class="kw">=&gt;</span> busB<span class="op">.</span><span class="fu">publish</span>(type<span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>))<span class="op">;</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forward B → A</span></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="at">bToA</span><span class="op">.</span><span class="fu">forEach</span>(type <span class="kw">=&gt;</span> {</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>      busB<span class="op">.</span><span class="fu">subscribe</span>(type<span class="op">,</span> msg <span class="kw">=&gt;</span> busA<span class="op">.</span><span class="fu">publish</span>(type<span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>))<span class="op">;</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bridge <span class="op">=</span> <span class="kw">new</span> <span class="fu">BidirectionalBridge</span>(mainBus<span class="op">,</span> widgetBus<span class="op">,</span> {</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">aToB</span><span class="op">:</span> [<span class="st">&#39;theme.changed&#39;</span><span class="op">,</span> <span class="st">&#39;user.login&#39;</span>]<span class="op">,</span></span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bToA</span><span class="op">:</span> [<span class="st">&#39;widget.action&#39;</span>]</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.3" id="message-bridging-patterns"><span
class="header-section-number">15.3</span> Message Bridging Patterns</h2>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 30%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Use Case</th>
<th>Key Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Basic Forward</strong></td>
<td>One-way message relay</td>
<td>Simple topic mapping</td>
</tr>
<tr>
<td><strong>Bidirectional</strong></td>
<td>Two-way communication</td>
<td>Transform and filter support</td>
</tr>
<tr>
<td><strong>Translation</strong></td>
<td>Protocol conversion</td>
<td>Type and data transformation</td>
</tr>
<tr>
<td><strong>Hierarchical</strong></td>
<td>Parent-child buses</td>
<td>Bubble-up and propagate-down</td>
</tr>
</tbody>
</table>
<h2 data-number="15.4" id="backend-integration-patterns"><span
class="header-section-number">15.4</span> Backend Integration
Patterns</h2>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 30%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Use Case</th>
<th>Key Features</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>API Gateway</strong></td>
<td>Centralized HTTP calls</td>
<td>Request queue, offline support</td>
</tr>
<tr>
<td><strong>WebSocket Bridge</strong></td>
<td>Real-time bidirectional</td>
<td>Auto-reconnect, message queue</td>
</tr>
<tr>
<td><strong>GraphQL Client</strong></td>
<td>Structured queries</td>
<td>Response caching, mutation invalidation</td>
</tr>
</tbody>
</table>
<h2 data-number="15.5" id="common-patterns-1"><span
class="header-section-number">15.5</span> Common Patterns</h2>
<h3 data-number="15.5.1" id="pattern-1-api-gateway-component"><span
class="header-section-number">15.5.1</span> Pattern 1: API Gateway
Component</h3>
<p>Centralize all API calls with offline support.</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> APIGateway <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;api.request&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { method<span class="op">,</span> endpoint<span class="op">,</span> data<span class="op">,</span> requestId } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>          method<span class="op">,</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">token</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>          }<span class="op">,</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">body</span><span class="op">:</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data) <span class="op">:</span> <span class="kw">undefined</span></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`HTTP </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.success&#39;</span><span class="op">,</span> { requestId<span class="op">,</span> result })<span class="op">;</span></span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.error&#39;</span><span class="op">,</span> { requestId<span class="op">,</span> <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;api-gateway&#39;</span><span class="op">,</span> APIGateway)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In any component</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.request&#39;</span><span class="op">,</span> {</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;GET&#39;</span><span class="op">,</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">endpoint</span><span class="op">:</span> <span class="st">&#39;/users/123&#39;</span><span class="op">,</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">requestId</span><span class="op">:</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;api.success&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">requestId</span> <span class="op">===</span> myRequestId) {</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">result</span><span class="op">;</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="15.5.2" id="pattern-2-micro-frontend-loader"><span
class="header-section-number">15.5.2</span> Pattern 2: Micro-Frontend
Loader</h3>
<p>Load remote modules dynamically.</p>
<div class="sourceCode" id="cb182"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MicroFrontendLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadModule</span>(name<span class="op">,</span> url<span class="op">,</span> props) {</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> module <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="co">/* webpackIgnore: true */</span> url)<span class="op">;</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> instance <span class="op">=</span> <span class="kw">new</span> module<span class="op">.</span><span class="fu">default</span>(props)<span class="op">;</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">modules</span><span class="op">.</span><span class="fu">set</span>(name<span class="op">,</span> instance)<span class="op">;</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;module-loaded&#39;</span><span class="op">,</span> { </span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">detail</span><span class="op">:</span> { name } </span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Failed to load module </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unloadModule</span>(name) {</span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> module <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">modules</span><span class="op">.</span><span class="fu">get</span>(name)<span class="op">;</span></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (module<span class="op">?.</span><span class="at">destroy</span>) module<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">modules</span><span class="op">.</span><span class="fu">delete</span>(name)<span class="op">;</span></span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loader <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;mf-loader&#39;</span>)<span class="op">;</span></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> loader<span class="op">.</span><span class="fu">loadModule</span>(<span class="st">&#39;cart&#39;</span><span class="op">,</span> <span class="st">&#39;https://cdn.example.com/cart.js&#39;</span><span class="op">,</span> {</span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bus</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">,</span></span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">apiEndpoint</span><span class="op">:</span> <span class="st">&#39;/api/cart&#39;</span></span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="15.5.3" id="pattern-3-plugin-registry-with-hooks"><span
class="header-section-number">15.5.3</span> Pattern 3: Plugin Registry
with Hooks</h3>
<p>Extensible plugin system.</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PluginRegistry {</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(bus) {</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">bus</span> <span class="op">=</span> bus<span class="op">;</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">plugins</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hooks</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">register</span>(id<span class="op">,</span> plugin) {</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize plugin</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>    plugin<span class="op">.</span><span class="fu">init</span>({ <span class="dt">bus</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">bus</span> })<span class="op">;</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register hooks</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (plugin<span class="op">.</span><span class="at">hooks</span>) {</span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(plugin<span class="op">.</span><span class="at">hooks</span>)<span class="op">.</span><span class="fu">forEach</span>(([hookName<span class="op">,</span> handler]) <span class="kw">=&gt;</span> {</span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">hooks</span><span class="op">.</span><span class="fu">has</span>(hookName)) {</span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="at">hooks</span><span class="op">.</span><span class="fu">set</span>(hookName<span class="op">,</span> [])<span class="op">;</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">hooks</span><span class="op">.</span><span class="fu">get</span>(hookName)<span class="op">.</span><span class="fu">push</span>({ id<span class="op">,</span> handler })<span class="op">;</span></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">plugins</span><span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> plugin)<span class="op">;</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">executeHook</span>(hookName<span class="op">,</span> data) {</span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">hooks</span><span class="op">.</span><span class="fu">get</span>(hookName) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> { handler } <span class="kw">of</span> handlers) {</span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a>      result <span class="op">=</span> <span class="cf">await</span> <span class="fu">handler</span>(result)<span class="op">;</span></span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb183-34"><a href="#cb183-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb183-35"><a href="#cb183-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb183-36"><a href="#cb183-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-37"><a href="#cb183-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Plugin example</span></span>
<span id="cb183-38"><a href="#cb183-38" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> analyticsPlugin <span class="op">=</span> {</span>
<span id="cb183-39"><a href="#cb183-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>({ bus }) {</span>
<span id="cb183-40"><a href="#cb183-40" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb183-41"><a href="#cb183-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">gtag</span>(<span class="st">&#39;event&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb183-42"><a href="#cb183-42" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb183-43"><a href="#cb183-43" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb183-44"><a href="#cb183-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-45"><a href="#cb183-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">hooks</span><span class="op">:</span> {</span>
<span id="cb183-46"><a href="#cb183-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;before-submit&#39;</span><span class="op">:</span> (formData) <span class="kw">=&gt;</span> {</span>
<span id="cb183-47"><a href="#cb183-47" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Analytics: Form submit&#39;</span><span class="op">,</span> formData)<span class="op">;</span></span>
<span id="cb183-48"><a href="#cb183-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> formData<span class="op">;</span></span>
<span id="cb183-49"><a href="#cb183-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb183-50"><a href="#cb183-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb183-51"><a href="#cb183-51" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb183-52"><a href="#cb183-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-53"><a href="#cb183-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb183-54"><a href="#cb183-54" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> registry <span class="op">=</span> <span class="kw">new</span> <span class="fu">PluginRegistry</span>(bus)<span class="op">;</span></span>
<span id="cb183-55"><a href="#cb183-55" aria-hidden="true" tabindex="-1"></a>registry<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;analytics&#39;</span><span class="op">,</span> analyticsPlugin)<span class="op">;</span></span>
<span id="cb183-56"><a href="#cb183-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-57"><a href="#cb183-57" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> registry<span class="op">.</span><span class="fu">executeHook</span>(<span class="st">&#39;before-submit&#39;</span><span class="op">,</span> formData)<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.6" id="architecture-tables"><span
class="header-section-number">15.6</span> Architecture Tables</h2>
<h3 data-number="15.6.1" id="multi-bus-architecture"><span
class="header-section-number">15.6.1</span> Multi-Bus Architecture</h3>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 18%" />
<col style="width: 18%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Approach</th>
<th>Pros</th>
<th>Cons</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Domain-Segregated</strong></td>
<td>Clear boundaries, testable</td>
<td>More complexity</td>
<td>Large apps with distinct domains</td>
</tr>
<tr>
<td><strong>Hierarchical</strong></td>
<td>Natural parent-child</td>
<td>Bubble/propagate overhead</td>
<td>Nested module systems</td>
</tr>
<tr>
<td><strong>Federated</strong></td>
<td>Independent deployment</td>
<td>Coordination needed</td>
<td>Micro-frontends</td>
</tr>
</tbody>
</table>
<h3 data-number="15.6.2" id="middleware-patterns"><span
class="header-section-number">15.6.2</span> Middleware Patterns</h3>
<table>
<thead>
<tr>
<th>Type</th>
<th>Use Case</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Logging</strong></td>
<td>Debug message flow</td>
<td>Log all messages</td>
</tr>
<tr>
<td><strong>Rate Limiting</strong></td>
<td>Prevent spam</td>
<td>Max 10 msgs/sec/topic</td>
</tr>
<tr>
<td><strong>Transform</strong></td>
<td>Add metadata</td>
<td>Inject timestamp, userId</td>
</tr>
<tr>
<td><strong>Auth</strong></td>
<td>Protect actions</td>
<td>Check token before API calls</td>
</tr>
<tr>
<td><strong>Error Handling</strong></td>
<td>Catch failures</td>
<td>Try/catch middleware chain</td>
</tr>
</tbody>
</table>
<h2 data-number="15.7" id="complete-example-3"><span
class="header-section-number">15.7</span> Complete Example</h2>
<p>Multi-domain e-commerce app with API gateway, WebSocket, and plugin
system.</p>
<div class="sourceCode" id="cb184"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Create domain buses</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> buses <span class="op">=</span> {</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">auth</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">,</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cart</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">,</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ui</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;pan-bus&#39;</span>)</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span><span class="op">.</span><span class="fu">values</span>(buses)<span class="op">.</span><span class="fu">forEach</span>(bus <span class="kw">=&gt;</span> <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(bus))<span class="op">;</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Bridge auth events to UI</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>buses<span class="op">.</span><span class="at">auth</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>  buses<span class="op">.</span><span class="at">ui</span><span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> {</span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="vs">`Welcome, </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">username</span><span class="sc">}</span><span class="vs">!`</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. API Gateway on auth bus</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthAPI <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus[domain=&quot;auth&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;auth.login&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/login&#39;</span><span class="op">,</span> {</span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span>)</span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> { token<span class="op">,</span> user } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;token&#39;</span><span class="op">,</span> token)<span class="op">;</span></span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;auth-api&#39;</span><span class="op">,</span> AuthAPI)<span class="op">;</span></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a><span class="co">// 4. WebSocket bridge for cart updates</span></span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CartSocket <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="st">&#39;wss://example.com/cart&#39;</span>)<span class="op">;</span></span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus[domain=&quot;cart&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb184-44"><a href="#cb184-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-45"><a href="#cb184-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb184-46"><a href="#cb184-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> update <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb184-47"><a href="#cb184-47" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.updated&#39;</span><span class="op">,</span> update)<span class="op">;</span></span>
<span id="cb184-48"><a href="#cb184-48" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb184-49"><a href="#cb184-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb184-50"><a href="#cb184-50" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.add-item&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb184-51"><a href="#cb184-51" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb184-52"><a href="#cb184-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;add&#39;</span><span class="op">,</span></span>
<span id="cb184-53"><a href="#cb184-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">item</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span></span>
<span id="cb184-54"><a href="#cb184-54" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb184-55"><a href="#cb184-55" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-56"><a href="#cb184-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-57"><a href="#cb184-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-58"><a href="#cb184-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-59"><a href="#cb184-59" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;cart-socket&#39;</span><span class="op">,</span> CartSocket)<span class="op">;</span></span>
<span id="cb184-60"><a href="#cb184-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-61"><a href="#cb184-61" aria-hidden="true" tabindex="-1"></a><span class="co">// 5. Plugin system</span></span>
<span id="cb184-62"><a href="#cb184-62" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> registry <span class="op">=</span> <span class="kw">new</span> <span class="fu">PluginRegistry</span>(buses<span class="op">.</span><span class="at">ui</span>)<span class="op">;</span></span>
<span id="cb184-63"><a href="#cb184-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-64"><a href="#cb184-64" aria-hidden="true" tabindex="-1"></a>registry<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;analytics&#39;</span><span class="op">,</span> {</span>
<span id="cb184-65"><a href="#cb184-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>({ bus }) {</span>
<span id="cb184-66"><a href="#cb184-66" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb184-67"><a href="#cb184-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">gtag</span>(<span class="st">&#39;event&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb184-68"><a href="#cb184-68" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-69"><a href="#cb184-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-70"><a href="#cb184-70" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb184-71"><a href="#cb184-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-72"><a href="#cb184-72" aria-hidden="true" tabindex="-1"></a>registry<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;error-handler&#39;</span><span class="op">,</span> {</span>
<span id="cb184-73"><a href="#cb184-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>({ bus }) {</span>
<span id="cb184-74"><a href="#cb184-74" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb184-75"><a href="#cb184-75" aria-hidden="true" tabindex="-1"></a>      Sentry<span class="op">.</span><span class="fu">captureException</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb184-76"><a href="#cb184-76" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-77"><a href="#cb184-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-78"><a href="#cb184-78" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.8" id="component-reference-11"><span
class="header-section-number">15.8</span> Component Reference</h2>
<p>See Chapter 17 for core PAN Bus API documentation.</p>
<h2 data-number="15.9" id="cross-references-12"><span
class="header-section-number">15.9</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 7
(Advanced Patterns)</li>
<li><strong>Components</strong>: Chapter 17 (pan-bus), Chapter 20
(integration components)</li>
<li><strong>Backend Integration</strong>: Chapter 7 (Data Fetching),
Chapter 9 (Realtime Features)</li>
<li><strong>Testing</strong>: Chapter 13 (mocking bridges and
plugins)</li>
</ul>
<h2 data-number="15.10" id="common-issues-12"><span
class="header-section-number">15.10</span> Common Issues</h2>
<h3 data-number="15.10.1" id="bridge-message-loops"><span
class="header-section-number">15.10.1</span> Bridge Message Loops</h3>
<p><strong>Problem</strong>: Messages bounce between bridges
infinitely<br />
<strong>Solution</strong>: Add loop detection with message IDs or use
one-way bridges</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> processedIds <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (processedIds<span class="op">.</span><span class="fu">has</span>(msg<span class="op">.</span><span class="at">id</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>  processedIds<span class="op">.</span><span class="fu">add</span>(msg<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Forward to other bus...</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Clean up old IDs</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (processedIds<span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> <span class="dv">1000</span>) {</span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>    processedIds<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="15.10.2" id="plugin-hook-failures"><span
class="header-section-number">15.10.2</span> Plugin Hook Failures</h3>
<p><strong>Problem</strong>: One plugin failure breaks entire hook
chain<br />
<strong>Solution</strong>: Wrap hooks in try/catch</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">executeHook</span>(hookName<span class="op">,</span> data) {</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">hooks</span><span class="op">.</span><span class="fu">get</span>(hookName) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> result <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> { id<span class="op">,</span> handler } <span class="kw">of</span> handlers) {</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>      result <span class="op">=</span> <span class="cf">await</span> <span class="fu">handler</span>(result)<span class="op">;</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Plugin </span><span class="sc">${</span>id<span class="sc">}</span><span class="vs"> hook </span><span class="sc">${</span>hookName<span class="sc">}</span><span class="vs"> failed:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Continue with other plugins</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="15.10.3" id="websocket-reconnect-storms"><span
class="header-section-number">15.10.3</span> WebSocket Reconnect
Storms</h3>
<p><strong>Problem</strong>: Exponential backoff too aggressive or too
slow<br />
<strong>Solution</strong>: Use capped exponential backoff</p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attemptReconnect</span>() {</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span><span class="op">++;</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Min 1s, max 30s, exponential between</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span>)<span class="op">,</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">30000</span></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">connect</span>()<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="15.10.4" id="micro-frontend-memory-leaks"><span
class="header-section-number">15.10.4</span> Micro-Frontend Memory
Leaks</h3>
<p><strong>Problem</strong>: Modules not properly cleaned up on
unload<br />
<strong>Solution</strong>: Enforce destroy lifecycle</p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unloadModule</span>(name) {</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> module <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">modules</span><span class="op">.</span><span class="fu">get</span>(name)<span class="op">;</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>module) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Call destroy if exists</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (module<span class="op">.</span><span class="at">destroy</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> module<span class="op">.</span><span class="at">destroy</span> <span class="op">===</span> <span class="st">&#39;function&#39;</span>) {</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>      module<span class="op">.</span><span class="fu">destroy</span>()<span class="op">;</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Module </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs"> destroy failed:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Remove DOM elements</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`[data-module=&quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (container) container<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">modules</span><span class="op">.</span><span class="fu">delete</span>(name)<span class="op">;</span></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="15.10.5" id="middleware-performance"><span
class="header-section-number">15.10.5</span> Middleware Performance</h3>
<p><strong>Problem</strong>: Too many middleware slow down message
delivery<br />
<strong>Solution</strong>: Profile and optimize critical path</p>
<div class="sourceCode" id="cb189"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add timing middleware in dev mode</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="im">import</span><span class="op">.</span><span class="at">meta</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">DEV</span>) {</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  registry<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;timing&#39;</span><span class="op">,</span> {</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">priority</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="co">// Run first</span></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">middleware</span><span class="op">:</span> <span class="kw">async</span> (context) <span class="kw">=&gt;</span> {</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> start <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>      context <span class="op">=</span> <span class="cf">await</span> <span class="fu">next</span>(context)<span class="op">;</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> duration <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (duration <span class="op">&gt;</span> <span class="dv">16</span>) { <span class="co">// Longer than 1 frame</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Slow middleware for </span><span class="sc">${</span>context<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>duration<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> context<span class="op">;</span></span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>See Also</strong>: <em>Learning LARC</em> Chapter 7 for
hands-on advanced pattern tutorials.</p>
<h1 data-number="16" id="deployment-and-production"><span
class="header-section-number">16</span> Deployment and Production</h1>
<p>Quick reference for deploying LARC applications to production. For
detailed tutorials, see <em>Learning LARC</em> Chapter 16.</p>
<h2 data-number="16.1" id="overview-12"><span
class="header-section-number">16.1</span> Overview</h2>
<p>LARC applications deploy as static files with optional build
optimization. No complex pipelines required—serve vanilla JavaScript
directly or optimize with minimal tooling.</p>
<p><strong>Key Concepts:</strong> - No-build deployment option -
Optional esbuild optimization - CDN deployment strategies - Caching
policies - Performance monitoring - Production debugging tools</p>
<h2 data-number="16.2" id="quick-example-12"><span
class="header-section-number">16.2</span> Quick Example</h2>
<div class="sourceCode" id="cb190"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Minimal esbuild configuration</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> esbuild <span class="im">from</span> <span class="st">&#39;esbuild&#39;</span><span class="op">;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> esbuild<span class="op">.</span><span class="fu">build</span>({</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">entryPoints</span><span class="op">:</span> [<span class="st">&#39;src/app.js&#39;</span>]<span class="op">,</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bundle</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minify</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sourcemap</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">target</span><span class="op">:</span> [<span class="st">&#39;es2020&#39;</span>]<span class="op">,</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">outfile</span><span class="op">:</span> <span class="st">&#39;dist/app.js&#39;</span><span class="op">,</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;esm&#39;</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Deploy <code>dist/</code> folder to any static host (Cloudflare
Pages, Netlify, Vercel).</p>
<h2 data-number="16.3" id="build-options"><span
class="header-section-number">16.3</span> Build Options</h2>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Use Case</th>
<th>Complexity</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>No Build</strong></td>
<td>Small apps, rapid prototyping</td>
<td>None</td>
</tr>
<tr>
<td><strong>esbuild</strong></td>
<td>Production optimization</td>
<td>Minimal</td>
</tr>
<tr>
<td><strong>Code Splitting</strong></td>
<td>Large apps with routing</td>
<td>Low</td>
</tr>
<tr>
<td><strong>TypeScript</strong></td>
<td>Type safety</td>
<td>Medium</td>
</tr>
</tbody>
</table>
<h3 data-number="16.3.1" id="build-configuration-example"><span
class="header-section-number">16.3.1</span> Build Configuration
Example</h3>
<div class="sourceCode" id="cb191"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="st">&quot;node build.js&quot;</span><span class="fu">,</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;dev&quot;</span><span class="fu">:</span> <span class="st">&quot;node build.js --watch&quot;</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="16.4" id="cdn-deployment"><span
class="header-section-number">16.4</span> CDN Deployment</h2>
<h3 data-number="16.4.1" id="platform-commands"><span
class="header-section-number">16.4.1</span> Platform Commands</h3>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Command</th>
<th>Config File</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Cloudflare Pages</strong></td>
<td><code>wrangler pages publish dist</code></td>
<td><code>_headers</code></td>
</tr>
<tr>
<td><strong>Netlify</strong></td>
<td><code>netlify deploy --dir=dist --prod</code></td>
<td><code>netlify.toml</code></td>
</tr>
<tr>
<td><strong>Vercel</strong></td>
<td><code>vercel --prod</code></td>
<td><code>vercel.json</code></td>
</tr>
</tbody>
</table>
<h3 data-number="16.4.2" id="cache-headers"><span
class="header-section-number">16.4.2</span> Cache Headers</h3>
<pre><code># _headers (Cloudflare)
/*.js
  Cache-Control: public, max-age=31536000, immutable

/index.html
  Cache-Control: no-cache

/service-worker.js
  Cache-Control: no-cache</code></pre>
<h2 data-number="16.5" id="common-patterns-2"><span
class="header-section-number">16.5</span> Common Patterns</h2>
<h3 data-number="16.5.1" id="pattern-1-service-worker-caching"><span
class="header-section-number">16.5.1</span> Pattern 1: Service Worker
Caching</h3>
<p>Offline support and faster loads.</p>
<div class="sourceCode" id="cb193"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">// service-worker.js</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CACHE_NAME <span class="op">=</span> <span class="st">&#39;larc-app-v1&#39;</span><span class="op">;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> URLS_TO_CACHE <span class="op">=</span> [<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="st">&#39;/index.html&#39;</span><span class="op">,</span> <span class="st">&#39;/app.js&#39;</span><span class="op">,</span> <span class="st">&#39;/styles.css&#39;</span>]<span class="op">;</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;install&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">waitUntil</span>(</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">open</span>(CACHE_NAME)</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(cache <span class="kw">=&gt;</span> cache<span class="op">.</span><span class="fu">addAll</span>(URLS_TO_CACHE))</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;fetch&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">respondWith</span>(</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">match</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>)</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response <span class="op">||</span> <span class="fu">fetch</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>))</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Register in app</span></span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">&#39;serviceWorker&#39;</span> <span class="kw">in</span> <span class="bu">navigator</span>) {</span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a>  <span class="bu">navigator</span><span class="op">.</span><span class="at">serviceWorker</span><span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/service-worker.js&#39;</span>)<span class="op">;</span></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="16.5.2" id="pattern-2-performance-monitoring"><span
class="header-section-number">16.5.2</span> Pattern 2: Performance
Monitoring</h3>
<p>Track Core Web Vitals.</p>
<div class="sourceCode" id="cb194"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PerformanceMonitor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Largest Contentful Paint</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> entries <span class="op">=</span> list<span class="op">.</span><span class="fu">getEntries</span>()<span class="op">;</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> lcp <span class="op">=</span> entries[entries<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">sendMetric</span>(<span class="st">&#39;lcp&#39;</span><span class="op">,</span> lcp<span class="op">.</span><span class="at">renderTime</span> <span class="op">||</span> lcp<span class="op">.</span><span class="at">loadTime</span>)<span class="op">;</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;largest-contentful-paint&#39;</span>] })<span class="op">;</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First Input Delay</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> list<span class="op">.</span><span class="fu">getEntries</span>()) {</span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> fid <span class="op">=</span> entry<span class="op">.</span><span class="at">processingStart</span> <span class="op">-</span> entry<span class="op">.</span><span class="at">startTime</span><span class="op">;</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">sendMetric</span>(<span class="st">&#39;fid&#39;</span><span class="op">,</span> fid)<span class="op">;</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;first-input&#39;</span>] })<span class="op">;</span></span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cumulative Layout Shift</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> clsScore <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> list<span class="op">.</span><span class="fu">getEntries</span>()) {</span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="op">!</span>entry<span class="op">.</span><span class="at">hadRecentInput</span>) clsScore <span class="op">+=</span> entry<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">sendMetric</span>(<span class="st">&#39;cls&#39;</span><span class="op">,</span> clsScore)<span class="op">;</span></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;layout-shift&#39;</span>] })<span class="op">;</span></span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sendMetric</span>(name<span class="op">,</span> value) {</span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">navigator</span><span class="op">.</span><span class="fu">sendBeacon</span>(<span class="st">&#39;/api/metrics&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">metric</span><span class="op">:</span> name<span class="op">,</span></span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a>      value<span class="op">,</span></span>
<span id="cb194-32"><a href="#cb194-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> location<span class="op">.</span><span class="at">pathname</span><span class="op">,</span></span>
<span id="cb194-33"><a href="#cb194-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb194-34"><a href="#cb194-34" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb194-35"><a href="#cb194-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb194-36"><a href="#cb194-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb194-37"><a href="#cb194-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-38"><a href="#cb194-38" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;perf-monitor&#39;</span><span class="op">,</span> PerformanceMonitor)<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.5.3" id="pattern-3-error-tracking"><span
class="header-section-number">16.5.3</span> Pattern 3: Error
Tracking</h3>
<p>Production error monitoring.</p>
<div class="sourceCode" id="cb195"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorTracker <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global errors</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">trackError</span>({</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> e<span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stack</span><span class="op">:</span> e<span class="op">.</span><span class="at">error</span><span class="op">?.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">source</span><span class="op">:</span> e<span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">line</span><span class="op">:</span> e<span class="op">.</span><span class="at">lineno</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unhandled promise rejections</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;unhandledrejection&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">trackError</span>({</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> e<span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Promise rejected&#39;</span><span class="op">,</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stack</span><span class="op">:</span> e<span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">stack</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trackError</span>(error) {</span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">navigator</span><span class="op">.</span><span class="fu">sendBeacon</span>(<span class="st">&#39;/api/errors&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>error<span class="op">,</span></span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">,</span></span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> location<span class="op">.</span><span class="at">href</span><span class="op">,</span></span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userAgent</span><span class="op">:</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">userAgent</span></span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;error-tracker&#39;</span><span class="op">,</span> ErrorTracker)<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.5.4" id="pattern-4-feature-flags"><span
class="header-section-number">16.5.4</span> Pattern 4: Feature
Flags</h3>
<p>Control features without redeployment.</p>
<div class="sourceCode" id="cb196"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeatureFlags <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load flags from server</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/feature-flags&#39;</span>)<span class="op">;</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">flags</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;flags.loaded&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">flags</span>)<span class="op">;</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check flags</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;flags.check&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { flag<span class="op">,</span> defaultValue } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> enabled <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">flags</span>[flag] <span class="op">??</span> defaultValue<span class="op">;</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;flags.result&#39;</span><span class="op">,</span> { flag<span class="op">,</span> enabled })<span class="op">;</span></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in components</span></span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;flags.check&#39;</span><span class="op">,</span> { <span class="dt">flag</span><span class="op">:</span> <span class="st">&#39;new-feature&#39;</span><span class="op">,</span> <span class="dt">defaultValue</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;flags.result&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">flag</span> <span class="op">===</span> <span class="st">&#39;new-feature&#39;</span> <span class="op">&amp;&amp;</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">enabled</span>) {</span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show new feature</span></span>
<span id="cb196-25"><a href="#cb196-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-26"><a href="#cb196-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.6" id="caching-strategies-1"><span
class="header-section-number">16.6</span> Caching Strategies</h2>
<table>
<thead>
<tr>
<th>Resource Type</th>
<th>Cache Duration</th>
<th>Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>HTML</strong></td>
<td>No cache</td>
<td><code>no-cache, must-revalidate</code></td>
</tr>
<tr>
<td><strong>JavaScript/CSS</strong></td>
<td>1 year</td>
<td><code>public, max-age=31536000, immutable</code></td>
</tr>
<tr>
<td><strong>Images</strong></td>
<td>30 days</td>
<td><code>public, max-age=2592000</code></td>
</tr>
<tr>
<td><strong>API Responses</strong></td>
<td>5 minutes</td>
<td>Client-side cache with invalidation</td>
</tr>
</tbody>
</table>
<h3 data-number="16.6.1" id="api-response-caching"><span
class="header-section-number">16.6.1</span> API Response Caching</h3>
<div class="sourceCode" id="cb197"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CachedAPIClient <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cacheDuration</span> <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 5 minutes</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(method<span class="op">,</span> endpoint<span class="op">,</span> data) {</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>method<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check cache for GET</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (method <span class="op">===</span> <span class="st">&#39;GET&#39;</span>) {</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cached <span class="op">&amp;&amp;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">&lt;</span> cached<span class="op">.</span><span class="at">expiresAt</span>) {</span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cached<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fetch from API</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> {</span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a>      method<span class="op">,</span></span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data) <span class="op">:</span> <span class="kw">undefined</span></span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cache GET responses</span></span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (method <span class="op">===</span> <span class="st">&#39;GET&#39;</span>) {</span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> {</span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> result<span class="op">,</span></span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">expiresAt</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">cacheDuration</span></span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Invalidate cache on mutations</span></span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="16.7" id="performance-metrics"><span
class="header-section-number">16.7</span> Performance Metrics</h2>
<h3 data-number="16.7.1" id="core-web-vitals-targets"><span
class="header-section-number">16.7.1</span> Core Web Vitals Targets</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Good</th>
<th>Needs Improvement</th>
<th>Poor</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LCP</strong> (Largest Contentful Paint)</td>
<td>≤2.5s</td>
<td>2.5-4s</td>
<td>&gt;4s</td>
</tr>
<tr>
<td><strong>FID</strong> (First Input Delay)</td>
<td>≤100ms</td>
<td>100-300ms</td>
<td>&gt;300ms</td>
</tr>
<tr>
<td><strong>CLS</strong> (Cumulative Layout Shift)</td>
<td>≤0.1</td>
<td>0.1-0.25</td>
<td>&gt;0.25</td>
</tr>
<tr>
<td><strong>TTFB</strong> (Time to First Byte)</td>
<td>≤800ms</td>
<td>800-1800ms</td>
<td>&gt;1800ms</td>
</tr>
</tbody>
</table>
<h3 data-number="16.7.2" id="custom-performance-marks"><span
class="header-section-number">16.7.2</span> Custom Performance
Marks</h3>
<div class="sourceCode" id="cb198"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Track specific operations</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="st">&#39;load-start&#39;</span>)<span class="op">;</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">fetchData</span>()<span class="op">;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="st">&#39;load-end&#39;</span>)<span class="op">;</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">measure</span>(<span class="st">&#39;data-load&#39;</span><span class="op">,</span> <span class="st">&#39;load-start&#39;</span><span class="op">,</span> <span class="st">&#39;load-end&#39;</span>)<span class="op">;</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> measurement <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByName</span>(<span class="st">&#39;data-load&#39;</span>)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Data load: </span><span class="sc">${</span>measurement<span class="op">.</span><span class="at">duration</span><span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.8" id="complete-example-4"><span
class="header-section-number">16.8</span> Complete Example</h2>
<p>Production-ready deployment with monitoring.</p>
<div class="sourceCode" id="cb199"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co">// build.js - Build script with optimization</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> esbuild <span class="im">from</span> <span class="st">&#39;esbuild&#39;</span><span class="op">;</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { statSync } <span class="im">from</span> <span class="st">&#39;fs&#39;</span><span class="op">;</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> esbuild<span class="op">.</span><span class="fu">build</span>({</span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">entryPoints</span><span class="op">:</span> [<span class="st">&#39;src/app.js&#39;</span>]<span class="op">,</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bundle</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minify</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sourcemap</span><span class="op">:</span> <span class="st">&#39;external&#39;</span><span class="op">,</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">target</span><span class="op">:</span> [<span class="st">&#39;es2020&#39;</span>]<span class="op">,</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">outfile</span><span class="op">:</span> <span class="st">&#39;dist/app.js&#39;</span><span class="op">,</span></span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">metafile</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Check bundle size</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stats <span class="op">=</span> <span class="fu">statSync</span>(<span class="st">&#39;dist/app.js&#39;</span>)<span class="op">;</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sizeKB <span class="op">=</span> (stats<span class="op">.</span><span class="at">size</span> <span class="op">/</span> <span class="dv">1024</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Bundle: </span><span class="sc">${</span>sizeKB<span class="sc">}</span><span class="vs"> KB`</span>)<span class="op">;</span></span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="pp">parseFloat</span>(sizeKB) <span class="op">&gt;</span> <span class="dv">500</span>) {</span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Bundle too large: </span><span class="sc">${</span>sizeKB<span class="sc">}</span><span class="vs"> KB`</span>)<span class="op">;</span></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a><span class="co">// index.html - Production HTML</span></span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>html lang<span class="op">=</span><span class="st">&quot;en&quot;</span><span class="op">&gt;</span></span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>head<span class="op">&gt;</span></span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>meta charset<span class="op">=</span><span class="st">&quot;UTF-8&quot;</span><span class="op">&gt;</span></span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>meta name<span class="op">=</span><span class="st">&quot;viewport&quot;</span> content<span class="op">=</span><span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="op">&gt;</span></span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>title<span class="op">&gt;</span>LARC App<span class="op">&lt;/</span>title<span class="op">&gt;</span></span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>script type<span class="op">=</span><span class="st">&quot;module&quot;</span> src<span class="op">=</span><span class="st">&quot;/app.js&quot;</span><span class="op">&gt;&lt;/</span>script<span class="op">&gt;</span></span>
<span id="cb199-32"><a href="#cb199-32" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>head<span class="op">&gt;</span></span>
<span id="cb199-33"><a href="#cb199-33" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>body<span class="op">&gt;</span></span>
<span id="cb199-34"><a href="#cb199-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> Core components <span class="op">--&gt;</span></span>
<span id="cb199-35"><a href="#cb199-35" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>pan<span class="op">-</span>bus debug<span class="op">=</span><span class="st">&quot;false&quot;</span><span class="op">&gt;&lt;/</span>pan<span class="op">-</span>bus<span class="op">&gt;</span></span>
<span id="cb199-36"><a href="#cb199-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>error<span class="op">-</span>tracker<span class="op">&gt;&lt;/</span>error<span class="op">-</span>tracker<span class="op">&gt;</span></span>
<span id="cb199-37"><a href="#cb199-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>perf<span class="op">-</span>monitor<span class="op">&gt;&lt;/</span>perf<span class="op">-</span>monitor<span class="op">&gt;</span></span>
<span id="cb199-38"><a href="#cb199-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>feature<span class="op">-</span>flags<span class="op">&gt;&lt;/</span>feature<span class="op">-</span>flags<span class="op">&gt;</span></span>
<span id="cb199-39"><a href="#cb199-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-40"><a href="#cb199-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;!--</span> App <span class="bu">root</span> <span class="op">--&gt;</span></span>
<span id="cb199-41"><a href="#cb199-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>div id<span class="op">=</span><span class="st">&quot;app&quot;</span><span class="op">&gt;&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb199-42"><a href="#cb199-42" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>body<span class="op">&gt;</span></span>
<span id="cb199-43"><a href="#cb199-43" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>html<span class="op">&gt;</span></span>
<span id="cb199-44"><a href="#cb199-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-45"><a href="#cb199-45" aria-hidden="true" tabindex="-1"></a><span class="co">// netlify.toml - Netlify configuration</span></span>
<span id="cb199-46"><a href="#cb199-46" aria-hidden="true" tabindex="-1"></a>[build]</span>
<span id="cb199-47"><a href="#cb199-47" aria-hidden="true" tabindex="-1"></a>  publish <span class="op">=</span> <span class="st">&quot;dist&quot;</span></span>
<span id="cb199-48"><a href="#cb199-48" aria-hidden="true" tabindex="-1"></a>  command <span class="op">=</span> <span class="st">&quot;npm run build&quot;</span></span>
<span id="cb199-49"><a href="#cb199-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-50"><a href="#cb199-50" aria-hidden="true" tabindex="-1"></a>[[headers]]</span>
<span id="cb199-51"><a href="#cb199-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">=</span> <span class="st">&quot;/*.js&quot;</span></span>
<span id="cb199-52"><a href="#cb199-52" aria-hidden="true" tabindex="-1"></a>  [headers<span class="op">.</span><span class="at">values</span>]</span>
<span id="cb199-53"><a href="#cb199-53" aria-hidden="true" tabindex="-1"></a>    Cache<span class="op">-</span>Control <span class="op">=</span> <span class="st">&quot;public, max-age=31536000, immutable&quot;</span></span>
<span id="cb199-54"><a href="#cb199-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-55"><a href="#cb199-55" aria-hidden="true" tabindex="-1"></a>[[headers]]</span>
<span id="cb199-56"><a href="#cb199-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb199-57"><a href="#cb199-57" aria-hidden="true" tabindex="-1"></a>  [headers<span class="op">.</span><span class="at">values</span>]</span>
<span id="cb199-58"><a href="#cb199-58" aria-hidden="true" tabindex="-1"></a>    Cache<span class="op">-</span>Control <span class="op">=</span> <span class="st">&quot;no-cache&quot;</span></span>
<span id="cb199-59"><a href="#cb199-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-60"><a href="#cb199-60" aria-hidden="true" tabindex="-1"></a>[[redirects]]</span>
<span id="cb199-61"><a href="#cb199-61" aria-hidden="true" tabindex="-1"></a>  <span class="im">from</span> <span class="op">=</span> <span class="st">&quot;/*&quot;</span></span>
<span id="cb199-62"><a href="#cb199-62" aria-hidden="true" tabindex="-1"></a>  to <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb199-63"><a href="#cb199-63" aria-hidden="true" tabindex="-1"></a>  status <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb199-64"><a href="#cb199-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-65"><a href="#cb199-65" aria-hidden="true" tabindex="-1"></a><span class="co">// app.js - Application entry</span></span>
<span id="cb199-66"><a href="#cb199-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./core/pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb199-67"><a href="#cb199-67" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/error-tracker.js&#39;</span><span class="op">;</span></span>
<span id="cb199-68"><a href="#cb199-68" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/perf-monitor.js&#39;</span><span class="op">;</span></span>
<span id="cb199-69"><a href="#cb199-69" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/feature-flags.js&#39;</span><span class="op">;</span></span>
<span id="cb199-70"><a href="#cb199-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-71"><a href="#cb199-71" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb199-72"><a href="#cb199-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-73"><a href="#cb199-73" aria-hidden="true" tabindex="-1"></a><span class="co">// Wait for initialization</span></span>
<span id="cb199-74"><a href="#cb199-74" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;pan:sys.ready&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb199-75"><a href="#cb199-75" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;LARC app initialized&#39;</span>)<span class="op">;</span></span>
<span id="cb199-76"><a href="#cb199-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-77"><a href="#cb199-77" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Register service worker</span></span>
<span id="cb199-78"><a href="#cb199-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">&#39;serviceWorker&#39;</span> <span class="kw">in</span> <span class="bu">navigator</span>) {</span>
<span id="cb199-79"><a href="#cb199-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">navigator</span><span class="op">.</span><span class="at">serviceWorker</span><span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/service-worker.js&#39;</span>)</span>
<span id="cb199-80"><a href="#cb199-80" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Service worker registered&#39;</span>))</span>
<span id="cb199-81"><a href="#cb199-81" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;SW registration failed:&#39;</span><span class="op">,</span> err))<span class="op">;</span></span>
<span id="cb199-82"><a href="#cb199-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-83"><a href="#cb199-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-84"><a href="#cb199-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Load main app</span></span>
<span id="cb199-85"><a href="#cb199-85" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span>(<span class="st">&#39;./main.js&#39;</span>)<span class="op">.</span><span class="fu">then</span>(module <span class="kw">=&gt;</span> {</span>
<span id="cb199-86"><a href="#cb199-86" aria-hidden="true" tabindex="-1"></a>    module<span class="op">.</span><span class="fu">init</span>(bus)<span class="op">;</span></span>
<span id="cb199-87"><a href="#cb199-87" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb199-88"><a href="#cb199-88" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.9" id="deployment-checklist"><span
class="header-section-number">16.9</span> Deployment Checklist</h2>
<p>Pre-deployment verification:</p>
<ul class="task-list">
<li><label><input type="checkbox" />Tests pass</label></li>
<li><label><input type="checkbox" />Bundle minified and under size
limit</label></li>
<li><label><input type="checkbox" />Source maps generated (protected in
production)</label></li>
<li><label><input type="checkbox" />Cache headers
configured</label></li>
<li><label><input type="checkbox" />Service worker registered (if
using)</label></li>
<li><label><input type="checkbox" />Error tracking enabled</label></li>
<li><label><input type="checkbox" />Performance monitoring
active</label></li>
<li><label><input type="checkbox" />Feature flags
configured</label></li>
<li><label><input type="checkbox" />Environment variables
set</label></li>
<li><label><input type="checkbox" />SSL certificate valid</label></li>
<li><label><input type="checkbox" />CDN configured</label></li>
<li><label><input type="checkbox" />Monitoring alerts set
up</label></li>
<li><label><input type="checkbox" />Rollback plan
documented</label></li>
</ul>
<h2 data-number="16.10" id="component-reference-12"><span
class="header-section-number">16.10</span> Component Reference</h2>
<ul>
<li>Performance monitoring: Use native PerformanceObserver API</li>
<li>Error tracking: Integrate with Sentry, Rollbar, or custom
backend</li>
<li>Feature flags: Server-side control with client-side caching</li>
</ul>
<h2 data-number="16.11" id="cross-references-13"><span
class="header-section-number">16.11</span> Cross-References</h2>
<ul>
<li><strong>Tutorial</strong>: <em>Learning LARC</em> Chapter 16
(Deployment)</li>
<li><strong>Performance</strong>: Chapter 12 (Performance
Optimization)</li>
<li><strong>Testing</strong>: Chapter 13 (Testing Strategies)</li>
<li><strong>Error Handling</strong>: Chapter 14 (Error Handling and
Debugging)</li>
<li><strong>Configuration</strong>: Appendix C (Build and Deploy
Configuration)</li>
</ul>
<h2 data-number="16.12" id="common-issues-13"><span
class="header-section-number">16.12</span> Common Issues</h2>
<h3 data-number="16.12.1" id="service-worker-not-updating"><span
class="header-section-number">16.12.1</span> Service Worker Not
Updating</h3>
<p><strong>Problem</strong>: Users see stale cached content<br />
<strong>Solution</strong>: Implement cache versioning and force
update</p>
<div class="sourceCode" id="cb200"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CACHE_NAME <span class="op">=</span> <span class="st">&#39;larc-app-v2&#39;</span><span class="op">;</span> <span class="co">// Increment version</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;activate&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">waitUntil</span>(</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">keys</span>()<span class="op">.</span><span class="fu">then</span>(keys <span class="kw">=&gt;</span> {</span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>        keys<span class="op">.</span><span class="fu">map</span>(key <span class="kw">=&gt;</span> {</span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (key <span class="op">!==</span> CACHE_NAME) {</span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> caches<span class="op">.</span><span class="fu">delete</span>(key)<span class="op">;</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.12.2" id="source-maps-exposed-to-public"><span
class="header-section-number">16.12.2</span> Source Maps Exposed to
Public</h3>
<p><strong>Problem</strong>: Source maps leak implementation
details<br />
<strong>Solution</strong>: Serve source maps only to authenticated
users</p>
<div class="sourceCode" id="cb201"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Edge function</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(request) {</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(request<span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (url<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.map&#39;</span>)) {</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> token <span class="op">=</span> request<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;Authorization&#39;</span>)<span class="op">;</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="fu">isValidDevToken</span>(token)) {</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(<span class="st">&#39;Unauthorized&#39;</span><span class="op">,</span> { <span class="dt">status</span><span class="op">:</span> <span class="dv">401</span> })<span class="op">;</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">fetch</span>(request)<span class="op">;</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.12.3" id="cache-invalidation-after-deploy"><span
class="header-section-number">16.12.3</span> Cache Invalidation After
Deploy</h3>
<p><strong>Problem</strong>: Users load old cached assets with new
HTML<br />
<strong>Solution</strong>: Use cache busting with content hashes</p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co">// build.js - Add hash to filenames</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { createHash } <span class="im">from</span> <span class="st">&#39;crypto&#39;</span><span class="op">;</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="fu">readFileSync</span>(<span class="st">&#39;dist/app.js&#39;</span>)<span class="op">;</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hash <span class="op">=</span> <span class="fu">createHash</span>(<span class="st">&#39;sha256&#39;</span>)</span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">update</span>(content)</span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">digest</span>(<span class="st">&#39;hex&#39;</span>)</span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a><span class="fu">renameSync</span>(<span class="st">&#39;dist/app.js&#39;</span><span class="op">,</span> <span class="vs">`dist/app.</span><span class="sc">${</span>hash<span class="sc">}</span><span class="vs">.js`</span>)<span class="op">;</span></span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Update HTML references</span></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> html <span class="op">=</span> <span class="fu">readFileSync</span>(<span class="st">&#39;src/index.html&#39;</span><span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)<span class="op">;</span></span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>html <span class="op">=</span> html<span class="op">.</span><span class="fu">replace</span>(<span class="st">&#39;app.js&#39;</span><span class="op">,</span> <span class="vs">`app.</span><span class="sc">${</span>hash<span class="sc">}</span><span class="vs">.js`</span>)<span class="op">;</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a><span class="fu">writeFileSync</span>(<span class="st">&#39;dist/index.html&#39;</span><span class="op">,</span> html)<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.12.4" id="performance-metrics-not-reporting"><span
class="header-section-number">16.12.4</span> Performance Metrics Not
Reporting</h3>
<p><strong>Problem</strong>: sendBeacon blocked by CORS or content
blockers<br />
<strong>Solution</strong>: Use fallback and proper CORS headers</p>
<div class="sourceCode" id="cb203"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sendMetric</span>(name<span class="op">,</span> value) {</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> payload <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">metric</span><span class="op">:</span> name<span class="op">,</span> value })<span class="op">;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Try sendBeacon first</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> sent <span class="op">=</span> <span class="bu">navigator</span><span class="op">.</span><span class="fu">sendBeacon</span>(<span class="st">&#39;/api/metrics&#39;</span><span class="op">,</span> payload)<span class="op">;</span></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fallback to fetch</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>sent) {</span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(<span class="st">&#39;/api/metrics&#39;</span><span class="op">,</span> {</span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> payload<span class="op">,</span></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">keepalive</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Metric send failed:&#39;</span><span class="op">,</span> err))<span class="op">;</span></span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="16.12.5" id="bundle-size-exceeds-limits"><span
class="header-section-number">16.12.5</span> Bundle Size Exceeds
Limits</h3>
<p><strong>Problem</strong>: Build fails due to large bundle<br />
<strong>Solution</strong>: Implement code splitting and lazy loading</p>
<div class="sourceCode" id="cb204"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Router with lazy loading</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">loadRoute</span>(route) {</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> module <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="vs">`./routes/</span><span class="sc">${</span>route<span class="sc">}</span><span class="vs">.js`</span>)<span class="op">;</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> module<span class="op">.</span><span class="fu">default</span>()<span class="op">;</span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co">// esbuild with splitting</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> esbuild<span class="op">.</span><span class="fu">build</span>({</span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">entryPoints</span><span class="op">:</span> [<span class="st">&#39;src/app.js&#39;</span><span class="op">,</span> <span class="st">&#39;src/routes/*.js&#39;</span>]<span class="op">,</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bundle</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">splitting</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;esm&#39;</span><span class="op">,</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">outdir</span><span class="op">:</span> <span class="st">&#39;dist&#39;</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.12.6" id="update-notifications-not-showing"><span
class="header-section-number">16.12.6</span> Update Notifications Not
Showing</h3>
<p><strong>Problem</strong>: Users miss version updates<br />
<strong>Solution</strong>: Implement version check with notification</p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UpdateChecker <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentVersion <span class="op">=</span> <span class="st">&#39;1.2.3&#39;</span><span class="op">;</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/version.json&#39;</span><span class="op">,</span> { <span class="dt">cache</span><span class="op">:</span> <span class="st">&#39;no-cache&#39;</span> })<span class="op">;</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { version } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (version <span class="op">!==</span> currentVersion) {</span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;update-banner&quot;&gt;</span></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          New version available!</span></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;location.reload()&quot;&gt;Refresh&lt;/button&gt;</span></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb205-15"><a href="#cb205-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb205-16"><a href="#cb205-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-17"><a href="#cb205-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb205-18"><a href="#cb205-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-19"><a href="#cb205-19" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;update-checker&#39;</span><span class="op">,</span> UpdateChecker)<span class="op">;</span></span></code></pre></div>
<p><strong>See Also</strong>: <em>Learning LARC</em> Chapter 16 for
step-by-step deployment tutorials.</p>
<h1 data-number="17" id="core-components-reference"><span
class="header-section-number">17</span> Core Components Reference</h1>
<p>API documentation for LARC’s core components. For tutorials, see
<em>Learning LARC</em> Chapters 4-5.</p>
<h2 data-number="17.1" id="pan-bus"><span
class="header-section-number">17.1</span> pan-bus</h2>
<p><strong>Purpose</strong>: Message bus for decoupled component
communication via pub/sub <strong>Import</strong>:
<code>&lt;script type="module" src="/core/pan-bus.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="17.1.1" id="quick-example-13"><span
class="header-section-number">17.1.1</span> Quick Example</h3>
<div class="sourceCode" id="cb206"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> })<span class="op">;</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="17.1.2" id="attributes"><span
class="header-section-number">17.1.2</span> Attributes</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>max-retained</code></td>
<td>Integer</td>
<td>1000</td>
<td>Max retained messages (LRU eviction)</td>
</tr>
<tr>
<td><code>max-message-size</code></td>
<td>Integer</td>
<td>1048576 (1MB)</td>
<td>Max message size (bytes)</td>
</tr>
<tr>
<td><code>cleanup-interval</code></td>
<td>Integer</td>
<td>30000 (30s)</td>
<td>Cleanup interval (ms)</td>
</tr>
<tr>
<td><code>rate-limit</code></td>
<td>Integer</td>
<td>1000</td>
<td>Max messages/client/second</td>
</tr>
<tr>
<td><code>allow-global-wildcard</code></td>
<td>Boolean</td>
<td>true</td>
<td>Allow <code>*</code> wildcard subscriptions</td>
</tr>
<tr>
<td><code>debug</code></td>
<td>Boolean</td>
<td>false</td>
<td>Enable console logging</td>
</tr>
<tr>
<td><code>enable-routing</code></td>
<td>Boolean</td>
<td>false</td>
<td>Enable declarative routing</td>
</tr>
<tr>
<td><code>enable-tracing</code></td>
<td>Boolean</td>
<td>false</td>
<td>Enable message tracing</td>
</tr>
</tbody>
</table>
<h3 data-number="17.1.3" id="methods"><span
class="header-section-number">17.1.3</span> Methods</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>publish(topic, data, options)</code></td>
<td>topic: String, data: Any, options?: Object</td>
<td>undefined</td>
<td>Publish message</td>
</tr>
<tr>
<td><code>subscribe(topics, handler)</code></td>
<td>topics: String|Array, handler: Function</td>
<td>Function</td>
<td>Subscribe (returns unsubscribe fn)</td>
</tr>
<tr>
<td><code>PanBusEnhanced.matches(topic, pattern)</code></td>
<td>topic: String, pattern: String</td>
<td>Boolean</td>
<td>Test if topic matches pattern</td>
</tr>
</tbody>
</table>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb207"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> { <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;config&#39;</span><span class="op">,</span> { <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> }<span class="op">,</span> { <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsub <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Unsubscribe</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a><span class="fu">unsub</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="17.1.4" id="events"><span
class="header-section-number">17.1.4</span> Events</h3>
<p><strong>Incoming</strong> (components dispatch these):</p>
<ul>
<li><code>pan:hello</code> - Register client:
<code>{ id, caps }</code></li>
<li><code>pan:subscribe</code> - Subscribe:
<code>{ topics, clientId, options }</code></li>
<li><code>pan:unsubscribe</code> - Unsubscribe:
<code>{ topics, clientId }</code></li>
<li><code>pan:publish</code> - Publish:
<code>{ topic, data, retain, clientId }</code></li>
<li><code>pan:request</code> - Request (like publish):
<code>{ topic, data, requestId }</code></li>
<li><code>pan:sys.stats</code> - Get statistics</li>
<li><code>pan:sys.clear-retained</code> - Clear retained:
<code>{ pattern? }</code></li>
</ul>
<p><strong>Outgoing</strong> (bus dispatches these):</p>
<ul>
<li><code>pan:sys.ready</code> - Bus ready:
<code>{ enhanced, routing, tracing, config }</code></li>
<li><code>pan:sys.error</code> - Error:
<code>{ code, message, details }</code></li>
<li><code>pan:deliver</code> - Deliver message:
<code>{ topic, data, id, ts, ...extras }</code></li>
</ul>
<h3 data-number="17.1.5" id="complete-example-5"><span
class="header-section-number">17.1.5</span> Complete Example</h3>
<div class="sourceCode" id="cb208"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publisher component</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;button id=&quot;login&quot;&gt;Login&lt;/button&gt;&#39;</span><span class="op">;</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#login&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> {</span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">userId</span><span class="op">:</span> <span class="st">&#39;123&#39;</span><span class="op">,</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span></span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscriber component</span></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dashboard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-22"><a href="#cb208-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb208-23"><a href="#cb208-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;h1&gt;Welcome, </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">!&lt;/h1&gt;`</span><span class="op">;</span></span>
<span id="cb208-24"><a href="#cb208-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb208-25"><a href="#cb208-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb208-26"><a href="#cb208-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-27"><a href="#cb208-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb208-28"><a href="#cb208-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb208-29"><a href="#cb208-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb208-30"><a href="#cb208-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb208-31"><a href="#cb208-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-32"><a href="#cb208-32" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;login-form&#39;</span><span class="op">,</span> LoginForm)<span class="op">;</span></span>
<span id="cb208-33"><a href="#cb208-33" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;dash-board&#39;</span><span class="op">,</span> Dashboard)<span class="op">;</span></span></code></pre></div>
<h3 data-number="17.1.6" id="common-issues-14"><span
class="header-section-number">17.1.6</span> Common Issues</h3>
<p><strong>Messages not delivered</strong>: Wait for
<code>pan:sys.ready</code> event or check <code>window.__panReady</code>
<strong>Memory leaks</strong>: Always unsubscribe in
<code>disconnectedCallback()</code> <strong>Rate limiting</strong>:
Increase <code>rate-limit</code> attribute for high-frequency apps
<strong>JSON errors</strong>: Payloads must be JSON-serializable (no
functions, DOM nodes, circular refs)</p>
<h3 data-number="17.1.7" id="errors"><span
class="header-section-number">17.1.7</span> Errors</h3>
<p>The pan-bus component dispatches <code>pan:sys.error</code> events
for error conditions:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RATE_LIMIT</code></td>
<td>Client exceeds rate limit</td>
<td>Increase <code>rate-limit</code> attribute or reduce publish
frequency</td>
</tr>
<tr>
<td><code>MESSAGE_TOO_LARGE</code></td>
<td>Message exceeds max size</td>
<td>Increase <code>max-message-size</code> or reduce payload size</td>
</tr>
<tr>
<td><code>INVALID_TOPIC</code></td>
<td>Topic name is invalid</td>
<td>Use alphanumeric + dots (e.g., <code>user.login</code>)</td>
</tr>
<tr>
<td><code>SUBSCRIPTION_FAILED</code></td>
<td>Handler threw exception</td>
<td>Fix handler code, check console for details</td>
</tr>
<tr>
<td><code>RETAINED_OVERFLOW</code></td>
<td>Too many retained messages</td>
<td>Increase <code>max-retained</code> or clean up old messages</td>
</tr>
<tr>
<td><code>WILDCARD_DISABLED</code></td>
<td><code>*</code> wildcard used when disabled</td>
<td>Set <code>allow-global-wildcard="true"</code></td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb209"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for errors</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;pan:sys.error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> message<span class="op">,</span> details } <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`PAN Bus Error [</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> message<span class="op">,</span> details)<span class="op">;</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle specific errors</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (code <span class="op">===</span> <span class="st">&#39;RATE_LIMIT&#39;</span>) {</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Slow down publishing</span></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">enableThrottling</span>()<span class="op">;</span></span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (code <span class="op">===</span> <span class="st">&#39;MESSAGE_TOO_LARGE&#39;</span>) {</span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Split large payloads</span></span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">splitPayload</span>(details<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>TypeError</code>: Invalid parameters (e.g., non-string topic,
non-function handler)</li>
<li><code>RangeError</code>: Attribute values out of bounds (e.g.,
negative rate-limit)</li>
</ul>
<hr />
<h2 data-number="17.2" id="pan-theme-provider"><span
class="header-section-number">17.2</span> pan-theme-provider</h2>
<p><strong>Purpose</strong>: Manages app theme with system preference
detection <strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-theme-provider.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="17.2.1" id="quick-example-14"><span
class="header-section-number">17.2.1</span> Quick Example</h3>
<div class="sourceCode" id="cb210"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-provider</span><span class="ot"> theme</span><span class="op">=</span><span class="st">&quot;auto&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-provider</span><span class="dt">&gt;</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root</span><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;light&quot;</span><span class="ex">]</span> { <span class="va">--bg</span><span class="ch">:</span> <span class="cn">#fff</span><span class="op">;</span> <span class="va">--text</span><span class="ch">:</span> <span class="cn">#000</span><span class="op">;</span> }</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>  <span class="in">:root</span><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="ex">]</span> { <span class="va">--bg</span><span class="ch">:</span> <span class="cn">#000</span><span class="op">;</span> <span class="va">--text</span><span class="ch">:</span> <span class="cn">#fff</span><span class="op">;</span> }</span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>  body { <span class="kw">background</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--bg</span><span class="fu">)</span><span class="op">;</span> <span class="kw">color</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--text</span><span class="fu">)</span><span class="op">;</span> }</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="17.2.2" id="attributes-1"><span
class="header-section-number">17.2.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>theme</code></td>
<td>String</td>
<td>“auto”</td>
<td>Theme mode: “light”, “dark”, or “auto”</td>
</tr>
</tbody>
</table>
<h3 data-number="17.2.3" id="methods-1"><span
class="header-section-number">17.2.3</span> Methods</h3>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 30%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setTheme(theme)</code></td>
<td>undefined</td>
<td>Set theme: “light”, “dark”, or “auto”</td>
</tr>
<tr>
<td><code>getTheme()</code></td>
<td>String</td>
<td>Get theme mode</td>
</tr>
<tr>
<td><code>getEffectiveTheme()</code></td>
<td>String</td>
<td>Get actual theme (“light” or “dark”)</td>
</tr>
<tr>
<td><code>getSystemTheme()</code></td>
<td>String</td>
<td>Get system preference</td>
</tr>
</tbody>
</table>
<p><strong>Usage</strong>:</p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> provider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>provider<span class="op">.</span><span class="fu">setTheme</span>(<span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(provider<span class="op">.</span><span class="fu">getEffectiveTheme</span>())<span class="op">;</span>  <span class="co">// &quot;dark&quot;</span></span></code></pre></div>
<h3 data-number="17.2.4" id="events-1"><span
class="header-section-number">17.2.4</span> Events</h3>
<ul>
<li><strong>DOM</strong>: <code>theme-change</code> - Detail:
<code>{ theme, effective }</code></li>
<li><strong>PAN</strong>: <code>theme.changed</code> - Data:
<code>{ theme, effective }</code></li>
<li><strong>PAN</strong>: <code>theme.system-changed</code> - Data:
<code>{ theme }</code></li>
</ul>
<h3 data-number="17.2.5" id="complete-example-6"><span
class="header-section-number">17.2.5</span> Complete Example</h3>
<div class="sourceCode" id="cb212"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemedApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to theme changes</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;theme.changed&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">effective</span>)<span class="op">;</span></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get initial theme</span></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> provider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (provider) {</span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(provider<span class="op">.</span><span class="fu">getEffectiveTheme</span>())<span class="op">;</span></span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Persist preference</span></span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>    bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;theme.changed&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb212-18"><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb212-19"><a href="#cb212-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb212-20"><a href="#cb212-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb212-21"><a href="#cb212-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-22"><a href="#cb212-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(theme) {</span>
<span id="cb212-23"><a href="#cb212-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="vs">`app theme-</span><span class="sc">${</span>theme<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb212-24"><a href="#cb212-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb212-25"><a href="#cb212-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-26"><a href="#cb212-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb212-27"><a href="#cb212-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb212-28"><a href="#cb212-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb212-29"><a href="#cb212-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb212-30"><a href="#cb212-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-31"><a href="#cb212-31" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;themed-app&#39;</span><span class="op">,</span> ThemedApp)<span class="op">;</span></span></code></pre></div>
<h3 data-number="17.2.6" id="common-issues-15"><span
class="header-section-number">17.2.6</span> Common Issues</h3>
<p><strong>Theme not applying</strong>: Define CSS variables for both
<code>[data-theme="light"]</code> and <code>[data-theme="dark"]</code>
<strong>Flash on load</strong>: Set theme in inline
<code>&lt;script&gt;</code> before loading components <strong>Not
updating</strong>: Subscribe to <code>theme.changed</code> in
<code>connectedCallback()</code></p>
<h3 data-number="17.2.7" id="errors-1"><span
class="header-section-number">17.2.7</span> Errors</h3>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Invalid theme value</td>
<td><code>setTheme()</code> called with invalid value</td>
<td>Use “light”, “dark”, or “auto” only</td>
</tr>
<tr>
<td><code>matchMedia</code> not supported</td>
<td>Old browser</td>
<td>Provide polyfill or default to “light”</td>
</tr>
<tr>
<td>localStorage quota</td>
<td>Storage full</td>
<td>Clear old data or use memory-only mode</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb213"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> provider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>  provider<span class="op">.</span><span class="fu">setTheme</span>(<span class="st">&#39;custom&#39;</span>)<span class="op">;</span> <span class="co">// Invalid!</span></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Theme error:&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fallback to auto</span></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>  provider<span class="op">.</span><span class="fu">setTheme</span>(<span class="st">&#39;auto&#39;</span>)<span class="op">;</span></span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>TypeError</code>: Invalid theme value passed to
<code>setTheme()</code></li>
<li><code>DOMException</code>: localStorage access denied (privacy
mode)</li>
</ul>
<hr />
<h2 data-number="17.3" id="pan-theme-toggle"><span
class="header-section-number">17.3</span> pan-theme-toggle</h2>
<p><strong>Purpose</strong>: UI control for theme switching
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-theme-toggle.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="17.3.1" id="quick-example-15"><span
class="header-section-number">17.3.1</span> Quick Example</h3>
<div class="sourceCode" id="cb214"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="ot"> variant</span><span class="op">=</span><span class="st">&quot;button&quot;</span><span class="ot"> label</span><span class="op">=</span><span class="st">&quot;Theme&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="ot"> variant</span><span class="op">=</span><span class="st">&quot;dropdown&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="17.3.2" id="attributes-2"><span
class="header-section-number">17.3.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>label</code></td>
<td>String</td>
<td>“”</td>
<td>Text label (button variant only)</td>
</tr>
<tr>
<td><code>variant</code></td>
<td>String</td>
<td>“icon”</td>
<td>Style: “icon”, “button”, or “dropdown”</td>
</tr>
</tbody>
</table>
<h3 data-number="17.3.3" id="complete-example-7"><span
class="header-section-number">17.3.3</span> Complete Example</h3>
<div class="sourceCode" id="cb215"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">nav</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;toolbar&quot;</span><span class="dt">&gt;</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">h1</span><span class="dt">&gt;</span>My App<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;actions&quot;</span><span class="dt">&gt;</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="dt">&gt;</span>Settings<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-theme-toggle</span><span class="dt">&gt;</span></span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">nav</span><span class="dt">&gt;</span></span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.toolbar</span> {</span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">space-between</span><span class="op">;</span></span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">background</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--surface</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.actions</span> {</span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">gap</span><span class="ch">:</span> <span class="dv">0.5</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb215-21"><a href="#cb215-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb215-22"><a href="#cb215-22" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="17.3.4" id="common-issues-16"><span
class="header-section-number">17.3.4</span> Common Issues</h3>
<p><strong>Not working</strong>: Ensure <code>pan-theme-provider</code>
exists <strong>Wrong icon</strong>: Component subscribes on connect; add
after <code>pan:sys.ready</code> <strong>Dropdown positioning</strong>:
Wrap in <code>position: relative</code> container</p>
<h3 data-number="17.3.5" id="errors-2"><span
class="header-section-number">17.3.5</span> Errors</h3>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Provider not found</td>
<td><code>pan-theme-provider</code> missing</td>
<td>Add <code>&lt;pan-theme-provider&gt;</code> to page</td>
</tr>
<tr>
<td>Invalid variant</td>
<td>Unsupported <code>variant</code> attribute</td>
<td>Use “icon”, “button”, or “dropdown”</td>
</tr>
<tr>
<td>Event not dispatched</td>
<td>pan-bus not ready</td>
<td>Wait for <code>pan:sys.ready</code> or add toggle after bus
loads</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb216"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Ensure provider exists</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;DOMContentLoaded&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> toggle <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-toggle&#39;</span>)<span class="op">;</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> provider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>provider) {</span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;pan-theme-toggle requires pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add provider dynamically</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newProvider <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;pan-theme-provider&#39;</span>)<span class="op">;</span></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">prepend</span>(newProvider)<span class="op">;</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Exceptions thrown</strong>: None (component fails gracefully
without provider)</p>
<hr />
<h2 data-number="17.4" id="pan-routes"><span
class="header-section-number">17.4</span> pan-routes</h2>
<p><strong>Purpose</strong>: Runtime-configurable message routing
<strong>Import</strong>: Enabled via
<code>&lt;pan-bus enable-routing="true"&gt;&lt;/pan-bus&gt;</code>
<strong>Access</strong>: <code>window.pan.routes</code> or
<code>bus.routingManager</code></p>
<h3 data-number="17.4.1" id="quick-example-16"><span
class="header-section-number">17.4.1</span> Quick Example</h3>
<div class="sourceCode" id="cb217"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> routes <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">routes</span><span class="op">;</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Add route</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Login redirect&#39;</span><span class="op">,</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user.login.success&#39;</span> }<span class="op">,</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> [</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;EMIT&#39;</span><span class="op">,</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> { <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;ui.navigate&#39;</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> { <span class="dt">to</span><span class="op">:</span> <span class="st">&#39;/dashboard&#39;</span> } }</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="17.4.2" id="methods-2"><span
class="header-section-number">17.4.2</span> Methods</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>add(route)</code></td>
<td>route: Object</td>
<td>Object</td>
<td>Add route (returns route with ID)</td>
</tr>
<tr>
<td><code>update(id, patch)</code></td>
<td>id: String, patch: Object</td>
<td>Object</td>
<td>Update route</td>
</tr>
<tr>
<td><code>remove(id)</code></td>
<td>id: String</td>
<td>Boolean</td>
<td>Remove route</td>
</tr>
<tr>
<td><code>enable(id)</code> / <code>disable(id)</code></td>
<td>id: String</td>
<td>-</td>
<td>Enable/disable route</td>
</tr>
<tr>
<td><code>get(id)</code></td>
<td>id: String</td>
<td>Object?</td>
<td>Get route by ID</td>
</tr>
<tr>
<td><code>list(filter?)</code></td>
<td>filter?: Object</td>
<td>Array</td>
<td>List routes</td>
</tr>
<tr>
<td><code>clear()</code></td>
<td>-</td>
<td>-</td>
<td>Remove all routes</td>
</tr>
<tr>
<td><code>registerTransformFn(id, fn)</code></td>
<td>id: String, fn: Function</td>
<td>-</td>
<td>Register transform</td>
</tr>
<tr>
<td><code>registerHandler(id, fn)</code></td>
<td>id: String, fn: Function</td>
<td>-</td>
<td>Register handler</td>
</tr>
<tr>
<td><code>getStats()</code></td>
<td>-</td>
<td>Object</td>
<td>Get statistics</td>
</tr>
<tr>
<td><code>resetStats()</code></td>
<td>-</td>
<td>-</td>
<td>Reset statistics</td>
</tr>
<tr>
<td><code>setEnabled(bool)</code></td>
<td>enabled: Boolean</td>
<td>-</td>
<td>Enable/disable routing</td>
</tr>
<tr>
<td><code>onRoutesChanged(fn)</code></td>
<td>fn: Function</td>
<td>Function</td>
<td>Subscribe to changes (returns unsub)</td>
</tr>
<tr>
<td><code>onError(fn)</code></td>
<td>fn: Function</td>
<td>Function</td>
<td>Subscribe to errors (returns unsub)</td>
</tr>
</tbody>
</table>
<h3 data-number="17.4.3" id="route-configuration"><span
class="header-section-number">17.4.3</span> Route Configuration</h3>
<div class="sourceCode" id="cb218"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="bu">String</span><span class="op">,</span>           <span class="co">// Optional (auto-generated)</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="bu">String</span><span class="op">,</span>         <span class="co">// Required</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">enabled</span><span class="op">:</span> <span class="bu">Boolean</span><span class="op">,</span>     <span class="co">// Default: true</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">order</span><span class="op">:</span> <span class="bu">Number</span><span class="op">,</span>        <span class="co">// Default: 0 (execution order)</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> {             <span class="co">// Match criteria</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="bu">String</span><span class="op">|</span><span class="bu">Array</span><span class="op">,</span>     <span class="co">// Message type(s)</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">topic</span><span class="op">:</span> <span class="bu">String</span><span class="op">|</span><span class="bu">Array</span><span class="op">,</span>    <span class="co">// Topic pattern(s)</span></span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">source</span><span class="op">:</span> <span class="bu">String</span><span class="op">|</span><span class="bu">Array</span><span class="op">,</span>   <span class="co">// Source client(s)</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tagsAny</span><span class="op">:</span> <span class="bu">Array</span><span class="op">,</span>        <span class="co">// Has any tag</span></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tagsAll</span><span class="op">:</span> <span class="bu">Array</span><span class="op">,</span>        <span class="co">// Has all tags</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">where</span><span class="op">:</span> <span class="bu">Object</span>          <span class="co">// Predicate (see below)</span></span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">transform</span><span class="op">:</span> <span class="bu">Object</span><span class="op">,</span>    <span class="co">// Optional transform</span></span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> <span class="bu">Array</span><span class="op">,</span>       <span class="co">// Actions to perform</span></span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">meta</span><span class="op">:</span> <span class="bu">Object</span>         <span class="co">// Optional metadata</span></span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.4.4" id="match-predicates"><span
class="header-section-number">17.4.4</span> Match Predicates</h3>
<p>Operators: <code>eq</code>, <code>neq</code>, <code>gt</code>,
<code>gte</code>, <code>lt</code>, <code>lte</code>, <code>in</code>,
<code>regex</code>, <code>and</code>, <code>or</code>,
<code>not</code></p>
<div class="sourceCode" id="cb219"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>where<span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;gt&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.temp&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">30</span> }</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Regex</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>where<span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;regex&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.email&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;^[</span><span class="sc">\\</span><span class="st">w-]+@&#39;</span> }</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Combined</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>where<span class="op">:</span> {</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;and&#39;</span><span class="op">,</span></span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">children</span><span class="op">:</span> [</span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;eq&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.status&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;active&#39;</span> }<span class="op">,</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;gt&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.score&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">75</span> }</span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.4.5" id="transform-operations"><span
class="header-section-number">17.4.5</span> Transform Operations</h3>
<div class="sourceCode" id="cb220"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Identity (no change)</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>transform<span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;identity&#39;</span> }</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Pick fields</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>transform<span class="op">:</span> {</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;pick&#39;</span><span class="op">,</span></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">paths</span><span class="op">:</span> [<span class="st">&#39;payload.userId&#39;</span><span class="op">,</span> <span class="st">&#39;meta.timestamp&#39;</span>]</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Map with function (register first)</span></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">registerTransformFn</span>(<span class="st">&#39;double&#39;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>transform<span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.value&#39;</span><span class="op">,</span> <span class="dt">fnId</span><span class="op">:</span> <span class="st">&#39;double&#39;</span> }</span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom (register first)</span></span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">registerTransformFn</span>(<span class="st">&#39;custom&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> ({ <span class="op">...</span>msg<span class="op">,</span> <span class="dt">payload</span><span class="op">:</span> {} }))<span class="op">;</span></span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a>transform<span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;custom&#39;</span><span class="op">,</span> <span class="dt">fnId</span><span class="op">:</span> <span class="st">&#39;custom&#39;</span> }</span></code></pre></div>
<h3 data-number="17.4.6" id="actions"><span
class="header-section-number">17.4.6</span> Actions</h3>
<div class="sourceCode" id="cb221"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co">// EMIT - Publish new message</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;EMIT&#39;</span><span class="op">,</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> { <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;new.topic&#39;</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> {} }<span class="op">,</span></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inherit</span><span class="op">:</span> [<span class="st">&#39;payload&#39;</span><span class="op">,</span> <span class="st">&#39;meta&#39;</span>]</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a><span class="co">// FORWARD - Forward to different topic</span></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;FORWARD&#39;</span><span class="op">,</span></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;new.topic&#39;</span><span class="op">,</span></span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">typeOverride</span><span class="op">:</span> <span class="st">&#39;new.type&#39;</span>  <span class="co">// Optional</span></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a><span class="co">// LOG - Console log</span></span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;LOG&#39;</span><span class="op">,</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">level</span><span class="op">:</span> <span class="st">&#39;info&#39;</span><span class="op">,</span>  <span class="co">// &#39;log&#39;, &#39;info&#39;, &#39;warn&#39;, &#39;error&#39;</span></span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">template</span><span class="op">:</span> <span class="st">&#39;User {{payload.id}} action&#39;</span></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a><span class="co">// CALL - Call registered handler</span></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;CALL&#39;</span><span class="op">,</span></span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">handlerId</span><span class="op">:</span> <span class="st">&#39;myHandler&#39;</span></span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.4.7" id="complete-example-8"><span
class="header-section-number">17.4.7</span> Complete Example</h3>
<div class="sourceCode" id="cb222"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> routes <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">routes</span><span class="op">;</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Register handlers</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">registerHandler</span>(<span class="st">&#39;notifyAdmin&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/admin/notify&#39;</span><span class="op">,</span> {</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg)</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">registerTransformFn</span>(<span class="st">&#39;sanitize&#39;</span><span class="op">,</span> (email) <span class="kw">=&gt;</span> {</span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> email<span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">.</span><span class="fu">trim</span>()<span class="op">;</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Workflow: Registration -&gt; Validation -&gt; Welcome</span></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;User registration workflow&#39;</span><span class="op">,</span></span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">order</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb222-19"><a href="#cb222-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user.register&#39;</span> }<span class="op">,</span></span>
<span id="cb222-20"><a href="#cb222-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">transform</span><span class="op">:</span> {</span>
<span id="cb222-21"><a href="#cb222-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;map&#39;</span><span class="op">,</span></span>
<span id="cb222-22"><a href="#cb222-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.email&#39;</span><span class="op">,</span></span>
<span id="cb222-23"><a href="#cb222-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fnId</span><span class="op">:</span> <span class="st">&#39;sanitize&#39;</span></span>
<span id="cb222-24"><a href="#cb222-24" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb222-25"><a href="#cb222-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> [</span>
<span id="cb222-26"><a href="#cb222-26" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb222-27"><a href="#cb222-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;EMIT&#39;</span><span class="op">,</span></span>
<span id="cb222-28"><a href="#cb222-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> { <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;email.validate&#39;</span> }<span class="op">,</span></span>
<span id="cb222-29"><a href="#cb222-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">inherit</span><span class="op">:</span> [<span class="st">&#39;payload&#39;</span>]</span>
<span id="cb222-30"><a href="#cb222-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb222-31"><a href="#cb222-31" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb222-32"><a href="#cb222-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-33"><a href="#cb222-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-34"><a href="#cb222-34" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb222-35"><a href="#cb222-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Email validated -&gt; Welcome&#39;</span><span class="op">,</span></span>
<span id="cb222-36"><a href="#cb222-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">order</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb222-37"><a href="#cb222-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;email.validated&#39;</span> }<span class="op">,</span></span>
<span id="cb222-38"><a href="#cb222-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> [</span>
<span id="cb222-39"><a href="#cb222-39" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb222-40"><a href="#cb222-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;EMIT&#39;</span><span class="op">,</span></span>
<span id="cb222-41"><a href="#cb222-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> {</span>
<span id="cb222-42"><a href="#cb222-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;email.send&#39;</span><span class="op">,</span></span>
<span id="cb222-43"><a href="#cb222-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> { <span class="dt">template</span><span class="op">:</span> <span class="st">&#39;welcome&#39;</span> }</span>
<span id="cb222-44"><a href="#cb222-44" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb222-45"><a href="#cb222-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">inherit</span><span class="op">:</span> [<span class="st">&#39;payload&#39;</span>]</span>
<span id="cb222-46"><a href="#cb222-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb222-47"><a href="#cb222-47" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb222-48"><a href="#cb222-48" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-49"><a href="#cb222-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-50"><a href="#cb222-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Log high-value transactions</span></span>
<span id="cb222-51"><a href="#cb222-51" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb222-52"><a href="#cb222-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;High-value transaction alert&#39;</span><span class="op">,</span></span>
<span id="cb222-53"><a href="#cb222-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> {</span>
<span id="cb222-54"><a href="#cb222-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;transaction.complete&#39;</span><span class="op">,</span></span>
<span id="cb222-55"><a href="#cb222-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">where</span><span class="op">:</span> { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;gt&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.amount&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">1000</span> }</span>
<span id="cb222-56"><a href="#cb222-56" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb222-57"><a href="#cb222-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> [</span>
<span id="cb222-58"><a href="#cb222-58" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb222-59"><a href="#cb222-59" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;LOG&#39;</span><span class="op">,</span></span>
<span id="cb222-60"><a href="#cb222-60" aria-hidden="true" tabindex="-1"></a>      <span class="dt">level</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb222-61"><a href="#cb222-61" aria-hidden="true" tabindex="-1"></a>      <span class="dt">template</span><span class="op">:</span> <span class="st">&#39;High-value: ${{payload.amount}}&#39;</span></span>
<span id="cb222-62"><a href="#cb222-62" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb222-63"><a href="#cb222-63" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb222-64"><a href="#cb222-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;CALL&#39;</span><span class="op">,</span></span>
<span id="cb222-65"><a href="#cb222-65" aria-hidden="true" tabindex="-1"></a>      <span class="dt">handlerId</span><span class="op">:</span> <span class="st">&#39;notifyAdmin&#39;</span></span>
<span id="cb222-66"><a href="#cb222-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb222-67"><a href="#cb222-67" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb222-68"><a href="#cb222-68" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-69"><a href="#cb222-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-70"><a href="#cb222-70" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter invalid sensor data</span></span>
<span id="cb222-71"><a href="#cb222-71" aria-hidden="true" tabindex="-1"></a>routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb222-72"><a href="#cb222-72" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Filter sensor readings&#39;</span><span class="op">,</span></span>
<span id="cb222-73"><a href="#cb222-73" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> {</span>
<span id="cb222-74"><a href="#cb222-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;sensor.reading&#39;</span><span class="op">,</span></span>
<span id="cb222-75"><a href="#cb222-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">where</span><span class="op">:</span> {</span>
<span id="cb222-76"><a href="#cb222-76" aria-hidden="true" tabindex="-1"></a>      <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;and&#39;</span><span class="op">,</span></span>
<span id="cb222-77"><a href="#cb222-77" aria-hidden="true" tabindex="-1"></a>      <span class="dt">children</span><span class="op">:</span> [</span>
<span id="cb222-78"><a href="#cb222-78" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;gte&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.temp&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="op">-</span><span class="dv">40</span> }<span class="op">,</span></span>
<span id="cb222-79"><a href="#cb222-79" aria-hidden="true" tabindex="-1"></a>        { <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;lte&#39;</span><span class="op">,</span> <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;payload.temp&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">85</span> }</span>
<span id="cb222-80"><a href="#cb222-80" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb222-81"><a href="#cb222-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb222-82"><a href="#cb222-82" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb222-83"><a href="#cb222-83" aria-hidden="true" tabindex="-1"></a>  <span class="dt">transform</span><span class="op">:</span> {</span>
<span id="cb222-84"><a href="#cb222-84" aria-hidden="true" tabindex="-1"></a>    <span class="dt">op</span><span class="op">:</span> <span class="st">&#39;pick&#39;</span><span class="op">,</span></span>
<span id="cb222-85"><a href="#cb222-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">paths</span><span class="op">:</span> [<span class="st">&#39;payload.temp&#39;</span><span class="op">,</span> <span class="st">&#39;meta.sensorId&#39;</span>]</span>
<span id="cb222-86"><a href="#cb222-86" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb222-87"><a href="#cb222-87" aria-hidden="true" tabindex="-1"></a>  <span class="dt">actions</span><span class="op">:</span> [</span>
<span id="cb222-88"><a href="#cb222-88" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;FORWARD&#39;</span><span class="op">,</span> <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;sensor.valid&#39;</span> }</span>
<span id="cb222-89"><a href="#cb222-89" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb222-90"><a href="#cb222-90" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb222-91"><a href="#cb222-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-92"><a href="#cb222-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Get stats</span></span>
<span id="cb222-93"><a href="#cb222-93" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(routes<span class="op">.</span><span class="fu">getStats</span>())<span class="op">;</span></span>
<span id="cb222-94"><a href="#cb222-94" aria-hidden="true" tabindex="-1"></a><span class="co">// {</span></span>
<span id="cb222-95"><a href="#cb222-95" aria-hidden="true" tabindex="-1"></a><span class="co">//   routesEvaluated: 150,</span></span>
<span id="cb222-96"><a href="#cb222-96" aria-hidden="true" tabindex="-1"></a><span class="co">//   routesMatched: 45,</span></span>
<span id="cb222-97"><a href="#cb222-97" aria-hidden="true" tabindex="-1"></a><span class="co">//   actionsExecuted: 67,</span></span>
<span id="cb222-98"><a href="#cb222-98" aria-hidden="true" tabindex="-1"></a><span class="co">//   errors: 0,</span></span>
<span id="cb222-99"><a href="#cb222-99" aria-hidden="true" tabindex="-1"></a><span class="co">//   routeCount: 4,</span></span>
<span id="cb222-100"><a href="#cb222-100" aria-hidden="true" tabindex="-1"></a><span class="co">//   enabledRouteCount: 4</span></span>
<span id="cb222-101"><a href="#cb222-101" aria-hidden="true" tabindex="-1"></a><span class="co">// }</span></span></code></pre></div>
<h3 data-number="17.4.8" id="common-issues-17"><span
class="header-section-number">17.4.8</span> Common Issues</h3>
<p><strong>Routes not firing</strong>: Enable routing with
<code>&lt;pan-bus enable-routing="true"&gt;</code> <strong>Wrong
matches</strong>: Enable debug mode:
<code>&lt;pan-bus debug="true"&gt;</code> <strong>Transform not
found</strong>: Register functions before adding routes <strong>Wrong
order</strong>: Set explicit <code>order</code> property (lower executes
first)</p>
<h3 data-number="17.4.9" id="errors-3"><span
class="header-section-number">17.4.9</span> Errors</h3>
<p>Subscribe to errors using <code>onError()</code>:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Type</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INVALID_ROUTE</code></td>
<td>Missing required fields (<code>name</code>, <code>match</code>, or
<code>actions</code>)</td>
<td>Provide all required fields in route config</td>
</tr>
<tr>
<td><code>ROUTE_NOT_FOUND</code></td>
<td><code>update()</code> or <code>remove()</code> with invalid ID</td>
<td>Check route exists with <code>get(id)</code> first</td>
</tr>
<tr>
<td><code>PREDICATE_ERROR</code></td>
<td>Invalid <code>where</code> operator or structure</td>
<td>Use supported operators: <code>eq</code>, <code>gt</code>,
<code>lt</code>, <code>in</code>, <code>regex</code>, <code>and</code>,
<code>or</code>, <code>not</code></td>
</tr>
<tr>
<td><code>TRANSFORM_ERROR</code></td>
<td>Transform function threw exception</td>
<td>Fix transform function or handle errors within it</td>
</tr>
<tr>
<td><code>TRANSFORM_NOT_FOUND</code></td>
<td><code>fnId</code> not registered</td>
<td>Call <code>registerTransformFn(id, fn)</code> before using</td>
</tr>
<tr>
<td><code>ACTION_ERROR</code></td>
<td>Action execution failed</td>
<td>Check action configuration and registered handlers</td>
</tr>
<tr>
<td><code>HANDLER_NOT_FOUND</code></td>
<td><code>CALL</code> action with unregistered handler</td>
<td>Call <code>registerHandler(id, fn)</code> before using</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb223"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> routes <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">routes</span><span class="op">;</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to errors</span></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsubscribe <span class="op">=</span> routes<span class="op">.</span><span class="fu">onError</span>((error) <span class="kw">=&gt;</span> {</span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Route error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle specific errors</span></span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (error<span class="op">.</span><span class="at">code</span>) {</span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;TRANSFORM_ERROR&#39;</span><span class="op">:</span></span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Disable problematic route</span></span>
<span id="cb223-11"><a href="#cb223-11" aria-hidden="true" tabindex="-1"></a>      routes<span class="op">.</span><span class="fu">disable</span>(error<span class="op">.</span><span class="at">routeId</span>)<span class="op">;</span></span>
<span id="cb223-12"><a href="#cb223-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">notifyAdmin</span>(<span class="st">&#39;Route failed&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb223-13"><a href="#cb223-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb223-14"><a href="#cb223-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-15"><a href="#cb223-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;HANDLER_NOT_FOUND&#39;</span><span class="op">:</span></span>
<span id="cb223-16"><a href="#cb223-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Register missing handler</span></span>
<span id="cb223-17"><a href="#cb223-17" aria-hidden="true" tabindex="-1"></a>      routes<span class="op">.</span><span class="fu">registerHandler</span>(error<span class="op">.</span><span class="at">handlerId</span><span class="op">,</span> fallbackHandler)<span class="op">;</span></span>
<span id="cb223-18"><a href="#cb223-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb223-19"><a href="#cb223-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb223-20"><a href="#cb223-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb223-21"><a href="#cb223-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-22"><a href="#cb223-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Validate route before adding</span></span>
<span id="cb223-23"><a href="#cb223-23" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb223-24"><a href="#cb223-24" aria-hidden="true" tabindex="-1"></a>  routes<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb223-25"><a href="#cb223-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;My Route&#39;</span><span class="op">,</span></span>
<span id="cb223-26"><a href="#cb223-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">match</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;test&#39;</span> }<span class="op">,</span></span>
<span id="cb223-27"><a href="#cb223-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">actions</span><span class="op">:</span> [{ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;LOG&#39;</span><span class="op">,</span> <span class="dt">level</span><span class="op">:</span> <span class="st">&#39;info&#39;</span><span class="op">,</span> <span class="dt">template</span><span class="op">:</span> <span class="st">&#39;Test&#39;</span> }]</span>
<span id="cb223-28"><a href="#cb223-28" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb223-29"><a href="#cb223-29" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (e) {</span>
<span id="cb223-30"><a href="#cb223-30" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to add route:&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb223-31"><a href="#cb223-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>Error</code>: Invalid route configuration (missing required
fields)</li>
<li><code>TypeError</code>: Invalid parameters (e.g., non-function
handler)</li>
<li><code>RangeError</code>: Invalid <code>order</code> value</li>
</ul>
<hr />
<h2 data-number="17.5" id="summary"><span
class="header-section-number">17.5</span> Summary</h2>
<p>This chapter documented LARC’s four core components:</p>
<ul>
<li><strong>pan-bus</strong>: Message bus infrastructure for pub/sub
communication</li>
<li><strong>pan-theme-provider</strong>: Centralized theme
management</li>
<li><strong>pan-theme-toggle</strong>: UI controls for theme
switching</li>
<li><strong>pan-routes</strong>: Message routing for workflows and
orchestration</li>
</ul>
<p>These form the backbone of every LARC application.</p>
<p><strong>See Also</strong>:</p>
<ul>
<li>Tutorial: <em>Learning LARC</em> Chapters 4-5</li>
<li>State components: Chapter 18</li>
<li>UI components: Chapter 19</li>
<li>Message patterns: Appendix A</li>
<li>Configuration: Appendix C</li>
</ul>
<h1 data-number="18" id="data-components-reference"><span
class="header-section-number">18</span> Data Components Reference</h1>
<p>API documentation for LARC’s data management components. For
tutorials, see <em>Learning LARC</em> Chapter 6.</p>
<h2 data-number="18.1" id="pan-store"><span
class="header-section-number">18.1</span> pan-store</h2>
<p><strong>Purpose</strong>: Reactive state management for shared
application state<br />
<strong>Import</strong>:
<code>import { createStore, bind } from './pan-store.mjs';</code></p>
<h3 data-number="18.1.1" id="quick-example-17"><span
class="header-section-number">18.1.1</span> Quick Example</h3>
<div class="sourceCode" id="cb224"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { createStore } <span class="im">from</span> <span class="st">&#39;./pan-store.mjs&#39;</span><span class="op">;</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> store <span class="op">=</span> <span class="fu">createStore</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span> })<span class="op">;</span></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to changes</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">subscribe</span>(({ detail }) <span class="kw">=&gt;</span> {</span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>detail<span class="op">.</span><span class="at">key</span><span class="sc">}</span><span class="vs"> changed to </span><span class="sc">${</span>detail<span class="op">.</span><span class="at">value</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Update state</span></span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span> <span class="co">// Triggers subscriber</span></span></code></pre></div>
<h3 data-number="18.1.2" id="api"><span
class="header-section-number">18.1.2</span> API</h3>
<h4 data-number="18.1.2.1" id="createstoreinitial"><span
class="header-section-number">18.1.2.1</span> createStore(initial)</h4>
<p>Creates reactive store with optional initial state.</p>
<p><strong>Parameters:</strong> - <code>initial</code> (Object,
optional): Initial state</p>
<p><strong>Returns:</strong> Store instance</p>
<p><strong>Properties:</strong> - <code>state</code> (Proxy): Reactive
state object</p>
<h4 data-number="18.1.2.2" id="store-methods"><span
class="header-section-number">18.1.2.2</span> Store Methods</h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>subscribe(callback)</code></td>
<td>callback: Function</td>
<td>Function</td>
<td>Subscribe to changes (returns unsubscribe fn)</td>
</tr>
<tr>
<td><code>set(key, value)</code></td>
<td>key: String, value: Any</td>
<td>-</td>
<td>Set single property</td>
</tr>
<tr>
<td><code>patch(object)</code></td>
<td>object: Object</td>
<td>-</td>
<td>Merge multiple properties</td>
</tr>
<tr>
<td><code>update(fn)</code></td>
<td>fn: Function</td>
<td>-</td>
<td>Update using function</td>
</tr>
<tr>
<td><code>select(path)</code></td>
<td>path: String</td>
<td>Any</td>
<td>Get nested value by dot-path</td>
</tr>
<tr>
<td><code>derive(key, deps, computeFn)</code></td>
<td>key: String, deps: Array, computeFn: Function</td>
<td>Function</td>
<td>Create computed property</td>
</tr>
<tr>
<td><code>batch(fn)</code></td>
<td>fn: Function</td>
<td>-</td>
<td>Batch multiple updates</td>
</tr>
<tr>
<td><code>use(middleware)</code></td>
<td>middleware: Function</td>
<td>Function</td>
<td>Add middleware (returns unsubscribe)</td>
</tr>
<tr>
<td><code>snapshot()</code></td>
<td>-</td>
<td>Object</td>
<td>Deep clone of current state</td>
</tr>
<tr>
<td><code>reset()</code></td>
<td>-</td>
<td>-</td>
<td>Reset to initial values</td>
</tr>
<tr>
<td><code>has(key)</code></td>
<td>key: String</td>
<td>Boolean</td>
<td>Check if property exists</td>
</tr>
<tr>
<td><code>delete(key)</code></td>
<td>key: String</td>
<td>Boolean</td>
<td>Remove property</td>
</tr>
<tr>
<td><code>keys()</code></td>
<td>-</td>
<td>Array</td>
<td>Get all property names</td>
</tr>
</tbody>
</table>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb225"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> store <span class="op">=</span> <span class="fu">createStore</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span> })<span class="op">;</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Direct access</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span> <span class="co">// Triggers updates</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Methods</span></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> <span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">patch</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> })<span class="op">;</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">update</span>(state <span class="kw">=&gt;</span> { state<span class="op">.</span><span class="at">count</span> <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> <span class="cf">return</span> state<span class="op">;</span> })<span class="op">;</span></span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Derived values</span></span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">derive</span>(<span class="st">&#39;doubled&#39;</span><span class="op">,</span> [<span class="st">&#39;count&#39;</span>]<span class="op">,</span> (count) <span class="kw">=&gt;</span> count <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">doubled</span>)<span class="op">;</span> <span class="co">// 10</span></span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Batching</span></span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">batch</span>(({ <span class="kw">set</span> }) <span class="kw">=&gt;</span> {</span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(<span class="st">&#39;loading&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span> <span class="co">// Single event</span></span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-21"><a href="#cb225-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Cleanup</span></span>
<span id="cb225-22"><a href="#cb225-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsub <span class="op">=</span> store<span class="op">.</span><span class="fu">subscribe</span>(handler)<span class="op">;</span></span>
<span id="cb225-23"><a href="#cb225-23" aria-hidden="true" tabindex="-1"></a><span class="fu">unsub</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="18.1.3" id="events-2"><span
class="header-section-number">18.1.3</span> Events</h3>
<ul>
<li><p><strong>state</strong>: Emitted on state change<br />
Detail:
<code>{ key, value, oldValue, state, batch?, changes?, deleted? }</code></p></li>
<li><p><strong>derived</strong>: Emitted on derived value update<br />
Detail: <code>{ key, value, state }</code></p></li>
</ul>
<h3 data-number="18.1.4" id="bindelement-store-mapping-options"><span
class="header-section-number">18.1.4</span> bind(element, store,
mapping, options)</h3>
<p>Two-way binding for form inputs.</p>
<p><strong>Parameters:</strong> - <code>element</code> (HTMLElement):
Container element - <code>store</code> (Store): Store instance -
<code>mapping</code> (Object): CSS selectors to property names -
<code>options</code> (Object, optional):
<code>{ events: ['input', 'change'] }</code></p>
<p><strong>Returns:</strong> Unbind function</p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb226"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> store <span class="op">=</span> <span class="fu">createStore</span>({ <span class="dt">username</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;&#39;</span> })<span class="op">;</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> form <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#user-form&#39;</span>)<span class="op">;</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unbind <span class="op">=</span> <span class="fu">bind</span>(form<span class="op">,</span> store<span class="op">,</span> {</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;input[name=&quot;username&quot;]&#39;</span><span class="op">:</span> <span class="st">&#39;username&#39;</span><span class="op">,</span></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;input[name=&quot;email&quot;]&#39;</span><span class="op">:</span> <span class="st">&#39;email&#39;</span></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Input changes update store</span></span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Store changes update inputs</span></span></code></pre></div>
<h3 data-number="18.1.5" id="complete-example-9"><span
class="header-section-number">18.1.5</span> Complete Example</h3>
<div class="sourceCode" id="cb227"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { createStore } <span class="im">from</span> <span class="st">&#39;./pan-store.mjs&#39;</span><span class="op">;</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Shopping cart with derived totals</span></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cart <span class="op">=</span> <span class="fu">createStore</span>({</span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">items</span><span class="op">:</span> [</span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Widget&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">qty</span><span class="op">:</span> <span class="dv">2</span> }<span class="op">,</span></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Gadget&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">25</span><span class="op">,</span> <span class="dt">qty</span><span class="op">:</span> <span class="dv">1</span> }</span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">taxRate</span><span class="op">:</span> <span class="fl">0.08</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Derive subtotal</span></span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a>cart<span class="op">.</span><span class="fu">derive</span>(<span class="st">&#39;subtotal&#39;</span><span class="op">,</span> [<span class="st">&#39;items&#39;</span>]<span class="op">,</span> (items) <span class="kw">=&gt;</span> {</span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> items<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> (item<span class="op">.</span><span class="at">price</span> <span class="op">*</span> item<span class="op">.</span><span class="at">qty</span>)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb227-16"><a href="#cb227-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-17"><a href="#cb227-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Derive tax and total</span></span>
<span id="cb227-18"><a href="#cb227-18" aria-hidden="true" tabindex="-1"></a>cart<span class="op">.</span><span class="fu">derive</span>(<span class="st">&#39;tax&#39;</span><span class="op">,</span> [<span class="st">&#39;subtotal&#39;</span><span class="op">,</span> <span class="st">&#39;taxRate&#39;</span>]<span class="op">,</span> (sub<span class="op">,</span> rate) <span class="kw">=&gt;</span> sub <span class="op">*</span> rate)<span class="op">;</span></span>
<span id="cb227-19"><a href="#cb227-19" aria-hidden="true" tabindex="-1"></a>cart<span class="op">.</span><span class="fu">derive</span>(<span class="st">&#39;total&#39;</span><span class="op">,</span> [<span class="st">&#39;subtotal&#39;</span><span class="op">,</span> <span class="st">&#39;tax&#39;</span>]<span class="op">,</span> (sub<span class="op">,</span> tax) <span class="kw">=&gt;</span> sub <span class="op">+</span> tax)<span class="op">;</span></span>
<span id="cb227-20"><a href="#cb227-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-21"><a href="#cb227-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Add logging middleware</span></span>
<span id="cb227-22"><a href="#cb227-22" aria-hidden="true" tabindex="-1"></a>cart<span class="op">.</span><span class="fu">use</span>(({ key<span class="op">,</span> value }) <span class="kw">=&gt;</span> {</span>
<span id="cb227-23"><a href="#cb227-23" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`State changed: </span><span class="sc">${</span>key<span class="sc">}</span><span class="vs"> = </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb227-24"><a href="#cb227-24" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb227-25"><a href="#cb227-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-26"><a href="#cb227-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to total changes</span></span>
<span id="cb227-27"><a href="#cb227-27" aria-hidden="true" tabindex="-1"></a>cart<span class="op">.</span><span class="fu">subscribe</span>(({ detail }) <span class="kw">=&gt;</span> {</span>
<span id="cb227-28"><a href="#cb227-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (detail<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">&#39;total&#39;</span>) {</span>
<span id="cb227-29"><a href="#cb227-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Cart total: $</span><span class="sc">${</span>detail<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb227-30"><a href="#cb227-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-31"><a href="#cb227-31" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb227-32"><a href="#cb227-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-33"><a href="#cb227-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Access computed values</span></span>
<span id="cb227-34"><a href="#cb227-34" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cart<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">subtotal</span>)<span class="op">;</span> <span class="co">// 45</span></span>
<span id="cb227-35"><a href="#cb227-35" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cart<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">tax</span>)<span class="op">;</span>      <span class="co">// 3.6</span></span>
<span id="cb227-36"><a href="#cb227-36" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cart<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">total</span>)<span class="op">;</span>    <span class="co">// 48.6</span></span></code></pre></div>
<h3 data-number="18.1.6" id="errors-4"><span
class="header-section-number">18.1.6</span> Errors</h3>
<p>pan-store emits errors through the <code>error</code> event for error
conditions:</p>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Circular dependency</td>
<td>Derived value depends on itself</td>
<td>Review <code>derive()</code> dependency chains</td>
</tr>
<tr>
<td>Invalid path</td>
<td><code>select()</code> with non-string path</td>
<td>Use valid dot-notation string (e.g., <code>'user.name'</code>)</td>
</tr>
<tr>
<td>Middleware error</td>
<td>Middleware function throws exception</td>
<td>Wrap middleware in try-catch or fix thrown error</td>
</tr>
<tr>
<td>Frozen state</td>
<td>Attempting to modify frozen object</td>
<td>Unfreeze object or create new reference</td>
</tr>
<tr>
<td>Type error</td>
<td>Non-object passed to <code>patch()</code></td>
<td>Pass plain object to <code>patch()</code></td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb228"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> store <span class="op">=</span> <span class="fu">createStore</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span> })<span class="op">;</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for errors</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { error<span class="op">,</span> operation<span class="op">,</span> key } <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Store error in </span><span class="sc">${</span>operation<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle specific errors</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="at">message</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;Circular&#39;</span>)) {</span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove circular dependencies</span></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Circular dependency detected for key: </span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (operation <span class="op">===</span> <span class="st">&#39;middleware&#39;</span>) {</span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Middleware failed</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Middleware error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe derived value with error handling</span></span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb228-20"><a href="#cb228-20" aria-hidden="true" tabindex="-1"></a>  store<span class="op">.</span><span class="fu">derive</span>(<span class="st">&#39;computed&#39;</span><span class="op">,</span> [<span class="st">&#39;dep1&#39;</span>]<span class="op">,</span> (dep) <span class="kw">=&gt;</span> {</span>
<span id="cb228-21"><a href="#cb228-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>dep) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Invalid dependency&#39;</span>)<span class="op">;</span></span>
<span id="cb228-22"><a href="#cb228-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dep <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb228-23"><a href="#cb228-23" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb228-24"><a href="#cb228-24" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (err) {</span>
<span id="cb228-25"><a href="#cb228-25" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to create derived value:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb228-26"><a href="#cb228-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb228-27"><a href="#cb228-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-28"><a href="#cb228-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe middleware usage</span></span>
<span id="cb228-29"><a href="#cb228-29" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">use</span>((state<span class="op">,</span> changes) <span class="kw">=&gt;</span> {</span>
<span id="cb228-30"><a href="#cb228-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb228-31"><a href="#cb228-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate changes</span></span>
<span id="cb228-32"><a href="#cb228-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (changes<span class="op">.</span><span class="at">price</span> <span class="op">&amp;&amp;</span> changes<span class="op">.</span><span class="at">price</span> <span class="op">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb228-33"><a href="#cb228-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Price cannot be negative&#39;</span>)<span class="op">;</span></span>
<span id="cb228-34"><a href="#cb228-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb228-35"><a href="#cb228-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> changes<span class="op">;</span></span>
<span id="cb228-36"><a href="#cb228-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb228-37"><a href="#cb228-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Middleware validation failed:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb228-38"><a href="#cb228-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span> <span class="co">// Reject changes</span></span>
<span id="cb228-39"><a href="#cb228-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-40"><a href="#cb228-40" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>TypeError</code>: Invalid parameters (e.g., non-string path,
non-function callback)</li>
<li><code>RangeError</code>: Invalid computed dependency (circular
reference)</li>
<li><code>Error</code>: Middleware exceptions (propagated from user
code)</li>
</ul>
<h3 data-number="18.1.7" id="common-issues-18"><span
class="header-section-number">18.1.7</span> Common Issues</h3>
<p><strong>Nested changes not detected</strong></p>
<div class="sourceCode" id="cb229"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;Ada&#39;</span><span class="op">;</span> <span class="co">// No event</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: reassign parent</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> { <span class="op">...</span>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">user</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Ada&#39;</span> }<span class="op">;</span></span></code></pre></div>
<p><strong>Performance with frequent updates</strong></p>
<div class="sourceCode" id="cb230"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: 1000 individual events</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000</span><span class="op">;</span> i<span class="op">++</span>) store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: use batch()</span></span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">batch</span>(({ <span class="kw">set</span> }) <span class="kw">=&gt;</span> {</span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000</span><span class="op">;</span> i<span class="op">++</span>) <span class="kw">set</span>(<span class="st">&#39;count&#39;</span><span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Memory leaks</strong></p>
<div class="sourceCode" id="cb231"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: no cleanup</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>    store<span class="op">.</span><span class="fu">subscribe</span>(<span class="kw">this</span><span class="op">.</span><span class="at">handleChange</span>)<span class="op">;</span> <span class="co">// Leaks</span></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: unsubscribe on disconnect</span></span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsub</span> <span class="op">=</span> store<span class="op">.</span><span class="fu">subscribe</span>(<span class="kw">this</span><span class="op">.</span><span class="at">handleChange</span>)<span class="op">;</span></span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-13"><a href="#cb231-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb231-14"><a href="#cb231-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsub</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">unsub</span>()<span class="op">;</span></span>
<span id="cb231-15"><a href="#cb231-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-16"><a href="#cb231-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
<h2 data-number="18.2" id="pan-idb"><span
class="header-section-number">18.2</span> pan-idb</h2>
<p><strong>Purpose</strong>: IndexedDB integration via PAN message
bus<br />
<strong>Import</strong>: <code>&lt;pan-idb&gt;</code> custom element</p>
<h3 data-number="18.2.1" id="quick-example-18"><span
class="header-section-number">18.2.1</span> Quick Example</h3>
<div class="sourceCode" id="cb232"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-idb</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  database</span><span class="op">=</span><span class="st">&quot;myapp&quot;</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  store</span><span class="op">=</span><span class="st">&quot;documents&quot;</span></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  key-path</span><span class="op">=</span><span class="st">&quot;id&quot;</span></span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  auto-increment</span></span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  indexes</span><span class="op">=</span><span class="st">&#39;[{&quot;name&quot;:&quot;byTitle&quot;,&quot;keyPath&quot;:&quot;title&quot;}]&#39;</span><span class="dt">&gt;</span></span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-idb</span><span class="dt">&gt;</span></span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Add document</span></span>
<span id="cb232-15"><a href="#cb232-15" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb232-16"><a href="#cb232-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.add&#39;</span><span class="op">,</span></span>
<span id="cb232-17"><a href="#cb232-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">item</span><span class="op">:</span> { <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Report&#39;</span><span class="op">,</span> <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;...&#39;</span> } }</span>
<span id="cb232-18"><a href="#cb232-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb232-19"><a href="#cb232-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-20"><a href="#cb232-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for result</span></span>
<span id="cb232-21"><a href="#cb232-21" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;documents.idb.result&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb232-22"><a href="#cb232-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Saved with key:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb232-23"><a href="#cb232-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb232-24"><a href="#cb232-24" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="18.2.2" id="attributes-3"><span
class="header-section-number">18.2.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>database</code></td>
<td>String</td>
<td>-</td>
<td>Database name (required)</td>
</tr>
<tr>
<td><code>version</code></td>
<td>Number</td>
<td>1</td>
<td>Database version</td>
</tr>
<tr>
<td><code>store</code></td>
<td>String</td>
<td>-</td>
<td>Object store name (required)</td>
</tr>
<tr>
<td><code>key-path</code></td>
<td>String</td>
<td>“id”</td>
<td>Primary key property</td>
</tr>
<tr>
<td><code>auto-increment</code></td>
<td>Boolean</td>
<td>false</td>
<td>Use auto-incrementing keys</td>
</tr>
<tr>
<td><code>indexes</code></td>
<td>JSON String</td>
<td>[]</td>
<td>Index configurations</td>
</tr>
</tbody>
</table>
<p><strong>Index format:</strong></p>
<div class="sourceCode" id="cb233"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;byTitle&quot;</span><span class="fu">,</span></span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;keyPath&quot;</span><span class="fu">:</span> <span class="st">&quot;title&quot;</span><span class="fu">,</span></span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;unique&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;multiEntry&quot;</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div>
<h3 data-number="18.2.3" id="pan-topics"><span
class="header-section-number">18.2.3</span> PAN Topics</h3>
<p>All topics follow pattern <code>{store}.idb.{operation}</code>.</p>
<h4 data-number="18.2.3.1" id="subscribe-commands"><span
class="header-section-number">18.2.3.1</span> Subscribe (Commands)</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{store}.idb.get</code></td>
<td><code>{ key }</code></td>
<td>Retrieve item by key</td>
</tr>
<tr>
<td><code>{store}.idb.put</code></td>
<td><code>{ item }</code></td>
<td>Insert or update item</td>
</tr>
<tr>
<td><code>{store}.idb.add</code></td>
<td><code>{ item }</code></td>
<td>Insert item (fails if exists)</td>
</tr>
<tr>
<td><code>{store}.idb.delete</code></td>
<td><code>{ key }</code></td>
<td>Delete item by key</td>
</tr>
<tr>
<td><code>{store}.idb.clear</code></td>
<td><code>{}</code></td>
<td>Delete all items</td>
</tr>
<tr>
<td><code>{store}.idb.list</code></td>
<td><code>{ index?, range?, direction?, limit? }</code></td>
<td>List items</td>
</tr>
<tr>
<td><code>{store}.idb.query</code></td>
<td><code>{ index, value }</code></td>
<td>Query by index</td>
</tr>
<tr>
<td><code>{store}.idb.count</code></td>
<td><code>{ index? }</code></td>
<td>Count items</td>
</tr>
</tbody>
</table>
<h4 data-number="18.2.3.2" id="publish-results"><span
class="header-section-number">18.2.3.2</span> Publish (Results)</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>{store}.idb.ready</code></td>
<td><code>{ database, store }</code></td>
<td>Database initialized</td>
</tr>
<tr>
<td><code>{store}.idb.result</code></td>
<td><code>{ operation, success, ...data }</code></td>
<td>Operation succeeded</td>
</tr>
<tr>
<td><code>{store}.idb.error</code></td>
<td><code>{ operation, success: false, error }</code></td>
<td>Operation failed</td>
</tr>
</tbody>
</table>
<p><strong>Result data by operation:</strong> - <code>get</code>:
<code>{ item }</code> - <code>put</code>/<code>add</code>:
<code>{ key }</code> - <code>list</code>/<code>query</code>:
<code>{ items }</code> - <code>count</code>: <code>{ count }</code></p>
<h3 data-number="18.2.4" id="methods-3"><span
class="header-section-number">18.2.4</span> Methods</h3>
<p>Direct JavaScript API (alternative to PAN topics):</p>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get(key)</code></td>
<td>key: Any</td>
<td>Promise&lt;Object&gt;</td>
<td>Retrieve item</td>
</tr>
<tr>
<td><code>put(item)</code></td>
<td>item: Object</td>
<td>Promise&lt;Any&gt;</td>
<td>Insert/update item</td>
</tr>
<tr>
<td><code>add(item)</code></td>
<td>item: Object</td>
<td>Promise&lt;Any&gt;</td>
<td>Insert item</td>
</tr>
<tr>
<td><code>delete(key)</code></td>
<td>key: Any</td>
<td>Promise&lt;void&gt;</td>
<td>Delete item</td>
</tr>
<tr>
<td><code>clear()</code></td>
<td>-</td>
<td>Promise&lt;void&gt;</td>
<td>Delete all</td>
</tr>
<tr>
<td><code>list(options)</code></td>
<td>options: Object</td>
<td>Promise&lt;Array&gt;</td>
<td>List items</td>
</tr>
<tr>
<td><code>query(index, value)</code></td>
<td>index: String, value: Any</td>
<td>Promise&lt;Array&gt;</td>
<td>Query by index</td>
</tr>
<tr>
<td><code>count(index)</code></td>
<td>index?: String</td>
<td>Promise&lt;Number&gt;</td>
<td>Count items</td>
</tr>
</tbody>
</table>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb234"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> idb <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-idb&#39;</span>)<span class="op">;</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-idb&#39;</span>)<span class="op">;</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> idb<span class="op">.</span><span class="at">initPromise</span><span class="op">;</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a><span class="co">// CRUD operations</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> id <span class="op">=</span> <span class="cf">await</span> idb<span class="op">.</span><span class="fu">add</span>({ <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Report&#39;</span><span class="op">,</span> <span class="dt">status</span><span class="op">:</span> <span class="st">&#39;draft&#39;</span> })<span class="op">;</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> doc <span class="op">=</span> <span class="cf">await</span> idb<span class="op">.</span><span class="fu">get</span>(id)<span class="op">;</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>doc<span class="op">.</span><span class="at">status</span> <span class="op">=</span> <span class="st">&#39;published&#39;</span><span class="op">;</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> idb<span class="op">.</span><span class="fu">put</span>(doc)<span class="op">;</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Query</span></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> drafts <span class="op">=</span> <span class="cf">await</span> idb<span class="op">.</span><span class="fu">query</span>(<span class="st">&#39;byStatus&#39;</span><span class="op">,</span> <span class="st">&#39;draft&#39;</span>)<span class="op">;</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> recent <span class="op">=</span> <span class="cf">await</span> idb<span class="op">.</span><span class="fu">list</span>({ </span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">index</span><span class="op">:</span> <span class="st">&#39;byCreated&#39;</span><span class="op">,</span> </span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">direction</span><span class="op">:</span> <span class="st">&#39;prev&#39;</span><span class="op">,</span> </span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">limit</span><span class="op">:</span> <span class="dv">5</span> </span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Count and delete</span></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> total <span class="op">=</span> <span class="cf">await</span> idb<span class="op">.</span><span class="fu">count</span>()<span class="op">;</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> idb<span class="op">.</span><span class="fu">delete</span>(id)<span class="op">;</span></span></code></pre></div>
<h3 data-number="18.2.5" id="complete-example-10"><span
class="header-section-number">18.2.5</span> Complete Example</h3>
<div class="sourceCode" id="cb235"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Document Manager<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-idb</span></span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    database</span><span class="op">=</span><span class="st">&quot;docapp&quot;</span></span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    store</span><span class="op">=</span><span class="st">&quot;documents&quot;</span></span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    key-path</span><span class="op">=</span><span class="st">&quot;id&quot;</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a><span class="ot">    auto-increment</span></span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    indexes</span><span class="op">=</span><span class="st">&#39;[</span></span>
<span id="cb235-11"><a href="#cb235-11" aria-hidden="true" tabindex="-1"></a><span class="st">      {&quot;name&quot;:&quot;byTitle&quot;,&quot;keyPath&quot;:&quot;title&quot;},</span></span>
<span id="cb235-12"><a href="#cb235-12" aria-hidden="true" tabindex="-1"></a><span class="st">      {&quot;name&quot;:&quot;byCreated&quot;,&quot;keyPath&quot;:&quot;created&quot;}</span></span>
<span id="cb235-13"><a href="#cb235-13" aria-hidden="true" tabindex="-1"></a><span class="st">    ]&#39;</span><span class="dt">&gt;</span></span>
<span id="cb235-14"><a href="#cb235-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-idb</span><span class="dt">&gt;</span></span>
<span id="cb235-15"><a href="#cb235-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-16"><a href="#cb235-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;doc-form&quot;</span><span class="dt">&gt;</span></span>
<span id="cb235-17"><a href="#cb235-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;title&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Title&quot;</span><span class="ot"> required</span><span class="dt">&gt;</span></span>
<span id="cb235-18"><a href="#cb235-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">textarea</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;content&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Content&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">textarea</span><span class="dt">&gt;</span></span>
<span id="cb235-19"><a href="#cb235-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="dt">&gt;</span>Save<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb235-20"><a href="#cb235-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb235-21"><a href="#cb235-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-22"><a href="#cb235-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">ul</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;doc-list&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">ul</span><span class="dt">&gt;</span></span>
<span id="cb235-23"><a href="#cb235-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-24"><a href="#cb235-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb235-25"><a href="#cb235-25" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb235-26"><a href="#cb235-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-27"><a href="#cb235-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb235-28"><a href="#cb235-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;doc-form&#39;</span>)<span class="op">;</span></span>
<span id="cb235-29"><a href="#cb235-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> list <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;doc-list&#39;</span>)<span class="op">;</span></span>
<span id="cb235-30"><a href="#cb235-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-31"><a href="#cb235-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for ready</span></span>
<span id="cb235-32"><a href="#cb235-32" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;documents.idb.ready&#39;</span><span class="op">,</span> loadDocuments)<span class="op">;</span></span>
<span id="cb235-33"><a href="#cb235-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-34"><a href="#cb235-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save document</span></span>
<span id="cb235-35"><a href="#cb235-35" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb235-36"><a href="#cb235-36" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb235-37"><a href="#cb235-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(form)<span class="op">;</span></span>
<span id="cb235-38"><a href="#cb235-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-39"><a href="#cb235-39" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb235-40"><a href="#cb235-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.add&#39;</span><span class="op">,</span></span>
<span id="cb235-41"><a href="#cb235-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb235-42"><a href="#cb235-42" aria-hidden="true" tabindex="-1"></a>          <span class="dt">item</span><span class="op">:</span> {</span>
<span id="cb235-43"><a href="#cb235-43" aria-hidden="true" tabindex="-1"></a>            <span class="dt">title</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;title&#39;</span>)<span class="op">,</span></span>
<span id="cb235-44"><a href="#cb235-44" aria-hidden="true" tabindex="-1"></a>            <span class="dt">content</span><span class="op">:</span> formData<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;content&#39;</span>)<span class="op">,</span></span>
<span id="cb235-45"><a href="#cb235-45" aria-hidden="true" tabindex="-1"></a>            <span class="dt">created</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb235-46"><a href="#cb235-46" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb235-47"><a href="#cb235-47" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb235-48"><a href="#cb235-48" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb235-49"><a href="#cb235-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-50"><a href="#cb235-50" aria-hidden="true" tabindex="-1"></a>      form<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb235-51"><a href="#cb235-51" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb235-52"><a href="#cb235-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-53"><a href="#cb235-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load documents</span></span>
<span id="cb235-54"><a href="#cb235-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">loadDocuments</span>() {</span>
<span id="cb235-55"><a href="#cb235-55" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb235-56"><a href="#cb235-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.list&#39;</span><span class="op">,</span></span>
<span id="cb235-57"><a href="#cb235-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> { <span class="dt">index</span><span class="op">:</span> <span class="st">&#39;byCreated&#39;</span><span class="op">,</span> <span class="dt">direction</span><span class="op">:</span> <span class="st">&#39;prev&#39;</span><span class="op">,</span> <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span> }</span>
<span id="cb235-58"><a href="#cb235-58" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb235-59"><a href="#cb235-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb235-60"><a href="#cb235-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-61"><a href="#cb235-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render results</span></span>
<span id="cb235-62"><a href="#cb235-62" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;documents.idb.result&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb235-63"><a href="#cb235-63" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;add&#39;</span>) <span class="fu">loadDocuments</span>()<span class="op">;</span></span>
<span id="cb235-64"><a href="#cb235-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;list&#39;</span>) <span class="fu">renderDocuments</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb235-65"><a href="#cb235-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;delete&#39;</span>) <span class="fu">loadDocuments</span>()<span class="op">;</span></span>
<span id="cb235-66"><a href="#cb235-66" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb235-67"><a href="#cb235-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-68"><a href="#cb235-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">renderDocuments</span>(docs) {</span>
<span id="cb235-69"><a href="#cb235-69" aria-hidden="true" tabindex="-1"></a>      list<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> docs<span class="op">.</span><span class="fu">map</span>(doc <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb235-70"><a href="#cb235-70" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;li&gt;</span></span>
<span id="cb235-71"><a href="#cb235-71" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;strong&gt;</span><span class="sc">${</span>doc<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/strong&gt;</span></span>
<span id="cb235-72"><a href="#cb235-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;</span><span class="sc">${</span>doc<span class="op">.</span><span class="at">content</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb235-73"><a href="#cb235-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;small&gt;</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(doc<span class="op">.</span><span class="at">created</span>)<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs">&lt;/small&gt;</span></span>
<span id="cb235-74"><a href="#cb235-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;deleteDoc(</span><span class="sc">${</span>doc<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;Delete&lt;/button&gt;</span></span>
<span id="cb235-75"><a href="#cb235-75" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/li&gt;</span></span>
<span id="cb235-76"><a href="#cb235-76" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb235-77"><a href="#cb235-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb235-78"><a href="#cb235-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-79"><a href="#cb235-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">deleteDoc</span> <span class="op">=</span> (id) <span class="kw">=&gt;</span> {</span>
<span id="cb235-80"><a href="#cb235-80" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>({ <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.delete&#39;</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> { <span class="dt">key</span><span class="op">:</span> id } })<span class="op">;</span></span>
<span id="cb235-81"><a href="#cb235-81" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb235-82"><a href="#cb235-82" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb235-83"><a href="#cb235-83" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb235-84"><a href="#cb235-84" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="18.2.6" id="errors-5"><span
class="header-section-number">18.2.6</span> Errors</h3>
<p>pan-idb publishes error messages to
<code>{storeName}.idb.error</code> topic:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_OPEN_FAILED</code></td>
<td>Cannot open IndexedDB</td>
<td>Check browser support, quota, or permissions</td>
</tr>
<tr>
<td><code>STORE_NOT_FOUND</code></td>
<td>Object store doesn’t exist</td>
<td>Set correct <code>store</code> attribute or upgrade database
version</td>
</tr>
<tr>
<td><code>VERSION_ERROR</code></td>
<td>Version downgrade attempted</td>
<td>Remove old database or increment version number</td>
</tr>
<tr>
<td><code>QUOTA_EXCEEDED</code></td>
<td>Storage limit reached</td>
<td>Clear old data or request persistent storage</td>
</tr>
<tr>
<td><code>TRANSACTION_FAILED</code></td>
<td>Transaction aborted</td>
<td>Check data validity, reduce transaction size</td>
</tr>
<tr>
<td><code>INDEX_ERROR</code></td>
<td>Index operation failed</td>
<td>Verify index exists and data matches index keyPath</td>
</tr>
<tr>
<td><code>KEY_ERROR</code></td>
<td>Invalid key provided</td>
<td>Use valid key type (number, string, date, array)</td>
</tr>
<tr>
<td><code>DATA_ERROR</code></td>
<td>Data cannot be cloned</td>
<td>Remove non-cloneable values (functions, DOM nodes)</td>
</tr>
<tr>
<td><code>READ_ONLY_ERROR</code></td>
<td>Write on readonly transaction</td>
<td>Use correct transaction mode</td>
</tr>
<tr>
<td><code>NOT_SUPPORTED</code></td>
<td>Browser doesn’t support IndexedDB</td>
<td>Provide fallback (localStorage, memory store)</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb236"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> idb <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-idb&#39;</span>)<span class="op">;</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to errors</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;documents.idb.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> error<span class="op">,</span> operation } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`IDB error [</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle specific errors</span></span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (code) {</span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;QUOTA_EXCEEDED&#39;</span><span class="op">:</span></span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Prompt user to clear data</span></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">confirm</span>(<span class="st">&#39;Storage full. Clear old data?&#39;</span>)) {</span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>({ <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.clear&#39;</span> })<span class="op">;</span></span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;VERSION_ERROR&#39;</span><span class="op">:</span></span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Database needs upgrade</span></span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Please reload to upgrade database&#39;</span>)<span class="op">;</span></span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>      location<span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;NOT_SUPPORTED&#39;</span><span class="op">:</span></span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Fallback to alternative storage</span></span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;IndexedDB not available, using localStorage&#39;</span>)<span class="op">;</span></span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">initLocalStorageFallback</span>()<span class="op">;</span></span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;DB_OPEN_FAILED&#39;</span><span class="op">:</span></span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Retry with exponential backoff</span></span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a>        idb<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;database&#39;</span><span class="op">,</span> idb<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;database&#39;</span>))<span class="op">;</span></span>
<span id="cb236-34"><a href="#cb236-34" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">1000</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> retryCount<span class="op">++</span>))<span class="op">;</span></span>
<span id="cb236-35"><a href="#cb236-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb236-36"><a href="#cb236-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-37"><a href="#cb236-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb236-38"><a href="#cb236-38" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Generic error handling</span></span>
<span id="cb236-39"><a href="#cb236-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showErrorNotification</span>(<span class="vs">`Database error: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb236-40"><a href="#cb236-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-41"><a href="#cb236-41" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb236-42"><a href="#cb236-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-43"><a href="#cb236-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Graceful degradation</span></span>
<span id="cb236-44"><a href="#cb236-44" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;documents.idb.error&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb236-45"><a href="#cb236-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">code</span> <span class="op">===</span> <span class="st">&#39;NOT_SUPPORTED&#39;</span> <span class="op">||</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">code</span> <span class="op">===</span> <span class="st">&#39;DB_OPEN_FAILED&#39;</span>) {</span>
<span id="cb236-46"><a href="#cb236-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Switch to memory-only mode</span></span>
<span id="cb236-47"><a href="#cb236-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">inMemoryStore</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb236-48"><a href="#cb236-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Using in-memory storage (data will not persist)&#39;</span>)<span class="op">;</span></span>
<span id="cb236-49"><a href="#cb236-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-50"><a href="#cb236-50" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb236-51"><a href="#cb236-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-52"><a href="#cb236-52" aria-hidden="true" tabindex="-1"></a><span class="co">// Quota management</span></span>
<span id="cb236-53"><a href="#cb236-53" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">checkQuota</span>() {</span>
<span id="cb236-54"><a href="#cb236-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span> <span class="op">&amp;&amp;</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="at">estimate</span>) {</span>
<span id="cb236-55"><a href="#cb236-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> estimate <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">estimate</span>()<span class="op">;</span></span>
<span id="cb236-56"><a href="#cb236-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> percentUsed <span class="op">=</span> (estimate<span class="op">.</span><span class="at">usage</span> <span class="op">/</span> estimate<span class="op">.</span><span class="at">quota</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb236-57"><a href="#cb236-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-58"><a href="#cb236-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (percentUsed <span class="op">&gt;</span> <span class="dv">90</span>) {</span>
<span id="cb236-59"><a href="#cb236-59" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Storage </span><span class="sc">${</span>percentUsed<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs">% full`</span>)<span class="op">;</span></span>
<span id="cb236-60"><a href="#cb236-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Trigger cleanup</span></span>
<span id="cb236-61"><a href="#cb236-61" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">publish</span>({ <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;documents.idb.cleanup&#39;</span> })<span class="op">;</span></span>
<span id="cb236-62"><a href="#cb236-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb236-63"><a href="#cb236-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-64"><a href="#cb236-64" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>DOMException</code>: IndexedDB-specific errors
(InvalidStateError, ConstraintError, etc.)</li>
<li><code>TypeError</code>: Invalid parameters (e.g., non-cloneable
data)</li>
<li><code>QuotaExceededError</code>: Storage limit reached</li>
<li><code>Error</code>: General database operation failures</li>
</ul>
<p><strong>Browser Compatibility Notes</strong>:</p>
<ul>
<li>IndexedDB supported in all modern browsers (Chrome 24+, Firefox 16+,
Safari 10+)</li>
<li>Private browsing may disable or limit IndexedDB</li>
<li>Check support: <code>if ('indexedDB' in window)</code></li>
</ul>
<h3 data-number="18.2.7" id="common-issues-19"><span
class="header-section-number">18.2.7</span> Common Issues</h3>
<p><strong>Database version conflicts</strong>: Different tabs with
different versions</p>
<div class="sourceCode" id="cb237"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle versionchange event</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>idb<span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;versionchange&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>  idb<span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alert</span>(<span class="st">&#39;Database upgraded. Please reload.&#39;</span>)<span class="op">;</span></span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Quota exceeded</strong>: Check available storage</p>
<div class="sourceCode" id="cb238"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span> <span class="op">&amp;&amp;</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="at">estimate</span>) {</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> estimate <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">estimate</span>()<span class="op">;</span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> percent <span class="op">=</span> (estimate<span class="op">.</span><span class="at">usage</span> <span class="op">/</span> estimate<span class="op">.</span><span class="at">quota</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (percent <span class="op">&gt;</span> <span class="dv">90</span>) <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Storage nearly full&#39;</span>)<span class="op">;</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Index not working after schema changes</strong>: Increment
version number</p>
<div class="sourceCode" id="cb239"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Change version=&quot;1&quot; to version=&quot;2&quot; --&gt;</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-idb</span><span class="ot"> database</span><span class="op">=</span><span class="st">&quot;myapp&quot;</span><span class="ot"> store</span><span class="op">=</span><span class="st">&quot;docs&quot;</span><span class="ot"> version</span><span class="op">=</span><span class="st">&quot;2&quot;</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Transaction timeouts</strong>: Break bulk operations into
batches</p>
<div class="sourceCode" id="cb240"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">bulkInsert</span>(items) {</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> BATCH_SIZE <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> items<span class="op">.</span><span class="at">length</span><span class="op">;</span> i <span class="op">+=</span> BATCH_SIZE) {</span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> batch <span class="op">=</span> items<span class="op">.</span><span class="fu">slice</span>(i<span class="op">,</span> i <span class="op">+</span> BATCH_SIZE)<span class="op">;</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> item <span class="kw">of</span> batch) <span class="cf">await</span> idb<span class="op">.</span><span class="fu">add</span>(item)<span class="op">;</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(r <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(r<span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span> <span class="co">// Yield</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
<h2 data-number="18.3" id="summary-1"><span
class="header-section-number">18.3</span> Summary</h2>
<p>This chapter documented LARC’s data management components:</p>
<ul>
<li><strong>pan-store</strong>: Reactive state management with
Proxy-based observation</li>
<li><strong>pan-idb</strong>: IndexedDB integration via PAN message
bus</li>
</ul>
<p>Use pan-store for reactive application state, pan-idb for persistent
storage.</p>
<p><strong>See Also</strong>:</p>
<ul>
<li>Tutorial: <em>Learning LARC</em> Chapter 6</li>
<li>Message bus: Chapter 17</li>
<li>UI components: Chapter 19</li>
<li>State patterns: Appendix A</li>
</ul>
<h1 data-number="19" id="ui-components-reference"><span
class="header-section-number">19</span> UI Components Reference</h1>
<p>API documentation for LARC’s UI components. For tutorials, see
<em>Learning LARC</em> Chapter 10.</p>
<h2 data-number="19.1" id="pan-files"><span
class="header-section-number">19.1</span> pan-files</h2>
<p><strong>Purpose</strong>: OPFS-backed file system browser with visual
UI and programmatic API<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-files.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="19.1.1" id="quick-example-19"><span
class="header-section-number">19.1.1</span> Quick Example</h3>
<div class="sourceCode" id="cb241"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-files</span><span class="ot"> filter</span><span class="op">=</span><span class="st">&quot;.md,.txt&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-files</span><span class="dt">&gt;</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> files <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-files&#39;</span>)<span class="op">;</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Write file</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> files<span class="op">.</span><span class="fu">writeFile</span>(<span class="st">&#39;/notes.txt&#39;</span><span class="op">,</span> <span class="st">&#39;Hello, World!&#39;</span>)<span class="op">;</span></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Read file</span></span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> content <span class="op">=</span> <span class="cf">await</span> files<span class="op">.</span><span class="fu">readFile</span>(<span class="st">&#39;/notes.txt&#39;</span>)<span class="op">;</span></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a><span class="co">// List files</span></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> allFiles <span class="op">=</span> <span class="cf">await</span> files<span class="op">.</span><span class="fu">listFiles</span>()<span class="op">;</span></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="19.1.2" id="attributes-4"><span
class="header-section-number">19.1.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>path</code></td>
<td>String</td>
<td>“/”</td>
<td>Current directory path (root level only)</td>
</tr>
<tr>
<td><code>filter</code></td>
<td>String</td>
<td>“”</td>
<td>Comma-separated file extensions to display</td>
</tr>
<tr>
<td><code>show-hidden</code></td>
<td>Boolean</td>
<td>false</td>
<td>Show files starting with dot</td>
</tr>
</tbody>
</table>
<h3 data-number="19.1.3" id="methods-4"><span
class="header-section-number">19.1.3</span> Methods</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>writeFile(path, content)</code></td>
<td>path: String, content: String</td>
<td>Promise&lt;void&gt;</td>
<td>Write file (creates or overwrites)</td>
</tr>
<tr>
<td><code>readFile(path)</code></td>
<td>path: String</td>
<td>Promise&lt;String&gt;</td>
<td>Read file contents</td>
</tr>
<tr>
<td><code>deleteFile(path)</code></td>
<td>path: String</td>
<td>Promise&lt;void&gt;</td>
<td>Delete file</td>
</tr>
<tr>
<td><code>listFiles()</code></td>
<td>-</td>
<td>Promise&lt;Array&lt;FileInfo&gt;&gt;</td>
<td>Get all files in directory</td>
</tr>
<tr>
<td><code>refresh()</code></td>
<td>-</td>
<td>Promise&lt;void&gt;</td>
<td>Reload file list and update UI</td>
</tr>
</tbody>
</table>
<p><strong>FileInfo structure:</strong></p>
<div class="sourceCode" id="cb242"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;example.txt&#39;</span><span class="op">,</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/example.txt&#39;</span><span class="op">,</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">isDirectory</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size</span><span class="op">:</span> <span class="dv">1024</span><span class="op">,</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">entry</span><span class="op">:</span> FileSystemHandle</span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.1.4" id="pan-events"><span
class="header-section-number">19.1.4</span> PAN Events</h3>
<h4 data-number="19.1.4.1" id="published"><span
class="header-section-number">19.1.4.1</span> Published</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file.selected</code></td>
<td><code>{ path, name, isDirectory }</code></td>
<td>User clicked file</td>
</tr>
<tr>
<td><code>file.created</code></td>
<td><code>{ path, name, isDirectory }</code></td>
<td>File/folder created</td>
</tr>
<tr>
<td><code>file.deleted</code></td>
<td><code>{ path }</code></td>
<td>File deleted</td>
</tr>
<tr>
<td><code>file.renamed</code></td>
<td><code>{ oldPath, newPath }</code></td>
<td>File renamed</td>
</tr>
<tr>
<td><code>file.content-loaded</code></td>
<td><code>{ path, content }</code></td>
<td>Response to file.load</td>
</tr>
</tbody>
</table>
<h4 data-number="19.1.4.2" id="subscribed"><span
class="header-section-number">19.1.4.2</span> Subscribed</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file.save</code></td>
<td><code>{ path, content }</code></td>
<td>Save file</td>
</tr>
<tr>
<td><code>file.load</code></td>
<td><code>{ path }</code></td>
<td>Load file (triggers file.content-loaded)</td>
</tr>
<tr>
<td><code>file.delete</code></td>
<td><code>{ path }</code></td>
<td>Delete file</td>
</tr>
<tr>
<td><code>file.create</code></td>
<td><code>{ path, content? }</code></td>
<td>Create file with optional content</td>
</tr>
</tbody>
</table>
<h3 data-number="19.1.5" id="complete-example-11"><span
class="header-section-number">19.1.5</span> Complete Example</h3>
<div class="sourceCode" id="cb243"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-files.mjs&#39;</span><span class="op">;</span></span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> files <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-files&#39;</span>)<span class="op">;</span></span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load file content when selected</span></span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;file.selected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>        bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;file.load&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">path</span> })<span class="op">;</span></span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;file.content-loaded&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;preview&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">content</span><span class="op">;</span></span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-21"><a href="#cb243-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Create quick note</span></span>
<span id="cb243-22"><a href="#cb243-22" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">createNote</span> <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb243-23"><a href="#cb243-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> files<span class="op">.</span><span class="fu">writeFile</span>(</span>
<span id="cb243-24"><a href="#cb243-24" aria-hidden="true" tabindex="-1"></a>          <span class="vs">`/note-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">.txt`</span><span class="op">,</span></span>
<span id="cb243-25"><a href="#cb243-25" aria-hidden="true" tabindex="-1"></a>          <span class="vs">`Created at </span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb243-26"><a href="#cb243-26" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb243-27"><a href="#cb243-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> files<span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb243-28"><a href="#cb243-28" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb243-29"><a href="#cb243-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb243-30"><a href="#cb243-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb243-31"><a href="#cb243-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb243-32"><a href="#cb243-32" aria-hidden="true" tabindex="-1"></a>    body { <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span> <span class="kw">grid-template-columns</span><span class="ch">:</span> <span class="dv">300</span><span class="dt">px</span> <span class="dv">1</span><span class="dt">fr</span><span class="op">;</span> <span class="kw">gap</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> }</span>
<span id="cb243-33"><a href="#cb243-33" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#preview</span> { <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">border</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ccc</span><span class="op">;</span> <span class="kw">white-space</span><span class="ch">:</span> <span class="dv">pre-wrap</span><span class="op">;</span> <span class="kw">font-family</span><span class="ch">:</span> <span class="dv">monospace</span><span class="op">;</span> }</span>
<span id="cb243-34"><a href="#cb243-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb243-35"><a href="#cb243-35" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb243-36"><a href="#cb243-36" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb243-37"><a href="#cb243-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb243-38"><a href="#cb243-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-files</span><span class="ot"> filter</span><span class="op">=</span><span class="st">&quot;.txt,.md&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-files</span><span class="dt">&gt;</span></span>
<span id="cb243-39"><a href="#cb243-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb243-40"><a href="#cb243-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;createNote()&quot;</span><span class="dt">&gt;</span>Create Note<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb243-41"><a href="#cb243-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pre</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;preview&quot;</span><span class="dt">&gt;</span>Select a file...<span class="dt">&lt;/</span><span class="kw">pre</span><span class="dt">&gt;</span></span>
<span id="cb243-42"><a href="#cb243-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb243-43"><a href="#cb243-43" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb243-44"><a href="#cb243-44" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="19.1.6" id="errors-6"><span
class="header-section-number">19.1.6</span> Errors</h3>
<p>pan-files dispatches custom <code>error</code> events and publishes
to <code>file.error</code> topic:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OPFS_NOT_SUPPORTED</code></td>
<td>Browser doesn’t support OPFS</td>
<td>Use Chrome 102+, Edge 102+, or provide fallback</td>
</tr>
<tr>
<td><code>OPFS_INIT_FAILED</code></td>
<td>Failed to initialize file system</td>
<td>Check HTTPS connection (or localhost)</td>
</tr>
<tr>
<td><code>FILE_NOT_FOUND</code></td>
<td>File doesn’t exist</td>
<td>Verify path or catch error gracefully</td>
</tr>
<tr>
<td><code>WRITE_FAILED</code></td>
<td>Cannot write file</td>
<td>Check storage quota or permissions</td>
</tr>
<tr>
<td><code>READ_FAILED</code></td>
<td>Cannot read file</td>
<td>Verify file exists and is accessible</td>
</tr>
<tr>
<td><code>DELETE_FAILED</code></td>
<td>Cannot delete file</td>
<td>Check if file is locked or in use</td>
</tr>
<tr>
<td><code>QUOTA_EXCEEDED</code></td>
<td>Storage quota exceeded</td>
<td>Clear old files or request persistent storage</td>
</tr>
<tr>
<td><code>INVALID_PATH</code></td>
<td>Path contains invalid characters</td>
<td>Use valid path format (no <code>&lt;&gt;:"|?*</code>)</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb244"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> files <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-files&#39;</span>)<span class="op">;</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for errors via DOM event</span></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>files<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> message<span class="op">,</span> path } <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`File error [</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (code) {</span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;OPFS_NOT_SUPPORTED&#39;</span><span class="op">:</span></span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showFallbackUI</span>()<span class="op">;</span></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;QUOTA_EXCEEDED&#39;</span><span class="op">:</span></span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">promptUserToCleanup</span>()<span class="op">;</span></span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;FILE_NOT_FOUND&#39;</span><span class="op">:</span></span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`File not found: </span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Or subscribe via PAN bus</span></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;file.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> message<span class="op">,</span> path } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">displayErrorToUser</span>(message)<span class="op">;</span></span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe file operations with try-catch</span></span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">safeWriteFile</span>(path<span class="op">,</span> content) {</span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> files<span class="op">.</span><span class="fu">writeFile</span>(path<span class="op">,</span> content)<span class="op">;</span></span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> files<span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Write failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to localStorage or download</span></span>
<span id="cb244-36"><a href="#cb244-36" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="vs">`backup_</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> content)<span class="op">;</span></span>
<span id="cb244-37"><a href="#cb244-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-38"><a href="#cb244-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb244-39"><a href="#cb244-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-40"><a href="#cb244-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Check quota before large operations</span></span>
<span id="cb244-41"><a href="#cb244-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span> <span class="op">&amp;&amp;</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="at">estimate</span>) {</span>
<span id="cb244-42"><a href="#cb244-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> estimate <span class="op">=</span> <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">storage</span><span class="op">.</span><span class="fu">estimate</span>()<span class="op">;</span></span>
<span id="cb244-43"><a href="#cb244-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> percentUsed <span class="op">=</span> (estimate<span class="op">.</span><span class="at">usage</span> <span class="op">/</span> estimate<span class="op">.</span><span class="at">quota</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb244-44"><a href="#cb244-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb244-45"><a href="#cb244-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (percentUsed <span class="op">&gt;</span> <span class="dv">90</span>) {</span>
<span id="cb244-46"><a href="#cb244-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Storage nearly full, cleanup recommended&#39;</span>)<span class="op">;</span></span>
<span id="cb244-47"><a href="#cb244-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-48"><a href="#cb244-48" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>DOMException</code>: OPFS-specific errors (NotFoundError,
QuotaExceededError)</li>
<li><code>TypeError</code>: Invalid parameters (non-string path, invalid
content type)</li>
<li><code>Error</code>: General file operation failures</li>
</ul>
<p><strong>Browser Compatibility Notes</strong>:</p>
<ul>
<li>OPFS requires Chrome 102+, Edge 102+, Opera 88+</li>
<li>Not available in Firefox as of December 2024</li>
<li>Requires HTTPS or localhost (not available on
<code>http://</code>)</li>
<li>Private/incognito mode may have reduced quota</li>
<li>Check support:
<code>if ('storage' in navigator &amp;&amp; 'getDirectory' in navigator.storage)</code></li>
</ul>
<h3 data-number="19.1.7" id="common-issues-20"><span
class="header-section-number">19.1.7</span> Common Issues</h3>
<p><strong>Files don’t persist</strong>: OPFS storage clears if user
clears browser data, uses private mode, or exceeds quota. Provide export
functionality for critical data.</p>
<p><strong>“Failed to initialize OPFS”</strong>: Requires HTTPS (or
localhost). Check browser support: Chrome 102+, Edge 102+, Opera
88+.</p>
<p><strong>File list doesn’t update</strong>: Call
<code>refresh()</code> after <code>writeFile()</code> or
<code>deleteFile()</code>.</p>
<p><strong>Can’t access files from network</strong>: OPFS is
origin-private by design. Read content and send via fetch/WebSocket to
share.</p>
<hr />
<h2 data-number="19.2" id="pan-markdown-editor"><span
class="header-section-number">19.2</span> pan-markdown-editor</h2>
<p><strong>Purpose</strong>: Rich markdown editor with toolbar, preview,
and auto-save<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-markdown-editor.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="19.2.1" id="quick-example-20"><span
class="header-section-number">19.2.1</span> Quick Example</h3>
<div class="sourceCode" id="cb245"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-markdown-editor</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  value</span><span class="op">=</span><span class="st">&quot;# Hello World&quot;</span></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  preview</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  autosave</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  placeholder</span><span class="op">=</span><span class="st">&quot;Start writing...&quot;</span><span class="dt">&gt;</span></span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-markdown-editor</span><span class="dt">&gt;</span></span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> editor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Get content</span></span>
<span id="cb245-12"><a href="#cb245-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> markdown <span class="op">=</span> editor<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb245-13"><a href="#cb245-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-14"><a href="#cb245-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Set content</span></span>
<span id="cb245-15"><a href="#cb245-15" aria-hidden="true" tabindex="-1"></a>editor<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;# New Content&#39;</span>)<span class="op">;</span></span>
<span id="cb245-16"><a href="#cb245-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-17"><a href="#cb245-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Insert at cursor</span></span>
<span id="cb245-18"><a href="#cb245-18" aria-hidden="true" tabindex="-1"></a>editor<span class="op">.</span><span class="fu">insertText</span>(<span class="st">&#39;</span><span class="sc">\n\n</span><span class="st">---</span><span class="sc">\n\n</span><span class="st">&#39;</span>)<span class="op">;</span></span>
<span id="cb245-19"><a href="#cb245-19" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="19.2.2" id="attributes-5"><span
class="header-section-number">19.2.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>value</code></td>
<td>String</td>
<td>“”</td>
<td>Initial markdown content</td>
</tr>
<tr>
<td><code>placeholder</code></td>
<td>String</td>
<td>“Start writing…”</td>
<td>Placeholder text</td>
</tr>
<tr>
<td><code>preview</code></td>
<td>Boolean</td>
<td>false</td>
<td>Show live preview pane</td>
</tr>
<tr>
<td><code>autosave</code></td>
<td>Boolean</td>
<td>false</td>
<td>Enable auto-save (1s debounce)</td>
</tr>
</tbody>
</table>
<h3 data-number="19.2.3" id="methods-5"><span
class="header-section-number">19.2.3</span> Methods</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setValue(value)</code></td>
<td>value: String</td>
<td>void</td>
<td>Set editor content</td>
</tr>
<tr>
<td><code>getValue()</code></td>
<td>-</td>
<td>String</td>
<td>Get current content</td>
</tr>
<tr>
<td><code>insertText(text)</code></td>
<td>text: String</td>
<td>void</td>
<td>Insert at cursor position</td>
</tr>
<tr>
<td><code>focus()</code></td>
<td>-</td>
<td>void</td>
<td>Focus editor textarea</td>
</tr>
</tbody>
</table>
<h3 data-number="19.2.4" id="toolbar-actions"><span
class="header-section-number">19.2.4</span> Toolbar Actions</h3>
<table>
<thead>
<tr>
<th>Button</th>
<th>Action</th>
<th>Shortcut</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>B</strong></td>
<td>Bold</td>
<td>Ctrl+B</td>
<td><code>**text**</code></td>
</tr>
<tr>
<td><strong>I</strong></td>
<td>Italic</td>
<td>Ctrl+I</td>
<td><code>*text*</code></td>
</tr>
<tr>
<td><strong>S</strong></td>
<td>Strikethrough</td>
<td>-</td>
<td><code>~~text~~</code></td>
</tr>
<tr>
<td>H1-H3</td>
<td>Headings</td>
<td>-</td>
<td><code># text</code></td>
</tr>
<tr>
<td>*</td>
<td>Bullet list</td>
<td>-</td>
<td><code>* item</code></td>
</tr>
<tr>
<td>1.</td>
<td>Numbered list</td>
<td>-</td>
<td><code>1. item</code></td>
</tr>
<tr>
<td><a href="#v">v</a></td>
<td>Task list</td>
<td>-</td>
<td><code>- [ ] task</code></td>
</tr>
<tr>
<td>[link]</td>
<td>Link</td>
<td>Ctrl+K</td>
<td><code>[text](url)</code></td>
</tr>
<tr>
<td>[img]</td>
<td>Image</td>
<td>-</td>
<td><code>![alt](url)</code></td>
</tr>
<tr>
<td>{ }</td>
<td>Inline code</td>
<td>-</td>
<td><code>`code`</code></td>
</tr>
<tr>
<td>&lt;/&gt;</td>
<td>Code block</td>
<td>-</td>
<td><code>```lang\ncode\n```</code></td>
</tr>
<tr>
<td>”</td>
<td>Blockquote</td>
<td>-</td>
<td><code>&gt; quote</code></td>
</tr>
<tr>
<td>-</td>
<td>Horizontal rule</td>
<td>-</td>
<td><code>---</code></td>
</tr>
<tr>
<td>[+]</td>
<td>Table</td>
<td>-</td>
<td>Markdown table</td>
</tr>
<tr>
<td>[eye]</td>
<td>Preview</td>
<td>-</td>
<td>Toggle preview pane</td>
</tr>
</tbody>
</table>
<p><strong>Additional shortcuts:</strong> - Ctrl+S: Save (triggers
<code>markdown.saved</code>) - Tab: Insert two spaces - Enter:
Auto-continue lists</p>
<h3 data-number="19.2.5" id="pan-events-1"><span
class="header-section-number">19.2.5</span> PAN Events</h3>
<h4 data-number="19.2.5.1" id="published-1"><span
class="header-section-number">19.2.5.1</span> Published</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>markdown.changed</code></td>
<td><code>{ content, wordCount, charCount }</code></td>
<td>Content changed</td>
</tr>
<tr>
<td><code>markdown.saved</code></td>
<td><code>{ content }</code></td>
<td>Ctrl+S pressed or auto-save</td>
</tr>
</tbody>
</table>
<h4 data-number="19.2.5.2" id="subscribed-1"><span
class="header-section-number">19.2.5.2</span> Subscribed</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>markdown.set-content</code></td>
<td><code>{ content }</code></td>
<td>Set editor content</td>
</tr>
<tr>
<td><code>markdown.get-content</code></td>
<td><code>{}</code></td>
<td>Request content (responds with markdown.content-response)</td>
</tr>
</tbody>
</table>
<h3 data-number="19.2.6" id="complete-example-12"><span
class="header-section-number">19.2.6</span> Complete Example</h3>
<div class="sourceCode" id="cb246"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-files.mjs&#39;</span><span class="op">;</span></span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-markdown-editor.mjs&#39;</span><span class="op">;</span></span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-markdown-renderer.mjs&#39;</span><span class="op">;</span></span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> currentFile <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load file into editor</span></span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;file.selected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb246-16"><a href="#cb246-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.md&#39;</span>)) {</span>
<span id="cb246-17"><a href="#cb246-17" aria-hidden="true" tabindex="-1"></a>          currentFile <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">path</span><span class="op">;</span></span>
<span id="cb246-18"><a href="#cb246-18" aria-hidden="true" tabindex="-1"></a>          bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;file.load&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">path</span> })<span class="op">;</span></span>
<span id="cb246-19"><a href="#cb246-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb246-20"><a href="#cb246-20" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb246-21"><a href="#cb246-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-22"><a href="#cb246-22" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;file.content-loaded&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb246-23"><a href="#cb246-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> editor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb246-24"><a href="#cb246-24" aria-hidden="true" tabindex="-1"></a>        editor<span class="op">.</span><span class="fu">setValue</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">content</span>)<span class="op">;</span></span>
<span id="cb246-25"><a href="#cb246-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;filename&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> </span>
<span id="cb246-26"><a href="#cb246-26" aria-hidden="true" tabindex="-1"></a>          msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb246-27"><a href="#cb246-27" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb246-28"><a href="#cb246-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-29"><a href="#cb246-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Save editor to file</span></span>
<span id="cb246-30"><a href="#cb246-30" aria-hidden="true" tabindex="-1"></a>      bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;markdown.saved&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb246-31"><a href="#cb246-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (currentFile) {</span>
<span id="cb246-32"><a href="#cb246-32" aria-hidden="true" tabindex="-1"></a>          bus<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;file.save&#39;</span><span class="op">,</span> {</span>
<span id="cb246-33"><a href="#cb246-33" aria-hidden="true" tabindex="-1"></a>            <span class="dt">path</span><span class="op">:</span> currentFile<span class="op">,</span></span>
<span id="cb246-34"><a href="#cb246-34" aria-hidden="true" tabindex="-1"></a>            <span class="dt">content</span><span class="op">:</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">content</span></span>
<span id="cb246-35"><a href="#cb246-35" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb246-36"><a href="#cb246-36" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb246-37"><a href="#cb246-37" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb246-38"><a href="#cb246-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-39"><a href="#cb246-39" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">createNote</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb246-40"><a href="#cb246-40" aria-hidden="true" tabindex="-1"></a>        currentFile <span class="op">=</span> <span class="vs">`/note-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">.md`</span><span class="op">;</span></span>
<span id="cb246-41"><a href="#cb246-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;filename&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> </span>
<span id="cb246-42"><a href="#cb246-42" aria-hidden="true" tabindex="-1"></a>          currentFile<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb246-43"><a href="#cb246-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> editor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb246-44"><a href="#cb246-44" aria-hidden="true" tabindex="-1"></a>        editor<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;# New Note</span><span class="sc">\n\n</span><span class="st">&#39;</span>)<span class="op">;</span></span>
<span id="cb246-45"><a href="#cb246-45" aria-hidden="true" tabindex="-1"></a>        editor<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb246-46"><a href="#cb246-46" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb246-47"><a href="#cb246-47" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb246-48"><a href="#cb246-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb246-49"><a href="#cb246-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb246-50"><a href="#cb246-50" aria-hidden="true" tabindex="-1"></a>    body { <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0</span><span class="op">;</span> <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span> <span class="kw">grid-template-rows</span><span class="ch">:</span> <span class="bu">auto</span> <span class="dv">1</span><span class="dt">fr</span><span class="op">;</span> <span class="kw">height</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">vh</span><span class="op">;</span> }</span>
<span id="cb246-51"><a href="#cb246-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.toolbar</span> { <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">border-bottom</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ccc</span><span class="op">;</span> <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span> <span class="kw">gap</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> }</span>
<span id="cb246-52"><a href="#cb246-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.content</span> { <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span> <span class="kw">grid-template-columns</span><span class="ch">:</span> <span class="dv">250</span><span class="dt">px</span> <span class="dv">1</span><span class="dt">fr</span><span class="op">;</span> <span class="kw">gap</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> }</span>
<span id="cb246-53"><a href="#cb246-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb246-54"><a href="#cb246-54" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb246-55"><a href="#cb246-55" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb246-56"><a href="#cb246-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb246-57"><a href="#cb246-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;toolbar&quot;</span><span class="dt">&gt;</span></span>
<span id="cb246-58"><a href="#cb246-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;filename&quot;</span><span class="dt">&gt;</span>No file selected<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb246-59"><a href="#cb246-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;createNote()&quot;</span><span class="dt">&gt;</span>New Note<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb246-60"><a href="#cb246-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb246-61"><a href="#cb246-61" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;content&quot;</span><span class="dt">&gt;</span></span>
<span id="cb246-62"><a href="#cb246-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-files</span><span class="ot"> filter</span><span class="op">=</span><span class="st">&quot;.md&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-files</span><span class="dt">&gt;</span></span>
<span id="cb246-63"><a href="#cb246-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-markdown-editor</span><span class="ot"> preview</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="ot"> autosave</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-markdown-editor</span><span class="dt">&gt;</span></span>
<span id="cb246-64"><a href="#cb246-64" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb246-65"><a href="#cb246-65" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb246-66"><a href="#cb246-66" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="19.2.7" id="errors-7"><span
class="header-section-number">19.2.7</span> Errors</h3>
<p>pan-markdown-editor dispatches <code>error</code> events for error
conditions:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RENDER_FAILED</code></td>
<td>Preview rendering failed</td>
<td>Check markdown syntax or disable preview</td>
</tr>
<tr>
<td><code>AUTOSAVE_FAILED</code></td>
<td>Auto-save operation failed</td>
<td>Check storage or disable autosave</td>
</tr>
<tr>
<td><code>INVALID_CONTENT</code></td>
<td>Non-string content passed to <code>setValue()</code></td>
<td>Pass valid string to <code>setValue()</code></td>
</tr>
<tr>
<td><code>TOOLBAR_ACTION_FAILED</code></td>
<td>Toolbar button action threw error</td>
<td>Check custom toolbar handlers</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb247"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> editor <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for errors</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>editor<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> message<span class="op">,</span> action } <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Editor error [</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (code) {</span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;RENDER_FAILED&#39;</span><span class="op">:</span></span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Disable preview temporarily</span></span>
<span id="cb247-11"><a href="#cb247-11" aria-hidden="true" tabindex="-1"></a>      editor<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;preview&#39;</span>)<span class="op">;</span></span>
<span id="cb247-12"><a href="#cb247-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="st">&#39;Preview disabled due to rendering error&#39;</span>)<span class="op">;</span></span>
<span id="cb247-13"><a href="#cb247-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb247-14"><a href="#cb247-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-15"><a href="#cb247-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;AUTOSAVE_FAILED&#39;</span><span class="op">:</span></span>
<span id="cb247-16"><a href="#cb247-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Manual save prompt</span></span>
<span id="cb247-17"><a href="#cb247-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">confirm</span>(<span class="st">&#39;Auto-save failed. Save manually?&#39;</span>)) {</span>
<span id="cb247-18"><a href="#cb247-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> content <span class="op">=</span> editor<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb247-19"><a href="#cb247-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">manualSave</span>(content)<span class="op">;</span></span>
<span id="cb247-20"><a href="#cb247-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb247-21"><a href="#cb247-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb247-22"><a href="#cb247-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-23"><a href="#cb247-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;INVALID_CONTENT&#39;</span><span class="op">:</span></span>
<span id="cb247-24"><a href="#cb247-24" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Attempted to set invalid content&#39;</span>)<span class="op">;</span></span>
<span id="cb247-25"><a href="#cb247-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb247-26"><a href="#cb247-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-27"><a href="#cb247-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb247-28"><a href="#cb247-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-29"><a href="#cb247-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe setValue with validation</span></span>
<span id="cb247-30"><a href="#cb247-30" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safeSetValue</span>(content) {</span>
<span id="cb247-31"><a href="#cb247-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> content <span class="op">!==</span> <span class="st">&#39;string&#39;</span>) {</span>
<span id="cb247-32"><a href="#cb247-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Content must be a string&#39;</span>)<span class="op">;</span></span>
<span id="cb247-33"><a href="#cb247-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb247-34"><a href="#cb247-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-35"><a href="#cb247-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb247-36"><a href="#cb247-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb247-37"><a href="#cb247-37" aria-hidden="true" tabindex="-1"></a>    editor<span class="op">.</span><span class="fu">setValue</span>(content)<span class="op">;</span></span>
<span id="cb247-38"><a href="#cb247-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb247-39"><a href="#cb247-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to set editor content:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb247-40"><a href="#cb247-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to plain textarea</span></span>
<span id="cb247-41"><a href="#cb247-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">useFallbackEditor</span>(content)<span class="op">;</span></span>
<span id="cb247-42"><a href="#cb247-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-43"><a href="#cb247-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb247-44"><a href="#cb247-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-45"><a href="#cb247-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Monitor autosave with error handling</span></span>
<span id="cb247-46"><a href="#cb247-46" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bus <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb247-47"><a href="#cb247-47" aria-hidden="true" tabindex="-1"></a>bus<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;markdown.saved&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb247-48"><a href="#cb247-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb247-49"><a href="#cb247-49" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;backup&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">content</span>)<span class="op">;</span></span>
<span id="cb247-50"><a href="#cb247-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Content backed up&#39;</span>)<span class="op">;</span></span>
<span id="cb247-51"><a href="#cb247-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb247-52"><a href="#cb247-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Backup failed:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb247-53"><a href="#cb247-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-54"><a href="#cb247-54" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>TypeError</code>: Invalid parameters (non-string content,
invalid position)</li>
<li><code>Error</code>: General operation failures (toolbar actions,
preview rendering)</li>
</ul>
<p><strong>Performance Notes</strong>:</p>
<ul>
<li>Documents over 50KB may cause lag with preview enabled</li>
<li>Autosave debounces input by 1 second</li>
<li>Consider disabling preview for large documents:
<code>if (content.length &gt; 50000) editor.removeAttribute('preview')</code></li>
</ul>
<h3 data-number="19.2.8" id="common-issues-21"><span
class="header-section-number">19.2.8</span> Common Issues</h3>
<p><strong>Toolbar doesn’t work on mobile</strong>: Component optimized
for desktop. Hide toolbar on mobile.</p>
<p><strong>Preview doesn’t update</strong>: Ensure
<code>pan-markdown-renderer</code> is imported.</p>
<p><strong>Large documents lag</strong>: Disable preview or add
debouncing for documents over 50KB.</p>
<p><strong>Keyboard shortcuts conflict</strong>: Component uses
<code>preventDefault()</code> but browser behavior varies.</p>
<hr />
<h2 data-number="19.3" id="pan-markdown-renderer"><span
class="header-section-number">19.3</span> pan-markdown-renderer</h2>
<p><strong>Purpose</strong>: Render markdown as formatted HTML with
syntax highlighting structure<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-markdown-renderer.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="19.3.1" id="quick-example-21"><span
class="header-section-number">19.3.1</span> Quick Example</h3>
<div class="sourceCode" id="cb248"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-markdown-renderer</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;# Hello World</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="st">This is **bold** and *italic*.</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a><span class="st">```javascript</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a><span class="st">console.log(&#39;Code block&#39;);</span></span></code></pre></div>
<p>“&gt;</pan-markdown-renderer></p>
<script type="module">
const renderer = document.querySelector('pan-markdown-renderer');

// Set content
renderer.setContent('# Dynamic Content');

// Get markdown
const markdown = renderer.getContent();

// Get rendered HTML
const html = renderer.getHtml();
</script>
<pre><code>
### Attributes

| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| `content` | String | &quot;&quot; | Markdown content to render |
| `sanitize` | Boolean | true | Escape raw HTML (disable only if trusted) |

### Methods

| Method | Parameters | Returns | Description |
|--------|-----------|---------|-------------|
| `setContent(content)` | content: String | void | Set and render markdown |
| `getContent()` | - | String | Get current markdown |
| `getHtml()` | - | String | Get rendered HTML output |

### Supported Syntax

**Standard markdown:**
- Headings: `# H1` through `###### H6`
- Emphasis: `**bold**`, `*italic*`, `~~strikethrough~~`
- Lists: Bullet (`*`), numbered (`1.`), task (`- [ ]`)
- Links: `[text](url)` and images: `![alt](url)`
- Code: Inline `` `code` `` and fenced ` ```lang ` blocks
- Blockquotes: `&gt; quote`
- Horizontal rules: `---`

**GitHub-flavored:**
- Tables with `|` delimiters
- Task lists: `- [x] Done` and `- [ ] Todo`

### Styling

Customize with CSS variables:

```css
pan-markdown-renderer {
  --color-text: #1e293b;
  --color-text-muted: #64748b;
  --color-bg-alt: #f8fafc;
  --color-border: #e2e8f0;
  --color-code-bg: #1e293b;
  --color-code-text: #e2e8f0;
  --color-primary: #006699;
  --font-mono: &#39;Courier New&#39;, monospace;
}

/* Dark mode */
pan-markdown-renderer.dark {
  --color-text: #e2e8f0;
  --color-bg-alt: #1e293b;
  --color-code-bg: #0f172a;
  --color-primary: #38bdf8;
}</code></pre>
<h3 data-number="19.3.2" id="pan-events-2"><span
class="header-section-number">19.3.2</span> PAN Events</h3>
<h4 data-number="19.3.2.1" id="subscribed-2"><span
class="header-section-number">19.3.2.1</span> Subscribed</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>markdown.render</code></td>
<td><code>{ content }</code></td>
<td>Render new content</td>
</tr>
</tbody>
</table>
<h3 data-number="19.3.3" id="complete-example-13"><span
class="header-section-number">19.3.3</span> Complete Example</h3>
<div class="sourceCode" id="cb250"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-markdown-renderer.mjs&#39;</span><span class="op">;</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> docs <span class="op">=</span> {</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">intro</span><span class="op">:</span> <span class="vs">`# Getting Started</span></span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a><span class="vs">Welcome! This guide covers the basics.</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a><span class="vs">## Prerequisites</span></span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a><span class="vs">- Modern web browser</span></span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a><span class="vs">- Basic HTML/JavaScript knowledge</span></span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a><span class="vs">- 15 minutes</span></span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a><span class="vs">## Installation</span></span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a><span class="sc">\`\`\`</span><span class="vs">javascript</span></span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a><span class="vs">import &#39;./components/app.mjs&#39;;</span></span>
<span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a><span class="sc">\`\`\`</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb250-24"><a href="#cb250-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-25"><a href="#cb250-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">api</span><span class="op">:</span> <span class="vs">`# API Reference</span></span>
<span id="cb250-26"><a href="#cb250-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-27"><a href="#cb250-27" aria-hidden="true" tabindex="-1"></a><span class="vs">## Core Methods</span></span>
<span id="cb250-28"><a href="#cb250-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-29"><a href="#cb250-29" aria-hidden="true" tabindex="-1"></a><span class="vs">### </span><span class="sc">\`</span><span class="vs">initialize(config)</span><span class="sc">\`</span></span>
<span id="cb250-30"><a href="#cb250-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-31"><a href="#cb250-31" aria-hidden="true" tabindex="-1"></a><span class="vs">Initializes the application.</span></span>
<span id="cb250-32"><a href="#cb250-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-33"><a href="#cb250-33" aria-hidden="true" tabindex="-1"></a><span class="vs">**Parameters:**</span></span>
<span id="cb250-34"><a href="#cb250-34" aria-hidden="true" tabindex="-1"></a><span class="vs">- </span><span class="sc">\`</span><span class="vs">config.debug</span><span class="sc">\`</span><span class="vs"> (Boolean): Enable debug mode</span></span>
<span id="cb250-35"><a href="#cb250-35" aria-hidden="true" tabindex="-1"></a><span class="vs">- </span><span class="sc">\`</span><span class="vs">config.theme</span><span class="sc">\`</span><span class="vs"> (String): Theme name</span></span>
<span id="cb250-36"><a href="#cb250-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-37"><a href="#cb250-37" aria-hidden="true" tabindex="-1"></a><span class="sc">\`\`\`</span><span class="vs">javascript</span></span>
<span id="cb250-38"><a href="#cb250-38" aria-hidden="true" tabindex="-1"></a><span class="vs">await initialize({ debug: true, theme: &#39;dark&#39; });</span></span>
<span id="cb250-39"><a href="#cb250-39" aria-hidden="true" tabindex="-1"></a><span class="sc">\`\`\`</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb250-40"><a href="#cb250-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-41"><a href="#cb250-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">examples</span><span class="op">:</span> <span class="vs">`# Examples</span></span>
<span id="cb250-42"><a href="#cb250-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-43"><a href="#cb250-43" aria-hidden="true" tabindex="-1"></a><span class="vs">## Task List</span></span>
<span id="cb250-44"><a href="#cb250-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-45"><a href="#cb250-45" aria-hidden="true" tabindex="-1"></a><span class="vs">- [x] Create component</span></span>
<span id="cb250-46"><a href="#cb250-46" aria-hidden="true" tabindex="-1"></a><span class="vs">- [x] Write docs</span></span>
<span id="cb250-47"><a href="#cb250-47" aria-hidden="true" tabindex="-1"></a><span class="vs">- [ ] Deploy</span></span>
<span id="cb250-48"><a href="#cb250-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-49"><a href="#cb250-49" aria-hidden="true" tabindex="-1"></a><span class="vs">## Data Table</span></span>
<span id="cb250-50"><a href="#cb250-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-51"><a href="#cb250-51" aria-hidden="true" tabindex="-1"></a><span class="vs">| Feature | Status | Version |</span></span>
<span id="cb250-52"><a href="#cb250-52" aria-hidden="true" tabindex="-1"></a><span class="vs">|---------|--------|---------|</span></span>
<span id="cb250-53"><a href="#cb250-53" aria-hidden="true" tabindex="-1"></a><span class="vs">| Import  | ✓      | 1.0     |</span></span>
<span id="cb250-54"><a href="#cb250-54" aria-hidden="true" tabindex="-1"></a><span class="vs">| Export  | ✓      | 1.0     |</span></span>
<span id="cb250-55"><a href="#cb250-55" aria-hidden="true" tabindex="-1"></a><span class="vs">| Sync    | ⏳     | 2.0     |`</span></span>
<span id="cb250-56"><a href="#cb250-56" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb250-57"><a href="#cb250-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-58"><a href="#cb250-58" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb250-59"><a href="#cb250-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> renderer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-renderer&#39;</span>)<span class="op">;</span></span>
<span id="cb250-60"><a href="#cb250-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-61"><a href="#cb250-61" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">showDoc</span> <span class="op">=</span> (section) <span class="kw">=&gt;</span> {</span>
<span id="cb250-62"><a href="#cb250-62" aria-hidden="true" tabindex="-1"></a>        renderer<span class="op">.</span><span class="fu">setContent</span>(docs[section])<span class="op">;</span></span>
<span id="cb250-63"><a href="#cb250-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;nav button&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(btn <span class="kw">=&gt;</span> {</span>
<span id="cb250-64"><a href="#cb250-64" aria-hidden="true" tabindex="-1"></a>          btn<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&#39;active&#39;</span><span class="op">,</span> btn<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">section</span> <span class="op">===</span> section)<span class="op">;</span></span>
<span id="cb250-65"><a href="#cb250-65" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb250-66"><a href="#cb250-66" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb250-67"><a href="#cb250-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-68"><a href="#cb250-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showDoc</span>(<span class="st">&#39;intro&#39;</span>)<span class="op">;</span></span>
<span id="cb250-69"><a href="#cb250-69" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb250-70"><a href="#cb250-70" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb250-71"><a href="#cb250-71" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb250-72"><a href="#cb250-72" aria-hidden="true" tabindex="-1"></a>    body { <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0</span><span class="op">;</span> <span class="kw">display</span><span class="ch">:</span> <span class="dv">grid</span><span class="op">;</span> <span class="kw">grid-template-columns</span><span class="ch">:</span> <span class="dv">200</span><span class="dt">px</span> <span class="dv">1</span><span class="dt">fr</span><span class="op">;</span> <span class="kw">height</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">vh</span><span class="op">;</span> }</span>
<span id="cb250-73"><a href="#cb250-73" aria-hidden="true" tabindex="-1"></a>    nav { <span class="kw">background</span><span class="ch">:</span> <span class="cn">#f8fafc</span><span class="op">;</span> <span class="kw">padding</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">border-right</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#e2e8f0</span><span class="op">;</span> }</span>
<span id="cb250-74"><a href="#cb250-74" aria-hidden="true" tabindex="-1"></a>    nav button { <span class="kw">display</span><span class="ch">:</span> <span class="dv">block</span><span class="op">;</span> <span class="kw">width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span> <span class="kw">padding</span><span class="ch">:</span> <span class="dv">0.5</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0.25</span><span class="dt">rem</span> <span class="dv">0</span><span class="op">;</span> </span>
<span id="cb250-75"><a href="#cb250-75" aria-hidden="true" tabindex="-1"></a>                 <span class="kw">border</span><span class="ch">:</span> <span class="dv">none</span><span class="op">;</span> <span class="kw">background</span><span class="ch">:</span> <span class="dv">transparent</span><span class="op">;</span> <span class="kw">text-align</span><span class="ch">:</span> <span class="dv">left</span><span class="op">;</span> <span class="kw">cursor</span><span class="ch">:</span> <span class="dv">pointer</span><span class="op">;</span> }</span>
<span id="cb250-76"><a href="#cb250-76" aria-hidden="true" tabindex="-1"></a>    nav button<span class="in">:hover</span> { <span class="kw">background</span><span class="ch">:</span> <span class="cn">#e2e8f0</span><span class="op">;</span> }</span>
<span id="cb250-77"><a href="#cb250-77" aria-hidden="true" tabindex="-1"></a>    nav button<span class="fu">.active</span> { <span class="kw">background</span><span class="ch">:</span> <span class="cn">#006699</span><span class="op">;</span> <span class="kw">color</span><span class="ch">:</span> <span class="cn">white</span><span class="op">;</span> }</span>
<span id="cb250-78"><a href="#cb250-78" aria-hidden="true" tabindex="-1"></a>    main { <span class="kw">padding</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">rem</span><span class="op">;</span> <span class="kw">overflow-y</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span> }</span>
<span id="cb250-79"><a href="#cb250-79" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb250-80"><a href="#cb250-80" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb250-81"><a href="#cb250-81" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb250-82"><a href="#cb250-82" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb250-83"><a href="#cb250-83" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">nav</span><span class="dt">&gt;</span></span>
<span id="cb250-84"><a href="#cb250-84" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Documentation<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb250-85"><a href="#cb250-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> data-section</span><span class="op">=</span><span class="st">&quot;intro&quot;</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;showDoc(&#39;intro&#39;)&quot;</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;active&quot;</span><span class="dt">&gt;</span>Getting Started<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb250-86"><a href="#cb250-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> data-section</span><span class="op">=</span><span class="st">&quot;api&quot;</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;showDoc(&#39;api&#39;)&quot;</span><span class="dt">&gt;</span>API Reference<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb250-87"><a href="#cb250-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> data-section</span><span class="op">=</span><span class="st">&quot;examples&quot;</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;showDoc(&#39;examples&#39;)&quot;</span><span class="dt">&gt;</span>Examples<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb250-88"><a href="#cb250-88" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">nav</span><span class="dt">&gt;</span></span>
<span id="cb250-89"><a href="#cb250-89" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">main</span><span class="dt">&gt;</span></span>
<span id="cb250-90"><a href="#cb250-90" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-markdown-renderer</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-markdown-renderer</span><span class="dt">&gt;</span></span>
<span id="cb250-91"><a href="#cb250-91" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">main</span><span class="dt">&gt;</span></span>
<span id="cb250-92"><a href="#cb250-92" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb250-93"><a href="#cb250-93" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="19.3.4" id="errors-8"><span
class="header-section-number">19.3.4</span> Errors</h3>
<p>pan-markdown-renderer dispatches <code>error</code> events when
rendering fails:</p>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 22%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PARSE_ERROR</code></td>
<td>Invalid markdown syntax</td>
<td>Check markdown format or sanitize input</td>
</tr>
<tr>
<td><code>RENDER_ERROR</code></td>
<td>HTML generation failed</td>
<td>Simplify content or report bug</td>
</tr>
<tr>
<td><code>SANITIZATION_ERROR</code></td>
<td>HTML sanitization failed</td>
<td>Check content or disable sanitization</td>
</tr>
<tr>
<td><code>INVALID_CONTENT</code></td>
<td>Non-string content passed</td>
<td>Pass valid string to <code>setContent()</code></td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb251"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> renderer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-markdown-renderer&#39;</span>)<span class="op">;</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for errors</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>renderer<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> message<span class="op">,</span> content } <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Renderer error [</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (code) {</span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;PARSE_ERROR&#39;</span><span class="op">:</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Show raw markdown as fallback</span></span>
<span id="cb251-11"><a href="#cb251-11" aria-hidden="true" tabindex="-1"></a>      renderer<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.content&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> content<span class="op">;</span></span>
<span id="cb251-12"><a href="#cb251-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showWarning</span>(<span class="st">&#39;Markdown parsing failed, showing raw content&#39;</span>)<span class="op">;</span></span>
<span id="cb251-13"><a href="#cb251-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb251-14"><a href="#cb251-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-15"><a href="#cb251-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;RENDER_ERROR&#39;</span><span class="op">:</span></span>
<span id="cb251-16"><a href="#cb251-16" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to render markdown&#39;</span>)<span class="op">;</span></span>
<span id="cb251-17"><a href="#cb251-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showFallbackRenderer</span>()<span class="op">;</span></span>
<span id="cb251-18"><a href="#cb251-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb251-19"><a href="#cb251-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-20"><a href="#cb251-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;SANITIZATION_ERROR&#39;</span><span class="op">:</span></span>
<span id="cb251-21"><a href="#cb251-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Retry with stricter sanitization</span></span>
<span id="cb251-22"><a href="#cb251-22" aria-hidden="true" tabindex="-1"></a>      renderer<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;sanitize&#39;</span><span class="op">,</span> <span class="st">&#39;true&#39;</span>)<span class="op">;</span></span>
<span id="cb251-23"><a href="#cb251-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb251-24"><a href="#cb251-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-25"><a href="#cb251-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;INVALID_CONTENT&#39;</span><span class="op">:</span></span>
<span id="cb251-26"><a href="#cb251-26" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Invalid content type provided&#39;</span>)<span class="op">;</span></span>
<span id="cb251-27"><a href="#cb251-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb251-28"><a href="#cb251-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb251-29"><a href="#cb251-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb251-30"><a href="#cb251-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-31"><a href="#cb251-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe setContent with validation</span></span>
<span id="cb251-32"><a href="#cb251-32" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safeSetContent</span>(content) {</span>
<span id="cb251-33"><a href="#cb251-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">typeof</span> content <span class="op">!==</span> <span class="st">&#39;string&#39;</span>) {</span>
<span id="cb251-34"><a href="#cb251-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Content must be a string&#39;</span>)<span class="op">;</span></span>
<span id="cb251-35"><a href="#cb251-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb251-36"><a href="#cb251-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb251-37"><a href="#cb251-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-38"><a href="#cb251-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb251-39"><a href="#cb251-39" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="fu">setContent</span>(content)<span class="op">;</span></span>
<span id="cb251-40"><a href="#cb251-40" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb251-41"><a href="#cb251-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to render content:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb251-42"><a href="#cb251-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to plain text</span></span>
<span id="cb251-43"><a href="#cb251-43" aria-hidden="true" tabindex="-1"></a>    renderer<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.content&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> content<span class="op">;</span></span>
<span id="cb251-44"><a href="#cb251-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb251-45"><a href="#cb251-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb251-46"><a href="#cb251-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-47"><a href="#cb251-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Validate markdown before rendering</span></span>
<span id="cb251-48"><a href="#cb251-48" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">validateAndRender</span>(markdown) {</span>
<span id="cb251-49"><a href="#cb251-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check for balanced code fences</span></span>
<span id="cb251-50"><a href="#cb251-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> fenceCount <span class="op">=</span> (markdown<span class="op">.</span><span class="fu">match</span>(<span class="ss">/```/g</span>) <span class="op">||</span> [])<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb251-51"><a href="#cb251-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fenceCount <span class="op">%</span> <span class="dv">2</span> <span class="op">!==</span> <span class="dv">0</span>) {</span>
<span id="cb251-52"><a href="#cb251-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Unbalanced code fences detected&#39;</span>)<span class="op">;</span></span>
<span id="cb251-53"><a href="#cb251-53" aria-hidden="true" tabindex="-1"></a>    markdown <span class="op">+=</span> <span class="st">&#39;</span><span class="sc">\n</span><span class="st">```&#39;</span><span class="op">;</span> <span class="co">// Auto-close</span></span>
<span id="cb251-54"><a href="#cb251-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb251-55"><a href="#cb251-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-56"><a href="#cb251-56" aria-hidden="true" tabindex="-1"></a>  renderer<span class="op">.</span><span class="fu">setContent</span>(markdown)<span class="op">;</span></span>
<span id="cb251-57"><a href="#cb251-57" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Exceptions thrown</strong>:</p>
<ul>
<li><code>TypeError</code>: Invalid parameters (non-string content)</li>
<li><code>Error</code>: Parse or render failures</li>
</ul>
<p><strong>Performance Notes</strong>:</p>
<ul>
<li>Large documents (&gt;100KB) may slow rendering</li>
<li>Complex tables with many rows cause layout reflow</li>
<li>Consider debouncing content updates for live preview</li>
</ul>
<h3 data-number="19.3.5" id="common-issues-22"><span
class="header-section-number">19.3.5</span> Common Issues</h3>
<p><strong>No syntax highlighting</strong>: Renderer provides structure
only. Add Prism.js or similar for color syntax highlighting.</p>
<p><strong>Tables render incorrectly</strong>: Ensure separator row with
dashes: <code>|---|---|</code></p>
<p><strong>Raw HTML appears</strong>: Sanitization enabled by default.
Only set <code>sanitize="false"</code> for trusted content.</p>
<p><strong>Content doesn’t wrap on mobile</strong>: Add responsive
CSS:</p>
<div class="sourceCode" id="cb252"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>pan-markdown-renderer { <span class="kw">overflow-x</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span> }</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>pan-markdown-renderer pre { <span class="kw">max-width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span> <span class="kw">overflow-x</span><span class="ch">:</span> <span class="bu">auto</span><span class="op">;</span> }</span></code></pre></div>
<hr />
<h2 data-number="19.4" id="summary-2"><span
class="header-section-number">19.4</span> Summary</h2>
<p>This chapter documented LARC’s UI components:</p>
<ul>
<li><strong>pan-files</strong>: OPFS file system browser with visual UI
and programmatic API</li>
<li><strong>pan-markdown-editor</strong>: Rich markdown editor with
toolbar, preview, and auto-save</li>
<li><strong>pan-markdown-renderer</strong>: Markdown-to-HTML renderer
with GitHub-flavored syntax</li>
</ul>
<p>Use together for complete markdown applications or individually as
needed.</p>
<p><strong>See Also</strong>:</p>
<ul>
<li>Tutorial: <em>Learning LARC</em> Chapter 10</li>
<li>Core components: Chapter 17</li>
<li>Data components: Chapter 18</li>
<li>Integration patterns: Chapter 20</li>
</ul>
<h1 data-number="20" id="integration-components-reference"><span
class="header-section-number">20</span> Integration Components
Reference</h1>
<p>API documentation for LARC’s integration components. For tutorials,
see <em>Learning LARC</em> Chapter 11.</p>
<h2 data-number="20.1" id="pan-data-connector"><span
class="header-section-number">20.1</span> pan-data-connector</h2>
<p><strong>Purpose</strong>: Declarative REST API bridge with CRUD
pattern<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-data-connector.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="20.1.1" id="quick-example-22"><span
class="header-section-number">20.1.1</span> Quick Example</h3>
<div class="sourceCode" id="cb253"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-data-connector</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  base-url</span><span class="op">=</span><span class="st">&quot;https://api.example.com&quot;</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  key</span><span class="op">=</span><span class="st">&quot;id&quot;</span><span class="dt">&gt;</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-data-connector</span><span class="dt">&gt;</span></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch list</span></span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> { <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span> })<span class="op">;</span></span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for results</span></span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Users:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb253-18"><a href="#cb253-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb253-19"><a href="#cb253-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-20"><a href="#cb253-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Get single item</span></span>
<span id="cb253-21"><a href="#cb253-21" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span>
<span id="cb253-22"><a href="#cb253-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-23"><a href="#cb253-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Save item</span></span>
<span id="cb253-24"><a href="#cb253-24" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.save&#39;</span><span class="op">,</span> {</span>
<span id="cb253-25"><a href="#cb253-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb253-26"><a href="#cb253-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span></span>
<span id="cb253-27"><a href="#cb253-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span></span>
<span id="cb253-28"><a href="#cb253-28" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb253-29"><a href="#cb253-29" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.1.2" id="attributes-6"><span
class="header-section-number">20.1.2</span> Attributes</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>resource</code></td>
<td>String</td>
<td>“items”</td>
<td>Resource name (topic prefix)</td>
</tr>
<tr>
<td><code>base-url</code></td>
<td>String</td>
<td>“”</td>
<td>API base URL</td>
</tr>
<tr>
<td><code>key</code></td>
<td>String</td>
<td>“id”</td>
<td>Unique identifier field</td>
</tr>
<tr>
<td><code>list-path</code></td>
<td>String</td>
<td>“/${resource}”</td>
<td>List endpoint template</td>
</tr>
<tr>
<td><code>item-path</code></td>
<td>String</td>
<td>“/${resource}/:id”</td>
<td>Item endpoint template</td>
</tr>
<tr>
<td><code>update-method</code></td>
<td>String</td>
<td>“PUT”</td>
<td>HTTP method for updates (PUT/PATCH)</td>
</tr>
<tr>
<td><code>credentials</code></td>
<td>String</td>
<td>“”</td>
<td>Fetch credentials mode</td>
</tr>
</tbody>
</table>
<p><strong>Headers configuration</strong> (via
<code>&lt;script type="application/json"&gt;</code>):</p>
<div class="sourceCode" id="cb254"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-data-connector</span><span class="ot"> resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="ot"> base-url</span><span class="op">=</span><span class="st">&quot;/api&quot;</span><span class="dt">&gt;</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;headers&quot;</span><span class="op">:</span> {</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Authorization&quot;</span><span class="op">:</span> <span class="st">&quot;Bearer TOKEN&quot;</span><span class="op">,</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;X-API-Version&quot;</span><span class="op">:</span> <span class="st">&quot;2023-01&quot;</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-data-connector</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.1.3" id="pan-topics-1"><span
class="header-section-number">20.1.3</span> PAN Topics</h3>
<h4 data-number="20.1.3.1" id="subscribed-requests"><span
class="header-section-number">20.1.3.1</span> Subscribed (Requests)</h4>
<table>
<colgroup>
<col style="width: 17%" />
<col style="width: 15%" />
<col style="width: 35%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>HTTP Request</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\${resource}.list.get</code></td>
<td><code>{ ...query }</code></td>
<td>GET /${resource}</td>
<td>Fetch list</td>
</tr>
<tr>
<td><code>\${resource}.item.get</code></td>
<td><code>{ id }</code></td>
<td>GET /${resource}/:id</td>
<td>Fetch single item</td>
</tr>
<tr>
<td><code>\${resource}.item.save</code></td>
<td><code>{ id?, ...data }</code></td>
<td>POST or PUT</td>
<td>Create/update item</td>
</tr>
<tr>
<td><code>\${resource}.item.delete</code></td>
<td><code>{ id }</code></td>
<td>DELETE /${resource}/:id</td>
<td>Delete item</td>
</tr>
</tbody>
</table>
<h4 data-number="20.1.3.2" id="published-responses"><span
class="header-section-number">20.1.3.2</span> Published (Responses)</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\${resource}.list.state</code></td>
<td><code>{ items: [...], meta? }</code></td>
<td>List results (retained)</td>
</tr>
<tr>
<td><code>\${resource}.item.state.\${id}</code></td>
<td><code>{ ...item }</code></td>
<td>Single item (retained)</td>
</tr>
<tr>
<td><code>\${resource}.error</code></td>
<td><code>{ operation, error, status }</code></td>
<td>Error occurred</td>
</tr>
</tbody>
</table>
<h3 data-number="20.1.4" id="complete-example-14"><span
class="header-section-number">20.1.4</span> Complete Example</h3>
<div class="sourceCode" id="cb255"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-data-connector.mjs&#39;</span><span class="op">;</span></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render user list</span></span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> list <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;user-list&#39;</span>)<span class="op">;</span></span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>        list<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">map</span>(user <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;li&gt;</span></span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>user<span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">)</span></span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;button onclick=&quot;editUser(</span><span class="sc">${</span>user<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;Edit&lt;/button&gt;</span></span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;button onclick=&quot;deleteUser(</span><span class="sc">${</span>user<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;Delete&lt;/button&gt;</span></span>
<span id="cb255-20"><a href="#cb255-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/li&gt;</span></span>
<span id="cb255-21"><a href="#cb255-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb255-22"><a href="#cb255-22" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb255-23"><a href="#cb255-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-24"><a href="#cb255-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Handle errors</span></span>
<span id="cb255-25"><a href="#cb255-25" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb255-26"><a href="#cb255-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;API Error:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb255-27"><a href="#cb255-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(<span class="vs">`Error: </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb255-28"><a href="#cb255-28" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb255-29"><a href="#cb255-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-30"><a href="#cb255-30" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load users on startup</span></span>
<span id="cb255-31"><a href="#cb255-31" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb255-32"><a href="#cb255-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-33"><a href="#cb255-33" aria-hidden="true" tabindex="-1"></a>      <span class="co">// CRUD operations</span></span>
<span id="cb255-34"><a href="#cb255-34" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">editUser</span> <span class="op">=</span> (id) <span class="kw">=&gt;</span> {</span>
<span id="cb255-35"><a href="#cb255-35" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { id })<span class="op">;</span></span>
<span id="cb255-36"><a href="#cb255-36" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.state.&#39;</span> <span class="op">+</span> id<span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb255-37"><a href="#cb255-37" aria-hidden="true" tabindex="-1"></a>          <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;name&#39;</span>)<span class="op">.</span><span class="at">value</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">name</span><span class="op">;</span></span>
<span id="cb255-38"><a href="#cb255-38" aria-hidden="true" tabindex="-1"></a>          <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;email&#39;</span>)<span class="op">.</span><span class="at">value</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">email</span><span class="op">;</span></span>
<span id="cb255-39"><a href="#cb255-39" aria-hidden="true" tabindex="-1"></a>          <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">.</span><span class="at">value</span> <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb255-40"><a href="#cb255-40" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb255-41"><a href="#cb255-41" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb255-42"><a href="#cb255-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-43"><a href="#cb255-43" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">saveUser</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb255-44"><a href="#cb255-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> id <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb255-45"><a href="#cb255-45" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.save&#39;</span><span class="op">,</span> {</span>
<span id="cb255-46"><a href="#cb255-46" aria-hidden="true" tabindex="-1"></a>          <span class="dt">id</span><span class="op">:</span> id <span class="op">||</span> <span class="kw">undefined</span><span class="op">,</span></span>
<span id="cb255-47"><a href="#cb255-47" aria-hidden="true" tabindex="-1"></a>          <span class="dt">name</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;name&#39;</span>)<span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb255-48"><a href="#cb255-48" aria-hidden="true" tabindex="-1"></a>          <span class="dt">email</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;email&#39;</span>)<span class="op">.</span><span class="at">value</span></span>
<span id="cb255-49"><a href="#cb255-49" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb255-50"><a href="#cb255-50" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb255-51"><a href="#cb255-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-52"><a href="#cb255-52" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">deleteUser</span> <span class="op">=</span> (id) <span class="kw">=&gt;</span> {</span>
<span id="cb255-53"><a href="#cb255-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">confirm</span>(<span class="st">&#39;Delete user?&#39;</span>)) {</span>
<span id="cb255-54"><a href="#cb255-54" aria-hidden="true" tabindex="-1"></a>          pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.delete&#39;</span><span class="op">,</span> { id })<span class="op">;</span></span>
<span id="cb255-55"><a href="#cb255-55" aria-hidden="true" tabindex="-1"></a>          <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> {})<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb255-56"><a href="#cb255-56" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb255-57"><a href="#cb255-57" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb255-58"><a href="#cb255-58" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb255-59"><a href="#cb255-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb255-60"><a href="#cb255-60" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb255-61"><a href="#cb255-61" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb255-62"><a href="#cb255-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb255-63"><a href="#cb255-63" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-data-connector</span><span class="ot"> resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="ot"> base-url</span><span class="op">=</span><span class="st">&quot;/api&quot;</span><span class="ot"> key</span><span class="op">=</span><span class="st">&quot;id&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-data-connector</span><span class="dt">&gt;</span></span>
<span id="cb255-64"><a href="#cb255-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-65"><a href="#cb255-65" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb255-66"><a href="#cb255-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Users<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb255-67"><a href="#cb255-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">ul</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;user-list&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">ul</span><span class="dt">&gt;</span></span>
<span id="cb255-68"><a href="#cb255-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-69"><a href="#cb255-69" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h3</span><span class="dt">&gt;</span>Edit User<span class="dt">&lt;/</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb255-70"><a href="#cb255-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;user-id&quot;</span><span class="dt">&gt;</span></span>
<span id="cb255-71"><a href="#cb255-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;name&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Name&quot;</span><span class="dt">&gt;</span></span>
<span id="cb255-72"><a href="#cb255-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Email&quot;</span><span class="dt">&gt;</span></span>
<span id="cb255-73"><a href="#cb255-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;saveUser()&quot;</span><span class="dt">&gt;</span>Save<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb255-74"><a href="#cb255-74" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb255-75"><a href="#cb255-75" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb255-76"><a href="#cb255-76" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.1.5" id="errors-9"><span
class="header-section-number">20.1.5</span> Errors</h3>
<p>pan-data-connector publishes errors to <code>${resource}.error</code>
topic:</p>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NETWORK_ERROR</code></td>
<td>Fetch failed (offline, DNS, timeout)</td>
<td>Check network connection and API availability</td>
</tr>
<tr>
<td><code>HTTP_4XX</code></td>
<td>Client error (400-499)</td>
<td>Verify request data and authentication</td>
</tr>
<tr>
<td><code>HTTP_5XX</code></td>
<td>Server error (500-599)</td>
<td>Check API server logs, retry with backoff</td>
</tr>
<tr>
<td><code>PARSE_ERROR</code></td>
<td>Response not valid JSON</td>
<td>Check API response format</td>
</tr>
<tr>
<td><code>CORS_ERROR</code></td>
<td>Cross-origin request blocked</td>
<td>Configure CORS headers on server</td>
</tr>
<tr>
<td><code>INVALID_CONFIG</code></td>
<td>Missing required attributes</td>
<td>Set <code>resource</code> and <code>base-url</code> attributes</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb256"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to errors</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { operation<span class="op">,</span> error<span class="op">,</span> status<span class="op">,</span> response } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`API Error [</span><span class="sc">${</span>operation<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (<span class="kw">true</span>) {</span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">===</span> <span class="dv">401</span><span class="op">:</span></span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Unauthorized - redirect to login</span></span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/login&#39;</span><span class="op">;</span></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">===</span> <span class="dv">404</span><span class="op">:</span></span>
<span id="cb256-17"><a href="#cb256-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Not found</span></span>
<span id="cb256-18"><a href="#cb256-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="st">&#39;Resource not found&#39;</span>)<span class="op">;</span></span>
<span id="cb256-19"><a href="#cb256-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-20"><a href="#cb256-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-21"><a href="#cb256-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">&gt;=</span> <span class="dv">500</span><span class="op">:</span></span>
<span id="cb256-22"><a href="#cb256-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Server error - retry with exponential backoff</span></span>
<span id="cb256-23"><a href="#cb256-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">retryWithBackoff</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb256-24"><a href="#cb256-24" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb256-25"><a href="#cb256-25" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb256-26"><a href="#cb256-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-27"><a href="#cb256-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-28"><a href="#cb256-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;CORS&#39;</span>)<span class="op">:</span></span>
<span id="cb256-29"><a href="#cb256-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">// CORS error</span></span>
<span id="cb256-30"><a href="#cb256-30" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;CORS configuration required on server&#39;</span>)<span class="op">;</span></span>
<span id="cb256-31"><a href="#cb256-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showCORSHelp</span>()<span class="op">;</span></span>
<span id="cb256-32"><a href="#cb256-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-33"><a href="#cb256-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-34"><a href="#cb256-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;NETWORK&#39;</span>)<span class="op">:</span></span>
<span id="cb256-35"><a href="#cb256-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Network error</span></span>
<span id="cb256-36"><a href="#cb256-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showOfflineMode</span>()<span class="op">;</span></span>
<span id="cb256-37"><a href="#cb256-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb256-38"><a href="#cb256-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-39"><a href="#cb256-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb256-40"><a href="#cb256-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="vs">`Error: </span><span class="sc">${</span>error<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb256-41"><a href="#cb256-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-42"><a href="#cb256-42" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb256-43"><a href="#cb256-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-44"><a href="#cb256-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Retry with exponential backoff</span></span>
<span id="cb256-45"><a href="#cb256-45" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> retryCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb256-46"><a href="#cb256-46" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">retryWithBackoff</span>(fn<span class="op">,</span> maxRetries <span class="op">=</span> <span class="dv">3</span>) {</span>
<span id="cb256-47"><a href="#cb256-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (retryCount <span class="op">&gt;=</span> maxRetries) {</span>
<span id="cb256-48"><a href="#cb256-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Max retries exceeded&#39;</span>)<span class="op">;</span></span>
<span id="cb256-49"><a href="#cb256-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb256-50"><a href="#cb256-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-51"><a href="#cb256-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> retryCount) <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb256-52"><a href="#cb256-52" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb256-53"><a href="#cb256-53" aria-hidden="true" tabindex="-1"></a>    retryCount<span class="op">++;</span></span>
<span id="cb256-54"><a href="#cb256-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fn</span>()<span class="op">;</span></span>
<span id="cb256-55"><a href="#cb256-55" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb256-56"><a href="#cb256-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb256-57"><a href="#cb256-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-58"><a href="#cb256-58" aria-hidden="true" tabindex="-1"></a><span class="co">// Optimistic updates with rollback on error</span></span>
<span id="cb256-59"><a href="#cb256-59" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> previousState <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb256-60"><a href="#cb256-60" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb256-61"><a href="#cb256-61" aria-hidden="true" tabindex="-1"></a>  previousState <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb256-62"><a href="#cb256-62" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb256-63"><a href="#cb256-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-64"><a href="#cb256-64" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">saveUserOptimistically</span>(user) {</span>
<span id="cb256-65"><a href="#cb256-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update UI immediately</span></span>
<span id="cb256-66"><a href="#cb256-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateUI</span>(user)<span class="op">;</span></span>
<span id="cb256-67"><a href="#cb256-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb256-68"><a href="#cb256-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Save to API</span></span>
<span id="cb256-69"><a href="#cb256-69" aria-hidden="true" tabindex="-1"></a>  pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.item.save&#39;</span><span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb256-70"><a href="#cb256-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb256-71"><a href="#cb256-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Rollback on error</span></span>
<span id="cb256-72"><a href="#cb256-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> unsubscribe <span class="op">=</span> pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb256-73"><a href="#cb256-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;save&#39;</span>) {</span>
<span id="cb256-74"><a href="#cb256-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateUI</span>(previousState)<span class="op">;</span></span>
<span id="cb256-75"><a href="#cb256-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb256-76"><a href="#cb256-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-77"><a href="#cb256-77" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb256-78"><a href="#cb256-78" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>HTTP Status Codes</strong>: All HTTP status codes are passed
through in the error message:</p>
<ul>
<li>400: Bad Request</li>
<li>401: Unauthorized</li>
<li>403: Forbidden</li>
<li>404: Not Found</li>
<li>422: Unprocessable Entity</li>
<li>500: Internal Server Error</li>
<li>502: Bad Gateway</li>
<li>503: Service Unavailable</li>
</ul>
<h3 data-number="20.1.6" id="common-issues-23"><span
class="header-section-number">20.1.6</span> Common Issues</h3>
<p><strong>401/403 errors</strong>: Configure authentication headers via
embedded JSON script.</p>
<p><strong>CORS errors</strong>: Ensure API server sets appropriate CORS
headers. Use <code>credentials="include"</code> for cookies.</p>
<p><strong>List doesn’t update after save</strong>: Connector doesn’t
auto-refresh lists. Manually request:
<code>pc.publish('${resource}.list.get', {})</code>.</p>
<p><strong>Non-standard API</strong>: Override <code>list-path</code>
and <code>item-path</code> attributes for custom endpoints.</p>
<hr />
<h2 data-number="20.2" id="pan-graphql-connector"><span
class="header-section-number">20.2</span> pan-graphql-connector</h2>
<p><strong>Purpose</strong>: GraphQL query and mutation bridge to PAN
bus<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-graphql-connector.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="20.2.1" id="quick-example-23"><span
class="header-section-number">20.2.1</span> Quick Example</h3>
<div class="sourceCode" id="cb257"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-graphql-connector</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  endpoint</span><span class="op">=</span><span class="st">&quot;https://api.example.com/graphql&quot;</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="dt">&gt;</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/graphql&quot;</span><span class="ot"> data-operation</span><span class="op">=</span><span class="st">&quot;list&quot;</span><span class="dt">&gt;</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>    query <span class="fu">GetUsers</span>($limit<span class="op">:</span> Int) {</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">users</span>(<span class="dt">limit</span><span class="op">:</span> $limit) {</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>        id</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>        name</span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>        email</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/graphql&quot;</span><span class="ot"> data-operation</span><span class="op">=</span><span class="st">&quot;get&quot;</span><span class="dt">&gt;</span></span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>    query <span class="fu">GetUser</span>($id<span class="op">:</span> ID<span class="op">!</span>) {</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">user</span>(<span class="dt">id</span><span class="op">:</span> $id) {</span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>        id</span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a>        name</span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>        email</span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a>        createdAt</span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb257-22"><a href="#cb257-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb257-23"><a href="#cb257-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb257-24"><a href="#cb257-24" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-graphql-connector</span><span class="dt">&gt;</span></span>
<span id="cb257-25"><a href="#cb257-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-26"><a href="#cb257-26" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb257-27"><a href="#cb257-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb257-28"><a href="#cb257-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-29"><a href="#cb257-29" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb257-30"><a href="#cb257-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-31"><a href="#cb257-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Execute query</span></span>
<span id="cb257-32"><a href="#cb257-32" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> { <span class="dt">limit</span><span class="op">:</span> <span class="dv">10</span> })<span class="op">;</span></span>
<span id="cb257-33"><a href="#cb257-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-34"><a href="#cb257-34" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb257-35"><a href="#cb257-35" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Users:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb257-36"><a href="#cb257-36" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb257-37"><a href="#cb257-37" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.2.2" id="attributes-7"><span
class="header-section-number">20.2.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>endpoint</code></td>
<td>String</td>
<td>“/graphql”</td>
<td>GraphQL endpoint URL</td>
</tr>
<tr>
<td><code>resource</code></td>
<td>String</td>
<td>“items”</td>
<td>Resource name (topic prefix)</td>
</tr>
<tr>
<td><code>key</code></td>
<td>String</td>
<td>“id”</td>
<td>Unique identifier field</td>
</tr>
</tbody>
</table>
<p><strong>GraphQL operations</strong> (via
<code>&lt;script type="application/graphql"&gt;</code>):</p>
<ul>
<li><code>data-operation="list"</code>: List query</li>
<li><code>data-operation="get"</code>: Single item query</li>
<li><code>data-operation="create"</code>: Create mutation</li>
<li><code>data-operation="update"</code>: Update mutation</li>
<li><code>data-operation="delete"</code>: Delete mutation</li>
</ul>
<p><strong>Headers configuration</strong> (via
<code>&lt;script type="application/json"&gt;</code>):</p>
<div class="sourceCode" id="cb258"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-graphql-connector</span><span class="ot"> endpoint</span><span class="op">=</span><span class="st">&quot;/graphql&quot;</span><span class="ot"> resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="dt">&gt;</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;headers&quot;</span><span class="op">:</span> {</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Authorization&quot;</span><span class="op">:</span> <span class="st">&quot;Bearer TOKEN&quot;</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- GraphQL scripts... --&gt;</span></span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-graphql-connector</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.2.3" id="pan-topics-2"><span
class="header-section-number">20.2.3</span> PAN Topics</h3>
<p>Same as <code>pan-data-connector</code>:</p>
<ul>
<li>Subscribe: <code>${resource}.list.get</code>,
<code>${resource}.item.get</code>, <code>${resource}.item.save</code>,
<code>${resource}.item.delete</code></li>
<li>Publish: <code>${resource}.list.state</code>,
<code>${resource}.item.state.${id}</code>,
<code>${resource}.error</code></li>
</ul>
<h3 data-number="20.2.4" id="complete-example-15"><span
class="header-section-number">20.2.4</span> Complete Example</h3>
<div class="sourceCode" id="cb259"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-graphql-connector.mjs&#39;</span><span class="op">;</span></span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Fetch users</span></span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> { <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span> })<span class="op">;</span></span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Display results</span></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;output&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> </span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a>          <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb259-19"><a href="#cb259-19" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb259-20"><a href="#cb259-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-21"><a href="#cb259-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Handle errors</span></span>
<span id="cb259-22"><a href="#cb259-22" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb259-23"><a href="#cb259-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;GraphQL Error:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb259-24"><a href="#cb259-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb259-25"><a href="#cb259-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb259-26"><a href="#cb259-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb259-27"><a href="#cb259-27" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb259-28"><a href="#cb259-28" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb259-29"><a href="#cb259-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb259-30"><a href="#cb259-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb259-31"><a href="#cb259-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-graphql-connector</span><span class="ot"> endpoint</span><span class="op">=</span><span class="st">&quot;https://api.example.com/graphql&quot;</span><span class="ot"> resource</span><span class="op">=</span><span class="st">&quot;users&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-32"><a href="#cb259-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-33"><a href="#cb259-33" aria-hidden="true" tabindex="-1"></a>      { <span class="st">&quot;headers&quot;</span><span class="op">:</span> { <span class="st">&quot;Authorization&quot;</span><span class="op">:</span> <span class="st">&quot;Bearer TOKEN&quot;</span> } }</span>
<span id="cb259-34"><a href="#cb259-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb259-35"><a href="#cb259-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-36"><a href="#cb259-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/graphql&quot;</span><span class="ot"> data-operation</span><span class="op">=</span><span class="st">&quot;list&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-37"><a href="#cb259-37" aria-hidden="true" tabindex="-1"></a>      query <span class="fu">GetUsers</span>($limit<span class="op">:</span> Int) {</span>
<span id="cb259-38"><a href="#cb259-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">users</span>(<span class="dt">limit</span><span class="op">:</span> $limit) {</span>
<span id="cb259-39"><a href="#cb259-39" aria-hidden="true" tabindex="-1"></a>          id</span>
<span id="cb259-40"><a href="#cb259-40" aria-hidden="true" tabindex="-1"></a>          name</span>
<span id="cb259-41"><a href="#cb259-41" aria-hidden="true" tabindex="-1"></a>          email</span>
<span id="cb259-42"><a href="#cb259-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb259-43"><a href="#cb259-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb259-44"><a href="#cb259-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb259-45"><a href="#cb259-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-46"><a href="#cb259-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/graphql&quot;</span><span class="ot"> data-operation</span><span class="op">=</span><span class="st">&quot;get&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-47"><a href="#cb259-47" aria-hidden="true" tabindex="-1"></a>      query <span class="fu">GetUser</span>($id<span class="op">:</span> ID<span class="op">!</span>) {</span>
<span id="cb259-48"><a href="#cb259-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">user</span>(<span class="dt">id</span><span class="op">:</span> $id) {</span>
<span id="cb259-49"><a href="#cb259-49" aria-hidden="true" tabindex="-1"></a>          id</span>
<span id="cb259-50"><a href="#cb259-50" aria-hidden="true" tabindex="-1"></a>          name</span>
<span id="cb259-51"><a href="#cb259-51" aria-hidden="true" tabindex="-1"></a>          email</span>
<span id="cb259-52"><a href="#cb259-52" aria-hidden="true" tabindex="-1"></a>          createdAt</span>
<span id="cb259-53"><a href="#cb259-53" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb259-54"><a href="#cb259-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb259-55"><a href="#cb259-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb259-56"><a href="#cb259-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-57"><a href="#cb259-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/graphql&quot;</span><span class="ot"> data-operation</span><span class="op">=</span><span class="st">&quot;create&quot;</span><span class="dt">&gt;</span></span>
<span id="cb259-58"><a href="#cb259-58" aria-hidden="true" tabindex="-1"></a>      mutation <span class="fu">CreateUser</span>($input<span class="op">:</span> UserInput<span class="op">!</span>) {</span>
<span id="cb259-59"><a href="#cb259-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">createUser</span>(<span class="dt">input</span><span class="op">:</span> $input) {</span>
<span id="cb259-60"><a href="#cb259-60" aria-hidden="true" tabindex="-1"></a>          id</span>
<span id="cb259-61"><a href="#cb259-61" aria-hidden="true" tabindex="-1"></a>          name</span>
<span id="cb259-62"><a href="#cb259-62" aria-hidden="true" tabindex="-1"></a>          email</span>
<span id="cb259-63"><a href="#cb259-63" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb259-64"><a href="#cb259-64" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb259-65"><a href="#cb259-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb259-66"><a href="#cb259-66" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-graphql-connector</span><span class="dt">&gt;</span></span>
<span id="cb259-67"><a href="#cb259-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-68"><a href="#cb259-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;pc.publish(&#39;users.list.get&#39;, { limit: 10 })&quot;</span><span class="dt">&gt;</span>Load Users<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb259-69"><a href="#cb259-69" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pre</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;output&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pre</span><span class="dt">&gt;</span></span>
<span id="cb259-70"><a href="#cb259-70" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb259-71"><a href="#cb259-71" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.2.5" id="errors-10"><span
class="header-section-number">20.2.5</span> Errors</h3>
<p>pan-graphql-connector publishes errors to
<code>${resource}.error</code> topic:</p>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GRAPHQL_ERROR</code></td>
<td>GraphQL errors in response</td>
<td>Check query syntax and schema</td>
</tr>
<tr>
<td><code>NETWORK_ERROR</code></td>
<td>Fetch failed</td>
<td>Check network and endpoint URL</td>
</tr>
<tr>
<td><code>PARSE_ERROR</code></td>
<td>Response not valid JSON</td>
<td>Check GraphQL endpoint response format</td>
</tr>
<tr>
<td><code>MISSING_OPERATION</code></td>
<td>No query/mutation defined for operation</td>
<td>Add
<code>&lt;script type="application/graphql" data-operation="..."&gt;</code></td>
</tr>
<tr>
<td><code>VALIDATION_ERROR</code></td>
<td>GraphQL validation failed</td>
<td>Fix query variables or schema mismatch</td>
</tr>
<tr>
<td><code>AUTH_ERROR</code></td>
<td>Authentication failed</td>
<td>Check Authorization header</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb260"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to GraphQL errors</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { operation<span class="op">,</span> error<span class="op">,</span> graphqlErrors<span class="op">,</span> status } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`GraphQL Error [</span><span class="sc">${</span>operation<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle GraphQL-specific errors</span></span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (graphqlErrors <span class="op">&amp;&amp;</span> graphqlErrors<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>    graphqlErrors<span class="op">.</span><span class="fu">forEach</span>(err <span class="kw">=&gt;</span> {</span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`  - </span><span class="sc">${</span>err<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Handle specific error types</span></span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err<span class="op">.</span><span class="at">extensions</span><span class="op">?.</span><span class="at">code</span> <span class="op">===</span> <span class="st">&#39;UNAUTHENTICATED&#39;</span>) {</span>
<span id="cb260-17"><a href="#cb260-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">redirectToLogin</span>()<span class="op">;</span></span>
<span id="cb260-18"><a href="#cb260-18" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (err<span class="op">.</span><span class="at">extensions</span><span class="op">?.</span><span class="at">code</span> <span class="op">===</span> <span class="st">&#39;FORBIDDEN&#39;</span>) {</span>
<span id="cb260-19"><a href="#cb260-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">showNotification</span>(<span class="st">&#39;Access denied&#39;</span>)<span class="op">;</span></span>
<span id="cb260-20"><a href="#cb260-20" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (err<span class="op">.</span><span class="at">path</span>) {</span>
<span id="cb260-21"><a href="#cb260-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">showFieldError</span>(err<span class="op">.</span><span class="at">path</span><span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;.&#39;</span>)<span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb260-22"><a href="#cb260-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb260-23"><a href="#cb260-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb260-24"><a href="#cb260-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-25"><a href="#cb260-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-26"><a href="#cb260-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle network errors</span></span>
<span id="cb260-27"><a href="#cb260-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;NETWORK&#39;</span>)) {</span>
<span id="cb260-28"><a href="#cb260-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">showOfflineMode</span>()<span class="op">;</span></span>
<span id="cb260-29"><a href="#cb260-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-30"><a href="#cb260-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-31"><a href="#cb260-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle missing operations</span></span>
<span id="cb260-32"><a href="#cb260-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;MISSING_OPERATION&#39;</span>)) {</span>
<span id="cb260-33"><a href="#cb260-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Add &lt;script type=&quot;application/graphql&quot; data-operation=&quot;</span><span class="sc">${</span>operation<span class="sc">}</span><span class="vs">&quot;&gt; to component`</span>)<span class="op">;</span></span>
<span id="cb260-34"><a href="#cb260-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-35"><a href="#cb260-35" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb260-36"><a href="#cb260-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-37"><a href="#cb260-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Retry with different variables on error</span></span>
<span id="cb260-38"><a href="#cb260-38" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">retryQueryWithFallback</span>() {</span>
<span id="cb260-39"><a href="#cb260-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> unsubscribe <span class="op">=</span> pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb260-40"><a href="#cb260-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">operation</span> <span class="op">===</span> <span class="st">&#39;list&#39;</span>) {</span>
<span id="cb260-41"><a href="#cb260-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Try with reduced limit</span></span>
<span id="cb260-42"><a href="#cb260-42" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> { <span class="dt">limit</span><span class="op">:</span> <span class="dv">10</span> })<span class="op">;</span></span>
<span id="cb260-43"><a href="#cb260-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb260-44"><a href="#cb260-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb260-45"><a href="#cb260-45" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb260-46"><a href="#cb260-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb260-47"><a href="#cb260-47" aria-hidden="true" tabindex="-1"></a>  pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> { <span class="dt">limit</span><span class="op">:</span> <span class="dv">100</span> })<span class="op">;</span></span>
<span id="cb260-48"><a href="#cb260-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb260-49"><a href="#cb260-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-50"><a href="#cb260-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle partial data from GraphQL</span></span>
<span id="cb260-51"><a href="#cb260-51" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb260-52"><a href="#cb260-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { items<span class="op">,</span> errors } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb260-53"><a href="#cb260-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb260-54"><a href="#cb260-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (errors) {</span>
<span id="cb260-55"><a href="#cb260-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// GraphQL can return partial data with errors</span></span>
<span id="cb260-56"><a href="#cb260-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Partial data received with errors:&#39;</span><span class="op">,</span> errors)<span class="op">;</span></span>
<span id="cb260-57"><a href="#cb260-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">showWarning</span>(<span class="st">&#39;Some data may be incomplete&#39;</span>)<span class="op">;</span></span>
<span id="cb260-58"><a href="#cb260-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-59"><a href="#cb260-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb260-60"><a href="#cb260-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">displayUsers</span>(items <span class="op">||</span> [])<span class="op">;</span></span>
<span id="cb260-61"><a href="#cb260-61" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>GraphQL Error Extensions</strong>: GraphQL servers often
include error codes in <code>extensions</code>:</p>
<ul>
<li><code>UNAUTHENTICATED</code>: Not logged in</li>
<li><code>FORBIDDEN</code>: Insufficient permissions</li>
<li><code>BAD_USER_INPUT</code>: Invalid variables</li>
<li><code>GRAPHQL_VALIDATION_FAILED</code>: Query validation error</li>
<li><code>PERSISTED_QUERY_NOT_FOUND</code>: Persisted query ID not
found</li>
</ul>
<h3 data-number="20.2.6" id="common-issues-24"><span
class="header-section-number">20.2.6</span> Common Issues</h3>
<p><strong>Query not found</strong>: Ensure <code>data-operation</code>
attribute matches operation type (list/get/create/update/delete).</p>
<p><strong>Variables not passed</strong>: Variable names must match
GraphQL schema. Check operation definitions.</p>
<p><strong>Response path mapping</strong>: Use <code>data-path</code>
attribute to specify nested result path:
<code>data-path="data.users"</code>.</p>
<hr />
<h2 data-number="20.3" id="pan-websocket"><span
class="header-section-number">20.3</span> pan-websocket</h2>
<p><strong>Purpose</strong>: Bidirectional WebSocket communication via
PAN bus<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-websocket.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="20.3.1" id="quick-example-24"><span
class="header-section-number">20.3.1</span> Quick Example</h3>
<div class="sourceCode" id="cb261"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-websocket</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  url</span><span class="op">=</span><span class="st">&quot;wss://api.example.com/ws&quot;</span></span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  auto-connect</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-websocket</span><span class="dt">&gt;</span></span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for connection</span></span>
<span id="cb261-12"><a href="#cb261-12" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb261-13"><a href="#cb261-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;WebSocket connected&#39;</span>)<span class="op">;</span></span>
<span id="cb261-14"><a href="#cb261-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb261-15"><a href="#cb261-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-16"><a href="#cb261-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Send message</span></span>
<span id="cb261-17"><a href="#cb261-17" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.send&#39;</span><span class="op">,</span> { </span>
<span id="cb261-18"><a href="#cb261-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;subscribe&#39;</span><span class="op">,</span></span>
<span id="cb261-19"><a href="#cb261-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">channel</span><span class="op">:</span> <span class="st">&#39;notifications&#39;</span></span>
<span id="cb261-20"><a href="#cb261-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb261-21"><a href="#cb261-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-22"><a href="#cb261-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Receive messages</span></span>
<span id="cb261-23"><a href="#cb261-23" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb261-24"><a href="#cb261-24" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Received:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb261-25"><a href="#cb261-25" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb261-26"><a href="#cb261-26" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.3.2" id="attributes-8"><span
class="header-section-number">20.3.2</span> Attributes</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>String</td>
<td>“”</td>
<td>WebSocket URL (ws:// or wss://)</td>
</tr>
<tr>
<td><code>auto-connect</code></td>
<td>Boolean</td>
<td>false</td>
<td>Connect on component mount</td>
</tr>
<tr>
<td><code>auto-reconnect</code></td>
<td>Boolean</td>
<td>true</td>
<td>Reconnect on disconnect</td>
</tr>
<tr>
<td><code>reconnect-delay</code></td>
<td>Number</td>
<td>1000</td>
<td>Reconnect delay (ms)</td>
</tr>
<tr>
<td><code>max-reconnect-attempts</code></td>
<td>Number</td>
<td>Infinity</td>
<td>Max reconnection attempts</td>
</tr>
</tbody>
</table>
<h3 data-number="20.3.3" id="methods-6"><span
class="header-section-number">20.3.3</span> Methods</h3>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect()</code></td>
<td>-</td>
<td>Promise&lt;void&gt;</td>
<td>Open WebSocket connection</td>
</tr>
<tr>
<td><code>disconnect()</code></td>
<td>-</td>
<td>void</td>
<td>Close connection</td>
</tr>
<tr>
<td><code>send(data)</code></td>
<td>data: Any</td>
<td>void</td>
<td>Send message (auto-serializes JSON)</td>
</tr>
</tbody>
</table>
<h3 data-number="20.3.4" id="pan-topics-3"><span
class="header-section-number">20.3.4</span> PAN Topics</h3>
<h4 data-number="20.3.4.1" id="published-2"><span
class="header-section-number">20.3.4.1</span> Published</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ws.connected</code></td>
<td><code>{ url }</code></td>
<td>Connection opened</td>
</tr>
<tr>
<td><code>ws.disconnected</code></td>
<td><code>{ code, reason }</code></td>
<td>Connection closed</td>
</tr>
<tr>
<td><code>ws.message</code></td>
<td><code>{ ...data }</code></td>
<td>Message received</td>
</tr>
<tr>
<td><code>ws.error</code></td>
<td><code>{ error }</code></td>
<td>Error occurred</td>
</tr>
</tbody>
</table>
<h4 data-number="20.3.4.2" id="subscribed-3"><span
class="header-section-number">20.3.4.2</span> Subscribed</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ws.connect</code></td>
<td><code>{ url? }</code></td>
<td>Open connection</td>
</tr>
<tr>
<td><code>ws.disconnect</code></td>
<td><code>{}</code></td>
<td>Close connection</td>
</tr>
<tr>
<td><code>ws.send</code></td>
<td><code>{ ...data }</code></td>
<td>Send message</td>
</tr>
</tbody>
</table>
<h3 data-number="20.3.5" id="complete-example-16"><span
class="header-section-number">20.3.5</span> Complete Example</h3>
<div class="sourceCode" id="cb262"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-websocket.mjs&#39;</span><span class="op">;</span></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Connection status</span></span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb262-14"><a href="#cb262-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Connected&#39;</span><span class="op">;</span></span>
<span id="cb262-15"><a href="#cb262-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">color</span> <span class="op">=</span> <span class="st">&#39;green&#39;</span><span class="op">;</span></span>
<span id="cb262-16"><a href="#cb262-16" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb262-17"><a href="#cb262-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-18"><a href="#cb262-18" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.disconnected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb262-19"><a href="#cb262-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Disconnected&#39;</span><span class="op">;</span></span>
<span id="cb262-20"><a href="#cb262-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">color</span> <span class="op">=</span> <span class="st">&#39;red&#39;</span><span class="op">;</span></span>
<span id="cb262-21"><a href="#cb262-21" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb262-22"><a href="#cb262-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-23"><a href="#cb262-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Receive messages</span></span>
<span id="cb262-24"><a href="#cb262-24" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb262-25"><a href="#cb262-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> log <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;log&#39;</span>)<span class="op">;</span></span>
<span id="cb262-26"><a href="#cb262-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> entry <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb262-27"><a href="#cb262-27" aria-hidden="true" tabindex="-1"></a>        entry<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb262-28"><a href="#cb262-28" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">prepend</span>(entry)<span class="op">;</span></span>
<span id="cb262-29"><a href="#cb262-29" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb262-30"><a href="#cb262-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-31"><a href="#cb262-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Send message</span></span>
<span id="cb262-32"><a href="#cb262-32" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">sendMessage</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb262-33"><a href="#cb262-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> input <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;message&#39;</span>)<span class="op">;</span></span>
<span id="cb262-34"><a href="#cb262-34" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.send&#39;</span><span class="op">,</span> { </span>
<span id="cb262-35"><a href="#cb262-35" aria-hidden="true" tabindex="-1"></a>          <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;chat&#39;</span><span class="op">,</span></span>
<span id="cb262-36"><a href="#cb262-36" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> input<span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb262-37"><a href="#cb262-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb262-38"><a href="#cb262-38" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb262-39"><a href="#cb262-39" aria-hidden="true" tabindex="-1"></a>        input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb262-40"><a href="#cb262-40" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb262-41"><a href="#cb262-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-42"><a href="#cb262-42" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Connect/disconnect</span></span>
<span id="cb262-43"><a href="#cb262-43" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">connect</span> <span class="op">=</span> () <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.connect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb262-44"><a href="#cb262-44" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="fu">disconnect</span> <span class="op">=</span> () <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.disconnect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb262-45"><a href="#cb262-45" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb262-46"><a href="#cb262-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb262-47"><a href="#cb262-47" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb262-48"><a href="#cb262-48" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb262-49"><a href="#cb262-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb262-50"><a href="#cb262-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-websocket</span><span class="ot"> url</span><span class="op">=</span><span class="st">&quot;wss://api.example.com/ws&quot;</span><span class="ot"> auto-connect</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-websocket</span><span class="dt">&gt;</span></span>
<span id="cb262-51"><a href="#cb262-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-52"><a href="#cb262-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb262-53"><a href="#cb262-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>WebSocket Demo<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb262-54"><a href="#cb262-54" aria-hidden="true" tabindex="-1"></a>    Status: <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;status&quot;</span><span class="dt">&gt;</span>Disconnected<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb262-55"><a href="#cb262-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;connect()&quot;</span><span class="dt">&gt;</span>Connect<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb262-56"><a href="#cb262-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;disconnect()&quot;</span><span class="dt">&gt;</span>Disconnect<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb262-57"><a href="#cb262-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-58"><a href="#cb262-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb262-59"><a href="#cb262-59" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;message&quot;</span><span class="ot"> placeholder</span><span class="op">=</span><span class="st">&quot;Enter message&quot;</span><span class="dt">&gt;</span></span>
<span id="cb262-60"><a href="#cb262-60" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;sendMessage()&quot;</span><span class="dt">&gt;</span>Send<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb262-61"><a href="#cb262-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb262-62"><a href="#cb262-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-63"><a href="#cb262-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h3</span><span class="dt">&gt;</span>Log<span class="dt">&lt;/</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb262-64"><a href="#cb262-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;log&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb262-65"><a href="#cb262-65" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb262-66"><a href="#cb262-66" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb262-67"><a href="#cb262-67" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.3.6" id="errors-11"><span
class="header-section-number">20.3.6</span> Errors</h3>
<p>pan-websocket publishes errors to <code>ws.error</code> topic:</p>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONNECTION_FAILED</code></td>
<td>Cannot connect to WebSocket server</td>
<td>Check URL and server availability</td>
</tr>
<tr>
<td><code>CONNECTION_CLOSED</code></td>
<td>Connection closed unexpectedly</td>
<td>Check server logs, will auto-reconnect if enabled</td>
</tr>
<tr>
<td><code>SEND_FAILED</code></td>
<td>Message send failed</td>
<td>Check connection status before sending</td>
</tr>
<tr>
<td><code>INVALID_URL</code></td>
<td>WebSocket URL is invalid</td>
<td>Use valid ws:// or wss:// URL</td>
</tr>
<tr>
<td><code>MAX_RECONNECT_EXCEEDED</code></td>
<td>Max reconnection attempts reached</td>
<td>Check server, increase max attempts, or fix issue</td>
</tr>
<tr>
<td><code>MESSAGE_PARSE_ERROR</code></td>
<td>Cannot parse received message</td>
<td>Check message format from server</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb263"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to errors</span></span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { error<span class="op">,</span> code<span class="op">,</span> url } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;WebSocket Error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (code) {</span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">1006</span><span class="op">:</span> <span class="co">// Abnormal closure</span></span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Connection lost abnormally&#39;</span>)<span class="op">;</span></span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="st">&#39;Connection lost, reconnecting...&#39;</span>)<span class="op">;</span></span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">1008</span><span class="op">:</span> <span class="co">// Policy violation</span></span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Connection rejected by server&#39;</span>)<span class="op">;</span></span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showNotification</span>(<span class="st">&#39;Access denied&#39;</span>)<span class="op">;</span></span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb263-20"><a href="#cb263-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-21"><a href="#cb263-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">1011</span><span class="op">:</span> <span class="co">// Server error</span></span>
<span id="cb263-22"><a href="#cb263-22" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Server error occurred&#39;</span>)<span class="op">;</span></span>
<span id="cb263-23"><a href="#cb263-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">retryAfterDelay</span>(<span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb263-24"><a href="#cb263-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb263-25"><a href="#cb263-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-26"><a href="#cb263-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb263-27"><a href="#cb263-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;MAX_RECONNECT_EXCEEDED&#39;</span>)) {</span>
<span id="cb263-28"><a href="#cb263-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">showNotification</span>(<span class="st">&#39;Cannot connect to server&#39;</span>)<span class="op">;</span></span>
<span id="cb263-29"><a href="#cb263-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">showOfflineMode</span>()<span class="op">;</span></span>
<span id="cb263-30"><a href="#cb263-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb263-31"><a href="#cb263-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-32"><a href="#cb263-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-33"><a href="#cb263-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-34"><a href="#cb263-34" aria-hidden="true" tabindex="-1"></a><span class="co">// Monitor connection lifecycle</span></span>
<span id="cb263-35"><a href="#cb263-35" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> connectionAttempts <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb263-36"><a href="#cb263-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-37"><a href="#cb263-37" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb263-38"><a href="#cb263-38" aria-hidden="true" tabindex="-1"></a>  connectionAttempts <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb263-39"><a href="#cb263-39" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;WebSocket connected&#39;</span>)<span class="op">;</span></span>
<span id="cb263-40"><a href="#cb263-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showOnlineStatus</span>()<span class="op">;</span></span>
<span id="cb263-41"><a href="#cb263-41" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-42"><a href="#cb263-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-43"><a href="#cb263-43" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.disconnected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb263-44"><a href="#cb263-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { code<span class="op">,</span> reason } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb263-45"><a href="#cb263-45" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Disconnected: </span><span class="sc">${</span>code<span class="sc">}</span><span class="vs"> - </span><span class="sc">${</span>reason<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb263-46"><a href="#cb263-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb263-47"><a href="#cb263-47" aria-hidden="true" tabindex="-1"></a>  connectionAttempts<span class="op">++;</span></span>
<span id="cb263-48"><a href="#cb263-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (connectionAttempts <span class="op">&gt;</span> <span class="dv">3</span>) {</span>
<span id="cb263-49"><a href="#cb263-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">showPersistentConnectionIssueWarning</span>()<span class="op">;</span></span>
<span id="cb263-50"><a href="#cb263-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-51"><a href="#cb263-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-52"><a href="#cb263-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-53"><a href="#cb263-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Heartbeat to detect connection issues</span></span>
<span id="cb263-54"><a href="#cb263-54" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> heartbeatInterval<span class="op">;</span></span>
<span id="cb263-55"><a href="#cb263-55" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> lastHeartbeat <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb263-56"><a href="#cb263-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-57"><a href="#cb263-57" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.connected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb263-58"><a href="#cb263-58" aria-hidden="true" tabindex="-1"></a>  heartbeatInterval <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb263-59"><a href="#cb263-59" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.send&#39;</span><span class="op">,</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;ping&#39;</span><span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb263-60"><a href="#cb263-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb263-61"><a href="#cb263-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if we&#39;ve received pong</span></span>
<span id="cb263-62"><a href="#cb263-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> lastHeartbeat <span class="op">&gt;</span> <span class="dv">30000</span>) {</span>
<span id="cb263-63"><a href="#cb263-63" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Heartbeat timeout, reconnecting...&#39;</span>)<span class="op">;</span></span>
<span id="cb263-64"><a href="#cb263-64" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.disconnect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb263-65"><a href="#cb263-65" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.connect&#39;</span><span class="op">,</span> {})<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb263-66"><a href="#cb263-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb263-67"><a href="#cb263-67" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb263-68"><a href="#cb263-68" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-69"><a href="#cb263-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-70"><a href="#cb263-70" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb263-71"><a href="#cb263-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;pong&#39;</span>) {</span>
<span id="cb263-72"><a href="#cb263-72" aria-hidden="true" tabindex="-1"></a>    lastHeartbeat <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb263-73"><a href="#cb263-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-74"><a href="#cb263-74" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-75"><a href="#cb263-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-76"><a href="#cb263-76" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.disconnected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb263-77"><a href="#cb263-77" aria-hidden="true" tabindex="-1"></a>  <span class="pp">clearInterval</span>(heartbeatInterval)<span class="op">;</span></span>
<span id="cb263-78"><a href="#cb263-78" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb263-79"><a href="#cb263-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-80"><a href="#cb263-80" aria-hidden="true" tabindex="-1"></a><span class="co">// Message queuing when offline</span></span>
<span id="cb263-81"><a href="#cb263-81" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> messageQueue <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb263-82"><a href="#cb263-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-83"><a href="#cb263-83" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sendMessage</span>(data) {</span>
<span id="cb263-84"><a href="#cb263-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if connected</span></span>
<span id="cb263-85"><a href="#cb263-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-websocket&#39;</span>)<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb263-86"><a href="#cb263-86" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.send&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb263-87"><a href="#cb263-87" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb263-88"><a href="#cb263-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Queue message</span></span>
<span id="cb263-89"><a href="#cb263-89" aria-hidden="true" tabindex="-1"></a>    messageQueue<span class="op">.</span><span class="fu">push</span>(data)<span class="op">;</span></span>
<span id="cb263-90"><a href="#cb263-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Message queued (offline)&#39;</span>)<span class="op">;</span></span>
<span id="cb263-91"><a href="#cb263-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-92"><a href="#cb263-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb263-93"><a href="#cb263-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-94"><a href="#cb263-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Send queued messages on reconnect</span></span>
<span id="cb263-95"><a href="#cb263-95" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.connected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb263-96"><a href="#cb263-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (messageQueue<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb263-97"><a href="#cb263-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> messageQueue<span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb263-98"><a href="#cb263-98" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.send&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb263-99"><a href="#cb263-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-100"><a href="#cb263-100" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>WebSocket Close Codes</strong>: Standard close codes passed
in <code>ws.disconnected</code>:</p>
<ul>
<li>1000: Normal closure</li>
<li>1001: Going away (page unload)</li>
<li>1002: Protocol error</li>
<li>1003: Unsupported data</li>
<li>1006: Abnormal closure (no close frame)</li>
<li>1007: Invalid data</li>
<li>1008: Policy violation</li>
<li>1009: Message too big</li>
<li>1011: Server error</li>
</ul>
<h3 data-number="20.3.7" id="common-issues-25"><span
class="header-section-number">20.3.7</span> Common Issues</h3>
<p><strong>Connection fails</strong>: Check URL scheme (ws:// for HTTP,
wss:// for HTTPS). Ensure server is running.</p>
<p><strong>Auto-reconnect loops</strong>: Increase
<code>reconnect-delay</code> or set <code>max-reconnect-attempts</code>
to prevent rapid retries.</p>
<p><strong>Messages not received</strong>: Ensure message format matches
expected structure. Check <code>ws.message</code> subscription.</p>
<p><strong>CORS issues</strong>: WebSocket doesn’t use CORS. Check
server’s Origin header validation.</p>
<hr />
<h2 data-number="20.4" id="pan-sse"><span
class="header-section-number">20.4</span> pan-sse</h2>
<p><strong>Purpose</strong>: Server-Sent Events streaming via PAN
bus<br />
<strong>Import</strong>:
<code>&lt;script type="module" src="/ui/pan-sse.mjs"&gt;&lt;/script&gt;</code></p>
<h3 data-number="20.4.1" id="quick-example-25"><span
class="header-section-number">20.4.1</span> Quick Example</h3>
<div class="sourceCode" id="cb264"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-sse</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  url</span><span class="op">=</span><span class="st">&quot;https://api.example.com/events&quot;</span></span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  auto-connect</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-sse</span><span class="dt">&gt;</span></span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-6"><a href="#cb264-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb264-7"><a href="#cb264-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb264-8"><a href="#cb264-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-9"><a href="#cb264-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb264-10"><a href="#cb264-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-11"><a href="#cb264-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for connection</span></span>
<span id="cb264-12"><a href="#cb264-12" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb264-13"><a href="#cb264-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;SSE connected&#39;</span>)<span class="op">;</span></span>
<span id="cb264-14"><a href="#cb264-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb264-15"><a href="#cb264-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-16"><a href="#cb264-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Receive events</span></span>
<span id="cb264-17"><a href="#cb264-17" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb264-18"><a href="#cb264-18" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Event:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb264-19"><a href="#cb264-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb264-20"><a href="#cb264-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-21"><a href="#cb264-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Receive custom event types</span></span>
<span id="cb264-22"><a href="#cb264-22" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.event.notification&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb264-23"><a href="#cb264-23" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Notification:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb264-24"><a href="#cb264-24" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb264-25"><a href="#cb264-25" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.4.2" id="attributes-9"><span
class="header-section-number">20.4.2</span> Attributes</h3>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 15%" />
<col style="width: 23%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>String</td>
<td>“”</td>
<td>SSE endpoint URL</td>
</tr>
<tr>
<td><code>auto-connect</code></td>
<td>Boolean</td>
<td>false</td>
<td>Connect on mount</td>
</tr>
<tr>
<td><code>with-credentials</code></td>
<td>Boolean</td>
<td>false</td>
<td>Include credentials in request</td>
</tr>
</tbody>
</table>
<h3 data-number="20.4.3" id="methods-7"><span
class="header-section-number">20.4.3</span> Methods</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>connect()</code></td>
<td>-</td>
<td>void</td>
<td>Open SSE connection</td>
</tr>
<tr>
<td><code>disconnect()</code></td>
<td>-</td>
<td>void</td>
<td>Close connection</td>
</tr>
</tbody>
</table>
<h3 data-number="20.4.4" id="pan-topics-4"><span
class="header-section-number">20.4.4</span> PAN Topics</h3>
<h4 data-number="20.4.4.1" id="published-3"><span
class="header-section-number">20.4.4.1</span> Published</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sse.connected</code></td>
<td><code>{ url }</code></td>
<td>Connection opened</td>
</tr>
<tr>
<td><code>sse.disconnected</code></td>
<td><code>{}</code></td>
<td>Connection closed</td>
</tr>
<tr>
<td><code>sse.message</code></td>
<td><code>{ data, id?, type? }</code></td>
<td>Default message event</td>
</tr>
<tr>
<td><code>sse.event.\${type}</code></td>
<td><code>{ data, id? }</code></td>
<td>Custom event type</td>
</tr>
<tr>
<td><code>sse.error</code></td>
<td><code>{ error }</code></td>
<td>Error occurred</td>
</tr>
</tbody>
</table>
<h4 data-number="20.4.4.2" id="subscribed-4"><span
class="header-section-number">20.4.4.2</span> Subscribed</h4>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sse.connect</code></td>
<td><code>{ url? }</code></td>
<td>Open connection</td>
</tr>
<tr>
<td><code>sse.disconnect</code></td>
<td><code>{}</code></td>
<td>Close connection</td>
</tr>
</tbody>
</table>
<h3 data-number="20.4.5" id="complete-example-17"><span
class="header-section-number">20.4.5</span> Complete Example</h3>
<div class="sourceCode" id="cb265"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-sse.mjs&#39;</span><span class="op">;</span></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Connection status</span></span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Streaming&#39;</span><span class="op">;</span></span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">color</span> <span class="op">=</span> <span class="st">&#39;green&#39;</span><span class="op">;</span></span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.disconnected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Stopped&#39;</span><span class="op">;</span></span>
<span id="cb265-20"><a href="#cb265-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;status&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">color</span> <span class="op">=</span> <span class="st">&#39;red&#39;</span><span class="op">;</span></span>
<span id="cb265-21"><a href="#cb265-21" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb265-22"><a href="#cb265-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-23"><a href="#cb265-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Receive default messages</span></span>
<span id="cb265-24"><a href="#cb265-24" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb265-25"><a href="#cb265-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addLog</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb265-26"><a href="#cb265-26" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb265-27"><a href="#cb265-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-28"><a href="#cb265-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Receive custom event types</span></span>
<span id="cb265-29"><a href="#cb265-29" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.event.update&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb265-30"><a href="#cb265-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addLog</span>(<span class="st">&#39;update&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb265-31"><a href="#cb265-31" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb265-32"><a href="#cb265-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-33"><a href="#cb265-33" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.event.notification&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb265-34"><a href="#cb265-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">addLog</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb265-35"><a href="#cb265-35" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb265-36"><a href="#cb265-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-37"><a href="#cb265-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">function</span> <span class="fu">addLog</span>(type<span class="op">,</span> data) {</span>
<span id="cb265-38"><a href="#cb265-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> log <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;log&#39;</span>)<span class="op">;</span></span>
<span id="cb265-39"><a href="#cb265-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> entry <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb265-40"><a href="#cb265-40" aria-hidden="true" tabindex="-1"></a>        entry<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;strong&gt;</span><span class="sc">${</span>type<span class="sc">}</span><span class="vs">:&lt;/strong&gt; </span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb265-41"><a href="#cb265-41" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">prepend</span>(entry)<span class="op">;</span></span>
<span id="cb265-42"><a href="#cb265-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb265-43"><a href="#cb265-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-44"><a href="#cb265-44" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">startStream</span> <span class="op">=</span> () <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.connect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb265-45"><a href="#cb265-45" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">stopStream</span> <span class="op">=</span> () <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.disconnect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb265-46"><a href="#cb265-46" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb265-47"><a href="#cb265-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb265-48"><a href="#cb265-48" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb265-49"><a href="#cb265-49" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb265-50"><a href="#cb265-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb265-51"><a href="#cb265-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-sse</span><span class="ot"> url</span><span class="op">=</span><span class="st">&quot;https://api.example.com/events&quot;</span><span class="ot"> auto-connect</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-sse</span><span class="dt">&gt;</span></span>
<span id="cb265-52"><a href="#cb265-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-53"><a href="#cb265-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb265-54"><a href="#cb265-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>SSE Demo<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb265-55"><a href="#cb265-55" aria-hidden="true" tabindex="-1"></a>    Status: <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;status&quot;</span><span class="dt">&gt;</span>Stopped<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb265-56"><a href="#cb265-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;startStream()&quot;</span><span class="dt">&gt;</span>Start<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb265-57"><a href="#cb265-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> onclick</span><span class="op">=</span><span class="st">&quot;stopStream()&quot;</span><span class="dt">&gt;</span>Stop<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb265-58"><a href="#cb265-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-59"><a href="#cb265-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h3</span><span class="dt">&gt;</span>Event Log<span class="dt">&lt;/</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb265-60"><a href="#cb265-60" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;log&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb265-61"><a href="#cb265-61" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb265-62"><a href="#cb265-62" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb265-63"><a href="#cb265-63" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="20.4.6" id="errors-12"><span
class="header-section-number">20.4.6</span> Errors</h3>
<p>pan-sse publishes errors to <code>sse.error</code> topic:</p>
<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 19%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Error Condition</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONNECTION_FAILED</code></td>
<td>Cannot connect to SSE endpoint</td>
<td>Check URL and server availability</td>
</tr>
<tr>
<td><code>CONNECTION_CLOSED</code></td>
<td>Stream closed unexpectedly</td>
<td>Check server logs, SSE auto-reconnects</td>
</tr>
<tr>
<td><code>PARSE_ERROR</code></td>
<td>Cannot parse event data</td>
<td>Check server event format</td>
</tr>
<tr>
<td><code>INVALID_URL</code></td>
<td>SSE URL is invalid</td>
<td>Use valid HTTP/HTTPS URL</td>
</tr>
<tr>
<td><code>NOT_SUPPORTED</code></td>
<td>Browser doesn’t support SSE</td>
<td>Use modern browser or provide fallback</td>
</tr>
</tbody>
</table>
<p><strong>Error handling example</strong>:</p>
<div class="sourceCode" id="cb266"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to errors</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { error<span class="op">,</span> readyState<span class="op">,</span> url } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;SSE Error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;CONNECTION_FAILED&#39;</span>)) {</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Retry with exponential backoff</span></span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.connect&#39;</span><span class="op">,</span> { url })<span class="op">;</span></span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb266-15"><a href="#cb266-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-16"><a href="#cb266-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-17"><a href="#cb266-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;NOT_SUPPORTED&#39;</span>)) {</span>
<span id="cb266-18"><a href="#cb266-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fall back to polling</span></span>
<span id="cb266-19"><a href="#cb266-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;SSE not supported, using polling fallback&#39;</span>)<span class="op">;</span></span>
<span id="cb266-20"><a href="#cb266-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">startPolling</span>()<span class="op">;</span></span>
<span id="cb266-21"><a href="#cb266-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-22"><a href="#cb266-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-23"><a href="#cb266-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;PARSE_ERROR&#39;</span>)) {</span>
<span id="cb266-24"><a href="#cb266-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log parse errors but continue streaming</span></span>
<span id="cb266-25"><a href="#cb266-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Invalid event format, skipping&#39;</span>)<span class="op">;</span></span>
<span id="cb266-26"><a href="#cb266-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-27"><a href="#cb266-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb266-28"><a href="#cb266-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-29"><a href="#cb266-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Monitor connection lifecycle</span></span>
<span id="cb266-30"><a href="#cb266-30" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.connected&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb266-31"><a href="#cb266-31" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;SSE streaming from:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb266-32"><a href="#cb266-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showStreamingStatus</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb266-33"><a href="#cb266-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb266-34"><a href="#cb266-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-35"><a href="#cb266-35" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.disconnected&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb266-36"><a href="#cb266-36" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;SSE stream stopped&#39;</span>)<span class="op">;</span></span>
<span id="cb266-37"><a href="#cb266-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showStreamingStatus</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb266-38"><a href="#cb266-38" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb266-39"><a href="#cb266-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-40"><a href="#cb266-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle connection drops gracefully</span></span>
<span id="cb266-41"><a href="#cb266-41" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> eventCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb266-42"><a href="#cb266-42" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> lastEventTime <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb266-43"><a href="#cb266-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-44"><a href="#cb266-44" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;sse.message&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb266-45"><a href="#cb266-45" aria-hidden="true" tabindex="-1"></a>  eventCount<span class="op">++;</span></span>
<span id="cb266-46"><a href="#cb266-46" aria-hidden="true" tabindex="-1"></a>  lastEventTime <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb266-47"><a href="#cb266-47" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb266-48"><a href="#cb266-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-49"><a href="#cb266-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Check for stale connection</span></span>
<span id="cb266-50"><a href="#cb266-50" aria-hidden="true" tabindex="-1"></a><span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb266-51"><a href="#cb266-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> timeSinceLastEvent <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> lastEventTime<span class="op">;</span></span>
<span id="cb266-52"><a href="#cb266-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb266-53"><a href="#cb266-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (timeSinceLastEvent <span class="op">&gt;</span> <span class="dv">60000</span>) { <span class="co">// 60 seconds</span></span>
<span id="cb266-54"><a href="#cb266-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;No events received recently, reconnecting...&#39;</span>)<span class="op">;</span></span>
<span id="cb266-55"><a href="#cb266-55" aria-hidden="true" tabindex="-1"></a>    pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.disconnect&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb266-56"><a href="#cb266-56" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.connect&#39;</span><span class="op">,</span> {})<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb266-57"><a href="#cb266-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-58"><a href="#cb266-58" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb266-59"><a href="#cb266-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-60"><a href="#cb266-60" aria-hidden="true" tabindex="-1"></a><span class="co">// Fallback to polling if SSE unavailable</span></span>
<span id="cb266-61"><a href="#cb266-61" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">startPolling</span>() {</span>
<span id="cb266-62"><a href="#cb266-62" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setInterval</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb266-63"><a href="#cb266-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb266-64"><a href="#cb266-64" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> res <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/events?since=&#39;</span> <span class="op">+</span> lastEventTime)<span class="op">;</span></span>
<span id="cb266-65"><a href="#cb266-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> events <span class="op">=</span> <span class="cf">await</span> res<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb266-66"><a href="#cb266-66" aria-hidden="true" tabindex="-1"></a>      events<span class="op">.</span><span class="fu">forEach</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb266-67"><a href="#cb266-67" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.message&#39;</span><span class="op">,</span> <span class="bu">event</span>)<span class="op">;</span></span>
<span id="cb266-68"><a href="#cb266-68" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb266-69"><a href="#cb266-69" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb266-70"><a href="#cb266-70" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Polling failed:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb266-71"><a href="#cb266-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-72"><a href="#cb266-72" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb266-73"><a href="#cb266-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb266-74"><a href="#cb266-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-75"><a href="#cb266-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Graceful degradation for older browsers</span></span>
<span id="cb266-76"><a href="#cb266-76" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="op">!</span>(<span class="st">&#39;EventSource&#39;</span> <span class="kw">in</span> <span class="bu">window</span>)) {</span>
<span id="cb266-77"><a href="#cb266-77" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;SSE not supported, using polling&#39;</span>)<span class="op">;</span></span>
<span id="cb266-78"><a href="#cb266-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">startPolling</span>()<span class="op">;</span></span>
<span id="cb266-79"><a href="#cb266-79" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb266-80"><a href="#cb266-80" aria-hidden="true" tabindex="-1"></a>  pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.connect&#39;</span><span class="op">,</span> { <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;/api/events&#39;</span> })<span class="op">;</span></span>
<span id="cb266-81"><a href="#cb266-81" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Browser Compatibility</strong>:</p>
<ul>
<li>SSE (EventSource API) supported in all modern browsers</li>
<li>Not available in IE11 (use polyfill or fallback to polling)</li>
<li>Check support: <code>if ('EventSource' in window)</code></li>
<li>Automatic reconnection is built into the EventSource API</li>
<li>Maximum reconnection delay: typically 3 seconds</li>
</ul>
<p><strong>Server Requirements</strong>:</p>
<ul>
<li>Must send <code>Content-Type: text/event-stream</code></li>
<li>Must send <code>Cache-Control: no-cache</code></li>
<li>Keep connection open (don’t close after each event)</li>
<li>Send <code>:\n\n</code> (comment) every 15-30 seconds to keep
alive</li>
<li>Event format: <code>data: {...}\n\n</code> or
<code>event: type\ndata: {...}\n\n</code></li>
</ul>
<h3 data-number="20.4.7" id="common-issues-26"><span
class="header-section-number">20.4.7</span> Common Issues</h3>
<p><strong>Connection closes immediately</strong>: Server must keep
connection open with proper headers:
<code>Content-Type: text/event-stream</code>,
<code>Cache-Control: no-cache</code>.</p>
<p><strong>Events not received</strong>: Check event format. Default
events use <code>data:</code> prefix. Custom events use
<code>event: type</code> followed by <code>data:</code>.</p>
<p><strong>CORS errors</strong>: Configure CORS headers on server. Use
<code>with-credentials="true"</code> for authenticated streams.</p>
<p><strong>No reconnection</strong>: SSE automatically reconnects. To
prevent, call <code>disconnect()</code> before page unload.</p>
<hr />
<h2 data-number="20.5" id="summary-3"><span
class="header-section-number">20.5</span> Summary</h2>
<p>This chapter documented LARC’s integration components:</p>
<ul>
<li><strong>pan-data-connector</strong>: REST API integration with CRUD
pattern</li>
<li><strong>pan-graphql-connector</strong>: GraphQL query and mutation
bridge</li>
<li><strong>pan-websocket</strong>: Bidirectional WebSocket
communication</li>
<li><strong>pan-sse</strong>: Server-Sent Events streaming</li>
</ul>
<p>All components transform external protocols into PAN bus messages,
maintaining architectural consistency.</p>
<p><strong>See Also</strong>:</p>
<ul>
<li>Tutorial: <em>Learning LARC</em> Chapter 11</li>
<li>Core components: Chapter 17</li>
<li>Data components: Chapter 18</li>
<li>Authentication patterns: Appendix B</li>
</ul>
<h1 data-number="21" id="utility-components-reference"><span
class="header-section-number">21</span> Utility Components
Reference</h1>
<p>API documentation for LARC’s utility components. For tutorials, see
<em>Learning LARC</em> Chapter 14.</p>
<h2 data-number="21.1" id="pan-debug"><span
class="header-section-number">21.1</span> pan-debug</h2>
<p><strong>Purpose</strong>: Message tracing and debugging for PAN bus
introspection<br />
<strong>Import</strong>:
<code>import { PanDebugManager } from './pan-debug.mjs';</code><br />
<strong>Global Access</strong>: <code>window.pan.debug</code> (when
using pan-bus)</p>
<h3 data-number="21.1.1" id="quick-example-26"><span
class="header-section-number">21.1.1</span> Quick Example</h3>
<div class="sourceCode" id="cb267"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Access via global</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> debug <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">debug</span><span class="op">;</span></span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Enable tracing</span></span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>debug<span class="op">.</span><span class="fu">enableTracing</span>({ <span class="dt">maxBuffer</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> <span class="dt">sampleRate</span><span class="op">:</span> <span class="fl">1.0</span> })<span class="op">;</span></span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Query messages</span></span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> recentMessages <span class="op">=</span> debug<span class="op">.</span><span class="fu">getTrace</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="dv">10</span> })<span class="op">;</span></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Recent messages:&#39;</span><span class="op">,</span> recentMessages)<span class="op">;</span></span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Find specific messages</span></span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> loginMessages <span class="op">=</span> debug<span class="op">.</span><span class="fu">findMessages</span>({</span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;user.login&#39;</span><span class="op">,</span></span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">timeRange</span><span class="op">:</span> { <span class="dt">start</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> <span class="dv">60000</span> } <span class="co">// Last minute</span></span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Export for analysis</span></span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> traceData <span class="op">=</span> debug<span class="op">.</span><span class="fu">exportTrace</span>()<span class="op">;</span></span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Trace export:&#39;</span><span class="op">,</span> traceData)<span class="op">;</span></span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Disable when done</span></span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a>debug<span class="op">.</span><span class="fu">disableTracing</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="21.1.2" id="api-1"><span
class="header-section-number">21.1.2</span> API</h3>
<h4 data-number="21.1.2.1" id="constructor"><span
class="header-section-number">21.1.2.1</span> Constructor</h4>
<div class="sourceCode" id="cb268"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">PanDebugManager</span>()</span></code></pre></div>
<p>Creates debug manager with defaults:</p>
<ul>
<li><code>enabled</code>: false</li>
<li><code>maxBuffer</code>: 1000</li>
<li><code>sampleRate</code>: 1.0 (100%)</li>
</ul>
<h4 data-number="21.1.2.2" id="configuration-methods"><span
class="header-section-number">21.1.2.2</span> Configuration Methods</h4>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>enableTracing(options)</code></td>
<td>options?: <code>{ maxBuffer?, sampleRate? }</code></td>
<td>Enable message tracing</td>
</tr>
<tr>
<td><code>disableTracing()</code></td>
<td>-</td>
<td>Disable tracing and clear buffer</td>
</tr>
<tr>
<td><code>setSampleRate(rate)</code></td>
<td>rate: Number (0.0-1.0)</td>
<td>Set sampling rate</td>
</tr>
<tr>
<td><code>clearTrace()</code></td>
<td>-</td>
<td>Clear trace buffer</td>
</tr>
</tbody>
</table>
<p><strong>options:</strong> - <code>maxBuffer</code> (Number, default:
1000): Max messages to retain - <code>sampleRate</code> (Number,
default: 1.0): Sampling rate (0.0-1.0)</p>
<h4 data-number="21.1.2.3" id="query-methods"><span
class="header-section-number">21.1.2.3</span> Query Methods</h4>
<table>
<colgroup>
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 21%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Parameters</th>
<th>Returns</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>getTrace(options)</code></td>
<td>options?: <code>{ limit?, offset? }</code></td>
<td>Array</td>
<td>Get trace buffer</td>
</tr>
<tr>
<td><code>findMessages(query)</code></td>
<td>query: Object</td>
<td>Array</td>
<td>Find messages matching criteria</td>
</tr>
<tr>
<td><code>getStats()</code></td>
<td>-</td>
<td>Object</td>
<td>Get statistics</td>
</tr>
<tr>
<td><code>exportTrace(format)</code></td>
<td>format?: String</td>
<td>String/Object</td>
<td>Export trace data</td>
</tr>
</tbody>
</table>
<p><strong>Query options:</strong> - <code>topic</code> (String): Match
topic pattern - <code>clientId</code> (String): Filter by client ID -
<code>timeRange</code> (Object): <code>{ start?, end? }</code> in
milliseconds - <code>limit</code> (Number): Max results</p>
<p><strong>Stats object:</strong></p>
<div class="sourceCode" id="cb269"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">totalMessages</span><span class="op">:</span> <span class="dv">1523</span><span class="op">,</span></span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tracedMessages</span><span class="op">:</span> <span class="dv">1523</span><span class="op">,</span></span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">droppedMessages</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bufferSize</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sampleRate</span><span class="op">:</span> <span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">enabled</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="21.1.3" id="complete-example-18"><span
class="header-section-number">21.1.3</span> Complete Example</h3>
<div class="sourceCode" id="cb270"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanDebugManager } <span class="im">from</span> <span class="st">&#39;./pan-debug.mjs&#39;</span><span class="op">;</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create and enable</span></span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> debug <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanDebugManager</span>()<span class="op">;</span></span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>debug<span class="op">.</span><span class="fu">enableTracing</span>({ <span class="dt">maxBuffer</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="dt">sampleRate</span><span class="op">:</span> <span class="fl">0.1</span> })<span class="op">;</span> <span class="co">// Sample 10%</span></span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Build debug UI</span></span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">buildDebugPanel</span>() {</span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> panel <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a>  panel<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">cssText</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb270-11"><a href="#cb270-11" aria-hidden="true" tabindex="-1"></a><span class="vs">    position: fixed; bottom: 0; right: 0; width: 400px; height: 300px;</span></span>
<span id="cb270-12"><a href="#cb270-12" aria-hidden="true" tabindex="-1"></a><span class="vs">    background: white; border: 1px solid #ccc; overflow: auto; </span></span>
<span id="cb270-13"><a href="#cb270-13" aria-hidden="true" tabindex="-1"></a><span class="vs">    font-family: monospace; font-size: 12px; padding: 10px;</span></span>
<span id="cb270-14"><a href="#cb270-14" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb270-15"><a href="#cb270-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-16"><a href="#cb270-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> refresh <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb270-17"><a href="#cb270-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> messages <span class="op">=</span> debug<span class="op">.</span><span class="fu">getTrace</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span> })<span class="op">;</span></span>
<span id="cb270-18"><a href="#cb270-18" aria-hidden="true" tabindex="-1"></a>    panel<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb270-19"><a href="#cb270-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h3&gt;PAN Bus Debug (</span><span class="sc">${</span>debug<span class="op">.</span><span class="fu">getStats</span>()<span class="op">.</span><span class="at">totalMessages</span><span class="sc">}</span><span class="vs"> total)&lt;/h3&gt;</span></span>
<span id="cb270-20"><a href="#cb270-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button onclick=&quot;window.panDebug.clearTrace()&quot;&gt;Clear&lt;/button&gt;</span></span>
<span id="cb270-21"><a href="#cb270-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button onclick=&quot;window.panDebug.exportToConsole()&quot;&gt;Export&lt;/button&gt;</span></span>
<span id="cb270-22"><a href="#cb270-22" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;hr&gt;</span></span>
<span id="cb270-23"><a href="#cb270-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>messages<span class="op">.</span><span class="fu">map</span>(msg <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb270-24"><a href="#cb270-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style=&quot;margin: 5px 0; border-left: 3px solid #007bff; padding-left: 5px;&quot;&gt;</span></span>
<span id="cb270-25"><a href="#cb270-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;strong&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">&lt;/strong&gt;</span></span>
<span id="cb270-26"><a href="#cb270-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;small&gt;(</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(msg<span class="op">.</span><span class="at">timestamp</span>)<span class="op">.</span><span class="fu">toLocaleTimeString</span>()<span class="sc">}</span><span class="vs">)&lt;/small&gt;</span></span>
<span id="cb270-27"><a href="#cb270-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;pre style=&quot;margin: 2px 0;&quot;&gt;</span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/pre&gt;</span></span>
<span id="cb270-28"><a href="#cb270-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb270-29"><a href="#cb270-29" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb270-30"><a href="#cb270-30" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb270-31"><a href="#cb270-31" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb270-32"><a href="#cb270-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-33"><a href="#cb270-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Refresh every 2 seconds</span></span>
<span id="cb270-34"><a href="#cb270-34" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setInterval</span>(refresh<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb270-35"><a href="#cb270-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb270-36"><a href="#cb270-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-37"><a href="#cb270-37" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(panel)<span class="op">;</span></span>
<span id="cb270-38"><a href="#cb270-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-39"><a href="#cb270-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Expose controls</span></span>
<span id="cb270-40"><a href="#cb270-40" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">panDebug</span> <span class="op">=</span> {</span>
<span id="cb270-41"><a href="#cb270-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">clearTrace</span><span class="op">:</span> () <span class="kw">=&gt;</span> { debug<span class="op">.</span><span class="fu">clearTrace</span>()<span class="op">;</span> <span class="fu">refresh</span>()<span class="op">;</span> }<span class="op">,</span></span>
<span id="cb270-42"><a href="#cb270-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">exportToConsole</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(debug<span class="op">.</span><span class="fu">exportTrace</span>())</span>
<span id="cb270-43"><a href="#cb270-43" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb270-44"><a href="#cb270-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb270-45"><a href="#cb270-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-46"><a href="#cb270-46" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize when bus ready</span></span>
<span id="cb270-47"><a href="#cb270-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">window</span><span class="op">.</span><span class="at">__panReady</span>) {</span>
<span id="cb270-48"><a href="#cb270-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">buildDebugPanel</span>()<span class="op">;</span></span>
<span id="cb270-49"><a href="#cb270-49" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb270-50"><a href="#cb270-50" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;pan:sys.ready&#39;</span><span class="op">,</span> buildDebugPanel<span class="op">,</span> { <span class="dt">once</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb270-51"><a href="#cb270-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="21.1.4" id="helper-functions"><span
class="header-section-number">21.1.4</span> Helper Functions</h3>
<div class="sourceCode" id="cb271"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter by topic pattern</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">findByTopic</span>(pattern) {</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> debug<span class="op">.</span><span class="fu">findMessages</span>({ <span class="dt">topic</span><span class="op">:</span> pattern })<span class="op">;</span></span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Get message frequency</span></span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getMessageFrequency</span>() {</span>
<span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> messages <span class="op">=</span> debug<span class="op">.</span><span class="fu">getTrace</span>()<span class="op">;</span></span>
<span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> freq <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb271-10"><a href="#cb271-10" aria-hidden="true" tabindex="-1"></a>  messages<span class="op">.</span><span class="fu">forEach</span>(msg <span class="kw">=&gt;</span> {</span>
<span id="cb271-11"><a href="#cb271-11" aria-hidden="true" tabindex="-1"></a>    freq[msg<span class="op">.</span><span class="at">topic</span>] <span class="op">=</span> (freq[msg<span class="op">.</span><span class="at">topic</span>] <span class="op">||</span> <span class="dv">0</span>) <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb271-12"><a href="#cb271-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb271-13"><a href="#cb271-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(freq)<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b[<span class="dv">1</span>] <span class="op">-</span> a[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb271-14"><a href="#cb271-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb271-15"><a href="#cb271-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-16"><a href="#cb271-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Find slow handlers</span></span>
<span id="cb271-17"><a href="#cb271-17" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">findSlowHandlers</span>(thresholdMs <span class="op">=</span> <span class="dv">100</span>) {</span>
<span id="cb271-18"><a href="#cb271-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> messages <span class="op">=</span> debug<span class="op">.</span><span class="fu">getTrace</span>()<span class="op">;</span></span>
<span id="cb271-19"><a href="#cb271-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> messages<span class="op">.</span><span class="fu">filter</span>(msg <span class="kw">=&gt;</span> </span>
<span id="cb271-20"><a href="#cb271-20" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">.</span><span class="at">processingTime</span> <span class="op">&amp;&amp;</span> msg<span class="op">.</span><span class="at">processingTime</span> <span class="op">&gt;</span> thresholdMs</span>
<span id="cb271-21"><a href="#cb271-21" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb271-22"><a href="#cb271-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="21.1.5" id="errors-13"><span
class="header-section-number">21.1.5</span> Errors</h3>
<p>pan-debug can encounter various error conditions during tracing
operations. All errors are thrown as standard JavaScript errors.</p>
<h4 data-number="21.1.5.1" id="error-conditions"><span
class="header-section-number">21.1.5.1</span> Error Conditions</h4>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 28%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr>
<th>Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BUFFER_OVERFLOW</code></td>
<td>Trace buffer exceeded maxBuffer limit</td>
<td>Increase maxBuffer, reduce sampleRate, or clear trace more
frequently</td>
</tr>
<tr>
<td><code>INVALID_SAMPLE_RATE</code></td>
<td>sampleRate outside 0.0-1.0 range</td>
<td>Provide valid sample rate between 0.0 and 1.0</td>
</tr>
<tr>
<td><code>QUERY_FAILED</code></td>
<td>findMessages() query malformed</td>
<td>Check query object format (topic, clientId, timeRange)</td>
</tr>
<tr>
<td><code>EXPORT_FAILED</code></td>
<td>exportTrace() serialization error</td>
<td>Check for circular references or non-serializable data</td>
</tr>
<tr>
<td><code>MEMORY_EXCEEDED</code></td>
<td>Trace buffer consuming too much memory</td>
<td>Reduce maxBuffer or use lower sampleRate</td>
</tr>
</tbody>
</table>
<h4 data-number="21.1.5.2" id="error-handling"><span
class="header-section-number">21.1.5.2</span> Error Handling</h4>
<div class="sourceCode" id="cb272"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanDebugManager } <span class="im">from</span> <span class="st">&#39;./pan-debug.mjs&#39;</span><span class="op">;</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> debug <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanDebugManager</span>()<span class="op">;</span></span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe initialization with error handling</span></span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">initializeDebugger</span>(options <span class="op">=</span> {}) {</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate sample rate</span></span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sampleRate <span class="op">=</span> options<span class="op">.</span><span class="at">sampleRate</span> <span class="op">??</span> <span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sampleRate <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> sampleRate <span class="op">&gt;</span> <span class="fl">1.0</span>) {</span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;INVALID_SAMPLE_RATE: Sample rate must be between 0.0 and 1.0&#39;</span>)<span class="op">;</span></span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable tracing with validated options</span></span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>    debug<span class="op">.</span><span class="fu">enableTracing</span>({</span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">maxBuffer</span><span class="op">:</span> options<span class="op">.</span><span class="at">maxBuffer</span> <span class="op">||</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sampleRate</span><span class="op">:</span> sampleRate</span>
<span id="cb272-18"><a href="#cb272-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb272-19"><a href="#cb272-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-20"><a href="#cb272-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Debug tracing enabled&#39;</span>)<span class="op">;</span></span>
<span id="cb272-21"><a href="#cb272-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb272-22"><a href="#cb272-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Debug initialization failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-23"><a href="#cb272-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fallback to minimal tracing</span></span>
<span id="cb272-24"><a href="#cb272-24" aria-hidden="true" tabindex="-1"></a>    debug<span class="op">.</span><span class="fu">enableTracing</span>({ <span class="dt">maxBuffer</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">sampleRate</span><span class="op">:</span> <span class="fl">0.01</span> })<span class="op">;</span></span>
<span id="cb272-25"><a href="#cb272-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-26"><a href="#cb272-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb272-27"><a href="#cb272-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-28"><a href="#cb272-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe query with error handling</span></span>
<span id="cb272-29"><a href="#cb272-29" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safeQuery</span>(queryOptions) {</span>
<span id="cb272-30"><a href="#cb272-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb272-31"><a href="#cb272-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate time range</span></span>
<span id="cb272-32"><a href="#cb272-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (queryOptions<span class="op">.</span><span class="at">timeRange</span>) {</span>
<span id="cb272-33"><a href="#cb272-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { start<span class="op">,</span> end } <span class="op">=</span> queryOptions<span class="op">.</span><span class="at">timeRange</span><span class="op">;</span></span>
<span id="cb272-34"><a href="#cb272-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (start <span class="op">&amp;&amp;</span> end <span class="op">&amp;&amp;</span> start <span class="op">&gt;</span> end) {</span>
<span id="cb272-35"><a href="#cb272-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;QUERY_FAILED: Invalid time range (start &gt; end)&#39;</span>)<span class="op">;</span></span>
<span id="cb272-36"><a href="#cb272-36" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb272-37"><a href="#cb272-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb272-38"><a href="#cb272-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-39"><a href="#cb272-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> results <span class="op">=</span> debug<span class="op">.</span><span class="fu">findMessages</span>(queryOptions)<span class="op">;</span></span>
<span id="cb272-40"><a href="#cb272-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results<span class="op">;</span></span>
<span id="cb272-41"><a href="#cb272-41" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb272-42"><a href="#cb272-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Query failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-43"><a href="#cb272-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> []<span class="op">;</span></span>
<span id="cb272-44"><a href="#cb272-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-45"><a href="#cb272-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb272-46"><a href="#cb272-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-47"><a href="#cb272-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe export with size checking</span></span>
<span id="cb272-48"><a href="#cb272-48" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safeExport</span>(format <span class="op">=</span> <span class="st">&#39;json&#39;</span>) {</span>
<span id="cb272-49"><a href="#cb272-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb272-50"><a href="#cb272-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stats <span class="op">=</span> debug<span class="op">.</span><span class="fu">getStats</span>()<span class="op">;</span></span>
<span id="cb272-51"><a href="#cb272-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb272-52"><a href="#cb272-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check buffer size before export</span></span>
<span id="cb272-53"><a href="#cb272-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (stats<span class="op">.</span><span class="at">tracedMessages</span> <span class="op">&gt;</span> <span class="dv">10000</span>) {</span>
<span id="cb272-54"><a href="#cb272-54" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Large trace buffer, export may be slow&#39;</span>)<span class="op">;</span></span>
<span id="cb272-55"><a href="#cb272-55" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Optionally export in chunks</span></span>
<span id="cb272-56"><a href="#cb272-56" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> chunkSize <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb272-57"><a href="#cb272-57" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> chunks <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb272-58"><a href="#cb272-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> stats<span class="op">.</span><span class="at">tracedMessages</span><span class="op">;</span> i <span class="op">+=</span> chunkSize) {</span>
<span id="cb272-59"><a href="#cb272-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> chunk <span class="op">=</span> debug<span class="op">.</span><span class="fu">getTrace</span>({ <span class="dt">limit</span><span class="op">:</span> chunkSize<span class="op">,</span> <span class="dt">offset</span><span class="op">:</span> i })<span class="op">;</span></span>
<span id="cb272-60"><a href="#cb272-60" aria-hidden="true" tabindex="-1"></a>        chunks<span class="op">.</span><span class="fu">push</span>(chunk)<span class="op">;</span></span>
<span id="cb272-61"><a href="#cb272-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb272-62"><a href="#cb272-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> chunks<span class="op">;</span></span>
<span id="cb272-63"><a href="#cb272-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb272-64"><a href="#cb272-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-65"><a href="#cb272-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> exportData <span class="op">=</span> debug<span class="op">.</span><span class="fu">exportTrace</span>(format)<span class="op">;</span></span>
<span id="cb272-66"><a href="#cb272-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> exportData<span class="op">;</span></span>
<span id="cb272-67"><a href="#cb272-67" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb272-68"><a href="#cb272-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Export failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-69"><a href="#cb272-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return minimal diagnostic data</span></span>
<span id="cb272-70"><a href="#cb272-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">error</span><span class="op">:</span> err<span class="op">.</span><span class="at">message</span><span class="op">,</span> <span class="dt">stats</span><span class="op">:</span> debug<span class="op">.</span><span class="fu">getStats</span>() }<span class="op">;</span></span>
<span id="cb272-71"><a href="#cb272-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-72"><a href="#cb272-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb272-73"><a href="#cb272-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-74"><a href="#cb272-74" aria-hidden="true" tabindex="-1"></a><span class="co">// Memory monitoring</span></span>
<span id="cb272-75"><a href="#cb272-75" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">monitorMemory</span>() {</span>
<span id="cb272-76"><a href="#cb272-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stats <span class="op">=</span> debug<span class="op">.</span><span class="fu">getStats</span>()<span class="op">;</span></span>
<span id="cb272-77"><a href="#cb272-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> estimatedSize <span class="op">=</span> stats<span class="op">.</span><span class="at">bufferSize</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// ~1KB per message</span></span>
<span id="cb272-78"><a href="#cb272-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-79"><a href="#cb272-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (estimatedSize <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>) { <span class="co">// 10MB threshold</span></span>
<span id="cb272-80"><a href="#cb272-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;MEMORY_EXCEEDED: Trace buffer exceeding 10MB&#39;</span>)<span class="op">;</span></span>
<span id="cb272-81"><a href="#cb272-81" aria-hidden="true" tabindex="-1"></a>    debug<span class="op">.</span><span class="fu">clearTrace</span>()<span class="op">;</span></span>
<span id="cb272-82"><a href="#cb272-82" aria-hidden="true" tabindex="-1"></a>    debug<span class="op">.</span><span class="fu">setSampleRate</span>(<span class="fl">0.1</span>)<span class="op">;</span> <span class="co">// Reduce to 10%</span></span>
<span id="cb272-83"><a href="#cb272-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-84"><a href="#cb272-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb272-85"><a href="#cb272-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-86"><a href="#cb272-86" aria-hidden="true" tabindex="-1"></a><span class="co">// Periodic memory check</span></span>
<span id="cb272-87"><a href="#cb272-87" aria-hidden="true" tabindex="-1"></a><span class="pp">setInterval</span>(monitorMemory<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb272-88"><a href="#cb272-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-89"><a href="#cb272-89" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Safe debug UI with error boundaries</span></span>
<span id="cb272-90"><a href="#cb272-90" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">buildRobustDebugPanel</span>() {</span>
<span id="cb272-91"><a href="#cb272-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb272-92"><a href="#cb272-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initializeDebugger</span>({ <span class="dt">maxBuffer</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> <span class="dt">sampleRate</span><span class="op">:</span> <span class="fl">0.1</span> })<span class="op">;</span></span>
<span id="cb272-93"><a href="#cb272-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-94"><a href="#cb272-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> panel <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb272-95"><a href="#cb272-95" aria-hidden="true" tabindex="-1"></a>    panel<span class="op">.</span><span class="at">id</span> <span class="op">=</span> <span class="st">&#39;debug-panel&#39;</span><span class="op">;</span></span>
<span id="cb272-96"><a href="#cb272-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-97"><a href="#cb272-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> refresh <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb272-98"><a href="#cb272-98" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb272-99"><a href="#cb272-99" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> messages <span class="op">=</span> <span class="fu">safeQuery</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span> })<span class="op">;</span></span>
<span id="cb272-100"><a href="#cb272-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> stats <span class="op">=</span> debug<span class="op">.</span><span class="fu">getStats</span>()<span class="op">;</span></span>
<span id="cb272-101"><a href="#cb272-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-102"><a href="#cb272-102" aria-hidden="true" tabindex="-1"></a>        panel<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb272-103"><a href="#cb272-103" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;PAN Debug (</span><span class="sc">${</span>stats<span class="op">.</span><span class="at">totalMessages</span><span class="sc">}</span><span class="vs"> total, </span><span class="sc">${</span>stats<span class="op">.</span><span class="at">droppedMessages</span><span class="sc">}</span><span class="vs"> dropped)&lt;/h3&gt;</span></span>
<span id="cb272-104"><a href="#cb272-104" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;Buffer: </span><span class="sc">${</span>stats<span class="op">.</span><span class="at">tracedMessages</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span>stats<span class="op">.</span><span class="at">bufferSize</span><span class="sc">}</span><span class="vs"> | Rate: </span><span class="sc">${</span>stats<span class="op">.</span><span class="at">sampleRate</span> <span class="op">*</span> <span class="dv">100</span><span class="sc">}</span><span class="vs">%&lt;/p&gt;</span></span>
<span id="cb272-105"><a href="#cb272-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;clearDebugTrace()&quot;&gt;Clear&lt;/button&gt;</span></span>
<span id="cb272-106"><a href="#cb272-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;exportDebugTrace()&quot;&gt;Export&lt;/button&gt;</span></span>
<span id="cb272-107"><a href="#cb272-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>stats<span class="op">.</span><span class="at">droppedMessages</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;&lt;span style=&quot;color:red;&quot;&gt;⚠ Messages dropped&lt;/span&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb272-108"><a href="#cb272-108" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;hr&gt;</span></span>
<span id="cb272-109"><a href="#cb272-109" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>messages<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;&lt;p&gt;No messages traced&lt;/p&gt;&#39;</span> <span class="op">:</span> </span>
<span id="cb272-110"><a href="#cb272-110" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">.</span><span class="fu">map</span>(msg <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb272-111"><a href="#cb272-111" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div style=&quot;margin: 5px 0; padding: 5px; border: 1px solid #ddd;&quot;&gt;</span></span>
<span id="cb272-112"><a href="#cb272-112" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;strong&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">&lt;/strong&gt;</span></span>
<span id="cb272-113"><a href="#cb272-113" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;small&gt;</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(msg<span class="op">.</span><span class="at">timestamp</span>)<span class="op">.</span><span class="fu">toLocaleTimeString</span>()<span class="sc">}</span><span class="vs">&lt;/small&gt;</span></span>
<span id="cb272-114"><a href="#cb272-114" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;pre&gt;</span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">.</span><span class="fu">substring</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">200</span>)<span class="sc">}</span><span class="vs">&lt;/pre&gt;</span></span>
<span id="cb272-115"><a href="#cb272-115" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/div&gt;</span></span>
<span id="cb272-116"><a href="#cb272-116" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb272-117"><a href="#cb272-117" aria-hidden="true" tabindex="-1"></a>          <span class="sc">}</span></span>
<span id="cb272-118"><a href="#cb272-118" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb272-119"><a href="#cb272-119" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (err) {</span>
<span id="cb272-120"><a href="#cb272-120" aria-hidden="true" tabindex="-1"></a>        panel<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;p style=&quot;color:red;&quot;&gt;Error: </span><span class="sc">${</span>err<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/p&gt;`</span><span class="op">;</span></span>
<span id="cb272-121"><a href="#cb272-121" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb272-122"><a href="#cb272-122" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb272-123"><a href="#cb272-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-124"><a href="#cb272-124" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setInterval</span>(refresh<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb272-125"><a href="#cb272-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb272-126"><a href="#cb272-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(panel)<span class="op">;</span></span>
<span id="cb272-127"><a href="#cb272-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-128"><a href="#cb272-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global safe controls</span></span>
<span id="cb272-129"><a href="#cb272-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">clearDebugTrace</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb272-130"><a href="#cb272-130" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb272-131"><a href="#cb272-131" aria-hidden="true" tabindex="-1"></a>        debug<span class="op">.</span><span class="fu">clearTrace</span>()<span class="op">;</span></span>
<span id="cb272-132"><a href="#cb272-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb272-133"><a href="#cb272-133" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (err) {</span>
<span id="cb272-134"><a href="#cb272-134" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Clear failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-135"><a href="#cb272-135" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb272-136"><a href="#cb272-136" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb272-137"><a href="#cb272-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-138"><a href="#cb272-138" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">exportDebugTrace</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb272-139"><a href="#cb272-139" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb272-140"><a href="#cb272-140" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="fu">safeExport</span>()<span class="op">;</span></span>
<span id="cb272-141"><a href="#cb272-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Exported trace:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb272-142"><a href="#cb272-142" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Optionally download as file</span></span>
<span id="cb272-143"><a href="#cb272-143" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> blob <span class="op">=</span> <span class="kw">new</span> <span class="bu">Blob</span>([<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)]<span class="op">,</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> })<span class="op">;</span></span>
<span id="cb272-144"><a href="#cb272-144" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> url <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob)<span class="op">;</span></span>
<span id="cb272-145"><a href="#cb272-145" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)<span class="op">;</span></span>
<span id="cb272-146"><a href="#cb272-146" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb272-147"><a href="#cb272-147" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="vs">`pan-trace-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">.json`</span><span class="op">;</span></span>
<span id="cb272-148"><a href="#cb272-148" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb272-149"><a href="#cb272-149" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (err) {</span>
<span id="cb272-150"><a href="#cb272-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Export failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-151"><a href="#cb272-151" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb272-152"><a href="#cb272-152" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb272-153"><a href="#cb272-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-154"><a href="#cb272-154" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb272-155"><a href="#cb272-155" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Debug panel initialization failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb272-156"><a href="#cb272-156" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-157"><a href="#cb272-157" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 data-number="21.1.5.3" id="exceptions-thrown"><span
class="header-section-number">21.1.5.3</span> Exceptions Thrown</h4>
<ul>
<li><strong>TypeError</strong>: Invalid parameter types (e.g.,
non-numeric sample rate)</li>
<li><strong>Error</strong>: General tracing errors (buffer overflow,
query failures, export errors)</li>
</ul>
<h4 data-number="21.1.5.4" id="performance-considerations-1"><span
class="header-section-number">21.1.5.4</span> Performance
Considerations</h4>
<ul>
<li>Large buffers (&gt;1000 messages) increase memory usage
significantly</li>
<li>High sample rates (&gt;0.1) can impact application performance</li>
<li>Export operations on large traces (&gt;5000 messages) may block UI
thread</li>
<li>Consider Web Workers for large export operations in production</li>
</ul>
<h3 data-number="21.1.6" id="common-issues-27"><span
class="header-section-number">21.1.6</span> Common Issues</h3>
<p><strong>High memory usage</strong>: Reduce <code>maxBuffer</code> or
<code>sampleRate</code>. For production, use
<code>sampleRate: 0.01</code> (1%).</p>
<p><strong>Messages not appearing</strong>: Ensure tracing enabled and
sampling rate &gt; 0.</p>
<p><strong>Performance impact</strong>: Tracing adds overhead. Use
sampling (0.01-0.1) in production, or disable entirely.</p>
<hr />
<h2 data-number="21.2" id="pan-forwarder"><span
class="header-section-number">21.2</span> pan-forwarder</h2>
<p><strong>Purpose</strong>: Forward PAN messages to HTTP
endpoints<br />
<strong>Import</strong>: <code>&lt;pan-forwarder&gt;</code> custom
element</p>
<h3 data-number="21.2.1" id="quick-example-27"><span
class="header-section-number">21.2.1</span> Quick Example</h3>
<div class="sourceCode" id="cb273"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-forwarder</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  url</span><span class="op">=</span><span class="st">&quot;https://api.example.com/events&quot;</span></span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  topics</span><span class="op">=</span><span class="st">&quot;user.login,user.logout,error.*&quot;</span></span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  debounce</span><span class="op">=</span><span class="st">&quot;500&quot;</span><span class="dt">&gt;</span></span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-forwarder</span><span class="dt">&gt;</span></span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Messages matching topics are automatically forwarded</span></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a><span class="co">// No additional code needed</span></span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="21.2.2" id="attributes-10"><span
class="header-section-number">21.2.2</span> Attributes</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>url</code></td>
<td>String</td>
<td>“”</td>
<td>HTTP endpoint URL</td>
</tr>
<tr>
<td><code>topics</code></td>
<td>String</td>
<td>“*”</td>
<td>Comma-separated topic patterns</td>
</tr>
<tr>
<td><code>method</code></td>
<td>String</td>
<td>“POST”</td>
<td>HTTP method</td>
</tr>
<tr>
<td><code>debounce</code></td>
<td>Number</td>
<td>0</td>
<td>Debounce delay (ms)</td>
</tr>
<tr>
<td><code>batch-size</code></td>
<td>Number</td>
<td>1</td>
<td>Batch multiple messages</td>
</tr>
<tr>
<td><code>batch-timeout</code></td>
<td>Number</td>
<td>1000</td>
<td>Max batch wait time (ms)</td>
</tr>
<tr>
<td><code>credentials</code></td>
<td>String</td>
<td>“”</td>
<td>Fetch credentials mode</td>
</tr>
<tr>
<td><code>deduplicate</code></td>
<td>Boolean</td>
<td>false</td>
<td>Skip duplicate messages</td>
</tr>
</tbody>
</table>
<h3 data-number="21.2.3" id="headers-configuration"><span
class="header-section-number">21.2.3</span> Headers Configuration</h3>
<p>Configure headers via embedded JSON script:</p>
<div class="sourceCode" id="cb274"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-forwarder</span><span class="ot"> url</span><span class="op">=</span><span class="st">&quot;/api/events&quot;</span><span class="ot"> topics</span><span class="op">=</span><span class="st">&quot;user.*&quot;</span><span class="dt">&gt;</span></span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;headers&quot;</span><span class="op">:</span> {</span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Authorization&quot;</span><span class="op">:</span> <span class="st">&quot;Bearer TOKEN&quot;</span><span class="op">,</span></span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;X-App-Version&quot;</span><span class="op">:</span> <span class="st">&quot;1.0.0&quot;</span></span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb274-9"><a href="#cb274-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb274-10"><a href="#cb274-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-forwarder</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="21.2.4" id="request-format"><span
class="header-section-number">21.2.4</span> Request Format</h3>
<p><strong>Single message:</strong></p>
<div class="sourceCode" id="cb275"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;topic&quot;</span><span class="fu">:</span> <span class="st">&quot;user.login&quot;</span><span class="fu">,</span></span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;userId&quot;</span><span class="fu">:</span> <span class="dv">123</span> <span class="fu">},</span></span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="dv">1640000000000</span><span class="fu">,</span></span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;msg-abc123&quot;</span></span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Batched messages:</strong></p>
<div class="sourceCode" id="cb276"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;messages&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;topic&quot;</span><span class="fu">:</span> <span class="st">&quot;user.login&quot;</span><span class="fu">,</span> <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="er">...</span><span class="fu">},</span> <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="dv">1640000000000</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;topic&quot;</span><span class="fu">:</span> <span class="st">&quot;user.action&quot;</span><span class="fu">,</span> <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="er">...</span><span class="fu">},</span> <span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="dv">1640000001000</span> <span class="fu">}</span></span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;batchSize&quot;</span><span class="fu">:</span> <span class="dv">2</span></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="21.2.5" id="complete-example-19"><span
class="header-section-number">21.2.5</span> Complete Example</h3>
<div class="sourceCode" id="cb277"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-bus.mjs&#39;</span><span class="op">;</span></span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;./pan-forwarder.mjs&#39;</span><span class="op">;</span></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>    customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Application publishes messages normally</span></span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;login-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> {</span>
<span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb277-16"><a href="#cb277-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb277-17"><a href="#cb277-17" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb277-18"><a href="#cb277-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Message automatically forwarded to server</span></span>
<span id="cb277-19"><a href="#cb277-19" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb277-20"><a href="#cb277-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-21"><a href="#cb277-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Track forwarding status</span></span>
<span id="cb277-22"><a href="#cb277-22" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.success&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb277-23"><a href="#cb277-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Forwarded:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">topic</span>)<span class="op">;</span></span>
<span id="cb277-24"><a href="#cb277-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb277-25"><a href="#cb277-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-26"><a href="#cb277-26" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb277-27"><a href="#cb277-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Forward failed:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb277-28"><a href="#cb277-28" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb277-29"><a href="#cb277-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb277-30"><a href="#cb277-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb277-31"><a href="#cb277-31" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb277-32"><a href="#cb277-32" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb277-33"><a href="#cb277-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb277-34"><a href="#cb277-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb277-35"><a href="#cb277-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Forward user events to analytics server --&gt;</span></span>
<span id="cb277-36"><a href="#cb277-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-forwarder</span></span>
<span id="cb277-37"><a href="#cb277-37" aria-hidden="true" tabindex="-1"></a><span class="ot">    url</span><span class="op">=</span><span class="st">&quot;https://analytics.example.com/events&quot;</span></span>
<span id="cb277-38"><a href="#cb277-38" aria-hidden="true" tabindex="-1"></a><span class="ot">    topics</span><span class="op">=</span><span class="st">&quot;user.login,user.logout,user.action&quot;</span></span>
<span id="cb277-39"><a href="#cb277-39" aria-hidden="true" tabindex="-1"></a><span class="ot">    method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span></span>
<span id="cb277-40"><a href="#cb277-40" aria-hidden="true" tabindex="-1"></a><span class="ot">    debounce</span><span class="op">=</span><span class="st">&quot;1000&quot;</span></span>
<span id="cb277-41"><a href="#cb277-41" aria-hidden="true" tabindex="-1"></a><span class="ot">    batch-size</span><span class="op">=</span><span class="st">&quot;10&quot;</span></span>
<span id="cb277-42"><a href="#cb277-42" aria-hidden="true" tabindex="-1"></a><span class="ot">    batch-timeout</span><span class="op">=</span><span class="st">&quot;5000&quot;</span><span class="dt">&gt;</span></span>
<span id="cb277-43"><a href="#cb277-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb277-44"><a href="#cb277-44" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb277-45"><a href="#cb277-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;headers&quot;</span><span class="op">:</span> {</span>
<span id="cb277-46"><a href="#cb277-46" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Authorization&quot;</span><span class="op">:</span> <span class="st">&quot;Bearer analytics-token&quot;</span><span class="op">,</span></span>
<span id="cb277-47"><a href="#cb277-47" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span></span>
<span id="cb277-48"><a href="#cb277-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb277-49"><a href="#cb277-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb277-50"><a href="#cb277-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb277-51"><a href="#cb277-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-forwarder</span><span class="dt">&gt;</span></span>
<span id="cb277-52"><a href="#cb277-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-53"><a href="#cb277-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Forward errors to monitoring service --&gt;</span></span>
<span id="cb277-54"><a href="#cb277-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-forwarder</span></span>
<span id="cb277-55"><a href="#cb277-55" aria-hidden="true" tabindex="-1"></a><span class="ot">    url</span><span class="op">=</span><span class="st">&quot;https://monitoring.example.com/errors&quot;</span></span>
<span id="cb277-56"><a href="#cb277-56" aria-hidden="true" tabindex="-1"></a><span class="ot">    topics</span><span class="op">=</span><span class="st">&quot;error.*,*.error&quot;</span></span>
<span id="cb277-57"><a href="#cb277-57" aria-hidden="true" tabindex="-1"></a><span class="ot">    method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span></span>
<span id="cb277-58"><a href="#cb277-58" aria-hidden="true" tabindex="-1"></a><span class="ot">    credentials</span><span class="op">=</span><span class="st">&quot;include&quot;</span><span class="dt">&gt;</span></span>
<span id="cb277-59"><a href="#cb277-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb277-60"><a href="#cb277-60" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb277-61"><a href="#cb277-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;headers&quot;</span><span class="op">:</span> {</span>
<span id="cb277-62"><a href="#cb277-62" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;X-Service&quot;</span><span class="op">:</span> <span class="st">&quot;my-app&quot;</span><span class="op">,</span></span>
<span id="cb277-63"><a href="#cb277-63" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;X-Environment&quot;</span><span class="op">:</span> <span class="st">&quot;production&quot;</span></span>
<span id="cb277-64"><a href="#cb277-64" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb277-65"><a href="#cb277-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb277-66"><a href="#cb277-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb277-67"><a href="#cb277-67" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-forwarder</span><span class="dt">&gt;</span></span>
<span id="cb277-68"><a href="#cb277-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-69"><a href="#cb277-69" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;login-btn&quot;</span><span class="dt">&gt;</span>Login (forwards to server)<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb277-70"><a href="#cb277-70" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb277-71"><a href="#cb277-71" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="21.2.6" id="server-side-example"><span
class="header-section-number">21.2.6</span> Server-Side Example</h3>
<p><strong>Node.js/Express:</strong></p>
<div class="sourceCode" id="cb278"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/events&#39;</span><span class="op">,</span> express<span class="op">.</span><span class="fu">json</span>()<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { topic<span class="op">,</span> data<span class="op">,</span> timestamp } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Received: </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Process event</span></span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (topic <span class="op">===</span> <span class="st">&#39;user.login&#39;</span>) {</span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>    analytics<span class="op">.</span><span class="fu">track</span>(<span class="st">&#39;login&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">success</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb278-13"><a href="#cb278-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-14"><a href="#cb278-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Batched messages</span></span>
<span id="cb278-15"><a href="#cb278-15" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/events/batch&#39;</span><span class="op">,</span> express<span class="op">.</span><span class="fu">json</span>()<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb278-16"><a href="#cb278-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { messages } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb278-17"><a href="#cb278-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-18"><a href="#cb278-18" aria-hidden="true" tabindex="-1"></a>  messages<span class="op">.</span><span class="fu">forEach</span>(msg <span class="kw">=&gt;</span> {</span>
<span id="cb278-19"><a href="#cb278-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Received: </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb278-20"><a href="#cb278-20" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb278-21"><a href="#cb278-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb278-22"><a href="#cb278-22" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>({ <span class="dt">success</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">processed</span><span class="op">:</span> messages<span class="op">.</span><span class="at">length</span> })<span class="op">;</span></span>
<span id="cb278-23"><a href="#cb278-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="21.2.7" id="pan-events-3"><span
class="header-section-number">21.2.7</span> PAN Events</h3>
<h4 data-number="21.2.7.1" id="published-4"><span
class="header-section-number">21.2.7.1</span> Published</h4>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Data</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>forwarder.success</code></td>
<td><code>{ topic, url, status }</code></td>
<td>Message forwarded successfully</td>
</tr>
<tr>
<td><code>forwarder.error</code></td>
<td><code>{ topic, url, error, status }</code></td>
<td>Forward failed</td>
</tr>
</tbody>
</table>
<h3 data-number="21.2.8" id="errors-14"><span
class="header-section-number">21.2.8</span> Errors</h3>
<p>pan-forwarder can encounter various error conditions when forwarding
messages to HTTP endpoints. All errors are published as PAN messages on
the <code>forwarder.error</code> topic.</p>
<h4 data-number="21.2.8.1" id="error-conditions-1"><span
class="header-section-number">21.2.8.1</span> Error Conditions</h4>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 28%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr>
<th>Code</th>
<th>Cause</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NETWORK_ERROR</code></td>
<td>Network connection failed</td>
<td>Check internet connectivity, verify URL is reachable</td>
</tr>
<tr>
<td><code>HTTP_ERROR</code></td>
<td>Server returned error status (4xx, 5xx)</td>
<td>Check server logs, verify authentication, check endpoint exists</td>
</tr>
<tr>
<td><code>BATCH_TIMEOUT</code></td>
<td>Batch timeout exceeded before filling</td>
<td>Reduce batch-timeout or batch-size for low-volume scenarios</td>
</tr>
<tr>
<td><code>TOPIC_MISMATCH</code></td>
<td>No topics matched messages</td>
<td>Verify topic patterns, use “*” to match all messages</td>
</tr>
<tr>
<td><code>PARSE_ERROR</code></td>
<td>Response body parsing failed</td>
<td>Check server returns valid JSON, verify Content-Type header</td>
</tr>
<tr>
<td><code>CORS_ERROR</code></td>
<td>Cross-origin request blocked</td>
<td>Configure CORS headers on server, check credentials mode</td>
</tr>
<tr>
<td><code>INVALID_CONFIG</code></td>
<td>Malformed configuration JSON</td>
<td>Validate JSON syntax in embedded script tag</td>
</tr>
</tbody>
</table>
<h4 data-number="21.2.8.2" id="error-handling-1"><span
class="header-section-number">21.2.8.2</span> Error Handling</h4>
<div class="sourceCode" id="cb279"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PanClient } <span class="im">from</span> <span class="st">&#39;./pan-client.mjs&#39;</span><span class="op">;</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pc <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Monitor forwarding errors</span></span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { topic<span class="op">,</span> url<span class="op">,</span> error<span class="op">,</span> status<span class="op">,</span> response } <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Forward failed [</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">]:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle different error scenarios</span></span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (<span class="kw">true</span>) {</span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;NETWORK_ERROR&#39;</span>)<span class="op">:</span></span>
<span id="cb279-13"><a href="#cb279-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">handleNetworkError</span>(topic<span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">originalMessage</span>)<span class="op">;</span></span>
<span id="cb279-14"><a href="#cb279-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb279-15"><a href="#cb279-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-16"><a href="#cb279-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">===</span> <span class="dv">401</span><span class="op">:</span></span>
<span id="cb279-17"><a href="#cb279-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Authentication required&#39;</span>)<span class="op">;</span></span>
<span id="cb279-18"><a href="#cb279-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">refreshAuthToken</span>()<span class="op">;</span></span>
<span id="cb279-19"><a href="#cb279-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb279-20"><a href="#cb279-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-21"><a href="#cb279-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">===</span> <span class="dv">429</span><span class="op">:</span></span>
<span id="cb279-22"><a href="#cb279-22" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Rate limited, backing off&#39;</span>)<span class="op">;</span></span>
<span id="cb279-23"><a href="#cb279-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">increaseDebounce</span>()<span class="op">;</span></span>
<span id="cb279-24"><a href="#cb279-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb279-25"><a href="#cb279-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-26"><a href="#cb279-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> status <span class="op">&gt;=</span> <span class="dv">500</span><span class="op">:</span></span>
<span id="cb279-27"><a href="#cb279-27" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Server error, will retry&#39;</span>)<span class="op">;</span></span>
<span id="cb279-28"><a href="#cb279-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">queueForRetry</span>(topic<span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">originalMessage</span>)<span class="op">;</span></span>
<span id="cb279-29"><a href="#cb279-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb279-30"><a href="#cb279-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-31"><a href="#cb279-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> error<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;CORS_ERROR&#39;</span>)<span class="op">:</span></span>
<span id="cb279-32"><a href="#cb279-32" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;CORS configuration issue on server&#39;</span>)<span class="op">;</span></span>
<span id="cb279-33"><a href="#cb279-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">showCorsWarning</span>()<span class="op">;</span></span>
<span id="cb279-34"><a href="#cb279-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb279-35"><a href="#cb279-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-36"><a href="#cb279-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span><span class="op">:</span></span>
<span id="cb279-37"><a href="#cb279-37" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Unhandled forward error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb279-38"><a href="#cb279-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">logToErrorTracking</span>({ topic<span class="op">,</span> error<span class="op">,</span> status })<span class="op">;</span></span>
<span id="cb279-39"><a href="#cb279-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-40"><a href="#cb279-40" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb279-41"><a href="#cb279-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-42"><a href="#cb279-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Track successful forwards</span></span>
<span id="cb279-43"><a href="#cb279-43" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> forwardCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-44"><a href="#cb279-44" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.success&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb279-45"><a href="#cb279-45" aria-hidden="true" tabindex="-1"></a>  forwardCount<span class="op">++;</span></span>
<span id="cb279-46"><a href="#cb279-46" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Forwarded </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs"> (total: </span><span class="sc">${</span>forwardCount<span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb279-47"><a href="#cb279-47" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb279-48"><a href="#cb279-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-49"><a href="#cb279-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Network error handling with offline queue</span></span>
<span id="cb279-50"><a href="#cb279-50" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> offlineQueue <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb279-51"><a href="#cb279-51" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> isOnline <span class="op">=</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span><span class="op">;</span></span>
<span id="cb279-52"><a href="#cb279-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-53"><a href="#cb279-53" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">handleNetworkError</span>(topic<span class="op">,</span> originalMessage) {</span>
<span id="cb279-54"><a href="#cb279-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>isOnline) {</span>
<span id="cb279-55"><a href="#cb279-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Queueing message for offline:&#39;</span><span class="op">,</span> topic)<span class="op">;</span></span>
<span id="cb279-56"><a href="#cb279-56" aria-hidden="true" tabindex="-1"></a>    offlineQueue<span class="op">.</span><span class="fu">push</span>({ topic<span class="op">,</span> <span class="dt">data</span><span class="op">:</span> originalMessage })<span class="op">;</span></span>
<span id="cb279-57"><a href="#cb279-57" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;forwarder_queue&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(offlineQueue))<span class="op">;</span></span>
<span id="cb279-58"><a href="#cb279-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-59"><a href="#cb279-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-60"><a href="#cb279-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-61"><a href="#cb279-61" aria-hidden="true" tabindex="-1"></a><span class="co">// Restore queue when online</span></span>
<span id="cb279-62"><a href="#cb279-62" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;online&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb279-63"><a href="#cb279-63" aria-hidden="true" tabindex="-1"></a>  isOnline <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb279-64"><a href="#cb279-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> saved <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;forwarder_queue&#39;</span>)<span class="op">;</span></span>
<span id="cb279-65"><a href="#cb279-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (saved) {</span>
<span id="cb279-66"><a href="#cb279-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> queue <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(saved)<span class="op">;</span></span>
<span id="cb279-67"><a href="#cb279-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Replaying </span><span class="sc">${</span>queue<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> queued messages`</span>)<span class="op">;</span></span>
<span id="cb279-68"><a href="#cb279-68" aria-hidden="true" tabindex="-1"></a>    queue<span class="op">.</span><span class="fu">forEach</span>(({ topic<span class="op">,</span> data }) <span class="kw">=&gt;</span> {</span>
<span id="cb279-69"><a href="#cb279-69" aria-hidden="true" tabindex="-1"></a>      pc<span class="op">.</span><span class="fu">publish</span>(topic<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb279-70"><a href="#cb279-70" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb279-71"><a href="#cb279-71" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="st">&#39;forwarder_queue&#39;</span>)<span class="op">;</span></span>
<span id="cb279-72"><a href="#cb279-72" aria-hidden="true" tabindex="-1"></a>    offlineQueue<span class="op">.</span><span class="at">length</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-73"><a href="#cb279-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-74"><a href="#cb279-74" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb279-75"><a href="#cb279-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-76"><a href="#cb279-76" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;offline&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb279-77"><a href="#cb279-77" aria-hidden="true" tabindex="-1"></a>  isOnline <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb279-78"><a href="#cb279-78" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Network offline, queueing messages&#39;</span>)<span class="op">;</span></span>
<span id="cb279-79"><a href="#cb279-79" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb279-80"><a href="#cb279-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-81"><a href="#cb279-81" aria-hidden="true" tabindex="-1"></a><span class="co">// Retry logic with exponential backoff</span></span>
<span id="cb279-82"><a href="#cb279-82" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> retryQueue <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb279-83"><a href="#cb279-83" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> retryTimer <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb279-84"><a href="#cb279-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-85"><a href="#cb279-85" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">queueForRetry</span>(topic<span class="op">,</span> message<span class="op">,</span> retries <span class="op">=</span> <span class="dv">0</span>) {</span>
<span id="cb279-86"><a href="#cb279-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (retries <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb279-87"><a href="#cb279-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Max retries exceeded for:&#39;</span><span class="op">,</span> topic)<span class="op">;</span></span>
<span id="cb279-88"><a href="#cb279-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logToErrorTracking</span>({ topic<span class="op">,</span> message<span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;max_retries_exceeded&#39;</span> })<span class="op">;</span></span>
<span id="cb279-89"><a href="#cb279-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb279-90"><a href="#cb279-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-91"><a href="#cb279-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-92"><a href="#cb279-92" aria-hidden="true" tabindex="-1"></a>  retryQueue<span class="op">.</span><span class="fu">push</span>({ topic<span class="op">,</span> message<span class="op">,</span> retries })<span class="op">;</span></span>
<span id="cb279-93"><a href="#cb279-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-94"><a href="#cb279-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>retryTimer) {</span>
<span id="cb279-95"><a href="#cb279-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> retries) <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 1s, 2s, 4s</span></span>
<span id="cb279-96"><a href="#cb279-96" aria-hidden="true" tabindex="-1"></a>    retryTimer <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb279-97"><a href="#cb279-97" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Retrying </span><span class="sc">${</span>retryQueue<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> messages...`</span>)<span class="op">;</span></span>
<span id="cb279-98"><a href="#cb279-98" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> batch <span class="op">=</span> [<span class="op">...</span>retryQueue]<span class="op">;</span></span>
<span id="cb279-99"><a href="#cb279-99" aria-hidden="true" tabindex="-1"></a>      retryQueue<span class="op">.</span><span class="at">length</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-100"><a href="#cb279-100" aria-hidden="true" tabindex="-1"></a>      retryTimer <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb279-101"><a href="#cb279-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-102"><a href="#cb279-102" aria-hidden="true" tabindex="-1"></a>      batch<span class="op">.</span><span class="fu">forEach</span>(({ topic<span class="op">,</span> message<span class="op">,</span> retries }) <span class="kw">=&gt;</span> {</span>
<span id="cb279-103"><a href="#cb279-103" aria-hidden="true" tabindex="-1"></a>        pc<span class="op">.</span><span class="fu">publish</span>(topic<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb279-104"><a href="#cb279-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Monitor if it fails again</span></span>
<span id="cb279-105"><a href="#cb279-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> unsubscribe <span class="op">=</span> pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.error&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb279-106"><a href="#cb279-106" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">topic</span> <span class="op">===</span> topic) {</span>
<span id="cb279-107"><a href="#cb279-107" aria-hidden="true" tabindex="-1"></a>            <span class="fu">queueForRetry</span>(topic<span class="op">,</span> message<span class="op">,</span> retries <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb279-108"><a href="#cb279-108" aria-hidden="true" tabindex="-1"></a>            <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb279-109"><a href="#cb279-109" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb279-110"><a href="#cb279-110" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb279-111"><a href="#cb279-111" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb279-112"><a href="#cb279-112" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb279-113"><a href="#cb279-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-114"><a href="#cb279-114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-115"><a href="#cb279-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-116"><a href="#cb279-116" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic debounce adjustment for rate limiting</span></span>
<span id="cb279-117"><a href="#cb279-117" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> currentDebounce <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-118"><a href="#cb279-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-119"><a href="#cb279-119" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">increaseDebounce</span>() {</span>
<span id="cb279-120"><a href="#cb279-120" aria-hidden="true" tabindex="-1"></a>  currentDebounce <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(currentDebounce <span class="op">+</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span> <span class="co">// Max 5s</span></span>
<span id="cb279-121"><a href="#cb279-121" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Increased debounce to </span><span class="sc">${</span>currentDebounce<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb279-122"><a href="#cb279-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb279-123"><a href="#cb279-123" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update forwarder element</span></span>
<span id="cb279-124"><a href="#cb279-124" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forwarder <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-forwarder&#39;</span>)<span class="op">;</span></span>
<span id="cb279-125"><a href="#cb279-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (forwarder) {</span>
<span id="cb279-126"><a href="#cb279-126" aria-hidden="true" tabindex="-1"></a>    forwarder<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;debounce&#39;</span><span class="op">,</span> currentDebounce)<span class="op">;</span></span>
<span id="cb279-127"><a href="#cb279-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-128"><a href="#cb279-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-129"><a href="#cb279-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-130"><a href="#cb279-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Reset debounce after successful forwards</span></span>
<span id="cb279-131"><a href="#cb279-131" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> successCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-132"><a href="#cb279-132" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.success&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb279-133"><a href="#cb279-133" aria-hidden="true" tabindex="-1"></a>  successCount<span class="op">++;</span></span>
<span id="cb279-134"><a href="#cb279-134" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (successCount <span class="op">&gt;=</span> <span class="dv">10</span> <span class="op">&amp;&amp;</span> currentDebounce <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb279-135"><a href="#cb279-135" aria-hidden="true" tabindex="-1"></a>    currentDebounce <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(currentDebounce <span class="op">-</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb279-136"><a href="#cb279-136" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Reduced debounce to </span><span class="sc">${</span>currentDebounce<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb279-137"><a href="#cb279-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> forwarder <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-forwarder&#39;</span>)<span class="op">;</span></span>
<span id="cb279-138"><a href="#cb279-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (forwarder) {</span>
<span id="cb279-139"><a href="#cb279-139" aria-hidden="true" tabindex="-1"></a>      forwarder<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;debounce&#39;</span><span class="op">,</span> currentDebounce)<span class="op">;</span></span>
<span id="cb279-140"><a href="#cb279-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb279-141"><a href="#cb279-141" aria-hidden="true" tabindex="-1"></a>    successCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-142"><a href="#cb279-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-143"><a href="#cb279-143" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb279-144"><a href="#cb279-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-145"><a href="#cb279-145" aria-hidden="true" tabindex="-1"></a><span class="co">// Authentication token refresh</span></span>
<span id="cb279-146"><a href="#cb279-146" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">refreshAuthToken</span>() {</span>
<span id="cb279-147"><a href="#cb279-147" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb279-148"><a href="#cb279-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/refresh-token&#39;</span><span class="op">,</span> {</span>
<span id="cb279-149"><a href="#cb279-149" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb279-150"><a href="#cb279-150" aria-hidden="true" tabindex="-1"></a>      <span class="dt">credentials</span><span class="op">:</span> <span class="st">&#39;include&#39;</span></span>
<span id="cb279-151"><a href="#cb279-151" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb279-152"><a href="#cb279-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb279-153"><a href="#cb279-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb279-154"><a href="#cb279-154" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { token } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb279-155"><a href="#cb279-155" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb279-156"><a href="#cb279-156" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update forwarder headers</span></span>
<span id="cb279-157"><a href="#cb279-157" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> forwarder <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-forwarder&#39;</span>)<span class="op">;</span></span>
<span id="cb279-158"><a href="#cb279-158" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> scriptTag <span class="op">=</span> forwarder<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;script[type=&quot;application/json&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb279-159"><a href="#cb279-159" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> config <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(scriptTag<span class="op">.</span><span class="at">textContent</span>)<span class="op">;</span></span>
<span id="cb279-160"><a href="#cb279-160" aria-hidden="true" tabindex="-1"></a>      config<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">Authorization</span> <span class="op">=</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb279-161"><a href="#cb279-161" aria-hidden="true" tabindex="-1"></a>      scriptTag<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(config<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb279-162"><a href="#cb279-162" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb279-163"><a href="#cb279-163" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Auth token refreshed&#39;</span>)<span class="op">;</span></span>
<span id="cb279-164"><a href="#cb279-164" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb279-165"><a href="#cb279-165" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Token refresh failed, redirecting to login&#39;</span>)<span class="op">;</span></span>
<span id="cb279-166"><a href="#cb279-166" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="st">&#39;/login&#39;</span><span class="op">;</span></span>
<span id="cb279-167"><a href="#cb279-167" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb279-168"><a href="#cb279-168" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb279-169"><a href="#cb279-169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Token refresh error:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb279-170"><a href="#cb279-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-171"><a href="#cb279-171" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-172"><a href="#cb279-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-173"><a href="#cb279-173" aria-hidden="true" tabindex="-1"></a><span class="co">// CORS warning display</span></span>
<span id="cb279-174"><a href="#cb279-174" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">showCorsWarning</span>() {</span>
<span id="cb279-175"><a href="#cb279-175" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> warning <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb279-176"><a href="#cb279-176" aria-hidden="true" tabindex="-1"></a>  warning<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">cssText</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb279-177"><a href="#cb279-177" aria-hidden="true" tabindex="-1"></a><span class="vs">    position: fixed; top: 20px; right: 20px; </span></span>
<span id="cb279-178"><a href="#cb279-178" aria-hidden="true" tabindex="-1"></a><span class="vs">    background: #ff9800; color: white; padding: 15px;</span></span>
<span id="cb279-179"><a href="#cb279-179" aria-hidden="true" tabindex="-1"></a><span class="vs">    border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);</span></span>
<span id="cb279-180"><a href="#cb279-180" aria-hidden="true" tabindex="-1"></a><span class="vs">    z-index: 10000;</span></span>
<span id="cb279-181"><a href="#cb279-181" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb279-182"><a href="#cb279-182" aria-hidden="true" tabindex="-1"></a>  warning<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb279-183"><a href="#cb279-183" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;strong&gt;⚠ CORS Error&lt;/strong&gt;&lt;br&gt;</span></span>
<span id="cb279-184"><a href="#cb279-184" aria-hidden="true" tabindex="-1"></a><span class="vs">    Server needs CORS headers configured.&lt;br&gt;</span></span>
<span id="cb279-185"><a href="#cb279-185" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;button onclick=&quot;this.parentElement.remove()&quot;&gt;Dismiss&lt;/button&gt;</span></span>
<span id="cb279-186"><a href="#cb279-186" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb279-187"><a href="#cb279-187" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(warning)<span class="op">;</span></span>
<span id="cb279-188"><a href="#cb279-188" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-189"><a href="#cb279-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-190"><a href="#cb279-190" aria-hidden="true" tabindex="-1"></a><span class="co">// Error tracking integration</span></span>
<span id="cb279-191"><a href="#cb279-191" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">logToErrorTracking</span>(errorData) {</span>
<span id="cb279-192"><a href="#cb279-192" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Example: Send to monitoring service</span></span>
<span id="cb279-193"><a href="#cb279-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(<span class="st">&#39;https://monitoring.example.com/errors&#39;</span><span class="op">,</span> {</span>
<span id="cb279-194"><a href="#cb279-194" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb279-195"><a href="#cb279-195" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb279-196"><a href="#cb279-196" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb279-197"><a href="#cb279-197" aria-hidden="true" tabindex="-1"></a>      <span class="dt">component</span><span class="op">:</span> <span class="st">&#39;pan-forwarder&#39;</span><span class="op">,</span></span>
<span id="cb279-198"><a href="#cb279-198" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb279-199"><a href="#cb279-199" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>errorData</span>
<span id="cb279-200"><a href="#cb279-200" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb279-201"><a href="#cb279-201" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">catch</span>(err <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error tracking failed:&#39;</span><span class="op">,</span> err<span class="op">.</span><span class="at">message</span>))<span class="op">;</span></span>
<span id="cb279-202"><a href="#cb279-202" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-203"><a href="#cb279-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-204"><a href="#cb279-204" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Robust forwarder with comprehensive error handling</span></span>
<span id="cb279-205"><a href="#cb279-205" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">setupRobustForwarder</span>() {</span>
<span id="cb279-206"><a href="#cb279-206" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb279-207"><a href="#cb279-207" aria-hidden="true" tabindex="-1"></a>  container<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb279-208"><a href="#cb279-208" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;pan-forwarder</span></span>
<span id="cb279-209"><a href="#cb279-209" aria-hidden="true" tabindex="-1"></a><span class="vs">      url=&quot;https://api.example.com/events&quot;</span></span>
<span id="cb279-210"><a href="#cb279-210" aria-hidden="true" tabindex="-1"></a><span class="vs">      topics=&quot;user.*,error.*&quot;</span></span>
<span id="cb279-211"><a href="#cb279-211" aria-hidden="true" tabindex="-1"></a><span class="vs">      method=&quot;POST&quot;</span></span>
<span id="cb279-212"><a href="#cb279-212" aria-hidden="true" tabindex="-1"></a><span class="vs">      debounce=&quot;1000&quot;</span></span>
<span id="cb279-213"><a href="#cb279-213" aria-hidden="true" tabindex="-1"></a><span class="vs">      batch-size=&quot;10&quot;</span></span>
<span id="cb279-214"><a href="#cb279-214" aria-hidden="true" tabindex="-1"></a><span class="vs">      batch-timeout=&quot;5000&quot;</span></span>
<span id="cb279-215"><a href="#cb279-215" aria-hidden="true" tabindex="-1"></a><span class="vs">      credentials=&quot;include&quot;&gt;</span></span>
<span id="cb279-216"><a href="#cb279-216" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;script type=&quot;application/json&quot;&gt;</span></span>
<span id="cb279-217"><a href="#cb279-217" aria-hidden="true" tabindex="-1"></a><span class="vs">        {</span></span>
<span id="cb279-218"><a href="#cb279-218" aria-hidden="true" tabindex="-1"></a><span class="vs">          &quot;headers&quot;: {</span></span>
<span id="cb279-219"><a href="#cb279-219" aria-hidden="true" tabindex="-1"></a><span class="vs">            &quot;Authorization&quot;: &quot;Bearer initial-token&quot;,</span></span>
<span id="cb279-220"><a href="#cb279-220" aria-hidden="true" tabindex="-1"></a><span class="vs">            &quot;Content-Type&quot;: &quot;application/json&quot;,</span></span>
<span id="cb279-221"><a href="#cb279-221" aria-hidden="true" tabindex="-1"></a><span class="vs">            &quot;X-Client-Version&quot;: &quot;1.0.0&quot;</span></span>
<span id="cb279-222"><a href="#cb279-222" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb279-223"><a href="#cb279-223" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb279-224"><a href="#cb279-224" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/script&gt;</span></span>
<span id="cb279-225"><a href="#cb279-225" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/pan-forwarder&gt;</span></span>
<span id="cb279-226"><a href="#cb279-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-227"><a href="#cb279-227" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div id=&quot;forward-stats&quot; style=&quot;position: fixed; bottom: 10px; right: 10px; background: white; padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;&quot;&gt;</span></span>
<span id="cb279-228"><a href="#cb279-228" aria-hidden="true" tabindex="-1"></a><span class="vs">      Forwards: &lt;span id=&quot;success-count&quot;&gt;0&lt;/span&gt; | </span></span>
<span id="cb279-229"><a href="#cb279-229" aria-hidden="true" tabindex="-1"></a><span class="vs">      Errors: &lt;span id=&quot;error-count&quot;&gt;0&lt;/span&gt; | </span></span>
<span id="cb279-230"><a href="#cb279-230" aria-hidden="true" tabindex="-1"></a><span class="vs">      Queued: &lt;span id=&quot;queue-count&quot;&gt;0&lt;/span&gt;</span></span>
<span id="cb279-231"><a href="#cb279-231" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb279-232"><a href="#cb279-232" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb279-233"><a href="#cb279-233" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb279-234"><a href="#cb279-234" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(container)<span class="op">;</span></span>
<span id="cb279-235"><a href="#cb279-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-236"><a href="#cb279-236" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update stats display</span></span>
<span id="cb279-237"><a href="#cb279-237" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> errorCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb279-238"><a href="#cb279-238" aria-hidden="true" tabindex="-1"></a>  pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.error&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb279-239"><a href="#cb279-239" aria-hidden="true" tabindex="-1"></a>    errorCount<span class="op">++;</span></span>
<span id="cb279-240"><a href="#cb279-240" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;error-count&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> errorCount<span class="op">;</span></span>
<span id="cb279-241"><a href="#cb279-241" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;queue-count&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> offlineQueue<span class="op">.</span><span class="at">length</span> <span class="op">+</span> retryQueue<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb279-242"><a href="#cb279-242" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb279-243"><a href="#cb279-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-244"><a href="#cb279-244" aria-hidden="true" tabindex="-1"></a>  pc<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;forwarder.success&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb279-245"><a href="#cb279-245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;success-count&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> forwardCount<span class="op">;</span></span>
<span id="cb279-246"><a href="#cb279-246" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb279-247"><a href="#cb279-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-248"><a href="#cb279-248" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Periodic queue check</span></span>
<span id="cb279-249"><a href="#cb279-249" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb279-250"><a href="#cb279-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;queue-count&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> offlineQueue<span class="op">.</span><span class="at">length</span> <span class="op">+</span> retryQueue<span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb279-251"><a href="#cb279-251" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb279-252"><a href="#cb279-252" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-253"><a href="#cb279-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-254"><a href="#cb279-254" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize when ready</span></span>
<span id="cb279-255"><a href="#cb279-255" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">then</span>(setupRobustForwarder)<span class="op">;</span></span></code></pre></div>
<h4 data-number="21.2.8.3" id="exceptions-thrown-1"><span
class="header-section-number">21.2.8.3</span> Exceptions Thrown</h4>
<p>pan-forwarder does not throw exceptions directly. All errors are
published as PAN messages on <code>forwarder.error</code> topic.</p>
<h4 data-number="21.2.8.4" id="http-status-codes"><span
class="header-section-number">21.2.8.4</span> HTTP Status Codes</h4>
<p>Common status codes encountered:</p>
<ul>
<li><strong>401 Unauthorized</strong>: Missing or invalid authentication
token</li>
<li><strong>403 Forbidden</strong>: Valid token but insufficient
permissions</li>
<li><strong>404 Not Found</strong>: Endpoint URL incorrect</li>
<li><strong>429 Too Many Requests</strong>: Rate limiting in effect</li>
<li><strong>500 Internal Server Error</strong>: Server-side processing
error</li>
<li><strong>502 Bad Gateway</strong>: Server unreachable or down</li>
<li><strong>503 Service Unavailable</strong>: Server temporarily
overloaded</li>
</ul>
<h4 data-number="21.2.8.5" id="server-requirements"><span
class="header-section-number">21.2.8.5</span> Server Requirements</h4>
<p>For successful message forwarding, server must:</p>
<ol type="1">
<li><p>Accept POST requests (or configured method) at the URL</p></li>
<li><p>Support JSON request body (Content-Type:
application/json)</p></li>
<li><p>Return JSON response with status field</p></li>
<li><p>Configure CORS headers if cross-origin:</p>
<pre><code>Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization</code></pre></li>
<li><p>Handle batched messages if batch-size &gt; 1</p></li>
<li><p>Respond within reasonable timeout (default: 30s)</p></li>
</ol>
<h3 data-number="21.2.9" id="common-issues-28"><span
class="header-section-number">21.2.9</span> Common Issues</h3>
<p><strong>Messages not forwarded</strong>: Check topic patterns match.
Use <code>topics="*"</code> to forward all messages.</p>
<p><strong>CORS errors</strong>: Configure CORS headers on server. Use
<code>credentials="include"</code> for cookies.</p>
<p><strong>Too many requests</strong>: Increase <code>debounce</code> or
use <code>batch-size</code> to group messages.</p>
<p><strong>Duplicate forwards</strong>: Enable
<code>deduplicate="true"</code> to skip duplicate messages within
5-second window.</p>
<p><strong>Server overload</strong>: Use batching
(<code>batch-size="50"</code>, <code>batch-timeout="5000"</code>) to
reduce request frequency.</p>
<hr />
<h2 data-number="21.3" id="summary-4"><span
class="header-section-number">21.3</span> Summary</h2>
<p>This chapter documented LARC’s utility components:</p>
<ul>
<li><strong>pan-debug</strong>: Message tracing and debugging with query
capabilities</li>
<li><strong>pan-forwarder</strong>: HTTP message forwarding for server
integration</li>
</ul>
<p>These components provide observability and extensibility without
modifying core application logic.</p>
<p><strong>See Also</strong>:</p>
<ul>
<li>Tutorial: <em>Learning LARC</em> Chapter 14</li>
<li>Core components: Chapter 17</li>
<li>Integration patterns: Chapter 20</li>
<li>Debugging guide: Appendix D</li>
</ul>
<h1 data-number="22" id="message-topics-reference"><span
class="header-section-number">22</span> Message Topics Reference</h1>
<p>This appendix provides a comprehensive reference for LARC message
topic conventions. Topics are the fundamental addressing mechanism in
LARC applications—they determine how messages are routed, who receives
them, and how components interact. Understanding topic patterns is
essential for building scalable, maintainable LARC applications.</p>
<h2 data-number="22.1" id="topic-format-and-structure"><span
class="header-section-number">22.1</span> Topic Format and
Structure</h2>
<h3 data-number="22.1.1" id="standard-format"><span
class="header-section-number">22.1.1</span> Standard Format</h3>
<p>LARC topics follow a hierarchical dotted notation:</p>
<pre><code>resource.action.qualifier</code></pre>
<p><strong>Components:</strong></p>
<ul>
<li><strong>Resource:</strong> The domain entity or system (users,
posts, nav, ui, auth)</li>
<li><strong>Action:</strong> The operation or event type (list, item,
get, save, updated)</li>
<li><strong>Qualifier:</strong> Additional context (state, request,
reply, event)</li>
</ul>
<p>This three-segment format provides clarity while remaining flexible
enough for various use cases. More segments can be added when needed for
specificity.</p>
<h3 data-number="22.1.2" id="topic-examples"><span
class="header-section-number">22.1.2</span> Topic Examples</h3>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 22%" />
<col style="width: 17%" />
<col style="width: 24%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>Topic</th>
<th>Resource</th>
<th>Action</th>
<th>Qualifier</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users.list.state</code></td>
<td>users</td>
<td>list</td>
<td>state</td>
<td>Current user list (retained)</td>
</tr>
<tr>
<td><code>users.item.get</code></td>
<td>users</td>
<td>item</td>
<td>get</td>
<td>Fetch single user (request)</td>
</tr>
<tr>
<td><code>posts.item.updated</code></td>
<td>posts</td>
<td>item</td>
<td>updated</td>
<td>Post was modified (event)</td>
</tr>
<tr>
<td><code>nav.goto</code></td>
<td>nav</td>
<td>goto</td>
<td>—</td>
<td>Navigate to route (command)</td>
</tr>
<tr>
<td><code>ui.modal.opened</code></td>
<td>ui</td>
<td>modal.opened</td>
<td>—</td>
<td>Modal opened (event)</td>
</tr>
<tr>
<td><code>auth.session.state</code></td>
<td>auth</td>
<td>session</td>
<td>state</td>
<td>Current session (retained)</td>
</tr>
</tbody>
</table>
<h3 data-number="22.1.3" id="naming-rules"><span
class="header-section-number">22.1.3</span> Naming Rules</h3>
<p><strong>Case and Separators:</strong></p>
<ul>
<li>Use lowercase letters only</li>
<li>Separate segments with dots (<code>.</code>)</li>
<li>Use hyphens (<code>-</code>) within a segment if needed:
<code>auth.two-factor.verify</code></li>
</ul>
<p><strong>Character Set:</strong> - Alphanumeric characters:
<code>a-z</code>, <code>0-9</code> - Dots for segment separation:
<code>.</code> - Hyphens for compound words: <code>-</code> - No
underscores, spaces, or special characters</p>
<p><strong>Length:</strong> - Keep topics concise but descriptive -
Typical range: 15-40 characters - Avoid abbreviations that sacrifice
clarity</p>
<h2 data-number="22.2" id="topic-patterns-and-matching"><span
class="header-section-number">22.2</span> Topic Patterns and
Matching</h2>
<h3 data-number="22.2.1" id="exact-match"><span
class="header-section-number">22.2.1</span> Exact Match</h3>
<p>The simplest pattern matches a specific topic exactly:</p>
<div class="sourceCode" id="cb282"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.updated&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User updated:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Receives only messages published to
<code>users.item.updated</code>.</p>
<h3 data-number="22.2.2" id="single-segment-wildcard"><span
class="header-section-number">22.2.2</span> Single-Segment Wildcard</h3>
<p>The asterisk (<code>*</code>) matches exactly one segment:</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Matches</th>
<th>Does Not Match</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users.*</code></td>
<td><code>users.list</code>, <code>users.item</code></td>
<td><code>users.list.state</code>, <code>users.item.updated</code></td>
</tr>
<tr>
<td><code>*.updated</code></td>
<td><code>users.updated</code>, <code>posts.updated</code></td>
<td><code>users.item.updated</code></td>
</tr>
<tr>
<td><code>users.*.state</code></td>
<td><code>users.list.state</code>, <code>users.item.state</code></td>
<td><code>users.state</code>, <code>users.list.item.state</code></td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb283"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to all user-related events</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User event:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">topic</span>)<span class="op">;</span></span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.2.3" id="global-wildcard"><span
class="header-section-number">22.2.3</span> Global Wildcard</h3>
<p>The special pattern <code>*</code> matches all topics:</p>
<div class="sourceCode" id="cb284"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Monitor all messages (use sparingly)</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;[ALL]&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Warning:</strong> Global wildcard subscriptions match every
message in the system. Use them only for debugging, logging, or
analytics. They can significantly impact performance in high-throughput
applications.</p>
<h3 data-number="22.2.4" id="pattern-matching-examples"><span
class="header-section-number">22.2.4</span> Pattern Matching
Examples</h3>
<div class="sourceCode" id="cb285"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Match all list operations</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*.list.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matches: users.list.state, posts.list.get, comments.list.get</span></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-6"><a href="#cb285-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Match all state topics</span></span>
<span id="cb285-7"><a href="#cb285-7" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*.*.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb285-8"><a href="#cb285-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matches: users.list.state, app.theme.state, nav.route.state</span></span>
<span id="cb285-9"><a href="#cb285-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb285-10"><a href="#cb285-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-11"><a href="#cb285-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Match all operations on items</span></span>
<span id="cb285-12"><a href="#cb285-12" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*.item.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb285-13"><a href="#cb285-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matches: users.item.get, posts.item.save, users.item.updated</span></span>
<span id="cb285-14"><a href="#cb285-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="22.3" id="reserved-topic-namespaces"><span
class="header-section-number">22.3</span> Reserved Topic Namespaces</h2>
<p>Certain topic namespaces are reserved for LARC internal use.
Applications must not publish to these topics directly.</p>
<h3 data-number="22.3.1" id="pan-namespace-system-internal"><span
class="header-section-number">22.3.1</span> pan:* Namespace (System
Internal)</h3>
<p>The <code>pan:*</code> namespace is reserved for PAN bus
internals:</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Purpose</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pan:sys.ready</code></td>
<td>Bus ready signal</td>
<td>Listen only</td>
</tr>
<tr>
<td><code>pan:sys.stats</code></td>
<td>Bus statistics</td>
<td>Request only</td>
</tr>
<tr>
<td><code>pan:sys.error</code></td>
<td>System errors</td>
<td>Listen only</td>
</tr>
<tr>
<td><code>pan:sys.clear-retained</code></td>
<td>Clear retained messages</td>
<td>Request only</td>
</tr>
<tr>
<td><code>pan:publish</code></td>
<td>Internal publish event</td>
<td>Internal only</td>
</tr>
<tr>
<td><code>pan:subscribe</code></td>
<td>Internal subscribe event</td>
<td>Internal only</td>
</tr>
<tr>
<td><code>pan:unsubscribe</code></td>
<td>Internal unsubscribe event</td>
<td>Internal only</td>
</tr>
<tr>
<td><code>pan:deliver</code></td>
<td>Internal message delivery</td>
<td>Internal only</td>
</tr>
<tr>
<td><code>pan:hello</code></td>
<td>Client registration</td>
<td>Internal only</td>
</tr>
<tr>
<td><code>pan:$reply:*</code></td>
<td>Auto-generated reply topics</td>
<td>Internal only</td>
</tr>
</tbody>
</table>
<p><strong>Never:</strong> - Publish to <code>pan:*</code> topics
directly - Subscribe to internal topics like <code>pan:publish</code> or
<code>pan:subscribe</code> - Manually create <code>pan:$reply:*</code>
topics (these are auto-generated by <code>request()</code>)</p>
<p><strong>Exception:</strong> You may subscribe to system notification
topics like <code>pan:sys.ready</code> and
<code>pan:sys.error</code>.</p>
<h3 data-number="22.3.2" id="sys-namespace-system-reserved"><span
class="header-section-number">22.3.2</span> sys:* Namespace (System
Reserved)</h3>
<p>The <code>sys:*</code> namespace is reserved for future system-level
functionality:</p>
<pre><code>sys:error               # Future: System-wide errors
sys:perf                # Future: Performance monitoring
sys:debug               # Future: Debug information
sys:config              # Future: Configuration changes</code></pre>
<p>Do not use <code>sys:*</code> topics in application code.</p>
<h3 data-number="22.3.3" id="application-namespaces"><span
class="header-section-number">22.3.3</span> Application Namespaces</h3>
<p>Your application should establish its own top-level namespaces:</p>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 30%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Namespace</th>
<th>Purpose</th>
<th>Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>app.*</code></td>
<td>Application-level concerns</td>
<td><code>app.config.state</code>, <code>app.theme.state</code></td>
</tr>
<tr>
<td><code>auth.*</code></td>
<td>Authentication/authorization</td>
<td><code>auth.login</code>, <code>auth.session.state</code></td>
</tr>
<tr>
<td><code>session.*</code></td>
<td>Session management</td>
<td><code>session.started</code>, <code>session.expired</code></td>
</tr>
<tr>
<td><code>nav.*</code></td>
<td>Navigation</td>
<td><code>nav.goto</code>, <code>nav.route.state</code></td>
</tr>
<tr>
<td><code>ui.*</code></td>
<td>UI components</td>
<td><code>ui.modal.opened</code>, <code>ui.toast.show</code></td>
</tr>
<tr>
<td><code>analytics.*</code></td>
<td>Analytics tracking</td>
<td><code>analytics.event</code>, <code>analytics.page-view</code></td>
</tr>
</tbody>
</table>
<h2 data-number="22.4" id="crud-topic-patterns"><span
class="header-section-number">22.4</span> CRUD Topic Patterns</h2>
<p>CRUD operations (Create, Read, Update, Delete) follow consistent
topic patterns across all resources.</p>
<h3 data-number="22.4.1" id="list-operations"><span
class="header-section-number">22.4.1</span> List Operations</h3>
<h4 data-number="22.4.1.1" id="list-state-retained"><span
class="header-section-number">22.4.1.1</span> List State (Retained)</h4>
<p><strong>Topic:</strong> <code>${resource}.list.state</code></p>
<p><strong>Purpose:</strong> Retained snapshot of current list data. New
subscribers receive the most recent list immediately.</p>
<p><strong>Message Format:</strong></p>
<div class="sourceCode" id="cb287"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.list.state&#39;</span><span class="op">,</span></span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> [<span class="co">/* array of items */</span>]<span class="op">,</span></span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span>              <span class="co">// Total count (for pagination)</span></span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span>                 <span class="co">// Current page</span></span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">filter</span><span class="op">:</span> {}<span class="op">,</span>              <span class="co">// Active filters</span></span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sort</span><span class="op">:</span> <span class="st">&#39;name-asc&#39;</span>         <span class="co">// Active sort</span></span>
<span id="cb287-9"><a href="#cb287-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb287-10"><a href="#cb287-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb287-11"><a href="#cb287-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb288"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish list state</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.list.state&#39;</span><span class="op">,</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> users<span class="op">,</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total</span><span class="op">:</span> users<span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to list state</span></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.list.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderList</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<h4 data-number="22.4.1.2" id="list-get-request"><span
class="header-section-number">22.4.1.2</span> List Get (Request)</h4>
<p><strong>Topic:</strong> <code>${resource}.list.get</code></p>
<p><strong>Purpose:</strong> Request to fetch list data with optional
parameters.</p>
<p><strong>Request Format:</strong></p>
<div class="sourceCode" id="cb289"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.list.get&#39;</span><span class="op">,</span></span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">filter</span><span class="op">:</span> { <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sort</span><span class="op">:</span> <span class="st">&#39;name-asc&#39;</span></span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Response Format:</strong></p>
<div class="sourceCode" id="cb290"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">items</span><span class="op">:</span> [<span class="co">/* array */</span>]<span class="op">,</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">total</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb291"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Request list</span></span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> {</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">limit</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">filter</span><span class="op">:</span> { <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb291-6"><a href="#cb291-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb291-7"><a href="#cb291-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-8"><a href="#cb291-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (response<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb291-9"><a href="#cb291-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderList</span>(response<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb291-10"><a href="#cb291-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="22.4.2" id="item-operations"><span
class="header-section-number">22.4.2</span> Item Operations</h3>
<h4 data-number="22.4.2.1" id="item-get-request"><span
class="header-section-number">22.4.2.1</span> Item Get (Request)</h4>
<p><strong>Topic:</strong> <code>${resource}.item.get</code></p>
<p><strong>Purpose:</strong> Fetch a single item by ID.</p>
<p><strong>Request Format:</strong></p>
<div class="sourceCode" id="cb292"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Response Format:</strong></p>
<div class="sourceCode" id="cb293"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Success</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">item</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;...&#39;</span> } }</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Not found</span></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Not found&#39;</span><span class="op">,</span> <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;NOT_FOUND&#39;</span> }</span></code></pre></div>
<h4 data-number="22.4.2.2" id="item-save-request"><span
class="header-section-number">22.4.2.2</span> Item Save (Request)</h4>
<p><strong>Topic:</strong> <code>${resource}.item.save</code></p>
<p><strong>Purpose:</strong> Create or update an item. If
<code>id</code> is present, updates existing item. If <code>id</code> is
omitted, creates new item.</p>
<p><strong>Request Format:</strong></p>
<div class="sourceCode" id="cb294"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.save&#39;</span><span class="op">,</span></span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">item</span><span class="op">:</span> {</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span>              <span class="co">// Omit for create</span></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span></span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Response Format:</strong></p>
<div class="sourceCode" id="cb295"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Success</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">item</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;...&#39;</span> } }</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Validation error</span></span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Invalid email&#39;</span><span class="op">,</span> <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;VALIDATION_ERROR&#39;</span> }</span></code></pre></div>
<h4 data-number="22.4.2.3" id="item-delete-request"><span
class="header-section-number">22.4.2.3</span> Item Delete (Request)</h4>
<p><strong>Topic:</strong> <code>${resource}.item.delete</code></p>
<p><strong>Purpose:</strong> Delete an item by ID.</p>
<p><strong>Request Format:</strong></p>
<div class="sourceCode" id="cb296"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.delete&#39;</span><span class="op">,</span></span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Response Format:</strong></p>
<div class="sourceCode" id="cb297"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Success</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Not found</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Not found&#39;</span><span class="op">,</span> <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;NOT_FOUND&#39;</span> }</span></code></pre></div>
<h4 data-number="22.4.2.4" id="item-select-event"><span
class="header-section-number">22.4.2.4</span> Item Select (Event)</h4>
<p><strong>Topic:</strong> <code>${resource}.item.select</code></p>
<p><strong>Purpose:</strong> User selected/focused an item (no reply
expected).</p>
<p><strong>Message Format:</strong></p>
<div class="sourceCode" id="cb298"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.select&#39;</span><span class="op">,</span></span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb299"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish selection</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.select&#39;</span><span class="op">,</span></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> userId }</span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle selection</span></span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.select&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">highlightItem</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadDetails</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.4.3" id="item-events"><span
class="header-section-number">22.4.3</span> Item Events</h3>
<p>Item events notify about completed operations:</p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Trigger</th>
<th>Data</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\${resource}.item.created</code></td>
<td>Item created</td>
<td><code>{ item: {...} }</code></td>
</tr>
<tr>
<td><code>\${resource}.item.updated</code></td>
<td>Item updated</td>
<td><code>{ item: {...} }</code></td>
</tr>
<tr>
<td><code>\${resource}.item.deleted</code></td>
<td>Item deleted</td>
<td><code>{ id: 123 }</code></td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb300"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co">// After save operation completes</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.updated&#39;</span><span class="op">,</span></span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">item</span><span class="op">:</span> savedUser }</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.4.4" id="per-item-state"><span
class="header-section-number">22.4.4</span> Per-Item State</h3>
<p>For tracking state of individual items:</p>
<p><strong>Topic:</strong> <code>${resource}.item.state.${id}</code></p>
<p><strong>Purpose:</strong> Retained state for a specific item (e.g.,
online status, typing indicator).</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb301"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish item state</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="vs">`users.item.state.</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> userId<span class="op">,</span></span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">online</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb301-7"><a href="#cb301-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">typing</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb301-8"><a href="#cb301-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">lastSeen</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb301-9"><a href="#cb301-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb301-10"><a href="#cb301-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb301-11"><a href="#cb301-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb301-12"><a href="#cb301-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-13"><a href="#cb301-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to specific item</span></span>
<span id="cb301-14"><a href="#cb301-14" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="vs">`users.item.state.</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb301-15"><a href="#cb301-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updatePresence</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb301-16"><a href="#cb301-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb301-17"><a href="#cb301-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-18"><a href="#cb301-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to all item states</span></span>
<span id="cb301-19"><a href="#cb301-19" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.state.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb301-20"><a href="#cb301-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updatePresence</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb301-21"><a href="#cb301-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="22.5" id="state-management-topics"><span
class="header-section-number">22.5</span> State Management Topics</h2>
<p>State topics use the <code>.state</code> qualifier and are always
retained.</p>
<h3 data-number="22.5.1" id="global-state"><span
class="header-section-number">22.5.1</span> Global State</h3>
<p><strong>Pattern:</strong> <code>${domain}.state</code></p>
<p><strong>Examples:</strong></p>
<div class="sourceCode" id="cb302"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;app.config.state&#39;</span>          # Application configuration</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;app.theme.state&#39;</span>           # Current theme</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;app.language.state&#39;</span>        # Current language</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.sidebar.state&#39;</span>          # Sidebar open<span class="op">/</span>closed</span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.loading.state&#39;</span>          # Loading indicator</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb303"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish state</span></span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;app.theme.state&#39;</span><span class="op">,</span></span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span><span class="op">,</span> <span class="dt">accent</span><span class="op">:</span> <span class="st">&#39;#007bff&#39;</span> }<span class="op">,</span></span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe (receives current state immediately)</span></span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.5.2" id="scoped-state"><span
class="header-section-number">22.5.2</span> Scoped State</h3>
<p><strong>Pattern:</strong> <code>${domain}.${scope}.state</code></p>
<p><strong>Examples:</strong></p>
<div class="sourceCode" id="cb304"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users.list.state&#39;</span>          # User list</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.session.state&#39;</span>        # Current session</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.route.state&#39;</span>           # Current route</span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;search.query.state&#39;</span>        # Search query</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;filters.active.state&#39;</span>      # Active filters</span></code></pre></div>
<h2 data-number="22.6" id="events-vs-commands"><span
class="header-section-number">22.6</span> Events vs Commands</h2>
<p>Distinguish between events (past tense) and commands
(imperative).</p>
<h3 data-number="22.6.1" id="events-3"><span
class="header-section-number">22.6.1</span> Events</h3>
<p>Events describe something that <strong>already happened</strong>.
They use past tense.</p>
<p><strong>Characteristics:</strong> - Past tense verbs:
<code>created</code>, <code>updated</code>, <code>deleted</code>,
<code>opened</code>, <code>closed</code> - Fire-and-forget (no reply
expected) - Multiple subscribers allowed - Informational</p>
<p><strong>Examples:</strong></p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users.item.created</code></td>
<td>A user was created</td>
</tr>
<tr>
<td><code>users.item.updated</code></td>
<td>A user was updated</td>
</tr>
<tr>
<td><code>ui.modal.opened</code></td>
<td>A modal was opened</td>
</tr>
<tr>
<td><code>ui.modal.closed</code></td>
<td>A modal was closed</td>
</tr>
<tr>
<td><code>session.started</code></td>
<td>Session started</td>
</tr>
<tr>
<td><code>session.expired</code></td>
<td>Session expired</td>
</tr>
<tr>
<td><code>auth.login.success</code></td>
<td>Login succeeded</td>
</tr>
<tr>
<td><code>auth.login.failed</code></td>
<td>Login failed</td>
</tr>
<tr>
<td><code>nav.navigated</code></td>
<td>Navigation completed</td>
</tr>
</tbody>
</table>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb305"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish event</span></span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.created&#39;</span><span class="op">,</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">item</span><span class="op">:</span> newUser }</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple handlers can react</span></span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.created&#39;</span><span class="op">,</span> logAnalytics)<span class="op">;</span></span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.created&#39;</span><span class="op">,</span> sendWelcomeEmail)<span class="op">;</span></span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.created&#39;</span><span class="op">,</span> updateDashboard)<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.6.2" id="commands"><span
class="header-section-number">22.6.2</span> Commands</h3>
<p>Commands request something to <strong>happen</strong>. They use
imperative/verb form.</p>
<p><strong>Characteristics:</strong> - Imperative verbs:
<code>save</code>, <code>delete</code>, <code>open</code>,
<code>close</code>, <code>goto</code> - May expect reply (request/reply
pattern) - Usually single handler - May fail</p>
<p><strong>Examples:</strong></p>
<table>
<thead>
<tr>
<th>Topic</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users.item.save</code></td>
<td>Save a user</td>
</tr>
<tr>
<td><code>users.item.delete</code></td>
<td>Delete a user</td>
</tr>
<tr>
<td><code>ui.modal.open</code></td>
<td>Open a modal</td>
</tr>
<tr>
<td><code>ui.modal.close</code></td>
<td>Close a modal</td>
</tr>
<tr>
<td><code>nav.goto</code></td>
<td>Navigate to route</td>
</tr>
<tr>
<td><code>nav.back</code></td>
<td>Go back in history</td>
</tr>
<tr>
<td><code>auth.login</code></td>
<td>Perform login</td>
</tr>
<tr>
<td><code>auth.logout</code></td>
<td>Perform logout</td>
</tr>
</tbody>
</table>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb306"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Fire-and-forget command</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;nav.goto&#39;</span><span class="op">,</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">route</span><span class="op">:</span> <span class="st">&#39;/users/123&#39;</span> }</span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Request command (expect reply)</span></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.item.save&#39;</span><span class="op">,</span> {</span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">item</span><span class="op">:</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }</span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="22.7" id="domain-specific-patterns"><span
class="header-section-number">22.7</span> Domain-Specific Patterns</h2>
<h3 data-number="22.7.1" id="authentication"><span
class="header-section-number">22.7.1</span> Authentication</h3>
<div class="sourceCode" id="cb307"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Commands</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.login&#39;</span>                # Login request</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.logout&#39;</span>               # Logout request</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.refresh&#39;</span>              # Refresh token</span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.verify&#39;</span>               # Verify credentials</span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Events</span></span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.login.success&#39;</span>        # Login succeeded</span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.login.failed&#39;</span>         # Login failed</span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.logout&#39;</span>               # User logged out</span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.token.expired&#39;</span>        # Token expired</span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a><span class="co">// State</span></span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.session.state&#39;</span>        # Current <span class="fu">session</span> (retained)</span>
<span id="cb307-15"><a href="#cb307-15" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.user.state&#39;</span>           # Current user <span class="fu">info</span> (retained)</span></code></pre></div>
<h3 data-number="22.7.2" id="navigation"><span
class="header-section-number">22.7.2</span> Navigation</h3>
<div class="sourceCode" id="cb308"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Commands</span></span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.goto&#39;</span>                  # Navigate to route</span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.back&#39;</span>                  # Go back</span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.forward&#39;</span>               # Go forward</span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.replace&#39;</span>               # Replace current route</span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Events</span></span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.navigated&#39;</span>             # Navigation completed</span>
<span id="cb308-9"><a href="#cb308-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.error&#39;</span>                 # Navigation error</span>
<span id="cb308-10"><a href="#cb308-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-11"><a href="#cb308-11" aria-hidden="true" tabindex="-1"></a><span class="co">// State</span></span>
<span id="cb308-12"><a href="#cb308-12" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.route.state&#39;</span>           # Current <span class="fu">route</span> (retained)</span>
<span id="cb308-13"><a href="#cb308-13" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.history.state&#39;</span>         # <span class="bu">History</span> <span class="fu">stack</span> (retained)</span></code></pre></div>
<h3 data-number="22.7.3" id="ui-components"><span
class="header-section-number">22.7.3</span> UI Components</h3>
<div class="sourceCode" id="cb309"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Modal</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.open&#39;</span>             # Command<span class="op">:</span> open modal</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.close&#39;</span>            # Command<span class="op">:</span> close modal</span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.opened&#39;</span>           # <span class="bu">Event</span><span class="op">:</span> modal opened</span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.closed&#39;</span>           # <span class="bu">Event</span><span class="op">:</span> modal closed</span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.state&#39;</span>            # State<span class="op">:</span> current <span class="fu">modal</span> (retained)</span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Sidebar</span></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.sidebar.toggle&#39;</span>         # Command<span class="op">:</span> toggle sidebar</span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.sidebar.open&#39;</span>           # Command<span class="op">:</span> open sidebar</span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.sidebar.close&#39;</span>          # Command<span class="op">:</span> close sidebar</span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.sidebar.state&#39;</span>          # State<span class="op">:</span> open<span class="op">/</span><span class="fu">closed</span> (retained)</span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Toast</span></span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.toast.show&#39;</span>             # Command<span class="op">:</span> show toast</span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.toast.hide&#39;</span>             # Command<span class="op">:</span> hide toast</span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Loading</span></span>
<span id="cb309-19"><a href="#cb309-19" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.loading.start&#39;</span>          # Command<span class="op">:</span> start loading</span>
<span id="cb309-20"><a href="#cb309-20" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.loading.stop&#39;</span>           # Command<span class="op">:</span> stop loading</span>
<span id="cb309-21"><a href="#cb309-21" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.loading.state&#39;</span>          # State<span class="op">:</span> loading <span class="fu">status</span> (retained)</span></code></pre></div>
<h3 data-number="22.7.4" id="forms-1"><span
class="header-section-number">22.7.4</span> Forms</h3>
<div class="sourceCode" id="cb310"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Validation</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.validate&#39;</span>             # Command<span class="op">:</span> validate form</span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.validated&#39;</span>            # <span class="bu">Event</span><span class="op">:</span> validation complete</span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.validation.state&#39;</span>     # State<span class="op">:</span> validation <span class="fu">errors</span> (retained)</span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Submission</span></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.submit&#39;</span>               # Command<span class="op">:</span> submit form</span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.submitted&#39;</span>            # <span class="bu">Event</span><span class="op">:</span> form submitted</span>
<span id="cb310-9"><a href="#cb310-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.submit.success&#39;</span>       # <span class="bu">Event</span><span class="op">:</span> submission succeeded</span>
<span id="cb310-10"><a href="#cb310-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.submit.failed&#39;</span>        # <span class="bu">Event</span><span class="op">:</span> submission failed</span>
<span id="cb310-11"><a href="#cb310-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-12"><a href="#cb310-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Field changes</span></span>
<span id="cb310-13"><a href="#cb310-13" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.field.changed&#39;</span>        # <span class="bu">Event</span><span class="op">:</span> field value changed</span>
<span id="cb310-14"><a href="#cb310-14" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.field.focused&#39;</span>        # <span class="bu">Event</span><span class="op">:</span> field focused</span>
<span id="cb310-15"><a href="#cb310-15" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;form.field.blurred&#39;</span>        # <span class="bu">Event</span><span class="op">:</span> field blurred</span></code></pre></div>
<h3 data-number="22.7.5" id="data-synchronization"><span
class="header-section-number">22.7.5</span> Data Synchronization</h3>
<div class="sourceCode" id="cb311"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync commands</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.start&#39;</span>                # Start sync</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.stop&#39;</span>                 # Stop sync</span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.refresh&#39;</span>              # Force refresh</span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync events</span></span>
<span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.started&#39;</span>              # Sync started</span>
<span id="cb311-8"><a href="#cb311-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.completed&#39;</span>            # Sync completed</span>
<span id="cb311-9"><a href="#cb311-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.failed&#39;</span>               # Sync failed</span>
<span id="cb311-10"><a href="#cb311-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.conflict&#39;</span>             # Sync conflict detected</span>
<span id="cb311-11"><a href="#cb311-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-12"><a href="#cb311-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Sync state</span></span>
<span id="cb311-13"><a href="#cb311-13" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.status.state&#39;</span>         # Current sync <span class="fu">status</span> (retained)</span>
<span id="cb311-14"><a href="#cb311-14" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;sync.last-update.state&#39;</span>    # Last update <span class="fu">time</span> (retained)</span></code></pre></div>
<h2 data-number="22.8" id="best-practices-1"><span
class="header-section-number">22.8</span> Best Practices</h2>
<h3 data-number="22.8.1" id="topic-naming"><span
class="header-section-number">22.8.1</span> Topic Naming</h3>
<p><strong>DO:</strong> - Use lowercase letters - Use dots to separate
segments - Use descriptive names - Be consistent across resources - Use
<code>.state</code> for retained topics - Use past tense for events -
Use imperative for commands</p>
<p><strong>DON’T:</strong> - Use underscores or camelCase - Use
abbreviations that sacrifice clarity - Mix naming conventions - Use
verbs for events (<code>users.update</code> <a href="#x">X</a> -&gt;
<code>users.updated</code> [check]) - Overuse wildcards (<code>*</code>
matches everything)</p>
<h3 data-number="22.8.2" id="topic-catalog"><span
class="header-section-number">22.8.2</span> Topic Catalog</h3>
<p>For larger applications, maintain a centralized topic catalog:</p>
<div class="sourceCode" id="cb312"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="co">// topics.js</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> TOPICS <span class="op">=</span> {</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">USERS</span><span class="op">:</span> {</span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIST</span><span class="op">:</span> {</span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">STATE</span><span class="op">:</span> <span class="st">&#39;users.list.state&#39;</span><span class="op">,</span></span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">GET</span><span class="op">:</span> <span class="st">&#39;users.list.get&#39;</span></span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ITEM</span><span class="op">:</span> {</span>
<span id="cb312-9"><a href="#cb312-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">GET</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb312-10"><a href="#cb312-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">SAVE</span><span class="op">:</span> <span class="st">&#39;users.item.save&#39;</span><span class="op">,</span></span>
<span id="cb312-11"><a href="#cb312-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">DELETE</span><span class="op">:</span> <span class="st">&#39;users.item.delete&#39;</span><span class="op">,</span></span>
<span id="cb312-12"><a href="#cb312-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">SELECT</span><span class="op">:</span> <span class="st">&#39;users.item.select&#39;</span><span class="op">,</span></span>
<span id="cb312-13"><a href="#cb312-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">UPDATED</span><span class="op">:</span> <span class="st">&#39;users.item.updated&#39;</span><span class="op">,</span></span>
<span id="cb312-14"><a href="#cb312-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">DELETED</span><span class="op">:</span> <span class="st">&#39;users.item.deleted&#39;</span><span class="op">,</span></span>
<span id="cb312-15"><a href="#cb312-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">STATE</span><span class="op">:</span> (id) <span class="kw">=&gt;</span> <span class="vs">`users.item.state.</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb312-16"><a href="#cb312-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb312-17"><a href="#cb312-17" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb312-18"><a href="#cb312-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-19"><a href="#cb312-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">NAV</span><span class="op">:</span> {</span>
<span id="cb312-20"><a href="#cb312-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">GOTO</span><span class="op">:</span> <span class="st">&#39;nav.goto&#39;</span><span class="op">,</span></span>
<span id="cb312-21"><a href="#cb312-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">BACK</span><span class="op">:</span> <span class="st">&#39;nav.back&#39;</span><span class="op">,</span></span>
<span id="cb312-22"><a href="#cb312-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ROUTE_STATE</span><span class="op">:</span> <span class="st">&#39;nav.route.state&#39;</span></span>
<span id="cb312-23"><a href="#cb312-23" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb312-24"><a href="#cb312-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-25"><a href="#cb312-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">AUTH</span><span class="op">:</span> {</span>
<span id="cb312-26"><a href="#cb312-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LOGIN</span><span class="op">:</span> <span class="st">&#39;auth.login&#39;</span><span class="op">,</span></span>
<span id="cb312-27"><a href="#cb312-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LOGOUT</span><span class="op">:</span> <span class="st">&#39;auth.logout&#39;</span><span class="op">,</span></span>
<span id="cb312-28"><a href="#cb312-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">SESSION_STATE</span><span class="op">:</span> <span class="st">&#39;auth.session.state&#39;</span></span>
<span id="cb312-29"><a href="#cb312-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb312-30"><a href="#cb312-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb312-31"><a href="#cb312-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-32"><a href="#cb312-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb312-33"><a href="#cb312-33" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb312-34"><a href="#cb312-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> TOPICS<span class="op">.</span><span class="at">USERS</span><span class="op">.</span><span class="at">ITEM</span><span class="op">.</span><span class="at">UPDATED</span><span class="op">,</span></span>
<span id="cb312-35"><a href="#cb312-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">item</span><span class="op">:</span> user }</span>
<span id="cb312-36"><a href="#cb312-36" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="22.8.3" id="performance-considerations-2"><span
class="header-section-number">22.8.3</span> Performance
Considerations</h3>
<p><strong>Wildcard Usage:</strong> - Avoid global wildcard
(<code>*</code>) in production code - Prefer specific patterns
(<code>users.*</code> over <code>*</code>) - Each wildcard increases
matching overhead</p>
<p><strong>Topic Depth:</strong> - Keep topics shallow (3-4 segments
ideal) - Deeper hierarchies increase matching cost - Balance specificity
with performance</p>
<p><strong>State Retention:</strong> - Use retention sparingly (only for
actual state) - Don’t retain high-volume event streams - Clear retained
messages when no longer needed</p>
<h2 data-number="22.9" id="summary-5"><span
class="header-section-number">22.9</span> Summary</h2>
<p><strong>Key Principles:</strong></p>
<ol type="1">
<li><strong>Standard Format:</strong>
<code>resource.action.qualifier</code></li>
<li><strong>State Suffix:</strong> Always use <code>.state</code> for
retained topics</li>
<li><strong>Events vs Commands:</strong> Past tense for events,
imperative for commands</li>
<li><strong>Consistency:</strong> Use same patterns across all
resources</li>
<li><strong>Reserved Namespaces:</strong> Never use <code>pan:*</code>
or <code>sys:*</code></li>
<li><strong>Wildcards:</strong> Use judiciously; prefer specific
patterns</li>
<li><strong>Documentation:</strong> Maintain topic catalog for large
apps</li>
</ol>
<p><strong>Quick Reference:</strong></p>
<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 32%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>\${resource}.list.state</code></td>
<td><code>users.list.state</code></td>
<td>List data (retained)</td>
</tr>
<tr>
<td><code>\${resource}.list.get</code></td>
<td><code>users.list.get</code></td>
<td>Request list</td>
</tr>
<tr>
<td><code>\${resource}.item.get</code></td>
<td><code>users.item.get</code></td>
<td>Request single item</td>
</tr>
<tr>
<td><code>\${resource}.item.save</code></td>
<td><code>users.item.save</code></td>
<td>Save item</td>
</tr>
<tr>
<td><code>\${resource}.item.delete</code></td>
<td><code>users.item.delete</code></td>
<td>Delete item</td>
</tr>
<tr>
<td><code>\${resource}.item.updated</code></td>
<td><code>users.item.updated</code></td>
<td>Item updated event</td>
</tr>
<tr>
<td><code>\${domain}.state</code></td>
<td><code>app.theme.state</code></td>
<td>Global state (retained)</td>
</tr>
<tr>
<td><code>\${domain}.\${action}</code></td>
<td><code>nav.goto</code></td>
<td>Command</td>
</tr>
</tbody>
</table>
<p>For complete API documentation, see the main API Reference.</p>
<h1 data-number="23" id="event-envelope-specification"><span
class="header-section-number">23</span> Event Envelope
Specification</h1>
<p>This appendix provides the complete specification for LARC message
envelopes—the data structures that wrap every message flowing through
the PAN bus. Understanding the envelope format is critical for
debugging, building tooling, and understanding how the system works at a
fundamental level.</p>
<h2 data-number="23.1" id="overview-13"><span
class="header-section-number">23.1</span> Overview</h2>
<p>Every message in LARC is wrapped in an envelope that provides
metadata, routing information, and payload data. The envelope follows a
simple, predictable structure that balances flexibility with
consistency.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li>Plain JavaScript objects (no classes or prototypes)</li>
<li>JSON-serializable (can be logged, stored, transmitted)</li>
<li>Immutable once published (bus may add fields, but won’t modify
existing)</li>
<li>Extensible through headers and custom fields</li>
</ul>
<h2 data-number="23.2" id="message-envelope-structure"><span
class="header-section-number">23.2</span> Message Envelope
Structure</h2>
<h3 data-number="23.2.1" id="complete-format"><span
class="header-section-number">23.2.1</span> Complete Format</h3>
<div class="sourceCode" id="cb313"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> PanMessage {</span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Required fields (must be provided by publisher)</span></span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>  topic<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>  data<span class="op">:</span> <span class="dt">any</span><span class="op">;</span></span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Auto-generated fields (added by bus if not provided)</span></span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a>  id<span class="op">?:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a>  ts<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb313-9"><a href="#cb313-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-10"><a href="#cb313-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Optional feature fields</span></span>
<span id="cb313-11"><a href="#cb313-11" aria-hidden="true" tabindex="-1"></a>  retain<span class="op">?:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb313-12"><a href="#cb313-12" aria-hidden="true" tabindex="-1"></a>  replyTo<span class="op">?:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb313-13"><a href="#cb313-13" aria-hidden="true" tabindex="-1"></a>  correlationId<span class="op">?:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb313-14"><a href="#cb313-14" aria-hidden="true" tabindex="-1"></a>  headers<span class="op">?:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">string</span><span class="op">&gt;;</span></span>
<span id="cb313-15"><a href="#cb313-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-16"><a href="#cb313-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Internal/system fields (typically not used by applications)</span></span>
<span id="cb313-17"><a href="#cb313-17" aria-hidden="true" tabindex="-1"></a>  clientId<span class="op">?:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb313-18"><a href="#cb313-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.2.2" id="minimal-message"><span
class="header-section-number">23.2.2</span> Minimal Message</h3>
<p>The absolute minimum required to publish a message:</p>
<div class="sourceCode" id="cb314"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }</span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The bus will enhance this to:</p>
<div class="sourceCode" id="cb315"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }<span class="op">,</span></span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;550e8400-e29b-41d4-a716-446655440000&#39;</span><span class="op">,</span></span>
<span id="cb315-5"><a href="#cb315-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699564800000</span></span>
<span id="cb315-6"><a href="#cb315-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="23.3" id="field-specifications"><span
class="header-section-number">23.3</span> Field Specifications</h2>
<h3 data-number="23.3.1" id="topic-required"><span
class="header-section-number">23.3.1</span> topic (required)</h3>
<p><strong>Type:</strong> <code>string</code></p>
<p><strong>Purpose:</strong> Identifies the message type and routing
destination.</p>
<p><strong>Format:</strong> Dotted notation, typically
<code>resource.action.qualifier</code></p>
<p><strong>Constraints:</strong> - Must be non-empty string - Lowercase
letters and dots recommended - Max length: 256 characters (practical
limit) - Pattern: <code>/^[a-z0-9.-]+$/i</code></p>
<p><strong>Examples:</strong></p>
<div class="sourceCode" id="cb316"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users.list.state&#39;</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users.item.get&#39;</span></span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.goto&#39;</span></span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;ui.modal.opened&#39;</span></span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.session.state&#39;</span></span></code></pre></div>
<p><strong>Validation:</strong></p>
<div class="sourceCode" id="cb317"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Valid topics</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users.updated&#39;</span>             [v]</span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;nav.goto&#39;</span>                  [v]</span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users.item.state.123&#39;</span>      [v]</span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;auth.two-factor.verify&#39;</span>    [v]</span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Invalid topics</span></span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;</span>                          [x] Empty string</span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users updated&#39;</span>             [x] Contains space</span>
<span id="cb317-10"><a href="#cb317-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;users_updated&#39;</span>             [x] <span class="fu">Underscore</span> (not recommended)</span>
<span id="cb317-11"><a href="#cb317-11" aria-hidden="true" tabindex="-1"></a><span class="kw">null</span>                        [x] Not a string</span></code></pre></div>
<p><strong>Reserved Patterns:</strong></p>
<ul>
<li><code>pan:*</code> - Reserved for PAN bus internals</li>
<li><code>sys:*</code> - Reserved for system-level topics</li>
</ul>
<h3 data-number="23.3.2" id="data-required"><span
class="header-section-number">23.3.2</span> data (required)</h3>
<p><strong>Type:</strong> <code>any</code> (must be
JSON-serializable)</p>
<p><strong>Purpose:</strong> Message payload—the actual information
being communicated.</p>
<p><strong>Constraints:</strong> - Must be JSON-serializable (no
functions, circular refs, DOM nodes) - Recommended max size: 512KB
(configurable via <code>max-payload-size</code>) - Can be any valid JSON
type: object, array, string, number, boolean, null</p>
<p><strong>Supported Types:</strong></p>
<div class="sourceCode" id="cb318"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Object</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span> <span class="dt">active</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Array</span></span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a>[{ <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span> }<span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span> }<span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">3</span> }]</span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a><span class="co">// String</span></span>
<span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Hello, world&quot;</span></span>
<span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-10"><a href="#cb318-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Number</span></span>
<span id="cb318-11"><a href="#cb318-11" aria-hidden="true" tabindex="-1"></a><span class="dv">42</span></span>
<span id="cb318-12"><a href="#cb318-12" aria-hidden="true" tabindex="-1"></a><span class="fl">3.14159</span></span>
<span id="cb318-13"><a href="#cb318-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-14"><a href="#cb318-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Boolean</span></span>
<span id="cb318-15"><a href="#cb318-15" aria-hidden="true" tabindex="-1"></a><span class="kw">true</span></span>
<span id="cb318-16"><a href="#cb318-16" aria-hidden="true" tabindex="-1"></a><span class="kw">false</span></span>
<span id="cb318-17"><a href="#cb318-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-18"><a href="#cb318-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Null</span></span>
<span id="cb318-19"><a href="#cb318-19" aria-hidden="true" tabindex="-1"></a><span class="kw">null</span></span></code></pre></div>
<p><strong>Invalid Data:</strong></p>
<div class="sourceCode" id="cb319"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Functions</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;hi&#39;</span>)    [x]</span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a><span class="co">// undefined (use null instead)</span></span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="kw">undefined</span>                  [x]</span>
<span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-7"><a href="#cb319-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Circular references</span></span>
<span id="cb319-8"><a href="#cb319-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> obj <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb319-9"><a href="#cb319-9" aria-hidden="true" tabindex="-1"></a>obj<span class="op">.</span><span class="at">self</span> <span class="op">=</span> obj<span class="op">;</span></span>
<span id="cb319-10"><a href="#cb319-10" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> obj                        [x]</span>
<span id="cb319-11"><a href="#cb319-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-12"><a href="#cb319-12" aria-hidden="true" tabindex="-1"></a><span class="co">// DOM nodes</span></span>
<span id="cb319-13"><a href="#cb319-13" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="at">body</span>              [x]</span></code></pre></div>
<p><strong>Best Practices:</strong></p>
<div class="sourceCode" id="cb320"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: structured data</span></span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.updated&#39;</span><span class="op">,</span></span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span></span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span><span class="op">,</span></span>
<span id="cb320-8"><a href="#cb320-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">updatedAt</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb320-9"><a href="#cb320-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb320-10"><a href="#cb320-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-11"><a href="#cb320-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-12"><a href="#cb320-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: minimal data</span></span>
<span id="cb320-13"><a href="#cb320-13" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb320-14"><a href="#cb320-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.select&#39;</span><span class="op">,</span></span>
<span id="cb320-15"><a href="#cb320-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb320-16"><a href="#cb320-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-17"><a href="#cb320-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-18"><a href="#cb320-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: null for no data</span></span>
<span id="cb320-19"><a href="#cb320-19" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb320-20"><a href="#cb320-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;ui.modal.close&#39;</span><span class="op">,</span></span>
<span id="cb320-21"><a href="#cb320-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb320-22"><a href="#cb320-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-23"><a href="#cb320-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-24"><a href="#cb320-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Acceptable: primitive data</span></span>
<span id="cb320-25"><a href="#cb320-25" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb320-26"><a href="#cb320-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;counter.value&#39;</span><span class="op">,</span></span>
<span id="cb320-27"><a href="#cb320-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> <span class="dv">42</span></span>
<span id="cb320-28"><a href="#cb320-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb320-29"><a href="#cb320-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-30"><a href="#cb320-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad: empty object when null is better</span></span>
<span id="cb320-31"><a href="#cb320-31" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb320-32"><a href="#cb320-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;ui.modal.close&#39;</span><span class="op">,</span></span>
<span id="cb320-33"><a href="#cb320-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {}  <span class="co">// Use null instead</span></span>
<span id="cb320-34"><a href="#cb320-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.3.3" id="id-optional-auto-generated"><span
class="header-section-number">23.3.3</span> id (optional,
auto-generated)</h3>
<p><strong>Type:</strong> <code>string</code> (UUID v4)</p>
<p><strong>Purpose:</strong> Unique identifier for message
deduplication, tracking, and correlation.</p>
<p><strong>Auto-generation:</strong> If not provided, bus generates a
UUID v4.</p>
<p><strong>Format:</strong> Standard UUID format:
<code>xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</code></p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb321"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;550e8400-e29b-41d4-a716-446655440000&#39;</span></span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;7c9e6679-7425-40de-944b-e07fc1f90ae7&#39;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb322"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Let bus generate (recommended)</span></span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb322-4"><a href="#cb322-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb322-5"><a href="#cb322-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// id will be auto-generated</span></span>
<span id="cb322-6"><a href="#cb322-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb322-7"><a href="#cb322-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-8"><a href="#cb322-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Provide custom ID (rare)</span></span>
<span id="cb322-9"><a href="#cb322-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb322-10"><a href="#cb322-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb322-11"><a href="#cb322-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb322-12"><a href="#cb322-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;user-update-123-2024-11-01&#39;</span></span>
<span id="cb322-13"><a href="#cb322-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Deduplication (detect duplicate
messages) - Message tracking in logs - Correlation across systems -
Idempotency keys</p>
<h3 data-number="23.3.4" id="ts-optional-auto-generated"><span
class="header-section-number">23.3.4</span> ts (optional,
auto-generated)</h3>
<p><strong>Type:</strong> <code>number</code> (Unix timestamp in
milliseconds)</p>
<p><strong>Purpose:</strong> Message creation timestamp for ordering and
time-based filtering.</p>
<p><strong>Auto-generation:</strong> If not provided, bus adds
<code>Date.now()</code>.</p>
<p><strong>Format:</strong> Milliseconds since Unix epoch (January 1,
1970 00:00:00 UTC)</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb323"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1699564800000</span>  <span class="co">// 2023-11-10 00:00:00 UTC</span></span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1699651200000</span>  <span class="co">// 2023-11-11 00:00:00 UTC</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb324"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Let bus generate (recommended)</span></span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ts will be auto-generated</span></span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Provide custom timestamp (rare)</span></span>
<span id="cb324-9"><a href="#cb324-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb324-10"><a href="#cb324-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.updated&#39;</span><span class="op">,</span></span>
<span id="cb324-11"><a href="#cb324-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb324-12"><a href="#cb324-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">parse</span>(<span class="st">&#39;2024-11-01T12:00:00Z&#39;</span>)</span>
<span id="cb324-13"><a href="#cb324-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Message ordering - Time-based filtering
- Analytics and logging - Determining message freshness</p>
<p><strong>Working with Timestamps:</strong></p>
<div class="sourceCode" id="cb325"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert to Date object</span></span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(msg<span class="op">.</span><span class="at">ts</span>)<span class="op">;</span></span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Format for display</span></span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> formatted <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(msg<span class="op">.</span><span class="at">ts</span>)<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">;</span></span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a><span class="co">// &quot;2024-11-01T12:00:00.000Z&quot;</span></span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Check message age</span></span>
<span id="cb325-9"><a href="#cb325-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ageMs <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> msg<span class="op">.</span><span class="at">ts</span><span class="op">;</span></span>
<span id="cb325-10"><a href="#cb325-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ageSeconds <span class="op">=</span> ageMs <span class="op">/</span> <span class="dv">1000</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="23.3.5" id="retain-optional"><span
class="header-section-number">23.3.5</span> retain (optional)</h3>
<p><strong>Type:</strong> <code>boolean</code></p>
<p><strong>Purpose:</strong> Indicates message should be retained by bus
and replayed to new subscribers.</p>
<p><strong>Default:</strong> <code>false</code></p>
<p><strong>Constraints:</strong> - Only one message retained per topic
(last value wins) - Subject to LRU eviction if bus retention limit
exceeded - Bus default max retained: 1000 messages (configurable via
<code>max-retained</code>)</p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb326"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish retained state</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;app.theme.state&#39;</span><span class="op">,</span></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> }<span class="op">,</span></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Later subscriber receives immediately</span></span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb326-10"><a href="#cb326-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb326-11"><a href="#cb326-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<p><strong>When to Use:</strong> - Application state (theme, language,
configuration) - List data (current user list, current items) - Session
information (current user, authentication) - Last known values (device
status, connection state)</p>
<p><strong>When NOT to Use:</strong> - Events (one-time notifications) -
High-frequency updates (mouse movements, scroll events) - Temporary
notifications (toasts, alerts) - Bulk data (large lists, file
contents)</p>
<h3 data-number="23.3.6" id="replyto-optional"><span
class="header-section-number">23.3.6</span> replyTo (optional)</h3>
<p><strong>Type:</strong> <code>string</code> (topic name)</p>
<p><strong>Purpose:</strong> Specifies topic where reply should be sent
(request/reply pattern).</p>
<p><strong>Auto-generation:</strong> Auto-generated by
<code>client.request()</code> method.</p>
<p><strong>Format:</strong> Typically
<code>pan:$reply:${clientId}:${correlationId}</code></p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb327"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Manually set replyTo</span></span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">replyTo</span><span class="op">:</span> <span class="st">&#39;users.item.get.reply.abc123&#39;</span><span class="op">,</span></span>
<span id="cb327-6"><a href="#cb327-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">correlationId</span><span class="op">:</span> <span class="st">&#39;req-001&#39;</span></span>
<span id="cb327-7"><a href="#cb327-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb327-8"><a href="#cb327-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb327-9"><a href="#cb327-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to reply</span></span>
<span id="cb327-10"><a href="#cb327-10" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.get.reply.abc123&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb327-11"><a href="#cb327-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Response:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb327-12"><a href="#cb327-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb327-13"><a href="#cb327-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb327-14"><a href="#cb327-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Better: use client.request() (auto-generates replyTo)</span></span>
<span id="cb327-15"><a href="#cb327-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span></code></pre></div>
<p><strong>Responder Pattern:</strong></p>
<div class="sourceCode" id="cb328"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check if reply expected</span></span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>msg<span class="op">.</span><span class="at">replyTo</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> database<span class="op">.</span><span class="fu">getUser</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Send reply to specified topic</span></span>
<span id="cb328-8"><a href="#cb328-8" aria-hidden="true" tabindex="-1"></a>  client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb328-9"><a href="#cb328-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">topic</span><span class="op">:</span> msg<span class="op">.</span><span class="at">replyTo</span><span class="op">,</span></span>
<span id="cb328-10"><a href="#cb328-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">data</span><span class="op">:</span> user <span class="op">?</span> { <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">item</span><span class="op">:</span> user } <span class="op">:</span> { <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Not found&#39;</span> }<span class="op">,</span></span>
<span id="cb328-11"><a href="#cb328-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">correlationId</span><span class="op">:</span> msg<span class="op">.</span><span class="at">correlationId</span></span>
<span id="cb328-12"><a href="#cb328-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb328-13"><a href="#cb328-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="23.3.7" id="correlationid-optional"><span
class="header-section-number">23.3.7</span> correlationId
(optional)</h3>
<p><strong>Type:</strong> <code>string</code> (UUID or custom
identifier)</p>
<p><strong>Purpose:</strong> Correlates replies with original requests
in request/reply pattern.</p>
<p><strong>Auto-generation:</strong> Auto-generated by
<code>client.request()</code> method.</p>
<p><strong>Format:</strong> Typically UUID, but can be any string
identifier.</p>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb329"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Manual correlation (rare)</span></span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> corrId <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb329-5"><a href="#cb329-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb329-6"><a href="#cb329-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb329-7"><a href="#cb329-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">replyTo</span><span class="op">:</span> <span class="st">&#39;users.reply&#39;</span><span class="op">,</span></span>
<span id="cb329-8"><a href="#cb329-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">correlationId</span><span class="op">:</span> corrId</span>
<span id="cb329-9"><a href="#cb329-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb329-10"><a href="#cb329-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-11"><a href="#cb329-11" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.reply&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb329-12"><a href="#cb329-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (msg<span class="op">.</span><span class="at">correlationId</span> <span class="op">===</span> corrId) {</span>
<span id="cb329-13"><a href="#cb329-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Our reply:&#39;</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb329-14"><a href="#cb329-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb329-15"><a href="#cb329-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb329-16"><a href="#cb329-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-17"><a href="#cb329-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Better: use client.request() (auto-correlates)</span></span>
<span id="cb329-18"><a href="#cb329-18" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Request/reply pattern - Tracking
conversation threads - Matching async responses - Distributed
tracing</p>
<h3 data-number="23.3.8" id="headers-optional"><span
class="header-section-number">23.3.8</span> headers (optional)</h3>
<p><strong>Type:</strong> <code>Record&lt;string, string&gt;</code>
(string key-value pairs)</p>
<p><strong>Purpose:</strong> Free-form metadata for custom application
needs.</p>
<p><strong>Constraints:</strong> - Keys and values must be strings - No
reserved header names (yet) - Included in message size calculations</p>
<p><strong>Common Use Cases:</strong></p>
<ul>
<li>User context (userId, sessionId, tenantId)</li>
<li>Distributed tracing (traceId, spanId, parentSpanId)</li>
<li>Source tracking (source, version, environment)</li>
<li>Custom metadata (priority, category, tags)</li>
</ul>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb330"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add headers</span></span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;analytics.event&#39;</span><span class="op">,</span></span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">action</span><span class="op">:</span> <span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;button&#39;</span> }<span class="op">,</span></span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">userId</span><span class="op">:</span> <span class="st">&#39;123&#39;</span><span class="op">,</span></span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sessionId</span><span class="op">:</span> <span class="st">&#39;abc-def-ghi&#39;</span><span class="op">,</span></span>
<span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">source</span><span class="op">:</span> <span class="st">&#39;mobile-app&#39;</span><span class="op">,</span></span>
<span id="cb330-9"><a href="#cb330-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;2.1.0&#39;</span><span class="op">,</span></span>
<span id="cb330-10"><a href="#cb330-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">environment</span><span class="op">:</span> <span class="st">&#39;production&#39;</span></span>
<span id="cb330-11"><a href="#cb330-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb330-12"><a href="#cb330-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb330-13"><a href="#cb330-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-14"><a href="#cb330-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Access headers in subscriber</span></span>
<span id="cb330-15"><a href="#cb330-15" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;analytics.*&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb330-16"><a href="#cb330-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> userId <span class="op">=</span> msg<span class="op">.</span><span class="at">headers</span><span class="op">?.</span><span class="at">userId</span><span class="op">;</span></span>
<span id="cb330-17"><a href="#cb330-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> source <span class="op">=</span> msg<span class="op">.</span><span class="at">headers</span><span class="op">?.</span><span class="at">source</span><span class="op">;</span></span>
<span id="cb330-18"><a href="#cb330-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-19"><a href="#cb330-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logEvent</span>(msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> msg<span class="op">.</span><span class="at">data</span><span class="op">,</span> { userId<span class="op">,</span> source })<span class="op">;</span></span>
<span id="cb330-20"><a href="#cb330-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Distributed Tracing Example:</strong></p>
<div class="sourceCode" id="cb331"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Start trace</span></span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> traceId <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> spanId <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb331-6"><a href="#cb331-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb331-7"><a href="#cb331-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb331-8"><a href="#cb331-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb331-9"><a href="#cb331-9" aria-hidden="true" tabindex="-1"></a>    traceId<span class="op">,</span></span>
<span id="cb331-10"><a href="#cb331-10" aria-hidden="true" tabindex="-1"></a>    spanId<span class="op">,</span></span>
<span id="cb331-11"><a href="#cb331-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">parentSpanId</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb331-12"><a href="#cb331-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb331-13"><a href="#cb331-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb331-14"><a href="#cb331-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb331-15"><a href="#cb331-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Continue trace in handler</span></span>
<span id="cb331-16"><a href="#cb331-16" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> <span class="kw">async</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb331-17"><a href="#cb331-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> childSpanId <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb331-18"><a href="#cb331-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb331-19"><a href="#cb331-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Process with trace context</span></span>
<span id="cb331-20"><a href="#cb331-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> database<span class="op">.</span><span class="fu">getUser</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> {</span>
<span id="cb331-21"><a href="#cb331-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">traceId</span><span class="op">:</span> msg<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">traceId</span><span class="op">,</span></span>
<span id="cb331-22"><a href="#cb331-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">parentSpanId</span><span class="op">:</span> msg<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">spanId</span><span class="op">,</span></span>
<span id="cb331-23"><a href="#cb331-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">spanId</span><span class="op">:</span> childSpanId</span>
<span id="cb331-24"><a href="#cb331-24" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb331-25"><a href="#cb331-25" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="23.3.9" id="clientid-internal"><span
class="header-section-number">23.3.9</span> clientId (internal)</h3>
<p><strong>Type:</strong> <code>string</code></p>
<p><strong>Purpose:</strong> Internal identifier for client that
published the message.</p>
<p><strong>Auto-generation:</strong> Generated by PanClient
constructor.</p>
<p><strong>Format:</strong> <code>${elementTag}#${uuid}</code></p>
<p><strong>Example:</strong>
<code>pan-user-list#7c9e6679-7425-40de-944b</code></p>
<p><strong>Usage:</strong> Primarily for internal bus operations.
Applications typically don’t need to use this field.</p>
<h2 data-number="23.4" id="message-examples"><span
class="header-section-number">23.4</span> Message Examples</h2>
<h3 data-number="23.4.1" id="simple-event"><span
class="header-section-number">23.4.1</span> Simple Event</h3>
<div class="sourceCode" id="cb332"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.updated&#39;</span><span class="op">,</span></span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice Cooper&#39;</span><span class="op">,</span></span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span><span class="op">,</span></span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">updatedAt</span><span class="op">:</span> <span class="dv">1699564800000</span></span>
<span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb332-9"><a href="#cb332-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;550e8400-e29b-41d4-a716-446655440000&#39;</span><span class="op">,</span></span>
<span id="cb332-10"><a href="#cb332-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699564800000</span></span>
<span id="cb332-11"><a href="#cb332-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.4.2" id="retained-state"><span
class="header-section-number">23.4.2</span> Retained State</h3>
<div class="sourceCode" id="cb333"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.list.state&#39;</span><span class="op">,</span></span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> [</span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }<span class="op">,</span></span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Bob&#39;</span> }<span class="op">,</span></span>
<span id="cb333-7"><a href="#cb333-7" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Charlie&#39;</span> }</span>
<span id="cb333-8"><a href="#cb333-8" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb333-9"><a href="#cb333-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb333-10"><a href="#cb333-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb333-11"><a href="#cb333-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb333-12"><a href="#cb333-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;7c9e6679-7425-40de-944b-e07fc1f90ae7&#39;</span><span class="op">,</span></span>
<span id="cb333-13"><a href="#cb333-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699651200000</span><span class="op">,</span></span>
<span id="cb333-14"><a href="#cb333-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retain</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb333-15"><a href="#cb333-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.4.3" id="request-message"><span
class="header-section-number">23.4.3</span> Request Message</h3>
<div class="sourceCode" id="cb334"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.item.get&#39;</span><span class="op">,</span></span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span></span>
<span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d&#39;</span><span class="op">,</span></span>
<span id="cb334-5"><a href="#cb334-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699651200000</span><span class="op">,</span></span>
<span id="cb334-6"><a href="#cb334-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">replyTo</span><span class="op">:</span> <span class="st">&#39;pan:$reply:user-list#abc123:req-001&#39;</span><span class="op">,</span></span>
<span id="cb334-7"><a href="#cb334-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">correlationId</span><span class="op">:</span> <span class="st">&#39;req-001&#39;</span></span>
<span id="cb334-8"><a href="#cb334-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.4.4" id="reply-message"><span
class="header-section-number">23.4.4</span> Reply Message</h3>
<div class="sourceCode" id="cb335"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:$reply:user-list#abc123:req-001&#39;</span><span class="op">,</span></span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">item</span><span class="op">:</span> {</span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span></span>
<span id="cb335-8"><a href="#cb335-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span></span>
<span id="cb335-9"><a href="#cb335-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb335-10"><a href="#cb335-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb335-11"><a href="#cb335-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;b2c3d4e5-f6a7-4b5c-9d0e-1f2a3b4c5d6e&#39;</span><span class="op">,</span></span>
<span id="cb335-12"><a href="#cb335-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699651205000</span><span class="op">,</span></span>
<span id="cb335-13"><a href="#cb335-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">correlationId</span><span class="op">:</span> <span class="st">&#39;req-001&#39;</span></span>
<span id="cb335-14"><a href="#cb335-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.4.5" id="message-with-headers"><span
class="header-section-number">23.4.5</span> Message with Headers</h3>
<div class="sourceCode" id="cb336"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;analytics.page-view&#39;</span><span class="op">,</span></span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="st">&#39;/users/123&#39;</span><span class="op">,</span></span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">duration</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></span>
<span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">referrer</span><span class="op">:</span> <span class="st">&#39;/dashboard&#39;</span></span>
<span id="cb336-7"><a href="#cb336-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb336-8"><a href="#cb336-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;c3d4e5f6-a7b8-4c5d-0e1f-2a3b4c5d6e7f&#39;</span><span class="op">,</span></span>
<span id="cb336-9"><a href="#cb336-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699651200000</span><span class="op">,</span></span>
<span id="cb336-10"><a href="#cb336-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb336-11"><a href="#cb336-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">userId</span><span class="op">:</span> <span class="st">&#39;456&#39;</span><span class="op">,</span></span>
<span id="cb336-12"><a href="#cb336-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sessionId</span><span class="op">:</span> <span class="st">&#39;session-xyz&#39;</span><span class="op">,</span></span>
<span id="cb336-13"><a href="#cb336-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">device</span><span class="op">:</span> <span class="st">&#39;mobile&#39;</span><span class="op">,</span></span>
<span id="cb336-14"><a href="#cb336-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">browser</span><span class="op">:</span> <span class="st">&#39;Chrome&#39;</span><span class="op">,</span></span>
<span id="cb336-15"><a href="#cb336-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;119.0&#39;</span><span class="op">,</span></span>
<span id="cb336-16"><a href="#cb336-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">traceId</span><span class="op">:</span> <span class="st">&#39;trace-abc-def&#39;</span></span>
<span id="cb336-17"><a href="#cb336-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb336-18"><a href="#cb336-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.4.6" id="error-response"><span
class="header-section-number">23.4.6</span> Error Response</h3>
<div class="sourceCode" id="cb337"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:$reply:user-form#xyz789:req-002&#39;</span><span class="op">,</span></span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;User not found&#39;</span><span class="op">,</span></span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;NOT_FOUND&#39;</span><span class="op">,</span></span>
<span id="cb337-7"><a href="#cb337-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">details</span><span class="op">:</span> {</span>
<span id="cb337-8"><a href="#cb337-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">requestedId</span><span class="op">:</span> <span class="dv">999</span><span class="op">,</span></span>
<span id="cb337-9"><a href="#cb337-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="dv">1699651200000</span></span>
<span id="cb337-10"><a href="#cb337-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb337-11"><a href="#cb337-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb337-12"><a href="#cb337-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;d4e5f6a7-b8c9-4d5e-1f2a-3b4c5d6e7f8a&#39;</span><span class="op">,</span></span>
<span id="cb337-13"><a href="#cb337-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ts</span><span class="op">:</span> <span class="dv">1699651210000</span><span class="op">,</span></span>
<span id="cb337-14"><a href="#cb337-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">correlationId</span><span class="op">:</span> <span class="st">&#39;req-002&#39;</span></span>
<span id="cb337-15"><a href="#cb337-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="23.5" id="response-payload-conventions"><span
class="header-section-number">23.5</span> Response Payload
Conventions</h2>
<p>While <code>data</code> can be any JSON value, LARC follows
conventions for response payloads in request/reply patterns:</p>
<h3 data-number="23.5.1" id="success-response"><span
class="header-section-number">23.5.1</span> Success Response</h3>
<div class="sourceCode" id="cb338"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">item</span><span class="op">:</span> { <span class="co">/* single item */</span> }</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a><span class="co">// or for lists</span></span>
<span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb338-9"><a href="#cb338-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">items</span><span class="op">:</span> [ <span class="co">/* array of items */</span> ]<span class="op">,</span></span>
<span id="cb338-10"><a href="#cb338-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">total</span><span class="op">:</span> <span class="dv">100</span></span>
<span id="cb338-11"><a href="#cb338-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.5.2" id="error-response-1"><span
class="header-section-number">23.5.2</span> Error Response</h3>
<div class="sourceCode" id="cb339"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Human-readable error message&#39;</span><span class="op">,</span></span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;ERROR_CODE&#39;</span><span class="op">,</span>           <span class="co">// Optional: machine-readable code</span></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">details</span><span class="op">:</span> { <span class="co">/* context */</span> }     <span class="co">// Optional: additional context</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.5.3" id="example-error-codes"><span
class="header-section-number">23.5.3</span> Example Error Codes</h3>
<div class="sourceCode" id="cb340"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;NOT_FOUND&#39;</span>           <span class="co">// Resource doesn&#39;t exist</span></span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;VALIDATION_ERROR&#39;</span>    <span class="co">// Invalid input</span></span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;UNAUTHORIZED&#39;</span>        <span class="co">// Not authenticated</span></span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;FORBIDDEN&#39;</span>           <span class="co">// Not authorized</span></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;CONFLICT&#39;</span>            <span class="co">// Resource conflict (e.g., duplicate)</span></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;RATE_LIMIT&#39;</span>          <span class="co">// Too many requests</span></span>
<span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;SERVER_ERROR&#39;</span>        <span class="co">// Internal error</span></span>
<span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;TIMEOUT&#39;</span>             <span class="co">// Operation timed out</span></span></code></pre></div>
<h2 data-number="23.6" id="message-size-limits"><span
class="header-section-number">23.6</span> Message Size Limits</h2>
<p>The PAN bus enforces configurable size limits:</p>
<h3 data-number="23.6.1" id="default-limits"><span
class="header-section-number">23.6.1</span> Default Limits</h3>
<ul>
<li><strong>Max message size:</strong> 1MB (1,048,576 bytes)</li>
<li><strong>Max payload size:</strong> 512KB (524,288 bytes)</li>
</ul>
<h3 data-number="23.6.2" id="configuration-1"><span
class="header-section-number">23.6.2</span> Configuration</h3>
<div class="sourceCode" id="cb341"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;2097152&quot;</span></span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span><span class="dt">&gt;</span></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="23.6.3" id="size-estimation"><span
class="header-section-number">23.6.3</span> Size Estimation</h3>
<p>The bus estimates message size by JSON-stringifying and
measuring:</p>
<div class="sourceCode" id="cb342"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">estimateSize</span>(msg) {</span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Blob</span>([<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg)])<span class="op">.</span><span class="at">size</span><span class="op">;</span></span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.6.4" id="handling-size-limits"><span
class="header-section-number">23.6.4</span> Handling Size Limits</h3>
<div class="sourceCode" id="cb343"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Large data: paginate requests</span></span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.list.get&#39;</span><span class="op">,</span> {</span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">limit</span><span class="op">:</span> <span class="dv">50</span>  <span class="co">// Smaller page size</span></span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb343-6"><a href="#cb343-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-7"><a href="#cb343-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Large payloads: use chunking or external storage</span></span>
<span id="cb343-8"><a href="#cb343-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of:</span></span>
<span id="cb343-9"><a href="#cb343-9" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb343-10"><a href="#cb343-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;file.uploaded&#39;</span><span class="op">,</span></span>
<span id="cb343-11"><a href="#cb343-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">fileContents</span><span class="op">:</span> hugeBase64String }  <span class="co">// Too large!</span></span>
<span id="cb343-12"><a href="#cb343-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb343-13"><a href="#cb343-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-14"><a href="#cb343-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do:</span></span>
<span id="cb343-15"><a href="#cb343-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fileId <span class="op">=</span> <span class="cf">await</span> <span class="fu">uploadToStorage</span>(fileContents)<span class="op">;</span></span>
<span id="cb343-16"><a href="#cb343-16" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb343-17"><a href="#cb343-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;file.uploaded&#39;</span><span class="op">,</span></span>
<span id="cb343-18"><a href="#cb343-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { fileId<span class="op">,</span> <span class="dt">url</span><span class="op">:</span> <span class="vs">`/files/</span><span class="sc">${</span>fileId<span class="sc">}</span><span class="vs">`</span> }</span>
<span id="cb343-19"><a href="#cb343-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="23.7" id="validation"><span
class="header-section-number">23.7</span> Validation</h2>
<p>The PAN bus validates messages before processing:</p>
<h3 data-number="23.7.1" id="topic-validation"><span
class="header-section-number">23.7.1</span> Topic Validation</h3>
<div class="sourceCode" id="cb344"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Must be non-empty string</span></span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="st">&#39;&#39;</span>                    [x]</span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="kw">null</span>                  [x]</span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="kw">undefined</span>             [x]</span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Must not be reserved</span></span>
<span id="cb344-7"><a href="#cb344-7" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="st">&#39;pan:publish&#39;</span>         [x] (reserved)</span>
<span id="cb344-8"><a href="#cb344-8" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="st">&#39;pan:subscribe&#39;</span>       [x] (reserved)</span>
<span id="cb344-9"><a href="#cb344-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-10"><a href="#cb344-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Valid</span></span>
<span id="cb344-11"><a href="#cb344-11" aria-hidden="true" tabindex="-1"></a>topic<span class="op">:</span> <span class="st">&#39;users.updated&#39;</span>       [v]</span></code></pre></div>
<h3 data-number="23.7.2" id="data-validation"><span
class="header-section-number">23.7.2</span> Data Validation</h3>
<div class="sourceCode" id="cb345"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Must be JSON-serializable</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> () <span class="kw">=&gt;</span> {}               [x] (<span class="kw">function</span>)</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="at">body</span>          [x] (DOM node)</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="kw">undefined</span>              [x] (use <span class="kw">null</span>)</span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> obj <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a>obj<span class="op">.</span><span class="at">self</span> <span class="op">=</span> obj<span class="op">;</span></span>
<span id="cb345-8"><a href="#cb345-8" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> obj                    [x] (circular reference)</span>
<span id="cb345-9"><a href="#cb345-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-10"><a href="#cb345-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Valid</span></span>
<span id="cb345-11"><a href="#cb345-11" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="kw">null</span>                   [v]</span>
<span id="cb345-12"><a href="#cb345-12" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }            [v]</span>
<span id="cb345-13"><a href="#cb345-13" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]              [v]</span>
<span id="cb345-14"><a href="#cb345-14" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="st">&quot;string&quot;</span>               [v]</span>
<span id="cb345-15"><a href="#cb345-15" aria-hidden="true" tabindex="-1"></a>data<span class="op">:</span> <span class="dv">42</span>                     [v]</span></code></pre></div>
<h3 data-number="23.7.3" id="size-validation"><span
class="header-section-number">23.7.3</span> Size Validation</h3>
<p>Messages exceeding size limits are rejected with error:</p>
<div class="sourceCode" id="cb346"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Error emitted if message too large</span></span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.error&#39;</span><span class="op">,</span></span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MESSAGE_INVALID&#39;</span><span class="op">,</span></span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Message size (2000000 bytes) exceeds limit (1048576 bytes)&#39;</span><span class="op">,</span></span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">details</span><span class="op">:</span> { <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;users.list.state&#39;</span> }</span>
<span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb346-9"><a href="#cb346-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="23.8" id="internal-system-messages"><span
class="header-section-number">23.8</span> Internal System Messages</h2>
<p>Certain system messages are emitted by the bus:</p>
<h3 data-number="23.8.1" id="pansys.ready"><span
class="header-section-number">23.8.1</span> pan:sys.ready</h3>
<p>Emitted when bus initializes:</p>
<div class="sourceCode" id="cb347"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.ready&#39;</span><span class="op">,</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">enhanced</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">routing</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tracing</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">config</span><span class="op">:</span> { <span class="co">/* bus configuration */</span> }</span>
<span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.8.2" id="pansys.error"><span
class="header-section-number">23.8.2</span> pan:sys.error</h3>
<p>Emitted for validation errors, rate limits, etc:</p>
<div class="sourceCode" id="cb348"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.error&#39;</span><span class="op">,</span></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;RATE_LIMIT_EXCEEDED&#39;</span><span class="op">,</span></span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Too many messages&#39;</span><span class="op">,</span></span>
<span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">details</span><span class="op">:</span> { <span class="dt">clientId</span><span class="op">:</span> <span class="st">&#39;user-list#abc&#39;</span> }</span>
<span id="cb348-7"><a href="#cb348-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb348-8"><a href="#cb348-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="23.8.3" id="pansys.stats"><span
class="header-section-number">23.8.3</span> pan:sys.stats</h3>
<p>Response to stats request:</p>
<div class="sourceCode" id="cb349"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">published</span><span class="op">:</span> <span class="dv">1234</span><span class="op">,</span></span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">delivered</span><span class="op">:</span> <span class="dv">5678</span><span class="op">,</span></span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dropped</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">retainedEvicted</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">subsCleanedUp</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">errors</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">subscriptions</span><span class="op">:</span> <span class="dv">18</span><span class="op">,</span></span>
<span id="cb349-11"><a href="#cb349-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">clients</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb349-12"><a href="#cb349-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">retained</span><span class="op">:</span> <span class="dv">42</span><span class="op">,</span></span>
<span id="cb349-13"><a href="#cb349-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">config</span><span class="op">:</span> { <span class="co">/* current config */</span> }</span>
<span id="cb349-14"><a href="#cb349-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb349-15"><a href="#cb349-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="23.9" id="summary-6"><span
class="header-section-number">23.9</span> Summary</h2>
<p><strong>Required Fields:</strong> - <code>topic</code> (string) -
Message routing address - <code>data</code> (any) - JSON-serializable
payload</p>
<p><strong>Auto-Generated Fields:</strong></p>
<ul>
<li><code>id</code> (string) - UUID for deduplication/tracking</li>
<li><code>ts</code> (number) - Unix timestamp in milliseconds</li>
</ul>
<p><strong>Feature Fields:</strong> - <code>retain</code> (boolean) -
Retain for late subscribers - <code>replyTo</code> (string) - Reply
destination topic - <code>correlationId</code> (string) - Request/reply
correlation - <code>headers</code> (object) - Custom metadata</p>
<p><strong>Constraints:</strong> - Topic: non-empty string, max 256
chars - Data: JSON-serializable, max 512KB (configurable) - Total
message: max 1MB (configurable) - Headers: string key-value pairs
only</p>
<p><strong>Best Practices:</strong> - Let bus auto-generate
<code>id</code> and <code>ts</code> - Use structured objects for
<code>data</code> - Use <code>retain: true</code> only for actual state
- Follow response conventions (<code>ok</code>, <code>error</code>,
<code>code</code>) - Include relevant context in <code>headers</code>
for tracing - Keep messages small; paginate or reference external
storage</p>
<p>For topic naming conventions, see Appendix A. For configuration
options, see Appendix C.</p>
<h1 data-number="24" id="configuration-options"><span
class="header-section-number">24</span> Configuration Options</h1>
<p>This appendix provides a comprehensive reference for all
configuration options available in LARC, from PAN bus settings to
component configuration, global defaults, and environment variables.
These settings control performance characteristics, security policies,
feature flags, and operational behavior.</p>
<h2 data-number="24.1" id="pan-bus-configuration"><span
class="header-section-number">24.1</span> PAN Bus Configuration</h2>
<p>The <code>&lt;pan-bus&gt;</code> element accepts configuration
through HTML attributes. These settings control the bus’s behavior,
resource limits, and enabled features.</p>
<h3 data-number="24.1.1" id="attribute-reference"><span
class="header-section-number">24.1.1</span> Attribute Reference</h3>
<h4 data-number="24.1.1.1" id="max-retained"><span
class="header-section-number">24.1.1.1</span> max-retained</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>1000</code> <strong>Range:</strong> <code>1</code> to
<code>100000</code> <strong>Purpose:</strong> Maximum number of retained
messages stored by the bus.</p>
<p>When this limit is exceeded, the bus evicts the least recently
accessed retained message (LRU eviction).</p>
<div class="sourceCode" id="cb350"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> max-retained</span><span class="op">=</span><span class="st">&quot;5000&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Use Cases:</strong> - Small apps with minimal state:
<code>100-500</code> - Medium apps: <code>1000-2000</code> (default:
<code>1000</code>) - Large apps with extensive state:
<code>5000-10000</code></p>
<p><strong>Performance Impact:</strong></p>
<ul>
<li>Higher values: More memory usage, slower eviction checks</li>
<li>Lower values: Less memory, faster eviction, more message loss</li>
</ul>
<p><strong>Monitoring:</strong></p>
<div class="sourceCode" id="cb351"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Retained:&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retained</span>)<span class="op">;</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Evicted:&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retainedEvicted</span>)<span class="op">;</span></span></code></pre></div>
<h4 data-number="24.1.1.2" id="max-message-size"><span
class="header-section-number">24.1.1.2</span> max-message-size</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>1048576</code> (1MB) <strong>Range:</strong> <code>1024</code> to
<code>10485760</code> (1KB to 10MB) <strong>Purpose:</strong> Maximum
total size of a message envelope in bytes.</p>
<p>Includes all fields: topic, data, headers, id, ts, etc.</p>
<div class="sourceCode" id="cb352"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> max-message-size</span><span class="op">=</span><span class="st">&quot;2097152&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Recommendations:</strong> - Default <code>1048576</code>
(1MB) suitable for most apps - Increase for apps with large payloads
(analytics, file metadata) - Decrease for memory-constrained
environments (IoT, embedded)</p>
<p><strong>Enforcement:</strong></p>
<div class="sourceCode" id="cb353"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Message rejected if too large</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.error&#39;</span><span class="op">,</span></span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MESSAGE_INVALID&#39;</span><span class="op">,</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Message size (2000000 bytes) exceeds limit (1048576 bytes)&#39;</span></span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 data-number="24.1.1.3" id="max-payload-size"><span
class="header-section-number">24.1.1.3</span> max-payload-size</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>524288</code> (512KB) <strong>Range:</strong> <code>1024</code> to
<code>5242880</code> (1KB to 5MB) <strong>Purpose:</strong> Maximum size
of message <code>data</code> field in bytes.</p>
<p>Separate limit for payload to prevent large data objects from
consuming resources.</p>
<div class="sourceCode" id="cb354"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> max-payload-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Relationship to max-message-size:</strong></p>
<pre><code>max-payload-size &lt;= max-message-size</code></pre>
<p><strong>Best Practice:</strong> Set <code>max-payload-size</code> to
50-70% of <code>max-message-size</code> to leave room for headers and
metadata.</p>
<h4 data-number="24.1.1.4" id="cleanup-interval"><span
class="header-section-number">24.1.1.4</span> cleanup-interval</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>30000</code> (30 seconds) <strong>Range:</strong>
<code>1000</code> to <code>300000</code> (1s to 5min)
<strong>Purpose:</strong> Interval in milliseconds between automatic
cleanup cycles.</p>
<p>The bus periodically removes dead subscriptions (components removed
from DOM) and stale rate limit data.</p>
<div class="sourceCode" id="cb356"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> cleanup-interval</span><span class="op">=</span><span class="st">&quot;60000&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Tuning:</strong> - Frequent cleanup (10-20s): Lower memory,
higher CPU - Infrequent cleanup (60-120s): Higher memory, lower CPU -
Default (30s): Balanced</p>
<p><strong>Monitoring:</strong></p>
<div class="sourceCode" id="cb357"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Cleaned up:&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">subsCleanedUp</span>)<span class="op">;</span></span></code></pre></div>
<h4 data-number="24.1.1.5" id="rate-limit"><span
class="header-section-number">24.1.1.5</span> rate-limit</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>1000</code> <strong>Range:</strong> <code>1</code> to
<code>100000</code> <strong>Purpose:</strong> Maximum messages per
client per rate limit window.</p>
<p>Prevents a single client from overwhelming the bus.</p>
<div class="sourceCode" id="cb358"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> rate-limit</span><span class="op">=</span><span class="st">&quot;5000&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Calculation:</strong></p>
<pre><code>messages_per_second = rate-limit / (rate-limit-window / 1000)

Default: 1000 / (1000 / 1000) = 1000 messages/second</code></pre>
<p><strong>Rate Limit Exceeded:</strong></p>
<div class="sourceCode" id="cb360"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Message rejected</span></span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.error&#39;</span><span class="op">,</span></span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;RATE_LIMIT_EXCEEDED&#39;</span><span class="op">,</span></span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Too many messages&#39;</span><span class="op">,</span></span>
<span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">details</span><span class="op">:</span> { <span class="dt">clientId</span><span class="op">:</span> <span class="st">&#39;user-list#abc123&#39;</span> }</span>
<span id="cb360-8"><a href="#cb360-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb360-9"><a href="#cb360-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Recommendations:</strong> - Development:
<code>1000-5000</code> (relaxed) - Production: <code>1000-2000</code>
(default) - High-throughput apps: <code>5000-10000</code></p>
<h4 data-number="24.1.1.6" id="rate-limit-window"><span
class="header-section-number">24.1.1.6</span> rate-limit-window</h4>
<p><strong>Type:</strong> Integer <strong>Default:</strong>
<code>1000</code> (1 second) <strong>Range:</strong> <code>100</code> to
<code>60000</code> (100ms to 1min) <strong>Purpose:</strong> Time window
in milliseconds for rate limiting.</p>
<p>Works together with <code>rate-limit</code> to determine messages per
time window.</p>
<div class="sourceCode" id="cb361"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> rate-limit</span><span class="op">=</span><span class="st">&quot;2000&quot;</span><span class="ot"> rate-limit-window</span><span class="op">=</span><span class="st">&quot;2000&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p>This allows 2000 messages per 2 seconds = 1000 messages/second.</p>
<h4 data-number="24.1.1.7" id="allow-global-wildcard"><span
class="header-section-number">24.1.1.7</span> allow-global-wildcard</h4>
<p><strong>Type:</strong> Boolean <strong>Default:</strong>
<code>true</code> <strong>Purpose:</strong> Allow or disallow global
wildcard (<code>*</code>) subscriptions.</p>
<p>Global wildcard subscriptions match every message in the system.
Disabling can improve security and performance.</p>
<div class="sourceCode" id="cb362"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>When Disabled:</strong></p>
<div class="sourceCode" id="cb363"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscription rejected</span></span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Error: Global wildcard (*) subscriptions are disabled for security</span></span></code></pre></div>
<p><strong>Recommendations:</strong> - Development: <code>true</code>
(useful for debugging) - Production: <code>false</code>
(security/performance)</p>
<h4 data-number="24.1.1.8" id="debug"><span
class="header-section-number">24.1.1.8</span> debug</h4>
<p><strong>Type:</strong> Boolean <strong>Default:</strong>
<code>false</code> <strong>Purpose:</strong> Enable detailed console
logging of bus operations.</p>
<div class="sourceCode" id="cb364"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Output Examples:</strong></p>
<pre><code>[PAN Bus] PAN Bus Enhanced ready { maxRetained: 1000, ... }
[PAN Bus] Client registered { id: &#39;user-list#abc&#39;, caps: [&#39;client&#39;] }
[PAN Bus] Subscription added { pattern: &#39;users.*&#39;, clientId: &#39;user-list#abc&#39; }
[PAN Bus] Published { topic: &#39;users.updated&#39;, delivered: 3, routes: 0 }
[PAN Bus] Cleaned up 2 dead subscriptions</code></pre>
<p><strong>Performance Impact:</strong> Minimal (logging is cheap), but
avoid in production.</p>
<h4 data-number="24.1.1.9" id="enable-routing"><span
class="header-section-number">24.1.1.9</span> enable-routing</h4>
<p><strong>Type:</strong> Boolean <strong>Default:</strong>
<code>false</code> <strong>Purpose:</strong> Enable the advanced routing
system for message transformation and filtering.</p>
<div class="sourceCode" id="cb366"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> enable-routing</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Features Enabled:</strong></p>
<ul>
<li>Declarative routing rules</li>
<li>Message transformation</li>
<li>Message filtering</li>
<li>Topic aliasing</li>
<li>Conditional routing</li>
</ul>
<p><strong>Access Routing API:</strong></p>
<div class="sourceCode" id="cb367"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Routes available at window.pan.routes</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">routes</span><span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;user-events-to-analytics&#39;</span><span class="op">,</span></span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">match</span><span class="op">:</span> <span class="st">&#39;users.item.*&#39;</span><span class="op">,</span></span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">transform</span><span class="op">:</span> (msg) <span class="kw">=&gt;</span> ({</span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;analytics.event&#39;</span><span class="op">,</span></span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">data</span><span class="op">:</span> { <span class="dt">entity</span><span class="op">:</span> <span class="st">&#39;user&#39;</span><span class="op">,</span> <span class="dt">action</span><span class="op">:</span> msg<span class="op">.</span><span class="at">topic</span><span class="op">,</span> <span class="op">...</span>msg<span class="op">.</span><span class="at">data</span> }</span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Performance Impact:</strong> Slight overhead per message for
route matching.</p>
<h4 data-number="24.1.1.10" id="enable-tracing"><span
class="header-section-number">24.1.1.10</span> enable-tracing</h4>
<p><strong>Type:</strong> Boolean <strong>Default:</strong>
<code>false</code> <strong>Purpose:</strong> Enable message tracing for
debugging and monitoring.</p>
<div class="sourceCode" id="cb368"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="ot"> enable-tracing</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Features Enabled:</strong></p>
<ul>
<li>Message flow visualization</li>
<li>Delivery tracking</li>
<li>Route matching logs</li>
<li>Performance metrics</li>
</ul>
<p><strong>Access Tracing API:</strong></p>
<div class="sourceCode" id="cb369"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Debug manager available at window.pan.debug</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> traces <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="at">debug</span><span class="op">.</span><span class="fu">getTraces</span>()<span class="op">;</span></span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Recent traces:&#39;</span><span class="op">,</span> traces)<span class="op">;</span></span></code></pre></div>
<h3 data-number="24.1.2" id="complete-configuration-example"><span
class="header-section-number">24.1.2</span> Complete Configuration
Example</h3>
<div class="sourceCode" id="cb370"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>My LARC App<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    max-retained</span><span class="op">=</span><span class="st">&quot;2000&quot;</span></span>
<span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a><span class="ot">    max-message-size</span><span class="op">=</span><span class="st">&quot;2097152&quot;</span></span>
<span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a><span class="ot">    max-payload-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span></span>
<span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    cleanup-interval</span><span class="op">=</span><span class="st">&quot;60000&quot;</span></span>
<span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a><span class="ot">    rate-limit</span><span class="op">=</span><span class="st">&quot;5000&quot;</span></span>
<span id="cb370-13"><a href="#cb370-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    rate-limit-window</span><span class="op">=</span><span class="st">&quot;1000&quot;</span></span>
<span id="cb370-14"><a href="#cb370-14" aria-hidden="true" tabindex="-1"></a><span class="ot">    allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb370-15"><a href="#cb370-15" aria-hidden="true" tabindex="-1"></a><span class="ot">    debug</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb370-16"><a href="#cb370-16" aria-hidden="true" tabindex="-1"></a><span class="ot">    enable-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb370-17"><a href="#cb370-17" aria-hidden="true" tabindex="-1"></a><span class="ot">    enable-tracing</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;</span></span>
<span id="cb370-18"><a href="#cb370-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span>
<span id="cb370-19"><a href="#cb370-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-20"><a href="#cb370-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">my-app</span><span class="dt">&gt;&lt;/</span><span class="kw">my-app</span><span class="dt">&gt;</span></span>
<span id="cb370-21"><a href="#cb370-21" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb370-22"><a href="#cb370-22" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="24.2" id="panclient-configuration"><span
class="header-section-number">24.2</span> PanClient Configuration</h2>
<p>The <code>PanClient</code> class accepts configuration through
constructor parameters and method options.</p>
<h3 data-number="24.2.1" id="constructor-options-1"><span
class="header-section-number">24.2.1</span> Constructor Options</h3>
<div class="sourceCode" id="cb371"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">PanClient</span>(host<span class="op">?,</span> busSelector<span class="op">?</span>)</span></code></pre></div>
<h4 data-number="24.2.1.1" id="host"><span
class="header-section-number">24.2.1.1</span> host</h4>
<p><strong>Type:</strong> <code>HTMLElement | Document</code>
<strong>Default:</strong> <code>document</code>
<strong>Purpose:</strong> Element to dispatch/receive events from.</p>
<div class="sourceCode" id="cb372"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Default: document-level client</span></span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>()<span class="op">;</span></span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Component-scoped client</span></span>
<span id="cb372-5"><a href="#cb372-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb372-6"><a href="#cb372-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb372-7"><a href="#cb372-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">client</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb372-8"><a href="#cb372-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb372-9"><a href="#cb372-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Use Cases:</strong> - Document-level (<code>document</code>):
Most common, global communication - Component-scoped (element): Isolated
communication within subtree</p>
<h4 data-number="24.2.1.2" id="busselector"><span
class="header-section-number">24.2.1.2</span> busSelector</h4>
<p><strong>Type:</strong> <code>string</code> <strong>Default:</strong>
<code>'pan-bus'</code> <strong>Purpose:</strong> CSS selector for bus
element.</p>
<div class="sourceCode" id="cb373"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Default selector</span></span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="bu">document</span><span class="op">,</span> <span class="st">&#39;pan-bus&#39;</span>)<span class="op">;</span></span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom selector</span></span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> client <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanClient</span>(<span class="bu">document</span><span class="op">,</span> <span class="st">&#39;#my-custom-bus&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p>Rarely needed unless using multiple buses or custom naming.</p>
<h3 data-number="24.2.2" id="subscription-options"><span
class="header-section-number">24.2.2</span> Subscription Options</h3>
<div class="sourceCode" id="cb374"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(topics<span class="op">,</span> handler<span class="op">,</span> options<span class="op">?</span>)</span></code></pre></div>
<h4 data-number="24.2.2.1" id="retained"><span
class="header-section-number">24.2.2.1</span> retained</h4>
<p><strong>Type:</strong> <code>boolean</code> <strong>Default:</strong>
<code>false</code> <strong>Purpose:</strong> Receive retained messages
immediately upon subscription.</p>
<div class="sourceCode" id="cb375"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current state immediately</span></span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.state&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<p><strong>Behavior:</strong> - <code>true</code>: Receives retained
message immediately (if exists), then future messages -
<code>false</code>: Only receives messages published after
subscription</p>
<h4 data-number="24.2.2.2" id="signal"><span
class="header-section-number">24.2.2.2</span> signal</h4>
<p><strong>Type:</strong> <code>AbortSignal</code>
<strong>Default:</strong> <code>undefined</code>
<strong>Purpose:</strong> Automatically unsubscribe when signal is
aborted.</p>
<div class="sourceCode" id="cb376"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> controller <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;users.*&#39;</span><span class="op">,</span> handler<span class="op">,</span> {</span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">signal</span><span class="op">:</span> controller<span class="op">.</span><span class="at">signal</span></span>
<span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb376-6"><a href="#cb376-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-7"><a href="#cb376-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Later: unsubscribe all at once</span></span>
<span id="cb376-8"><a href="#cb376-8" aria-hidden="true" tabindex="-1"></a>controller<span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span></code></pre></div>
<p><strong>Use Case:</strong> Clean up multiple subscriptions with
single abort.</p>
<h3 data-number="24.2.3" id="request-options"><span
class="header-section-number">24.2.3</span> Request Options</h3>
<div class="sourceCode" id="cb377"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">request</span>(topic<span class="op">,</span> data<span class="op">,</span> options<span class="op">?</span>)</span></code></pre></div>
<h4 data-number="24.2.3.1" id="timeoutms"><span
class="header-section-number">24.2.3.1</span> timeoutMs</h4>
<p><strong>Type:</strong> <code>number</code> <strong>Default:</strong>
<code>5000</code> (5 seconds) <strong>Range:</strong> <code>100</code>
to <code>300000</code> (100ms to 5min) <strong>Purpose:</strong> Maximum
time to wait for reply before timeout error.</p>
<div class="sourceCode" id="cb378"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Default timeout</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom timeout</span></span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;slow.operation&#39;</span><span class="op">,</span> { <span class="op">...</span> }<span class="op">,</span> {</span>
<span id="cb378-6"><a href="#cb378-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">timeoutMs</span><span class="op">:</span> <span class="dv">30000</span>  <span class="co">// 30 seconds</span></span>
<span id="cb378-7"><a href="#cb378-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Timeout Error:</strong></p>
<div class="sourceCode" id="cb379"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;users.item.get&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> }<span class="op">,</span> { <span class="dt">timeoutMs</span><span class="op">:</span> <span class="dv">1000</span> })<span class="op">;</span></span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> (err) {</span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(err<span class="op">.</span><span class="at">message</span>)<span class="op">;</span>  <span class="co">// &quot;PAN request timeout&quot;</span></span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Recommendations:</strong> - Fast queries:
<code>1000-2000ms</code> - Standard requests: <code>5000ms</code>
(default) - Slow operations: <code>10000-30000ms</code> - Long-running
tasks: Consider async pattern instead</p>
<h2 data-number="24.3" id="component-configuration"><span
class="header-section-number">24.3</span> Component Configuration</h2>
<p>LARC components can be configured through attributes, properties, and
data attributes.</p>
<h3 data-number="24.3.1" id="standard-attributes"><span
class="header-section-number">24.3.1</span> Standard Attributes</h3>
<p>Most LARC components follow these conventions:</p>
<h4 data-number="24.3.1.1" id="data--attributes"><span
class="header-section-number">24.3.1.1</span> data-* Attributes</h4>
<p>Use for configuration and initial values:</p>
<div class="sourceCode" id="cb380"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-user-list</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  data-page-size</span><span class="op">=</span><span class="st">&quot;50&quot;</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  data-sort</span><span class="op">=</span><span class="st">&quot;name-asc&quot;</span></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  data-filter</span><span class="op">=</span><span class="st">&quot;active&quot;</span><span class="dt">&gt;</span></span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-user-list</span><span class="dt">&gt;</span></span></code></pre></div>
<h4 data-number="24.3.1.2" id="boolean-attributes"><span
class="header-section-number">24.3.1.2</span> Boolean Attributes</h4>
<p>Use presence/absence for boolean flags:</p>
<div class="sourceCode" id="cb381"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Feature enabled --&gt;</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-data-grid</span><span class="ot"> sortable filterable paginated</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-data-grid</span><span class="dt">&gt;</span></span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Feature disabled --&gt;</span></span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-data-grid</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-data-grid</span><span class="dt">&gt;</span></span></code></pre></div>
<h4 data-number="24.3.1.3" id="value-attributes"><span
class="header-section-number">24.3.1.3</span> Value Attributes</h4>
<p>Use for string/number values:</p>
<div class="sourceCode" id="cb382"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-modal</span></span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  size</span><span class="op">=</span><span class="st">&quot;large&quot;</span></span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  position</span><span class="op">=</span><span class="st">&quot;center&quot;</span></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  backdrop</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-modal</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.3.2" id="component-specific-configuration"><span
class="header-section-number">24.3.2</span> Component-Specific
Configuration</h3>
<p>Configuration varies by component. Refer to component documentation
for specifics.</p>
<p><strong>Example: pan-storage</strong></p>
<div class="sourceCode" id="cb383"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-storage</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  key</span><span class="op">=</span><span class="st">&quot;my-app-state&quot;</span></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  storage</span><span class="op">=</span><span class="st">&quot;localStorage&quot;</span></span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  sync</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  debounce</span><span class="op">=</span><span class="st">&quot;1000&quot;</span><span class="dt">&gt;</span></span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-storage</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Example: pan-routes</strong></p>
<div class="sourceCode" id="cb384"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-routes</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  base-path</span><span class="op">=</span><span class="st">&quot;/app&quot;</span></span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  hash-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  scroll-restoration</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-routes</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="24.4" id="global-configuration"><span
class="header-section-number">24.4</span> Global Configuration</h2>
<p>Global configuration affects all LARC components and clients.</p>
<h3 data-number="24.4.1" id="window-configuration"><span
class="header-section-number">24.4.1</span> Window Configuration</h3>
<p>Configure LARC globally before bus initialization:</p>
<div class="sourceCode" id="cb385"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">LARC_CONFIG</span> <span class="op">=</span> {</span>
<span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bus</span><span class="op">:</span> {</span>
<span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxRetained</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">debug</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb385-6"><a href="#cb385-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb385-7"><a href="#cb385-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">defaults</span><span class="op">:</span> {</span>
<span id="cb385-8"><a href="#cb385-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">requestTimeout</span><span class="op">:</span> <span class="dv">10000</span><span class="op">,</span></span>
<span id="cb385-9"><a href="#cb385-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">retainedSubscription</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb385-10"><a href="#cb385-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb385-11"><a href="#cb385-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb385-12"><a href="#cb385-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb385-13"><a href="#cb385-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-14"><a href="#cb385-14" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Note:</strong> This is a proposed pattern. Current
implementation uses attributes only.</p>
<h3 data-number="24.4.2" id="feature-flags"><span
class="header-section-number">24.4.2</span> Feature Flags</h3>
<p>Control experimental or optional features:</p>
<div class="sourceCode" id="cb386"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">LARC_FEATURES</span> <span class="op">=</span> {</span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">routing</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tracing</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb386-4"><a href="#cb386-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">devtools</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb386-5"><a href="#cb386-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 data-number="24.5" id="environment-variables"><span
class="header-section-number">24.5</span> Environment Variables</h2>
<p>For build-time configuration, use environment variables:</p>
<h3 data-number="24.5.1" id="node_env"><span
class="header-section-number">24.5.1</span> NODE_ENV</h3>
<p><strong>Values:</strong> <code>development</code> |
<code>production</code> | <code>test</code> <strong>Purpose:</strong>
Affects default behavior and optimizations.</p>
<div class="sourceCode" id="cb387"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="va">NODE_ENV</span><span class="op">=</span>production <span class="ex">npm</span> run build</span></code></pre></div>
<p><strong>Impact:</strong> - <code>development</code>: Debug logging,
dev warnings, relaxed limits - <code>production</code>: Optimized, no
debug output, strict limits - <code>test</code>: Test-specific behavior,
mocked services</p>
<h3 data-number="24.5.2" id="larc_debug"><span
class="header-section-number">24.5.2</span> LARC_DEBUG</h3>
<p><strong>Values:</strong> <code>true</code> | <code>false</code>
<strong>Purpose:</strong> Override debug mode regardless of
NODE_ENV.</p>
<div class="sourceCode" id="cb388"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="va">LARC_DEBUG</span><span class="op">=</span>true <span class="ex">npm</span> start</span></code></pre></div>
<h3 data-number="24.5.3" id="larc_max_retained"><span
class="header-section-number">24.5.3</span> LARC_MAX_RETAINED</h3>
<p><strong>Values:</strong> Integer <strong>Purpose:</strong> Override
default max retained messages.</p>
<div class="sourceCode" id="cb389"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="va">LARC_MAX_RETAINED</span><span class="op">=</span>5000 <span class="ex">npm</span> start</span></code></pre></div>
<h3 data-number="24.5.4" id="larc_rate_limit"><span
class="header-section-number">24.5.4</span> LARC_RATE_LIMIT</h3>
<p><strong>Values:</strong> Integer <strong>Purpose:</strong> Override
default rate limit.</p>
<div class="sourceCode" id="cb390"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="va">LARC_RATE_LIMIT</span><span class="op">=</span>10000 <span class="ex">npm</span> start</span></code></pre></div>
<h2 data-number="24.6" id="configuration-profiles"><span
class="header-section-number">24.6</span> Configuration Profiles</h2>
<p>Recommended configuration profiles for different scenarios:</p>
<h3 data-number="24.6.1" id="development-profile"><span
class="header-section-number">24.6.1</span> Development Profile</h3>
<p><strong>Focus:</strong> Developer experience, debugging, relaxed
limits</p>
<div class="sourceCode" id="cb391"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;500&quot;</span></span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span></span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;524288&quot;</span></span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  cleanup-interval</span><span class="op">=</span><span class="st">&quot;30000&quot;</span></span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;10000&quot;</span></span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-tracing</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb391-11"><a href="#cb391-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.6.2" id="production-profile"><span
class="header-section-number">24.6.2</span> Production Profile</h3>
<p><strong>Focus:</strong> Performance, security, resource limits</p>
<div class="sourceCode" id="cb392"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;2000&quot;</span></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span></span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;524288&quot;</span></span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  cleanup-interval</span><span class="op">=</span><span class="st">&quot;60000&quot;</span></span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;2000&quot;</span></span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb392-10"><a href="#cb392-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-tracing</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;</span></span>
<span id="cb392-11"><a href="#cb392-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.6.3" id="high-throughput-profile"><span
class="header-section-number">24.6.3</span> High-Throughput Profile</h3>
<p><strong>Focus:</strong> Maximum message volume, relaxed limits</p>
<div class="sourceCode" id="cb393"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;5000&quot;</span></span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;2097152&quot;</span></span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span></span>
<span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  cleanup-interval</span><span class="op">=</span><span class="st">&quot;120000&quot;</span></span>
<span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;10000&quot;</span></span>
<span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit-window</span><span class="op">=</span><span class="st">&quot;1000&quot;</span></span>
<span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb393-10"><a href="#cb393-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-routing</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb393-11"><a href="#cb393-11" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-tracing</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;</span></span>
<span id="cb393-12"><a href="#cb393-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.6.4" id="memory-constrained-profile"><span
class="header-section-number">24.6.4</span> Memory-Constrained
Profile</h3>
<p><strong>Focus:</strong> Minimal memory footprint</p>
<div class="sourceCode" id="cb394"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;100&quot;</span></span>
<span id="cb394-3"><a href="#cb394-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;262144&quot;</span></span>
<span id="cb394-4"><a href="#cb394-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;131072&quot;</span></span>
<span id="cb394-5"><a href="#cb394-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  cleanup-interval</span><span class="op">=</span><span class="st">&quot;15000&quot;</span></span>
<span id="cb394-6"><a href="#cb394-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;500&quot;</span></span>
<span id="cb394-7"><a href="#cb394-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb394-8"><a href="#cb394-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb394-9"><a href="#cb394-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb394-10"><a href="#cb394-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-tracing</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;</span></span>
<span id="cb394-11"><a href="#cb394-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.6.5" id="testing-profile"><span
class="header-section-number">24.6.5</span> Testing Profile</h3>
<p><strong>Focus:</strong> Predictable behavior, fast cleanup</p>
<div class="sourceCode" id="cb395"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;50&quot;</span></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-message-size</span><span class="op">=</span><span class="st">&quot;1048576&quot;</span></span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-payload-size</span><span class="op">=</span><span class="st">&quot;524288&quot;</span></span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  cleanup-interval</span><span class="op">=</span><span class="st">&quot;5000&quot;</span></span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;1000&quot;</span></span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a><span class="ot">  allow-global-wildcard</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-routing</span><span class="op">=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  enable-tracing</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="24.7" id="runtime-configuration"><span
class="header-section-number">24.7</span> Runtime Configuration</h2>
<p>Some settings can be changed at runtime through the bus API.</p>
<h3 data-number="24.7.1" id="get-current-configuration"><span
class="header-section-number">24.7.1</span> Get Current
Configuration</h3>
<div class="sourceCode" id="cb396"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Config:&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">config</span>)<span class="op">;</span></span></code></pre></div>
<h3 data-number="24.7.2" id="clear-retained-messages"><span
class="header-section-number">24.7.2</span> Clear Retained Messages</h3>
<div class="sourceCode" id="cb397"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear all retained messages</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.clear-retained&#39;</span><span class="op">,</span></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> {}</span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Clear matching pattern</span></span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>client<span class="op">.</span><span class="fu">publish</span>({</span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">topic</span><span class="op">:</span> <span class="st">&#39;pan:sys.clear-retained&#39;</span><span class="op">,</span></span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">data</span><span class="op">:</span> { <span class="dt">pattern</span><span class="op">:</span> <span class="st">&#39;users.*&#39;</span> }</span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="24.7.3" id="get-statistics"><span
class="header-section-number">24.7.3</span> Get Statistics</h3>
<div class="sourceCode" id="cb398"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>({</span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">published</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">published</span><span class="op">,</span></span>
<span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">delivered</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">delivered</span><span class="op">,</span></span>
<span id="cb398-6"><a href="#cb398-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">dropped</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">dropped</span><span class="op">,</span></span>
<span id="cb398-7"><a href="#cb398-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retained</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retained</span><span class="op">,</span></span>
<span id="cb398-8"><a href="#cb398-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">retainedEvicted</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retainedEvicted</span><span class="op">,</span></span>
<span id="cb398-9"><a href="#cb398-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">subsCleanedUp</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">subsCleanedUp</span><span class="op">,</span></span>
<span id="cb398-10"><a href="#cb398-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">errors</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">errors</span><span class="op">,</span></span>
<span id="cb398-11"><a href="#cb398-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">subscriptions</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">,</span></span>
<span id="cb398-12"><a href="#cb398-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">clients</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">clients</span></span>
<span id="cb398-13"><a href="#cb398-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="24.8" id="configuration-best-practices"><span
class="header-section-number">24.8</span> Configuration Best
Practices</h2>
<h3 data-number="24.8.1" id="start-conservative"><span
class="header-section-number">24.8.1</span> Start Conservative</h3>
<p>Begin with default settings:</p>
<div class="sourceCode" id="cb399"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Monitor with stats, adjust only when needed.</p>
<h3 data-number="24.8.2" id="monitor-and-tune"><span
class="header-section-number">24.8.2</span> Monitor and Tune</h3>
<div class="sourceCode" id="cb400"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Periodic monitoring</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a><span class="pp">setInterval</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;pan:sys.stats&#39;</span><span class="op">,</span> {})<span class="op">;</span></span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Bus Health:&#39;</span><span class="op">,</span> {</span>
<span id="cb400-6"><a href="#cb400-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">retained</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retained</span><span class="sc">}</span><span class="vs"> / </span><span class="sc">${</span>stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="at">maxRetained</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb400-7"><a href="#cb400-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dropped</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">dropped</span><span class="op">,</span></span>
<span id="cb400-8"><a href="#cb400-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">errors</span><span class="op">:</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">errors</span></span>
<span id="cb400-9"><a href="#cb400-9" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb400-10"><a href="#cb400-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-11"><a href="#cb400-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Alert if approaching limits</span></span>
<span id="cb400-12"><a href="#cb400-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">retained</span> <span class="op">&gt;</span> stats<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">config</span><span class="op">.</span><span class="at">maxRetained</span> <span class="op">*</span> <span class="fl">0.8</span>) {</span>
<span id="cb400-13"><a href="#cb400-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Retained messages approaching limit&#39;</span>)<span class="op">;</span></span>
<span id="cb400-14"><a href="#cb400-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb400-15"><a href="#cb400-15" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">60000</span>)<span class="op">;</span></span></code></pre></div>
<h3 data-number="24.8.3" id="environment-specific-configuration"><span
class="header-section-number">24.8.3</span> Environment-Specific
Configuration</h3>
<p>Use different profiles per environment:</p>
<div class="sourceCode" id="cb401"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config.js</span></span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">getBusConfig</span>() {</span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span>) {</span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb401-5"><a href="#cb401-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">maxRetained</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb401-6"><a href="#cb401-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">debug</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb401-7"><a href="#cb401-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rateLimit</span><span class="op">:</span> <span class="dv">2000</span></span>
<span id="cb401-8"><a href="#cb401-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb401-9"><a href="#cb401-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb401-10"><a href="#cb401-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-11"><a href="#cb401-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb401-12"><a href="#cb401-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxRetained</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb401-13"><a href="#cb401-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">debug</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb401-14"><a href="#cb401-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rateLimit</span><span class="op">:</span> <span class="dv">10000</span></span>
<span id="cb401-15"><a href="#cb401-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb401-16"><a href="#cb401-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb402"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { getBusConfig } <span class="im">from</span> <span class="st">&#39;./config.js&#39;</span><span class="op">;</span></span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> config <span class="op">=</span> <span class="fu">getBusConfig</span>()<span class="op">;</span></span>
<span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-6"><a href="#cb402-6" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;max-retained&#39;</span><span class="op">,</span> config<span class="op">.</span><span class="at">maxRetained</span>)<span class="op">;</span></span>
<span id="cb402-7"><a href="#cb402-7" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;debug&#39;</span><span class="op">,</span> config<span class="op">.</span><span class="at">debug</span>)<span class="op">;</span></span>
<span id="cb402-8"><a href="#cb402-8" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-bus&#39;</span>)<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;rate-limit&#39;</span><span class="op">,</span> config<span class="op">.</span><span class="at">rateLimit</span>)<span class="op">;</span></span>
<span id="cb402-9"><a href="#cb402-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="24.8.4" id="document-your-configuration"><span
class="header-section-number">24.8.4</span> Document Your
Configuration</h3>
<div class="sourceCode" id="cb403"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a><span class="co">  PAN Bus Configuration</span></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a><span class="co">  Environment: Production</span></span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a><span class="co">  Profile: High-availability</span></span>
<span id="cb403-6"><a href="#cb403-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-7"><a href="#cb403-7" aria-hidden="true" tabindex="-1"></a><span class="co">  max-retained: 2000</span></span>
<span id="cb403-8"><a href="#cb403-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - Expected state topics: ~500</span></span>
<span id="cb403-9"><a href="#cb403-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - Headroom: 4x expected</span></span>
<span id="cb403-10"><a href="#cb403-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-11"><a href="#cb403-11" aria-hidden="true" tabindex="-1"></a><span class="co">  rate-limit: 2000</span></span>
<span id="cb403-12"><a href="#cb403-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - Expected peak load: 1000 msg/s</span></span>
<span id="cb403-13"><a href="#cb403-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - Headroom: 2x peak</span></span>
<span id="cb403-14"><a href="#cb403-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-15"><a href="#cb403-15" aria-hidden="true" tabindex="-1"></a><span class="co">  Last tuned: 2024-11-01</span></span>
<span id="cb403-16"><a href="#cb403-16" aria-hidden="true" tabindex="-1"></a><span class="co">  Next review: 2024-12-01</span></span>
<span id="cb403-17"><a href="#cb403-17" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb403-18"><a href="#cb403-18" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-bus</span></span>
<span id="cb403-19"><a href="#cb403-19" aria-hidden="true" tabindex="-1"></a><span class="ot">  max-retained</span><span class="op">=</span><span class="st">&quot;2000&quot;</span></span>
<span id="cb403-20"><a href="#cb403-20" aria-hidden="true" tabindex="-1"></a><span class="ot">  rate-limit</span><span class="op">=</span><span class="st">&quot;2000&quot;</span></span>
<span id="cb403-21"><a href="#cb403-21" aria-hidden="true" tabindex="-1"></a><span class="ot">  debug</span><span class="op">=</span><span class="st">&quot;false&quot;</span><span class="dt">&gt;</span></span>
<span id="cb403-22"><a href="#cb403-22" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-bus</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="24.9" id="configuration-checklist"><span
class="header-section-number">24.9</span> Configuration Checklist</h2>
<p><strong>Pre-Launch:</strong> - [ ] <code>debug="false"</code> in
production - [ ] <code>allow-global-wildcard="false"</code> for security
- [ ] <code>max-retained</code> appropriate for app state volume - [ ]
<code>rate-limit</code> appropriate for expected load - [ ] Monitoring
enabled for bus statistics - [ ] Configuration documented in code
comments</p>
<p><strong>Performance Tuning:</strong></p>
<ul class="task-list">
<li><label><input type="checkbox" />Monitor <code>retained</code>
approaching <code>maxRetained</code></label></li>
<li><label><input type="checkbox" />Monitor <code>dropped</code>
messages (rate limiting)</label></li>
<li><label><input type="checkbox" />Monitor <code>errors</code>
(validation, size limits)</label></li>
<li><label><input type="checkbox" />Monitor <code>subsCleanedUp</code>
(memory leaks?)</label></li>
<li><label><input type="checkbox" />Adjust limits based on observed
usage</label></li>
</ul>
<p><strong>Security:</strong> - [ ] Global wildcard disabled in
production - [ ] Rate limits prevent DoS - [ ] Message size limits
prevent memory exhaustion - [ ] Debug mode disabled in production</p>
<h2 data-number="24.10" id="summary-7"><span
class="header-section-number">24.10</span> Summary</h2>
<p><strong>PAN Bus Core Settings:</strong></p>
<ul>
<li><code>max-retained</code> - Retained message limit (default:
1000)</li>
<li><code>max-message-size</code> - Total message size limit (default:
1MB)</li>
<li><code>max-payload-size</code> - Payload size limit (default:
512KB)</li>
<li><code>cleanup-interval</code> - Cleanup cycle interval (default:
30s)</li>
<li><code>rate-limit</code> - Messages per window (default: 1000)</li>
<li><code>allow-global-wildcard</code> - Allow <code>*</code>
subscriptions (default: true)</li>
<li><code>debug</code> - Enable debug logging (default: false)</li>
</ul>
<p><strong>PAN Bus Features:</strong></p>
<ul>
<li><code>enable-routing</code> - Enable routing system (default:
false)</li>
<li><code>enable-tracing</code> - Enable message tracing (default:
false)</li>
</ul>
<p><strong>PanClient Settings:</strong></p>
<ul>
<li><code>host</code> - Event dispatch element (default: document)</li>
<li><code>busSelector</code> - Bus element selector (default:
‘pan-bus’)</li>
<li><code>retained</code> - Receive retained messages (default:
false)</li>
<li><code>timeoutMs</code> - Request timeout (default: 5000ms)</li>
</ul>
<p><strong>Recommended Profiles:</strong></p>
<ul>
<li>Development: Debug enabled, relaxed limits</li>
<li>Production: Debug disabled, strict limits</li>
<li>High-throughput: Increased limits, routing enabled</li>
<li>Memory-constrained: Minimal retained, frequent cleanup</li>
<li>Testing: Fast cleanup, debug enabled</li>
</ul>
<p><strong>Monitoring:</strong> - Use <code>pan:sys.stats</code> to
monitor bus health - Alert on approaching limits - Tune based on
observed behavior - Document configuration decisions</p>
<p>For message envelope structure, see Appendix B. For topic
conventions, see Appendix A.</p>
<h1 data-number="25" id="migration-guide"><span
class="header-section-number">25</span> Migration Guide</h1>
<p>This appendix helps you upgrade LARC applications across versions,
navigate breaking changes, and adopt new features while maintaining
stability. Whether you’re moving from an early prototype to a production
release or keeping pace with framework evolution, this guide provides
version-specific migration paths and practical strategies.</p>
<h2 data-number="25.1" id="general-migration-strategy"><span
class="header-section-number">25.1</span> General Migration
Strategy</h2>
<p>Before diving into version-specific changes, establish a methodical
upgrade process:</p>
<p><strong>1. Review the Changelog</strong> Start with LARC’s release
notes. Note breaking changes, deprecations, and new features relevant to
your application.</p>
<p><strong>2. Update in Increments</strong> Avoid jumping multiple major
versions. Upgrade one major version at a time, testing thoroughly
between steps.</p>
<p><strong>3. Run Your Test Suite</strong> Execute all tests before and
after migration. Pay special attention to component integration tests
that exercise PAN bus communication.</p>
<p><strong>4. Check Dependencies</strong> Ensure your LARC-compatible
libraries (routing, state management) support the new version. Update
these incrementally.</p>
<p><strong>5. Use Feature Flags</strong> When migrating large
applications, use feature flags to toggle between old and new
implementations during transition periods.</p>
<h2 data-number="25.2" id="version-0.x-to-1.0-migration"><span
class="header-section-number">25.2</span> Version 0.x to 1.0
Migration</h2>
<p>The move to LARC 1.0 established core APIs and stabilized component
architecture. Key changes:</p>
<h3 data-number="25.2.1" id="component-registration-changes"><span
class="header-section-number">25.2.1</span> Component Registration
Changes</h3>
<p><strong>Before (0.x):</strong></p>
<div class="sourceCode" id="cb404"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>LARC<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;my-widget&#39;</span><span class="op">,</span> {</span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">template</span><span class="op">:</span> <span class="st">&#39;&lt;div&gt;Content&lt;/div&gt;&#39;</span><span class="op">,</span></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">props</span><span class="op">:</span> [<span class="st">&#39;data&#39;</span>]</span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>After (1.0):</strong></p>
<div class="sourceCode" id="cb405"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyWidget <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;data&#39;</span>]<span class="op">;</span></span>
<span id="cb405-3"><a href="#cb405-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-4"><a href="#cb405-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb405-5"><a href="#cb405-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb405-6"><a href="#cb405-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb405-7"><a href="#cb405-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-8"><a href="#cb405-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb405-9"><a href="#cb405-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div&gt;Content&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb405-10"><a href="#cb405-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb405-11"><a href="#cb405-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb405-12"><a href="#cb405-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-13"><a href="#cb405-13" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-widget&#39;</span><span class="op">,</span> MyWidget)<span class="op">;</span></span></code></pre></div>
<p><strong>Migration Steps:</strong> 1. Convert registration objects to
ES6 classes extending <code>HTMLElement</code> 2. Move lifecycle hooks
to standard Web Components callbacks 3. Implement
<code>observedAttributes</code> for reactive properties 4. Replace
template strings with <code>render()</code> methods</p>
<h3 data-number="25.2.2" id="pan-bus-api-refinement"><span
class="header-section-number">25.2.2</span> PAN Bus API Refinement</h3>
<p>Version 1.0 introduced explicit bus references rather than implicit
global access.</p>
<p><strong>Before (0.x):</strong></p>
<div class="sourceCode" id="cb406"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">emit</span>(<span class="st">&#39;data-changed&#39;</span><span class="op">,</span> { <span class="dt">value</span><span class="op">:</span> <span class="dv">42</span> })<span class="op">;</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;user-action&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span></code></pre></div>
<p><strong>After (1.0):</strong></p>
<div class="sourceCode" id="cb407"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data-changed&#39;</span><span class="op">,</span> { <span class="dt">value</span><span class="op">:</span> <span class="dv">42</span> })<span class="op">;</span></span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user-action&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span></code></pre></div>
<p><strong>Migration Steps:</strong> 1. Replace <code>emit()</code> with
<code>pan.dispatch()</code> 2. Replace <code>on()</code> with
<code>pan.subscribe()</code> 3. Update cleanup to use returned
unsubscribe functions 4. Add explicit PAN bus initialization if using
custom buses</p>
<h3 data-number="25.2.3" id="attribute-handling"><span
class="header-section-number">25.2.3</span> Attribute Handling</h3>
<p>Attribute parsing became more strict in 1.0.</p>
<p><strong>Before (0.x):</strong></p>
<div class="sourceCode" id="cb408"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Automatic JSON parsing</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;config&#39;</span>)<span class="op">;</span> <span class="co">// returns object</span></span></code></pre></div>
<p><strong>After (1.0):</strong></p>
<div class="sourceCode" id="cb409"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Explicit parsing required</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a><span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;config&#39;</span>) <span class="op">||</span> <span class="st">&#39;{}&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><strong>Migration Steps:</strong> 1. Add explicit JSON parsing for
complex attributes 2. Implement <code>attributeChangedCallback()</code>
for reactive updates 3. Use <code>observedAttributes</code> to declare
monitored attributes</p>
<h2 data-number="25.3" id="version-1.x-to-2.0-migration"><span
class="header-section-number">25.3</span> Version 1.x to 2.0
Migration</h2>
<p>LARC 2.0 introduced TypeScript support, improved developer
experience, and performance optimizations.</p>
<h3 data-number="25.3.1" id="typescript-integration"><span
class="header-section-number">25.3.1</span> TypeScript Integration</h3>
<p>While JavaScript remains fully supported, TypeScript brings type
safety.</p>
<p><strong>Migration Steps:</strong> 1. Install TypeScript definitions:
<code>npm install --save-dev @larc/types</code> 2. Rename
<code>.js</code> files to <code>.ts</code> incrementally 3. Add type
annotations to component properties 4. Define custom event payload
types</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb410"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { PANEvent } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> UserData {</span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a>  id<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb410-5"><a href="#cb410-5" aria-hidden="true" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb410-6"><a href="#cb410-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb410-7"><a href="#cb410-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb410-8"><a href="#cb410-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb410-9"><a href="#cb410-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> userData<span class="op">:</span> UserData <span class="op">|</span> <span class="dt">null</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb410-10"><a href="#cb410-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb410-11"><a href="#cb410-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb410-12"><a href="#cb410-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span><span class="op">&lt;</span>UserData<span class="op">&gt;</span>(<span class="st">&#39;user-selected&#39;</span><span class="op">,</span> (event<span class="op">:</span> PANEvent<span class="op">&lt;</span>UserData<span class="op">&gt;</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb410-13"><a href="#cb410-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">userData</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb410-14"><a href="#cb410-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb410-15"><a href="#cb410-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb410-16"><a href="#cb410-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb410-17"><a href="#cb410-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="25.3.2" id="shadow-dom-adoption"><span
class="header-section-number">25.3.2</span> Shadow DOM Adoption</h3>
<p>Version 2.0 encouraged Shadow DOM for style encapsulation.</p>
<p><strong>Before (1.x):</strong></p>
<div class="sourceCode" id="cb411"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;container&quot;&gt;Content&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>After (2.0):</strong></p>
<div class="sourceCode" id="cb412"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;style&gt;</span></span>
<span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      .container { padding: 1rem; }</span></span>
<span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/style&gt;</span></span>
<span id="cb412-7"><a href="#cb412-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div class=&quot;container&quot;&gt;Content&lt;/div&gt;</span></span>
<span id="cb412-8"><a href="#cb412-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb412-9"><a href="#cb412-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Migration Considerations:</strong></p>
<ul>
<li>Global styles won’t penetrate Shadow DOM</li>
<li>Use CSS custom properties for theming</li>
<li>Update selectors in tests to query shadow roots</li>
<li>Consider performance impact for large component trees</li>
</ul>
<h3 data-number="25.3.3" id="async-component-initialization"><span
class="header-section-number">25.3.3</span> Async Component
Initialization</h3>
<p>Version 2.0 added first-class async support.</p>
<p><strong>Before (1.x):</strong></p>
<div class="sourceCode" id="cb413"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(data <span class="kw">=&gt;</span> {</span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>After (2.0):</strong></p>
<div class="sourceCode" id="cb414"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">initialize</span>()<span class="op">;</span></span>
<span id="cb414-3"><a href="#cb414-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb414-4"><a href="#cb414-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-5"><a href="#cb414-5" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">initialize</span>() {</span>
<span id="cb414-6"><a href="#cb414-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb414-7"><a href="#cb414-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb414-8"><a href="#cb414-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb414-9"><a href="#cb414-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb414-10"><a href="#cb414-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">renderError</span>(error)<span class="op">;</span></span>
<span id="cb414-11"><a href="#cb414-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb414-12"><a href="#cb414-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="25.4" id="version-2.x-to-3.0-migration"><span
class="header-section-number">25.4</span> Version 2.x to 3.0
Migration</h2>
<p>LARC 3.0 focused on performance, introducing reactive primitives and
optimized rendering.</p>
<h3 data-number="25.4.1" id="reactive-state-management"><span
class="header-section-number">25.4.1</span> Reactive State
Management</h3>
<p>The new reactive state system replaces manual <code>render()</code>
calls.</p>
<p><strong>Before (2.x):</strong></p>
<div class="sourceCode" id="cb415"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb415-5"><a href="#cb415-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb415-6"><a href="#cb415-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-7"><a href="#cb415-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span>() {</span>
<span id="cb415-8"><a href="#cb415-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb415-9"><a href="#cb415-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb415-10"><a href="#cb415-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb415-11"><a href="#cb415-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>After (3.0):</strong></p>
<div class="sourceCode" id="cb416"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { reactive } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb416-5"><a href="#cb416-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb416-6"><a href="#cb416-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="fu">reactive</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span> })<span class="op">;</span></span>
<span id="cb416-7"><a href="#cb416-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="fu">$watch</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>())<span class="op">;</span></span>
<span id="cb416-8"><a href="#cb416-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb416-9"><a href="#cb416-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-10"><a href="#cb416-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span>() {</span>
<span id="cb416-11"><a href="#cb416-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span> <span class="co">// automatically triggers render</span></span>
<span id="cb416-12"><a href="#cb416-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb416-13"><a href="#cb416-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Migration Steps:</strong> 1. Wrap component state in
<code>reactive()</code> 2. Set up <code>$watch()</code> for automatic
rendering 3. Remove manual <code>render()</code> calls after state
changes 4. Use <code>$batch()</code> for multiple simultaneous
updates</p>
<h3 data-number="25.4.2" id="pan-bus-namespacing"><span
class="header-section-number">25.4.2</span> PAN Bus Namespacing</h3>
<p>Version 3.0 introduced event namespacing for better organization.</p>
<p><strong>Before (2.x):</strong></p>
<div class="sourceCode" id="cb417"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data-loaded&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data-error&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data-cleared&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><strong>After (3.0):</strong></p>
<div class="sourceCode" id="cb418"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data:loaded&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data:error&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;data:cleared&#39;</span>)<span class="op">;</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to namespace</span></span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data:*&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Data event: </span><span class="sc">${</span><span class="bu">event</span><span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="25.4.3" id="performance-optimizations"><span
class="header-section-number">25.4.3</span> Performance
Optimizations</h3>
<p>Version 3.0 added batched updates and render scheduling.</p>
<p><strong>Manual Batching:</strong></p>
<div class="sourceCode" id="cb419"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { batch } <span class="im">from</span> <span class="st">&#39;@larc/core&#39;</span><span class="op">;</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a><span class="fu">batch</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb419-5"><a href="#cb419-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;Updated&#39;</span><span class="op">;</span></span>
<span id="cb419-6"><a href="#cb419-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">timestamp</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb419-7"><a href="#cb419-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span> <span class="co">// Single render after all changes</span></span></code></pre></div>
<p><strong>Render Scheduling:</strong></p>
<div class="sourceCode" id="cb420"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HeavyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requestIdleCallback</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Expensive rendering during idle time</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateComplexUI</span>()<span class="op">;</span></span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="25.5" id="deprecation-timeline"><span
class="header-section-number">25.5</span> Deprecation Timeline</h2>
<h3 data-number="25.5.1" id="currently-deprecated-remove-in-4.0"><span
class="header-section-number">25.5.1</span> Currently Deprecated (Remove
in 4.0)</h3>
<p><strong>Legacy Event Syntax:</strong></p>
<div class="sourceCode" id="cb421"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Deprecated</span></span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;event-name&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Use instead</span></span>
<span id="cb421-5"><a href="#cb421-5" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;event-name&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span></code></pre></div>
<p><strong>Global Bus Access:</strong></p>
<div class="sourceCode" id="cb422"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Deprecated</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">PAN</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;event&#39;</span>)<span class="op">;</span></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Use instead</span></span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;event&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><strong>Synchronous connectedCallback with async
operations:</strong></p>
<div class="sourceCode" id="cb423"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Deprecated pattern</span></span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(<span class="st">&#39;/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(d <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> d)<span class="op">;</span></span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span> <span class="co">// Renders before data loads</span></span>
<span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb423-7"><a href="#cb423-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Preferred</span></span>
<span id="cb423-8"><a href="#cb423-8" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb423-9"><a href="#cb423-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb423-10"><a href="#cb423-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb423-11"><a href="#cb423-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="25.5.2" id="planned-deprecations-4.0"><span
class="header-section-number">25.5.2</span> Planned Deprecations
(4.0+)</h3>
<ul>
<li>Direct innerHTML manipulation (prefer template literals or JSX)</li>
<li>Imperative event listener registration (favor declarative
templates)</li>
<li>String-based event names (transition to strongly-typed event
enums)</li>
</ul>
<h2 data-number="25.6" id="breaking-changes-checklist"><span
class="header-section-number">25.6</span> Breaking Changes
Checklist</h2>
<p>When upgrading major versions, verify these common breaking change
areas:</p>
<p><strong>API Surface:</strong> - [ ] Component registration method - [
] PAN bus method names - [ ] Event payload structure - [ ] Lifecycle
callback signatures</p>
<p><strong>Behavior Changes:</strong></p>
<ul class="task-list">
<li><label><input type="checkbox" />Attribute parsing (automatic
vs. manual)</label></li>
<li><label><input type="checkbox" />Default Shadow DOM
usage</label></li>
<li><label><input type="checkbox" />Event bubbling and
cancellation</label></li>
<li><label><input type="checkbox" />Async initialization
timing</label></li>
</ul>
<p><strong>Build Process:</strong> - [ ] Bundler configuration - [ ]
TypeScript compiler options - [ ] Test framework compatibility - [ ]
Development server setup</p>
<p><strong>Dependencies:</strong> - [ ] Peer dependency versions - [ ]
Polyfill requirements - [ ] Browser compatibility targets - [ ]
Third-party library compatibility</p>
<h2 data-number="25.7" id="migration-tools"><span
class="header-section-number">25.7</span> Migration Tools</h2>
<h3 data-number="25.7.1" id="automated-refactoring"><span
class="header-section-number">25.7.1</span> Automated Refactoring</h3>
<p>Use these tools to accelerate migration:</p>
<p><strong>AST-Based Transforms:</strong></p>
<div class="sourceCode" id="cb424"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> @larc/migrate <span class="at">--from</span> 2.x <span class="at">--to</span> 3.0 src/<span class="pp">**</span>/<span class="pp">*</span>.js</span></code></pre></div>
<p><strong>Codemod Scripts:</strong></p>
<div class="sourceCode" id="cb425"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Convert emit to dispatch</span></span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> <span class="kw">function</span>(fileInfo<span class="op">,</span> api) {</span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> j <span class="op">=</span> api<span class="op">.</span><span class="at">jscodeshift</span><span class="op">;</span></span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">j</span>(fileInfo<span class="op">.</span><span class="at">source</span>)</span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">find</span>(j<span class="op">.</span><span class="at">CallExpression</span><span class="op">,</span> {</span>
<span id="cb425-6"><a href="#cb425-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">callee</span><span class="op">:</span> {</span>
<span id="cb425-7"><a href="#cb425-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">object</span><span class="op">:</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;ThisExpression&#39;</span> }<span class="op">,</span></span>
<span id="cb425-8"><a href="#cb425-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">property</span><span class="op">:</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;emit&#39;</span> }</span>
<span id="cb425-9"><a href="#cb425-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb425-10"><a href="#cb425-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb425-11"><a href="#cb425-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forEach</span>(path <span class="kw">=&gt;</span> {</span>
<span id="cb425-12"><a href="#cb425-12" aria-hidden="true" tabindex="-1"></a>      path<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">callee</span><span class="op">.</span><span class="at">property</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;dispatch&#39;</span><span class="op">;</span></span>
<span id="cb425-13"><a href="#cb425-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb425-14"><a href="#cb425-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">toSource</span>()<span class="op">;</span></span>
<span id="cb425-15"><a href="#cb425-15" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 data-number="25.7.2" id="manual-review-points"><span
class="header-section-number">25.7.2</span> Manual Review Points</h3>
<p>Automated tools can’t catch everything. Manually review:</p>
<ol type="1">
<li><strong>Business Logic:</strong> Ensure state changes behave
identically</li>
<li><strong>Edge Cases:</strong> Test error handling and boundary
conditions</li>
<li><strong>Performance:</strong> Profile before/after for
regressions</li>
<li><strong>User Experience:</strong> Verify visual consistency and
interactions</li>
</ol>
<h2 data-number="25.8" id="rollback-strategy"><span
class="header-section-number">25.8</span> Rollback Strategy</h2>
<p>If migration causes critical issues:</p>
<ol type="1">
<li><strong>Revert Version:</strong> Use git to restore previous
package.json</li>
<li><strong>Isolate Changes:</strong> Create feature branches for
incremental updates</li>
<li><strong>Dual Implementation:</strong> Run old and new code
side-by-side with feature flags</li>
<li><strong>Gradual Rollout:</strong> Deploy to subset of users before
full migration</li>
</ol>
<h2 data-number="25.9" id="getting-help"><span
class="header-section-number">25.9</span> Getting Help</h2>
<p>When stuck during migration:</p>
<ul>
<li><strong>Documentation:</strong> Check version-specific upgrade
guides at larc.dev/migrate</li>
<li><strong>Community:</strong> Ask in GitHub Discussions or
Discord</li>
<li><strong>Issue Tracker:</strong> Search for similar migration
problems</li>
<li><strong>Support Contracts:</strong> Enterprise users can access
dedicated migration assistance</li>
</ul>
<p>Migration is an investment in your application’s future. Take time to
understand changes, test thoroughly, and leverage community resources.
The LARC team strives for smooth upgrade paths while continuing to
evolve the framework.</p>
<h1 data-number="26" id="recipes-and-patterns"><span
class="header-section-number">26</span> Recipes and Patterns</h1>
<p>This appendix provides practical, copy-paste-ready solutions for
common LARC development scenarios. Each recipe demonstrates a specific
technique or pattern you’ll encounter when building real applications.
Use these as starting points, adapting them to your specific
requirements.</p>
<h2 data-number="26.1" id="recipe-1-lazy-loading-components"><span
class="header-section-number">26.1</span> Recipe 1: Lazy-Loading
Components</h2>
<p>Defer component loading until needed, reducing initial bundle
size.</p>
<div class="sourceCode" id="cb426"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LazyLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> componentName <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;component&#39;</span>)<span class="op">;</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> modulePath <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;module&#39;</span>)<span class="op">;</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="im">import</span>(modulePath)<span class="op">;</span></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(componentName)<span class="op">;</span></span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">attributes</span>)<span class="op">.</span><span class="fu">forEach</span>(attr <span class="kw">=&gt;</span> {</span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (attr<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;component&#39;</span> <span class="op">&amp;&amp;</span> attr<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;module&#39;</span>) {</span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>          element<span class="op">.</span><span class="fu">setAttribute</span>(attr<span class="op">.</span><span class="at">name</span><span class="op">,</span> attr<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">replaceWith</span>(element)<span class="op">;</span></span>
<span id="cb426-15"><a href="#cb426-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb426-16"><a href="#cb426-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;Failed to load component&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb426-17"><a href="#cb426-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Lazy load failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb426-18"><a href="#cb426-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb426-19"><a href="#cb426-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-20"><a href="#cb426-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb426-21"><a href="#cb426-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-22"><a href="#cb426-22" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;lazy-loader&#39;</span><span class="op">,</span> LazyLoader)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb427"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">lazy-loader</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  component</span><span class="op">=</span><span class="st">&quot;data-table&quot;</span></span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  module</span><span class="op">=</span><span class="st">&quot;/components/data-table.js&quot;</span></span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  data-source</span><span class="op">=</span><span class="st">&quot;/api/users&quot;</span><span class="dt">&gt;</span></span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">lazy-loader</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>When to Use:</strong> - Large components used infrequently -
Route-based code splitting - Conditional feature loading based on user
permissions</p>
<h2 data-number="26.2" id="recipe-2-form-validation-component"><span
class="header-section-number">26.2</span> Recipe 2: Form Validation
Component</h2>
<p>Reusable form validation with real-time feedback.</p>
<div class="sourceCode" id="cb428"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidatedForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">validators</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-7"><a href="#cb428-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb428-8"><a href="#cb428-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb428-9"><a href="#cb428-9" aria-hidden="true" tabindex="-1"></a><span class="vs">        .field { margin-bottom: 1rem; }</span></span>
<span id="cb428-10"><a href="#cb428-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error { color: #d32f2f; font-size: 0.875rem; margin-top: 0.25rem; }</span></span>
<span id="cb428-11"><a href="#cb428-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        .valid { border-color: #4caf50; }</span></span>
<span id="cb428-12"><a href="#cb428-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .invalid { border-color: #d32f2f; }</span></span>
<span id="cb428-13"><a href="#cb428-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb428-14"><a href="#cb428-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb428-15"><a href="#cb428-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb428-16"><a href="#cb428-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;actions&quot;&gt;</span></span>
<span id="cb428-17"><a href="#cb428-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;</span></span>
<span id="cb428-18"><a href="#cb428-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb428-19"><a href="#cb428-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb428-20"><a href="#cb428-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb428-21"><a href="#cb428-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-22"><a href="#cb428-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupValidation</span>()<span class="op">;</span></span>
<span id="cb428-23"><a href="#cb428-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-24"><a href="#cb428-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-25"><a href="#cb428-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupValidation</span>() {</span>
<span id="cb428-26"><a href="#cb428-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb428-27"><a href="#cb428-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inputs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-validate]&#39;</span>)<span class="op">;</span></span>
<span id="cb428-28"><a href="#cb428-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-29"><a href="#cb428-29" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">forEach</span>(input <span class="kw">=&gt;</span> {</span>
<span id="cb428-30"><a href="#cb428-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rules <span class="op">=</span> input<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;data-validate&#39;</span>)<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;,&#39;</span>)<span class="op">;</span></span>
<span id="cb428-31"><a href="#cb428-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">validators</span><span class="op">.</span><span class="fu">set</span>(input<span class="op">,</span> rules)<span class="op">;</span></span>
<span id="cb428-32"><a href="#cb428-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-33"><a href="#cb428-33" aria-hidden="true" tabindex="-1"></a>      input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;blur&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateField</span>(input))<span class="op">;</span></span>
<span id="cb428-34"><a href="#cb428-34" aria-hidden="true" tabindex="-1"></a>      input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb428-35"><a href="#cb428-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="fu">has</span>(input)) {</span>
<span id="cb428-36"><a href="#cb428-36" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">validateField</span>(input)<span class="op">;</span></span>
<span id="cb428-37"><a href="#cb428-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb428-38"><a href="#cb428-38" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb428-39"><a href="#cb428-39" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb428-40"><a href="#cb428-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-41"><a href="#cb428-41" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb428-42"><a href="#cb428-42" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb428-43"><a href="#cb428-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">validateAll</span>()) {</span>
<span id="cb428-44"><a href="#cb428-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>()<span class="op">;</span></span>
<span id="cb428-45"><a href="#cb428-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-46"><a href="#cb428-46" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb428-47"><a href="#cb428-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-48"><a href="#cb428-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-49"><a href="#cb428-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validateField</span>(input) {</span>
<span id="cb428-50"><a href="#cb428-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> rules <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">validators</span><span class="op">.</span><span class="fu">get</span>(input)<span class="op">;</span></span>
<span id="cb428-51"><a href="#cb428-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> value <span class="op">=</span> input<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">trim</span>()<span class="op">;</span></span>
<span id="cb428-52"><a href="#cb428-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> error <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb428-53"><a href="#cb428-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-54"><a href="#cb428-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> rule <span class="kw">of</span> rules) {</span>
<span id="cb428-55"><a href="#cb428-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule <span class="op">===</span> <span class="st">&#39;required&#39;</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>value) {</span>
<span id="cb428-56"><a href="#cb428-56" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&#39;This field is required&#39;</span><span class="op">;</span></span>
<span id="cb428-57"><a href="#cb428-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb428-58"><a href="#cb428-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-59"><a href="#cb428-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule <span class="op">===</span> <span class="st">&#39;email&#39;</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">isValidEmail</span>(value)) {</span>
<span id="cb428-60"><a href="#cb428-60" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&#39;Invalid email address&#39;</span><span class="op">;</span></span>
<span id="cb428-61"><a href="#cb428-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb428-62"><a href="#cb428-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-63"><a href="#cb428-63" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;min:&#39;</span>)) {</span>
<span id="cb428-64"><a href="#cb428-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> min <span class="op">=</span> <span class="pp">parseInt</span>(rule<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;:&#39;</span>)[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb428-65"><a href="#cb428-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (value<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> min) {</span>
<span id="cb428-66"><a href="#cb428-66" aria-hidden="true" tabindex="-1"></a>          error <span class="op">=</span> <span class="vs">`Minimum </span><span class="sc">${</span>min<span class="sc">}</span><span class="vs"> characters required`</span><span class="op">;</span></span>
<span id="cb428-67"><a href="#cb428-67" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb428-68"><a href="#cb428-68" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb428-69"><a href="#cb428-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-70"><a href="#cb428-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;max:&#39;</span>)) {</span>
<span id="cb428-71"><a href="#cb428-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> max <span class="op">=</span> <span class="pp">parseInt</span>(rule<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;:&#39;</span>)[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb428-72"><a href="#cb428-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (value<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> max) {</span>
<span id="cb428-73"><a href="#cb428-73" aria-hidden="true" tabindex="-1"></a>          error <span class="op">=</span> <span class="vs">`Maximum </span><span class="sc">${</span>max<span class="sc">}</span><span class="vs"> characters allowed`</span><span class="op">;</span></span>
<span id="cb428-74"><a href="#cb428-74" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb428-75"><a href="#cb428-75" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb428-76"><a href="#cb428-76" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-77"><a href="#cb428-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb428-78"><a href="#cb428-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-79"><a href="#cb428-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateFieldError</span>(input<span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb428-80"><a href="#cb428-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">!</span>error<span class="op">;</span></span>
<span id="cb428-81"><a href="#cb428-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-82"><a href="#cb428-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-83"><a href="#cb428-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateFieldError</span>(input<span class="op">,</span> error) {</span>
<span id="cb428-84"><a href="#cb428-84" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&#39;invalid&#39;</span><span class="op">,</span> <span class="op">!!</span>error)<span class="op">;</span></span>
<span id="cb428-85"><a href="#cb428-85" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&#39;valid&#39;</span><span class="op">,</span> <span class="op">!</span>error)<span class="op">;</span></span>
<span id="cb428-86"><a href="#cb428-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-87"><a href="#cb428-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> errorDiv <span class="op">=</span> input<span class="op">.</span><span class="at">nextElementSibling</span><span class="op">;</span></span>
<span id="cb428-88"><a href="#cb428-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (errorDiv <span class="op">&amp;&amp;</span> errorDiv<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;error&#39;</span>)) {</span>
<span id="cb428-89"><a href="#cb428-89" aria-hidden="true" tabindex="-1"></a>      errorDiv<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb428-90"><a href="#cb428-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb428-91"><a href="#cb428-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-92"><a href="#cb428-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error) {</span>
<span id="cb428-93"><a href="#cb428-93" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="fu">set</span>(input<span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb428-94"><a href="#cb428-94" aria-hidden="true" tabindex="-1"></a>      errorDiv <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb428-95"><a href="#cb428-95" aria-hidden="true" tabindex="-1"></a>      errorDiv<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;error&#39;</span><span class="op">;</span></span>
<span id="cb428-96"><a href="#cb428-96" aria-hidden="true" tabindex="-1"></a>      errorDiv<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> error<span class="op">;</span></span>
<span id="cb428-97"><a href="#cb428-97" aria-hidden="true" tabindex="-1"></a>      input<span class="op">.</span><span class="fu">after</span>(errorDiv)<span class="op">;</span></span>
<span id="cb428-98"><a href="#cb428-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb428-99"><a href="#cb428-99" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="fu">delete</span>(input)<span class="op">;</span></span>
<span id="cb428-100"><a href="#cb428-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb428-101"><a href="#cb428-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-102"><a href="#cb428-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-103"><a href="#cb428-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validateAll</span>() {</span>
<span id="cb428-104"><a href="#cb428-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> isValid <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb428-105"><a href="#cb428-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">validators</span><span class="op">.</span><span class="fu">forEach</span>((rules<span class="op">,</span> input) <span class="kw">=&gt;</span> {</span>
<span id="cb428-106"><a href="#cb428-106" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">validateField</span>(input)) {</span>
<span id="cb428-107"><a href="#cb428-107" aria-hidden="true" tabindex="-1"></a>        isValid <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb428-108"><a href="#cb428-108" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-109"><a href="#cb428-109" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb428-110"><a href="#cb428-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> isValid<span class="op">;</span></span>
<span id="cb428-111"><a href="#cb428-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-112"><a href="#cb428-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-113"><a href="#cb428-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isValidEmail</span>(email) {</span>
<span id="cb428-114"><a href="#cb428-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">/</span><span class="sc">^[^\s@]+</span><span class="ss">@</span><span class="sc">[^\s@]+\.[^\s@]+$</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(email)<span class="op">;</span></span>
<span id="cb428-115"><a href="#cb428-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-116"><a href="#cb428-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-117"><a href="#cb428-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleSubmit</span>() {</span>
<span id="cb428-118"><a href="#cb428-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>))<span class="op">;</span></span>
<span id="cb428-119"><a href="#cb428-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;form:submitted&#39;</span><span class="op">,</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(formData))<span class="op">;</span></span>
<span id="cb428-120"><a href="#cb428-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-121"><a href="#cb428-121" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb428-122"><a href="#cb428-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-123"><a href="#cb428-123" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;validated-form&#39;</span><span class="op">,</span> ValidatedForm)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb429"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">validated-form</span><span class="dt">&gt;</span></span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;field&quot;</span><span class="dt">&gt;</span></span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">label</span><span class="dt">&gt;</span>Email<span class="dt">&lt;/</span><span class="kw">label</span><span class="dt">&gt;</span></span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> data-validate</span><span class="op">=</span><span class="st">&quot;required,email&quot;</span><span class="dt">&gt;</span></span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;field&quot;</span><span class="dt">&gt;</span></span>
<span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">label</span><span class="dt">&gt;</span>Password<span class="dt">&lt;/</span><span class="kw">label</span><span class="dt">&gt;</span></span>
<span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;password&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;password&quot;</span><span class="ot"> data-validate</span><span class="op">=</span><span class="st">&quot;required,min:8&quot;</span><span class="dt">&gt;</span></span>
<span id="cb429-9"><a href="#cb429-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb429-10"><a href="#cb429-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">validated-form</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.3" id="recipe-3-infinite-scroll-list"><span
class="header-section-number">26.3</span> Recipe 3: Infinite Scroll
List</h2>
<p>Load data progressively as user scrolls.</p>
<div class="sourceCode" id="cb430"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InfiniteList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-9"><a href="#cb430-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb430-10"><a href="#cb430-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">apiEndpoint</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;api&#39;</span>)<span class="op">;</span></span>
<span id="cb430-11"><a href="#cb430-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupIntersectionObserver</span>()<span class="op">;</span></span>
<span id="cb430-12"><a href="#cb430-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadMore</span>()<span class="op">;</span></span>
<span id="cb430-13"><a href="#cb430-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-14"><a href="#cb430-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-15"><a href="#cb430-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupIntersectionObserver</span>() {</span>
<span id="cb430-16"><a href="#cb430-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sentinel <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb430-17"><a href="#cb430-17" aria-hidden="true" tabindex="-1"></a>    sentinel<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;scroll-sentinel&#39;</span><span class="op">;</span></span>
<span id="cb430-18"><a href="#cb430-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(sentinel)<span class="op">;</span></span>
<span id="cb430-19"><a href="#cb430-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-20"><a href="#cb430-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>((entries) <span class="kw">=&gt;</span> {</span>
<span id="cb430-21"><a href="#cb430-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (entries[<span class="dv">0</span>]<span class="op">.</span><span class="at">isIntersecting</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span>) {</span>
<span id="cb430-22"><a href="#cb430-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">loadMore</span>()<span class="op">;</span></span>
<span id="cb430-23"><a href="#cb430-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb430-24"><a href="#cb430-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> { <span class="dt">threshold</span><span class="op">:</span> <span class="fl">0.1</span> })<span class="op">;</span></span>
<span id="cb430-25"><a href="#cb430-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-26"><a href="#cb430-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span><span class="op">.</span><span class="fu">observe</span>(sentinel)<span class="op">;</span></span>
<span id="cb430-27"><a href="#cb430-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-28"><a href="#cb430-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-29"><a href="#cb430-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadMore</span>() {</span>
<span id="cb430-30"><a href="#cb430-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb430-31"><a href="#cb430-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showLoadingIndicator</span>()<span class="op">;</span></span>
<span id="cb430-32"><a href="#cb430-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-33"><a href="#cb430-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb430-34"><a href="#cb430-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">apiEndpoint</span><span class="sc">}</span><span class="vs">?page=</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">page</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb430-35"><a href="#cb430-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb430-36"><a href="#cb430-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-37"><a href="#cb430-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb430-38"><a href="#cb430-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb430-39"><a href="#cb430-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">hideLoadingIndicator</span>()<span class="op">;</span></span>
<span id="cb430-40"><a href="#cb430-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb430-41"><a href="#cb430-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb430-42"><a href="#cb430-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-43"><a href="#cb430-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderItems</span>(data<span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb430-44"><a href="#cb430-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">page</span><span class="op">++;</span></span>
<span id="cb430-45"><a href="#cb430-45" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb430-46"><a href="#cb430-46" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load items:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb430-47"><a href="#cb430-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> { <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Failed to load items&#39;</span> })<span class="op">;</span></span>
<span id="cb430-48"><a href="#cb430-48" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb430-49"><a href="#cb430-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb430-50"><a href="#cb430-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">hideLoadingIndicator</span>()<span class="op">;</span></span>
<span id="cb430-51"><a href="#cb430-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb430-52"><a href="#cb430-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-53"><a href="#cb430-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-54"><a href="#cb430-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderItems</span>(items) {</span>
<span id="cb430-55"><a href="#cb430-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sentinel <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.scroll-sentinel&#39;</span>)<span class="op">;</span></span>
<span id="cb430-56"><a href="#cb430-56" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb430-57"><a href="#cb430-57" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> element <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">createItemElement</span>(item)<span class="op">;</span></span>
<span id="cb430-58"><a href="#cb430-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">insertBefore</span>(element<span class="op">,</span> sentinel)<span class="op">;</span></span>
<span id="cb430-59"><a href="#cb430-59" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb430-60"><a href="#cb430-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-61"><a href="#cb430-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-62"><a href="#cb430-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">createItemElement</span>(item) {</span>
<span id="cb430-63"><a href="#cb430-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> div <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb430-64"><a href="#cb430-64" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;list-item&#39;</span><span class="op">;</span></span>
<span id="cb430-65"><a href="#cb430-65" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb430-66"><a href="#cb430-66" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h3&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb430-67"><a href="#cb430-67" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">description</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb430-68"><a href="#cb430-68" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb430-69"><a href="#cb430-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> div<span class="op">;</span></span>
<span id="cb430-70"><a href="#cb430-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-71"><a href="#cb430-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-72"><a href="#cb430-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showLoadingIndicator</span>() {</span>
<span id="cb430-73"><a href="#cb430-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> loader <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loader&#39;</span>)<span class="op">;</span></span>
<span id="cb430-74"><a href="#cb430-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>loader) {</span>
<span id="cb430-75"><a href="#cb430-75" aria-hidden="true" tabindex="-1"></a>      loader <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb430-76"><a href="#cb430-76" aria-hidden="true" tabindex="-1"></a>      loader<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;loader&#39;</span><span class="op">;</span></span>
<span id="cb430-77"><a href="#cb430-77" aria-hidden="true" tabindex="-1"></a>      loader<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Loading...&#39;</span><span class="op">;</span></span>
<span id="cb430-78"><a href="#cb430-78" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(loader)<span class="op">;</span></span>
<span id="cb430-79"><a href="#cb430-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb430-80"><a href="#cb430-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-81"><a href="#cb430-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-82"><a href="#cb430-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hideLoadingIndicator</span>() {</span>
<span id="cb430-83"><a href="#cb430-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loader <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loader&#39;</span>)<span class="op">;</span></span>
<span id="cb430-84"><a href="#cb430-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (loader) loader<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb430-85"><a href="#cb430-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-86"><a href="#cb430-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-87"><a href="#cb430-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb430-88"><a href="#cb430-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">observer</span>) {</span>
<span id="cb430-89"><a href="#cb430-89" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">observer</span><span class="op">.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb430-90"><a href="#cb430-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb430-91"><a href="#cb430-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb430-92"><a href="#cb430-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb430-93"><a href="#cb430-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-94"><a href="#cb430-94" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;infinite-list&#39;</span><span class="op">,</span> InfiniteList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.4" id="recipe-4-toast-notification-system"><span
class="header-section-number">26.4</span> Recipe 4: Toast Notification
System</h2>
<p>Display temporary user notifications.</p>
<div class="sourceCode" id="cb431"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ToastContainer <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb431-5"><a href="#cb431-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb431-6"><a href="#cb431-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb431-7"><a href="#cb431-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb431-8"><a href="#cb431-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 1rem;</span></span>
<span id="cb431-9"><a href="#cb431-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 1rem;</span></span>
<span id="cb431-10"><a href="#cb431-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 10000;</span></span>
<span id="cb431-11"><a href="#cb431-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb431-12"><a href="#cb431-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb431-13"><a href="#cb431-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb431-14"><a href="#cb431-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 400px;</span></span>
<span id="cb431-15"><a href="#cb431-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb431-16"><a href="#cb431-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toast {</span></span>
<span id="cb431-17"><a href="#cb431-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem 1.5rem;</span></span>
<span id="cb431-18"><a href="#cb431-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.5rem;</span></span>
<span id="cb431-19"><a href="#cb431-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);</span></span>
<span id="cb431-20"><a href="#cb431-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb431-21"><a href="#cb431-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb431-22"><a href="#cb431-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.75rem;</span></span>
<span id="cb431-23"><a href="#cb431-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: slideIn 0.3s ease;</span></span>
<span id="cb431-24"><a href="#cb431-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb431-25"><a href="#cb431-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toast.success { background: #4caf50; color: white; }</span></span>
<span id="cb431-26"><a href="#cb431-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toast.error { background: #f44336; color: white; }</span></span>
<span id="cb431-27"><a href="#cb431-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toast.info { background: #2196f3; color: white; }</span></span>
<span id="cb431-28"><a href="#cb431-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toast.warning { background: #ff9800; color: white; }</span></span>
<span id="cb431-29"><a href="#cb431-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        @keyframes slideIn {</span></span>
<span id="cb431-30"><a href="#cb431-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          from {</span></span>
<span id="cb431-31"><a href="#cb431-31" aria-hidden="true" tabindex="-1"></a><span class="vs">            transform: translateX(100%);</span></span>
<span id="cb431-32"><a href="#cb431-32" aria-hidden="true" tabindex="-1"></a><span class="vs">            opacity: 0;</span></span>
<span id="cb431-33"><a href="#cb431-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb431-34"><a href="#cb431-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          to {</span></span>
<span id="cb431-35"><a href="#cb431-35" aria-hidden="true" tabindex="-1"></a><span class="vs">            transform: translateX(0);</span></span>
<span id="cb431-36"><a href="#cb431-36" aria-hidden="true" tabindex="-1"></a><span class="vs">            opacity: 1;</span></span>
<span id="cb431-37"><a href="#cb431-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb431-38"><a href="#cb431-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb431-39"><a href="#cb431-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        .close {</span></span>
<span id="cb431-40"><a href="#cb431-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-left: auto;</span></span>
<span id="cb431-41"><a href="#cb431-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb431-42"><a href="#cb431-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1.25rem;</span></span>
<span id="cb431-43"><a href="#cb431-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          opacity: 0.8;</span></span>
<span id="cb431-44"><a href="#cb431-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb431-45"><a href="#cb431-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        .close:hover { opacity: 1; }</span></span>
<span id="cb431-46"><a href="#cb431-46" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb431-47"><a href="#cb431-47" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb431-48"><a href="#cb431-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-49"><a href="#cb431-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;toast:show&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb431-50"><a href="#cb431-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showToast</span>(<span class="bu">event</span><span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb431-51"><a href="#cb431-51" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb431-52"><a href="#cb431-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb431-53"><a href="#cb431-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-54"><a href="#cb431-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showToast</span>({ message<span class="op">,</span> type <span class="op">=</span> <span class="st">&#39;info&#39;</span><span class="op">,</span> duration <span class="op">=</span> <span class="dv">3000</span> }) {</span>
<span id="cb431-55"><a href="#cb431-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> toast <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb431-56"><a href="#cb431-56" aria-hidden="true" tabindex="-1"></a>    toast<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="vs">`toast </span><span class="sc">${</span>type<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb431-57"><a href="#cb431-57" aria-hidden="true" tabindex="-1"></a>    toast<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb431-58"><a href="#cb431-58" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span class=&quot;message&quot;&gt;</span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb431-59"><a href="#cb431-59" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span class=&quot;close&quot;&gt;&amp;times;&lt;/span&gt;</span></span>
<span id="cb431-60"><a href="#cb431-60" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb431-61"><a href="#cb431-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-62"><a href="#cb431-62" aria-hidden="true" tabindex="-1"></a>    toast<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.close&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb431-63"><a href="#cb431-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">removeToast</span>(toast)<span class="op">;</span></span>
<span id="cb431-64"><a href="#cb431-64" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb431-65"><a href="#cb431-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-66"><a href="#cb431-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">appendChild</span>(toast)<span class="op">;</span></span>
<span id="cb431-67"><a href="#cb431-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-68"><a href="#cb431-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (duration <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb431-69"><a href="#cb431-69" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">removeToast</span>(toast)<span class="op">,</span> duration)<span class="op">;</span></span>
<span id="cb431-70"><a href="#cb431-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb431-71"><a href="#cb431-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb431-72"><a href="#cb431-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-73"><a href="#cb431-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">removeToast</span>(toast) {</span>
<span id="cb431-74"><a href="#cb431-74" aria-hidden="true" tabindex="-1"></a>    toast<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">animation</span> <span class="op">=</span> <span class="st">&#39;slideIn 0.3s ease reverse&#39;</span><span class="op">;</span></span>
<span id="cb431-75"><a href="#cb431-75" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> toast<span class="op">.</span><span class="fu">remove</span>()<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb431-76"><a href="#cb431-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb431-77"><a href="#cb431-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb431-78"><a href="#cb431-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-79"><a href="#cb431-79" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;toast-container&#39;</span><span class="op">,</span> ToastContainer)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb432"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Anywhere in your app</span></span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;toast:show&#39;</span><span class="op">,</span> {</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Settings saved successfully&#39;</span><span class="op">,</span></span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;success&#39;</span><span class="op">,</span></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">duration</span><span class="op">:</span> <span class="dv">3000</span></span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.5" id="recipe-5-debounced-search-input"><span
class="header-section-number">26.5</span> Recipe 5: Debounced Search
Input</h2>
<p>Optimize API calls by debouncing user input.</p>
<div class="sourceCode" id="cb433"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchInput <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceDelay</span> <span class="op">=</span> <span class="pp">parseInt</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;debounce&#39;</span>)) <span class="op">||</span> <span class="dv">300</span><span class="op">;</span></span>
<span id="cb433-6"><a href="#cb433-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-7"><a href="#cb433-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-8"><a href="#cb433-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb433-9"><a href="#cb433-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb433-10"><a href="#cb433-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;search-wrapper&quot;&gt;</span></span>
<span id="cb433-11"><a href="#cb433-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;search&quot; placeholder=&quot;Search...&quot;&gt;</span></span>
<span id="cb433-12"><a href="#cb433-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;spinner&quot; style=&quot;display: none;&quot;&gt;[hourglass]&lt;/span&gt;</span></span>
<span id="cb433-13"><a href="#cb433-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb433-14"><a href="#cb433-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;results&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb433-15"><a href="#cb433-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb433-16"><a href="#cb433-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-17"><a href="#cb433-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb433-18"><a href="#cb433-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">spinner</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.spinner&#39;</span>)<span class="op">;</span></span>
<span id="cb433-19"><a href="#cb433-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resultsContainer</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.results&#39;</span>)<span class="op">;</span></span>
<span id="cb433-20"><a href="#cb433-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-21"><a href="#cb433-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb433-22"><a href="#cb433-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleInput</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb433-23"><a href="#cb433-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb433-24"><a href="#cb433-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-25"><a href="#cb433-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;search:results&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb433-26"><a href="#cb433-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">displayResults</span>(<span class="bu">event</span><span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb433-27"><a href="#cb433-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb433-28"><a href="#cb433-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-29"><a href="#cb433-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-30"><a href="#cb433-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleInput</span>(value) {</span>
<span id="cb433-31"><a href="#cb433-31" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span>)<span class="op">;</span></span>
<span id="cb433-32"><a href="#cb433-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-33"><a href="#cb433-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>value<span class="op">.</span><span class="fu">trim</span>()) {</span>
<span id="cb433-34"><a href="#cb433-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">resultsContainer</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb433-35"><a href="#cb433-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb433-36"><a href="#cb433-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb433-37"><a href="#cb433-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-38"><a href="#cb433-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showSpinner</span>()<span class="op">;</span></span>
<span id="cb433-39"><a href="#cb433-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-40"><a href="#cb433-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb433-41"><a href="#cb433-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">performSearch</span>(value)<span class="op">;</span></span>
<span id="cb433-42"><a href="#cb433-42" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">debounceDelay</span>)<span class="op">;</span></span>
<span id="cb433-43"><a href="#cb433-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-44"><a href="#cb433-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-45"><a href="#cb433-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">performSearch</span>(query) {</span>
<span id="cb433-46"><a href="#cb433-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb433-47"><a href="#cb433-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> apiEndpoint <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;api&#39;</span>)<span class="op">;</span></span>
<span id="cb433-48"><a href="#cb433-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span>apiEndpoint<span class="sc">}</span><span class="vs">?q=</span><span class="sc">${</span><span class="pp">encodeURIComponent</span>(query)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb433-49"><a href="#cb433-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb433-50"><a href="#cb433-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;search:results&#39;</span><span class="op">,</span> results)<span class="op">;</span></span>
<span id="cb433-51"><a href="#cb433-51" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb433-52"><a href="#cb433-52" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Search failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb433-53"><a href="#cb433-53" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb433-54"><a href="#cb433-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">hideSpinner</span>()<span class="op">;</span></span>
<span id="cb433-55"><a href="#cb433-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb433-56"><a href="#cb433-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-57"><a href="#cb433-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-58"><a href="#cb433-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">displayResults</span>(results) {</span>
<span id="cb433-59"><a href="#cb433-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (results<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb433-60"><a href="#cb433-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">resultsContainer</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;no-results&quot;&gt;No results found&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb433-61"><a href="#cb433-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb433-62"><a href="#cb433-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb433-63"><a href="#cb433-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-64"><a href="#cb433-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resultsContainer</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> results</span>
<span id="cb433-65"><a href="#cb433-65" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(result <span class="kw">=&gt;</span> <span class="vs">`&lt;div class=&quot;result-item&quot;&gt;</span><span class="sc">${</span>result<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span>)</span>
<span id="cb433-66"><a href="#cb433-66" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb433-67"><a href="#cb433-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-68"><a href="#cb433-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-69"><a href="#cb433-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showSpinner</span>() {</span>
<span id="cb433-70"><a href="#cb433-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">spinner</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;inline&#39;</span><span class="op">;</span></span>
<span id="cb433-71"><a href="#cb433-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-72"><a href="#cb433-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-73"><a href="#cb433-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hideSpinner</span>() {</span>
<span id="cb433-74"><a href="#cb433-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">spinner</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb433-75"><a href="#cb433-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-76"><a href="#cb433-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb433-77"><a href="#cb433-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-78"><a href="#cb433-78" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;search-input&#39;</span><span class="op">,</span> SearchInput)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.6" id="recipe-6-modal-dialog"><span
class="header-section-number">26.6</span> Recipe 6: Modal Dialog</h2>
<p>Accessible modal with focus trapping.</p>
<div class="sourceCode" id="cb434"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModalDialog <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 0;</span></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb434-11"><a href="#cb434-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb434-12"><a href="#cb434-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          bottom: 0;</span></span>
<span id="cb434-13"><a href="#cb434-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 9999;</span></span>
<span id="cb434-14"><a href="#cb434-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb434-15"><a href="#cb434-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([open]) { display: block; }</span></span>
<span id="cb434-16"><a href="#cb434-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        .backdrop {</span></span>
<span id="cb434-17"><a href="#cb434-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb434-18"><a href="#cb434-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 0;</span></span>
<span id="cb434-19"><a href="#cb434-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb434-20"><a href="#cb434-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb434-21"><a href="#cb434-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          bottom: 0;</span></span>
<span id="cb434-22"><a href="#cb434-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: rgba(0, 0, 0, 0.5);</span></span>
<span id="cb434-23"><a href="#cb434-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb434-24"><a href="#cb434-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        .modal {</span></span>
<span id="cb434-25"><a href="#cb434-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb434-26"><a href="#cb434-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 50%;</span></span>
<span id="cb434-27"><a href="#cb434-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 50%;</span></span>
<span id="cb434-28"><a href="#cb434-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          transform: translate(-50%, -50%);</span></span>
<span id="cb434-29"><a href="#cb434-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb434-30"><a href="#cb434-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.5rem;</span></span>
<span id="cb434-31"><a href="#cb434-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2rem;</span></span>
<span id="cb434-32"><a href="#cb434-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 90vw;</span></span>
<span id="cb434-33"><a href="#cb434-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 90vh;</span></span>
<span id="cb434-34"><a href="#cb434-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: auto;</span></span>
<span id="cb434-35"><a href="#cb434-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);</span></span>
<span id="cb434-36"><a href="#cb434-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb434-37"><a href="#cb434-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        .close {</span></span>
<span id="cb434-38"><a href="#cb434-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb434-39"><a href="#cb434-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 1rem;</span></span>
<span id="cb434-40"><a href="#cb434-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 1rem;</span></span>
<span id="cb434-41"><a href="#cb434-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: none;</span></span>
<span id="cb434-42"><a href="#cb434-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb434-43"><a href="#cb434-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1.5rem;</span></span>
<span id="cb434-44"><a href="#cb434-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb434-45"><a href="#cb434-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb434-46"><a href="#cb434-46" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb434-47"><a href="#cb434-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;backdrop&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb434-48"><a href="#cb434-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;modal&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot;&gt;</span></span>
<span id="cb434-49"><a href="#cb434-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;close&quot; aria-label=&quot;Close&quot;&gt;&amp;times;&lt;/button&gt;</span></span>
<span id="cb434-50"><a href="#cb434-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb434-51"><a href="#cb434-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb434-52"><a href="#cb434-52" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb434-53"><a href="#cb434-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-54"><a href="#cb434-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.backdrop&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">close</span>())<span class="op">;</span></span>
<span id="cb434-55"><a href="#cb434-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.close&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">close</span>())<span class="op">;</span></span>
<span id="cb434-56"><a href="#cb434-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-57"><a href="#cb434-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;modal:open&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb434-58"><a href="#cb434-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">event</span><span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">id</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb434-59"><a href="#cb434-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">open</span>()<span class="op">;</span></span>
<span id="cb434-60"><a href="#cb434-60" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb434-61"><a href="#cb434-61" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb434-62"><a href="#cb434-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb434-63"><a href="#cb434-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-64"><a href="#cb434-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">open</span>() {</span>
<span id="cb434-65"><a href="#cb434-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb434-66"><a href="#cb434-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">previousFocus</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span><span class="op">;</span></span>
<span id="cb434-67"><a href="#cb434-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">trapFocus</span>()<span class="op">;</span></span>
<span id="cb434-68"><a href="#cb434-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">overflow</span> <span class="op">=</span> <span class="st">&#39;hidden&#39;</span><span class="op">;</span></span>
<span id="cb434-69"><a href="#cb434-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb434-70"><a href="#cb434-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-71"><a href="#cb434-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>() {</span>
<span id="cb434-72"><a href="#cb434-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb434-73"><a href="#cb434-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">overflow</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb434-74"><a href="#cb434-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">previousFocus</span>) {</span>
<span id="cb434-75"><a href="#cb434-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">previousFocus</span><span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb434-76"><a href="#cb434-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb434-77"><a href="#cb434-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;modal:closed&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb434-78"><a href="#cb434-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb434-79"><a href="#cb434-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-80"><a href="#cb434-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trapFocus</span>() {</span>
<span id="cb434-81"><a href="#cb434-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> focusableElements <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(</span>
<span id="cb434-82"><a href="#cb434-82" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;button, [href], input, select, textarea, [tabindex]:not([tabindex=&quot;-1&quot;])&#39;</span></span>
<span id="cb434-83"><a href="#cb434-83" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb434-84"><a href="#cb434-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> firstElement <span class="op">=</span> focusableElements[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb434-85"><a href="#cb434-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lastElement <span class="op">=</span> focusableElements[focusableElements<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb434-86"><a href="#cb434-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-87"><a href="#cb434-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">keydownHandler</span> <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb434-88"><a href="#cb434-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">!==</span> <span class="st">&#39;Tab&#39;</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb434-89"><a href="#cb434-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-90"><a href="#cb434-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">shiftKey</span> <span class="op">&amp;&amp;</span> <span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span> <span class="op">===</span> firstElement) {</span>
<span id="cb434-91"><a href="#cb434-91" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb434-92"><a href="#cb434-92" aria-hidden="true" tabindex="-1"></a>        lastElement<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb434-93"><a href="#cb434-93" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>e<span class="op">.</span><span class="at">shiftKey</span> <span class="op">&amp;&amp;</span> <span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span> <span class="op">===</span> lastElement) {</span>
<span id="cb434-94"><a href="#cb434-94" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb434-95"><a href="#cb434-95" aria-hidden="true" tabindex="-1"></a>        firstElement<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb434-96"><a href="#cb434-96" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb434-97"><a href="#cb434-97" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb434-98"><a href="#cb434-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-99"><a href="#cb434-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">keydownHandler</span>)<span class="op">;</span></span>
<span id="cb434-100"><a href="#cb434-100" aria-hidden="true" tabindex="-1"></a>    firstElement<span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb434-101"><a href="#cb434-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb434-102"><a href="#cb434-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-103"><a href="#cb434-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb434-104"><a href="#cb434-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">keydownHandler</span>) {</span>
<span id="cb434-105"><a href="#cb434-105" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">keydownHandler</span>)<span class="op">;</span></span>
<span id="cb434-106"><a href="#cb434-106" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb434-107"><a href="#cb434-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb434-108"><a href="#cb434-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb434-109"><a href="#cb434-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-110"><a href="#cb434-110" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;modal-dialog&#39;</span><span class="op">,</span> ModalDialog)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.7" id="recipe-7-state-persistence"><span
class="header-section-number">26.7</span> Recipe 7: State
Persistence</h2>
<p>Save and restore component state to localStorage.</p>
<div class="sourceCode" id="cb435"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StatefulComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">storageKey</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;storage-key&#39;</span>) <span class="op">||</span> <span class="st">&#39;component-state&#39;</span><span class="op">;</span></span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadState</span>()<span class="op">;</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadState</span>() {</span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> saved <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storageKey</span>)<span class="op">;</span></span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> saved <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(saved) <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getDefaultState</span>()<span class="op">;</span></span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load state:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getDefaultState</span>()<span class="op">;</span></span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-17"><a href="#cb435-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-18"><a href="#cb435-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveState</span>() {</span>
<span id="cb435-19"><a href="#cb435-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb435-20"><a href="#cb435-20" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storageKey</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span>))<span class="op">;</span></span>
<span id="cb435-21"><a href="#cb435-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;state:saved&#39;</span><span class="op">,</span> { <span class="dt">key</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">storageKey</span> })<span class="op">;</span></span>
<span id="cb435-22"><a href="#cb435-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb435-23"><a href="#cb435-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to save state:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb435-24"><a href="#cb435-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;state:error&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb435-25"><a href="#cb435-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb435-26"><a href="#cb435-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-27"><a href="#cb435-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-28"><a href="#cb435-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateState</span>(updates) {</span>
<span id="cb435-29"><a href="#cb435-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> { <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> <span class="op">...</span>updates }<span class="op">;</span></span>
<span id="cb435-30"><a href="#cb435-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">saveState</span>()<span class="op">;</span></span>
<span id="cb435-31"><a href="#cb435-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb435-32"><a href="#cb435-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-33"><a href="#cb435-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-34"><a href="#cb435-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getDefaultState</span>() {</span>
<span id="cb435-35"><a href="#cb435-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {}<span class="op">;</span></span>
<span id="cb435-36"><a href="#cb435-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-37"><a href="#cb435-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-38"><a href="#cb435-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clearState</span>() {</span>
<span id="cb435-39"><a href="#cb435-39" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storageKey</span>)<span class="op">;</span></span>
<span id="cb435-40"><a href="#cb435-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getDefaultState</span>()<span class="op">;</span></span>
<span id="cb435-41"><a href="#cb435-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb435-42"><a href="#cb435-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-43"><a href="#cb435-43" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="26.8" id="recipe-8-drag-and-drop"><span
class="header-section-number">26.8</span> Recipe 8: Drag and Drop</h2>
<p>Reorderable list with drag-and-drop.</p>
<div class="sourceCode" id="cb436"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DraggableList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragstart&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleDragStart</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragover&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleDragOver</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;drop&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleDrop</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragend&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleDragEnd</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">makeItemsDraggable</span>()<span class="op">;</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-10"><a href="#cb436-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-11"><a href="#cb436-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">makeItemsDraggable</span>() {</span>
<span id="cb436-12"><a href="#cb436-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.draggable-item&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb436-13"><a href="#cb436-13" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;draggable&#39;</span><span class="op">,</span> <span class="st">&#39;true&#39;</span>)<span class="op">;</span></span>
<span id="cb436-14"><a href="#cb436-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb436-15"><a href="#cb436-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-16"><a href="#cb436-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-17"><a href="#cb436-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleDragStart</span>(e) {</span>
<span id="cb436-18"><a href="#cb436-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;draggable-item&#39;</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb436-19"><a href="#cb436-19" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;dragging&#39;</span>)<span class="op">;</span></span>
<span id="cb436-20"><a href="#cb436-20" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="at">dataTransfer</span><span class="op">.</span><span class="at">effectAllowed</span> <span class="op">=</span> <span class="st">&#39;move&#39;</span><span class="op">;</span></span>
<span id="cb436-21"><a href="#cb436-21" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="at">dataTransfer</span><span class="op">.</span><span class="fu">setData</span>(<span class="st">&#39;text/html&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">innerHTML</span>)<span class="op">;</span></span>
<span id="cb436-22"><a href="#cb436-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-23"><a href="#cb436-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-24"><a href="#cb436-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleDragOver</span>(e) {</span>
<span id="cb436-25"><a href="#cb436-25" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb436-26"><a href="#cb436-26" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="at">dataTransfer</span><span class="op">.</span><span class="at">dropEffect</span> <span class="op">=</span> <span class="st">&#39;move&#39;</span><span class="op">;</span></span>
<span id="cb436-27"><a href="#cb436-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-28"><a href="#cb436-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dragging <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.dragging&#39;</span>)<span class="op">;</span></span>
<span id="cb436-29"><a href="#cb436-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> afterElement <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getDragAfterElement</span>(e<span class="op">.</span><span class="at">clientY</span>)<span class="op">;</span></span>
<span id="cb436-30"><a href="#cb436-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-31"><a href="#cb436-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (afterElement <span class="op">==</span> <span class="kw">null</span>) {</span>
<span id="cb436-32"><a href="#cb436-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(dragging)<span class="op">;</span></span>
<span id="cb436-33"><a href="#cb436-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb436-34"><a href="#cb436-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">insertBefore</span>(dragging<span class="op">,</span> afterElement)<span class="op">;</span></span>
<span id="cb436-35"><a href="#cb436-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb436-36"><a href="#cb436-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-37"><a href="#cb436-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-38"><a href="#cb436-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleDrop</span>(e) {</span>
<span id="cb436-39"><a href="#cb436-39" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">stopPropagation</span>()<span class="op">;</span></span>
<span id="cb436-40"><a href="#cb436-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchReorderEvent</span>()<span class="op">;</span></span>
<span id="cb436-41"><a href="#cb436-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-42"><a href="#cb436-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-43"><a href="#cb436-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleDragEnd</span>(e) {</span>
<span id="cb436-44"><a href="#cb436-44" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;dragging&#39;</span>)<span class="op">;</span></span>
<span id="cb436-45"><a href="#cb436-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-46"><a href="#cb436-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-47"><a href="#cb436-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getDragAfterElement</span>(y) {</span>
<span id="cb436-48"><a href="#cb436-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> draggableElements <span class="op">=</span> [</span>
<span id="cb436-49"><a href="#cb436-49" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.draggable-item:not(.dragging)&#39;</span>)</span>
<span id="cb436-50"><a href="#cb436-50" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb436-51"><a href="#cb436-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-52"><a href="#cb436-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> draggableElements<span class="op">.</span><span class="fu">reduce</span>((closest<span class="op">,</span> child) <span class="kw">=&gt;</span> {</span>
<span id="cb436-53"><a href="#cb436-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> box <span class="op">=</span> child<span class="op">.</span><span class="fu">getBoundingClientRect</span>()<span class="op">;</span></span>
<span id="cb436-54"><a href="#cb436-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> offset <span class="op">=</span> y <span class="op">-</span> box<span class="op">.</span><span class="at">top</span> <span class="op">-</span> box<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb436-55"><a href="#cb436-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-56"><a href="#cb436-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (offset <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> offset <span class="op">&gt;</span> closest<span class="op">.</span><span class="at">offset</span>) {</span>
<span id="cb436-57"><a href="#cb436-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> { <span class="dt">offset</span><span class="op">:</span> offset<span class="op">,</span> <span class="dt">element</span><span class="op">:</span> child }<span class="op">;</span></span>
<span id="cb436-58"><a href="#cb436-58" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb436-59"><a href="#cb436-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> closest<span class="op">;</span></span>
<span id="cb436-60"><a href="#cb436-60" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb436-61"><a href="#cb436-61" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> { <span class="dt">offset</span><span class="op">:</span> <span class="bu">Number</span><span class="op">.</span><span class="cn">NEGATIVE_INFINITY</span> })<span class="op">.</span><span class="at">element</span><span class="op">;</span></span>
<span id="cb436-62"><a href="#cb436-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-63"><a href="#cb436-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-64"><a href="#cb436-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dispatchReorderEvent</span>() {</span>
<span id="cb436-65"><a href="#cb436-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> order <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.draggable-item&#39;</span>))</span>
<span id="cb436-66"><a href="#cb436-66" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((item<span class="op">,</span> index) <span class="kw">=&gt;</span> ({ index<span class="op">,</span> <span class="dt">id</span><span class="op">:</span> item<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">id</span> }))<span class="op">;</span></span>
<span id="cb436-67"><a href="#cb436-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;list:reordered&#39;</span><span class="op">,</span> order)<span class="op">;</span></span>
<span id="cb436-68"><a href="#cb436-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-69"><a href="#cb436-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb436-70"><a href="#cb436-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-71"><a href="#cb436-71" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;draggable-list&#39;</span><span class="op">,</span> DraggableList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.9" id="recipe-9-responsive-image"><span
class="header-section-number">26.9</span> Recipe 9: Responsive
Image</h2>
<p>Automatically load appropriate image sizes.</p>
<div class="sourceCode" id="cb437"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResponsiveImage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">sources</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;sources&#39;</span>))<span class="op">;</span></span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">alt</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;alt&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleResize</span>())<span class="op">;</span></span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> src <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">selectSource</span>()<span class="op">;</span></span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;img src=&quot;</span><span class="sc">${</span>src<span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">alt</span><span class="sc">}</span><span class="vs">&quot; loading=&quot;lazy&quot;&gt;`</span><span class="op">;</span></span>
<span id="cb437-13"><a href="#cb437-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-14"><a href="#cb437-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-15"><a href="#cb437-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selectSource</span>() {</span>
<span id="cb437-16"><a href="#cb437-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> width <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">innerWidth</span><span class="op">;</span></span>
<span id="cb437-17"><a href="#cb437-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sorted <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(<span class="kw">this</span><span class="op">.</span><span class="at">sources</span>)</span>
<span id="cb437-18"><a href="#cb437-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">sort</span>(([a]<span class="op">,</span> [b]) <span class="kw">=&gt;</span> <span class="pp">parseInt</span>(a) <span class="op">-</span> <span class="pp">parseInt</span>(b))<span class="op">;</span></span>
<span id="cb437-19"><a href="#cb437-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-20"><a href="#cb437-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [breakpoint<span class="op">,</span> url] <span class="kw">of</span> sorted) {</span>
<span id="cb437-21"><a href="#cb437-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (width <span class="op">&lt;=</span> <span class="pp">parseInt</span>(breakpoint)) {</span>
<span id="cb437-22"><a href="#cb437-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> url<span class="op">;</span></span>
<span id="cb437-23"><a href="#cb437-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb437-24"><a href="#cb437-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb437-25"><a href="#cb437-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-26"><a href="#cb437-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sorted[sorted<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>][<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb437-27"><a href="#cb437-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-28"><a href="#cb437-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-29"><a href="#cb437-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleResize</span>() {</span>
<span id="cb437-30"><a href="#cb437-30" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">resizeTimer</span>)<span class="op">;</span></span>
<span id="cb437-31"><a href="#cb437-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resizeTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb437-32"><a href="#cb437-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> currentSrc <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;img&#39;</span>)<span class="op">.</span><span class="at">src</span><span class="op">;</span></span>
<span id="cb437-33"><a href="#cb437-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> newSrc <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">selectSource</span>()<span class="op">;</span></span>
<span id="cb437-34"><a href="#cb437-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (currentSrc <span class="op">!==</span> newSrc) {</span>
<span id="cb437-35"><a href="#cb437-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb437-36"><a href="#cb437-36" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb437-37"><a href="#cb437-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">250</span>)<span class="op">;</span></span>
<span id="cb437-38"><a href="#cb437-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-39"><a href="#cb437-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb437-40"><a href="#cb437-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-41"><a href="#cb437-41" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;responsive-image&#39;</span><span class="op">,</span> ResponsiveImage)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb438"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">responsive-image</span></span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  sources</span><span class="op">=</span><span class="st">&#39;{&quot;480&quot;: &quot;/img/small.jpg&quot;, &quot;1024&quot;: &quot;/img/medium.jpg&quot;, &quot;1920&quot;: &quot;/img/large.jpg&quot;}&#39;</span></span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  alt</span><span class="op">=</span><span class="st">&quot;Product photo&quot;</span><span class="dt">&gt;</span></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">responsive-image</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.10" id="recipe-10-event-bus-bridge"><span
class="header-section-number">26.10</span> Recipe 10: Event Bus
Bridge</h2>
<p>Bridge LARC PAN bus events to external systems.</p>
<div class="sourceCode" id="cb439"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EventBridge <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">externalSystem</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;target&#39;</span>)<span class="op">;</span></span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventMap</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;event-map&#39;</span>) <span class="op">||</span> <span class="st">&#39;{}&#39;</span>)<span class="op">;</span></span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-6"><a href="#cb439-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(<span class="kw">this</span><span class="op">.</span><span class="at">eventMap</span>)<span class="op">.</span><span class="fu">forEach</span>(panEvent <span class="kw">=&gt;</span> {</span>
<span id="cb439-7"><a href="#cb439-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(panEvent<span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb439-8"><a href="#cb439-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">bridgeEvent</span>(panEvent<span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb439-9"><a href="#cb439-9" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb439-10"><a href="#cb439-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb439-11"><a href="#cb439-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-12"><a href="#cb439-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-13"><a href="#cb439-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bridgeEvent</span>(panEvent<span class="op">,</span> data) {</span>
<span id="cb439-14"><a href="#cb439-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> externalEvent <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">eventMap</span>[panEvent]<span class="op">;</span></span>
<span id="cb439-15"><a href="#cb439-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-16"><a href="#cb439-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (<span class="kw">this</span><span class="op">.</span><span class="at">externalSystem</span>) {</span>
<span id="cb439-17"><a href="#cb439-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;analytics&#39;</span><span class="op">:</span></span>
<span id="cb439-18"><a href="#cb439-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">sendToAnalytics</span>(externalEvent<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb439-19"><a href="#cb439-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb439-20"><a href="#cb439-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;websocket&#39;</span><span class="op">:</span></span>
<span id="cb439-21"><a href="#cb439-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">sendToWebSocket</span>(externalEvent<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb439-22"><a href="#cb439-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb439-23"><a href="#cb439-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;postmessage&#39;</span><span class="op">:</span></span>
<span id="cb439-24"><a href="#cb439-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">sendToParent</span>(externalEvent<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb439-25"><a href="#cb439-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb439-26"><a href="#cb439-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb439-27"><a href="#cb439-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-28"><a href="#cb439-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-29"><a href="#cb439-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sendToAnalytics</span>(<span class="bu">event</span><span class="op">,</span> data) {</span>
<span id="cb439-30"><a href="#cb439-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">window</span><span class="op">.</span><span class="at">gtag</span>) {</span>
<span id="cb439-31"><a href="#cb439-31" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="fu">gtag</span>(<span class="st">&#39;event&#39;</span><span class="op">,</span> <span class="bu">event</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb439-32"><a href="#cb439-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb439-33"><a href="#cb439-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-34"><a href="#cb439-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-35"><a href="#cb439-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sendToWebSocket</span>(<span class="bu">event</span><span class="op">,</span> data) {</span>
<span id="cb439-36"><a href="#cb439-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">websocket</span><span class="op">?.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb439-37"><a href="#cb439-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">websocket</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">type</span><span class="op">:</span> <span class="bu">event</span><span class="op">,</span> <span class="dt">payload</span><span class="op">:</span> data }))<span class="op">;</span></span>
<span id="cb439-38"><a href="#cb439-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb439-39"><a href="#cb439-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-40"><a href="#cb439-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-41"><a href="#cb439-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sendToParent</span>(<span class="bu">event</span><span class="op">,</span> data) {</span>
<span id="cb439-42"><a href="#cb439-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">parent</span><span class="op">.</span><span class="fu">postMessage</span>({ <span class="dt">type</span><span class="op">:</span> <span class="bu">event</span><span class="op">,</span> <span class="dt">payload</span><span class="op">:</span> data }<span class="op">,</span> <span class="st">&#39;*&#39;</span>)<span class="op">;</span></span>
<span id="cb439-43"><a href="#cb439-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-44"><a href="#cb439-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb439-45"><a href="#cb439-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-46"><a href="#cb439-46" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;event-bridge&#39;</span><span class="op">,</span> EventBridge)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.11" id="recipe-11-file-upload-with-progress"><span
class="header-section-number">26.11</span> Recipe 11: File Upload with
Progress</h2>
<p>Multi-file upload with progress tracking and validation.</p>
<div class="sourceCode" id="cb440"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileUpload <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxSize</span> <span class="op">=</span> <span class="pp">parseInt</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;max-size&#39;</span>)) <span class="op">||</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// 5MB</span></span>
<span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">accept</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;accept&#39;</span>) <span class="op">||</span> <span class="st">&#39;*/*&#39;</span><span class="op">;</span></span>
<span id="cb440-6"><a href="#cb440-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">multiple</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;multiple&#39;</span>)<span class="op">;</span></span>
<span id="cb440-7"><a href="#cb440-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-8"><a href="#cb440-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb440-9"><a href="#cb440-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb440-10"><a href="#cb440-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        .upload-area {</span></span>
<span id="cb440-11"><a href="#cb440-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 2px dashed #ccc;</span></span>
<span id="cb440-12"><a href="#cb440-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.5rem;</span></span>
<span id="cb440-13"><a href="#cb440-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2rem;</span></span>
<span id="cb440-14"><a href="#cb440-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb440-15"><a href="#cb440-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb440-16"><a href="#cb440-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: border-color 0.3s;</span></span>
<span id="cb440-17"><a href="#cb440-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb440-18"><a href="#cb440-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        .upload-area:hover { border-color: #2196f3; }</span></span>
<span id="cb440-19"><a href="#cb440-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        .upload-area.dragover { border-color: #4caf50; background: #f0f8f0; }</span></span>
<span id="cb440-20"><a href="#cb440-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        .file-list { margin-top: 1rem; }</span></span>
<span id="cb440-21"><a href="#cb440-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        .file-item {</span></span>
<span id="cb440-22"><a href="#cb440-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb440-23"><a href="#cb440-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb440-24"><a href="#cb440-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb440-25"><a href="#cb440-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb440-26"><a href="#cb440-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb440-27"><a href="#cb440-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb440-28"><a href="#cb440-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 0.5rem;</span></span>
<span id="cb440-29"><a href="#cb440-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb440-30"><a href="#cb440-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        .progress-bar {</span></span>
<span id="cb440-31"><a href="#cb440-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb440-32"><a href="#cb440-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 8px;</span></span>
<span id="cb440-33"><a href="#cb440-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e0e0e0;</span></span>
<span id="cb440-34"><a href="#cb440-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb440-35"><a href="#cb440-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: hidden;</span></span>
<span id="cb440-36"><a href="#cb440-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb440-37"><a href="#cb440-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        .progress-fill {</span></span>
<span id="cb440-38"><a href="#cb440-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 100%;</span></span>
<span id="cb440-39"><a href="#cb440-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #4caf50;</span></span>
<span id="cb440-40"><a href="#cb440-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: width 0.3s;</span></span>
<span id="cb440-41"><a href="#cb440-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb440-42"><a href="#cb440-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        .remove-btn {</span></span>
<span id="cb440-43"><a href="#cb440-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f44336;</span></span>
<span id="cb440-44"><a href="#cb440-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb440-45"><a href="#cb440-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb440-46"><a href="#cb440-46" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.25rem 0.5rem;</span></span>
<span id="cb440-47"><a href="#cb440-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb440-48"><a href="#cb440-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb440-49"><a href="#cb440-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb440-50"><a href="#cb440-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error { color: #f44336; font-size: 0.875rem; }</span></span>
<span id="cb440-51"><a href="#cb440-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb440-52"><a href="#cb440-52" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;upload-area&quot;&gt;</span></span>
<span id="cb440-53"><a href="#cb440-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;file&quot; style=&quot;display: none&quot; accept=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">accept</span><span class="sc">}</span><span class="vs">&quot; </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">multiple</span> <span class="op">?</span> <span class="st">&#39;multiple&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&gt;</span></span>
<span id="cb440-54"><a href="#cb440-54" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;📁 Drag files here or click to browse&lt;/p&gt;</span></span>
<span id="cb440-55"><a href="#cb440-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb440-56"><a href="#cb440-56" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;file-list&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb440-57"><a href="#cb440-57" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb440-58"><a href="#cb440-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-59"><a href="#cb440-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.upload-area&#39;</span>)<span class="op">;</span></span>
<span id="cb440-60"><a href="#cb440-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fileInput</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input[type=&quot;file&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb440-61"><a href="#cb440-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fileList</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.file-list&#39;</span>)<span class="op">;</span></span>
<span id="cb440-62"><a href="#cb440-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-63"><a href="#cb440-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupEvents</span>()<span class="op">;</span></span>
<span id="cb440-64"><a href="#cb440-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-65"><a href="#cb440-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-66"><a href="#cb440-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupEvents</span>() {</span>
<span id="cb440-67"><a href="#cb440-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">fileInput</span><span class="op">.</span><span class="fu">click</span>())<span class="op">;</span></span>
<span id="cb440-68"><a href="#cb440-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fileInput</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleFiles</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>))<span class="op">;</span></span>
<span id="cb440-69"><a href="#cb440-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-70"><a href="#cb440-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragover&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb440-71"><a href="#cb440-71" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb440-72"><a href="#cb440-72" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;dragover&#39;</span>)<span class="op">;</span></span>
<span id="cb440-73"><a href="#cb440-73" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb440-74"><a href="#cb440-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-75"><a href="#cb440-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;dragleave&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb440-76"><a href="#cb440-76" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;dragover&#39;</span>)<span class="op">;</span></span>
<span id="cb440-77"><a href="#cb440-77" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb440-78"><a href="#cb440-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-79"><a href="#cb440-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;drop&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb440-80"><a href="#cb440-80" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb440-81"><a href="#cb440-81" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">uploadArea</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;dragover&#39;</span>)<span class="op">;</span></span>
<span id="cb440-82"><a href="#cb440-82" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleFiles</span>(e<span class="op">.</span><span class="at">dataTransfer</span><span class="op">.</span><span class="at">files</span>)<span class="op">;</span></span>
<span id="cb440-83"><a href="#cb440-83" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb440-84"><a href="#cb440-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-85"><a href="#cb440-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-86"><a href="#cb440-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleFiles</span>(files) {</span>
<span id="cb440-87"><a href="#cb440-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(files)<span class="op">.</span><span class="fu">forEach</span>(file <span class="kw">=&gt;</span> {</span>
<span id="cb440-88"><a href="#cb440-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (file<span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxSize</span>) {</span>
<span id="cb440-89"><a href="#cb440-89" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="vs">`</span><span class="sc">${</span>file<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> exceeds </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">maxSize</span> <span class="op">/</span> <span class="dv">1024</span> <span class="op">/</span> <span class="dv">1024</span><span class="sc">}</span><span class="vs">MB limit`</span>)<span class="op">;</span></span>
<span id="cb440-90"><a href="#cb440-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb440-91"><a href="#cb440-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb440-92"><a href="#cb440-92" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">uploadFile</span>(file)<span class="op">;</span></span>
<span id="cb440-93"><a href="#cb440-93" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb440-94"><a href="#cb440-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-95"><a href="#cb440-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-96"><a href="#cb440-96" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">uploadFile</span>(file) {</span>
<span id="cb440-97"><a href="#cb440-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fileId <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="op">;</span></span>
<span id="cb440-98"><a href="#cb440-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fileItem <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">createFileItem</span>(file<span class="op">,</span> fileId)<span class="op">;</span></span>
<span id="cb440-99"><a href="#cb440-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fileList</span><span class="op">.</span><span class="fu">appendChild</span>(fileItem)<span class="op">;</span></span>
<span id="cb440-100"><a href="#cb440-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-101"><a href="#cb440-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb440-102"><a href="#cb440-102" aria-hidden="true" tabindex="-1"></a>    formData<span class="op">.</span><span class="fu">append</span>(<span class="st">&#39;file&#39;</span><span class="op">,</span> file)<span class="op">;</span></span>
<span id="cb440-103"><a href="#cb440-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-104"><a href="#cb440-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb440-105"><a href="#cb440-105" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;upload-url&#39;</span>) <span class="op">||</span> <span class="st">&#39;/api/upload&#39;</span><span class="op">,</span> {</span>
<span id="cb440-106"><a href="#cb440-106" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb440-107"><a href="#cb440-107" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> formData<span class="op">,</span></span>
<span id="cb440-108"><a href="#cb440-108" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb440-109"><a href="#cb440-109" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;X-File-Name&#39;</span><span class="op">:</span> file<span class="op">.</span><span class="at">name</span></span>
<span id="cb440-110"><a href="#cb440-110" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb440-111"><a href="#cb440-111" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb440-112"><a href="#cb440-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-113"><a href="#cb440-113" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Upload failed&#39;</span>)<span class="op">;</span></span>
<span id="cb440-114"><a href="#cb440-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-115"><a href="#cb440-115" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb440-116"><a href="#cb440-116" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateProgress</span>(fileId<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb440-117"><a href="#cb440-117" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;file:uploaded&#39;</span><span class="op">,</span> { <span class="dt">file</span><span class="op">:</span> file<span class="op">.</span><span class="at">name</span><span class="op">,</span> result })<span class="op">;</span></span>
<span id="cb440-118"><a href="#cb440-118" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb440-119"><a href="#cb440-119" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="vs">`Failed to upload </span><span class="sc">${</span>file<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb440-120"><a href="#cb440-120" aria-hidden="true" tabindex="-1"></a>      fileItem<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.progress-bar&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb440-121"><a href="#cb440-121" aria-hidden="true" tabindex="-1"></a>      fileItem<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.error&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> error<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb440-122"><a href="#cb440-122" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb440-123"><a href="#cb440-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-124"><a href="#cb440-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-125"><a href="#cb440-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">createFileItem</span>(file<span class="op">,</span> id) {</span>
<span id="cb440-126"><a href="#cb440-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> div <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb440-127"><a href="#cb440-127" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;file-item&#39;</span><span class="op">;</span></span>
<span id="cb440-128"><a href="#cb440-128" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">id</span> <span class="op">=</span> id<span class="op">;</span></span>
<span id="cb440-129"><a href="#cb440-129" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb440-130"><a href="#cb440-130" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span&gt;</span><span class="sc">${</span>file<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>(file<span class="op">.</span><span class="at">size</span> <span class="op">/</span> <span class="dv">1024</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>)<span class="sc">}</span><span class="vs">KB)&lt;/span&gt;</span></span>
<span id="cb440-131"><a href="#cb440-131" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;progress-bar&quot;&gt;</span></span>
<span id="cb440-132"><a href="#cb440-132" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;progress-fill&quot; style=&quot;width: 0%&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb440-133"><a href="#cb440-133" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb440-134"><a href="#cb440-134" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button class=&quot;remove-btn&quot;&gt;Remove&lt;/button&gt;</span></span>
<span id="cb440-135"><a href="#cb440-135" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;error&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb440-136"><a href="#cb440-136" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb440-137"><a href="#cb440-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-138"><a href="#cb440-138" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.remove-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb440-139"><a href="#cb440-139" aria-hidden="true" tabindex="-1"></a>      div<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb440-140"><a href="#cb440-140" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;file:removed&#39;</span><span class="op">,</span> { <span class="dt">file</span><span class="op">:</span> file<span class="op">.</span><span class="at">name</span> })<span class="op">;</span></span>
<span id="cb440-141"><a href="#cb440-141" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb440-142"><a href="#cb440-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-143"><a href="#cb440-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> div<span class="op">;</span></span>
<span id="cb440-144"><a href="#cb440-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-145"><a href="#cb440-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-146"><a href="#cb440-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateProgress</span>(fileId<span class="op">,</span> percent) {</span>
<span id="cb440-147"><a href="#cb440-147" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> item <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">fileList</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`[data-id=&quot;</span><span class="sc">${</span>fileId<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb440-148"><a href="#cb440-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (item) {</span>
<span id="cb440-149"><a href="#cb440-149" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> fill <span class="op">=</span> item<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.progress-fill&#39;</span>)<span class="op">;</span></span>
<span id="cb440-150"><a href="#cb440-150" aria-hidden="true" tabindex="-1"></a>      fill<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>percent<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb440-151"><a href="#cb440-151" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb440-152"><a href="#cb440-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-153"><a href="#cb440-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-154"><a href="#cb440-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(message) {</span>
<span id="cb440-155"><a href="#cb440-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> error <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb440-156"><a href="#cb440-156" aria-hidden="true" tabindex="-1"></a>    error<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;error&#39;</span><span class="op">;</span></span>
<span id="cb440-157"><a href="#cb440-157" aria-hidden="true" tabindex="-1"></a>    error<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> message<span class="op">;</span></span>
<span id="cb440-158"><a href="#cb440-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fileList</span><span class="op">.</span><span class="fu">appendChild</span>(error)<span class="op">;</span></span>
<span id="cb440-159"><a href="#cb440-159" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> error<span class="op">.</span><span class="fu">remove</span>()<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb440-160"><a href="#cb440-160" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb440-161"><a href="#cb440-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb440-162"><a href="#cb440-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-163"><a href="#cb440-163" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;file-upload&#39;</span><span class="op">,</span> FileUpload)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.12" id="recipe-12-autocomplete-input"><span
class="header-section-number">26.12</span> Recipe 12: Autocomplete
Input</h2>
<p>Dropdown suggestions with keyboard navigation.</p>
<div class="sourceCode" id="cb441"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AutocompleteInput <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb441-5"><a href="#cb441-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">suggestions</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb441-6"><a href="#cb441-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-7"><a href="#cb441-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-8"><a href="#cb441-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb441-9"><a href="#cb441-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb441-10"><a href="#cb441-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb441-11"><a href="#cb441-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb441-12"><a href="#cb441-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .wrapper { position: relative; }</span></span>
<span id="cb441-13"><a href="#cb441-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        input {</span></span>
<span id="cb441-14"><a href="#cb441-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb441-15"><a href="#cb441-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb441-16"><a href="#cb441-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ccc;</span></span>
<span id="cb441-17"><a href="#cb441-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb441-18"><a href="#cb441-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb441-19"><a href="#cb441-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        .suggestions {</span></span>
<span id="cb441-20"><a href="#cb441-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb441-21"><a href="#cb441-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 100%;</span></span>
<span id="cb441-22"><a href="#cb441-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb441-23"><a href="#cb441-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb441-24"><a href="#cb441-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb441-25"><a href="#cb441-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ccc;</span></span>
<span id="cb441-26"><a href="#cb441-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-top: none;</span></span>
<span id="cb441-27"><a href="#cb441-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 200px;</span></span>
<span id="cb441-28"><a href="#cb441-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-y: auto;</span></span>
<span id="cb441-29"><a href="#cb441-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 1000;</span></span>
<span id="cb441-30"><a href="#cb441-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb441-31"><a href="#cb441-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb441-32"><a href="#cb441-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        .suggestions.open { display: block; }</span></span>
<span id="cb441-33"><a href="#cb441-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        .suggestion {</span></span>
<span id="cb441-34"><a href="#cb441-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb441-35"><a href="#cb441-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb441-36"><a href="#cb441-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb441-37"><a href="#cb441-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        .suggestion:hover, .suggestion.selected {</span></span>
<span id="cb441-38"><a href="#cb441-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f0f0f0;</span></span>
<span id="cb441-39"><a href="#cb441-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb441-40"><a href="#cb441-40" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb441-41"><a href="#cb441-41" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;wrapper&quot;&gt;</span></span>
<span id="cb441-42"><a href="#cb441-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;text&quot; placeholder=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;placeholder&#39;</span>) <span class="op">||</span> <span class="st">&#39;Search...&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb441-43"><a href="#cb441-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;suggestions&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb441-44"><a href="#cb441-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb441-45"><a href="#cb441-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb441-46"><a href="#cb441-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-47"><a href="#cb441-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb441-48"><a href="#cb441-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.suggestions&#39;</span>)<span class="op">;</span></span>
<span id="cb441-49"><a href="#cb441-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-50"><a href="#cb441-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupEvents</span>()<span class="op">;</span></span>
<span id="cb441-51"><a href="#cb441-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-52"><a href="#cb441-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-53"><a href="#cb441-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupEvents</span>() {</span>
<span id="cb441-54"><a href="#cb441-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleInput</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb441-55"><a href="#cb441-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleKeydown</span>(e))<span class="op">;</span></span>
<span id="cb441-56"><a href="#cb441-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;blur&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hideDropdown</span>()<span class="op">,</span> <span class="dv">200</span>))<span class="op">;</span></span>
<span id="cb441-57"><a href="#cb441-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-58"><a href="#cb441-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb441-59"><a href="#cb441-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;suggestion&#39;</span>)) {</span>
<span id="cb441-60"><a href="#cb441-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">selectSuggestion</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">textContent</span>)<span class="op">;</span></span>
<span id="cb441-61"><a href="#cb441-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb441-62"><a href="#cb441-62" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb441-63"><a href="#cb441-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-64"><a href="#cb441-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-65"><a href="#cb441-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleInput</span>(value) {</span>
<span id="cb441-66"><a href="#cb441-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb441-67"><a href="#cb441-67" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">hideDropdown</span>()<span class="op">;</span></span>
<span id="cb441-68"><a href="#cb441-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb441-69"><a href="#cb441-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb441-70"><a href="#cb441-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-71"><a href="#cb441-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb441-72"><a href="#cb441-72" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> apiUrl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;api&#39;</span>)<span class="op">;</span></span>
<span id="cb441-73"><a href="#cb441-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span>apiUrl<span class="sc">}</span><span class="vs">?q=</span><span class="sc">${</span><span class="pp">encodeURIComponent</span>(value)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb441-74"><a href="#cb441-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">suggestions</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb441-75"><a href="#cb441-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderSuggestions</span>()<span class="op">;</span></span>
<span id="cb441-76"><a href="#cb441-76" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb441-77"><a href="#cb441-77" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Autocomplete failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb441-78"><a href="#cb441-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb441-79"><a href="#cb441-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-80"><a href="#cb441-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-81"><a href="#cb441-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderSuggestions</span>() {</span>
<span id="cb441-82"><a href="#cb441-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">suggestions</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb441-83"><a href="#cb441-83" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">hideDropdown</span>()<span class="op">;</span></span>
<span id="cb441-84"><a href="#cb441-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb441-85"><a href="#cb441-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb441-86"><a href="#cb441-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-87"><a href="#cb441-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">suggestions</span></span>
<span id="cb441-88"><a href="#cb441-88" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> <span class="vs">`&lt;div class=&quot;suggestion&quot;&gt;</span><span class="sc">${</span>s<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span>)</span>
<span id="cb441-89"><a href="#cb441-89" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb441-90"><a href="#cb441-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb441-91"><a href="#cb441-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb441-92"><a href="#cb441-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-93"><a href="#cb441-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-94"><a href="#cb441-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleKeydown</span>(e) {</span>
<span id="cb441-95"><a href="#cb441-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> items <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.suggestion&#39;</span>)<span class="op">;</span></span>
<span id="cb441-96"><a href="#cb441-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-97"><a href="#cb441-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (e<span class="op">.</span><span class="at">key</span>) {</span>
<span id="cb441-98"><a href="#cb441-98" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;ArrowDown&#39;</span><span class="op">:</span></span>
<span id="cb441-99"><a href="#cb441-99" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb441-100"><a href="#cb441-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> items<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb441-101"><a href="#cb441-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateSelection</span>(items)<span class="op">;</span></span>
<span id="cb441-102"><a href="#cb441-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb441-103"><a href="#cb441-103" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;ArrowUp&#39;</span><span class="op">:</span></span>
<span id="cb441-104"><a href="#cb441-104" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb441-105"><a href="#cb441-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb441-106"><a href="#cb441-106" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateSelection</span>(items)<span class="op">;</span></span>
<span id="cb441-107"><a href="#cb441-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb441-108"><a href="#cb441-108" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;Enter&#39;</span><span class="op">:</span></span>
<span id="cb441-109"><a href="#cb441-109" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb441-110"><a href="#cb441-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">&gt;=</span> <span class="dv">0</span>) {</span>
<span id="cb441-111"><a href="#cb441-111" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">selectSuggestion</span>(items[<span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span>]<span class="op">.</span><span class="at">textContent</span>)<span class="op">;</span></span>
<span id="cb441-112"><a href="#cb441-112" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb441-113"><a href="#cb441-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb441-114"><a href="#cb441-114" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;Escape&#39;</span><span class="op">:</span></span>
<span id="cb441-115"><a href="#cb441-115" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">hideDropdown</span>()<span class="op">;</span></span>
<span id="cb441-116"><a href="#cb441-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb441-117"><a href="#cb441-117" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb441-118"><a href="#cb441-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-119"><a href="#cb441-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-120"><a href="#cb441-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateSelection</span>(items) {</span>
<span id="cb441-121"><a href="#cb441-121" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span><span class="fu">forEach</span>((item<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb441-122"><a href="#cb441-122" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&#39;selected&#39;</span><span class="op">,</span> i <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span>)<span class="op">;</span></span>
<span id="cb441-123"><a href="#cb441-123" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb441-124"><a href="#cb441-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-125"><a href="#cb441-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-126"><a href="#cb441-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selectSuggestion</span>(value) {</span>
<span id="cb441-127"><a href="#cb441-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">input</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb441-128"><a href="#cb441-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">hideDropdown</span>()<span class="op">;</span></span>
<span id="cb441-129"><a href="#cb441-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;autocomplete:selected&#39;</span><span class="op">,</span> { value })<span class="op">;</span></span>
<span id="cb441-130"><a href="#cb441-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-131"><a href="#cb441-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-132"><a href="#cb441-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hideDropdown</span>() {</span>
<span id="cb441-133"><a href="#cb441-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dropdown</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb441-134"><a href="#cb441-134" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">selectedIndex</span> <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb441-135"><a href="#cb441-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb441-136"><a href="#cb441-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb441-137"><a href="#cb441-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-138"><a href="#cb441-138" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;autocomplete-input&#39;</span><span class="op">,</span> AutocompleteInput)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.13" id="recipe-13-sortable-data-table"><span
class="header-section-number">26.13</span> Recipe 13: Sortable Data
Table</h2>
<p>Table with sortable columns and highlighting.</p>
<div class="sourceCode" id="cb442"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SortableTable <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">sortColumn</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">=</span> <span class="st">&#39;asc&#39;</span><span class="op">;</span></span>
<span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-7"><a href="#cb442-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-8"><a href="#cb442-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb442-9"><a href="#cb442-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;data&#39;</span>) <span class="op">||</span> <span class="st">&#39;[]&#39;</span>)<span class="op">;</span></span>
<span id="cb442-10"><a href="#cb442-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">columns</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;columns&#39;</span>) <span class="op">||</span> <span class="st">&#39;[]&#39;</span>)<span class="op">;</span></span>
<span id="cb442-11"><a href="#cb442-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb442-12"><a href="#cb442-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-13"><a href="#cb442-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-14"><a href="#cb442-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb442-15"><a href="#cb442-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb442-16"><a href="#cb442-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb442-17"><a href="#cb442-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        table { width: 100%; border-collapse: collapse; }</span></span>
<span id="cb442-18"><a href="#cb442-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        th {</span></span>
<span id="cb442-19"><a href="#cb442-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb442-20"><a href="#cb442-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.75rem;</span></span>
<span id="cb442-21"><a href="#cb442-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: left;</span></span>
<span id="cb442-22"><a href="#cb442-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb442-23"><a href="#cb442-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          user-select: none;</span></span>
<span id="cb442-24"><a href="#cb442-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb442-25"><a href="#cb442-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        th:hover { background: #e0e0e0; }</span></span>
<span id="cb442-26"><a href="#cb442-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        th.sorted::after {</span></span>
<span id="cb442-27"><a href="#cb442-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          content: &#39;↑&#39;;</span></span>
<span id="cb442-28"><a href="#cb442-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-left: 0.5rem;</span></span>
<span id="cb442-29"><a href="#cb442-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb442-30"><a href="#cb442-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        th.sorted.desc::after { content: &#39;↓&#39;; }</span></span>
<span id="cb442-31"><a href="#cb442-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        td { padding: 0.75rem; border-top: 1px solid #ddd; }</span></span>
<span id="cb442-32"><a href="#cb442-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        tr:hover { background: #f9f9f9; }</span></span>
<span id="cb442-33"><a href="#cb442-33" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb442-34"><a href="#cb442-34" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;table&gt;</span></span>
<span id="cb442-35"><a href="#cb442-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;thead&gt;</span></span>
<span id="cb442-36"><a href="#cb442-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;tr&gt;</span></span>
<span id="cb442-37"><a href="#cb442-37" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">columns</span><span class="op">.</span><span class="fu">map</span>(col <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb442-38"><a href="#cb442-38" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th data-key=&quot;</span><span class="sc">${</span>col<span class="op">.</span><span class="at">key</span><span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>col<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs">&lt;/th&gt;</span></span>
<span id="cb442-39"><a href="#cb442-39" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb442-40"><a href="#cb442-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/tr&gt;</span></span>
<span id="cb442-41"><a href="#cb442-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/thead&gt;</span></span>
<span id="cb442-42"><a href="#cb442-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;tbody&gt;</span></span>
<span id="cb442-43"><a href="#cb442-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">renderRows</span>()<span class="sc">}</span></span>
<span id="cb442-44"><a href="#cb442-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/tbody&gt;</span></span>
<span id="cb442-45"><a href="#cb442-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/table&gt;</span></span>
<span id="cb442-46"><a href="#cb442-46" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb442-47"><a href="#cb442-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-48"><a href="#cb442-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;th&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(th <span class="kw">=&gt;</span> {</span>
<span id="cb442-49"><a href="#cb442-49" aria-hidden="true" tabindex="-1"></a>      th<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleSort</span>(th<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">key</span>))<span class="op">;</span></span>
<span id="cb442-50"><a href="#cb442-50" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb442-51"><a href="#cb442-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-52"><a href="#cb442-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-53"><a href="#cb442-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderRows</span>() {</span>
<span id="cb442-54"><a href="#cb442-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb442-55"><a href="#cb442-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tr&gt;</span></span>
<span id="cb442-56"><a href="#cb442-56" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">columns</span><span class="op">.</span><span class="fu">map</span>(col <span class="kw">=&gt;</span> <span class="vs">`&lt;td&gt;</span><span class="sc">${</span>row[col<span class="op">.</span><span class="at">key</span>] <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&lt;/td&gt;`</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb442-57"><a href="#cb442-57" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/tr&gt;</span></span>
<span id="cb442-58"><a href="#cb442-58" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb442-59"><a href="#cb442-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-60"><a href="#cb442-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-61"><a href="#cb442-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleSort</span>(key) {</span>
<span id="cb442-62"><a href="#cb442-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">sortColumn</span> <span class="op">===</span> key) {</span>
<span id="cb442-63"><a href="#cb442-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">===</span> <span class="st">&#39;asc&#39;</span> <span class="op">?</span> <span class="st">&#39;desc&#39;</span> <span class="op">:</span> <span class="st">&#39;asc&#39;</span><span class="op">;</span></span>
<span id="cb442-64"><a href="#cb442-64" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb442-65"><a href="#cb442-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">sortColumn</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb442-66"><a href="#cb442-66" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">=</span> <span class="st">&#39;asc&#39;</span><span class="op">;</span></span>
<span id="cb442-67"><a href="#cb442-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb442-68"><a href="#cb442-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-69"><a href="#cb442-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb442-70"><a href="#cb442-70" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> aVal <span class="op">=</span> a[key]<span class="op">;</span></span>
<span id="cb442-71"><a href="#cb442-71" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bVal <span class="op">=</span> b[key]<span class="op">;</span></span>
<span id="cb442-72"><a href="#cb442-72" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> modifier <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">===</span> <span class="st">&#39;asc&#39;</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb442-73"><a href="#cb442-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-74"><a href="#cb442-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">typeof</span> aVal <span class="op">===</span> <span class="st">&#39;number&#39;</span>) {</span>
<span id="cb442-75"><a href="#cb442-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (aVal <span class="op">-</span> bVal) <span class="op">*</span> modifier<span class="op">;</span></span>
<span id="cb442-76"><a href="#cb442-76" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb442-77"><a href="#cb442-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">String</span>(aVal)<span class="op">.</span><span class="fu">localeCompare</span>(<span class="bu">String</span>(bVal)) <span class="op">*</span> modifier<span class="op">;</span></span>
<span id="cb442-78"><a href="#cb442-78" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb442-79"><a href="#cb442-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-80"><a href="#cb442-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb442-81"><a href="#cb442-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateSortIndicator</span>()<span class="op">;</span></span>
<span id="cb442-82"><a href="#cb442-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-83"><a href="#cb442-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-84"><a href="#cb442-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateSortIndicator</span>() {</span>
<span id="cb442-85"><a href="#cb442-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;th&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(th <span class="kw">=&gt;</span> {</span>
<span id="cb442-86"><a href="#cb442-86" aria-hidden="true" tabindex="-1"></a>      th<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;sorted&#39;</span><span class="op">,</span> <span class="st">&#39;desc&#39;</span>)<span class="op">;</span></span>
<span id="cb442-87"><a href="#cb442-87" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (th<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">sortColumn</span>) {</span>
<span id="cb442-88"><a href="#cb442-88" aria-hidden="true" tabindex="-1"></a>        th<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;sorted&#39;</span>)<span class="op">;</span></span>
<span id="cb442-89"><a href="#cb442-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">sortDirection</span> <span class="op">===</span> <span class="st">&#39;desc&#39;</span>) {</span>
<span id="cb442-90"><a href="#cb442-90" aria-hidden="true" tabindex="-1"></a>          th<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;desc&#39;</span>)<span class="op">;</span></span>
<span id="cb442-91"><a href="#cb442-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb442-92"><a href="#cb442-92" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb442-93"><a href="#cb442-93" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb442-94"><a href="#cb442-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-95"><a href="#cb442-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb442-96"><a href="#cb442-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-97"><a href="#cb442-97" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;sortable-table&#39;</span><span class="op">,</span> SortableTable)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.14" id="recipe-14-tabs-component"><span
class="header-section-number">26.14</span> Recipe 14: Tabs
Component</h2>
<p>Accessible tabs with keyboard support.</p>
<div class="sourceCode" id="cb443"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TabsComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentTab</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupKeyboardNav</span>()<span class="op">;</span></span>
<span id="cb443-7"><a href="#cb443-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-8"><a href="#cb443-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-9"><a href="#cb443-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb443-10"><a href="#cb443-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tabs <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[slot^=&quot;tab-&quot;]&#39;</span>))<span class="op">;</span></span>
<span id="cb443-11"><a href="#cb443-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> panels <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[slot^=&quot;panel-&quot;]&#39;</span>))<span class="op">;</span></span>
<span id="cb443-12"><a href="#cb443-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-13"><a href="#cb443-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb443-14"><a href="#cb443-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb443-15"><a href="#cb443-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        .tabs {</span></span>
<span id="cb443-16"><a href="#cb443-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb443-17"><a href="#cb443-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 2px solid #ddd;</span></span>
<span id="cb443-18"><a href="#cb443-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb443-19"><a href="#cb443-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb443-20"><a href="#cb443-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        .tab {</span></span>
<span id="cb443-21"><a href="#cb443-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.75rem 1.5rem;</span></span>
<span id="cb443-22"><a href="#cb443-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: none;</span></span>
<span id="cb443-23"><a href="#cb443-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb443-24"><a href="#cb443-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 2px solid transparent;</span></span>
<span id="cb443-25"><a href="#cb443-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb443-26"><a href="#cb443-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1rem;</span></span>
<span id="cb443-27"><a href="#cb443-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: all 0.3s;</span></span>
<span id="cb443-28"><a href="#cb443-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb443-29"><a href="#cb443-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        .tab:hover { background: #f5f5f5; }</span></span>
<span id="cb443-30"><a href="#cb443-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        .tab[aria-selected=&quot;true&quot;] {</span></span>
<span id="cb443-31"><a href="#cb443-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom-color: #2196f3;</span></span>
<span id="cb443-32"><a href="#cb443-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #2196f3;</span></span>
<span id="cb443-33"><a href="#cb443-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb443-34"><a href="#cb443-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        .panel {</span></span>
<span id="cb443-35"><a href="#cb443-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1.5rem 0;</span></span>
<span id="cb443-36"><a href="#cb443-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb443-37"><a href="#cb443-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb443-38"><a href="#cb443-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        .panel[aria-hidden=&quot;false&quot;] { display: block; }</span></span>
<span id="cb443-39"><a href="#cb443-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb443-40"><a href="#cb443-40" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;tabs&quot; role=&quot;tablist&quot;&gt;</span></span>
<span id="cb443-41"><a href="#cb443-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>tabs<span class="op">.</span><span class="fu">map</span>((tab<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb443-42"><a href="#cb443-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button</span></span>
<span id="cb443-43"><a href="#cb443-43" aria-hidden="true" tabindex="-1"></a><span class="vs">            class=&quot;tab&quot;</span></span>
<span id="cb443-44"><a href="#cb443-44" aria-hidden="true" tabindex="-1"></a><span class="vs">            role=&quot;tab&quot;</span></span>
<span id="cb443-45"><a href="#cb443-45" aria-hidden="true" tabindex="-1"></a><span class="vs">            aria-selected=&quot;</span><span class="sc">${</span>i <span class="op">===</span> <span class="dv">0</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-46"><a href="#cb443-46" aria-hidden="true" tabindex="-1"></a><span class="vs">            aria-controls=&quot;panel-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-47"><a href="#cb443-47" aria-hidden="true" tabindex="-1"></a><span class="vs">            id=&quot;tab-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-48"><a href="#cb443-48" aria-hidden="true" tabindex="-1"></a><span class="vs">            tabindex=&quot;</span><span class="sc">${</span>i <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb443-49"><a href="#cb443-49" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>tab<span class="op">.</span><span class="at">textContent</span><span class="sc">}</span></span>
<span id="cb443-50"><a href="#cb443-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/button&gt;</span></span>
<span id="cb443-51"><a href="#cb443-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb443-52"><a href="#cb443-52" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb443-53"><a href="#cb443-53" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>panels<span class="op">.</span><span class="fu">map</span>((panel<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb443-54"><a href="#cb443-54" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div</span></span>
<span id="cb443-55"><a href="#cb443-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          class=&quot;panel&quot;</span></span>
<span id="cb443-56"><a href="#cb443-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          role=&quot;tabpanel&quot;</span></span>
<span id="cb443-57"><a href="#cb443-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          id=&quot;panel-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-58"><a href="#cb443-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          aria-labelledby=&quot;tab-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-59"><a href="#cb443-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          aria-hidden=&quot;</span><span class="sc">${</span>i <span class="op">!==</span> <span class="dv">0</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb443-60"><a href="#cb443-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;panel-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb443-61"><a href="#cb443-61" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb443-62"><a href="#cb443-62" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb443-63"><a href="#cb443-63" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb443-64"><a href="#cb443-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-65"><a href="#cb443-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.tab&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>((tab<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb443-66"><a href="#cb443-66" aria-hidden="true" tabindex="-1"></a>      tab<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">selectTab</span>(i))<span class="op">;</span></span>
<span id="cb443-67"><a href="#cb443-67" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb443-68"><a href="#cb443-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-69"><a href="#cb443-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-70"><a href="#cb443-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selectTab</span>(index) {</span>
<span id="cb443-71"><a href="#cb443-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentTab</span> <span class="op">=</span> index<span class="op">;</span></span>
<span id="cb443-72"><a href="#cb443-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-73"><a href="#cb443-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.tab&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>((tab<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb443-74"><a href="#cb443-74" aria-hidden="true" tabindex="-1"></a>      tab<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;aria-selected&#39;</span><span class="op">,</span> i <span class="op">===</span> index)<span class="op">;</span></span>
<span id="cb443-75"><a href="#cb443-75" aria-hidden="true" tabindex="-1"></a>      tab<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;tabindex&#39;</span><span class="op">,</span> i <span class="op">===</span> index <span class="op">?</span> <span class="dv">0</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb443-76"><a href="#cb443-76" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb443-77"><a href="#cb443-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-78"><a href="#cb443-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.panel&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>((panel<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb443-79"><a href="#cb443-79" aria-hidden="true" tabindex="-1"></a>      panel<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;aria-hidden&#39;</span><span class="op">,</span> i <span class="op">!==</span> index)<span class="op">;</span></span>
<span id="cb443-80"><a href="#cb443-80" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb443-81"><a href="#cb443-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-82"><a href="#cb443-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;tab:changed&#39;</span><span class="op">,</span> { index })<span class="op">;</span></span>
<span id="cb443-83"><a href="#cb443-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-84"><a href="#cb443-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-85"><a href="#cb443-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupKeyboardNav</span>() {</span>
<span id="cb443-86"><a href="#cb443-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.tabs&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb443-87"><a href="#cb443-87" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> tabs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.tab&#39;</span>)<span class="op">;</span></span>
<span id="cb443-88"><a href="#cb443-88" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> newIndex <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentTab</span><span class="op">;</span></span>
<span id="cb443-89"><a href="#cb443-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-90"><a href="#cb443-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> (e<span class="op">.</span><span class="at">key</span>) {</span>
<span id="cb443-91"><a href="#cb443-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&#39;ArrowLeft&#39;</span><span class="op">:</span></span>
<span id="cb443-92"><a href="#cb443-92" aria-hidden="true" tabindex="-1"></a>          newIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">0</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentTab</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb443-93"><a href="#cb443-93" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb443-94"><a href="#cb443-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&#39;ArrowRight&#39;</span><span class="op">:</span></span>
<span id="cb443-95"><a href="#cb443-95" aria-hidden="true" tabindex="-1"></a>          newIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(tabs<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentTab</span> <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb443-96"><a href="#cb443-96" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb443-97"><a href="#cb443-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&#39;Home&#39;</span><span class="op">:</span></span>
<span id="cb443-98"><a href="#cb443-98" aria-hidden="true" tabindex="-1"></a>          newIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb443-99"><a href="#cb443-99" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb443-100"><a href="#cb443-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&#39;End&#39;</span><span class="op">:</span></span>
<span id="cb443-101"><a href="#cb443-101" aria-hidden="true" tabindex="-1"></a>          newIndex <span class="op">=</span> tabs<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb443-102"><a href="#cb443-102" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb443-103"><a href="#cb443-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb443-104"><a href="#cb443-104" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span><span class="op">;</span></span>
<span id="cb443-105"><a href="#cb443-105" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb443-106"><a href="#cb443-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-107"><a href="#cb443-107" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb443-108"><a href="#cb443-108" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">selectTab</span>(newIndex)<span class="op">;</span></span>
<span id="cb443-109"><a href="#cb443-109" aria-hidden="true" tabindex="-1"></a>      tabs[newIndex]<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb443-110"><a href="#cb443-110" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb443-111"><a href="#cb443-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-112"><a href="#cb443-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb443-113"><a href="#cb443-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-114"><a href="#cb443-114" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;tabs-component&#39;</span><span class="op">,</span> TabsComponent)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb444"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">tabs-component</span><span class="dt">&gt;</span></span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;tab-0&quot;</span><span class="dt">&gt;</span>Overview<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;tab-1&quot;</span><span class="dt">&gt;</span>Details<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">span</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;tab-2&quot;</span><span class="dt">&gt;</span>Reviews<span class="dt">&lt;/</span><span class="kw">span</span><span class="dt">&gt;</span></span>
<span id="cb444-5"><a href="#cb444-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb444-6"><a href="#cb444-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panel-0&quot;</span><span class="dt">&gt;&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Overview content...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb444-7"><a href="#cb444-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panel-1&quot;</span><span class="dt">&gt;&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Details content...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb444-8"><a href="#cb444-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panel-2&quot;</span><span class="dt">&gt;&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Reviews content...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb444-9"><a href="#cb444-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">tabs-component</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.15" id="recipe-15-accordion-component"><span
class="header-section-number">26.15</span> Recipe 15: Accordion
Component</h2>
<p>Expandable sections with smooth animations.</p>
<div class="sourceCode" id="cb445"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AccordionComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">allowMultiple</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;allow-multiple&#39;</span>)<span class="op">;</span></span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-6"><a href="#cb445-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-7"><a href="#cb445-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb445-8"><a href="#cb445-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> items <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[slot^=&quot;item-&quot;]&#39;</span>))<span class="op">;</span></span>
<span id="cb445-9"><a href="#cb445-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb445-10"><a href="#cb445-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb445-11"><a href="#cb445-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb445-12"><a href="#cb445-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-item {</span></span>
<span id="cb445-13"><a href="#cb445-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb445-14"><a href="#cb445-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 0.5rem;</span></span>
<span id="cb445-15"><a href="#cb445-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb445-16"><a href="#cb445-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-17"><a href="#cb445-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-header {</span></span>
<span id="cb445-18"><a href="#cb445-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb445-19"><a href="#cb445-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: space-between;</span></span>
<span id="cb445-20"><a href="#cb445-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb445-21"><a href="#cb445-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb445-22"><a href="#cb445-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb445-23"><a href="#cb445-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb445-24"><a href="#cb445-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          user-select: none;</span></span>
<span id="cb445-25"><a href="#cb445-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-26"><a href="#cb445-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-header:hover { background: #e0e0e0; }</span></span>
<span id="cb445-27"><a href="#cb445-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-icon {</span></span>
<span id="cb445-28"><a href="#cb445-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: transform 0.3s;</span></span>
<span id="cb445-29"><a href="#cb445-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-30"><a href="#cb445-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-item.open .accordion-icon {</span></span>
<span id="cb445-31"><a href="#cb445-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          transform: rotate(180deg);</span></span>
<span id="cb445-32"><a href="#cb445-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-33"><a href="#cb445-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-content {</span></span>
<span id="cb445-34"><a href="#cb445-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 0;</span></span>
<span id="cb445-35"><a href="#cb445-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: hidden;</span></span>
<span id="cb445-36"><a href="#cb445-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: max-height 0.3s ease;</span></span>
<span id="cb445-37"><a href="#cb445-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-38"><a href="#cb445-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-item.open .accordion-content {</span></span>
<span id="cb445-39"><a href="#cb445-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 500px;</span></span>
<span id="cb445-40"><a href="#cb445-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-41"><a href="#cb445-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        .accordion-body {</span></span>
<span id="cb445-42"><a href="#cb445-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb445-43"><a href="#cb445-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb445-44"><a href="#cb445-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb445-45"><a href="#cb445-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>items<span class="op">.</span><span class="fu">map</span>((item<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb445-46"><a href="#cb445-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> title <span class="op">=</span> item<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;title&quot;]&#39;</span>)<span class="op">?.</span><span class="at">textContent</span> <span class="op">||</span> <span class="vs">`Section </span><span class="sc">${</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb445-47"><a href="#cb445-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> content <span class="op">=</span> item<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;content&quot;]&#39;</span>)<span class="op">?.</span><span class="at">innerHTML</span> <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb445-48"><a href="#cb445-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb445-49"><a href="#cb445-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb445-50"><a href="#cb445-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;accordion-item&quot; data-index=&quot;</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb445-51"><a href="#cb445-51" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;accordion-header&quot;&gt;</span></span>
<span id="cb445-52"><a href="#cb445-52" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;span&gt;</span><span class="sc">${</span>title<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb445-53"><a href="#cb445-53" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;span class=&quot;accordion-icon&quot;&gt;▼&lt;/span&gt;</span></span>
<span id="cb445-54"><a href="#cb445-54" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb445-55"><a href="#cb445-55" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;accordion-content&quot;&gt;</span></span>
<span id="cb445-56"><a href="#cb445-56" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div class=&quot;accordion-body&quot;&gt;</span><span class="sc">${</span>content<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb445-57"><a href="#cb445-57" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb445-58"><a href="#cb445-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb445-59"><a href="#cb445-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb445-60"><a href="#cb445-60" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb445-61"><a href="#cb445-61" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb445-62"><a href="#cb445-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-63"><a href="#cb445-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.accordion-header&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(header <span class="kw">=&gt;</span> {</span>
<span id="cb445-64"><a href="#cb445-64" aria-hidden="true" tabindex="-1"></a>      header<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb445-65"><a href="#cb445-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> item <span class="op">=</span> header<span class="op">.</span><span class="at">parentElement</span><span class="op">;</span></span>
<span id="cb445-66"><a href="#cb445-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">toggleItem</span>(item)<span class="op">;</span></span>
<span id="cb445-67"><a href="#cb445-67" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb445-68"><a href="#cb445-68" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb445-69"><a href="#cb445-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-70"><a href="#cb445-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-71"><a href="#cb445-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toggleItem</span>(item) {</span>
<span id="cb445-72"><a href="#cb445-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isOpen <span class="op">=</span> item<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb445-73"><a href="#cb445-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-74"><a href="#cb445-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">allowMultiple</span>) {</span>
<span id="cb445-75"><a href="#cb445-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.accordion-item&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(i <span class="kw">=&gt;</span> {</span>
<span id="cb445-76"><a href="#cb445-76" aria-hidden="true" tabindex="-1"></a>        i<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb445-77"><a href="#cb445-77" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb445-78"><a href="#cb445-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb445-79"><a href="#cb445-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-80"><a href="#cb445-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>isOpen) {</span>
<span id="cb445-81"><a href="#cb445-81" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb445-82"><a href="#cb445-82" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;accordion:opened&#39;</span><span class="op">,</span> { <span class="dt">index</span><span class="op">:</span> item<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">index</span> })<span class="op">;</span></span>
<span id="cb445-83"><a href="#cb445-83" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb445-84"><a href="#cb445-84" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb445-85"><a href="#cb445-85" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;accordion:closed&#39;</span><span class="op">,</span> { <span class="dt">index</span><span class="op">:</span> item<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">index</span> })<span class="op">;</span></span>
<span id="cb445-86"><a href="#cb445-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb445-87"><a href="#cb445-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-88"><a href="#cb445-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb445-89"><a href="#cb445-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-90"><a href="#cb445-90" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;accordion-component&#39;</span><span class="op">,</span> AccordionComponent)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.16" id="recipe-16-context-menu"><span
class="header-section-number">26.16</span> Recipe 16: Context Menu</h2>
<p>Right-click custom menu.</p>
<div class="sourceCode" id="cb446"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContextMenu <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;items&#39;</span>) <span class="op">||</span> <span class="st">&#39;[]&#39;</span>)<span class="op">;</span></span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb446-6"><a href="#cb446-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupTriggers</span>()<span class="op">;</span></span>
<span id="cb446-7"><a href="#cb446-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-8"><a href="#cb446-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-9"><a href="#cb446-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb446-10"><a href="#cb446-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb446-11"><a href="#cb446-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb446-12"><a href="#cb446-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb446-13"><a href="#cb446-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb446-14"><a href="#cb446-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 10000;</span></span>
<span id="cb446-15"><a href="#cb446-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb446-16"><a href="#cb446-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb446-17"><a href="#cb446-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host(.visible) { display: block; }</span></span>
<span id="cb446-18"><a href="#cb446-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        .menu {</span></span>
<span id="cb446-19"><a href="#cb446-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb446-20"><a href="#cb446-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb446-21"><a href="#cb446-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb446-22"><a href="#cb446-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 2px 10px rgba(0,0,0,0.1);</span></span>
<span id="cb446-23"><a href="#cb446-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          min-width: 150px;</span></span>
<span id="cb446-24"><a href="#cb446-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb446-25"><a href="#cb446-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .menu-item {</span></span>
<span id="cb446-26"><a href="#cb446-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 1rem;</span></span>
<span id="cb446-27"><a href="#cb446-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb446-28"><a href="#cb446-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb446-29"><a href="#cb446-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb446-30"><a href="#cb446-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb446-31"><a href="#cb446-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb446-32"><a href="#cb446-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        .menu-item:hover { background: #f5f5f5; }</span></span>
<span id="cb446-33"><a href="#cb446-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        .menu-separator {</span></span>
<span id="cb446-34"><a href="#cb446-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 1px;</span></span>
<span id="cb446-35"><a href="#cb446-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #ddd;</span></span>
<span id="cb446-36"><a href="#cb446-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0.25rem 0;</span></span>
<span id="cb446-37"><a href="#cb446-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb446-38"><a href="#cb446-38" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb446-39"><a href="#cb446-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;menu&quot;&gt;</span></span>
<span id="cb446-40"><a href="#cb446-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> </span>
<span id="cb446-41"><a href="#cb446-41" aria-hidden="true" tabindex="-1"></a>          item<span class="op">.</span><span class="at">separator</span> </span>
<span id="cb446-42"><a href="#cb446-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">?</span> <span class="st">&#39;&lt;div class=&quot;menu-separator&quot;&gt;&lt;/div&gt;&#39;</span></span>
<span id="cb446-43"><a href="#cb446-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">:</span> <span class="vs">`&lt;div class=&quot;menu-item&quot; data-action=&quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">action</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb446-44"><a href="#cb446-44" aria-hidden="true" tabindex="-1"></a><span class="vs">                 </span><span class="sc">${</span>item<span class="op">.</span><span class="at">icon</span> <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span>item<span class="op">.</span><span class="at">label</span><span class="sc">}</span></span>
<span id="cb446-45"><a href="#cb446-45" aria-hidden="true" tabindex="-1"></a><span class="vs">               &lt;/div&gt;`</span></span>
<span id="cb446-46"><a href="#cb446-46" aria-hidden="true" tabindex="-1"></a>        )<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb446-47"><a href="#cb446-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb446-48"><a href="#cb446-48" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb446-49"><a href="#cb446-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-50"><a href="#cb446-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.menu-item&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb446-51"><a href="#cb446-51" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb446-52"><a href="#cb446-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handleAction</span>(item<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">action</span>)<span class="op">;</span></span>
<span id="cb446-53"><a href="#cb446-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">hide</span>()<span class="op">;</span></span>
<span id="cb446-54"><a href="#cb446-54" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb446-55"><a href="#cb446-55" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb446-56"><a href="#cb446-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-57"><a href="#cb446-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-58"><a href="#cb446-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupTriggers</span>() {</span>
<span id="cb446-59"><a href="#cb446-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> target <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;target&#39;</span>)<span class="op">;</span></span>
<span id="cb446-60"><a href="#cb446-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> elements <span class="op">=</span> target <span class="op">?</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(target) <span class="op">:</span> [<span class="bu">document</span>]<span class="op">;</span></span>
<span id="cb446-61"><a href="#cb446-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-62"><a href="#cb446-62" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> {</span>
<span id="cb446-63"><a href="#cb446-63" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;contextmenu&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb446-64"><a href="#cb446-64" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb446-65"><a href="#cb446-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">show</span>(e<span class="op">.</span><span class="at">clientX</span><span class="op">,</span> e<span class="op">.</span><span class="at">clientY</span><span class="op">,</span> el)<span class="op">;</span></span>
<span id="cb446-66"><a href="#cb446-66" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb446-67"><a href="#cb446-67" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb446-68"><a href="#cb446-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-69"><a href="#cb446-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hide</span>())<span class="op">;</span></span>
<span id="cb446-70"><a href="#cb446-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-71"><a href="#cb446-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-72"><a href="#cb446-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show</span>(x<span class="op">,</span> y<span class="op">,</span> target) {</span>
<span id="cb446-73"><a href="#cb446-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">left</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>x<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb446-74"><a href="#cb446-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">top</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>y<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb446-75"><a href="#cb446-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;visible&#39;</span>)<span class="op">;</span></span>
<span id="cb446-76"><a href="#cb446-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentTarget</span> <span class="op">=</span> target<span class="op">;</span></span>
<span id="cb446-77"><a href="#cb446-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-78"><a href="#cb446-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-79"><a href="#cb446-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hide</span>() {</span>
<span id="cb446-80"><a href="#cb446-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;visible&#39;</span>)<span class="op">;</span></span>
<span id="cb446-81"><a href="#cb446-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-82"><a href="#cb446-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-83"><a href="#cb446-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleAction</span>(action) {</span>
<span id="cb446-84"><a href="#cb446-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;context-menu:action&#39;</span><span class="op">,</span> {</span>
<span id="cb446-85"><a href="#cb446-85" aria-hidden="true" tabindex="-1"></a>      action<span class="op">,</span></span>
<span id="cb446-86"><a href="#cb446-86" aria-hidden="true" tabindex="-1"></a>      <span class="dt">target</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentTarget</span></span>
<span id="cb446-87"><a href="#cb446-87" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb446-88"><a href="#cb446-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-89"><a href="#cb446-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb446-90"><a href="#cb446-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-91"><a href="#cb446-91" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;context-menu&#39;</span><span class="op">,</span> ContextMenu)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb447"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">context-menu</span></span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  target</span><span class="op">=</span><span class="st">&quot;.list-item&quot;</span></span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  items</span><span class="op">=</span><span class="st">&#39;[</span></span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;label&quot;: &quot;Edit&quot;, &quot;action&quot;: &quot;edit&quot;, &quot;icon&quot;: &quot;✏️&quot;},</span></span>
<span id="cb447-5"><a href="#cb447-5" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;label&quot;: &quot;Delete&quot;, &quot;action&quot;: &quot;delete&quot;, &quot;icon&quot;: &quot;🗑️&quot;},</span></span>
<span id="cb447-6"><a href="#cb447-6" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;separator&quot;: true},</span></span>
<span id="cb447-7"><a href="#cb447-7" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;label&quot;: &quot;Share&quot;, &quot;action&quot;: &quot;share&quot;, &quot;icon&quot;: &quot;🔗&quot;}</span></span>
<span id="cb447-8"><a href="#cb447-8" aria-hidden="true" tabindex="-1"></a><span class="st">  ]&#39;</span><span class="dt">&gt;</span></span>
<span id="cb447-9"><a href="#cb447-9" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">context-menu</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.17" id="recipe-17-copy-to-clipboard"><span
class="header-section-number">26.17</span> Recipe 17: Copy to
Clipboard</h2>
<p>One-click copy with visual feedback.</p>
<div class="sourceCode" id="cb448"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CopyButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">text</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;text&#39;</span>) <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span><span class="op">;</span></span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb448-9"><a href="#cb448-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button class=&quot;copy-btn&quot;&gt;</span></span>
<span id="cb448-10"><a href="#cb448-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;icon&quot;&gt;📋&lt;/span&gt;</span></span>
<span id="cb448-11"><a href="#cb448-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;label&quot;&gt;Copy&lt;/span&gt;</span></span>
<span id="cb448-12"><a href="#cb448-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb448-13"><a href="#cb448-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb448-14"><a href="#cb448-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        .copy-btn {</span></span>
<span id="cb448-15"><a href="#cb448-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: inline-flex;</span></span>
<span id="cb448-16"><a href="#cb448-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb448-17"><a href="#cb448-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb448-18"><a href="#cb448-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 1rem;</span></span>
<span id="cb448-19"><a href="#cb448-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb448-20"><a href="#cb448-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb448-21"><a href="#cb448-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb448-22"><a href="#cb448-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb448-23"><a href="#cb448-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: all 0.3s;</span></span>
<span id="cb448-24"><a href="#cb448-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb448-25"><a href="#cb448-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .copy-btn:hover {</span></span>
<span id="cb448-26"><a href="#cb448-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb448-27"><a href="#cb448-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-color: #2196f3;</span></span>
<span id="cb448-28"><a href="#cb448-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb448-29"><a href="#cb448-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        .copy-btn.success {</span></span>
<span id="cb448-30"><a href="#cb448-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #4caf50;</span></span>
<span id="cb448-31"><a href="#cb448-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb448-32"><a href="#cb448-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-color: #4caf50;</span></span>
<span id="cb448-33"><a href="#cb448-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb448-34"><a href="#cb448-34" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb448-35"><a href="#cb448-35" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb448-36"><a href="#cb448-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-37"><a href="#cb448-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">button</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.copy-btn&#39;</span>)<span class="op">;</span></span>
<span id="cb448-38"><a href="#cb448-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">button</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">copyToClipboard</span>())<span class="op">;</span></span>
<span id="cb448-39"><a href="#cb448-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-40"><a href="#cb448-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-41"><a href="#cb448-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">copyToClipboard</span>() {</span>
<span id="cb448-42"><a href="#cb448-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb448-43"><a href="#cb448-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">clipboard</span><span class="op">.</span><span class="fu">writeText</span>(<span class="kw">this</span><span class="op">.</span><span class="at">text</span>)<span class="op">;</span></span>
<span id="cb448-44"><a href="#cb448-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>()<span class="op">;</span></span>
<span id="cb448-45"><a href="#cb448-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;clipboard:copied&#39;</span><span class="op">,</span> { <span class="dt">text</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">text</span> })<span class="op">;</span></span>
<span id="cb448-46"><a href="#cb448-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb448-47"><a href="#cb448-47" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Copy failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb448-48"><a href="#cb448-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>()<span class="op">;</span></span>
<span id="cb448-49"><a href="#cb448-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb448-50"><a href="#cb448-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-51"><a href="#cb448-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-52"><a href="#cb448-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showSuccess</span>() {</span>
<span id="cb448-53"><a href="#cb448-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> icon <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.icon&#39;</span>)<span class="op">;</span></span>
<span id="cb448-54"><a href="#cb448-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> label <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.label&#39;</span>)<span class="op">;</span></span>
<span id="cb448-55"><a href="#cb448-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb448-56"><a href="#cb448-56" aria-hidden="true" tabindex="-1"></a>    icon<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;✓&#39;</span><span class="op">;</span></span>
<span id="cb448-57"><a href="#cb448-57" aria-hidden="true" tabindex="-1"></a>    label<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Copied!&#39;</span><span class="op">;</span></span>
<span id="cb448-58"><a href="#cb448-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">button</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;success&#39;</span>)<span class="op">;</span></span>
<span id="cb448-59"><a href="#cb448-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-60"><a href="#cb448-60" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb448-61"><a href="#cb448-61" aria-hidden="true" tabindex="-1"></a>      icon<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;📋&#39;</span><span class="op">;</span></span>
<span id="cb448-62"><a href="#cb448-62" aria-hidden="true" tabindex="-1"></a>      label<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Copy&#39;</span><span class="op">;</span></span>
<span id="cb448-63"><a href="#cb448-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">button</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;success&#39;</span>)<span class="op">;</span></span>
<span id="cb448-64"><a href="#cb448-64" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb448-65"><a href="#cb448-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-66"><a href="#cb448-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-67"><a href="#cb448-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>() {</span>
<span id="cb448-68"><a href="#cb448-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> label <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.label&#39;</span>)<span class="op">;</span></span>
<span id="cb448-69"><a href="#cb448-69" aria-hidden="true" tabindex="-1"></a>    label<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Failed&#39;</span><span class="op">;</span></span>
<span id="cb448-70"><a href="#cb448-70" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb448-71"><a href="#cb448-71" aria-hidden="true" tabindex="-1"></a>      label<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Copy&#39;</span><span class="op">;</span></span>
<span id="cb448-72"><a href="#cb448-72" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb448-73"><a href="#cb448-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-74"><a href="#cb448-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb448-75"><a href="#cb448-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-76"><a href="#cb448-76" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;copy-button&#39;</span><span class="op">,</span> CopyButton)<span class="op">;</span></span></code></pre></div>
<h2 data-number="26.18" id="recipe-18-dark-mode-toggle"><span
class="header-section-number">26.18</span> Recipe 18: Dark Mode
Toggle</h2>
<p>Theme switching with system preference detection and persistence.</p>
<div class="sourceCode" id="cb449"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DarkModeToggle <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">initTheme</span>()<span class="op">;</span></span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb449-6"><a href="#cb449-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-7"><a href="#cb449-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-8"><a href="#cb449-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initTheme</span>() {</span>
<span id="cb449-9"><a href="#cb449-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> saved <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;theme&#39;</span>)<span class="op">;</span></span>
<span id="cb449-10"><a href="#cb449-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> systemPrefers <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="fu">matchMedia</span>(<span class="st">&#39;(prefers-color-scheme: dark)&#39;</span>)<span class="op">.</span><span class="at">matches</span><span class="op">;</span></span>
<span id="cb449-11"><a href="#cb449-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">=</span> saved <span class="op">||</span> (systemPrefers <span class="op">?</span> <span class="st">&#39;dark&#39;</span> <span class="op">:</span> <span class="st">&#39;light&#39;</span>)<span class="op">;</span></span>
<span id="cb449-12"><a href="#cb449-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>()<span class="op">;</span></span>
<span id="cb449-13"><a href="#cb449-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-14"><a href="#cb449-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for system theme changes</span></span>
<span id="cb449-15"><a href="#cb449-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">matchMedia</span>(<span class="st">&#39;(prefers-color-scheme: dark)&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb449-16"><a href="#cb449-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;theme&#39;</span>)) {</span>
<span id="cb449-17"><a href="#cb449-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">=</span> e<span class="op">.</span><span class="at">matches</span> <span class="op">?</span> <span class="st">&#39;dark&#39;</span> <span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">;</span></span>
<span id="cb449-18"><a href="#cb449-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>()<span class="op">;</span></span>
<span id="cb449-19"><a href="#cb449-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb449-20"><a href="#cb449-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb449-21"><a href="#cb449-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-22"><a href="#cb449-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-23"><a href="#cb449-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb449-24"><a href="#cb449-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb449-25"><a href="#cb449-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb449-26"><a href="#cb449-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb449-27"><a href="#cb449-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: none;</span></span>
<span id="cb449-28"><a href="#cb449-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid var(--border-color, #ddd);</span></span>
<span id="cb449-29"><a href="#cb449-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 2rem;</span></span>
<span id="cb449-30"><a href="#cb449-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 1rem;</span></span>
<span id="cb449-31"><a href="#cb449-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb449-32"><a href="#cb449-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb449-33"><a href="#cb449-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb449-34"><a href="#cb449-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb449-35"><a href="#cb449-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1rem;</span></span>
<span id="cb449-36"><a href="#cb449-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: all 0.3s;</span></span>
<span id="cb449-37"><a href="#cb449-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb449-38"><a href="#cb449-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb449-39"><a href="#cb449-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--hover-bg, #f5f5f5);</span></span>
<span id="cb449-40"><a href="#cb449-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb449-41"><a href="#cb449-41" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb449-42"><a href="#cb449-42" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;</span></span>
<span id="cb449-43"><a href="#cb449-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;icon&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">===</span> <span class="st">&#39;dark&#39;</span> <span class="op">?</span> <span class="st">&#39;🌙&#39;</span> <span class="op">:</span> <span class="st">&#39;☀️&#39;</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb449-44"><a href="#cb449-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">===</span> <span class="st">&#39;dark&#39;</span> <span class="op">?</span> <span class="st">&#39;Dark&#39;</span> <span class="op">:</span> <span class="st">&#39;Light&#39;</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb449-45"><a href="#cb449-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb449-46"><a href="#cb449-46" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb449-47"><a href="#cb449-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-48"><a href="#cb449-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">toggle</span>())<span class="op">;</span></span>
<span id="cb449-49"><a href="#cb449-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-50"><a href="#cb449-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-51"><a href="#cb449-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toggle</span>() {</span>
<span id="cb449-52"><a href="#cb449-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">theme</span> <span class="op">===</span> <span class="st">&#39;light&#39;</span> <span class="op">?</span> <span class="st">&#39;dark&#39;</span> <span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">;</span></span>
<span id="cb449-53"><a href="#cb449-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>()<span class="op">;</span></span>
<span id="cb449-54"><a href="#cb449-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">saveTheme</span>()<span class="op">;</span></span>
<span id="cb449-55"><a href="#cb449-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb449-56"><a href="#cb449-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-57"><a href="#cb449-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-58"><a href="#cb449-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>() {</span>
<span id="cb449-59"><a href="#cb449-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb449-60"><a href="#cb449-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">colorScheme</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">theme</span><span class="op">;</span></span>
<span id="cb449-61"><a href="#cb449-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;theme:changed&#39;</span><span class="op">,</span> { <span class="dt">theme</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">theme</span> })<span class="op">;</span></span>
<span id="cb449-62"><a href="#cb449-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-63"><a href="#cb449-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-64"><a href="#cb449-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveTheme</span>() {</span>
<span id="cb449-65"><a href="#cb449-65" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb449-66"><a href="#cb449-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb449-67"><a href="#cb449-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb449-68"><a href="#cb449-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-69"><a href="#cb449-69" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;dark-mode-toggle&#39;</span><span class="op">,</span> DarkModeToggle)<span class="op">;</span></span></code></pre></div>
<p><strong>CSS Variables:</strong></p>
<div class="sourceCode" id="cb450"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">--bg-color</span><span class="ch">:</span> <span class="cn">white</span><span class="op">;</span></span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--text-color</span><span class="ch">:</span> <span class="cn">#333</span><span class="op">;</span></span>
<span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-color</span><span class="ch">:</span> <span class="cn">#ddd</span><span class="op">;</span></span>
<span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[</span><span class="ss">data-theme</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="ex">]</span> {</span>
<span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">--bg-color</span><span class="ch">:</span> <span class="cn">#1a1a1a</span><span class="op">;</span></span>
<span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">--text-color</span><span class="ch">:</span> <span class="cn">#f0f0f0</span><span class="op">;</span></span>
<span id="cb450-10"><a href="#cb450-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-color</span><span class="ch">:</span> <span class="cn">#444</span><span class="op">;</span></span>
<span id="cb450-11"><a href="#cb450-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb450-12"><a href="#cb450-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-13"><a href="#cb450-13" aria-hidden="true" tabindex="-1"></a>body {</span>
<span id="cb450-14"><a href="#cb450-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--bg-color</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb450-15"><a href="#cb450-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">color</span><span class="ch">:</span> <span class="fu">var(</span><span class="va">--text-color</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb450-16"><a href="#cb450-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">transition</span><span class="ch">:</span> <span class="dv">background 0.3</span><span class="dt">s</span><span class="op">,</span> <span class="dv">color</span> <span class="dv">0.3</span><span class="dt">s</span><span class="op">;</span></span>
<span id="cb450-17"><a href="#cb450-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="26.19" id="recipe-19-skeleton-loader"><span
class="header-section-number">26.19</span> Recipe 19: Skeleton
Loader</h2>
<p>Loading placeholders for better perceived performance.</p>
<div class="sourceCode" id="cb451"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SkeletonLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">type</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;type&#39;</span>) <span class="op">||</span> <span class="st">&#39;text&#39;</span><span class="op">;</span></span>
<span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">lines</span> <span class="op">=</span> <span class="pp">parseInt</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;lines&#39;</span>)) <span class="op">||</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb451-9"><a href="#cb451-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> templates <span class="op">=</span> {</span>
<span id="cb451-10"><a href="#cb451-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">text</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderTextSkeleton</span>()<span class="op">,</span></span>
<span id="cb451-11"><a href="#cb451-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">card</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderCardSkeleton</span>()<span class="op">,</span></span>
<span id="cb451-12"><a href="#cb451-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">list</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderListSkeleton</span>()<span class="op">,</span></span>
<span id="cb451-13"><a href="#cb451-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">profile</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderProfileSkeleton</span>()</span>
<span id="cb451-14"><a href="#cb451-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb451-15"><a href="#cb451-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-16"><a href="#cb451-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb451-17"><a href="#cb451-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb451-18"><a href="#cb451-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        .skeleton {</span></span>
<span id="cb451-19"><a href="#cb451-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: pulse 1.5s ease-in-out infinite;</span></span>
<span id="cb451-20"><a href="#cb451-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb451-21"><a href="#cb451-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        @keyframes pulse {</span></span>
<span id="cb451-22"><a href="#cb451-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          0%, 100% { opacity: 1; }</span></span>
<span id="cb451-23"><a href="#cb451-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          50% { opacity: 0.4; }</span></span>
<span id="cb451-24"><a href="#cb451-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb451-25"><a href="#cb451-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .skeleton-line {</span></span>
<span id="cb451-26"><a href="#cb451-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 1rem;</span></span>
<span id="cb451-27"><a href="#cb451-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e0e0e0;</span></span>
<span id="cb451-28"><a href="#cb451-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.25rem;</span></span>
<span id="cb451-29"><a href="#cb451-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 0.5rem;</span></span>
<span id="cb451-30"><a href="#cb451-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb451-31"><a href="#cb451-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        .skeleton-circle {</span></span>
<span id="cb451-32"><a href="#cb451-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 50px;</span></span>
<span id="cb451-33"><a href="#cb451-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 50px;</span></span>
<span id="cb451-34"><a href="#cb451-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 50%;</span></span>
<span id="cb451-35"><a href="#cb451-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e0e0e0;</span></span>
<span id="cb451-36"><a href="#cb451-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb451-37"><a href="#cb451-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        .skeleton-rect {</span></span>
<span id="cb451-38"><a href="#cb451-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 200px;</span></span>
<span id="cb451-39"><a href="#cb451-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e0e0e0;</span></span>
<span id="cb451-40"><a href="#cb451-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 0.5rem;</span></span>
<span id="cb451-41"><a href="#cb451-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 1rem;</span></span>
<span id="cb451-42"><a href="#cb451-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb451-43"><a href="#cb451-43" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb451-44"><a href="#cb451-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span>templates[<span class="kw">this</span><span class="op">.</span><span class="at">type</span>] <span class="op">||</span> templates<span class="op">.</span><span class="at">text</span><span class="sc">}</span></span>
<span id="cb451-45"><a href="#cb451-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb451-46"><a href="#cb451-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-47"><a href="#cb451-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-48"><a href="#cb451-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderTextSkeleton</span>() {</span>
<span id="cb451-49"><a href="#cb451-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span>(<span class="kw">this</span><span class="op">.</span><span class="at">lines</span>)</span>
<span id="cb451-50"><a href="#cb451-50" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)</span>
<span id="cb451-51"><a href="#cb451-51" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((_<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb451-52"><a href="#cb451-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> width <span class="op">=</span> i <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">lines</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">?</span> <span class="st">&#39;60%&#39;</span> <span class="op">:</span> <span class="st">&#39;100%&#39;</span><span class="op">;</span></span>
<span id="cb451-53"><a href="#cb451-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`&lt;div class=&quot;skeleton skeleton-line&quot; style=&quot;width: </span><span class="sc">${</span>width<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb451-54"><a href="#cb451-54" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb451-55"><a href="#cb451-55" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb451-56"><a href="#cb451-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-57"><a href="#cb451-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-58"><a href="#cb451-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderCardSkeleton</span>() {</span>
<span id="cb451-59"><a href="#cb451-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb451-60"><a href="#cb451-60" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;skeleton skeleton-rect&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-61"><a href="#cb451-61" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">renderTextSkeleton</span>()<span class="sc">}</span></span>
<span id="cb451-62"><a href="#cb451-62" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb451-63"><a href="#cb451-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-64"><a href="#cb451-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-65"><a href="#cb451-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderListSkeleton</span>() {</span>
<span id="cb451-66"><a href="#cb451-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span>(<span class="kw">this</span><span class="op">.</span><span class="at">lines</span>)</span>
<span id="cb451-67"><a href="#cb451-67" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)</span>
<span id="cb451-68"><a href="#cb451-68" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(() <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb451-69"><a href="#cb451-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style=&quot;display: flex; gap: 1rem; margin-bottom: 1rem;&quot;&gt;</span></span>
<span id="cb451-70"><a href="#cb451-70" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton skeleton-circle&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-71"><a href="#cb451-71" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style=&quot;flex: 1;&quot;&gt;</span></span>
<span id="cb451-72"><a href="#cb451-72" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;skeleton skeleton-line&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-73"><a href="#cb451-73" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;skeleton skeleton-line&quot; style=&quot;width: 70%&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-74"><a href="#cb451-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb451-75"><a href="#cb451-75" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb451-76"><a href="#cb451-76" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)</span>
<span id="cb451-77"><a href="#cb451-77" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb451-78"><a href="#cb451-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-79"><a href="#cb451-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-80"><a href="#cb451-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderProfileSkeleton</span>() {</span>
<span id="cb451-81"><a href="#cb451-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb451-82"><a href="#cb451-82" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;display: flex; gap: 1rem; align-items: center;&quot;&gt;</span></span>
<span id="cb451-83"><a href="#cb451-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;skeleton skeleton-circle&quot; style=&quot;width: 80px; height: 80px;&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-84"><a href="#cb451-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style=&quot;flex: 1;&quot;&gt;</span></span>
<span id="cb451-85"><a href="#cb451-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton skeleton-line&quot; style=&quot;width: 200px;&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-86"><a href="#cb451-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton skeleton-line&quot; style=&quot;width: 150px;&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb451-87"><a href="#cb451-87" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb451-88"><a href="#cb451-88" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb451-89"><a href="#cb451-89" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb451-90"><a href="#cb451-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-91"><a href="#cb451-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb451-92"><a href="#cb451-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-93"><a href="#cb451-93" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;skeleton-loader&#39;</span><span class="op">,</span> SkeletonLoader)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb452"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">skeleton-loader</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;card&quot;</span><span class="ot"> lines</span><span class="op">=</span><span class="st">&quot;3&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">skeleton-loader</span><span class="dt">&gt;</span></span>
<span id="cb452-2"><a href="#cb452-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">skeleton-loader</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;list&quot;</span><span class="ot"> lines</span><span class="op">=</span><span class="st">&quot;5&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">skeleton-loader</span><span class="dt">&gt;</span></span>
<span id="cb452-3"><a href="#cb452-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">skeleton-loader</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;profile&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">skeleton-loader</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.20" id="recipe-20-countdown-timer"><span
class="header-section-number">26.20</span> Recipe 20: Countdown
Timer</h2>
<p>Countdown timer with custom formatting.</p>
<div class="sourceCode" id="cb453"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CountdownTimer <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">targetDate</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;target&#39;</span>))<span class="op">.</span><span class="fu">getTime</span>()<span class="op">;</span></span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">format</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;format&#39;</span>) <span class="op">||</span> <span class="st">&#39;dhms&#39;</span><span class="op">;</span> <span class="co">// days, hours, minutes, seconds</span></span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">startCountdown</span>()<span class="op">;</span></span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-9"><a href="#cb453-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb453-10"><a href="#cb453-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb453-11"><a href="#cb453-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb453-12"><a href="#cb453-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .countdown {</span></span>
<span id="cb453-13"><a href="#cb453-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb453-14"><a href="#cb453-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 1rem;</span></span>
<span id="cb453-15"><a href="#cb453-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-family: monospace;</span></span>
<span id="cb453-16"><a href="#cb453-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb453-17"><a href="#cb453-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        .time-unit {</span></span>
<span id="cb453-18"><a href="#cb453-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb453-19"><a href="#cb453-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb453-20"><a href="#cb453-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        .value {</span></span>
<span id="cb453-21"><a href="#cb453-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb453-22"><a href="#cb453-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 2rem;</span></span>
<span id="cb453-23"><a href="#cb453-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb453-24"><a href="#cb453-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb453-25"><a href="#cb453-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .label {</span></span>
<span id="cb453-26"><a href="#cb453-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb453-27"><a href="#cb453-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 0.875rem;</span></span>
<span id="cb453-28"><a href="#cb453-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb453-29"><a href="#cb453-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-transform: uppercase;</span></span>
<span id="cb453-30"><a href="#cb453-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb453-31"><a href="#cb453-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        .expired {</span></span>
<span id="cb453-32"><a href="#cb453-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #f44336;</span></span>
<span id="cb453-33"><a href="#cb453-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1.5rem;</span></span>
<span id="cb453-34"><a href="#cb453-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb453-35"><a href="#cb453-35" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb453-36"><a href="#cb453-36" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;countdown&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb453-37"><a href="#cb453-37" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb453-38"><a href="#cb453-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-39"><a href="#cb453-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">container</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.countdown&#39;</span>)<span class="op">;</span></span>
<span id="cb453-40"><a href="#cb453-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb453-41"><a href="#cb453-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-42"><a href="#cb453-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">startCountdown</span>() {</span>
<span id="cb453-43"><a href="#cb453-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateDisplay</span>()<span class="op">;</span></span>
<span id="cb453-44"><a href="#cb453-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">interval</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">updateDisplay</span>()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb453-45"><a href="#cb453-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb453-46"><a href="#cb453-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-47"><a href="#cb453-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateDisplay</span>() {</span>
<span id="cb453-48"><a href="#cb453-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb453-49"><a href="#cb453-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> distance <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">targetDate</span> <span class="op">-</span> now<span class="op">;</span></span>
<span id="cb453-50"><a href="#cb453-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-51"><a href="#cb453-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (distance <span class="op">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb453-52"><a href="#cb453-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">container</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;expired&quot;&gt;Time expired!&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb453-53"><a href="#cb453-53" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">interval</span>)<span class="op">;</span></span>
<span id="cb453-54"><a href="#cb453-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;countdown:expired&#39;</span><span class="op">,</span> { <span class="dt">target</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">targetDate</span> })<span class="op">;</span></span>
<span id="cb453-55"><a href="#cb453-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb453-56"><a href="#cb453-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb453-57"><a href="#cb453-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-58"><a href="#cb453-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> days <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(distance <span class="op">/</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">24</span>))<span class="op">;</span></span>
<span id="cb453-59"><a href="#cb453-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> hours <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>((distance <span class="op">%</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">24</span>)) <span class="op">/</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span>))<span class="op">;</span></span>
<span id="cb453-60"><a href="#cb453-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> minutes <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>((distance <span class="op">%</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span>)) <span class="op">/</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span>))<span class="op">;</span></span>
<span id="cb453-61"><a href="#cb453-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> seconds <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>((distance <span class="op">%</span> (<span class="dv">1000</span> <span class="op">*</span> <span class="dv">60</span>)) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb453-62"><a href="#cb453-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-63"><a href="#cb453-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parts <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb453-64"><a href="#cb453-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;d&#39;</span>)) parts<span class="op">.</span><span class="fu">push</span>({ <span class="dt">value</span><span class="op">:</span> days<span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Days&#39;</span> })<span class="op">;</span></span>
<span id="cb453-65"><a href="#cb453-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;h&#39;</span>)) parts<span class="op">.</span><span class="fu">push</span>({ <span class="dt">value</span><span class="op">:</span> hours<span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Hours&#39;</span> })<span class="op">;</span></span>
<span id="cb453-66"><a href="#cb453-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;m&#39;</span>)) parts<span class="op">.</span><span class="fu">push</span>({ <span class="dt">value</span><span class="op">:</span> minutes<span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Minutes&#39;</span> })<span class="op">;</span></span>
<span id="cb453-67"><a href="#cb453-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">format</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;s&#39;</span>)) parts<span class="op">.</span><span class="fu">push</span>({ <span class="dt">value</span><span class="op">:</span> seconds<span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Seconds&#39;</span> })<span class="op">;</span></span>
<span id="cb453-68"><a href="#cb453-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-69"><a href="#cb453-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">container</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> parts</span>
<span id="cb453-70"><a href="#cb453-70" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb453-71"><a href="#cb453-71" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;time-unit&quot;&gt;</span></span>
<span id="cb453-72"><a href="#cb453-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;value&quot;&gt;</span><span class="sc">${</span><span class="bu">String</span>(p<span class="op">.</span><span class="at">value</span>)<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>)<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb453-73"><a href="#cb453-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;label&quot;&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">label</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb453-74"><a href="#cb453-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb453-75"><a href="#cb453-75" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)</span>
<span id="cb453-76"><a href="#cb453-76" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb453-77"><a href="#cb453-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb453-78"><a href="#cb453-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-79"><a href="#cb453-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb453-80"><a href="#cb453-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">interval</span>) {</span>
<span id="cb453-81"><a href="#cb453-81" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">interval</span>)<span class="op">;</span></span>
<span id="cb453-82"><a href="#cb453-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb453-83"><a href="#cb453-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb453-84"><a href="#cb453-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb453-85"><a href="#cb453-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-86"><a href="#cb453-86" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;countdown-timer&#39;</span><span class="op">,</span> CountdownTimer)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb454"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">countdown-timer</span><span class="ot"> target</span><span class="op">=</span><span class="st">&quot;2024-12-31T23:59:59&quot;</span><span class="ot"> format</span><span class="op">=</span><span class="st">&quot;dhms&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">countdown-timer</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.21" id="recipe-21-progress-bar"><span
class="header-section-number">26.21</span> Recipe 21: Progress Bar</h2>
<p>Visual progress indicator with customization.</p>
<div class="sourceCode" id="cb455"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProgressBar <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="pp">parseFloat</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;value&#39;</span>)) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">max</span> <span class="op">=</span> <span class="pp">parseFloat</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;max&#39;</span>)) <span class="op">||</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">showLabel</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;show-label&#39;</span>)<span class="op">;</span></span>
<span id="cb455-7"><a href="#cb455-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb455-8"><a href="#cb455-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-9"><a href="#cb455-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;progress:update&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb455-10"><a href="#cb455-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">event</span><span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">id</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb455-11"><a href="#cb455-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateProgress</span>(<span class="bu">event</span><span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb455-12"><a href="#cb455-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb455-13"><a href="#cb455-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb455-14"><a href="#cb455-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb455-15"><a href="#cb455-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-16"><a href="#cb455-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb455-17"><a href="#cb455-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> percent <span class="op">=</span> (<span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">max</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb455-18"><a href="#cb455-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-19"><a href="#cb455-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb455-20"><a href="#cb455-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb455-21"><a href="#cb455-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        .progress-container {</span></span>
<span id="cb455-22"><a href="#cb455-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb455-23"><a href="#cb455-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e0e0e0;</span></span>
<span id="cb455-24"><a href="#cb455-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 1rem;</span></span>
<span id="cb455-25"><a href="#cb455-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: hidden;</span></span>
<span id="cb455-26"><a href="#cb455-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: relative;</span></span>
<span id="cb455-27"><a href="#cb455-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb455-28"><a href="#cb455-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        .progress-bar {</span></span>
<span id="cb455-29"><a href="#cb455-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 2rem;</span></span>
<span id="cb455-30"><a href="#cb455-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: linear-gradient(90deg, #4caf50, #8bc34a);</span></span>
<span id="cb455-31"><a href="#cb455-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 1rem;</span></span>
<span id="cb455-32"><a href="#cb455-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: width 0.3s ease;</span></span>
<span id="cb455-33"><a href="#cb455-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb455-34"><a href="#cb455-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb455-35"><a href="#cb455-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: center;</span></span>
<span id="cb455-36"><a href="#cb455-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb455-37"><a href="#cb455-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb455-38"><a href="#cb455-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb455-39"><a href="#cb455-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        .label {</span></span>
<span id="cb455-40"><a href="#cb455-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb455-41"><a href="#cb455-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb455-42"><a href="#cb455-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb455-43"><a href="#cb455-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          line-height: 2rem;</span></span>
<span id="cb455-44"><a href="#cb455-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: </span><span class="sc">${</span>percent <span class="op">&gt;</span> <span class="dv">50</span> <span class="op">?</span> <span class="st">&#39;white&#39;</span> <span class="op">:</span> <span class="st">&#39;#333&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb455-45"><a href="#cb455-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 1;</span></span>
<span id="cb455-46"><a href="#cb455-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb455-47"><a href="#cb455-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb455-48"><a href="#cb455-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;progress-container&quot;&gt;</span></span>
<span id="cb455-49"><a href="#cb455-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">showLabel</span> <span class="op">?</span> <span class="vs">`&lt;div class=&quot;label&quot;&gt;</span><span class="sc">${</span>percent<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs">%&lt;/div&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb455-50"><a href="#cb455-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;progress-bar&quot; style=&quot;width: </span><span class="sc">${</span>percent<span class="sc">}</span><span class="vs">%&quot;&gt;</span></span>
<span id="cb455-51"><a href="#cb455-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb455-52"><a href="#cb455-52" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb455-53"><a href="#cb455-53" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb455-54"><a href="#cb455-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb455-55"><a href="#cb455-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-56"><a href="#cb455-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateProgress</span>(value) {</span>
<span id="cb455-57"><a href="#cb455-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb455-58"><a href="#cb455-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;value&#39;</span><span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb455-59"><a href="#cb455-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb455-60"><a href="#cb455-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-61"><a href="#cb455-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">&gt;=</span> <span class="kw">this</span><span class="op">.</span><span class="at">max</span>) {</span>
<span id="cb455-62"><a href="#cb455-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;progress:complete&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb455-63"><a href="#cb455-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb455-64"><a href="#cb455-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb455-65"><a href="#cb455-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-66"><a href="#cb455-66" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb455-67"><a href="#cb455-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&#39;value&#39;</span>]<span class="op">;</span></span>
<span id="cb455-68"><a href="#cb455-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb455-69"><a href="#cb455-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-70"><a href="#cb455-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb455-71"><a href="#cb455-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;value&#39;</span> <span class="op">&amp;&amp;</span> oldValue <span class="op">!==</span> newValue) {</span>
<span id="cb455-72"><a href="#cb455-72" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="pp">parseFloat</span>(newValue)<span class="op">;</span></span>
<span id="cb455-73"><a href="#cb455-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb455-74"><a href="#cb455-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb455-75"><a href="#cb455-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb455-76"><a href="#cb455-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb455-77"><a href="#cb455-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-78"><a href="#cb455-78" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;progress-bar&#39;</span><span class="op">,</span> ProgressBar)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb456"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">progress-bar</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;upload-progress&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;45&quot;</span><span class="ot"> max</span><span class="op">=</span><span class="st">&quot;100&quot;</span><span class="ot"> show-label</span><span class="dt">&gt;&lt;/</span><span class="kw">progress-bar</span><span class="dt">&gt;</span></span>
<span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb456-3"><a href="#cb456-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb456-4"><a href="#cb456-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Update progress</span></span>
<span id="cb456-5"><a href="#cb456-5" aria-hidden="true" tabindex="-1"></a>pc<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;progress:update&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="st">&#39;upload-progress&#39;</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">75</span> })<span class="op">;</span></span>
<span id="cb456-6"><a href="#cb456-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="26.22" id="common-patterns-3"><span
class="header-section-number">26.22</span> Common Patterns</h2>
<h3 data-number="26.22.1" id="pattern-component-composition"><span
class="header-section-number">26.22.1</span> Pattern: Component
Composition</h3>
<p>Build complex components from simpler ones.</p>
<div class="sourceCode" id="cb457"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb457-4"><a href="#cb457-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;user-avatar user-id=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/user-avatar&gt;</span></span>
<span id="cb457-5"><a href="#cb457-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;user-details user-id=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/user-details&gt;</span></span>
<span id="cb457-6"><a href="#cb457-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;user-actions user-id=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/user-actions&gt;</span></span>
<span id="cb457-7"><a href="#cb457-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb457-8"><a href="#cb457-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb457-9"><a href="#cb457-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="26.22.2" id="pattern-higher-order-components"><span
class="header-section-number">26.22.2</span> Pattern: Higher-Order
Components</h3>
<p>Wrap components with additional functionality.</p>
<div class="sourceCode" id="cb458"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">withLoading</span>(ComponentClass) {</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">class</span> <span class="kw">extends</span> ComponentClass {</span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">connectedCallback</span>() {</span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showLoader</span>()<span class="op">;</span></span>
<span id="cb458-5"><a href="#cb458-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">super</span><span class="op">.</span><span class="fu">connectedCallback</span>()<span class="op">;</span></span>
<span id="cb458-6"><a href="#cb458-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb458-7"><a href="#cb458-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-8"><a href="#cb458-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">showLoader</span>() {</span>
<span id="cb458-9"><a href="#cb458-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;loader&quot;&gt;Loading...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb458-10"><a href="#cb458-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb458-11"><a href="#cb458-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb458-12"><a href="#cb458-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb458-13"><a href="#cb458-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-14"><a href="#cb458-14" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-card&#39;</span><span class="op">,</span> <span class="fu">withLoading</span>(UserCard))<span class="op">;</span></span></code></pre></div>
<h3 data-number="26.22.3" id="pattern-singleton-services"><span
class="header-section-number">26.22.3</span> Pattern: Singleton
Services</h3>
<p>Share a single instance across components.</p>
<div class="sourceCode" id="cb459"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataCache {</span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> instance <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="fu">getInstance</span>() {</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>DataCache<span class="op">.</span><span class="at">instance</span>) {</span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a>      DataCache<span class="op">.</span><span class="at">instance</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">DataCache</span>()<span class="op">;</span></span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb459-8"><a href="#cb459-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DataCache<span class="op">.</span><span class="at">instance</span><span class="op">;</span></span>
<span id="cb459-9"><a href="#cb459-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb459-10"><a href="#cb459-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-11"><a href="#cb459-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb459-12"><a href="#cb459-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb459-13"><a href="#cb459-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb459-14"><a href="#cb459-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-15"><a href="#cb459-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(key) {</span>
<span id="cb459-16"><a href="#cb459-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb459-17"><a href="#cb459-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb459-18"><a href="#cb459-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-19"><a href="#cb459-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(key<span class="op">,</span> value) {</span>
<span id="cb459-20"><a href="#cb459-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb459-21"><a href="#cb459-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb459-22"><a href="#cb459-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="26.23" id="anti-patterns-to-avoid"><span
class="header-section-number">26.23</span> Anti-Patterns to Avoid</h2>
<h3 data-number="26.23.1" id="anti-pattern-tight-coupling"><span
class="header-section-number">26.23.1</span> Anti-Pattern: Tight
Coupling</h3>
<p><strong>Bad:</strong></p>
<div class="sourceCode" id="cb460"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ComponentA <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;component-b&#39;</span>)<span class="op">.</span><span class="fu">doSomething</span>()<span class="op">;</span></span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb460-5"><a href="#cb460-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Good:</strong></p>
<div class="sourceCode" id="cb461"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ComponentA <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;action:requested&#39;</span><span class="op">,</span> { data })<span class="op">;</span></span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="26.23.2" id="anti-pattern-massive-components"><span
class="header-section-number">26.23.2</span> Anti-Pattern: Massive
Components</h3>
<p><strong>Bad:</strong> 500-line components handling everything.</p>
<p><strong>Good:</strong> Break into focused, single-responsibility
components.</p>
<h3 data-number="26.23.3" id="anti-pattern-ignoring-lifecycle"><span
class="header-section-number">26.23.3</span> Anti-Pattern: Ignoring
Lifecycle</h3>
<p><strong>Bad:</strong></p>
<div class="sourceCode" id="cb462"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BadComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb462-4"><a href="#cb462-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div&gt;Content&lt;/div&gt;&#39;</span><span class="op">;</span> <span class="co">// Too early!</span></span>
<span id="cb462-5"><a href="#cb462-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb462-6"><a href="#cb462-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Good:</strong></p>
<div class="sourceCode" id="cb463"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GoodComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb463-2"><a href="#cb463-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb463-3"><a href="#cb463-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div&gt;Content&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb463-4"><a href="#cb463-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb463-5"><a href="#cb463-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="26.23.4" id="anti-pattern-manual-memory-leaks"><span
class="header-section-number">26.23.4</span> Anti-Pattern: Manual Memory
Leaks</h3>
<p><strong>Bad:</strong></p>
<div class="sourceCode" id="cb464"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;event&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Never unsubscribed!</span></span>
<span id="cb464-4"><a href="#cb464-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Good:</strong></p>
<div class="sourceCode" id="cb465"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">pan</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;event&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb465-4"><a href="#cb465-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-5"><a href="#cb465-5" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnectedCallback</span>() {</span>
<span id="cb465-6"><a href="#cb465-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb465-7"><a href="#cb465-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>These recipes provide battle-tested solutions for common scenarios.
Adapt them to your needs, understanding the principles behind each
pattern. The best code is readable, maintainable, and solves the problem
at hand without unnecessary complexity.</p>
<h1 data-number="27" id="glossary"><span
class="header-section-number">27</span> Glossary</h1>
<p>This glossary defines technical terms, LARC-specific concepts, and
web standards references used throughout this manual. Terms are
presented in alphabetical order with clear definitions and, where
relevant, cross-references to related concepts.</p>
<h2 data-number="27.1" id="a"><span
class="header-section-number">27.1</span> A</h2>
<p><strong>Adapter</strong> A design pattern that converts one interface
to another. In LARC contexts, adapters bridge LARC components with
external libraries or non-standard APIs.</p>
<p><strong>Attribute</strong> An HTML element property set via markup
(e.g., <code>&lt;my-component data-id="123"&gt;</code>). LARC components
observe attributes through <code>observedAttributes</code> and respond
to changes via <code>attributeChangedCallback()</code>.</p>
<p><strong>Autonomous Custom Element</strong> A Web Component that
extends <code>HTMLElement</code> directly rather than extending built-in
HTML elements. LARC components are autonomous custom elements. Compare
with <em>Customized Built-in Element</em>.</p>
<h2 data-number="27.2" id="b"><span
class="header-section-number">27.2</span> B</h2>
<p><strong>Batch Update</strong> An optimization technique that groups
multiple state changes into a single render cycle, reducing unnecessary
DOM operations and improving performance.</p>
<p><strong>Binding</strong> The connection between a data source and its
visual representation. LARC uses event-driven updates rather than
automatic data binding, giving developers explicit control over
rendering.</p>
<p><strong>Browser Event</strong> Standard DOM events like
<code>click</code>, <code>input</code>, or <code>submit</code>. LARC
components listen to browser events and can translate them into PAN bus
events for application-wide communication.</p>
<p><strong>Bubble</strong> Event propagation through the DOM tree from
child to parent elements. Browser events bubble by default; custom
events must explicitly enable bubbling via
<code>bubbles: true</code>.</p>
<h2 data-number="27.3" id="c"><span
class="header-section-number">27.3</span> C</h2>
<p><strong>Callback</strong> A function passed as an argument to another
function, executed after a specific event or operation completes. LARC
lifecycle methods (<code>connectedCallback</code>,
<code>disconnectedCallback</code>) are callbacks invoked by the browser
at specific times.</p>
<p><strong>Composed</strong> An event property that determines whether
the event crosses Shadow DOM boundaries. Set via
<code>composed: true</code> in event initialization. Essential for
events that need to traverse shadow roots.</p>
<p><strong>Component</strong> A self-contained, reusable user interface
element. In LARC, components are Web Components registered via
<code>customElements.define()</code> and implementing standard lifecycle
callbacks.</p>
<p><strong>Custom Element</strong> The Web Components standard for
creating new HTML elements with custom behavior. LARC applications are
built from custom elements. See also <em>Autonomous Custom
Element</em>.</p>
<p><strong>Customized Built-in Element</strong> A Web Component that
extends an existing HTML element (e.g.,
<code>&lt;button is="fancy-button"&gt;</code>). LARC primarily uses
autonomous custom elements rather than customized built-ins.</p>
<h2 data-number="27.4" id="d"><span
class="header-section-number">27.4</span> D</h2>
<p><strong>Declarative</strong> A programming style that describes
<em>what</em> should happen rather than <em>how</em>. HTML templates are
declarative. Contrast with <em>Imperative</em>.</p>
<p><strong>Dependency Injection</strong> A pattern where dependencies
are provided to a component rather than created internally. LARC
components receive the PAN bus reference rather than accessing a global
singleton.</p>
<p><strong>Dispatch</strong> Sending an event to the PAN bus for other
components to receive. Called via
<code>this.pan.dispatch(eventType, detail)</code>.</p>
<p><strong>DOM (Document Object Model)</strong> The browser’s
representation of an HTML document as a tree of objects. LARC components
manipulate the DOM through standard APIs.</p>
<h2 data-number="27.5" id="e"><span
class="header-section-number">27.5</span> E</h2>
<p><strong>Element</strong> A node in the DOM tree representing an HTML
tag. Custom elements are specialized elements with developer-defined
behavior.</p>
<p><strong>Emit</strong> Synonym for <em>dispatch</em>. Some frameworks
use “emit” for event publication. LARC prefers “dispatch” to align with
standard DOM terminology.</p>
<p><strong>Encapsulation</strong> Hiding internal implementation details
from external code. Shadow DOM provides style encapsulation; JavaScript
class private fields provide data encapsulation.</p>
<p><strong>Event</strong> A signal indicating something happened.
Browser events (clicks, inputs) and custom events (PAN bus messages)
both use the Event API.</p>
<p><strong>Event Target</strong> Any object that can receive events and
have listeners registered on it. All DOM nodes are event targets; the
PAN bus is also an event target.</p>
<h2 data-number="27.6" id="f"><span
class="header-section-number">27.6</span> F</h2>
<p><strong>Fragment</strong> A <code>DocumentFragment</code> is a
lightweight container for DOM nodes that can be manipulated off-screen
and inserted into the document in one operation, reducing reflows.</p>
<p><strong>Framework</strong> A comprehensive library providing
structure and conventions for application development. LARC is a
lightweight component architecture rather than a full framework,
emphasizing web standards.</p>
<h2 data-number="27.7" id="h"><span
class="header-section-number">27.7</span> H</h2>
<p><strong>HTML Template</strong> The <code>&lt;template&gt;</code>
element stores client-side content that won’t render until explicitly
instantiated. Useful for defining reusable markup structures.</p>
<p><strong>Hydration</strong> The process of attaching event listeners
and state to server-rendered HTML. LARC components hydrate automatically
when defined via <code>customElements.define()</code>.</p>
<h2 data-number="27.8" id="i"><span
class="header-section-number">27.8</span> I</h2>
<p><strong>Imperative</strong> A programming style describing
<em>how</em> to accomplish a task through explicit instructions.
JavaScript is imperative. Contrast with <em>Declarative</em>.</p>
<p><strong>Intersection Observer</strong> A browser API for efficiently
detecting when elements enter or leave the viewport. Used for lazy
loading, infinite scroll, and visibility tracking.</p>
<h2 data-number="27.9" id="l"><span
class="header-section-number">27.9</span> L</h2>
<p><strong>LARC (Lightweight Asynchronous Reactive Components)</strong>
The component architecture described in this manual, emphasizing web
standards, minimal abstraction, and explicit communication patterns.</p>
<p><strong>Lifecycle</strong> The sequence of states a component passes
through: creation, attachment to DOM, updates, and removal. LARC
components implement standard Web Components lifecycle callbacks.</p>
<p><strong>Lifecycle Callback</strong> Methods invoked by the browser at
specific points in a component’s lifecycle: <code>constructor()</code>,
<code>connectedCallback()</code>, <code>disconnectedCallback()</code>,
<code>attributeChangedCallback()</code>,
<code>adoptedCallback()</code>.</p>
<p><strong>Light DOM</strong> Regular DOM content, as opposed to Shadow
DOM. Content placed inside a custom element’s tags lives in the light
DOM and can be redistributed via <code>&lt;slot&gt;</code>.</p>
<h2 data-number="27.10" id="m"><span
class="header-section-number">27.10</span> M</h2>
<p><strong>Microtask</strong> A JavaScript task scheduled via
<code>Promise.then()</code> or <code>queueMicrotask()</code>. Microtasks
run before the browser’s next rendering cycle, useful for batching
updates.</p>
<p><strong>Module</strong> An ES6 module
(<code>import</code>/<code>export</code>) that encapsulates code. LARC
components are typically defined as modules, one component per file.</p>
<p><strong>Mutation Observer</strong> A browser API for watching DOM
changes. Less commonly needed in LARC since components manage their own
rendering.</p>
<h2 data-number="27.11" id="n"><span
class="header-section-number">27.11</span> N</h2>
<p><strong>Namespace</strong> A prefix used to group related events or
APIs. LARC encourages namespacing PAN bus events (e.g.,
<code>user:login</code>, <code>user:logout</code>) for better
organization.</p>
<p><strong>Node</strong> A basic DOM building block. Elements, text, and
comments are all nodes. Components manipulate nodes through standard DOM
APIs.</p>
<h2 data-number="27.12" id="o"><span
class="header-section-number">27.12</span> O</h2>
<p><strong>Observer Pattern</strong> A design pattern where objects
(observers) subscribe to state changes in another object (subject). The
PAN bus implements the observer pattern.</p>
<p><strong>observedAttributes</strong> A static getter on custom element
classes listing attributes the component wants to monitor. Changes
trigger <code>attributeChangedCallback()</code>.</p>
<h2 data-number="27.13" id="p"><span
class="header-section-number">27.13</span> P</h2>
<p><strong>PAN Bus (Publish-and-subscribe Asynchronous Notification
Bus)</strong> LARC’s event system for component communication.
Components dispatch events to the bus and subscribe to events they care
about, enabling loose coupling.</p>
<p><strong>Polyfill</strong> JavaScript code that implements modern
features in older browsers. Web Components polyfills enable LARC
applications to run in browsers without native support.</p>
<p><strong>Prop (Property)</strong> Short for “property,” data passed to
a component. In LARC, complex data typically flows through PAN bus
events rather than attributes, since attributes are limited to
strings.</p>
<p><strong>Publish-Subscribe</strong> A messaging pattern where
publishers send messages to topics/channels, and subscribers receive
messages from those topics. The PAN bus is a pub-sub system.</p>
<h2 data-number="27.14" id="r"><span
class="header-section-number">27.14</span> R</h2>
<p><strong>Reactive</strong> A programming model where the UI
automatically updates in response to data changes. LARC components
implement reactivity explicitly through PAN bus subscriptions rather
than automatic binding.</p>
<p><strong>Reconciliation</strong> The process of determining minimal
DOM changes needed to reflect new state. LARC leaves reconciliation to
developers or optional libraries rather than providing built-in virtual
DOM diffing.</p>
<p><strong>Render</strong> Convert data into visual representation. In
LARC, rendering is explicit—components call their own
<code>render()</code> methods when appropriate.</p>
<p><strong>Reflow</strong> The browser’s process of recalculating
element positions and dimensions. Excessive reflows hurt performance.
LARC’s batch updates minimize reflows.</p>
<h2 data-number="27.15" id="s"><span
class="header-section-number">27.15</span> S</h2>
<p><strong>Scoped Styles</strong> CSS that applies only to a specific
component without affecting other elements. Shadow DOM provides
automatic style scoping.</p>
<p><strong>Shadow DOM</strong> A web standard for attaching encapsulated
DOM trees to elements. Shadow DOM provides style and markup
encapsulation, preventing styles from leaking in or out.</p>
<p><strong>Shadow Host</strong> The element to which a shadow root is
attached. When you call <code>this.attachShadow()</code> on a custom
element, that element becomes the shadow host.</p>
<p><strong>Shadow Root</strong> The root of a shadow DOM tree, created
via <code>element.attachShadow()</code>. Content inside the shadow root
is isolated from the main document.</p>
<p><strong>Slot</strong> A Shadow DOM feature for distributing light DOM
content into shadow DOM. Defined with <code>&lt;slot&gt;</code> elements
and allowing flexible content composition.</p>
<p><strong>State</strong> Data that determines component appearance and
behavior. LARC encourages explicit state management through component
properties and PAN bus events.</p>
<p><strong>Subscribe</strong> Registering a listener for events on the
PAN bus. Called via <code>this.pan.subscribe(eventType, handler)</code>,
returns an unsubscribe function.</p>
<h2 data-number="27.16" id="t"><span
class="header-section-number">27.16</span> T</h2>
<p><strong>Template</strong> Reusable markup structure. Can refer to
HTML <code>&lt;template&gt;</code> elements or template literals
(backtick strings) used for generating HTML.</p>
<p><strong>Template Literal</strong> JavaScript’s backtick string syntax
supporting multiline strings and interpolation. Commonly used for
component templates: <code>`&lt;div&gt;${value}&lt;/div&gt;`</code>.</p>
<p><strong>Throttle</strong> Limiting function execution frequency.
Unlike debouncing (which delays until activity stops), throttling
ensures a function runs at most once per time interval.</p>
<h2 data-number="27.17" id="u"><span
class="header-section-number">27.17</span> U</h2>
<p><strong>Unsubscribe</strong> Removing a listener from the PAN bus.
The function returned by <code>subscribe()</code> acts as an unsubscribe
callback, essential for preventing memory leaks.</p>
<p><strong>User Agent</strong> The browser or other software accessing a
web application. User agent strings identify the browser type and
version.</p>
<h2 data-number="27.18" id="v"><span
class="header-section-number">27.18</span> V</h2>
<p><strong>Virtual DOM</strong> An in-memory representation of the DOM
used to calculate minimal changes before applying them. LARC doesn’t
include built-in virtual DOM, preferring explicit control or optional
libraries.</p>
<h2 data-number="27.19" id="w"><span
class="header-section-number">27.19</span> W</h2>
<p><strong>Web Component</strong> An umbrella term for three standards:
Custom Elements, Shadow DOM, and HTML Templates. LARC applications are
built on Web Components.</p>
<p><strong>Web Standards</strong> Specifications maintained by standards
bodies (W3C, WHATWG) defining how web technologies work. LARC
prioritizes web standards over proprietary abstractions.</p>
<h2 data-number="27.20" id="larc-specific-terms"><span
class="header-section-number">27.20</span> LARC-Specific Terms</h2>
<p><strong>Component Bus</strong> A dedicated PAN bus instance for a
specific component subtree. Allows isolated event scopes within larger
applications. Most applications use a single global bus.</p>
<p><strong>Component Tree</strong> The hierarchical structure of custom
elements in an application. Events and data flow through this tree via
the PAN bus.</p>
<p><strong>Event Detail</strong> The <code>detail</code> property of a
custom event, containing application-specific data. PAN bus events place
their payload in the detail object.</p>
<p><strong>Event Type</strong> A string identifying an event category
(e.g., <code>'user:login'</code>, <code>'data:loaded'</code>). LARC
encourages namespaced, descriptive event types.</p>
<p><strong>Pan Property</strong> The <code>pan</code> property on custom
elements, providing access to the PAN bus. Automatically injected by
LARC’s component initialization.</p>
<p><strong>Reactive Primitive</strong> Basic reactive building blocks
like reactive objects, computed values, and watchers. LARC’s optional
reactivity system provides these as lightweight utilities.</p>
<p><strong>Unidirectional Data Flow</strong> An architecture where data
flows in one direction through an application. LARC encourages this
through PAN bus events: components dispatch actions upward and listen
for state changes downward.</p>
<h2 data-number="27.21" id="web-standards-references"><span
class="header-section-number">27.21</span> Web Standards References</h2>
<p><strong>CustomElementRegistry</strong> The browser’s registry of
defined custom elements, accessed via
<code>window.customElements</code>. Provides <code>define()</code>,
<code>get()</code>, <code>whenDefined()</code>, and
<code>upgrade()</code> methods.</p>
<p><strong>Event.prototype.composed</strong> Boolean property indicating
whether an event crosses shadow DOM boundaries during event
propagation.</p>
<p><strong>Event.prototype.bubbles</strong> Boolean property indicating
whether an event propagates up the DOM tree from its target.</p>
<p><strong>HTMLElement</strong> The base interface for HTML elements.
All LARC components extend <code>HTMLElement</code> or its
subclasses.</p>
<p><strong>MutationObserver API</strong> Interface for observing DOM
mutations. Occasionally useful for LARC components that need to react to
external DOM changes.</p>
<p><strong>ShadowRoot</strong> Interface representing the root of a
shadow DOM tree, providing methods like <code>querySelector()</code>
that operate within the shadow scope.</p>
<p><strong>shadowRoot.mode</strong> The encapsulation mode of a shadow
root: <code>'open'</code> (accessible via
<code>element.shadowRoot</code>) or <code>'closed'</code> (inaccessible
from outside). LARC recommends open mode for testability.</p>
<h2 data-number="27.22" id="acronyms-and-abbreviations"><span
class="header-section-number">27.22</span> Acronyms and
Abbreviations</h2>
<p><strong>API</strong> - Application Programming Interface
<strong>CDN</strong> - Content Delivery Network <strong>CSS</strong> -
Cascading Style Sheets <strong>DOM</strong> - Document Object Model
<strong>ES6</strong> - ECMAScript 2015 (JavaScript version)
<strong>HTML</strong> - HyperText Markup Language <strong>HTTP</strong>
- HyperText Transfer Protocol <strong>JSX</strong> - JavaScript XML
(React’s template syntax, not part of LARC) <strong>LARC</strong> -
Lightweight Asynchronous Reactive Components <strong>MVC</strong> -
Model-View-Controller <strong>NPM</strong> - Node Package Manager
<strong>PAN</strong> - Publish-and-subscribe Asynchronous Notification
<strong>REST</strong> - Representational State Transfer
<strong>SPA</strong> - Single-Page Application <strong>SSR</strong> -
Server-Side Rendering <strong>UI</strong> - User Interface
<strong>URL</strong> - Uniform Resource Locator <strong>VDOM</strong> -
Virtual DOM <strong>W3C</strong> - World Wide Web Consortium
<strong>WHATWG</strong> - Web Hypertext Application Technology Working
Group</p>
<h2 data-number="27.23" id="related-concepts"><span
class="header-section-number">27.23</span> Related Concepts</h2>
<p><strong>Component Lifecycle</strong> See <em>Lifecycle</em> and
<em>Lifecycle Callback</em>.</p>
<p><strong>Custom Events</strong> Events created via
<code>new CustomEvent()</code> rather than browser-generated events. PAN
bus events are custom events.</p>
<p><strong>Event-Driven Architecture</strong> An architectural pattern
where components communicate through events rather than direct method
calls. LARC’s PAN bus enables event-driven architecture.</p>
<p><strong>Loose Coupling</strong> Design principle where components
depend on abstractions (event types) rather than concrete
implementations (specific components), making systems more flexible and
maintainable.</p>
<p><strong>Separation of Concerns</strong> Design principle where
different aspects of functionality are handled by different components.
LARC components encapsulate specific UI concerns, communicating via
well-defined events.</p>
<p><strong>Single Responsibility Principle</strong> Each component
should have one clear purpose. LARC encourages focused components that
do one thing well.</p>
<h2 data-number="27.24" id="further-reading"><span
class="header-section-number">27.24</span> Further Reading</h2>
<p><strong>MDN Web Docs (developer.mozilla.org)</strong> Comprehensive
reference for Web APIs, including Web Components, DOM manipulation, and
JavaScript features.</p>
<p><strong>Web Components Specifications</strong> Official standards
documents at w3.org and whatwg.org defining Custom Elements, Shadow DOM,
and HTML Templates.</p>
<p><strong>LARC Documentation</strong> Complete API reference and guides
at larc.dev.</p>
<p><strong>ECMAScript Specifications</strong> JavaScript language
specifications at tc39.es.</p>
<hr />
<p>This glossary covers core concepts needed to work effectively with
LARC. For deeper exploration of specific topics, consult the main
chapters of this manual and the reference materials listed above.
Understanding these terms and their relationships helps you write
clearer code, communicate more effectively with other developers, and
leverage the full power of web standards in your applications.</p>
<h1 data-number="28" id="resources"><span
class="header-section-number">28</span> Resources</h1>
<p>This appendix provides a curated collection of resources for
learning, using, and extending LARC. Whether you’re getting started,
troubleshooting a problem, or contributing to the ecosystem, these links
will help you find what you need.</p>
<h2 data-number="28.1" id="official-documentation"><span
class="header-section-number">28.1</span> Official Documentation</h2>
<h3 data-number="28.1.1" id="primary-documentation"><span
class="header-section-number">28.1.1</span> Primary Documentation</h3>
<p><strong>LARC Core Repository</strong> https://github.com/larcjs/larc
The main LARC repository containing the core framework source code,
examples, and technical documentation. This is the authoritative source
for implementation details and includes the complete test suite.</p>
<p><strong>LARC Components Library</strong>
https://github.com/larcjs/larc/tree/main/packages/components Official
component library with production-ready UI components, data components,
integration components, and utilities. Each component includes
comprehensive documentation and working examples.</p>
<p><strong>API Reference</strong> https://larcjs.com/api Complete API
documentation for all core classes, components, and utilities. Includes
type definitions, method signatures, and interactive examples.</p>
<p><strong>Getting Started Guide</strong>
https://larcjs.com/getting-started Quick-start guide for new developers.
Walks through installation, first application, and core concepts in 30
minutes.</p>
<h3 data-number="28.1.2" id="companion-books"><span
class="header-section-number">28.1.2</span> Companion Books</h3>
<p><strong>Learning LARC</strong> The tutorial-focused companion to this
reference manual. Organized around progressive learning with hands-on
exercises, projects, and quizzes. Ideal for developers new to LARC or
component-based architecture.</p>
<p><strong>Building with LARC: A Reference Manual</strong> This book.
Comprehensive reference covering all aspects of LARC development from
core concepts to advanced patterns. Available online at
https://larcjs.com/reference</p>
<h2 data-number="28.2" id="community-resources"><span
class="header-section-number">28.2</span> Community Resources</h2>
<h3 data-number="28.2.1" id="forums-and-discussion"><span
class="header-section-number">28.2.1</span> Forums and Discussion</h3>
<p><strong>LARC Discussions (GitHub)</strong>
https://github.com/larcjs/larc/discussions Official discussion forum for
LARC developers. Ask questions, share projects, discuss patterns, and
connect with other developers. Monitored by core maintainers.</p>
<p><strong>Stack Overflow</strong>
https://stackoverflow.com/questions/tagged/larc Tag: <code>larc</code>
For technical troubleshooting and specific programming questions. Search
existing questions before posting new ones.</p>
<p><strong>Discord Community</strong> https://discord.gg/zjUPsWTu
Real-time chat for LARC developers. Channels for beginners, advanced
topics, component development, and off-topic discussion. Most active
community hub.</p>
<p><strong>Reddit r/larcjs</strong> https://reddit.com/r/larcjs
Community-run subreddit for LARC news, showcases, and discussion. Good
for project feedback and ecosystem updates.</p>
<h3 data-number="28.2.2" id="social-media"><span
class="header-section-number">28.2.2</span> Social Media</h3>
<p><strong>Twitter/X: <span class="citation"
data-cites="larcjs">@larcjs</span></strong> https://twitter.com/larcjs
Official Twitter account for announcements, tips, and community
highlights. Follow for news about releases, events, and ecosystem
updates.</p>
<p><strong>Mastodon: <span class="citation"
data-cites="larcjs">@larcjs</span><span class="citation"
data-cites="fosstodon.org">@fosstodon.org</span></strong>
https://fosstodon.org/<span class="citation"
data-cites="larcjs">@larcjs</span> Official presence on the Fediverse
for developers who prefer open platforms.</p>
<p><strong>LinkedIn: LARC Developers Group</strong>
https://linkedin.com/groups/larcjs Professional network for LARC
developers. Good for job postings, industry discussion, and enterprise
use cases.</p>
<h2 data-number="28.3" id="code-examples-and-templates"><span
class="header-section-number">28.3</span> Code Examples and
Templates</h2>
<h3 data-number="28.3.1" id="example-applications"><span
class="header-section-number">28.3.1</span> Example Applications</h3>
<p><strong>Official Examples Repository</strong>
https://github.com/larcjs/larc/tree/main/packages/examples Curated
collection of example applications demonstrating LARC patterns and
components. Each example is self-contained, documented, and includes
setup instructions.</p>
<p>Notable examples include:</p>
<ul>
<li>Task Manager (state management, persistence)</li>
<li>E-commerce Store (routing, forms, authentication)</li>
<li>Real-time Chat (WebSocket integration, presence)</li>
<li>File Manager (OPFS, drag-and-drop, uploads)</li>
<li>Dashboard Builder (composable widgets, theming)</li>
</ul>
<p><strong>CodeSandbox Templates</strong>
https://codesandbox.io/search?refinementList%5Btags%5D=larc Interactive
online templates for rapid prototyping. Fork and experiment without
local setup. Includes starter templates for common application
types.</p>
<p><strong>GitHub Topics: #larcjs</strong>
https://github.com/topics/larcjs Community-contributed projects using
LARC. Browse for inspiration, study real-world implementations, and
discover reusable components.</p>
<h3 data-number="28.3.2" id="component-showcases"><span
class="header-section-number">28.3.2</span> Component Showcases</h3>
<p><strong>LARC Component Gallery</strong> https://components.larcjs.com
Visual gallery of all official components with live demos, code samples,
and customization tools. Essential reference when choosing components
for your project.</p>
<p><strong>Awesome LARC Components</strong>
https://github.com/larcjs/awesome-larc-components Curated list of
community-built components. Organized by category (UI, data,
integration) with quality ratings and maintenance status.</p>
<h2 data-number="28.4" id="development-tools"><span
class="header-section-number">28.4</span> Development Tools</h2>
<h3 data-number="28.4.1" id="browser-extensions"><span
class="header-section-number">28.4.1</span> Browser Extensions</h3>
<p><strong>LARC DevTools</strong> Chrome:
https://chrome.google.com/webstore/detail/larc-devtools Firefox:
https://addons.mozilla.org/firefox/addon/larc-devtools Browser extension
providing visual PAN message inspection, component tree visualization,
performance profiling, and state debugging.</p>
<p><strong>Web Components DevTools</strong> General-purpose extension
for debugging all Web Components, including LARC components. Useful for
inspecting Shadow DOM and custom element lifecycles.</p>
<h3 data-number="28.4.2" id="editor-extensions"><span
class="header-section-number">28.4.2</span> Editor Extensions</h3>
<p><strong>VS Code: LARC Extension</strong>
https://marketplace.visualstudio.com/items?itemName=larcjs.larc-vscode
Official VS Code extension providing:</p>
<ul>
<li>Component auto-completion</li>
<li>PAN topic IntelliSense</li>
<li>Snippet library for common patterns</li>
<li>Integrated component browser</li>
<li>Live component preview</li>
</ul>
<p><strong>JetBrains Plugin: LARC Support</strong>
https://plugins.jetbrains.com/plugin/larcjs-support Support for
WebStorm, IntelliJ IDEA, and other JetBrains IDEs. Provides code
completion, navigation, and refactoring tools.</p>
<h3 data-number="28.4.3" id="command-line-tools"><span
class="header-section-number">28.4.3</span> Command-Line Tools</h3>
<p><strong>LARC CLI</strong>
https://github.com/larcjs/larc/tree/main/cli</p>
<div class="sourceCode" id="cb466"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> npm install <span class="at">-g</span> create-larc-app</span></code></pre></div>
<p>Official command-line interface for:</p>
<ul>
<li>Project scaffolding (<code>larc create</code>)</li>
<li>Component generation (<code>larc generate</code>)</li>
<li>Development server with hot reload (<code>larc dev</code>)</li>
<li>Production builds (<code>larc build</code>)</li>
<li>Component registry integration (<code>larc add</code>)</li>
</ul>
<p><strong>create-larc-app</strong>
https://github.com/larcjs/larc/tree/main/cli</p>
<div class="sourceCode" id="cb467"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> npx create-larc-app my-app</span></code></pre></div>
<p>Zero-configuration starter for new LARC projects. Includes
pre-configured development environment, example components, and build
tooling.</p>
<h2 data-number="28.5" id="learning-resources"><span
class="header-section-number">28.5</span> Learning Resources</h2>
<h3 data-number="28.5.1" id="video-tutorials"><span
class="header-section-number">28.5.1</span> Video Tutorials</h3>
<p><strong>LARC Fundamentals (YouTube)</strong>
https://youtube.com/playlist?list=PLarc-fundamentals Official video
series covering:</p>
<ul>
<li>Introduction to LARC (15 min)</li>
<li>PAN Bus Messaging (22 min)</li>
<li>Component Development (28 min)</li>
<li>State Management Patterns (35 min)</li>
<li>Building a Complete Application (1h 15min)</li>
</ul>
<p><strong>Egghead.io: Building with LARC</strong>
https://egghead.io/courses/building-with-larc Professional screencast
series (paid) with bite-sized lessons on specific topics. High
production quality with accompanying code repositories.</p>
<p><strong>Frontend Masters: LARC Workshop</strong>
https://frontendmasters.com/courses/larc Full-day workshop covering LARC
from fundamentals to advanced patterns. Includes exercises, quizzes, and
downloadable resources.</p>
<h3 data-number="28.5.2" id="blog-posts-and-articles"><span
class="header-section-number">28.5.2</span> Blog Posts and Articles</h3>
<p><strong>LARC Blog</strong> https://blog.larcjs.com Official blog with
deep dives into architecture decisions, release notes, performance
analysis, and best practices from core maintainers.</p>
<p><strong>CSS-Tricks: LARC Guide Series</strong>
https://css-tricks.com/guides/larc Multi-part guide covering LARC from a
frontend developer’s perspective. Excellent for understanding how LARC
fits into modern web development.</p>
<p><strong>Smashing Magazine: Component Architecture with LARC</strong>
https://smashingmagazine.com/larc-component-architecture In-depth
article comparing LARC’s approach to other component frameworks. Good
for understanding trade-offs and architectural decisions.</p>
<h3 data-number="28.5.3" id="podcasts"><span
class="header-section-number">28.5.3</span> Podcasts</h3>
<p><strong>Syntax.fm: LARC Deep Dive</strong>
https://syntax.fm/show/larc-deep-dive Popular web development podcast
featuring LARC’s creator discussing philosophy, implementation, and
future direction.</p>
<p><strong>ShopTalk Show: Building without Build Tools</strong>
https://shoptalkshow.com/larc-episode Discussion of zero-build
development philosophy and LARC’s approach to modern web
development.</p>
<h2 data-number="28.6" id="related-projects-and-technologies"><span
class="header-section-number">28.6</span> Related Projects and
Technologies</h2>
<h3 data-number="28.6.1" id="web-components-standards"><span
class="header-section-number">28.6.1</span> Web Components
Standards</h3>
<p><strong>Web Components at MDN</strong>
https://developer.mozilla.org/en-US/docs/Web/Web_Components
Comprehensive documentation for Custom Elements, Shadow DOM, HTML
Templates, and related browser APIs that LARC builds upon.</p>
<p><strong>webcomponents.org</strong> https://webcomponents.org
Community hub for Web Components with tutorials, best practices, and a
component directory. Not LARC-specific but highly relevant.</p>
<p><strong>Custom Elements Everywhere</strong>
https://custom-elements-everywhere.com Test suite showing how different
frameworks work with Web Components. Demonstrates LARC’s excellent
interoperability.</p>
<h3 data-number="28.6.2" id="message-bus-patterns"><span
class="header-section-number">28.6.2</span> Message Bus Patterns</h3>
<p><strong>Enterprise Integration Patterns: Messaging</strong>
https://enterpriseintegrationpatterns.com/patterns/messaging Classic
reference for message-based architecture patterns. LARC implements many
patterns described here adapted for browser environments.</p>
<p><strong>Reactive Manifesto</strong> https://reactivemanifesto.org
Principles of reactive system design that influenced LARC’s
architecture, particularly around message-driven communication.</p>
<h3 data-number="28.6.3" id="complementary-technologies"><span
class="header-section-number">28.6.3</span> Complementary
Technologies</h3>
<p><strong>IndexedDB API</strong>
https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API Browser
database API used by LARC storage components for client-side
persistence.</p>
<p><strong>Origin Private File System (OPFS)</strong>
https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API
Modern file system API supported by LARC file management components.</p>
<p><strong>BroadcastChannel API</strong>
https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API
Cross-tab communication API used by LARC for multi-window
synchronization.</p>
<h2 data-number="28.7" id="backend-integration"><span
class="header-section-number">28.7</span> Backend Integration</h2>
<h3 data-number="28.7.1" id="larc-compatible-backends"><span
class="header-section-number">28.7.1</span> LARC-Compatible
Backends</h3>
<p><strong>Node.js Backend Examples</strong>
https://github.com/larcjs/larc/tree/main/packages/examples/backends/nodejs
Reference implementations showing REST and WebSocket backends for LARC
applications. Includes authentication, file uploads, and real-time
features.</p>
<p><strong>Python/Flask Backend Examples</strong>
https://github.com/larcjs/larc/tree/main/packages/examples/backends/python
Python backend examples demonstrating API design patterns that work well
with LARC frontend applications.</p>
<p><strong>Deno Backend Examples</strong>
https://github.com/larcjs/larc/tree/main/packages/examples/backends/deno
Modern JavaScript runtime examples showing how to build backends without
Node.js dependencies.</p>
<h3 data-number="28.7.2" id="api-design-guides"><span
class="header-section-number">28.7.2</span> API Design Guides</h3>
<p><strong>REST API Design for LARC Applications</strong>
https://larcjs.com/guides/rest-api-design Best practices for designing
REST APIs that integrate cleanly with LARC’s data components and message
patterns.</p>
<p><strong>WebSocket Integration Guide</strong>
https://larcjs.com/guides/websocket-integration How to implement
real-time features using WebSocket connections with LARC’s messaging
system.</p>
<h2 data-number="28.8" id="testing-and-quality"><span
class="header-section-number">28.8</span> Testing and Quality</h2>
<h3 data-number="28.8.1" id="testing-resources"><span
class="header-section-number">28.8.1</span> Testing Resources</h3>
<p><strong>LARC Testing Guide</strong> https://larcjs.com/guides/testing
Official guide for testing LARC applications covering unit tests,
integration tests, end-to-end tests, and visual regression testing.</p>
<p><strong>Web Test Runner</strong>
https://modern-web.dev/docs/test-runner/overview Recommended test runner
for LARC applications. Fast, supports Web Components natively, and
requires no browser driver.</p>
<p><strong>Playwright</strong> https://playwright.dev End-to-end testing
framework recommended for LARC application testing. Excellent Web
Component support and debugging tools.</p>
<h3 data-number="28.8.2" id="performance-resources"><span
class="header-section-number">28.8.2</span> Performance Resources</h3>
<p><strong>Web Performance Working Group</strong>
https://w3c.github.io/web-performance W3C standards for measuring and
optimizing web performance. LARC follows these standards for component
performance metrics.</p>
<p><strong>web.dev Performance</strong> https://web.dev/performance
Google’s comprehensive performance guide covering Core Web Vitals,
optimization techniques, and measurement tools relevant to LARC
applications.</p>
<h2 data-number="28.9" id="contributing-and-extending"><span
class="header-section-number">28.9</span> Contributing and
Extending</h2>
<h3 data-number="28.9.1" id="contribution-guides"><span
class="header-section-number">28.9.1</span> Contribution Guides</h3>
<p><strong>Contributing to LARC Core</strong>
https://github.com/larcjs/larc/blob/main/CONTRIBUTING.md Guidelines for
contributing to the LARC core framework. Includes coding standards,
testing requirements, and pull request process.</p>
<p><strong>Publishing Components</strong>
https://larcjs.com/guides/publishing-components How to create, document,
and publish reusable LARC components for the community. Covers naming
conventions, versioning, and registry submission.</p>
<p><strong>Component Development Guide</strong>
https://larcjs.com/guides/component-development Best practices for
building high-quality LARC components including accessibility,
performance, and API design.</p>
<h3 data-number="28.9.2" id="governance-and-roadmap"><span
class="header-section-number">28.9.2</span> Governance and Roadmap</h3>
<p><strong>LARC Roadmap</strong>
https://github.com/larcjs/larc/blob/main/ROADMAP.md Public roadmap
showing planned features, architectural improvements, and long-term
vision. Community feedback welcome.</p>
<p><strong>RFC Process</strong> https://github.com/larcjs/rfcs Request
for Comments process for proposing major changes to LARC. Review active
RFCs and submit your own proposals.</p>
<p><strong>Governance Model</strong>
https://github.com/larcjs/larc/blob/main/GOVERNANCE.md How LARC is
governed, who makes decisions, and how the community can participate in
the project’s direction.</p>
<h2 data-number="28.10" id="package-registries"><span
class="header-section-number">28.10</span> Package Registries</h2>
<h3 data-number="28.10.1" id="npm-packages"><span
class="header-section-number">28.10.1</span> NPM Packages</h3>
<p><strong><span class="citation"
data-cites="larcjs/core">@larcjs/core</span></strong>
https://npmjs.com/package/<span class="citation"
data-cites="larcjs/core">@larcjs/core</span> Core framework package
containing PAN bus, autoloader, and foundational components.</p>
<p><strong><span class="citation"
data-cites="larcjs/ui">@larcjs/ui</span></strong>
https://npmjs.com/package/<span class="citation"
data-cites="larcjs/ui">@larcjs/ui</span> Official component library with
UI, data, and integration components.</p>
<p><strong><span class="citation"
data-cites="larcjs/core-types">@larcjs/core-types</span></strong>
https://npmjs.com/package/<span class="citation"
data-cites="larcjs/core-types">@larcjs/core-types</span> TypeScript type
definitions for LARC core APIs and components.</p>
<p><strong><span class="citation"
data-cites="larcjs/testing-library">@larcjs/testing-library</span></strong>
https://npmjs.com/package/<span class="citation"
data-cites="larcjs/testing-library">@larcjs/testing-library</span>
Testing utilities and helpers for LARC applications.</p>
<h3 data-number="28.10.2" id="cdn-distributions"><span
class="header-section-number">28.10.2</span> CDN Distributions</h3>
<p><strong>unpkg.com</strong> https://unpkg.com/<span class="citation"
data-cites="larcjs/core">@larcjs/core</span><span class="citation"
data-cites="latest">@latest</span> Fast, global CDN for quick
prototyping and development. Automatically serves latest versions.</p>
<p><strong>jsDelivr</strong> https://cdn.jsdelivr.net/npm/<span
class="citation" data-cites="larcjs/core">@larcjs/core</span><span
class="citation" data-cites="latest">@latest</span> Alternative CDN with
excellent performance and reliability. Supports version pinning and
package exploration.</p>
<p><strong>LARC Official CDN</strong> https://cdn.larcjs.com Official
CDN optimized for LARC with guaranteed uptime, geographic distribution,
and versioned URLs.</p>
<h2 data-number="28.11" id="books-and-long-form-resources"><span
class="header-section-number">28.11</span> Books and Long-Form
Resources</h2>
<h3 data-number="28.11.1" id="recommended-reading"><span
class="header-section-number">28.11.1</span> Recommended Reading</h3>
<p><strong>Web Components: From Zero to Hero</strong> By Pascal Schilp
Foundation knowledge for understanding the Web Components standards that
LARC builds upon. Available free online.</p>
<p><strong>Component-Based Development in JavaScript</strong> By Oliver
Steele Explores component architecture patterns with examples in
multiple frameworks including LARC. Good for understanding architectural
trade-offs.</p>
<p><strong>Event-Driven Architecture</strong> By Martin Fowler Classic
software architecture text covering message-based patterns that inform
LARC’s design philosophy.</p>
<h3 data-number="28.11.2" id="academic-papers"><span
class="header-section-number">28.11.2</span> Academic Papers</h3>
<p><strong>Web Components: Standards, Patterns, and Best
Practices</strong> Research paper analyzing Web Components adoption and
patterns. Includes LARC case studies.</p>
<p><strong>Message-Oriented Middleware for Browser Applications</strong>
Academic treatment of message bus patterns in web applications with LARC
as example implementation.</p>
<h2 data-number="28.12" id="deployment-and-hosting"><span
class="header-section-number">28.12</span> Deployment and Hosting</h2>
<h3 data-number="28.12.1" id="hosting-platforms"><span
class="header-section-number">28.12.1</span> Hosting Platforms</h3>
<p><strong>Netlify</strong> https://netlify.com Recommended static
hosting platform for LARC applications. Free tier suitable for most
projects. Excellent CDN and deployment pipeline.</p>
<p><strong>Vercel</strong> https://vercel.com Alternative hosting
platform with Git integration, preview deployments, and serverless
functions for backend features.</p>
<p><strong>Cloudflare Pages</strong> https://pages.cloudflare.com Global
edge network hosting with fast deployments and excellent performance.
Good for international applications.</p>
<p><strong>GitHub Pages</strong> https://pages.github.com Free hosting
for open source projects. Simple deployment directly from GitHub
repositories.</p>
<h3 data-number="28.12.2" id="deployment-guides"><span
class="header-section-number">28.12.2</span> Deployment Guides</h3>
<p><strong>LARC Deployment Guide</strong>
https://larcjs.com/guides/deployment Comprehensive guide covering
deployment options, optimization strategies, caching configuration, and
production best practices.</p>
<p><strong>Performance Optimization Guide</strong>
https://larcjs.com/guides/performance-optimization How to optimize LARC
applications for production including code splitting, lazy loading,
asset optimization, and CDN configuration.</p>
<h2 data-number="28.13" id="events-and-training"><span
class="header-section-number">28.13</span> Events and Training</h2>
<h3 data-number="28.13.1" id="conferences"><span
class="header-section-number">28.13.1</span> Conferences</h3>
<p><strong>LARC Conf</strong> https://conf.larcjs.com Annual conference
dedicated to LARC featuring talks, workshops, and networking. Recordings
available online.</p>
<p><strong>Web Components Summit</strong>
https://webcomponentssummit.com General Web Components conference with
LARC-specific tracks and presentations.</p>
<h3 data-number="28.13.2" id="workshops-and-training"><span
class="header-section-number">28.13.2</span> Workshops and Training</h3>
<p><strong>Official LARC Workshops</strong> https://larcjs.com/workshops
In-person and virtual workshops taught by LARC experts. Topics range
from fundamentals to advanced patterns.</p>
<p><strong>Corporate Training</strong> https://larcjs.com/training
Customized training programs for enterprise teams. Includes on-site
workshops, consultation, and ongoing support.</p>
<h2 data-number="28.14" id="community-projects"><span
class="header-section-number">28.14</span> Community Projects</h2>
<h3 data-number="28.14.1"
id="notable-applications-built-with-larc"><span
class="header-section-number">28.14.1</span> Notable Applications Built
with LARC</h3>
<p>Browse https://larcjs.com/showcase for featured applications
demonstrating LARC’s capabilities in production environments.</p>
<h3 data-number="28.14.2" id="open-source-projects"><span
class="header-section-number">28.14.2</span> Open Source Projects</h3>
<p><strong>LARC DevTools</strong> Browser extension and debugging
toolkit (open source)</p>
<p><strong>LARC Component Library Templates</strong> Starter templates
for building your own component libraries</p>
<p><strong>LARC Form Builder</strong> Visual form builder with code
generation</p>
<p><strong>LARC Dashboard Framework</strong> Composable dashboard system
with widgets and layouts</p>
<h2 data-number="28.15" id="stay-updated"><span
class="header-section-number">28.15</span> Stay Updated</h2>
<h3 data-number="28.15.1" id="newsletters"><span
class="header-section-number">28.15.1</span> Newsletters</h3>
<p><strong>LARC Weekly</strong> https://larcjs.com/newsletter Weekly
newsletter covering LARC news, tutorials, community projects, and
ecosystem updates.</p>
<p><strong>Web Components Weekly</strong>
https://webcomponents.dev/newsletter General Web Components newsletter
that frequently features LARC content.</p>
<h3 data-number="28.15.2" id="release-notes"><span
class="header-section-number">28.15.2</span> Release Notes</h3>
<p><strong>LARC Changelog</strong>
https://github.com/larcjs/larc/blob/main/CHANGELOG.md Detailed changelog
for all LARC releases including breaking changes, new features, and bug
fixes.</p>
<p><strong>Security Advisories</strong>
https://github.com/larcjs/larc/security/advisories Security
announcements and vulnerability reports. Subscribe for critical
updates.</p>
<h2 data-number="28.16" id="getting-help-1"><span
class="header-section-number">28.16</span> Getting Help</h2>
<p>When you need assistance:</p>
<ol type="1">
<li><p><strong>Search existing resources</strong>: Check documentation,
Stack Overflow, and GitHub Discussions first</p></li>
<li><p><strong>Prepare a minimal reproduction</strong>: Create a
CodeSandbox or GitHub repo demonstrating your issue</p></li>
<li><p><strong>Be specific</strong>: Include LARC version, browser,
error messages, and what you’ve already tried</p></li>
<li><p><strong>Choose the right channel</strong>:</p>
<ul>
<li>Technical questions -&gt; Stack Overflow (tag:
<code>larc</code>)</li>
<li>Bug reports -&gt; GitHub Issues</li>
<li>General discussion -&gt; GitHub Discussions or Discord</li>
<li>Real-time help -&gt; Discord #help channel</li>
</ul></li>
</ol>
<h3 data-number="28.16.1" id="support-options"><span
class="header-section-number">28.16.1</span> Support Options</h3>
<p><strong>Community Support (Free)</strong> Discord, GitHub
Discussions, Stack Overflow</p>
<p><strong>Professional Support</strong> https://larcjs.com/support
Commercial support plans available for enterprise users needing
guaranteed response times and consulting.</p>
<hr />
<p>This appendix is maintained by the LARC community. To suggest
additions or corrections, submit a pull request to
https://github.com/larcjs/larc-docs or open an issue describing the
change.</p>
<p><em>Last updated: December 2025</em></p>
<h1 data-number="29" id="index"><span
class="header-section-number">29</span> Index</h1>
<h2 data-number="29.1" id="a-1"><span
class="header-section-number">29.1</span> A</h2>
<p><strong>addEventListener()</strong>, Chapter 4, Chapter 7
<strong>Accessibility</strong>, Chapter 15, Chapter 17, Chapter 19
<strong>Acknowledgments</strong>, Preface <strong>Action
topics</strong>, Chapter 4, Appendix A <strong>ActiveForm (todo
status)</strong>, Chapter 19 <strong>adoptedStyleSheets</strong>,
Chapter 15 <strong>Advanced patterns</strong>, Chapter 19
<strong>Alpine.js comparison</strong>, Chapter 2 <strong>Analytics
tracking</strong>, Chapter 4, Chapter 12 <strong>Angular
comparison</strong>, Chapter 2 <strong>Anti-patterns</strong>, Chapter
4, Chapter 19 <strong>Apache configuration</strong>, Chapter 5, Chapter
20 <strong>API design</strong>, Chapter 11, Appendix G <strong>API
integration</strong>, Chapter 11 <strong>API reference</strong>, Chapter
17-21, Appendix G <strong>API topics</strong>, Chapter 4, Chapter 11
<strong>Application state</strong>, Chapter 8 <strong>Architectural
decisions</strong>, Chapter 2, Chapter 19 <strong>Asynchronous
patterns</strong>, Chapter 6, Chapter 11 <strong>Attributes
(component)</strong>, Chapter 4, Chapter 7, Chapter 17-21
<strong>attributeChangedCallback()</strong>, Chapter 7
<strong>Authentication</strong>, Chapter 12</p>
<ul>
<li>JWT tokens, Chapter 12</li>
<li>OAuth integration, Chapter 12</li>
<li>Session management, Chapter 12</li>
<li>Token refresh, Chapter 12 <strong>Authorization</strong>, Chapter 12
<strong>Auto-loading components</strong>, Chapter 4, Chapter 5, Chapter
7 <strong>Autoloader</strong>, Chapter 4, Chapter 5, Chapter 7
<strong>await</strong>, Chapter 6, Chapter 11</li>
</ul>
<h2 data-number="29.2" id="b-1"><span
class="header-section-number">29.2</span> B</h2>
<p><strong>Backend integration</strong>, Chapter 11, Appendix G</p>
<ul>
<li><p>Deno, Appendix G</p></li>
<li><p>Node.js, Appendix G</p></li>
<li><p>Python/Flask, Appendix G <strong>Best practices</strong>, Chapter
6-20 <strong>Boolean attributes</strong>, Chapter 7, Chapter 17-21
<strong>Branching logic</strong>, Chapter 19 <strong>BroadcastChannel
API</strong>, Chapter 8, Chapter 13, Appendix G <strong>Browser
compatibility</strong>, Chapter 5, Chapter 20</p></li>
<li><p>Chrome, Chapter 5</p></li>
<li><p>Edge, Chapter 5</p></li>
<li><p>Firefox, Chapter 5</p></li>
<li><p>Mobile browsers, Chapter 5</p></li>
<li><p>Safari, Chapter 5 <strong>Browser DevTools</strong>, Chapter 5,
Chapter 18</p></li>
<li><p>Chrome DevTools, Chapter 5, Chapter 18</p></li>
<li><p>Console panel, Chapter 5, Chapter 18</p></li>
<li><p>Elements panel, Chapter 5</p></li>
<li><p>Firefox Developer Tools, Chapter 5</p></li>
<li><p>Network panel, Chapter 5, Chapter 18</p></li>
<li><p>Safari Web Inspector, Chapter 5 <strong>Bubbling
(event)</strong>, Chapter 4, Chapter 7 <strong>Build tools</strong>,
Chapter 1, Chapter 2, Chapter 20</p></li>
<li><p>Optional nature, Chapter 2</p></li>
<li><p>Production optimization, Chapter 20</p></li>
<li><p>Rollup, Chapter 20</p></li>
<li><p>Vite, Chapter 5, Chapter 20</p></li>
<li><p>Webpack, Chapter 20 <strong>Bus statistics</strong>, Chapter 4,
Chapter 17</p></li>
</ul>
<h2 data-number="29.3" id="c-1"><span
class="header-section-number">29.3</span> C</h2>
<p><strong>Caching</strong>, Chapter 11, Chapter 16, Chapter 20
<strong>CAN bus (automotive)</strong>, Chapter 1, Chapter 3 <strong>CDN
deployment</strong>, Chapter 5, Chapter 20, Appendix G</p>
<ul>
<li><p>jsDelivr, Chapter 5, Appendix G</p></li>
<li><p>unpkg, Chapter 5, Appendix G <strong>Change detection</strong>,
Chapter 8 <strong>Chrome DevTools Extension</strong>, Chapter 5,
Appendix G <strong>Cleanup (subscription)</strong>, Chapter 4, Chapter 7
<strong>Client-side routing</strong>, Chapter 9 <strong>Cloudflare
Pages</strong>, Chapter 20, Appendix G <strong>Code
conventions</strong>, Chapter 1 <strong>Code examples</strong>, Chapter
1, Appendix G <strong>Code splitting</strong>, Chapter 16, Chapter 20
<strong>Command-line tools</strong>, Chapter 5, Appendix G
<strong>Community resources</strong>, Appendix G <strong>Comparison with
other frameworks</strong>, Chapter 2 <strong>Component API
reference</strong>, Chapter 17-21 <strong>Component
autoloading</strong>, Chapter 4, Chapter 5, Chapter 7 <strong>Component
composition</strong>, Chapter 4, Chapter 7 <strong>Component development
guide</strong>, Appendix G <strong>Component gallery</strong>, Appendix
G <strong>Component lifecycle</strong>, Chapter 7</p></li>
<li><p>attributeChangedCallback, Chapter 7</p></li>
<li><p>connectedCallback, Chapter 7</p></li>
<li><p>disconnectedCallback, Chapter 7 <strong>Component naming
conventions</strong>, Chapter 1, Chapter 7 <strong>Component
registration</strong>, Chapter 7 <strong>Component reusability</strong>,
Chapter 7, Chapter 19 <strong>Component testing</strong>, Chapter 17
<strong>Composability</strong>, Chapter 2, Chapter 4, Chapter 7
<strong>Composition patterns</strong>, Chapter 4, Chapter 7, Chapter 19
<strong>Configuration</strong></p></li>
<li><p>larc-config.mjs, Chapter 5</p></li>
<li><p>pan-bus attributes, Chapter 4, Chapter 17</p></li>
<li><p>Path configuration, Chapter 5
<strong>connectedCallback()</strong>, Chapter 7 <strong>Console
logging</strong>, Chapter 4, Chapter 18 <strong>Constructable
Stylesheets</strong>, Chapter 15 <strong>Content Security Policy
(CSP)</strong>, Chapter 20 <strong>Context API</strong>, Chapter 8
<strong>Contributing to LARC</strong>, Appendix G <strong>Convention
over configuration</strong>, Chapter 2, Chapter 5 <strong>Core
concepts</strong>, Chapter 4 <strong>Core Web Vitals</strong>, Chapter
16, Appendix G <strong>CORS errors</strong>, Chapter 5
<strong>correlationId</strong>, Chapter 4, Chapter 6
<strong>create-larc-app</strong>, Chapter 5, Appendix G
<strong>Cross-origin images</strong>, Chapter 14 <strong>Cross-tab
communication</strong>, Chapter 8, Chapter 13 <strong>CSS Custom
Properties</strong>, Chapter 15 <strong>CSS encapsulation</strong>,
Chapter 7, Chapter 15 <strong>Custom Elements</strong>, Chapter 1,
Chapter 4, Chapter 7</p></li>
<li><p>v1 API, Chapter 7 <strong>customElements.define()</strong>,
Chapter 7 <strong>CustomEvent</strong>, Chapter 4, Chapter 7</p></li>
</ul>
<h2 data-number="29.4" id="d-1"><span
class="header-section-number">29.4</span> D</h2>
<p><strong>Dark mode</strong>, Chapter 15 <strong>Dashboard
applications</strong>, Chapter 19 <strong>Data components</strong>,
Chapter 18 <strong>Data fetching</strong>, Chapter 11</p>
<ul>
<li><p>Caching strategies, Chapter 11</p></li>
<li><p>Error handling, Chapter 11</p></li>
<li><p>Loading states, Chapter 11</p></li>
<li><p>Pagination, Chapter 11 <strong>Data validation</strong>, Chapter
10 <strong>Debugging</strong>, Chapter 5, Chapter 18</p></li>
<li><p>Browser DevTools, Chapter 5, Chapter 18</p></li>
<li><p>Debug mode, Chapter 4, Chapter 17</p></li>
<li><p>LARC DevTools extension, Appendix G</p></li>
<li><p>Message tracing, Chapter 18, Chapter 17 <strong>Decoupled
architecture</strong>, Chapter 2, Chapter 4 <strong>Deduplication
(messages)</strong>, Chapter 4 <strong>Deep linking</strong>, Chapter 9
<strong>Deployment</strong>, Chapter 20</p></li>
<li><p>CDN configuration, Chapter 20</p></li>
<li><p>GitHub Pages, Chapter 20, Appendix G</p></li>
<li><p>Netlify, Chapter 20, Appendix G</p></li>
<li><p>Optimization, Chapter 20</p></li>
<li><p>Static hosting, Chapter 20</p></li>
<li><p>Vercel, Chapter 20, Appendix G <strong>Design patterns</strong>,
Chapter 19 <strong>Development environment setup</strong>, Chapter 5
<strong>Development server</strong>, Chapter 5</p></li>
<li><p>Live Server, Chapter 5</p></li>
<li><p>PHP built-in, Chapter 5</p></li>
<li><p>Python http.server, Chapter 5</p></li>
<li><p>Vite, Chapter 5 <strong>DevTools extension</strong>, Chapter 5,
Appendix G <strong>Directory structure</strong>, Chapter 5
<strong>disconnectedCallback()</strong>, Chapter 7 <strong>Discord
community</strong>, Appendix G <strong>dispatchEvent()</strong>, Chapter
4, Chapter 7 <strong>Documentation resources</strong>, Appendix G
<strong>DOM events</strong>, Chapter 4, Chapter 7 <strong>Drag and
drop</strong>, Chapter 14 <strong>Dynamic imports</strong>, Chapter 16,
Chapter 20</p></li>
</ul>
<h2 data-number="29.5" id="e-1"><span
class="header-section-number">29.5</span> E</h2>
<p><strong>E-commerce examples</strong>, Chapter 4, Appendix G
<strong>Editor configuration</strong>, Chapter 5</p>
<ul>
<li><p>JetBrains, Appendix G</p></li>
<li><p>Sublime Text, Chapter 5</p></li>
<li><p>Vim, Chapter 5</p></li>
<li><p>VS Code, Chapter 5, Appendix G <strong>Emmet</strong>, Chapter 5
<strong>Encapsulation</strong>, Chapter 7, Chapter 15 <strong>End-to-end
testing</strong>, Chapter 17 <strong>Enterprise Integration
Patterns</strong>, Appendix G <strong>Error boundaries</strong>, Chapter
18 <strong>Error handling</strong>, Chapter 18</p></li>
<li><p>API errors, Chapter 11, Chapter 18</p></li>
<li><p>Global handlers, Chapter 18</p></li>
<li><p>User feedback, Chapter 18 <strong>ES Modules</strong>, Chapter 1,
Chapter 5, Chapter 7 <strong>ESLint</strong>, Chapter 5 <strong>Event
delegation</strong>, Chapter 7 <strong>Event envelopes</strong>, Chapter
4, Chapter 6, Appendix B <strong>Event listeners</strong>, Chapter 7
<strong>Event topics</strong>, Chapter 4, Appendix A
<strong>Event-driven architecture</strong>, Chapter 2, Chapter 4
<strong>Example applications</strong>, Chapter 1, Chapter 5, Appendix G
<strong>Export/import</strong>, Chapter 7</p></li>
</ul>
<h2 data-number="29.6" id="f-1"><span
class="header-section-number">29.6</span> F</h2>
<p><strong>Feature detection</strong>, Chapter 5, Chapter 14
<strong>Fetch API</strong>, Chapter 11 <strong>File management</strong>,
Chapter 14</p>
<ul>
<li><p>Downloads, Chapter 14</p></li>
<li><p>Drag and drop, Chapter 14</p></li>
<li><p>OPFS integration, Chapter 14</p></li>
<li><p>Upload handling, Chapter 14 <strong>File paths</strong>, Chapter
1, Chapter 5 <strong>Filtering (data)</strong>, Chapter 18
<strong>Firefox Developer Tools</strong>, Chapter 5 <strong>Form
handling</strong>, Chapter 10</p></li>
<li><p>Accessibility, Chapter 10</p></li>
<li><p>Custom validation, Chapter 10</p></li>
<li><p>Multi-step forms, Chapter 10</p></li>
<li><p>Submission, Chapter 10</p></li>
<li><p>Validation, Chapter 10 <strong>Frontend Masters</strong>,
Appendix G</p></li>
</ul>
<h2 data-number="29.7" id="g"><span
class="header-section-number">29.7</span> G</h2>
<p><strong>Getting started</strong>, Chapter 5 <strong>Git clone
installation</strong>, Chapter 5 <strong>GitHub Discussions</strong>,
Appendix G <strong>GitHub Pages</strong>, Chapter 20, Appendix G
<strong>Global state</strong>, Chapter 8 <strong>Global wildcard
subscriptions</strong>, Chapter 4, Chapter 17 <strong>Glossary</strong>,
Appendix F <strong>Governance</strong>, Appendix G</p>
<h2 data-number="29.8" id="h-1"><span
class="header-section-number">29.8</span> H</h2>
<p><strong>Hash routing</strong>, Chapter 9 <strong>Headers
(message)</strong>, Chapter 4, Chapter 6 <strong>Hello World
example</strong>, Chapter 5 <strong>Hierarchical topics</strong>,
Chapter 4, Appendix A <strong>History API</strong>, Chapter 9
<strong>Hot module replacement</strong>, Chapter 2 <strong>HTML
Templates</strong>, Chapter 7 <strong>http-server</strong>, Chapter
5</p>
<h2 data-number="29.9" id="i-1"><span
class="header-section-number">29.9</span> I</h2>
<p><strong>Icons</strong>, Chapter 19 <strong>IDE support</strong>,
Chapter 5, Appendix G <strong>Import maps</strong>, Chapter 5, Chapter
20 <strong>IndexedDB</strong>, Chapter 8, Chapter 14, Appendix G
<strong>Infinite scroll</strong>, Chapter 18 <strong>Initial state
loading</strong>, Chapter 8 <strong>Installation options</strong>,
Chapter 5</p>
<ul>
<li>CDN, Chapter 5</li>
<li>Git clone, Chapter 5</li>
<li>NPM, Chapter 5 <strong>Integration components</strong>, Chapter 20
<strong>IntersectionObserver</strong>, Chapter 4, Chapter 5, Chapter 16
<strong>Introduction</strong>, Chapter 1</li>
</ul>
<h2 data-number="29.10" id="j"><span
class="header-section-number">29.10</span> J</h2>
<p><strong>JavaScript frameworks comparison</strong>, Chapter 2
<strong>JetBrains plugin</strong>, Appendix G <strong>jsDelivr
CDN</strong>, Chapter 5, Appendix G <strong>JSON serialization</strong>,
Chapter 4 <strong>JWT authentication</strong>, Chapter 12</p>
<h2 data-number="29.11" id="k"><span
class="header-section-number">29.11</span> K</h2>
<p><strong>Key concepts</strong>, Chapter 4</p>
<h2 data-number="29.12" id="l-1"><span
class="header-section-number">29.12</span> L</h2>
<p><strong>larc-config.mjs</strong>, Chapter 5 <strong>LARC
CLI</strong>, Chapter 5, Appendix G <strong>LARC philosophy</strong>,
Chapter 2 <strong>LARC story</strong>, Chapter 3 <strong>Lazy
loading</strong>, Chapter 16, Chapter 20 <strong>Learning path</strong>,
Chapter 1 <strong>Learning LARC (book)</strong>, Chapter 1, Appendix G
<strong>Lifecycle methods</strong>, Chapter 7 <strong>Lightweight
architecture</strong>, Chapter 1, Chapter 2 <strong>Live
Server</strong>, Chapter 5 <strong>Loading states</strong>, Chapter 11,
Chapter 18 <strong>Local development</strong>, Chapter 5 <strong>Local
state</strong>, Chapter 8 <strong>localStorage</strong>, Chapter 5,
Chapter 8 <strong>Logging</strong>, Chapter 18</p>
<h2 data-number="29.13" id="m-1"><span
class="header-section-number">29.13</span> M</h2>
<p><strong>Markdown editor</strong>, Chapter 19 <strong>Memory
management</strong>, Chapter 4, Chapter 16, Chapter 17 <strong>Message
bus</strong>, Chapter 4, Chapter 17</p>
<ul>
<li>Configuration, Chapter 4, Chapter 17</li>
<li>Debug mode, Chapter 4</li>
<li>Initialization, Chapter 5</li>
<li>Rate limiting, Chapter 17</li>
<li>Statistics, Chapter 4, Chapter 17 <strong>Message envelope
structure</strong>, Chapter 4, Chapter 6, Appendix B <strong>Message
flow</strong>, Chapter 6 <strong>Message IDs</strong>, Chapter 4
<strong>Message lifecycle</strong>, Chapter 4 <strong>Message
patterns</strong>, Chapter 6, Chapter 19 <strong>Message
retention</strong>, Chapter 4, Chapter 8 <strong>Message
routing</strong>, Chapter 4, Chapter 17 <strong>Message size
limits</strong>, Chapter 4, Chapter 17 <strong>Message
timestamps</strong>, Chapter 4 <strong>Message topics</strong>, Chapter
1, Chapter 4, Appendix A <strong>Message tracing</strong>, Chapter 18,
Chapter 17 <strong>Message validation</strong>, Chapter 4, Chapter 17
<strong>Metadata (message)</strong>, Chapter 4, Chapter 6 <strong>Method
signatures</strong>, Chapter 1, Chapter 17-25 <strong>Microservices
pattern</strong>, Chapter 19 <strong>Migration guide</strong>, Appendix
D <strong>MIME types</strong>, Chapter 5 <strong>Mobile browser
support</strong>, Chapter 5 <strong>Modal dialogs</strong>, Chapter 19
<strong>Module loading</strong>, Chapter 5, Chapter 7 <strong>Multi-step
forms</strong>, Chapter 10 <strong>Multi-tenant systems</strong>,
Chapter 4 <strong>MutationObserver</strong>, Chapter 16</li>
</ul>
<h2 data-number="29.14" id="n-1"><span
class="header-section-number">29.14</span> N</h2>
<p><strong>Naming conventions</strong></p>
<ul>
<li>Components, Chapter 1, Chapter 7</li>
<li>Topics, Chapter 4, Appendix A <strong>Navigation</strong>, Chapter 9
<strong>Netlify deployment</strong>, Chapter 20, Appendix G
<strong>Network errors</strong>, Chapter 11, Chapter 18 <strong>Nginx
configuration</strong>, Chapter 5, Chapter 20 <strong>Node.js
backend</strong>, Appendix G <strong>Notifications</strong>, Chapter 19
<strong>NPM installation</strong>, Chapter 5 <strong>NPM
packages</strong>, Appendix G</li>
</ul>
<h2 data-number="29.15" id="o-1"><span
class="header-section-number">29.15</span> O</h2>
<p><strong>OAuth integration</strong>, Chapter 12
<strong>observedAttributes</strong>, Chapter 7 <strong>Offline
support</strong>, Chapter 14, Chapter 20 <strong>Optimistic
updates</strong>, Chapter 11 <strong>Optimization</strong>, Chapter 16,
Chapter 20</p>
<ul>
<li>Bundle size, Chapter 16, Chapter 20</li>
<li>Code splitting, Chapter 16, Chapter 20</li>
<li>Image optimization, Chapter 16</li>
<li>Lazy loading, Chapter 16</li>
<li>Performance, Chapter 16 <strong>Origin Private File System
(OPFS)</strong>, Chapter 5, Chapter 14, Appendix G <strong>O’Reilly
conventions</strong>, Chapter 1</li>
</ul>
<h2 data-number="29.16" id="p-1"><span
class="header-section-number">29.16</span> P</h2>
<p><strong>Pagination</strong>, Chapter 11, Chapter 18 <strong>PAN (Page
Area Network)</strong>, Chapter 1, Chapter 3, Chapter 4 <strong>pan-bus
component</strong>, Chapter 4, Chapter 17</p>
<ul>
<li><p>Attributes, Chapter 17</p></li>
<li><p>Configuration, Chapter 4, Chapter 17</p></li>
<li><p>Events, Chapter 17</p></li>
<li><p>Methods, Chapter 17 <strong>pan-button component</strong>,
Chapter 19 <strong>pan-card component</strong>, Chapter 19
<strong>pan-client API</strong>, Chapter 4, Chapter 6
<strong>pan-data-table component</strong>, Chapter 18 <strong>pan-form
component</strong>, Chapter 10 <strong>pan-markdown-editor
component</strong>, Chapter 19 <strong>pan-routes component</strong>,
Chapter 9, Chapter 17 <strong>pan-storage component</strong>, Chapter 8,
Chapter 18 <strong>pan-theme-provider component</strong>, Chapter 15,
Chapter 17 <strong>pan-theme-toggle component</strong>, Chapter 15,
Chapter 17 <strong>pan:deliver event</strong>, Chapter 4, Chapter 6
<strong>pan:publish event</strong>, Chapter 4, Chapter 6
<strong>pan:sys.ready event</strong>, Chapter 5, Chapter 17
<strong>pan:sys.stats</strong>, Chapter 4, Chapter 17 <strong>Pattern
matching (topics)</strong>, Chapter 4 <strong>Performance
optimization</strong>, Chapter 16</p></li>
<li><p>Benchmarking, Chapter 16</p></li>
<li><p>Core Web Vitals, Chapter 16</p></li>
<li><p>Lazy loading, Chapter 16</p></li>
<li><p>Profiling, Chapter 16 <strong>Persistence</strong>, Chapter 8,
Chapter 14 <strong>Philosophy</strong>, Chapter 2 <strong>PHP
server</strong>, Chapter 5, Chapter 20 <strong>Playwright
testing</strong>, Chapter 17, Appendix G <strong>Plugin system</strong>,
Chapter 19 <strong>Podcasts</strong>, Appendix G
<strong>Polyfills</strong>, Chapter 5 <strong>Prerequisites</strong>,
Chapter 1, Chapter 5 <strong>Production deployment</strong>, Chapter 20
<strong>Progressive enhancement</strong>, Chapter 5 <strong>Progressive
Web Apps (PWA)</strong>, Chapter 20 <strong>Project structure</strong>,
Chapter 5 <strong>Promises</strong>, Chapter 6, Chapter 11
<strong>Pub/sub pattern</strong>, Chapter 4, Chapter 6 <strong>publish()
method</strong>, Chapter 4, Chapter 6 <strong>Publishing
components</strong>, Appendix G <strong>Pull requests</strong>, Appendix
G <strong>Python backend</strong>, Appendix G <strong>Python
http.server</strong>, Chapter 5</p></li>
</ul>
<h2 data-number="29.17" id="q"><span
class="header-section-number">29.17</span> Q</h2>
<p><strong>Query parameters</strong>, Chapter 9
<strong>QuotaExceededError</strong>, Chapter 5, Chapter 8</p>
<h2 data-number="29.18" id="r-1"><span
class="header-section-number">29.18</span> R</h2>
<p><strong>Rate limiting</strong>, Chapter 17 <strong>React
comparison</strong>, Chapter 2 <strong>Reactive patterns</strong>,
Chapter 8, Appendix G <strong>Real-time features</strong>, Chapter
13</p>
<ul>
<li><p>Presence tracking, Chapter 13</p></li>
<li><p>Server-Sent Events, Chapter 13</p></li>
<li><p>WebSocket integration, Chapter 13 <strong>Reddit
community</strong>, Appendix G <strong>Redux comparison</strong>,
Chapter 2, Chapter 8 <strong>References</strong>, Appendix G
<strong>Refactoring</strong>, Chapter 19 <strong>Regex
patterns</strong>, Chapter 4 <strong>Registration (component)</strong>,
Chapter 7 <strong>Related projects</strong>, Appendix G <strong>Release
notes</strong>, Appendix G <strong>Remote data</strong>, Chapter 11
<strong>Rendering optimization</strong>, Chapter 16 <strong>replyTo
field</strong>, Chapter 4, Chapter 6 <strong>request() method</strong>,
Chapter 4, Chapter 6 <strong>Request/reply pattern</strong>, Chapter 4,
Chapter 6 <strong>ResizeObserver</strong>, Chapter 16
<strong>Resources</strong>, Appendix G <strong>REST API design</strong>,
Chapter 11, Appendix G <strong>Retained messages</strong>, Chapter 4,
Chapter 8</p></li>
<li><p>LRU eviction, Chapter 4</p></li>
<li><p>Memory limits, Chapter 4</p></li>
<li><p>State synchronization, Chapter 8 <strong>Retry logic</strong>,
Chapter 11 <strong>RFC process</strong>, Appendix G
<strong>Roadmap</strong>, Appendix G <strong>Routing</strong>, Chapter
9</p></li>
<li><p>Client-side, Chapter 9</p></li>
<li><p>Hash routing, Chapter 9</p></li>
<li><p>History API, Chapter 9</p></li>
<li><p>Message routing, Chapter 4</p></li>
<li><p>Nested routes, Chapter 9</p></li>
<li><p>Query parameters, Chapter 9</p></li>
</ul>
<h2 data-number="29.19" id="s-1"><span
class="header-section-number">29.19</span> S</h2>
<p><strong>Safari Web Inspector</strong>, Chapter 5 <strong>Sandbox
mode</strong>, Chapter 20 <strong>Scaffolding tools</strong>, Chapter 5,
Appendix G <strong>Scope (component)</strong>, Chapter 7, Chapter 15
<strong>Security</strong>, Chapter 12, Chapter 20</p>
<ul>
<li><p>Authentication, Chapter 12</p></li>
<li><p>Authorization, Chapter 12</p></li>
<li><p>CSP, Chapter 20</p></li>
<li><p>XSS prevention, Chapter 20 <strong>Semantic routing</strong>,
Chapter 4 <strong>Server-Sent Events (SSE)</strong>, Chapter 13
<strong>Service Workers</strong>, Chapter 20 <strong>Session
management</strong>, Chapter 12 <strong>Setup</strong>, Chapter 5
<strong>Shadow DOM</strong>, Chapter 1, Chapter 5, Chapter 7, Chapter
15</p></li>
<li><p>CSS encapsulation, Chapter 15</p></li>
<li><p>Debugging, Chapter 5</p></li>
<li><p>Styling, Chapter 15 <strong>Shopping cart example</strong>,
Chapter 4, Chapter 8 <strong>Single Page Applications (SPA)</strong>,
Chapter 9 <strong>Slot elements</strong>, Chapter 7, Chapter 19
<strong>Smashing Magazine</strong>, Appendix G <strong>Social
media</strong>, Appendix G <strong>Software requirements</strong>,
Chapter 5 <strong>Sorting (data)</strong>, Chapter 18 <strong>Stack
Overflow</strong>, Appendix G <strong>State management</strong>, Chapter
8</p></li>
<li><p>Cross-tab sync, Chapter 8</p></li>
<li><p>Local state, Chapter 8</p></li>
<li><p>Persistent state, Chapter 8</p></li>
<li><p>Shared state, Chapter 8</p></li>
<li><p>State publisher pattern, Chapter 8 <strong>State
persistence</strong>, Chapter 8 <strong>State snapshots</strong>,
Chapter 4, Chapter 8 <strong>State synchronization</strong>, Chapter 4,
Chapter 8 <strong>Static hosting</strong>, Chapter 20, Appendix G
<strong>Storage APIs</strong>, Chapter 8, Chapter 14 <strong>Story (LARC
origin)</strong>, Chapter 3 <strong>Streaming data</strong>, Chapter 13
<strong>Style encapsulation</strong>, Chapter 7, Chapter 15
<strong>Styling components</strong>, Chapter 15 <strong>Sublime Text
configuration</strong>, Chapter 5 <strong>subscribe() method</strong>,
Chapter 4, Chapter 6 <strong>Subscription cleanup</strong>, Chapter 4,
Chapter 7 <strong>Subscription patterns</strong>, Chapter 4, Chapter 6
<strong>Svelte comparison</strong>, Chapter 2 <strong>System
themes</strong>, Chapter 15</p></li>
</ul>
<h2 data-number="29.20" id="t-1"><span
class="header-section-number">29.20</span> T</h2>
<p><strong>Tab synchronization</strong>, Chapter 8, Chapter 13
<strong>Table components</strong>, Chapter 18 <strong>Task list
example</strong>, Chapter 4, Chapter 5 <strong>Templates
(HTML)</strong>, Chapter 7 <strong>Testing</strong>, Chapter 17</p>
<ul>
<li><p>Component testing, Chapter 17</p></li>
<li><p>E2E testing, Chapter 17</p></li>
<li><p>Integration testing, Chapter 17</p></li>
<li><p>Unit testing, Chapter 17</p></li>
<li><p>Visual regression, Chapter 17 <strong>Testing resources</strong>,
Appendix G <strong>Theme switching</strong>, Chapter 15
<strong>Theming</strong>, Chapter 15</p></li>
<li><p>CSS Custom Properties, Chapter 15</p></li>
<li><p>Dark mode, Chapter 15</p></li>
<li><p>System preferences, Chapter 15 <strong>Throttling</strong>,
Chapter 16 <strong>Time-to-Interactive (TTI)</strong>, Chapter 16
<strong>Timestamps (message)</strong>, Chapter 4 <strong>Toast
notifications</strong>, Chapter 19 <strong>TodoWrite patterns</strong>,
Chapter 19 <strong>Topic conventions</strong>, Chapter 1, Chapter 4,
Appendix A <strong>Topic hierarchies</strong>, Chapter 4, Appendix A
<strong>Topic patterns</strong>, Chapter 4 <strong>Topic
wildcards</strong>, Chapter 4 <strong>Tracing (message)</strong>,
Chapter 18, Chapter 17 <strong>Training resources</strong>, Appendix G
<strong>Tree shaking</strong>, Chapter 20
<strong>Troubleshooting</strong>, Chapter 5, Chapter 18</p></li>
<li><p>Component loading, Chapter 5</p></li>
<li><p>CORS errors, Chapter 5</p></li>
<li><p>Message delivery, Chapter 5</p></li>
<li><p>Storage quota, Chapter 5</p></li>
<li><p>Styling issues, Chapter 5 <strong>TTL (Time To Live)</strong>,
Chapter 4 <strong>Tutorial book</strong>, Chapter 1, Appendix G
<strong>Twitter/X</strong>, Appendix G <strong>Type
definitions</strong>, Chapter 5, Appendix G <strong>TypeScript
support</strong>, Chapter 1, Chapter 5 <strong>Typographical
conventions</strong>, Chapter 1</p></li>
</ul>
<h2 data-number="29.21" id="u-1"><span
class="header-section-number">29.21</span> U</h2>
<p><strong>UI components</strong>, Chapter 19
<strong>Undo/redo</strong>, Chapter 8, Chapter 19 <strong>Unit
testing</strong>, Chapter 17 <strong>unpkg CDN</strong>, Chapter 5,
Appendix G <strong>Unsubscribe</strong>, Chapter 4, Chapter 7
<strong>Upload handling</strong>, Chapter 14 <strong>URL
routing</strong>, Chapter 9 <strong>User authentication</strong>,
Chapter 12 <strong>User input handling</strong>, Chapter 10
<strong>Utility components</strong>, Chapter 21 <strong>UUID
generation</strong>, Chapter 4</p>
<h2 data-number="29.22" id="v-1"><span
class="header-section-number">29.22</span> V</h2>
<p><strong>Validation</strong> - Form validation, Chapter 10 - Message
validation, Chapter 4, Chapter 17 <strong>Vercel deployment</strong>,
Chapter 20, Appendix G <strong>Video tutorials</strong>, Appendix G
<strong>Vim configuration</strong>, Chapter 5 <strong>Virtual
DOM</strong>, Chapter 2, Chapter 4 <strong>Virtual scrolling</strong>,
Chapter 16, Chapter 18 <strong>Visual regression testing</strong>,
Chapter 17 <strong>Vite</strong>, Chapter 5, Chapter 20 <strong>Vue
comparison</strong>, Chapter 2 <strong>VS Code extension</strong>,
Chapter 5, Appendix G</p>
<h2 data-number="29.23" id="w-1"><span
class="header-section-number">29.23</span> W</h2>
<p><strong>Web Components</strong>, Chapter 1, Chapter 4, Chapter 7,
Appendix G</p>
<ul>
<li>Browser support, Chapter 5</li>
<li>Custom Elements, Chapter 7</li>
<li>HTML Templates, Chapter 7</li>
<li>Shadow DOM, Chapter 7, Chapter 15</li>
<li>Standards, Appendix G <strong>Web Performance</strong>, Chapter 16,
Appendix G <strong>Web Test Runner</strong>, Chapter 17, Appendix G
<strong>web.dev</strong>, Appendix G <strong>webcomponents.org</strong>,
Appendix G <strong>WebSocket integration</strong>, Chapter 13, Appendix
G <strong>WebStorm</strong>, Chapter 5 <strong>Webpack</strong>, Chapter
1, Chapter 20 <strong>Who should read this book</strong>, Chapter 1
<strong>Wildcard subscriptions</strong>, Chapter 4, Chapter 17
<strong>window.panClient</strong>, Chapter 5, Chapter 6
**window.__panReady<strong>, Chapter 5, Chapter 17 </strong>Workshops**,
Appendix G</li>
</ul>
<h2 data-number="29.24" id="x"><span
class="header-section-number">29.24</span> X</h2>
<p><strong>XSS prevention</strong>, Chapter 20</p>
<h2 data-number="29.25" id="y"><span
class="header-section-number">29.25</span> Y</h2>
<p><strong>YouTube tutorials</strong>, Appendix G</p>
<h2 data-number="29.26" id="z"><span
class="header-section-number">29.26</span> Z</h2>
<p><strong>Zero-build development</strong>, Chapter 1, Chapter 2,
Chapter 5</p>
<ul>
<li>Philosophy, Chapter 2</li>
<li>Workflow, Chapter 5</li>
</ul>
<hr />
<h2 data-number="29.27" id="appendices"><span
class="header-section-number">29.27</span> Appendices</h2>
<p><strong>Appendix A: Message Topic Conventions</strong>
<strong>Appendix B: Event Envelope Specification</strong>
<strong>Appendix C: Configuration Reference</strong> <strong>Appendix D:
Migration Guides</strong> <strong>Appendix E: Code Recipes</strong>
<strong>Appendix F: Glossary</strong> <strong>Appendix G:
Resources</strong></p>
<h2 data-number="29.28" id="components-quick-reference"><span
class="header-section-number">29.28</span> Components Quick
Reference</h2>
<p><strong>Core Components</strong> (Chapter 17)</p>
<ul>
<li>pan-bus</li>
<li>pan-theme-provider</li>
<li>pan-theme-toggle</li>
<li>pan-routes</li>
</ul>
<p><strong>Data Components</strong> (Chapter 18)</p>
<ul>
<li>pan-store</li>
<li>pan-storage</li>
<li>pan-data-table</li>
<li>pan-list</li>
<li>pan-filter</li>
<li>pan-sort</li>
</ul>
<p><strong>UI Components</strong> (Chapter 19)</p>
<ul>
<li>pan-button</li>
<li>pan-card</li>
<li>pan-modal</li>
<li>pan-toast</li>
<li>pan-tabs</li>
<li>pan-accordion</li>
<li>pan-markdown-editor</li>
</ul>
<p><strong>Integration Components</strong> (Chapter 20)</p>
<ul>
<li>pan-http</li>
<li>pan-websocket</li>
<li>pan-sse</li>
<li>pan-auth</li>
<li>pan-analytics</li>
</ul>
<p><strong>Utility Components</strong> (Chapter 21)</p>
<ul>
<li>pan-logger</li>
<li>pan-validator</li>
<li>pan-debounce</li>
<li>pan-throttle</li>
</ul>
<hr />
<p><em>This index references chapters and appendices by title. Page
numbers would be added in print editions.</em></p>
<h1 data-number="30" id="colophon"><span
class="header-section-number">30</span> Colophon</h1>
<h2 data-number="30.1" id="about-the-cover-animal"><span
class="header-section-number">30.1</span> About the Cover Animal</h2>
<p>The animal on the cover of <em>Building with LARC</em> is a
<strong>North American Beaver</strong> (<em>Castor canadensis</em>), one
of nature’s most accomplished engineers and builders. Beavers are large,
semi-aquatic rodents native to North America, known for their remarkable
ability to modify their environment through the construction of dams,
lodges, and canals.</p>
<p>Adult beavers typically weigh between 35-65 pounds and measure 3-4
feet in length, including their distinctive flat, paddle-shaped tail.
Their dense, waterproof fur provides excellent insulation in cold water,
while webbed hind feet make them powerful swimmers. The beaver’s most
recognizable features are its large, continuously growing incisors -
sharp orange teeth that can fell trees up to 3 feet in diameter.</p>
<p>Beavers are legendary for their construction skills. Using branches,
logs, mud, and stones, they build elaborate dams that create ponds and
wetlands, fundamentally reshaping their ecosystem. These structures can
span hundreds of feet and last for decades, sometimes even centuries
with regular maintenance. The engineering is sophisticated: dams are
typically built with a curved shape to better withstand water pressure,
and beavers continuously monitor and repair their structures, plugging
leaks and reinforcing weak points.</p>
<p>Their lodges - dome-shaped homes built from sticks and mud - feature
underwater entrances for protection from predators, with living chambers
positioned above the waterline. Inside, these chambers remain remarkably
warm even during harsh winters, thanks to excellent insulation and the
occupants’ body heat.</p>
<p>Beavers work primarily at night and are highly industrious, with
family groups collaborating on construction projects. They communicate
through tail slaps on the water (warning signals), scent marking, and
vocalizations. Their tree-felling technique is methodical: they gnaw
around the trunk in an hourglass pattern until the tree falls, then
section it into manageable pieces for transport and use.</p>
<p>We chose the Beaver for this book because, like these master
builders, software architecture requires careful planning, solid
engineering principles, and the ability to construct complex systems
from simple components. The beaver’s methodical approach to building -
starting with a foundation, reinforcing structures, and creating systems
that serve multiple purposes - mirrors the best practices in software
development. Just as beaver dams create thriving ecosystems, well-built
applications create value for entire communities of users.</p>
<h2 data-number="30.2" id="about-the-cover-illustration"><span
class="header-section-number">30.2</span> About the Cover
Illustration</h2>
<p>The cover illustration was hand-drawn by the author using pen and
ink, photographed, and refined in Photoshop. The woodcut-style engraving
technique echoes the natural history illustrations of 18th and 19th
century field guides and the iconic animal covers of O’Reilly Media’s
technical books. The beaver is depicted sitting alertly on a log with
wood chips nearby - a working builder surveying its domain - which
seemed particularly fitting for a reference manual about building
applications. The detailed cross-hatching captures the texture of the
beaver’s fur and the grain of the wood, reflecting both the precision of
the craft and the artistry involved.</p>
<h2 data-number="30.3" id="fonts"><span
class="header-section-number">30.3</span> Fonts</h2>
<p>The text typeface is Adobe Minion Pro, the display typeface is Myriad
Pro, and the code typeface is Ubuntu Mono. The book was typeset using
Pandoc and LaTeX.</p>
<h2 data-number="30.4" id="production-notes"><span
class="header-section-number">30.4</span> Production Notes</h2>
<p>This book was authored in Markdown using a modular structure with 25
chapters, 7 appendices, and a comprehensive index. The content was
converted to multiple formats (HTML, PDF, and EPUB) using Pandoc. All
code examples were tested against LARC version 3.x and validated for
correctness.</p>
<p>The book follows O’Reilly’s tradition of comprehensive technical
documentation: starting with philosophy and context, moving through
practical implementation, and concluding with exhaustive API reference
material. The structure was inspired by classic programming references
like <em>Programming Perl</em> and <em>Programming Python</em>, which
balance narrative explanation with detailed technical
specifications.</p>
<p>The build system itself was designed to embody LARC’s philosophy: it
works without complex toolchains, uses standard tools (Pandoc, LaTeX),
and produces professional results with minimal configuration. In a meta
sense, the build script is a small LARC application - taking structured
inputs and producing multiple coordinated outputs.</p>
<h2 data-number="30.5" id="acknowledgments"><span
class="header-section-number">30.5</span> Acknowledgments</h2>
<p>Special thanks to the LARC community for their contributions,
feedback, and real-world usage patterns that informed many sections of
this book. Thanks also to Christopher Robison for his vision in creating
LARC and his commitment to web standards and developer ergonomics.</p>
<hr />
<p><em>If you find an error in this book, have suggestions for
improvements, or want to contribute additional recipes and patterns,
please visit our GitHub repository or contact the author. This book is a
living document that grows with the LARC community.</em></p>
<h1 data-number="31" id="learning-larc"><span
class="header-section-number">31</span> Learning LARC</h1>
<h2 data-number="31.1"
id="the-web-has-grown-up.-its-time-our-apps-did-too."><span
class="header-section-number">31.1</span> The Web Has Grown Up. It’s
Time Our Apps Did Too.</h2>
<p>Modern browsers aren’t the brittle playgrounds they once were.
They’re fast, secure, richly capable application platforms — yet most of
today’s development stacks still treat them like dumb terminals that
need layers of tooling, bundling, and framework magic just to
function.</p>
<p><strong>Learning LARC</strong> shows another path.</p>
<p>LARC embraces the browser as a mature runtime, using nothing but open
standards — Web Components, modules, events, and message buses — to
build complex, deeply interactive applications without build systems,
without monoliths, and without ceremony. Through clear narrative
examples and real architectural stories, this book teaches you how to
design apps as ecosystems: small parts, clearly defined, communicating
through a shared bus.</p>
<p>You’ll learn how to structure large systems out of tiny cooperating
modules, expose capabilities through message patterns instead of global
state, keep your interfaces clean, and let the platform do the heavy
lifting it was built for.</p>
<p>No bundlers. No scaffolding. No twenty-layer dependency stacks. Just
the browser, finally treated like the grown-up it is.</p>
<p>Whether you’re maintaining a legacy system or starting fresh,
<strong>Learning LARC</strong> will help you rethink how modern web apps
can — and should — be built.</p>
<h2 data-number="31.2" id="about-the-author"><span
class="header-section-number">31.2</span> About the Author</h2>
<p>Christopher Robison is a veteran software engineer and architect with
nearly three decades of experience building systems that range from
biotech and online trading platforms to complex web applications and
AI-driven tools. A lifelong maker with a deep appreciation for open
standards, he has spent his career exploring the boundaries of what the
web can do when you stop fighting the platform and start embracing
it.</p>
<p>He is the creator of LARC.js and the PAN message bus, a
browser-native architecture inspired by the elegant simplicity of the
automotive CAN bus. His work blends engineering pragmatism with a
playful curiosity that has led him to design everything from 3D printers
and robotics to interactive music systems and decentralized
applications.</p>
<p>Christopher currently lives in San Francisco, where he continues to
build things that bridge the digital and physical worlds — and
occasionally sneaks off to play punk rock shows with his band.</p>
<p><strong>Website:</strong> <a
href="https://larcjs.com">https://larcjs.com</a></p>
</body>
</html>
