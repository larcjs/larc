<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Christopher Robison" />
  <meta name="description" content="A comprehensive, hands-on guide to building modern web applications with LARC. Learn to create reactive components using web standards and the Page Area Network (PAN) message bus." />
  <title>Learning LARC</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="book-style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Learning LARC</h1>
<p class="subtitle">A Hands-On Guide to Modern Web Development</p>
<p class="author">Christopher Robison</p>
<p class="date">December 2025</p>
</header>
<div class="pagebreak">

</div>
<hr />
<h2 class="unnumbered" id="praise-for-learning-larc">Praise for Learning
LARC</h2>
<p><em>“LARC represents a return to web fundamentals while embracing
modern capabilities. This book beautifully explains why that
matters.”</em> — <strong>David B. - Software Engineer</strong></p>
<p><em>“Finally, a framework that respects the browser. Learning LARC
shows you how to build without fighting the platform.”</em> —
<strong>Jon W. - App Developer</strong></p>
<p><em>“The PAN bus architecture is elegant and powerful. This book
makes it accessible to everyone.”</em> — <strong>Mary S. - Designer /
Artist</strong></p>
<div class="pagebreak">

</div>
<hr />
<h2 class="unnumbered" id="copyright">Copyright</h2>
<p>Copyright © 2025 LARC Team. All rights reserved.</p>
<p>Printed in the United States of America.</p>
<p>Published by LARC Press.</p>
<p>The LARC logo and name are trademarks of the LARC Project.</p>
<p>While the publisher and authors have used good faith efforts to
ensure that the information and instructions contained in this work are
accurate, the publisher and authors disclaim all responsibility for
errors or omissions, including without limitation responsibility for
damages resulting from the use of or reliance on this work.</p>
<p>Use of the information and instructions contained in this work is at
your own risk. If any code samples or other technology this work
contains or describes is subject to open source licenses or the
intellectual property rights of others, it is your responsibility to
ensure that your use thereof complies with such licenses and/or
rights.</p>
<div class="pagebreak">

</div>
<hr />
<h2 class="unnumbered" id="table-of-contents">Table of Contents</h2>
<h3 class="unnumbered" id="preface">Preface</h3>
<ul>
<li>Who This Book Is For</li>
<li>What You’ll Learn</li>
<li>Conventions Used in This Book</li>
<li>Using Code Examples</li>
<li>How to Contact Us</li>
<li>Acknowledgments</li>
</ul>
<h3 class="unnumbered" id="part-i-foundations">Part I: Foundations</h3>
<p><strong>Chapter 1: Philosophy and Background</strong></p>
<ul>
<li>The Problem with Modern Web Development</li>
<li>A Return to Fundamentals</li>
<li>The LARC Philosophy</li>
<li>Why “No Build” Matters</li>
<li>When to Use LARC</li>
<li>What You’ll Build</li>
</ul>
<p><strong>Chapter 2: Core Concepts</strong></p>
<ul>
<li>Web Components Refresher</li>
<li>The Page Area Network (PAN)</li>
<li>Event-Driven Architecture</li>
<li>State Management Philosophy</li>
<li>Module System</li>
<li>The Component Lifecycle</li>
</ul>
<p><strong>Chapter 3: Getting Started</strong></p>
<ul>
<li>Setting Up Your Development Environment</li>
<li>Your First LARC Application</li>
<li>Project Structure</li>
<li>Import Maps Explained</li>
<li>Development Workflow</li>
<li>Common Patterns</li>
</ul>
<h3 class="unnumbered" id="part-ii-building-components">Part II:
Building Components</h3>
<p><strong>Chapter 4: Creating Web Components</strong></p>
<ul>
<li>Anatomy of a LARC Component</li>
<li>Shadow DOM Deep Dive</li>
<li>Attributes and Properties</li>
<li>Component Styling</li>
<li>Lifecycle Methods</li>
<li>Testing Components</li>
</ul>
<p><strong>Chapter 5: The PAN Bus</strong></p>
<ul>
<li>Understanding Pub/Sub Architecture</li>
<li>Topics and Namespaces</li>
<li>Publishing Messages</li>
<li>Subscribing to Events</li>
<li>Message Patterns</li>
<li>Debugging PAN Communication</li>
</ul>
<p><strong>Chapter 6: State Management</strong></p>
<ul>
<li>Component-Local State</li>
<li>Shared State Patterns</li>
<li>The pan-store Component</li>
<li>IndexedDB Integration</li>
<li>Persistence Strategies</li>
<li>Offline-First Applications</li>
</ul>
<p><strong>Chapter 7: Advanced Component Patterns</strong></p>
<ul>
<li>Compound Components</li>
<li>Higher-Order Components</li>
<li>Component Composition</li>
<li>Slots and Content Projection</li>
<li>Dynamic Component Loading</li>
<li>Performance Optimization</li>
</ul>
<h3 class="unnumbered" id="part-iii-building-applications">Part III:
Building Applications</h3>
<p><strong>Chapter 8: Routing and Navigation</strong></p>
<ul>
<li>Client-Side Routing</li>
<li>The pan-router Component</li>
<li>Route Parameters</li>
<li>Nested Routes</li>
<li>Route Guards</li>
<li>History Management</li>
</ul>
<p><strong>Chapter 9: Forms and Validation</strong></p>
<ul>
<li>Form Components</li>
<li>Two-Way Data Binding</li>
<li>Validation Strategies</li>
<li>Error Handling</li>
<li>File Uploads</li>
<li>Form Submission</li>
</ul>
<p><strong>Chapter 10: Data Fetching and APIs</strong></p>
<ul>
<li>The pan-fetch Component</li>
<li>REST API Integration</li>
<li>GraphQL Support</li>
<li>WebSocket Communication</li>
<li>Server-Sent Events</li>
<li>Error Handling and Retry Logic</li>
</ul>
<p><strong>Chapter 11: Authentication and Security</strong></p>
<ul>
<li>Authentication Patterns</li>
<li>The pan-auth Component</li>
<li>JWT Token Management</li>
<li>Protected Routes</li>
<li>CORS Considerations</li>
<li>Security Best Practices</li>
</ul>
<h3 class="unnumbered" id="part-iv-advanced-topics">Part IV: Advanced
Topics</h3>
<p><strong>Chapter 12: Server Integration</strong></p>
<ul>
<li>Backend Architecture</li>
<li>Node.js Integration</li>
<li>PHP Connector</li>
<li>Python/Django Integration</li>
<li>Database Patterns</li>
<li>Real-Time Communication</li>
</ul>
<p><strong>Chapter 13: Testing</strong></p>
<ul>
<li>Unit Testing Components</li>
<li>Integration Testing</li>
<li>End-to-End Testing</li>
<li>Visual Regression Testing</li>
<li>Performance Testing</li>
<li>Continuous Integration</li>
</ul>
<p><strong>Chapter 14: Performance and Optimization</strong></p>
<ul>
<li>Loading Strategies</li>
<li>Code Splitting</li>
<li>Lazy Loading Components</li>
<li>Caching Strategies</li>
<li>Bundle Size Optimization</li>
<li>Performance Monitoring</li>
</ul>
<p><strong>Chapter 15: Deployment</strong></p>
<ul>
<li>Static Hosting</li>
<li>CDN Configuration</li>
<li>Environment Variables</li>
<li>CI/CD Pipelines</li>
<li>Monitoring and Analytics</li>
<li>Production Best Practices</li>
</ul>
<h3 class="unnumbered" id="part-v-ecosystem">Part V: Ecosystem</h3>
<p><strong>Chapter 16: Component Library</strong></p>
<ul>
<li>Using the Component Registry</li>
<li>Contributing Components</li>
<li>Creating a Component Library</li>
<li>Documentation Strategies</li>
<li>Versioning and Releases</li>
</ul>
<p><strong>Chapter 17: Tooling</strong></p>
<ul>
<li>Development Tools</li>
<li>CLI Tools</li>
<li>VS Code Integration</li>
<li>Browser DevTools</li>
<li>Debugging Techniques</li>
</ul>
<p><strong>Chapter 18: Real-World Applications</strong></p>
<ul>
<li>Case Study: E-Commerce Platform</li>
<li>Case Study: Dashboard Application</li>
<li>Case Study: Blog/CMS</li>
<li>Lessons Learned</li>
<li>Best Practices</li>
</ul>
<h3 class="unnumbered" id="appendices">Appendices</h3>
<p><strong>Appendix A: Web Components API Reference</strong></p>
<ul>
<li>Custom Elements</li>
<li>Shadow DOM</li>
<li>HTML Templates</li>
<li>ES Modules</li>
</ul>
<p><strong>Appendix B: PAN Bus API Reference</strong></p>
<ul>
<li>Core Methods</li>
<li>Message Formats</li>
<li>Topic Patterns</li>
<li>Configuration Options</li>
</ul>
<p><strong>Appendix C: Component API Reference</strong></p>
<ul>
<li>Built-in Components</li>
<li>Component Properties</li>
<li>Events and Methods</li>
</ul>
<p><strong>Appendix D: Migration Guides</strong></p>
<ul>
<li>From React</li>
<li>From Vue</li>
<li>From Angular</li>
<li>From jQuery</li>
</ul>
<p><strong>Appendix E: Resources</strong></p>
<ul>
<li>Official Documentation</li>
<li>Community Resources</li>
<li>Video Tutorials</li>
<li>Example Projects</li>
</ul>
<h3 class="unnumbered" id="index">Index</h3>
<div class="pagebreak">

</div>
<hr />
<h2 class="unnumbered" id="about-the-author">About the Author</h2>
<p>Christopher Robison is a veteran software engineer and architect with
nearly three decades of experience building systems that range from
biotech and online trading platforms to complex web applications and
AI-driven tools. A lifelong maker with a deep appreciation for open
standards, he has spent his career exploring the boundaries of what the
web can do when you stop fighting the platform and start embracing
it.</p>
<p>He is the creator of LARC.js and the PAN message bus, a
browser-native architecture inspired by the elegant simplicity of the
automotive CAN bus. His work blends engineering pragmatism with a
playful curiosity that has led him to design everything from 3D printers
and robotics to interactive music systems and decentralized
applications.</p>
<p>Christopher currently lives in San Francisco, where he continues to
build things that bridge the digital and physical worlds — and
occasionally sneaks off to play punk rock shows with his band.</p>
<p><strong>Website:</strong> <a
href="https://larcjs.com">https://larcjs.com</a></p>
<hr />
<div class="pagebreak">

</div>
<h1 class="unnumbered" id="foreword">Foreword</h1>
<p><em>by Christopher Robison</em></p>
<p>I didn’t set out to build a framework. I set out to escape one — or
at least escape the gravitational pull of the endless build
pipeline.</p>
<p>After decades of building things for the web, my machine had become a
storage exhibit of Node versions, Python versions, shims, wrappers, and
dependency folders with the mass of small moons. Not because any of it
was bad. Build tools are fine. For big projects, they’re downright
amazing. But somewhere along the way, we normalized the idea that even
the simplest experiment needed a pipeline, a bundler, a transpiler, and
a twelve-step hydration ritual before it could say “Hello, World.”</p>
<p>That friction bothered me.</p>
<p>I wanted the feeling I had back in the early days: the joy of
dropping a <code>&lt;script&gt;</code> tag into an HTML file and
instantly seeing something come alive. No ceremony. No yak shaving. Just
a browser, a file, and an idea.</p>
<p>Web Components felt close to that spirit — native modules, shadow
DOM, real encapsulation — but they were oddly isolated. Each component
was a self-contained island. Reusable, yes. Architecturally composable?
Not really. Nothing tied them together except whatever glue code you
wrote yourself. It felt like someone had shipped LEGO bricks without the
ability to click them together.</p>
<p>That’s when I remembered the CAN bus in cars.</p>
<p>The CAN bus is this beautifully simple ecosystem: dozens of systems —
sensors, motors, controllers — all sharing a single communication line.
Anybody can broadcast. Anybody can listen. Nobody needs to know who else
exists. A message goes out, and the parts that care respond. It’s
loosely coupled machinery at its finest.</p>
<p>I wanted that for the web.</p>
<p>So I built the PAN bus — the Page Area Network — and started
experimenting. Not with the intention of making A Real Framework™, but
out of curiosity. How far could I push this idea? What could I build if
every component on the page could talk over a shared bus, using nothing
but browser-native APIs and one tiny script include?</p>
<p>That little experiment got out of hand in the best way.</p>
<p>I kept pushing it, partly out of stubbornness, partly out of sheer
delight. I wanted to see if I could build real, full-blown applications
with no build process at all — just a single script tag pointing to LARC
and a page full of components chatting over the bus. And it turned out
to be… fun. Refreshing. Capable. Liberating, even. A loose, elegant
architecture emerged almost on its own.</p>
<p>Along the way, I realized something important: I’m not
anti-build-tool. They solve real problems, especially at scale. But they
shouldn’t be mandatory for everything. And they shouldn’t overshadow the
fact that the browser today is powerful enough to build serious
applications with a simple HTML page, a few components, and a shared
message bus.</p>
<p>React, Angular, Vue — they solved problems that absolutely needed
solving at the time. The web platform in 2015 was missing big pieces:
templating, reactivity, routing, structured components, coherence. These
frameworks carried the industry through that era. But the web has
evolved since then. Many of those features now exist natively —
standardized, built-in, fast, and universally available.</p>
<p>LARC isn’t here to replace those frameworks. It complements them. It
fills in the 20% Web Components never standardized — the shared
communication fabric. The glue that lets components coexist instead of
siloing themselves off. It also makes bundle sizes smaller and
architectures cleaner, whether you’re going framework-free or
integrating with your existing stack.</p>
<p>If this book succeeds, you’ll see what I saw: the thrill of
rediscovering the browser as a first-class app platform. The joy of
building big things out of small, decoupled pieces. And the surprising
power of an architecture that starts with a simple HTML file and one
script include.</p>
<p>The web grew up. Now we get to build like it.</p>
<p>— <em>Christopher Robison</em></p>
<div class="pagebreak">

</div>
<h1 data-number="1" id="philosophy-and-background"><span
class="header-section-number">1</span> Philosophy and Background</h1>
<h2 data-number="1.1" id="the-problem-with-modern-web-development"><span
class="header-section-number">1.1</span> The Problem with Modern Web
Development</h2>
<p>If you’ve been building web applications for the past decade, you’ve
likely experienced what many developers call “JavaScript fatigue.” The
modern web development landscape has become increasingly complex, with
countless tools, frameworks, and build processes standing between you
and shipping working code.</p>
<p>Consider a typical modern web project setup:</p>
<ol type="1">
<li>Initialize your project with a framework CLI
(<code>create-react-app</code>, <code>vue create</code>, etc.)</li>
<li>Install hundreds or thousands of npm dependencies</li>
<li>Configure webpack, Babel, TypeScript, ESLint, Prettier</li>
<li>Set up build scripts for development, production, testing</li>
<li>Wait for builds to complete (sometimes minutes)</li>
<li>Debug build configuration issues when something breaks</li>
<li>Update dependencies regularly to patch security vulnerabilities</li>
<li>Repeat the cycle when frameworks release breaking changes</li>
</ol>
<p>This complexity wasn’t always necessary. In the early days of the
web, you could create an HTML file, add some CSS and JavaScript, and
open it directly in a browser. No build step. No toolchain. No
configuration. Just code that runs.</p>
<p>What happened?</p>
<h3 data-number="1.1.1" id="the-rise-of-complexity"><span
class="header-section-number">1.1.1</span> The Rise of Complexity</h3>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/12-traditional-vs-larc-1.png"
alt="Figure 1.1: Development Workflow - Traditional vs LARC" />
<figcaption aria-hidden="true"><strong>Figure 1.1:</strong> Development
Workflow - Traditional vs LARC</figcaption>
</figure>
<p>The web platform evolved, but it didn’t evolve fast enough for
ambitious developers. We wanted:</p>
<ul>
<li><strong>Component-based architecture</strong> — but HTML didn’t have
custom elements yet</li>
<li><strong>Module systems</strong> — but JavaScript didn’t have native
imports</li>
<li><strong>Reactive data binding</strong> — but the DOM wasn’t designed
for it</li>
<li><strong>Advanced syntax</strong> — like JSX, TypeScript, or class
properties</li>
</ul>
<p>Frameworks filled these gaps by building abstractions on top of the
web platform. But these abstractions came with costs:</p>
<ul>
<li><strong>Build toolchains</strong> became mandatory to transpile
code</li>
<li><strong>Bundle sizes</strong> grew as framework code was shipped to
browsers</li>
<li><strong>Learning curves</strong> steepened as developers had to
learn both the framework and the tools</li>
<li><strong>Debugging</strong> became harder with source maps and
transpiled code</li>
<li><strong>Performance</strong> suffered from unnecessary abstraction
layers</li>
</ul>
<p>The irony? While we were busy building these elaborate toolchains,
the web platform itself was evolving to support many of the features we
wanted natively.</p>
<h3 data-number="1.1.2" id="the-platform-has-caught-up"><span
class="header-section-number">1.1.2</span> The Platform Has Caught
Up</h3>
<div class="side-by-side">
<p><img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/01-architecture-overview-3.png"
style="width:48.0%" alt="Figure 1.2: LARC No-Build Architecture" /> <img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/12-traditional-vs-larc-3.png"
style="width:48.0%" alt="Figure 1.3: Bundle Size Comparison" /></p>
</div>
<p>Today’s web platform is remarkably capable. Modern browsers
support:</p>
<ul>
<li><strong>Custom Elements</strong> — native component definition</li>
<li><strong>Shadow DOM</strong> — true style encapsulation</li>
<li><strong>ES Modules</strong> — native JavaScript modules with
imports</li>
<li><strong>Import Maps</strong> — dependency management without
bundlers</li>
<li><strong>Template Literals</strong> — dynamic HTML without JSX</li>
<li><strong>Proxy and Reflect</strong> — reactive data patterns</li>
<li><strong>CSS Custom Properties</strong> — themeable components</li>
<li><strong>Web Components</strong> — standards-based component
architecture</li>
</ul>
<p>These aren’t polyfills or experimental features. They’re stable,
well-supported standards that work across all modern browsers. Yet most
web frameworks continue to build elaborate abstractions on top of the
platform, ignoring these native capabilities.</p>
<h3 data-number="1.1.3" id="a-common-scenario"><span
class="header-section-number">1.1.3</span> A Common Scenario</h3>
<p>Let’s look at a real-world example. Imagine you’re building a simple
dashboard with a few interactive components: a card, a button, and a
data table. Here’s what this might look like in a typical React
project:</p>
<p><strong>The Setup:</strong></p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> create-react-app my-dashboard</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> my-dashboard</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install styled-components react-router axios redux</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait 5-10 minutes for installation</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Project size: ~300MB, ~1000+ dependencies</span></span></code></pre></div>
<p><strong>The Code:</strong></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Card.jsx</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> styled <span class="im">from</span> <span class="st">&#39;styled-components&#39;</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> StyledCard <span class="op">=</span> styled<span class="op">.</span><span class="fu">div</span><span class="vs">`</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="vs">  padding: 20px;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  border-radius: 8px;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  box-shadow: 0 2px 4px rgba(0,0,0,0.1);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="kw">function</span> <span class="fu">Card</span>({ title<span class="op">,</span> children }) {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">&lt;StyledCard&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;h2&gt;</span><span class="va">{</span>title<span class="va">}</span><span class="kw">&lt;/h2&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">{</span>children<span class="va">}</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">&lt;/StyledCard&gt;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>The Build:</strong></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run build</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait 30-60 seconds</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Output: Minified, bundled, transpiled code</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Bundle size: 200-500KB (before your actual code)</span></span></code></pre></div>
<p>Now, here’s the same thing with native Web Components and LARC:</p>
<p><strong>The Setup:</strong></p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larcjs/ui&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/components@2.0.0/pan-card.mjs&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-card</span><span class="ot"> title</span><span class="op">=</span><span class="st">&quot;Dashboard&quot;</span><span class="dt">&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Your content here<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-card</span><span class="dt">&gt;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>The Build:</strong></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># There is no build step. Open the HTML file. It works.</span></span></code></pre></div>
<p>Same functionality. Zero dependencies. No build process. No
toolchain. Just HTML, CSS, and JavaScript working together as the
platform intended.</p>
<h2 data-number="1.2" id="a-return-to-fundamentals"><span
class="header-section-number">1.2</span> A Return to Fundamentals</h2>
<p>LARC (Lightweight Autonomous Reactive Components) represents a
philosophical shift back to web fundamentals. But this isn’t about going
backward—it’s about recognizing that the platform has evolved to the
point where many of our abstractions are no longer necessary.</p>
<h3 data-number="1.2.1" id="what-larc-is"><span
class="header-section-number">1.2.1</span> What LARC Is</h3>
<p>LARC is a set of conventions, patterns, and utilities for building
modern web applications using native web standards:</p>
<ul>
<li><strong>Web Components</strong> for encapsulated, reusable UI
elements</li>
<li><strong>ES Modules</strong> for code organization and imports</li>
<li><strong>Import Maps</strong> for dependency management</li>
<li><strong>The PAN Bus</strong> for component communication</li>
<li><strong>Native APIs</strong> for state, routing, and data
fetching</li>
</ul>
<p>LARC provides guidance and utilities, but it doesn’t abstract away
the platform. When you write LARC code, you’re writing standard
JavaScript, HTML, and CSS that runs directly in the browser.</p>
<h3 data-number="1.2.2" id="what-larc-is-not"><span
class="header-section-number">1.2.2</span> What LARC Is Not</h3>
<p>LARC is deliberately minimal. It is <strong>not</strong>:</p>
<ul>
<li>A framework with proprietary APIs you must learn</li>
<li>A template language that requires compilation</li>
<li>A state management system with complex rules</li>
<li>A build tool that transforms your code</li>
<li>A runtime that interprets your components</li>
</ul>
<p>If you know HTML, CSS, and JavaScript, you already know most of
LARC.</p>
<h3 data-number="1.2.3" id="core-principles"><span
class="header-section-number">1.2.3</span> Core Principles</h3>
<p>LARC is built on several core principles:</p>
<h4 data-number="1.2.3.1" id="standards-first"><span
class="header-section-number">1.2.3.1</span> 1. Standards First</h4>
<p>LARC embraces web standards rather than fighting them. Every LARC
component is a valid Web Component. Every LARC module is a valid ES
Module. If you understand the standards, you understand LARC.</p>
<h4 data-number="1.2.3.2" id="zero-build-for-development"><span
class="header-section-number">1.2.3.2</span> 2. Zero Build for
Development</h4>
<p>During development, you should be able to edit a file and refresh the
browser. No build step. No waiting. No configuration. The browser is
your development environment.</p>
<p>This doesn’t mean builds are forbidden—you can still optimize for
production if needed. But they should be optional enhancements, not
requirements.</p>
<h4 data-number="1.2.3.3" id="progressive-enhancement"><span
class="header-section-number">1.2.3.3</span> 3. Progressive
Enhancement</h4>
<p>Start simple and add complexity only when needed. A basic component
can be a few lines of JavaScript. As requirements grow, add features
incrementally: state management, routing, server integration, etc.</p>
<p>You’re never locked into architectural decisions made at project
initialization. LARC applications evolve naturally.</p>
<h4 data-number="1.2.3.4" id="local-first-network-aware"><span
class="header-section-number">1.2.3.4</span> 4. Local First, Network
Aware</h4>
<p>Components should work independently with local state. Network
communication happens through explicit, observable patterns (the PAN
bus). This makes components:</p>
<ul>
<li>Easier to test (no mocking required)</li>
<li>More reusable (fewer dependencies)</li>
<li>More resilient (graceful degradation)</li>
</ul>
<h4 data-number="1.2.3.5"
id="developer-experience-through-simplicity"><span
class="header-section-number">1.2.3.5</span> 5. Developer Experience
Through Simplicity</h4>
<p>Good DX doesn’t require complex tooling. It comes from:</p>
<ul>
<li>Clear, predictable patterns</li>
<li>Minimal abstractions</li>
<li>Fast feedback loops</li>
<li>Easy debugging</li>
<li>Comprehensive documentation</li>
</ul>
<p>When something breaks in LARC, you can open browser DevTools and
debug standard JavaScript. No source maps. No transpiled code. No
framework internals.</p>
<h2 data-number="1.3" id="the-larc-philosophy"><span
class="header-section-number">1.3</span> The LARC Philosophy</h2>
<p>At its heart, LARC is about <strong>respecting the platform</strong>.
The web is incredibly powerful, yet we’ve spent years building layers of
abstraction that hide its capabilities. LARC removes those layers.</p>
<h3 data-number="1.3.1" id="composition-over-configuration"><span
class="header-section-number">1.3.1</span> Composition Over
Configuration</h3>
<p>Rather than configuring a framework through JSON or CLI flags, LARC
applications are composed from standard parts:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Composition: Combine standard elements --&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;home-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/dashboard&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;dashboard-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Each element is understandable in isolation. There’s no magic
configuration file that controls behavior across your entire
application.</p>
<h3 data-number="1.3.2" id="convention-over-prescription"><span
class="header-section-number">1.3.2</span> Convention Over
Prescription</h3>
<p>LARC suggests patterns but doesn’t enforce them. There’s no “one true
way” to structure a LARC application. The conventions exist to make
common tasks easier, but you can always drop down to standard APIs when
needed.</p>
<p>For example, LARC recommends the PAN bus for component communication,
but you can also use:</p>
<ul>
<li>Custom events</li>
<li>Direct property access</li>
<li>Shared state objects</li>
<li>URL parameters</li>
<li>LocalStorage</li>
<li>Any other standard browser API</li>
</ul>
<p>Choose the right tool for your specific use case.</p>
<h3 data-number="1.3.3" id="explicit-over-implicit"><span
class="header-section-number">1.3.3</span> Explicit Over Implicit</h3>
<p>LARC favors explicitness. When a component fetches data, you see the
fetch call. When state changes, you see the assignment. When events are
dispatched, you see the dispatch.</p>
<p>Compare these two approaches:</p>
<p><strong>Implicit (typical framework):</strong></p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">UserProfile</span>() {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [user<span class="op">,</span> loading<span class="op">,</span> error] <span class="op">=</span> <span class="fu">useUser</span>(userId)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (loading) <span class="cf">return </span><span class="fu">&lt;Spinner</span> <span class="fu">/&gt;</span><span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (error) <span class="cf">return </span><span class="fu">&lt;Error</span> <span class="ot">message</span><span class="op">=</span><span class="va">{</span>error<span class="va">}</span> <span class="fu">/&gt;</span><span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return </span><span class="fu">&lt;ProfileCard</span> <span class="ot">user</span><span class="op">=</span><span class="va">{</span>user<span class="va">}</span> <span class="fu">/&gt;</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Magic happens in <code>useUser</code>. Where does the data come from?
When does it refetch? What triggers updates? You need to understand the
framework’s mental model.</p>
<p><strong>Explicit (LARC):</strong></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ <span class="dt">loading</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">userId</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ user })<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(state) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (state<span class="op">.</span><span class="at">loading</span>) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;loading-spinner&gt;&lt;/loading-spinner&gt;&#39;</span><span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (state<span class="op">.</span><span class="at">error</span>) {</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;error-message text=&quot;</span><span class="sc">${</span>state<span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&quot;&gt;&lt;/error-message&gt;`</span><span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;profile-card .user=&quot;</span><span class="sc">${</span>state<span class="op">.</span><span class="at">user</span><span class="sc">}</span><span class="vs">&quot;&gt;&lt;/profile-card&gt;`</span><span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Every step is visible. You can trace exactly what happens and when.
Debugging is straightforward because you’re working with standard
JavaScript.</p>
<h2 data-number="1.4" id="why-no-build-matters"><span
class="header-section-number">1.4</span> Why “No Build” Matters</h2>
<p>The “no build” philosophy isn’t about being purist or rejecting
tools. It’s about removing unnecessary complexity and its associated
costs.</p>
<h3 data-number="1.4.1" id="development-speed"><span
class="header-section-number">1.4.1</span> Development Speed</h3>
<p>Without a build step, your development cycle is:</p>
<ol type="1">
<li>Edit code</li>
<li>Refresh browser</li>
<li>See changes</li>
</ol>
<p>That’s it. No waiting for webpack to rebuild. No watching file
watchers fail. No debugging build configurations.</p>
<p>This might seem like a small thing, but it compounds. Over a day of
development, those 10-30 second build times add up to significant lost
productivity. More importantly, they break flow state.</p>
<h3 data-number="1.4.2" id="debugging-simplicity"><span
class="header-section-number">1.4.2</span> Debugging Simplicity</h3>
<p>When you open browser DevTools in a LARC application, you see your
actual code. No source maps needed. No transpiled output. No minified
framework internals.</p>
<p>Set a breakpoint in your component’s <code>connectedCallback</code>.
It stops exactly where you expect. The call stack is readable. Variables
are named as you wrote them.</p>
<p>This makes debugging accessible to junior developers and reduces time
spent fighting tools.</p>
<h3 data-number="1.4.3" id="deployment-simplicity"><span
class="header-section-number">1.4.3</span> Deployment Simplicity</h3>
<p>A LARC application can be deployed to any static host:</p>
<ul>
<li>GitHub Pages</li>
<li>Netlify</li>
<li>Vercel</li>
<li>Amazon S3</li>
<li>Any web server</li>
</ul>
<p>No server-side rendering. No Node.js runtime. No build artifacts to
manage. Just upload HTML, CSS, and JavaScript files.</p>
<p>Want to deploy to a CDN? Your entire application is already
CDN-friendly because it’s just static files.</p>
<h3 data-number="1.4.4" id="lower-barrier-to-entry"><span
class="header-section-number">1.4.4</span> Lower Barrier to Entry</h3>
<p>New developers can learn web development by:</p>
<ol type="1">
<li>Creating an HTML file</li>
<li>Adding some CSS and JavaScript</li>
<li>Opening it in a browser</li>
</ol>
<p>No installation. No environment setup. No project configuration. This
is how the web should work.</p>
<p>With build tools, new developers face:</p>
<ol type="1">
<li>Install Node.js</li>
<li>Learn npm/yarn</li>
<li>Understand package.json</li>
<li>Configure webpack/Babel</li>
<li>Troubleshoot build errors</li>
<li>Learn framework-specific tooling</li>
</ol>
<p>Before writing a single line of application code, they’ve already
encountered dozens of concepts unrelated to actual web development.</p>
<h3 data-number="1.4.5" id="sustainability"><span
class="header-section-number">1.4.5</span> Sustainability</h3>
<p>Build tools and frameworks change rapidly. A React application from
2015 likely needs significant updates to run today. Build configurations
break. Dependencies become unmaintained. Migration guides are
incomplete.</p>
<p>LARC applications use web standards. A LARC application from 2025
will still run in 2035 because it’s built on stable browser APIs, not
framework-specific abstractions.</p>
<p>This doesn’t mean LARC applications never need updates—APIs evolve,
best practices change. But the core architecture is built on a
foundation that changes slowly and deliberately through standards
processes.</p>
<h2 data-number="1.5" id="when-to-use-larc"><span
class="header-section-number">1.5</span> When to Use LARC</h2>
<p>LARC isn’t the right choice for every project. Understanding when to
use it (and when not to) helps you make informed decisions.</p>
<h3 data-number="1.5.1" id="larc-excels-at"><span
class="header-section-number">1.5.1</span> LARC Excels At</h3>
<p><strong>Small to Medium Applications</strong> Projects with 10-100
components where simplicity and maintainability matter more than
framework ecosystem size.</p>
<p><strong>Dashboard and Admin Panels</strong> Internal tools where the
development team controls the environment and values fast iteration.</p>
<p><strong>Progressive Web Apps</strong> Applications that benefit from
offline-first architecture and minimal JavaScript overhead.</p>
<p><strong>Learning Projects</strong> Teaching web development without
the complexity of modern toolchains.</p>
<p><strong>Embedded Widgets</strong> Reusable components that need to
work in any environment without framework dependencies.</p>
<p><strong>Prototypes and MVPs</strong> Quickly validating ideas without
upfront tooling investment.</p>
<h3 data-number="1.5.2" id="consider-alternatives-when"><span
class="header-section-number">1.5.2</span> Consider Alternatives
When</h3>
<p><strong>Very Large Teams</strong> If you have 50+ developers working
on a single codebase, framework opinions and tooling might provide
valuable guardrails.</p>
<p><strong>Heavy Framework Ecosystem Dependencies</strong> If your
project critically relies on a specific framework’s ecosystem (e.g.,
React Native integration, specific UI libraries), switching costs may be
prohibitive.</p>
<p><strong>Server-Side Rendering is Critical</strong> While LARC
supports SSR, frameworks like Next.js have more mature SSR/SSG
ecosystems.</p>
<p><strong>Team Expertise</strong> If your entire team is deeply
experienced in React/Vue/Angular and inexperienced with Web Components,
the learning curve might slow initial development.</p>
<p>That said, LARC’s simplicity often means the learning curve is
shorter than expected. Most experienced developers can become productive
with LARC in days, not weeks.</p>
<h3 data-number="1.5.3" id="hybrid-approaches"><span
class="header-section-number">1.5.3</span> Hybrid Approaches</h3>
<p>You don’t have to go all-in on LARC. Consider hybrid approaches:</p>
<p><strong>Progressive Migration</strong> Build new features in LARC
while maintaining existing framework code. Web Components can coexist
with React, Vue, or Angular.</p>
<p><strong>Micro-frontends</strong> Use LARC for some micro-frontends
and other frameworks for others. Web Components provide clean
boundaries.</p>
<p><strong>Component Libraries</strong> Build a LARC component library
that can be consumed by any framework or vanilla JavaScript.</p>
<h2 data-number="1.6" id="what-youll-build"><span
class="header-section-number">1.6</span> What You’ll Build</h2>
<p>Throughout this book, you’ll build several progressively complex
applications:</p>
<h3 data-number="1.6.1" id="chapter-examples"><span
class="header-section-number">1.6.1</span> Chapter Examples</h3>
<p>Each chapter includes focused examples demonstrating specific
concepts:</p>
<ul>
<li>A <strong>counter component</strong> (Chapter 4) to understand
component basics</li>
<li>A <strong>todo list</strong> (Chapter 5) to learn PAN bus
communication</li>
<li>A <strong>user profile form</strong> (Chapter 9) to master form
handling</li>
<li>A <strong>data table</strong> (Chapter 10) to work with APIs and
data</li>
</ul>
<h3 data-number="1.6.2" id="capstone-project-taskflow"><span
class="header-section-number">1.6.2</span> Capstone Project:
TaskFlow</h3>
<p>In the final chapters, you’ll build <strong>TaskFlow</strong>, a
complete project management application featuring:</p>
<ul>
<li>User authentication and authorization</li>
<li>Real-time collaboration via WebSockets</li>
<li>Offline-first architecture with IndexedDB</li>
<li>Drag-and-drop task boards</li>
<li>File attachments and comments</li>
<li>Search and filtering</li>
<li>Data visualization</li>
<li>Mobile-responsive design</li>
</ul>
<p>TaskFlow will demonstrate how LARC patterns scale to production
applications while remaining maintainable and performant.</p>
<h3 data-number="1.6.3" id="what-youll-learn"><span
class="header-section-number">1.6.3</span> What You’ll Learn</h3>
<p>By the end of this book, you’ll be able to:</p>
<ul>
<li>Build complex, maintainable applications using Web Components</li>
<li>Design effective component communication patterns with the PAN
bus</li>
<li>Manage application state without external frameworks</li>
<li>Integrate with backend APIs and real-time services</li>
<li>Handle routing, forms, and authentication</li>
<li>Write testable, reusable components</li>
<li>Optimize performance and bundle size</li>
<li>Deploy LARC applications to production</li>
<li>Make informed decisions about when to use LARC vs. other
approaches</li>
</ul>
<h2 data-number="1.7" id="looking-ahead"><span
class="header-section-number">1.7</span> Looking Ahead</h2>
<p>The next chapter dives into LARC’s core concepts: Web Components, the
PAN bus, and event-driven architecture. You’ll learn the fundamental
patterns that make LARC applications work.</p>
<p>But before we get technical, take a moment to consider what drew you
to this book. Perhaps you’re tired of build tool complexity. Perhaps you
want to understand how the web really works. Perhaps you’re curious
about a different approach.</p>
<p>Whatever your motivation, LARC offers something increasingly rare in
modern web development: simplicity without sacrificing capability.
You’re about to learn how to build serious web applications using the
platform itself, not abstractions on top of it.</p>
<p>Let’s begin.</p>
<hr />
<h2 data-number="1.8" id="summary"><span
class="header-section-number">1.8</span> Summary</h2>
<ul>
<li>Modern web development has become unnecessarily complex with build
tools, frameworks, and abstractions</li>
<li>The web platform has evolved to support features natively that once
required frameworks</li>
<li>LARC uses web standards (Web Components, ES Modules, Import Maps) to
build applications without build steps</li>
<li>Core principles: standards first, zero build for development,
progressive enhancement, local first</li>
<li>“No build” matters for development speed, debugging simplicity,
deployment, and sustainability</li>
<li>LARC works best for small-to-medium applications, dashboards, PWAs,
and prototypes</li>
<li>You’ll build real applications throughout this book, culminating in
a production-ready project management app</li>
</ul>
<hr />
<h2 data-number="1.9" id="further-reading"><span
class="header-section-number">1.9</span> Further Reading</h2>
<p><strong>For comprehensive reference:</strong> - <em>Building with
LARC</em> Chapter 1: Introduction - Reference manual overview and
conventions - <em>Building with LARC</em> Chapter 2: Core Concepts -
Deep dive into LARC architecture - <em>Building with LARC</em> Appendix
D: Migration Guide - Migrating from React, Vue, Angular</p>
<div class="pagebreak">

</div>
<h1 data-number="2" id="core-concepts"><span
class="header-section-number">2</span> Core Concepts</h1>
<p>Now that you understand LARC’s philosophy, let’s explore the
technical foundation that makes it work. This chapter introduces the
core concepts you’ll use throughout the book: Web Components, the PAN
bus, event-driven architecture, and the component lifecycle.</p>
<p>Don’t worry if some of these concepts are new to you. We’ll build
understanding progressively, starting with the basics and working toward
more sophisticated patterns.</p>
<h2 data-number="2.1" id="web-components-refresher"><span
class="header-section-number">2.1</span> Web Components Refresher</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/01-architecture-overview-1.png"
alt="Figure 2.1: LARC High-Level Architecture" />
<figcaption aria-hidden="true"><strong>Figure 2.1:</strong> LARC
High-Level Architecture</figcaption>
</figure>
<p>Web Components are a suite of browser APIs that let you create
custom, reusable HTML elements. Unlike framework components, Web
Components are browser standards supported natively across all modern
browsers.</p>
<h3 data-number="2.1.1" id="the-three-pillars"><span
class="header-section-number">2.1.1</span> The Three Pillars</h3>
<p>Web Components rest on three main technologies:</p>
<h4 data-number="2.1.1.1" id="custom-elements"><span
class="header-section-number">2.1.1.1</span> 1. Custom Elements</h4>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/02-component-structure-2.png"
alt="Figure 2.2: Web Component Anatomy" />
<figcaption aria-hidden="true"><strong>Figure 2.2:</strong> Web
Component Anatomy</figcaption>
</figure>
<p>Custom Elements let you define new HTML tags with custom
behavior:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a custom element</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HelloWorld <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Hello, World!&#39;</span><span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Register it</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;hello-world&#39;</span><span class="op">,</span> HelloWorld)<span class="op">;</span></span></code></pre></div>
<p>Now you can use <code>&lt;hello-world&gt;&lt;/hello-world&gt;</code>
in your HTML, and it works like any built-in element.</p>
<p><strong>Key Points:</strong></p>
<ul>
<li>Element names must contain a hyphen (e.g.,
<code>my-component</code>, not <code>mycomponent</code>)</li>
<li>Custom elements inherit from <code>HTMLElement</code> or another
HTML element</li>
<li>They have lifecycle callbacks for creation, connection, and
removal</li>
</ul>
<h4 data-number="2.1.1.2" id="shadow-dom"><span
class="header-section-number">2.1.1.2</span> 2. Shadow DOM</h4>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/02-component-structure-4.png"
alt="Figure 2.3: Shadow DOM Tree Structure" />
<figcaption aria-hidden="true"><strong>Figure 2.3:</strong> Shadow DOM
Tree Structure</figcaption>
</figure>
<p>Shadow DOM provides style and markup encapsulation:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FancyButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create shadow root</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: blue;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px 20px;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;fancy-button&#39;</span><span class="op">,</span> FancyButton)<span class="op">;</span></span></code></pre></div>
<p>The styles inside Shadow DOM don’t leak out, and external styles
don’t leak in:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This button is blue (from shadow DOM) --&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">fancy-button</span><span class="dt">&gt;</span>Click Me<span class="dt">&lt;/</span><span class="kw">fancy-button</span><span class="dt">&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This button is not affected by fancy-button&#39;s styles --&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">button</span><span class="dt">&gt;</span>Regular Button<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* This won&#39;t affect fancy-button&#39;s internal button */</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  button { <span class="kw">background</span><span class="ch">:</span> <span class="cn">red</span><span class="op">;</span> }</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Shadow DOM creates an isolated scope for styles and DOM</li>
<li>Use <code>&lt;slot&gt;</code> elements to project content from light
DOM into shadow DOM</li>
<li><code>mode: 'open'</code> makes shadow root accessible via
<code>element.shadowRoot</code></li>
</ul>
<h4 data-number="2.1.1.3" id="html-templates"><span
class="header-section-number">2.1.1.3</span> 3. HTML Templates</h4>
<p>Templates define reusable chunks of markup that aren’t rendered until
activated:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">template</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;card-template&quot;</span><span class="dt">&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.card</span> {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">border</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#ddd</span><span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">padding</span><span class="ch">:</span> <span class="dv">16</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;card&quot;</span><span class="dt">&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;title&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;content&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">template</span><span class="dt">&gt;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">class</span> SimpleCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">connectedCallback</span>() {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> template <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;card-template&#39;</span>)<span class="op">;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> clone <span class="op">=</span> template<span class="op">.</span><span class="at">content</span><span class="op">.</span><span class="fu">cloneNode</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      clone<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.title&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;title&#39;</span>)<span class="op">;</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      clone<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.content&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;content&#39;</span>)<span class="op">;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">appendChild</span>(clone)<span class="op">;</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;simple-card&#39;</span><span class="op">,</span> SimpleCard)<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Template content is inert (scripts don’t run, images don’t
load)</li>
<li>Templates can be defined in HTML or created programmatically</li>
<li>Clone template content before using it</li>
</ul>
<h3 data-number="2.1.2"
id="web-components-vs-framework-components"><span
class="header-section-number">2.1.2</span> Web Components vs Framework
Components</h3>
<p>It’s worth understanding how Web Components differ from framework
components:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Web Components</th>
<th>React Components</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Definition</strong></td>
<td>Browser standard</td>
<td>Library-specific</td>
</tr>
<tr>
<td><strong>Syntax</strong></td>
<td>JavaScript classes</td>
<td>JSX or functions</td>
</tr>
<tr>
<td><strong>Lifecycle</strong></td>
<td>Native callbacks</td>
<td>Virtual DOM lifecycle</td>
</tr>
<tr>
<td><strong>Reusability</strong></td>
<td>Works everywhere</td>
<td>Requires React</td>
</tr>
<tr>
<td><strong>Build step</strong></td>
<td>Optional</td>
<td>Required (for JSX)</td>
</tr>
<tr>
<td><strong>Encapsulation</strong></td>
<td>Shadow DOM</td>
<td>CSS Modules/CSS-in-JS</td>
</tr>
</tbody>
</table>
<p>Both approaches have their place. Web Components excel at true
reusability and standards-based development. Framework components often
provide better ergonomics within their specific ecosystem.</p>
<p>LARC chooses Web Components because they align with the “standards
first” principle.</p>
<h2 data-number="2.2" id="the-page-area-network-pan"><span
class="header-section-number">2.2</span> The Page Area Network
(PAN)</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/01-architecture-overview-2.png"
alt="Figure 2.4: Component Communication Flow" />
<figcaption aria-hidden="true"><strong>Figure 2.4:</strong> Component
Communication Flow</figcaption>
</figure>
<p>The Page Area Network, or PAN bus, is LARC’s event-driven
communication system. It’s inspired by microservices architecture but
designed for browser components.</p>
<h3 data-number="2.2.1" id="the-problem-it-solves"><span
class="header-section-number">2.2.1</span> The Problem It Solves</h3>
<p>In a traditional component tree, communication flows up and down:</p>
<pre><code>App
├── Header
│   └── UserMenu
│       └── LogoutButton
└── Content
    └── UserProfile</code></pre>
<p>If <code>LogoutButton</code> needs to notify <code>UserProfile</code>
that the user logged out, you have several options:</p>
<ol type="1">
<li><strong>Pass callbacks down</strong> through props (prop
drilling)</li>
<li><strong>Lift state up</strong> to a common ancestor</li>
<li><strong>Use context</strong> or global state</li>
<li><strong>Dispatch custom events</strong> that bubble up</li>
</ol>
<p>Each approach has tradeoffs. Prop drilling creates tight coupling.
Global state makes testing harder. Event bubbling is limited by DOM
structure.</p>
<h3 data-number="2.2.2" id="the-pan-bus-approach"><span
class="header-section-number">2.2.2</span> The PAN Bus Approach</h3>
<p>The PAN bus provides a <strong>decoupled pub/sub system</strong>:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// LogoutButton publishes an event</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.logout&#39;</span><span class="op">,</span> { <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">// UserProfile subscribes to events (anywhere in the app)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.logout&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User logged out:&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">userId</span>)<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">clearUserData</span>()<span class="op">;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Components don’t need to know about each other. They communicate
through topics (like <code>'user.logout'</code>) with no direct
coupling.</p>
<h3 data-number="2.2.3" id="topic-namespaces"><span
class="header-section-number">2.2.3</span> Topic Namespaces</h3>
<p>Topics use dot notation for organization:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;user.login&#39;</span>          <span class="co">// User logged in</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;user.logout&#39;</span>         <span class="co">// User logged out</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;user.profile.update&#39;</span> <span class="co">// Profile was updated</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;cart.item.add&#39;</span>       <span class="co">// Item added to cart</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;cart.item.remove&#39;</span>    <span class="co">// Item removed</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;cart.checkout&#39;</span>       <span class="co">// Checkout initiated</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;app.theme.change&#39;</span>    <span class="co">// Theme changed</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;app.error&#39;</span>           <span class="co">// Application error</span></span></code></pre></div>
<p>You can subscribe to specific topics or use wildcards:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Specific topic</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Wildcard (all user events)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.*&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">// All events (useful for debugging)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> handler)<span class="op">;</span></span></code></pre></div>
<h3 data-number="2.2.4" id="message-patterns"><span
class="header-section-number">2.2.4</span> Message Patterns</h3>
<p>The PAN bus supports several messaging patterns:</p>
<h4 data-number="2.2.4.1" id="fire-and-forget"><span
class="header-section-number">2.2.4.1</span> 1. Fire and Forget</h4>
<p>Most common pattern. Publish a message and continue:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.show&#39;</span><span class="op">,</span> {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;success&#39;</span><span class="op">,</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Saved successfully&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h4 data-number="2.2.4.2" id="requestresponse"><span
class="header-section-number">2.2.4.2</span> 2. Request/Response</h4>
<p>Publish a message and wait for a response:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;api.fetch&#39;</span><span class="op">,</span> {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;/api/users&#39;</span><span class="op">,</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;GET&#39;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>A subscriber handles the request and returns data:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">respond</span>(<span class="st">&#39;api.fetch&#39;</span><span class="op">,</span> <span class="kw">async</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(data<span class="op">.</span><span class="at">url</span><span class="op">,</span> { <span class="dt">method</span><span class="op">:</span> data<span class="op">.</span><span class="at">method</span> })<span class="op">;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h4 data-number="2.2.4.3" id="state-broadcast"><span
class="header-section-number">2.2.4.3</span> 3. State Broadcast</h4>
<p>Publish state changes that multiple components need:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Theme switcher publishes</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.theme.change&#39;</span><span class="op">,</span> { <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> })<span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple components subscribe</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Header <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.change&#39;</span><span class="op">,</span> ({ theme }) <span class="kw">=&gt;</span> {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sidebar <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.change&#39;</span><span class="op">,</span> ({ theme }) <span class="kw">=&gt;</span> {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="2.2.5" id="why-pan-bus"><span
class="header-section-number">2.2.5</span> Why PAN Bus?</h3>
<p>The PAN bus provides several advantages:</p>
<p><strong>Loose Coupling</strong> Components don’t need references to
each other. Add or remove components without changing others.</p>
<p><strong>Testability</strong> Test components in isolation. Mock the
bus or test actual pub/sub behavior.</p>
<p><strong>Debuggability</strong> Subscribe to <code>'*'</code> to log
all messages. Visualize message flow easily.</p>
<p><strong>Scalability</strong> Add new features by subscribing to
existing topics. No need to modify existing code.</p>
<p><strong>Flexibility</strong> Mix different communication patterns
(events, requests, broadcasts) as needed.</p>
<h2 data-number="2.3" id="event-driven-architecture"><span
class="header-section-number">2.3</span> Event-Driven Architecture</h2>
<p>LARC applications use event-driven architecture (EDA) at multiple
levels:</p>
<h3 data-number="2.3.1" id="browser-events"><span
class="header-section-number">2.3.1</span> Browser Events</h3>
<p>Standard DOM events for user interaction:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClickCounter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button id=&quot;btn&quot;&gt;Clicked </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs"> times&lt;/button&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#btn&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Clicked </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs"> times`</span><span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="2.3.2" id="custom-events"><span
class="header-section-number">2.3.2</span> Custom Events</h3>
<p>Components can dispatch custom events for parent components:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ColorPicker <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">selectColor</span>(color) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dispatch custom event</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;colorchange&#39;</span><span class="op">,</span> {</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">detail</span><span class="op">:</span> { color }<span class="op">,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">composed</span><span class="op">:</span> <span class="kw">true</span>  <span class="co">// Cross shadow DOM boundary</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Parent can listen</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;color-picker&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;colorchange&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Selected color:&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">color</span>)<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="2.3.3" id="pan-bus-events"><span
class="header-section-number">2.3.3</span> PAN Bus Events</h3>
<p>For cross-component communication:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchBox <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleInput</span>(value) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;search.query&#39;</span><span class="op">,</span> { <span class="dt">query</span><span class="op">:</span> value })<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchResults <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;search.query&#39;</span><span class="op">,</span> ({ query }) <span class="kw">=&gt;</span> {</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">search</span>(query)<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="2.3.4" id="when-to-use-each"><span
class="header-section-number">2.3.4</span> When to Use Each</h3>
<p><strong>Use DOM Events when:</strong></p>
<ul>
<li>Handling user interactions (click, input, focus, etc.)</li>
<li>Communication is parent-child relationship</li>
<li>Following HTML semantics matters</li>
</ul>
<p><strong>Use Custom Events when:</strong></p>
<ul>
<li>Component needs to notify parent/ancestors</li>
<li>Event should bubble up the DOM tree</li>
<li>Mimicking native element behavior</li>
</ul>
<p><strong>Use PAN Bus when:</strong></p>
<ul>
<li>Components are not in parent-child relationship</li>
<li>Multiple unrelated components need the same data</li>
<li>Decoupling is more important than DOM semantics</li>
<li>Building cross-cutting concerns (logging, analytics, etc.)</li>
</ul>
<h2 data-number="2.4" id="state-management-philosophy"><span
class="header-section-number">2.4</span> State Management
Philosophy</h2>
<p>LARC takes a pragmatic approach to state management: use the simplest
solution that works, then scale up if needed.</p>
<h3 data-number="2.4.1" id="state-hierarchy"><span
class="header-section-number">2.4.1</span> State Hierarchy</h3>
<p>State can exist at different levels:</p>
<h4 data-number="2.4.1.1" id="component-local-state"><span
class="header-section-number">2.4.1.1</span> 1. Component-Local
State</h4>
<p>State that only matters to one component:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoItem <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">completed</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Local state</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">toggle</span>() {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">completed</span> <span class="op">=</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">completed</span><span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">toggle</span>(<span class="st">&#39;completed&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">completed</span>)<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>When to use:</strong> UI state, temporary values,
component-specific configuration.</p>
<h4 data-number="2.4.1.2" id="shared-state"><span
class="header-section-number">2.4.1.2</span> 2. Shared State</h4>
<p>State that multiple components need:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple shared state object</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> appState <span class="op">=</span> {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">notifications</span><span class="op">:</span> []</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Components read from it</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserMenu <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(appState<span class="op">.</span><span class="at">user</span>)<span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Components write to it and notify via PAN</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateTheme</span>(theme) {</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  appState<span class="op">.</span><span class="at">theme</span> <span class="op">=</span> theme<span class="op">;</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.theme.change&#39;</span><span class="op">,</span> { theme })<span class="op">;</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>When to use:</strong> Application-wide settings, user data,
feature flags.</p>
<h4 data-number="2.4.1.3" id="persistent-state"><span
class="header-section-number">2.4.1.3</span> 3. Persistent State</h4>
<p>State that survives page reloads:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadTodos</span>() {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> saved <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;todos&#39;</span>)<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> saved <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(saved) <span class="op">:</span> []<span class="op">;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveTodos</span>(todos) {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(todos))<span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>When to use:</strong> User preferences, draft content,
offline data.</p>
<h4 data-number="2.4.1.4" id="server-state"><span
class="header-section-number">2.4.1.4</span> 4. Server State</h4>
<p>State that comes from and syncs with a server:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadProfile</span>() {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/profile&#39;</span>)<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">profile</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">saveProfile</span>(updates) {</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/profile&#39;</span><span class="op">,</span> {</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;PUT&#39;</span><span class="op">,</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(updates)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>When to use:</strong> Database records, API data, real-time
updates.</p>
<h3 data-number="2.4.2" id="reactive-state-optional"><span
class="header-section-number">2.4.2</span> Reactive State
(Optional)</h3>
<p>For more complex state needs, LARC provides reactive patterns using
JavaScript Proxies:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createStore</span>(initialState) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> listeners <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> state <span class="op">=</span> <span class="kw">new</span> <span class="bu">Proxy</span>(initialState<span class="op">,</span> {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span>(target<span class="op">,</span> property<span class="op">,</span> value) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>      target[property] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">forEach</span>(fn <span class="kw">=&gt;</span> <span class="fu">fn</span>(property<span class="op">,</span> value))<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    state<span class="op">,</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subscribe</span>(fn) {</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">add</span>(fn)<span class="op">;</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> () <span class="kw">=&gt;</span> listeners<span class="op">.</span><span class="fu">delete</span>(fn)<span class="op">;</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> store <span class="op">=</span> <span class="fu">createStore</span>({ <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span> })<span class="op">;</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to changes</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> store<span class="op">.</span><span class="fu">subscribe</span>((prop<span class="op">,</span> value) <span class="kw">=&gt;</span> {</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (prop <span class="op">===</span> <span class="st">&#39;count&#39;</span>) <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Count: </span><span class="sc">${</span>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Update state (automatically notifies subscribers)</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span></code></pre></div>
<p>This is similar to MobX or Vue’s reactivity, but built with standard
JavaScript.</p>
<h2 data-number="2.5" id="module-system"><span
class="header-section-number">2.5</span> Module System</h2>
<p>LARC uses ES Modules, the native JavaScript module system.</p>
<h3 data-number="2.5.1" id="importexport-basics"><span
class="header-section-number">2.5.1</span> Import/Export Basics</h3>
<p>Export from a module:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/button.js</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> PanButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> BUTTON_TYPES <span class="op">=</span> [<span class="st">&#39;primary&#39;</span><span class="op">,</span> <span class="st">&#39;secondary&#39;</span><span class="op">,</span> <span class="st">&#39;danger&#39;</span>]<span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> PanButton<span class="op">;</span></span></code></pre></div>
<p>Import into another module:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app.js</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> PanButton<span class="op">,</span> { BUTTON_TYPES } <span class="im">from</span> <span class="st">&#39;./components/button.js&#39;</span><span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Or import everything</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> Button <span class="im">from</span> <span class="st">&#39;./components/button.js&#39;</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="2.5.2" id="import-maps"><span
class="header-section-number">2.5.2</span> Import Maps</h3>
<p>Import Maps let you define aliases for module paths:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larcjs/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/pan.mjs&quot;</span><span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larcjs/ui&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/components@2.0.0/pan-card.mjs&quot;</span><span class="op">,</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;app/&quot;</span><span class="op">:</span> <span class="st">&quot;/src/&quot;</span><span class="op">,</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;components/&quot;</span><span class="op">:</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use aliases</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> { PanButton } <span class="im">from</span> <span class="st">&#39;@larcjs/ui&#39;</span><span class="op">;</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> { Header } <span class="im">from</span> <span class="st">&#39;components/header.js&#39;</span><span class="op">;</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>This is similar to webpack’s resolve aliases, but it’s a browser
standard.</p>
<h3 data-number="2.5.3" id="module-organization"><span
class="header-section-number">2.5.3</span> Module Organization</h3>
<p>A typical LARC project structure:</p>
<pre><code>src/
├── components/
│   ├── header.js
│   ├── footer.js
│   └── sidebar.js
├── lib/
│   ├── api.js
│   ├── auth.js
│   └── utils.js
├── pages/
│   ├── home.js
│   ├── dashboard.js
│   └── profile.js
└── app.js</code></pre>
<p>Each file is a module with clear responsibilities:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/lib/api.js</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">async</span> <span class="kw">function</span> <span class="fu">fetchJSON</span>(url<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>options<span class="op">,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>options<span class="op">.</span><span class="at">headers</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`API error: </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">// src/components/user-list.js</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { fetchJSON } <span class="im">from</span> <span class="st">&#39;../lib/api.js&#39;</span><span class="op">;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> UserList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetchJSON</span>(<span class="st">&#39;/api/users&#39;</span>)<span class="op">;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(users)<span class="op">;</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-list&#39;</span><span class="op">,</span> UserList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="2.6" id="the-component-lifecycle"><span
class="header-section-number">2.6</span> The Component Lifecycle</h2>
<p>Understanding the component lifecycle is essential for building
robust LARC applications.</p>
<h3 data-number="2.6.1" id="lifecycle-callbacks"><span
class="header-section-number">2.6.1</span> Lifecycle Callbacks</h3>
<p>Web Components provide several lifecycle callbacks:</p>
<h4 data-number="2.6.1.1" id="constructor"><span
class="header-section-number">2.6.1.1</span> constructor()</h4>
<p>Called when an instance is created:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MUST call super() first</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize instance properties</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach shadow DOM if needed</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// DON&#39;T access attributes or children here</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// They might not be set yet</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Best practices:</strong></p>
<ul>
<li>Always call <code>super()</code> first</li>
<li>Initialize instance properties</li>
<li>Attach shadow DOM</li>
<li>Don’t access attributes, children, or parent elements</li>
<li>Don’t render here (use <code>connectedCallback</code> instead)</li>
</ul>
<h4 data-number="2.6.1.2" id="connectedcallback"><span
class="header-section-number">2.6.1.2</span> connectedCallback()</h4>
<p>Called when the element is inserted into the DOM:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Now it&#39;s safe to access attributes, children, parent</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;title&#39;</span>)<span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Render initial content</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add event listeners</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fetch data</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Subscribe to PAN events</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.update&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleUpdate</span>)<span class="op">;</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Best practices:</strong></p>
<ul>
<li>Render initial content</li>
<li>Add event listeners</li>
<li>Subscribe to events</li>
<li>Fetch initial data</li>
<li>Can be called multiple times if element is moved</li>
</ul>
<h4 data-number="2.6.1.3" id="disconnectedcallback"><span
class="header-section-number">2.6.1.3</span> disconnectedCallback()</h4>
<p>Called when the element is removed from the DOM:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">disconnectedCallback</span>() {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Clean up event listeners</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Unsubscribe from PAN events</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) {</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Cancel pending operations</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span>) {</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Clear timers</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">timer</span>) {</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">timer</span>)<span class="op">;</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Best practices:</strong></p>
<ul>
<li>Remove event listeners to prevent memory leaks</li>
<li>Unsubscribe from PAN events</li>
<li>Cancel pending async operations</li>
<li>Clear timers and intervals</li>
</ul>
<h4 data-number="2.6.1.4"
id="attributechangedcallbackname-oldvalue-newvalue"><span
class="header-section-number">2.6.1.4</span>
attributeChangedCallback(name, oldValue, newValue)</h4>
<p>Called when observed attributes change:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;count&#39;</span><span class="op">,</span> <span class="st">&#39;active&#39;</span>]<span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Called for each observed attribute that changes</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;title&#39;</span>) {</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateTitle</span>(newValue)<span class="op">;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;count&#39;</span>) {</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateCount</span>(<span class="bu">Number</span>(newValue))<span class="op">;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;active&#39;</span>) {</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateActive</span>(newValue <span class="op">!==</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Best practices:</strong></p>
<ul>
<li>Only observe attributes you actually use</li>
<li>Convert string values to appropriate types</li>
<li>Handle null/undefined values</li>
<li>Update only what changed (don’t re-render everything)</li>
</ul>
<h4 data-number="2.6.1.5" id="adoptedcallback"><span
class="header-section-number">2.6.1.5</span> adoptedCallback()</h4>
<p>Called when the element is moved to a new document (rare):</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">adoptedCallback</span>() {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Usually not needed</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Called when element is moved between documents</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (e.g., iframe scenarios)</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="2.6.2" id="complete-lifecycle-example"><span
class="header-section-number">2.6.2</span> Complete Lifecycle
Example</h3>
<p>Here’s a full component showing proper lifecycle management:</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataTable <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define which attributes to observe</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&#39;url&#39;</span><span class="op">,</span> <span class="st">&#39;page-size&#39;</span>]<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize state</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pageSize</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentPage</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initial render</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load data if URL is set</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;url&#39;</span>)<span class="op">;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (url) {</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>(url)<span class="op">;</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to events</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribePan</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;table.refresh&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set up event listeners</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;page-change&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handlePageChange</span>)<span class="op">;</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up subscriptions</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribePan</span>) {</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribePan</span>()<span class="op">;</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove event listeners</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;page-change&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handlePageChange</span>)<span class="op">;</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cancel pending fetch</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span>) {</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (oldValue <span class="op">===</span> newValue) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;url&#39;</span> <span class="op">&amp;&amp;</span> newValue) {</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>(newValue)<span class="op">;</span></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;page-size&#39;</span>) {</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pageSize</span> <span class="op">=</span> <span class="bu">Number</span>(newValue) <span class="op">||</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadData</span>(url) {</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cancel previous fetch if any</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span>) {</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> {</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">signal</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">fetchController</span><span class="op">.</span><span class="at">signal</span></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;AbortError&#39;</span>) {</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load data:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render logic here</span></span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a><span class="vs">        table { width: 100%; border-collapse: collapse; }</span></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }</span></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;table&gt;</span></span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;thead&gt;</span></span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Status&lt;/th&gt;&lt;/tr&gt;</span></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/thead&gt;</span></span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;tbody&gt;</span></span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;tr&gt;</span></span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;td&gt;</span><span class="sc">${</span>row<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;td&gt;</span><span class="sc">${</span>row<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;td&gt;</span><span class="sc">${</span>row<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/tr&gt;</span></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/tbody&gt;</span></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/table&gt;</span></span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>  handlePageChange <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentPage</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">page</span><span class="op">;</span></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">refresh</span>() {</span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;url&#39;</span>)<span class="op">;</span></span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (url) {</span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>(url)<span class="op">;</span></span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;data-table&#39;</span><span class="op">,</span> DataTable)<span class="op">;</span></span></code></pre></div>
<h2 data-number="2.7" id="summary-1"><span
class="header-section-number">2.7</span> Summary</h2>
<p>This chapter introduced LARC’s core concepts:</p>
<ul>
<li><strong>Web Components</strong> provide standard, reusable elements
with Custom Elements, Shadow DOM, and Templates</li>
<li><strong>The PAN Bus</strong> enables decoupled pub/sub communication
between components</li>
<li><strong>Event-Driven Architecture</strong> uses DOM events, custom
events, and PAN messages for different scenarios</li>
<li><strong>State Management</strong> starts simple (local state) and
scales to shared, persistent, and server state</li>
<li><strong>ES Modules</strong> organize code with standard
imports/exports and import maps</li>
<li><strong>Component Lifecycle</strong> provides callbacks for
creation, connection, attribute changes, and cleanup</li>
</ul>
<p>In the next chapter, we’ll put these concepts into practice by
setting up a development environment and building your first LARC
application.</p>
<hr />
<h2 data-number="2.8" id="key-takeaways"><span
class="header-section-number">2.8</span> Key Takeaways</h2>
<ul>
<li>Web Components are browser standards, not framework
abstractions</li>
<li>Shadow DOM provides true style encapsulation</li>
<li>The PAN bus decouples components through pub/sub messaging</li>
<li>Use the simplest state management that works, then scale up</li>
<li>ES Modules and Import Maps replace build-time bundling</li>
<li>Proper lifecycle management prevents bugs and memory leaks</li>
<li>Components should be self-contained but composable</li>
</ul>
<hr />
<h2 data-number="2.9" id="further-reading-1"><span
class="header-section-number">2.9</span> Further Reading</h2>
<p><strong>For detailed technical reference:</strong> - <em>Building
with LARC</em> Chapter 2: Core Concepts - Architecture patterns and
message flow reference - <em>Building with LARC</em> Appendix A: Message
Topics Reference - Standard topic conventions - <em>Building with
LARC</em> Appendix B: Event Envelope Specification - Message format
details - <em>Building with LARC</em> Appendix F: Glossary - Technical
terminology reference</p>
<div class="pagebreak">

</div>
<h1 data-number="3" id="getting-started"><span
class="header-section-number">3</span> Getting Started</h1>
<p>Theory is important, but there’s no substitute for hands-on
experience. In this chapter, you’ll set up your development environment
and build your first LARC application. By the end, you’ll have a working
project and understand the basic development workflow.</p>
<h2 data-number="3.1" id="setting-up-your-development-environment"><span
class="header-section-number">3.1</span> Setting Up Your Development
Environment</h2>
<p>One of LARC’s strengths is minimal setup requirements. You don’t need
complex tooling or configuration—just a browser, a text editor, and a
way to serve files.</p>
<h3 data-number="3.1.1" id="requirements"><span
class="header-section-number">3.1.1</span> Requirements</h3>
<p><strong>Essential:</strong></p>
<ul>
<li><strong>Modern browser</strong> — Chrome, Firefox, Safari, or Edge
(latest version)</li>
<li><strong>Text editor</strong> — VS Code, Sublime Text, Atom, or any
editor you prefer</li>
<li><strong>Local web server</strong> — Python’s SimpleHTTPServer,
Node’s <code>http-server</code>, or VS Code’s Live Server extension</li>
</ul>
<p><strong>Optional but Recommended:</strong></p>
<ul>
<li><strong>VS Code</strong> with the LARC extension for snippets and
IntelliSense</li>
<li><strong>Browser DevTools</strong> familiarity for debugging</li>
<li><strong>Git</strong> for version control</li>
</ul>
<h3 data-number="3.1.2" id="quick-start-with-create-larc-app"><span
class="header-section-number">3.1.2</span> Quick Start with
create-larc-app</h3>
<p>The fastest way to start is using the LARC CLI:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install globally</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-g</span> create-larc-app</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new project</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="ex">create-larc-app</span> my-first-app</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Start development server</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> my-first-app</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="ex">larc</span> dev</span></code></pre></div>
<p>Open <code>http://localhost:3000</code> and you’ll see your new LARC
application running.</p>
<h3 data-number="3.1.3" id="manual-setup-no-cli"><span
class="header-section-number">3.1.3</span> Manual Setup (No CLI)</h3>
<p>Don’t want to install Node.js? You can set up a LARC project
manually:</p>
<p><strong>1. Create project structure:</strong></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> my-first-app</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> my-first-app</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> src</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> src/components</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> public</span></code></pre></div>
<p><strong>2. Create <code>index.html</code>:</strong></p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">&quot;en&quot;</span><span class="dt">&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">&quot;UTF-8&quot;</span><span class="dt">&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="dt">&gt;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>My First LARC App<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Import Map for dependencies --&gt;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larcjs/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/pan.mjs&quot;</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    body {</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">font-family</span><span class="ch">:</span> <span class="dv">system-ui</span><span class="op">,</span> <span class="dv">-apple-system</span><span class="op">,</span> <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">padding</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">background</span><span class="ch">:</span> <span class="cn">#f5f5f5</span><span class="op">;</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;src/app.js&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>3. Create <code>src/app.js</code>:</strong></p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Import your components</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/hello-world.js&#39;</span><span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize app</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;LARC app initialized&#39;</span>)<span class="op">;</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.ready&#39;</span>)<span class="op">;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Add component to page</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;hello-world&gt;&lt;/hello-world&gt;&#39;</span><span class="op">;</span></span></code></pre></div>
<p><strong>4. Create
<code>src/components/hello-world.js</code>:</strong></p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HelloWorld <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: white;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 40px;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 8px;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        box-shadow: 0 2px 8px rgba(0,0,0,0.1);</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="vs">        text-align: center;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &quot;&gt;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h1&gt;Hello, LARC!&lt;/h1&gt;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Welcome to your first LARC application.&lt;/p&gt;</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;hello-world&#39;</span><span class="op">,</span> HelloWorld)<span class="op">;</span></span></code></pre></div>
<p><strong>5. Serve the files:</strong></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python 3</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> http.server 3000</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or Python 2</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> SimpleHTTPServer 3000</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Or with Node.js</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> http-server <span class="at">-p</span> 3000</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Or use VS Code Live Server extension</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (right-click index.html → &quot;Open with Live Server&quot;)</span></span></code></pre></div>
<p>Open <code>http://localhost:3000</code> and you should see “Hello,
LARC!” displayed.</p>
<p><strong>That’s it.</strong> No build step. No transpilation. No
bundling. Just HTML, CSS, and JavaScript.</p>
<h3 data-number="3.1.4" id="development-tools"><span
class="header-section-number">3.1.4</span> Development Tools</h3>
<h4 data-number="3.1.4.1" id="vs-code-extensions"><span
class="header-section-number">3.1.4.1</span> VS Code Extensions</h4>
<p>Install these extensions for the best experience:</p>
<p><strong>LARC Extension:</strong></p>
<ul>
<li>Snippets for components and PAN patterns</li>
<li>IntelliSense for LARC APIs</li>
<li>Commands for creating components</li>
</ul>
<p>Install: Search “LARC” in VS Code extensions marketplace</p>
<p><strong>Live Server:</strong></p>
<ul>
<li>Auto-reload when files change</li>
<li>Simple local web server</li>
<li>Right-click HTML file to start</li>
</ul>
<p>Install: Search “Live Server” by Ritwick Dey</p>
<p><strong>ES6 String HTML:</strong></p>
<ul>
<li>Syntax highlighting for template literals</li>
<li>Makes component templates more readable</li>
</ul>
<p>Install: Search “ES6 String HTML”</p>
<h4 data-number="3.1.4.2" id="browser-devtools"><span
class="header-section-number">3.1.4.2</span> Browser DevTools</h4>
<p>Learn these DevTools features for LARC development:</p>
<p><strong>Elements Panel:</strong></p>
<pre><code>- Inspect shadow DOM (enable &quot;Show user agent shadow DOM&quot; in settings)
- View Custom Elements with their properties
- Debug CSS in shadow roots</code></pre>
<p><strong>Console:</strong></p>
<pre><code>- Subscribe to all PAN messages: `pan.subscribe(&#39;*&#39;, console.log)`
- Test components directly: `document.querySelector(&#39;my-component&#39;)`
- Check Custom Elements registry: `customElements.get(&#39;my-component&#39;)`</code></pre>
<p><strong>Network Panel:</strong></p>
<pre><code>- Verify ES modules load correctly
- Check import map resolution
- Monitor API calls</code></pre>
<p><strong>Sources Panel:</strong></p>
<pre><code>- Set breakpoints in your source code (no source maps needed!)
- Step through component lifecycle
- Watch variables and state</code></pre>
<h2 data-number="3.2" id="your-first-larc-application"><span
class="header-section-number">3.2</span> Your First LARC
Application</h2>
<p>Let’s build something more interesting than “Hello World”—a simple
counter application with multiple components communicating via the PAN
bus.</p>
<h3 data-number="3.2.1" id="project-goal"><span
class="header-section-number">3.2.1</span> Project Goal</h3>
<p>We’ll create:</p>
<pre><code>- A counter display component
- Increment and decrement buttons
- A reset button
- Communication via PAN bus (no prop drilling!)</code></pre>
<h3 data-number="3.2.2" id="step-1-update-index.html"><span
class="header-section-number">3.2.2</span> Step 1: Update
index.html</h3>
<div class="sourceCode" id="cb51"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">&quot;en&quot;</span><span class="dt">&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">&quot;UTF-8&quot;</span><span class="dt">&gt;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="dt">&gt;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Counter App - LARC<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larcjs/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/pan.mjs&quot;</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> {</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">padding</span><span class="ch">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">box-sizing</span><span class="ch">:</span> <span class="dv">border-box</span><span class="op">;</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    body {</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">font-family</span><span class="ch">:</span> <span class="dv">-apple-system</span><span class="op">,</span> <span class="dv">BlinkMacSystemFont</span><span class="op">,</span> <span class="st">&#39;Segoe UI&#39;</span><span class="op">,</span> <span class="dv">Roboto</span><span class="op">,</span> <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">background</span><span class="ch">:</span> <span class="fu">linear-gradient(</span><span class="dv">135</span><span class="dt">deg</span><span class="op">,</span> <span class="cn">#667eea</span> <span class="dv">0</span><span class="dt">%</span><span class="op">,</span> <span class="cn">#764ba2</span> <span class="dv">100</span><span class="dt">%</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">min-height</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">vh</span><span class="op">;</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#app</span> {</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">background</span><span class="ch">:</span> <span class="cn">white</span><span class="op">;</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">padding</span><span class="ch">:</span> <span class="dv">40</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">16</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">box-shadow</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">20</span><span class="dt">px</span> <span class="dv">60</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0.3</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">min-width</span><span class="ch">:</span> <span class="dv">400</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="dt">&gt;</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">counter-display</span><span class="dt">&gt;&lt;/</span><span class="kw">counter-display</span><span class="dt">&gt;</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">counter-controls</span><span class="dt">&gt;&lt;/</span><span class="kw">counter-controls</span><span class="dt">&gt;</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;src/app.js&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="3.2.3" id="step-2-create-app.js"><span
class="header-section-number">3.2.3</span> Step 2: Create app.js</h3>
<div class="sourceCode" id="cb52"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/app.js</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Import components</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/counter-display.js&#39;</span><span class="op">;</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/counter-controls.js&#39;</span><span class="op">;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize application state</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for increment requests</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;counter.increment&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  count<span class="op">++;</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> { count })<span class="op">;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for decrement requests</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;counter.decrement&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  count<span class="op">--;</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> { count })<span class="op">;</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Listen for reset requests</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;counter.reset&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> { count })<span class="op">;</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Publish initial state</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> { count })<span class="op">;</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Counter app initialized&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.2.4" id="step-3-create-counter-display.js"><span
class="header-section-number">3.2.4</span> Step 3: Create
counter-display.js</h3>
<div class="sourceCode" id="cb53"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/components/counter-display.js</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CounterDisplay <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to count updates</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> ({ count }) <span class="kw">=&gt;</span> {</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> count<span class="op">;</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 30px;</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        .display {</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 72px;</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #667eea;</span></span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 10px;</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-variant-numeric: tabular-nums;</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        .label {</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 18px;</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-transform: uppercase;</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a><span class="vs">          letter-spacing: 2px;</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;display&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;label&quot;&gt;Current Count&lt;/div&gt;</span></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;counter-display&#39;</span><span class="op">,</span> CounterDisplay)<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.2.5" id="step-4-create-counter-controls.js"><span
class="header-section-number">3.2.5</span> Step 4: Create
counter-controls.js</h3>
<div class="sourceCode" id="cb54"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/components/counter-controls.js</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CounterControls <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachEventListeners</span>()<span class="op">;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attachEventListeners</span>() {</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#increment&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.increment&#39;</span>)<span class="op">;</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#decrement&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.decrement&#39;</span>)<span class="op">;</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#reset&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.reset&#39;</span>)<span class="op">;</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        .controls {</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 10px;</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 15px;</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 15px;</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 16px;</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: all 0.2s;</span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          transform: translateY(-2px);</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:active {</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          transform: translateY(0);</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="vs">        #increment {</span></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #48bb78;</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="vs">        #increment:hover {</span></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #38a169;</span></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a><span class="vs">        #decrement {</span></span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f56565;</span></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a><span class="vs">        #decrement:hover {</span></span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #e53e3e;</span></span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a><span class="vs">        #reset {</span></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #4a5568;</span></span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a><span class="vs">        #reset:hover {</span></span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #2d3748;</span></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;controls&quot;&gt;</span></span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;decrement&quot;&gt;− Decrement&lt;/button&gt;</span></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;increment&quot;&gt;+ Increment&lt;/button&gt;</span></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button id=&quot;reset&quot;&gt;Reset&lt;/button&gt;</span></span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;counter-controls&#39;</span><span class="op">,</span> CounterControls)<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.2.6" id="step-5-test-your-app"><span
class="header-section-number">3.2.6</span> Step 5: Test Your App</h3>
<p>Start your local server and open the page. You should see:</p>
<pre><code>- A large counter display showing &quot;0&quot;
- Increment and decrement buttons
- A reset button</code></pre>
<p>Click the buttons. Notice how:</p>
<pre><code>- Components update immediately
- State is managed centrally in `app.js`
- Components don&#39;t reference each other directly
- Adding new components is trivial (just subscribe to `counter.updated`)</code></pre>
<h3 data-number="3.2.7" id="what-just-happened"><span
class="header-section-number">3.2.7</span> What Just Happened?</h3>
<p>Let’s examine the architecture:</p>
<p><strong>Data Flow:</strong></p>
<pre><code>User clicks button
     ↓
Controls component publishes event
     ↓
App.js receives event and updates state
     ↓
App.js publishes updated state
     ↓
Display component receives update and re-renders</code></pre>
<p><strong>Key Points:</strong></p>
<ol type="1">
<li><strong>Decoupled Components:</strong> Display and controls don’t
know about each other</li>
<li><strong>Central State:</strong> State lives in <code>app.js</code>,
not in components</li>
<li><strong>Pub/Sub Communication:</strong> All communication via PAN
bus topics</li>
<li><strong>No Props:</strong> No prop drilling or lifting state up</li>
<li><strong>Easy Testing:</strong> Each component can be tested in
isolation</li>
</ol>
<h2 data-number="3.3" id="project-structure"><span
class="header-section-number">3.3</span> Project Structure</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/01-architecture-overview-5.png"
alt="Figure 3.1: LARC Deployment Architecture" />
<figcaption aria-hidden="true"><strong>Figure 3.1:</strong> LARC
Deployment Architecture</figcaption>
</figure>
<p>As your application grows, organization becomes important. Here’s a
recommended structure:</p>
<pre><code>my-app/
├── index.html              # Entry point
├── larc.config.json        # Optional config
├── src/
│   ├── app.js              # Main application logic
│   ├── components/         # Reusable components
│   │   ├── ui/             # Generic UI components
│   │   │   ├── button.js
│   │   │   ├── card.js
│   │   │   └── modal.js
│   │   ├── features/       # Feature-specific components
│   │   │   ├── user-profile.js
│   │   │   ├── todo-list.js
│   │   │   └── dashboard.js
│   │   └── layout/         # Layout components
│   │       ├── header.js
│   │       ├── sidebar.js
│   │       └── footer.js
│   ├── lib/                # Utilities and helpers
│   │   ├── api.js          # API client
│   │   ├── auth.js         # Authentication
│   │   ├── router.js       # Routing logic
│   │   └── utils.js        # General utilities
│   ├── pages/              # Page-level components
│   │   ├── home.js
│   │   ├── dashboard.js
│   │   └── settings.js
│   └── styles/             # Global styles
│       ├── reset.css
│       ├── variables.css
│       └── utilities.css
├── public/                 # Static assets
│   ├── images/
│   ├── fonts/
│   └── icons/
└── tests/                  # Test files
    ├── components/
    └── integration/</code></pre>
<h3 data-number="3.3.1" id="file-organization-principles"><span
class="header-section-number">3.3.1</span> File Organization
Principles</h3>
<p><strong>Components:</strong></p>
<pre><code>- One component per file
- File name matches component name: `user-profile.js` defines `&lt;user-profile&gt;`
- Keep related components together in subdirectories</code></pre>
<p><strong>Lib:</strong></p>
<pre><code>- Utilities that don&#39;t render UI
- API clients, helpers, formatters
- Pure functions when possible</code></pre>
<p><strong>Pages:</strong></p>
<pre><code>- Top-level route components
- Compose smaller components
- Handle page-specific logic</code></pre>
<p><strong>Styles:</strong></p>
<pre><code>- Global styles in `styles/`
- Component-specific styles in Shadow DOM
- CSS custom properties for theming</code></pre>
<h2 data-number="3.4" id="import-maps-explained"><span
class="header-section-number">3.4</span> Import Maps Explained</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/01-architecture-overview-4.png"
alt="Figure 3.2: Module Loading with Import Maps" />
<figcaption aria-hidden="true"><strong>Figure 3.2:</strong> Module
Loading with Import Maps</figcaption>
</figure>
<p>Import Maps are a browser standard that replaces the need for
bundlers to resolve module paths.</p>
<h3 data-number="3.4.1" id="basic-import-map"><span
class="header-section-number">3.4.1</span> Basic Import Map</h3>
<div class="sourceCode" id="cb63"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;lodash&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/lodash-es@4/lodash.js&quot;</span><span class="op">,</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dayjs&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js&quot;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use package names instead of URLs</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> _ <span class="im">from</span> <span class="st">&#39;lodash&#39;</span><span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> dayjs <span class="im">from</span> <span class="st">&#39;dayjs&#39;</span><span class="op">;</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">dayjs</span>()<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-DD&#39;</span>))<span class="op">;</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="3.4.2" id="path-aliases"><span
class="header-section-number">3.4.2</span> Path Aliases</h3>
<p>Create shortcuts for your own modules:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@/&quot;</span><span class="op">:</span> <span class="st">&quot;/src/&quot;</span><span class="op">,</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;components/&quot;</span><span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;lib/&quot;</span><span class="op">:</span> <span class="st">&quot;/src/lib/&quot;</span><span class="op">,</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@larcjs/core&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/pan.mjs&quot;</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Instead of: import { api } from &#39;../../../lib/api.js&#39;;</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> { api } <span class="im">from</span> <span class="st">&#39;lib/api.js&#39;</span><span class="op">;</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Instead of: import Button from &#39;../components/ui/button.js&#39;;</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> Button <span class="im">from</span> <span class="st">&#39;components/ui/button.js&#39;</span><span class="op">;</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Instead of: import something from &#39;../../../src/utils.js&#39;;</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> something <span class="im">from</span> <span class="st">&#39;@/utils.js&#39;</span><span class="op">;</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="3.4.3" id="version-management"><span
class="header-section-number">3.4.3</span> Version Management</h3>
<p>Pin dependencies to specific versions:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;imports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/core&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/dist/index.js&quot;</span><span class="fu">,</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/ui&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/ui@2.0.1/dist/index.js&quot;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Or use version ranges for automatic updates:</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;imports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/core&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/pan.mjs&quot;</span><span class="fu">,</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/ui&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/ui@2/dist/index.js&quot;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="3.4.4" id="multiple-cdns"><span
class="header-section-number">3.4.4</span> Multiple CDNs</h3>
<p>Add fallbacks for reliability:</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;imports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;react&quot;</span><span class="fu">:</span> <span class="st">&quot;https://esm.sh/react@18&quot;</span><span class="fu">,</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;react-fallback&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.skypack.dev/react@18&quot;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Then in code:</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> React<span class="op">;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  React <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;react&#39;</span>)<span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">catch</span> {</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  React <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;react-fallback&#39;</span>)<span class="op">;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="3.4.5" id="development-vs-production"><span
class="header-section-number">3.4.5</span> Development vs
Production</h3>
<p>Use different import maps for different environments:</p>
<p><strong>development.importmap.json:</strong></p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;imports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/core&quot;</span><span class="fu">:</span> <span class="st">&quot;/node_modules/@larcjs/core/dist/index.js&quot;</span><span class="fu">,</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;app/&quot;</span><span class="fu">:</span> <span class="st">&quot;/src/&quot;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>production.importmap.json:</strong></p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;imports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@larcjs/core&quot;</span><span class="fu">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/dist/index.js&quot;</span><span class="fu">,</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;app/&quot;</span><span class="fu">:</span> <span class="st">&quot;/assets/js/&quot;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Load the appropriate map:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;/config/production.importmap.json&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="3.5" id="development-workflow"><span
class="header-section-number">3.5</span> Development Workflow</h2>
<h3 data-number="3.5.1" id="daily-development"><span
class="header-section-number">3.5.1</span> Daily Development</h3>
<p>A typical development session:</p>
<p><strong>1. Start dev server:</strong></p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="ex">larc</span> dev</span></code></pre></div>
<p>This starts a local server with hot reload.</p>
<p><strong>2. Edit files:</strong> Open your editor and make changes.
The browser automatically reloads when you save.</p>
<p><strong>3. Check the console:</strong> Open browser DevTools and
check for errors or warnings.</p>
<p><strong>4. Test in browser:</strong> Interact with your app, verify
behavior, check responsive design.</p>
<p><strong>5. Debug as needed:</strong> Set breakpoints, inspect
elements, monitor network requests.</p>
<p><strong>6. Repeat:</strong> The edit-refresh cycle is instant with no
build step.</p>
<h3 data-number="3.5.2" id="debugging-tips"><span
class="header-section-number">3.5.2</span> Debugging Tips</h3>
<p><strong>Log all PAN messages:</strong></p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[PAN] </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Inspect custom elements:</strong></p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get element</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> el <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;my-component&#39;</span>)<span class="op">;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Check if defined</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(customElements<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;my-component&#39;</span>))<span class="op">;</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Access shadow root</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(el<span class="op">.</span><span class="at">shadowRoot</span>)<span class="op">;</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Call methods directly</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>el<span class="op">.</span><span class="fu">someMethod</span>()<span class="op">;</span></span></code></pre></div>
<p><strong>Monitor attribute changes:</strong></p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create observer</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="bu">MutationObserver</span>((mutations) <span class="kw">=&gt;</span> {</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  mutations<span class="op">.</span><span class="fu">forEach</span>(mutation <span class="kw">=&gt;</span> {</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Attribute changed:&#39;</span><span class="op">,</span> mutation<span class="op">.</span><span class="at">attributeName</span>)<span class="op">;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Watch element</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>observer<span class="op">.</span><span class="fu">observe</span>(element<span class="op">,</span> { <span class="dt">attributes</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span></code></pre></div>
<h3 data-number="3.5.3" id="testing"><span
class="header-section-number">3.5.3</span> Testing</h3>
<p>Run tests without a build step:</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- tests/counter.test.html --&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Counter Tests<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;@larcjs/core&quot;</span><span class="op">:</span> <span class="st">&quot;../node_modules/@larcjs/core/dist/index.js&quot;</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;test-container&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="st">&#39;../counter-display.js&#39;</span><span class="op">;</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple test framework</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">test</span>(name<span class="op">,</span> fn) {</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fn</span>()<span class="op">;</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`✓ </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`✗ </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">assert</span>(condition<span class="op">,</span> message) {</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>condition) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(message <span class="op">||</span> <span class="st">&#39;Assertion failed&#39;</span>)<span class="op">;</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Tests</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test</span>(<span class="st">&#39;counter-display renders initial count&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> el <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;counter-display&#39;</span>)<span class="op">;</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;test-container&#39;</span>)<span class="op">.</span><span class="fu">appendChild</span>(el)<span class="op">;</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> display <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.display&#39;</span>)<span class="op">;</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">assert</span>(display<span class="op">.</span><span class="at">textContent</span> <span class="op">===</span> <span class="st">&#39;0&#39;</span><span class="op">,</span> <span class="st">&#39;Initial count should be 0&#39;</span>)<span class="op">;</span></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test</span>(<span class="st">&#39;counter-display updates on PAN message&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> el <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;counter-display&#39;</span>)<span class="op">;</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;test-container&#39;</span>)<span class="op">.</span><span class="fu">appendChild</span>(el)<span class="op">;</span></span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait for component to connect</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Publish update</span></span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> { <span class="dt">count</span><span class="op">:</span> <span class="dv">42</span> })<span class="op">;</span></span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait for render</span></span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> display <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.display&#39;</span>)<span class="op">;</span></span>
<span id="cb76-60"><a href="#cb76-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">assert</span>(display<span class="op">.</span><span class="at">textContent</span> <span class="op">===</span> <span class="st">&#39;42&#39;</span><span class="op">,</span> <span class="st">&#39;Count should update to 42&#39;</span>)<span class="op">;</span></span>
<span id="cb76-61"><a href="#cb76-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-62"><a href="#cb76-62" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb76-63"><a href="#cb76-63" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb76-64"><a href="#cb76-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-65"><a href="#cb76-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;All tests complete&#39;</span>)<span class="op">;</span></span>
<span id="cb76-66"><a href="#cb76-66" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb76-67"><a href="#cb76-67" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb76-68"><a href="#cb76-68" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Open <code>tests/counter.test.html</code> in your browser to run
tests.</p>
<h2 data-number="3.6" id="common-patterns"><span
class="header-section-number">3.6</span> Common Patterns</h2>
<h3 data-number="3.6.1" id="pattern-1-loading-states"><span
class="header-section-number">3.6.1</span> Pattern 1: Loading
States</h3>
<div class="sourceCode" id="cb77"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ <span class="dt">loading</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchData</span>()<span class="op">;</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ data })<span class="op">;</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(state) {</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (state<span class="op">.</span><span class="at">loading</span>) {</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;loading-spinner&gt;&lt;/loading-spinner&gt;&#39;</span><span class="op">;</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (state<span class="op">.</span><span class="at">error</span>) {</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;error-message&gt;</span><span class="sc">${</span>state<span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/error-message&gt;`</span><span class="op">;</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;data-display .data=&quot;</span><span class="sc">${</span>state<span class="op">.</span><span class="at">data</span><span class="sc">}</span><span class="vs">&quot;&gt;&lt;/data-display&gt;`</span><span class="op">;</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="3.6.2" id="pattern-2-form-handling"><span
class="header-section-number">3.6.2</span> Pattern 2: Form Handling</h3>
<div class="sourceCode" id="cb78"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;email&quot; name=&quot;email&quot; required&gt;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;password&quot; name=&quot;password&quot; required&gt;</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot;&gt;Login&lt;/button&gt;</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(e<span class="op">.</span><span class="at">target</span>)<span class="op">;</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(formData)<span class="op">;</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.login&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="3.6.3" id="pattern-3-conditional-rendering"><span
class="header-section-number">3.6.3</span> Pattern 3: Conditional
Rendering</h3>
<div class="sourceCode" id="cb79"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserMenu <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;auth.user.changed&#39;</span><span class="op">,</span> ({ user }) <span class="kw">=&gt;</span> {</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">user</span>) {</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;logged-in&quot;&gt;</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span&gt;Hello, </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button id=&quot;logout&quot;&gt;Logout&lt;/button&gt;</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#logout&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.logout&#39;</span>)<span class="op">;</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;login&quot;&gt;Login&lt;/button&gt;</span></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#login&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="3.6.4" id="pattern-4-lists-and-iteration"><span
class="header-section-number">3.6.4</span> Pattern 4: Lists and
Iteration</h3>
<div class="sourceCode" id="cb80"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;todos.updated&#39;</span><span class="op">,</span> ({ todos }) <span class="kw">=&gt;</span> {</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> todos<span class="op">;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;ul&gt;</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">map</span>(todo <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;li&gt;</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;checkbox&quot;</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="vs">                   </span><span class="sc">${</span>todo<span class="op">.</span><span class="at">completed</span> <span class="op">?</span> <span class="st">&#39;checked&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a><span class="vs">                   data-id=&quot;</span><span class="sc">${</span>todo<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;</span><span class="sc">${</span>todo<span class="op">.</span><span class="at">completed</span> <span class="op">?</span> <span class="st">&#39;completed&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="vs">              </span><span class="sc">${</span>todo<span class="op">.</span><span class="at">text</span><span class="sc">}</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/span&gt;</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/li&gt;</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/ul&gt;</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach event listeners after rendering</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;input[type=&quot;checkbox&quot;]&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(checkbox <span class="kw">=&gt;</span> {</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>      checkbox<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> id <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;todos.toggle&#39;</span><span class="op">,</span> { id })<span class="op">;</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="3.7" id="summary-2"><span
class="header-section-number">3.7</span> Summary</h2>
<p>In this chapter, you:</p>
<pre><code>- Set up a LARC development environment (CLI or manual)
- Built your first multi-component application
- Learned project structure best practices
- Mastered Import Maps for dependency management
- Established an efficient development workflow
- Explored common component patterns</code></pre>
<p>You now have a solid foundation for building LARC applications. The
next chapter dives deeper into creating sophisticated Web Components
with proper lifecycle management, styling, and interactivity.</p>
<hr />
<h2 data-number="3.8" id="exercises"><span
class="header-section-number">3.8</span> Exercises</h2>
<p><strong>1. Enhance the Counter App:</strong></p>
<pre><code>- Add a history component that shows past values
- Add increment/decrement by custom amounts
- Persist count to localStorage</code></pre>
<p><strong>2. Build a Todo List:</strong></p>
<pre><code>- Add/remove todos
- Mark as complete/incomplete
- Filter by status (all/active/completed)
- Use PAN bus for state management</code></pre>
<p><strong>3. Create a Theme Switcher:</strong></p>
<pre><code>- Light/dark theme toggle
- Publish theme changes via PAN
- Multiple components respond to theme changes
- Persist theme preference</code></pre>
<p><strong>4. Experiment with Import Maps:</strong></p>
<pre><code>- Try different CDNs (jsDelivr, unpkg, esm.sh)
- Add path aliases for your components
- Import an external library (lodash, dayjs, etc.)</code></pre>
<p>Take your time with these exercises. Understanding these patterns now
will make the rest of the book much easier.</p>
<hr />
<h2 data-number="3.9" id="further-reading-2"><span
class="header-section-number">3.9</span> Further Reading</h2>
<p><strong>For detailed API reference and configuration
options:</strong> - <em>Building with LARC</em> Chapter 3: Getting
Started - Complete installation options and troubleshooting -
<em>Building with LARC</em> Chapter 2: Core Concepts - Architecture and
messaging patterns reference - <em>Building with LARC</em> Appendix C:
Configuration Options - All configuration parameters</p>
<div class="pagebreak">

</div>
<h1 data-number="4" id="creating-web-components"><span
class="header-section-number">4</span> Creating Web Components</h1>
<p>Now that you’ve built your first LARC application, it’s time to
master the art of creating robust, reusable Web Components. This chapter
covers everything from basic component anatomy to advanced patterns like
composition, slots, and performance optimization.</p>
<p>By the end of this chapter, you’ll be able to build
production-quality components that are maintainable, testable, and
performant.</p>
<h2 data-number="4.1" id="anatomy-of-a-larc-component"><span
class="header-section-number">4.1</span> Anatomy of a LARC
Component</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/02-component-structure-3.png"
alt="Figure 4.1: Component Lifecycle Flow" />
<figcaption aria-hidden="true"><strong>Figure 4.1:</strong> Component
Lifecycle Flow</figcaption>
</figure>
<p>Let’s dissect a well-structured LARC component to understand its
parts:</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Import dependencies</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { formatDate } <span class="im">from</span> <span class="st">&#39;../lib/utils.js&#39;</span><span class="op">;</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * A card component for displaying user information.</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@element</span><span class="co"> user-card</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {string} user-id - The ID of the user to display</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} compact - Display in compact mode</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@fires</span><span class="co"> user-selected - Dispatched when card is clicked</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> - Default slot for additional content</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> actions - Slot for action buttons</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 1. Define observed attributes</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&#39;user-id&#39;</span><span class="op">,</span> <span class="st">&#39;compact&#39;</span>]<span class="op">;</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2. Constructor - initialize instance</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach shadow DOM</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize private state</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bind event handlers</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3. Lifecycle: connected to DOM</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load user data if ID is provided</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">;</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (userId) {</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadUser</span>(userId)<span class="op">;</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to PAN events</span></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.updated&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleUserUpdate</span>)<span class="op">;</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add event listeners</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 4. Lifecycle: disconnected from DOM</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up subscriptions</span></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) {</span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove event listeners</span></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 5. Lifecycle: attributes changed</span></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (oldValue <span class="op">===</span> newValue) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;user-id&#39;</span> <span class="op">&amp;&amp;</span> newValue) {</span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadUser</span>(newValue)<span class="op">;</span></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;compact&#39;</span>) {</span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-77"><a href="#cb86-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-78"><a href="#cb86-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-79"><a href="#cb86-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 6. Public properties with getters/setters</span></span>
<span id="cb86-80"><a href="#cb86-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">user</span>() {</span>
<span id="cb86-81"><a href="#cb86-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">;</span></span>
<span id="cb86-82"><a href="#cb86-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-83"><a href="#cb86-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-84"><a href="#cb86-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">user</span>(value) {</span>
<span id="cb86-85"><a href="#cb86-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb86-86"><a href="#cb86-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-87"><a href="#cb86-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-88"><a href="#cb86-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-89"><a href="#cb86-89" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">loading</span>() {</span>
<span id="cb86-90"><a href="#cb86-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span><span class="op">;</span></span>
<span id="cb86-91"><a href="#cb86-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-92"><a href="#cb86-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-93"><a href="#cb86-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 7. Public methods</span></span>
<span id="cb86-94"><a href="#cb86-94" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadUser</span>(userId) {</span>
<span id="cb86-95"><a href="#cb86-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb86-96"><a href="#cb86-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-97"><a href="#cb86-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-98"><a href="#cb86-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-99"><a href="#cb86-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb86-100"><a href="#cb86-100" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb86-101"><a href="#cb86-101" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to load user&#39;</span>)<span class="op">;</span></span>
<span id="cb86-102"><a href="#cb86-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-103"><a href="#cb86-103" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb86-104"><a href="#cb86-104" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-105"><a href="#cb86-105" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-106"><a href="#cb86-106" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb86-107"><a href="#cb86-107" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_error</span> <span class="op">=</span> error<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb86-108"><a href="#cb86-108" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb86-109"><a href="#cb86-109" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-110"><a href="#cb86-110" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-111"><a href="#cb86-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-112"><a href="#cb86-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-113"><a href="#cb86-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">refresh</span>() {</span>
<span id="cb86-114"><a href="#cb86-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">;</span></span>
<span id="cb86-115"><a href="#cb86-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (userId) {</span>
<span id="cb86-116"><a href="#cb86-116" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadUser</span>(userId)<span class="op">;</span></span>
<span id="cb86-117"><a href="#cb86-117" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-118"><a href="#cb86-118" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-119"><a href="#cb86-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-120"><a href="#cb86-120" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 8. Private methods</span></span>
<span id="cb86-121"><a href="#cb86-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleClick</span>(<span class="bu">event</span>) {</span>
<span id="cb86-122"><a href="#cb86-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb86-123"><a href="#cb86-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-124"><a href="#cb86-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;user-selected&#39;</span><span class="op">,</span> {</span>
<span id="cb86-125"><a href="#cb86-125" aria-hidden="true" tabindex="-1"></a>      <span class="dt">detail</span><span class="op">:</span> { <span class="dt">user</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> }<span class="op">,</span></span>
<span id="cb86-126"><a href="#cb86-126" aria-hidden="true" tabindex="-1"></a>      <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb86-127"><a href="#cb86-127" aria-hidden="true" tabindex="-1"></a>      <span class="dt">composed</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb86-128"><a href="#cb86-128" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb86-129"><a href="#cb86-129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-130"><a href="#cb86-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-131"><a href="#cb86-131" aria-hidden="true" tabindex="-1"></a>  handleUserUpdate <span class="op">=</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb86-132"><a href="#cb86-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">userId</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)) {</span>
<span id="cb86-133"><a href="#cb86-133" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> <span class="op">=</span> data<span class="op">.</span><span class="at">user</span><span class="op">;</span></span>
<span id="cb86-134"><a href="#cb86-134" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb86-135"><a href="#cb86-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-136"><a href="#cb86-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-137"><a href="#cb86-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-138"><a href="#cb86-138" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 9. Render method</span></span>
<span id="cb86-139"><a href="#cb86-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb86-140"><a href="#cb86-140" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> compact <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;compact&#39;</span>)<span class="op">;</span></span>
<span id="cb86-141"><a href="#cb86-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-142"><a href="#cb86-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_loading</span>) {</span>
<span id="cb86-143"><a href="#cb86-143" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderLoading</span>()<span class="op">;</span></span>
<span id="cb86-144"><a href="#cb86-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb86-145"><a href="#cb86-145" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-146"><a href="#cb86-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-147"><a href="#cb86-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_error</span>) {</span>
<span id="cb86-148"><a href="#cb86-148" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderError</span>()<span class="op">;</span></span>
<span id="cb86-149"><a href="#cb86-149" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb86-150"><a href="#cb86-150" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-151"><a href="#cb86-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-152"><a href="#cb86-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span>) {</span>
<span id="cb86-153"><a href="#cb86-153" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderEmpty</span>()<span class="op">;</span></span>
<span id="cb86-154"><a href="#cb86-154" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb86-155"><a href="#cb86-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb86-156"><a href="#cb86-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-157"><a href="#cb86-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> compact</span>
<span id="cb86-158"><a href="#cb86-158" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderCompact</span>()</span>
<span id="cb86-159"><a href="#cb86-159" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderFull</span>()<span class="op">;</span></span>
<span id="cb86-160"><a href="#cb86-160" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-161"><a href="#cb86-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-162"><a href="#cb86-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderLoading</span>() {</span>
<span id="cb86-163"><a href="#cb86-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-164"><a href="#cb86-164" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">styles</span>()<span class="sc">}</span><span class="vs">&lt;/style&gt;</span></span>
<span id="cb86-165"><a href="#cb86-165" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card loading&quot;&gt;</span></span>
<span id="cb86-166"><a href="#cb86-166" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;spinner&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb86-167"><a href="#cb86-167" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Loading...&lt;/p&gt;</span></span>
<span id="cb86-168"><a href="#cb86-168" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb86-169"><a href="#cb86-169" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-170"><a href="#cb86-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-171"><a href="#cb86-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-172"><a href="#cb86-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderError</span>() {</span>
<span id="cb86-173"><a href="#cb86-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-174"><a href="#cb86-174" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">styles</span>()<span class="sc">}</span><span class="vs">&lt;/style&gt;</span></span>
<span id="cb86-175"><a href="#cb86-175" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card error&quot;&gt;</span></span>
<span id="cb86-176"><a href="#cb86-176" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p class=&quot;error-message&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_error</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb86-177"><a href="#cb86-177" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;retry&quot;&gt;Retry&lt;/button&gt;</span></span>
<span id="cb86-178"><a href="#cb86-178" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb86-179"><a href="#cb86-179" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-180"><a href="#cb86-180" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-181"><a href="#cb86-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-182"><a href="#cb86-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderEmpty</span>() {</span>
<span id="cb86-183"><a href="#cb86-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-184"><a href="#cb86-184" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">styles</span>()<span class="sc">}</span><span class="vs">&lt;/style&gt;</span></span>
<span id="cb86-185"><a href="#cb86-185" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card empty&quot;&gt;</span></span>
<span id="cb86-186"><a href="#cb86-186" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;No user data&lt;/p&gt;</span></span>
<span id="cb86-187"><a href="#cb86-187" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb86-188"><a href="#cb86-188" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-189"><a href="#cb86-189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-190"><a href="#cb86-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-191"><a href="#cb86-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderCompact</span>() {</span>
<span id="cb86-192"><a href="#cb86-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-193"><a href="#cb86-193" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">styles</span>()<span class="sc">}</span><span class="vs">&lt;/style&gt;</span></span>
<span id="cb86-194"><a href="#cb86-194" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card compact&quot;&gt;</span></span>
<span id="cb86-195"><a href="#cb86-195" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;img src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">avatar</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb86-196"><a href="#cb86-196" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;info&quot;&gt;</span></span>
<span id="cb86-197"><a href="#cb86-197" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb86-198"><a href="#cb86-198" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;actions&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb86-199"><a href="#cb86-199" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb86-200"><a href="#cb86-200" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb86-201"><a href="#cb86-201" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-202"><a href="#cb86-202" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-203"><a href="#cb86-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-204"><a href="#cb86-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderFull</span>() {</span>
<span id="cb86-205"><a href="#cb86-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-206"><a href="#cb86-206" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">styles</span>()<span class="sc">}</span><span class="vs">&lt;/style&gt;</span></span>
<span id="cb86-207"><a href="#cb86-207" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb86-208"><a href="#cb86-208" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;header&quot;&gt;</span></span>
<span id="cb86-209"><a href="#cb86-209" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;img src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">avatar</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot; class=&quot;avatar&quot;&gt;</span></span>
<span id="cb86-210"><a href="#cb86-210" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;header-content&quot;&gt;</span></span>
<span id="cb86-211"><a href="#cb86-211" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;h2&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h2&gt;</span></span>
<span id="cb86-212"><a href="#cb86-212" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;p class=&quot;email&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb86-213"><a href="#cb86-213" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb86-214"><a href="#cb86-214" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb86-215"><a href="#cb86-215" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;body&quot;&gt;</span></span>
<span id="cb86-216"><a href="#cb86-216" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p class=&quot;bio&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">bio</span> <span class="op">||</span> <span class="st">&#39;No bio available&#39;</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb86-217"><a href="#cb86-217" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;meta&quot;&gt;</span></span>
<span id="cb86-218"><a href="#cb86-218" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span&gt;Joined </span><span class="sc">${</span><span class="fu">formatDate</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">createdAt</span>)<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb86-219"><a href="#cb86-219" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb86-220"><a href="#cb86-220" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb86-221"><a href="#cb86-221" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb86-222"><a href="#cb86-222" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;footer&quot;&gt;</span></span>
<span id="cb86-223"><a href="#cb86-223" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;actions&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb86-224"><a href="#cb86-224" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb86-225"><a href="#cb86-225" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb86-226"><a href="#cb86-226" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-227"><a href="#cb86-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-228"><a href="#cb86-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-229"><a href="#cb86-229" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 10. Styles</span></span>
<span id="cb86-230"><a href="#cb86-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">styles</span>() {</span>
<span id="cb86-231"><a href="#cb86-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb86-232"><a href="#cb86-232" aria-hidden="true" tabindex="-1"></a><span class="vs">      :host {</span></span>
<span id="cb86-233"><a href="#cb86-233" aria-hidden="true" tabindex="-1"></a><span class="vs">        display: block;</span></span>
<span id="cb86-234"><a href="#cb86-234" aria-hidden="true" tabindex="-1"></a><span class="vs">        cursor: pointer;</span></span>
<span id="cb86-235"><a href="#cb86-235" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-236"><a href="#cb86-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-237"><a href="#cb86-237" aria-hidden="true" tabindex="-1"></a><span class="vs">      .card {</span></span>
<span id="cb86-238"><a href="#cb86-238" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: white;</span></span>
<span id="cb86-239"><a href="#cb86-239" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 8px;</span></span>
<span id="cb86-240"><a href="#cb86-240" aria-hidden="true" tabindex="-1"></a><span class="vs">        box-shadow: 0 2px 4px rgba(0,0,0,0.1);</span></span>
<span id="cb86-241"><a href="#cb86-241" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 16px;</span></span>
<span id="cb86-242"><a href="#cb86-242" aria-hidden="true" tabindex="-1"></a><span class="vs">        transition: box-shadow 0.2s;</span></span>
<span id="cb86-243"><a href="#cb86-243" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-244"><a href="#cb86-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-245"><a href="#cb86-245" aria-hidden="true" tabindex="-1"></a><span class="vs">      .card:hover {</span></span>
<span id="cb86-246"><a href="#cb86-246" aria-hidden="true" tabindex="-1"></a><span class="vs">        box-shadow: 0 4px 12px rgba(0,0,0,0.15);</span></span>
<span id="cb86-247"><a href="#cb86-247" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-248"><a href="#cb86-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-249"><a href="#cb86-249" aria-hidden="true" tabindex="-1"></a><span class="vs">      .header {</span></span>
<span id="cb86-250"><a href="#cb86-250" aria-hidden="true" tabindex="-1"></a><span class="vs">        display: flex;</span></span>
<span id="cb86-251"><a href="#cb86-251" aria-hidden="true" tabindex="-1"></a><span class="vs">        gap: 12px;</span></span>
<span id="cb86-252"><a href="#cb86-252" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin-bottom: 16px;</span></span>
<span id="cb86-253"><a href="#cb86-253" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-254"><a href="#cb86-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-255"><a href="#cb86-255" aria-hidden="true" tabindex="-1"></a><span class="vs">      .avatar {</span></span>
<span id="cb86-256"><a href="#cb86-256" aria-hidden="true" tabindex="-1"></a><span class="vs">        width: 48px;</span></span>
<span id="cb86-257"><a href="#cb86-257" aria-hidden="true" tabindex="-1"></a><span class="vs">        height: 48px;</span></span>
<span id="cb86-258"><a href="#cb86-258" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 50%;</span></span>
<span id="cb86-259"><a href="#cb86-259" aria-hidden="true" tabindex="-1"></a><span class="vs">        object-fit: cover;</span></span>
<span id="cb86-260"><a href="#cb86-260" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-261"><a href="#cb86-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-262"><a href="#cb86-262" aria-hidden="true" tabindex="-1"></a><span class="vs">      h2 {</span></span>
<span id="cb86-263"><a href="#cb86-263" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin: 0;</span></span>
<span id="cb86-264"><a href="#cb86-264" aria-hidden="true" tabindex="-1"></a><span class="vs">        font-size: 18px;</span></span>
<span id="cb86-265"><a href="#cb86-265" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #333;</span></span>
<span id="cb86-266"><a href="#cb86-266" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-267"><a href="#cb86-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-268"><a href="#cb86-268" aria-hidden="true" tabindex="-1"></a><span class="vs">      .email {</span></span>
<span id="cb86-269"><a href="#cb86-269" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin: 4px 0 0 0;</span></span>
<span id="cb86-270"><a href="#cb86-270" aria-hidden="true" tabindex="-1"></a><span class="vs">        font-size: 14px;</span></span>
<span id="cb86-271"><a href="#cb86-271" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #666;</span></span>
<span id="cb86-272"><a href="#cb86-272" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-273"><a href="#cb86-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-274"><a href="#cb86-274" aria-hidden="true" tabindex="-1"></a><span class="vs">      .bio {</span></span>
<span id="cb86-275"><a href="#cb86-275" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #444;</span></span>
<span id="cb86-276"><a href="#cb86-276" aria-hidden="true" tabindex="-1"></a><span class="vs">        line-height: 1.5;</span></span>
<span id="cb86-277"><a href="#cb86-277" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-278"><a href="#cb86-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-279"><a href="#cb86-279" aria-hidden="true" tabindex="-1"></a><span class="vs">      .meta {</span></span>
<span id="cb86-280"><a href="#cb86-280" aria-hidden="true" tabindex="-1"></a><span class="vs">        font-size: 12px;</span></span>
<span id="cb86-281"><a href="#cb86-281" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #999;</span></span>
<span id="cb86-282"><a href="#cb86-282" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin-top: 12px;</span></span>
<span id="cb86-283"><a href="#cb86-283" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-284"><a href="#cb86-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-285"><a href="#cb86-285" aria-hidden="true" tabindex="-1"></a><span class="vs">      .loading, .error, .empty {</span></span>
<span id="cb86-286"><a href="#cb86-286" aria-hidden="true" tabindex="-1"></a><span class="vs">        text-align: center;</span></span>
<span id="cb86-287"><a href="#cb86-287" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 40px 20px;</span></span>
<span id="cb86-288"><a href="#cb86-288" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #666;</span></span>
<span id="cb86-289"><a href="#cb86-289" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-290"><a href="#cb86-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-291"><a href="#cb86-291" aria-hidden="true" tabindex="-1"></a><span class="vs">      .spinner {</span></span>
<span id="cb86-292"><a href="#cb86-292" aria-hidden="true" tabindex="-1"></a><span class="vs">        border: 3px solid #f3f3f3;</span></span>
<span id="cb86-293"><a href="#cb86-293" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-top: 3px solid #667eea;</span></span>
<span id="cb86-294"><a href="#cb86-294" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 50%;</span></span>
<span id="cb86-295"><a href="#cb86-295" aria-hidden="true" tabindex="-1"></a><span class="vs">        width: 40px;</span></span>
<span id="cb86-296"><a href="#cb86-296" aria-hidden="true" tabindex="-1"></a><span class="vs">        height: 40px;</span></span>
<span id="cb86-297"><a href="#cb86-297" aria-hidden="true" tabindex="-1"></a><span class="vs">        animation: spin 1s linear infinite;</span></span>
<span id="cb86-298"><a href="#cb86-298" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin: 0 auto 16px;</span></span>
<span id="cb86-299"><a href="#cb86-299" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-300"><a href="#cb86-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-301"><a href="#cb86-301" aria-hidden="true" tabindex="-1"></a><span class="vs">      @keyframes spin {</span></span>
<span id="cb86-302"><a href="#cb86-302" aria-hidden="true" tabindex="-1"></a><span class="vs">        to { transform: rotate(360deg); }</span></span>
<span id="cb86-303"><a href="#cb86-303" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-304"><a href="#cb86-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-305"><a href="#cb86-305" aria-hidden="true" tabindex="-1"></a><span class="vs">      .error-message {</span></span>
<span id="cb86-306"><a href="#cb86-306" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: #e53e3e;</span></span>
<span id="cb86-307"><a href="#cb86-307" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-308"><a href="#cb86-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-309"><a href="#cb86-309" aria-hidden="true" tabindex="-1"></a><span class="vs">      .compact {</span></span>
<span id="cb86-310"><a href="#cb86-310" aria-hidden="true" tabindex="-1"></a><span class="vs">        display: flex;</span></span>
<span id="cb86-311"><a href="#cb86-311" aria-hidden="true" tabindex="-1"></a><span class="vs">        align-items: center;</span></span>
<span id="cb86-312"><a href="#cb86-312" aria-hidden="true" tabindex="-1"></a><span class="vs">        gap: 12px;</span></span>
<span id="cb86-313"><a href="#cb86-313" aria-hidden="true" tabindex="-1"></a><span class="vs">        padding: 12px;</span></span>
<span id="cb86-314"><a href="#cb86-314" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-315"><a href="#cb86-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-316"><a href="#cb86-316" aria-hidden="true" tabindex="-1"></a><span class="vs">      .compact img {</span></span>
<span id="cb86-317"><a href="#cb86-317" aria-hidden="true" tabindex="-1"></a><span class="vs">        width: 40px;</span></span>
<span id="cb86-318"><a href="#cb86-318" aria-hidden="true" tabindex="-1"></a><span class="vs">        height: 40px;</span></span>
<span id="cb86-319"><a href="#cb86-319" aria-hidden="true" tabindex="-1"></a><span class="vs">        border-radius: 50%;</span></span>
<span id="cb86-320"><a href="#cb86-320" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-321"><a href="#cb86-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-322"><a href="#cb86-322" aria-hidden="true" tabindex="-1"></a><span class="vs">      .compact h3 {</span></span>
<span id="cb86-323"><a href="#cb86-323" aria-hidden="true" tabindex="-1"></a><span class="vs">        margin: 0;</span></span>
<span id="cb86-324"><a href="#cb86-324" aria-hidden="true" tabindex="-1"></a><span class="vs">        font-size: 14px;</span></span>
<span id="cb86-325"><a href="#cb86-325" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb86-326"><a href="#cb86-326" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb86-327"><a href="#cb86-327" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-328"><a href="#cb86-328" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-329"><a href="#cb86-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-330"><a href="#cb86-330" aria-hidden="true" tabindex="-1"></a><span class="co">// 11. Register the custom element</span></span>
<span id="cb86-331"><a href="#cb86-331" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-card&#39;</span><span class="op">,</span> UserCard)<span class="op">;</span></span>
<span id="cb86-332"><a href="#cb86-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-333"><a href="#cb86-333" aria-hidden="true" tabindex="-1"></a><span class="co">// 12. Export for use in other modules</span></span>
<span id="cb86-334"><a href="#cb86-334" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> UserCard<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.1.1" id="component-structure-breakdown"><span
class="header-section-number">4.1.1</span> Component Structure
Breakdown</h3>
<p><strong>1. Documentation:</strong></p>
<ul>
<li>JSDoc comments explain usage</li>
<li>Attribute, property, event, and slot documentation</li>
<li>Helps other developers understand the component</li>
</ul>
<p><strong>2. Static Properties:</strong></p>
<ul>
<li><code>observedAttributes</code> defines which attributes trigger
<code>attributeChangedCallback</code></li>
<li>Keep this list minimal for performance</li>
</ul>
<p><strong>3. Constructor:</strong></p>
<ul>
<li>Initialize instance variables</li>
<li>Attach shadow DOM</li>
<li>Bind methods (for event handlers)</li>
<li>Don’t access attributes or DOM here</li>
</ul>
<p><strong>4. Lifecycle Methods:</strong></p>
<ul>
<li><code>connectedCallback</code>: Setup when added to DOM</li>
<li><code>disconnectedCallback</code>: Cleanup when removed</li>
<li><code>attributeChangedCallback</code>: Respond to attribute
changes</li>
</ul>
<p><strong>5. Properties:</strong></p>
<ul>
<li>Use private fields (<code>_user</code>) for internal state</li>
<li>Provide getters/setters for public API</li>
<li>Setters can trigger re-renders</li>
</ul>
<p><strong>6. Methods:</strong></p>
<ul>
<li>Public methods for external use</li>
<li>Private methods (conventionally start with <code>_</code> or use
<code>#</code> private fields)</li>
<li>Keep methods focused and single-purpose</li>
</ul>
<p><strong>7. Rendering:</strong></p>
<ul>
<li>Separate render logic from state management</li>
<li>Multiple render methods for different states</li>
<li>Extract styles to a separate method</li>
</ul>
<h2 data-number="4.2" id="shadow-dom-deep-dive"><span
class="header-section-number">4.2</span> Shadow DOM Deep Dive</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/02-component-structure-6.png"
alt="Figure 4.2: Slots and Content Projection" />
<figcaption aria-hidden="true"><strong>Figure 4.2:</strong> Slots and
Content Projection</figcaption>
</figure>
<p>Shadow DOM is one of the most powerful features of Web Components. It
provides true encapsulation for both markup and styles.</p>
<h3 data-number="4.2.1" id="creating-shadow-dom"><span
class="header-section-number">4.2.1</span> Creating Shadow DOM</h3>
<div class="sourceCode" id="cb87"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create shadow root</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// mode: &#39;open&#39; - shadow root accessible via element.shadowRoot</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// mode: &#39;closed&#39; - shadow root not accessible (rarely used)</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.2.2" id="shadow-dom-vs-light-dom"><span
class="header-section-number">4.2.2</span> Shadow DOM vs Light DOM</h3>
<div class="sourceCode" id="cb88"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">my-component</span><span class="dt">&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- This is Light DOM (regular DOM) --&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Visible content<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">my-component</span><span class="dt">&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">constructor</span>() {</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// This is Shadow DOM</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;shadow-content&quot;&gt;</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h2&gt;Shadow DOM Content&lt;/h2&gt;</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>  customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;my-component&#39;</span><span class="op">,</span> MyComponent)<span class="op">;</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Result:</strong></p>
<ul>
<li>Light DOM (<code>&lt;p&gt;Visible content&lt;/p&gt;</code>) is
projected into the <code>&lt;slot&gt;</code></li>
<li>Shadow DOM provides the structure and styling</li>
<li>Styles in shadow DOM don’t leak out</li>
<li>Styles from light DOM don’t leak in</li>
</ul>
<h3 data-number="4.2.3" id="style-encapsulation"><span
class="header-section-number">4.2.3</span> Style Encapsulation</h3>
<div class="sourceCode" id="cb89"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StyledButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* These styles only affect this component */</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: blue;</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px 20px;</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: darkblue;</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/button&gt;</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Styles inside shadow DOM are scoped</li>
<li>No conflicts with global styles</li>
<li>No CSS class name collisions</li>
<li>True component encapsulation</li>
</ul>
<h3 data-number="4.2.4" id="the-host-selector"><span
class="header-section-number">4.2.4</span> The :host Selector</h3>
<p>Style the component itself:</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="in">:host</span> {</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">display</span><span class="ch">:</span> <span class="dv">block</span><span class="op">;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">margin</span><span class="ch">:</span> <span class="dv">16</span><span class="dt">px</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co">/* Style host when it has a class */</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="in">:host(</span><span class="fu">.highlighted</span><span class="in">)</span> {</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">border</span><span class="ch">:</span> <span class="dv">2</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">gold</span><span class="op">;</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="co">/* Style host when it has an attribute */</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="in">:host(</span><span class="ex">[</span><span class="ss">disabled</span><span class="ex">]</span><span class="in">)</span> {</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">opacity</span><span class="ch">:</span> <span class="dv">0.5</span><span class="op">;</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">pointer-events</span><span class="ch">:</span> <span class="dv">none</span><span class="op">;</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="co">/* Style host in specific contexts */</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="in">:host-context(</span><span class="fu">.dark-theme</span><span class="in">)</span> {</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background</span><span class="ch">:</span> <span class="cn">#333</span><span class="op">;</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">color</span><span class="ch">:</span> <span class="cn">white</span><span class="op">;</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.2.5" id="css-custom-properties-variables"><span
class="header-section-number">4.2.5</span> CSS Custom Properties
(Variables)</h3>
<p>CSS variables pierce the shadow DOM boundary:</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Component defines and uses variables</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemedCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--card-bg, white);</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: var(--card-text, black);</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid var(--card-border, #ddd);</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: var(--card-radius, 8px);</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--card-padding, 16px);</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Override component variables from outside */</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  themed-card {</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-bg</span><span class="ch">:</span> <span class="cn">#f0f0f0</span><span class="op">;</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-text</span><span class="ch">:</span> <span class="cn">#333</span><span class="op">;</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-border</span><span class="ch">:</span> <span class="cn">#ccc</span><span class="op">;</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-radius</span><span class="ch">:</span> <span class="dv">12</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  themed-card<span class="fu">.dark</span> {</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-bg</span><span class="ch">:</span> <span class="cn">#333</span><span class="op">;</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-text</span><span class="ch">:</span> <span class="cn">#fff</span><span class="op">;</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">--card-border</span><span class="ch">:</span> <span class="cn">#555</span><span class="op">;</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">themed-card</span><span class="dt">&gt;</span>Normal theme<span class="dt">&lt;/</span><span class="kw">themed-card</span><span class="dt">&gt;</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">themed-card</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;dark&quot;</span><span class="dt">&gt;</span>Dark theme<span class="dt">&lt;/</span><span class="kw">themed-card</span><span class="dt">&gt;</span></span></code></pre></div>
<p>This pattern allows theming while maintaining encapsulation.</p>
<h3 data-number="4.2.6" id="parts-and-part"><span
class="header-section-number">4.2.6</span> Parts and ::part()</h3>
<p>Expose specific shadow DOM elements for styling:</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FancyButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        button { /* default styles */ }</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        .icon { /* icon styles */ }</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button part=&quot;button&quot;&gt;</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span part=&quot;icon&quot; class=&quot;icon&quot;&gt;→&lt;/span&gt;</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Style from outside:</strong></p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>fancy-button<span class="in">::part(</span><span class="st">button</span><span class="in">)</span> {</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background</span><span class="ch">:</span> <span class="fu">linear-gradient(</span><span class="dv">135</span><span class="dt">deg</span><span class="op">,</span> <span class="cn">#667eea</span><span class="op">,</span> <span class="cn">#764ba2</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>fancy-button<span class="in">::part(</span><span class="st">icon</span><span class="in">)</span> {</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">color</span><span class="ch">:</span> <span class="cn">gold</span><span class="op">;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This gives consumers more control while maintaining
encapsulation.</p>
<h2 data-number="4.3" id="attributes-and-properties"><span
class="header-section-number">4.3</span> Attributes and Properties</h2>
<p>Understanding the difference between attributes and properties is
crucial for component design.</p>
<h3 data-number="4.3.1" id="attributes-vs-properties"><span
class="header-section-number">4.3.1</span> Attributes vs Properties</h3>
<p><strong>Attributes:</strong></p>
<ul>
<li>HTML attributes (<code>&lt;my-el foo="bar"&gt;</code>)</li>
<li>Always strings</li>
<li>Visible in HTML</li>
<li>Trigger <code>attributeChangedCallback</code></li>
</ul>
<p><strong>Properties:</strong></p>
<ul>
<li>JavaScript properties (<code>element.foo = 123</code>)</li>
<li>Any type (string, number, object, etc.)</li>
<li>Not visible in HTML</li>
<li>Direct access, no callback</li>
</ul>
<h3 data-number="4.3.2" id="reflecting-properties-to-attributes"><span
class="header-section-number">4.3.2</span> Reflecting Properties to
Attributes</h3>
<div class="sourceCode" id="cb95"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ToggleButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&#39;checked&#39;</span>]<span class="op">;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_checked</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Property getter</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">checked</span>() {</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_checked</span><span class="op">;</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Property setter - reflects to attribute</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">checked</span>(value) {</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> isChecked <span class="op">=</span> <span class="bu">Boolean</span>(value)<span class="op">;</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (isChecked) {</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;checked&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;checked&#39;</span>)<span class="op">;</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Attribute changed - updates property</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;checked&#39;</span>) {</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_checked</span> <span class="op">=</span> newValue <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button class=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_checked</span> <span class="op">?</span> <span class="st">&#39;checked&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_checked</span> <span class="op">?</span> <span class="st">&#39;✓&#39;</span> <span class="op">:</span> <span class="st">&#39;○&#39;</span><span class="sc">}</span></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Set via attribute --&gt;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">toggle-button</span><span class="ot"> checked</span><span class="dt">&gt;&lt;/</span><span class="kw">toggle-button</span><span class="dt">&gt;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> toggle <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;toggle-button&#39;</span>)<span class="op">;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set via property</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  toggle<span class="op">.</span><span class="at">checked</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get property</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(toggle<span class="op">.</span><span class="at">checked</span>)<span class="op">;</span> <span class="co">// true</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check attribute</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(toggle<span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;checked&#39;</span>))<span class="op">;</span> <span class="co">// true</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="4.3.3" id="when-to-use-each-1"><span
class="header-section-number">4.3.3</span> When to Use Each</h3>
<p><strong>Use Attributes for:</strong></p>
<ul>
<li>Simple configuration (strings, numbers, booleans)</li>
<li>Values that should be visible in HTML</li>
<li>Initial configuration from HTML</li>
<li>Values that need to work with CSS selectors</li>
</ul>
<p><strong>Use Properties for:</strong></p>
<ul>
<li>Complex data (objects, arrays, functions)</li>
<li>Data that changes frequently</li>
<li>Large data that shouldn’t serialize to HTML</li>
<li>Callback functions</li>
</ul>
<h3 data-number="4.3.4" id="type-conversion"><span
class="header-section-number">4.3.4</span> Type Conversion</h3>
<p>Attributes are always strings, so convert appropriately:</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;count&#39;</span>) {</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_count</span> <span class="op">=</span> <span class="bu">Number</span>(newValue) <span class="op">||</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;enabled&#39;</span>) {</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_enabled</span> <span class="op">=</span> newValue <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span> <span class="co">// Boolean attribute</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;options&#39;</span>) {</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_options</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(newValue)<span class="op">;</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> {</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_options</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.3.5" id="boolean-attributes"><span
class="header-section-number">4.3.5</span> Boolean Attributes</h3>
<p>Follow HTML conventions:</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Boolean attribute: presence = true, absence = false</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;disabled&#39;</span>)) {</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Is disabled</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Set boolean attribute</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;disabled&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span> <span class="co">// value doesn&#39;t matter</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Remove boolean attribute</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;disabled&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="4.4" id="component-styling"><span
class="header-section-number">4.4</span> Component Styling</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/02-component-structure-7.png"
alt="Figure 4.3: CSS Encapsulation with Shadow DOM" />
<figcaption aria-hidden="true"><strong>Figure 4.3:</strong> CSS
Encapsulation with Shadow DOM</figcaption>
</figure>
<h3 data-number="4.4.1" id="internal-styles"><span
class="header-section-number">4.4.1</span> Internal Styles</h3>
<p>Most styles should be in shadow DOM:</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">styles</span>() {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    :host {</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      display: block;</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="vs">    }</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    .container {</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      padding: 16px;</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    }</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="vs">    /* All your component styles */</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.4.2" id="external-stylesheets"><span
class="header-section-number">4.4.2</span> External Stylesheets</h3>
<p>For larger components, link external styles:</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">connectedCallback</span>() {</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/components/user-card.css&quot;&gt;</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;div class=&quot;user-card&quot;&gt;</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;!-- content --&gt;</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/div&gt;</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span><span class="op">;</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.4.3" id="adoptable-stylesheets"><span
class="header-section-number">4.4.3</span> Adoptable Stylesheets</h3>
<p>Share styles between component instances:</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create shared stylesheet once</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sheet <span class="op">=</span> <span class="kw">new</span> <span class="bu">CSSStyleSheet</span>()<span class="op">;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>sheet<span class="op">.</span><span class="fu">replaceSync</span>(<span class="vs">`</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  .card {</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="vs">    padding: 16px;</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    border-radius: 8px;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    background: white;</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="vs">    box-shadow: 0 2px 4px rgba(0,0,0,0.1);</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  }</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CardComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adopt shared stylesheet (very fast)</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">adoptedStyleSheets</span> <span class="op">=</span> [sheet]<span class="op">;</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>Styles parsed once, shared across instances</li>
<li>Better performance with many components</li>
<li>Modify shared styles dynamically</li>
</ul>
<h3 data-number="4.4.4" id="theming-strategies"><span
class="header-section-number">4.4.4</span> Theming Strategies</h3>
<p><strong>Strategy 1: CSS Custom Properties</strong></p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemedComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">styles</span>() {</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      :host {</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        --primary-color: var(--app-primary, #667eea);</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        --background: var(--app-bg, white);</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        --text: var(--app-text, #333);</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      .content {</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: var(--background);</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: var(--text);</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="vs">      button {</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: var(--primary-color);</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Strategy 2: Class-Based Themes</strong></p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeAwareComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Observe theme changes on documentElement</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="bu">MutationObserver</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateTheme</span>()<span class="op">;</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    observer<span class="op">.</span><span class="fu">observe</span>(<span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">,</span> {</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">attributes</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">attributeFilter</span><span class="op">:</span> [<span class="st">&#39;data-theme&#39;</span>]</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateTheme</span>()<span class="op">;</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateTheme</span>() {</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theme <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">theme</span> <span class="op">||</span> <span class="st">&#39;light&#39;</span><span class="op">;</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> theme)<span class="op">;</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">styles</span>() {</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      :host([theme=&quot;light&quot;]) {</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: white;</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: black;</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a><span class="vs">      :host([theme=&quot;dark&quot;]) {</span></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: #333;</span></span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: white;</span></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Strategy 3: PAN-Based Themes</strong></p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanThemedComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.changed&#39;</span><span class="op">,</span> ({ theme }) <span class="kw">=&gt;</span> {</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Request current theme</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;app.theme.get&#39;</span>)<span class="op">.</span><span class="fu">then</span>(theme <span class="kw">=&gt;</span> {</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(theme) {</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-theme&#39;</span><span class="op">,</span> theme)<span class="op">;</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.5" id="lifecycle-methods-advanced-patterns"><span
class="header-section-number">4.5</span> Lifecycle Methods (Advanced
Patterns)</h2>
<h3 data-number="4.5.1" id="deferred-rendering"><span
class="header-section-number">4.5.1</span> Deferred Rendering</h3>
<p>Wait for dependencies before rendering:</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataDisplay <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for dependencies to load</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;loading-spinner&#39;</span>)<span class="op">;</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(<span class="st">&#39;error-message&#39;</span>)<span class="op">;</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Now render</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.5.2" id="preventing-memory-leaks"><span
class="header-section-number">4.5.2</span> Preventing Memory Leaks</h3>
<div class="sourceCode" id="cb106"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WebSocketComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="st">&#39;wss://api.example.com&#39;</span>)<span class="op">;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleMessage</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> (error) <span class="kw">=&gt;</span> {</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;WebSocket error:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up WebSocket connection</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">ws</span>) {</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="4.5.3" id="handling-rapid-reconnection"><span
class="header-section-number">4.5.3</span> Handling Rapid
Reconnection</h3>
<p>Components can be disconnected and reconnected quickly:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RobustComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Might be called multiple times</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use a guard to prevent duplicate setup</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_initialized</span>) {</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_initialized</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setup</span>()<span class="op">;</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use setTimeout to debounce</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_cleanupTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">cleanup</span>()<span class="op">;</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_initialized</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cancel cleanup if reconnected quickly</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_cleanupTimer</span>) {</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_cleanupTimer</span>)<span class="op">;</span></span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_cleanupTimer</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_initialized</span>) {</span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_initialized</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setup</span>()<span class="op">;</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.6" id="testing-components"><span
class="header-section-number">4.6</span> Testing Components</h2>
<h3 data-number="4.6.1" id="unit-testing"><span
class="header-section-number">4.6.1</span> Unit Testing</h3>
<p>Test components in isolation:</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/user-card.test.js</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { expect } <span class="im">from</span> <span class="st">&#39;@open-wc/testing&#39;</span><span class="op">;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;../user-card.js&#39;</span><span class="op">;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;UserCard&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> element<span class="op">;</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;user-card&#39;</span>)<span class="op">;</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">afterEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;renders empty state by default&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> emptyText <span class="op">=</span> element<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.empty&#39;</span>)<span class="op">;</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(emptyText)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;loads user when user-id attribute is set&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mock fetch</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">global</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> ({</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">json</span><span class="op">:</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> ({ <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;John Doe&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;john@example.com&#39;</span> })</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;user-id&#39;</span><span class="op">,</span> <span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for async operations</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> name <span class="op">=</span> element<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;h2&#39;</span>)<span class="op">;</span></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(name<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;John Doe&#39;</span>)<span class="op">;</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;handles loading state&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;user-id&#39;</span><span class="op">,</span> <span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> spinner <span class="op">=</span> element<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.spinner&#39;</span>)<span class="op">;</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(spinner)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;dispatches user-selected event on click&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">_user</span> <span class="op">=</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;John&#39;</span> }<span class="op">;</span></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> eventData <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;user-selected&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>      eventData <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>    element<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.card&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(eventData)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">deep</span><span class="op">.</span><span class="fu">equal</span>({ <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;John&#39;</span> } })<span class="op">;</span></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.6.2" id="integration-testing"><span
class="header-section-number">4.6.2</span> Integration Testing</h3>
<p>Test components working together:</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/counter-integration.test.js</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Counter Integration&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;counter-display&gt;&lt;/counter-display&gt;</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;counter-controls&gt;&lt;/counter-controls&gt;</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;updates display when controls are clicked&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> display <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;counter-display&#39;</span>)<span class="op">;</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> controls <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;counter-controls&#39;</span>)<span class="op">;</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> incrementBtn <span class="op">=</span> controls<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#increment&#39;</span>)<span class="op">;</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    incrementBtn<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">50</span>))<span class="op">;</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> displayValue <span class="op">=</span> display<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.display&#39;</span>)<span class="op">.</span><span class="at">textContent</span><span class="op">;</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(displayValue)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="4.6.3" id="visual-regression-testing"><span
class="header-section-number">4.6.3</span> Visual Regression
Testing</h3>
<p>Catch visual bugs:</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tests/visual.test.js</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> puppeteer <span class="im">from</span> <span class="st">&#39;puppeteer&#39;</span><span class="op">;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pixelmatch <span class="im">from</span> <span class="st">&#39;pixelmatch&#39;</span><span class="op">;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Visual Regression&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> browser<span class="op">,</span> page<span class="op">;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeAll</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    browser <span class="op">=</span> <span class="cf">await</span> puppeteer<span class="op">.</span><span class="fu">launch</span>()<span class="op">;</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> <span class="cf">await</span> browser<span class="op">.</span><span class="fu">newPage</span>()<span class="op">;</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">afterAll</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> browser<span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;user-card matches snapshot&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;http://localhost:3000/tests/user-card.html&#39;</span>)<span class="op">;</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> screenshot <span class="op">=</span> <span class="cf">await</span> page<span class="op">.</span><span class="fu">screenshot</span>({ <span class="dt">fullPage</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> baseline <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(<span class="st">&#39;tests/snapshots/user-card.png&#39;</span>)<span class="op">;</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> diff <span class="op">=</span> <span class="fu">pixelmatch</span>(screenshot<span class="op">,</span> baseline<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="dv">600</span><span class="op">,</span> {</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">threshold</span><span class="op">:</span> <span class="fl">0.1</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(diff)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="fu">lessThan</span>(<span class="dv">100</span>)<span class="op">;</span> <span class="co">// Allow small differences</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="4.7" id="summary-3"><span
class="header-section-number">4.7</span> Summary</h2>
<p>This chapter covered:</p>
<ul>
<li><strong>Component Anatomy</strong>: Structure, lifecycle, and
organization</li>
<li><strong>Shadow DOM</strong>: Encapsulation, slots, and styling</li>
<li><strong>Attributes vs Properties</strong>: When to use each and how
to reflect them</li>
<li><strong>Component Styling</strong>: Internal styles, theming, and
CSS custom properties</li>
<li><strong>Lifecycle Patterns</strong>: Memory management and robust
connection handling</li>
<li><strong>Testing</strong>: Unit, integration, and visual regression
testing</li>
</ul>
<p>You now know how to build production-quality Web Components. The next
chapter explores the PAN bus in depth, showing you how to orchestrate
component communication at scale.</p>
<hr />
<h2 data-number="4.8" id="best-practices"><span
class="header-section-number">4.8</span> Best Practices</h2>
<ol type="1">
<li><strong>Always clean up in
<code>disconnectedCallback</code></strong>
<ul>
<li>Remove event listeners</li>
<li>Cancel pending operations</li>
<li>Unsubscribe from events</li>
</ul></li>
<li><strong>Use Shadow DOM for encapsulation</strong>
<ul>
<li>Keep styles scoped</li>
<li>Avoid global style pollution</li>
<li>Use <code>:host</code> and CSS custom properties for theming</li>
</ul></li>
<li><strong>Reflect important properties to attributes</strong>
<ul>
<li>Makes state visible in HTML</li>
<li>Enables CSS selectors</li>
<li>Improves debugging</li>
</ul></li>
<li><strong>Keep components focused</strong>
<ul>
<li>Single responsibility principle</li>
<li>Compose larger components from smaller ones</li>
<li>Extract shared logic to utilities</li>
</ul></li>
<li><strong>Test early and often</strong>
<ul>
<li>Write tests as you build components</li>
<li>Test both happy paths and error cases</li>
<li>Use integration tests for component interaction</li>
</ul></li>
</ol>
<hr />
<h2 data-number="4.9" id="further-reading-3"><span
class="header-section-number">4.9</span> Further Reading</h2>
<p><strong>For complete Web Components reference:</strong> -
<em>Building with LARC</em> Chapter 2: Core Concepts - Web Components
architecture and lifecycle - <em>Building with LARC</em> Chapters 17-21:
Component Reference - Complete API documentation - <em>Building with
LARC</em> Chapter 13: Testing Strategies - Component testing
patterns</p>
<div class="pagebreak">

</div>
<h1 data-number="5" id="the-pan-bus"><span
class="header-section-number">5</span> The PAN Bus</h1>
<p>The Page Area Network (PAN) bus is LARC’s event-driven communication
backbone. It enables decoupled, scalable component architectures by
providing a pub/sub messaging system that works across your entire
application.</p>
<p>In this chapter, you’ll master the PAN bus: from basic
publish/subscribe patterns to advanced message routing, error handling,
and debugging techniques. By the end, you’ll be able to build complex
applications where components communicate seamlessly without tight
coupling.</p>
<h2 data-number="5.1" id="understanding-pubsub-architecture"><span
class="header-section-number">5.1</span> Understanding Pub/Sub
Architecture</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-1.png"
alt="Figure 5.1: PAN Bus Pub/Sub Architecture" />
<figcaption aria-hidden="true"><strong>Figure 5.1:</strong> PAN Bus
Pub/Sub Architecture</figcaption>
</figure>
<p>Publish/Subscribe (pub/sub) is a messaging pattern where senders
(publishers) don’t directly target specific receivers (subscribers).
Instead, messages are sent to topics, and any component interested in
those topics receives them.</p>
<h3 data-number="5.1.1" id="traditional-communication"><span
class="header-section-number">5.1.1</span> Traditional
Communication</h3>
<p>Without pub/sub, components need direct references:</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Tight coupling</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginButton {</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleLogin</span>() {</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">authenticate</span>()<span class="op">;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Direct reference to other components</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;user-menu&#39;</span>)<span class="op">.</span><span class="fu">updateUser</span>(user)<span class="op">;</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;sidebar&#39;</span>)<span class="op">.</span><span class="fu">showUserPanel</span>()<span class="op">;</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;notification&#39;</span>)<span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Welcome!&#39;</span>)<span class="op">;</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Problems:</strong></p>
<ul>
<li>LoginButton must know about all dependent components</li>
<li>Adding new components requires modifying LoginButton</li>
<li>Components can’t work independently</li>
<li>Testing requires mocking all dependencies</li>
</ul>
<h3 data-number="5.1.2" id="pubsub-communication"><span
class="header-section-number">5.1.2</span> Pub/Sub Communication</h3>
<p>With the PAN bus:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✓ Loose coupling</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginButton {</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleLogin</span>() {</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">authenticate</span>()<span class="op">;</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Publish event - don&#39;t care who listens</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> { user })<span class="op">;</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Separate components subscribe independently</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserMenu {</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> ({ user }) <span class="kw">=&gt;</span> {</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateUser</span>(user)<span class="op">;</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sidebar {</span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showUserPanel</span>()<span class="op">;</span></span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="bu">Notification</span> {</span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">show</span>(<span class="st">&#39;Welcome!&#39;</span>)<span class="op">;</span></span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>LoginButton doesn’t know about consumers</li>
<li>Add new subscribers without changing publishers</li>
<li>Components work independently</li>
<li>Easy to test in isolation</li>
</ul>
<h3 data-number="5.1.3" id="the-pan-bus-api"><span
class="header-section-number">5.1.3</span> The PAN Bus API</h3>
<p>The PAN bus provides three core operations:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Publish - send a message to a topic</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;topic.name&#39;</span><span class="op">,</span> { <span class="dt">data</span><span class="op">:</span> <span class="st">&#39;value&#39;</span> })<span class="op">;</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Subscribe - listen for messages on a topic</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsubscribe <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;topic.name&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Received:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. Unsubscribe - stop listening</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="fu">unsubscribe</span>()<span class="op">;</span></span></code></pre></div>
<p>That’s the foundation. Everything else builds on these three
operations.</p>
<h2 data-number="5.2" id="topics-and-namespaces"><span
class="header-section-number">5.2</span> Topics and Namespaces</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-3.png"
alt="Figure 5.2: Topic Namespace Structure" />
<figcaption aria-hidden="true"><strong>Figure 5.2:</strong> Topic
Namespace Structure</figcaption>
</figure>
<p>Topics are the routing keys for messages. Well-designed topics make
your application’s data flow clear and maintainable.</p>
<h3 data-number="5.2.1" id="topic-naming-conventions"><span
class="header-section-number">5.2.1</span> Topic Naming Conventions</h3>
<p>Use dot notation to create hierarchies:</p>
<pre><code>domain.entity.action</code></pre>
<p><strong>Examples:</strong></p>
<pre><code>user.profile.updated
user.auth.login
user.auth.logout
user.settings.changed

cart.item.added
cart.item.removed
cart.total.calculated
cart.checkout.started
cart.checkout.completed

notification.info.show
notification.warning.show
notification.error.show

app.theme.changed
app.language.changed
app.route.changed</code></pre>
<h3 data-number="5.2.2" id="namespace-structure"><span
class="header-section-number">5.2.2</span> Namespace Structure</h3>
<p>Organize topics by domain:</p>
<p><strong>User Domain:</strong></p>
<pre><code>user.auth.login
user.auth.logout
user.auth.refresh
user.profile.fetch
user.profile.update
user.settings.fetch
user.settings.update</code></pre>
<p><strong>Shopping Cart Domain:</strong></p>
<pre><code>cart.init
cart.item.add
cart.item.remove
cart.item.update
cart.clear
cart.checkout</code></pre>
<p><strong>Application Domain:</strong></p>
<pre><code>app.ready
app.error
app.navigate
app.theme.change
app.modal.open
app.modal.close</code></pre>
<h3 data-number="5.2.3" id="wildcards"><span
class="header-section-number">5.2.3</span> Wildcards</h3>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-4.png"
alt="Figure 5.3: Wildcard Subscription Matching" />
<figcaption aria-hidden="true"><strong>Figure 5.3:</strong> Wildcard
Subscription Matching</figcaption>
</figure>
<p>Subscribe to multiple topics using wildcards:</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to all user events</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.*&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;User event:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to all auth events across domains</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*.auth.*&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Auth event:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to ALL events (debugging)</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">]`</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Wildcard Patterns:</strong></p>
<ul>
<li><code>user.*</code> - All user events (user.login, user.logout,
etc.)</li>
<li><code>*.created</code> - All create events (user.created,
post.created, etc.)</li>
<li><code>user.*.updated</code> - All user update events
(user.profile.updated, user.settings.updated, etc.)</li>
<li><code>*</code> - All events</li>
</ul>
<h3 data-number="5.2.4" id="topic-best-practices"><span
class="header-section-number">5.2.4</span> Topic Best Practices</h3>
<p><strong>1. Be Specific:</strong></p>
<div class="sourceCode" id="cb120"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✓ Good - clear intent</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.added&#39;</span><span class="op">,</span> { item<span class="op">,</span> quantity })<span class="op">;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad - vague</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.update&#39;</span><span class="op">,</span> { <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;add&#39;</span><span class="op">,</span> item<span class="op">,</span> quantity })<span class="op">;</span></span></code></pre></div>
<p><strong>2. Use Consistent Tense:</strong></p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✓ Good - past tense for events that happened</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> { user })<span class="op">;</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.loaded&#39;</span><span class="op">,</span> { data })<span class="op">;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad - mixed tense</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> { user })<span class="op">;</span>  <span class="co">// Is this a command or event?</span></span></code></pre></div>
<p><strong>3. Include Context:</strong></p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✓ Good - data includes context</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;task.completed&#39;</span><span class="op">,</span> {</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">taskId</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">userId</span><span class="op">:</span> <span class="dv">456</span><span class="op">,</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">completedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad - missing context</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;task.done&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">123</span> })<span class="op">;</span></span></code></pre></div>
<p><strong>4. Avoid Over-Nesting:</strong></p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✓ Good - clear and concise</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.profile.updated&#39;</span><span class="op">,</span> { user })<span class="op">;</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad - too nested</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.domain.user.entity.profile.action.updated&#39;</span><span class="op">,</span> { user })<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.3" id="publishing-messages"><span
class="header-section-number">5.3</span> Publishing Messages</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-2.png"
alt="Figure 5.4: Message Flow Sequence" />
<figcaption aria-hidden="true"><strong>Figure 5.4:</strong> Message Flow
Sequence</figcaption>
</figure>
<p>Publishing is straightforward, but there are patterns and options to
understand.</p>
<h3 data-number="5.3.1" id="basic-publishing"><span
class="header-section-number">5.3.1</span> Basic Publishing</h3>
<div class="sourceCode" id="cb124"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;event.name&#39;</span><span class="op">,</span> { <span class="dt">any</span><span class="op">:</span> <span class="st">&#39;data&#39;</span> })<span class="op">;</span></span></code></pre></div>
<p>The data can be anything JSON-serializable:</p>
<div class="sourceCode" id="cb125"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple value</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;counter.updated&#39;</span><span class="op">,</span> <span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Object</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.logged-in&#39;</span><span class="op">,</span> {</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">username</span><span class="op">:</span> <span class="st">&#39;john&#39;</span><span class="op">,</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;john@example.com&#39;</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Array</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;items.loaded&#39;</span><span class="op">,</span> [</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Item 1&#39;</span> }<span class="op">,</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Item 2&#39;</span> }</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Null/undefined</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.cleared&#39;</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.3.2" id="publishing-from-components"><span
class="header-section-number">5.3.2</span> Publishing from
Components</h3>
<p>Publish in response to user actions or state changes:</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddToCartButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleClick</span>)<span class="op">;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleClick</span>() {</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> productId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;product-id&#39;</span>)<span class="op">;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> quantity <span class="op">=</span> <span class="pp">parseInt</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;quantity&#39;</span>) <span class="op">||</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Publish intent</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add-requested&#39;</span><span class="op">,</span> { productId<span class="op">,</span> quantity })<span class="op">;</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Perform action</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">addToCart</span>(productId<span class="op">,</span> quantity)<span class="op">;</span></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Publish success</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.added&#39;</span><span class="op">,</span> {</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>        productId<span class="op">,</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>        quantity<span class="op">,</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Publish failure</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add-failed&#39;</span><span class="op">,</span> {</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>        productId<span class="op">,</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>        quantity<span class="op">,</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">addToCart</span>(productId<span class="op">,</span> quantity) {</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/cart/items&#39;</span><span class="op">,</span> {</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ productId<span class="op">,</span> quantity })</span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to add item to cart&#39;</span>)<span class="op">;</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.3.3" id="event-metadata"><span
class="header-section-number">5.3.3</span> Event Metadata</h3>
<p>Include metadata for debugging and auditing:</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">publishWithMetadata</span>(topic<span class="op">,</span> data) {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(topic<span class="op">,</span> {</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span>data<span class="op">,</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">_meta</span><span class="op">:</span> {</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">source</span><span class="op">:</span> <span class="st">&#39;UserComponent&#39;</span><span class="op">,</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userId</span><span class="op">:</span> currentUser<span class="op">?.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sessionId</span><span class="op">:</span> sessionId</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="fu">publishWithMetadata</span>(<span class="st">&#39;order.placed&#39;</span><span class="op">,</span> {</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">orderId</span><span class="op">:</span> <span class="dv">12345</span><span class="op">,</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">total</span><span class="op">:</span> <span class="fl">99.99</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.3.4" id="batch-publishing"><span
class="header-section-number">5.3.4</span> Batch Publishing</h3>
<p>Publish multiple events efficiently:</p>
<div class="sourceCode" id="cb128"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">syncLocalChanges</span>(changes) {</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  changes<span class="op">.</span><span class="fu">forEach</span>(change <span class="kw">=&gt;</span> {</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (change<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;add&#39;</span><span class="op">:</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.item.added&#39;</span><span class="op">,</span> change<span class="op">.</span><span class="at">item</span>)<span class="op">;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;update&#39;</span><span class="op">:</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.item.updated&#39;</span><span class="op">,</span> change<span class="op">.</span><span class="at">item</span>)<span class="op">;</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;delete&#39;</span><span class="op">:</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.item.deleted&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> change<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Publish batch complete</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;data.sync.completed&#39;</span><span class="op">,</span> {</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">changesCount</span><span class="op">:</span> changes<span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="5.4" id="subscribing-to-events"><span
class="header-section-number">5.4</span> Subscribing to Events</h2>
<p>Subscriptions are how components react to events they care about.</p>
<h3 data-number="5.4.1" id="basic-subscription"><span
class="header-section-number">5.4.1</span> Basic Subscription</h3>
<div class="sourceCode" id="cb129"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> unsubscribe <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;event.name&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Received:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Later, when done</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="fu">unsubscribe</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.4.2" id="component-lifecycle-integration"><span
class="header-section-number">5.4.2</span> Component Lifecycle
Integration</h3>
<p>Subscribe in <code>connectedCallback</code>, unsubscribe in
<code>disconnectedCallback</code>:</p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NotificationDisplay <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to notification events</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeInfo</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;notification.info&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">showInfo</span>)<span class="op">;</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeWarning</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;notification.warning&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">showWarning</span>)<span class="op">;</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeError</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;notification.error&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">showError</span>)<span class="op">;</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up subscriptions</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeInfo</span>()<span class="op">;</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeWarning</span>()<span class="op">;</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeError</span>()<span class="op">;</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  showInfo <span class="op">=</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(<span class="st">&#39;info&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>  showWarning <span class="op">=</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(<span class="st">&#39;warning&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>  showError <span class="op">=</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showNotification</span>(type<span class="op">,</span> message) {</span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render notification UI</span></span>
<span id="cb130-30"><a href="#cb130-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb130-31"><a href="#cb130-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.4.3" id="multiple-subscriptions-helper"><span
class="header-section-number">5.4.3</span> Multiple Subscriptions
Helper</h3>
<p>Manage multiple subscriptions easily:</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SubscriptionManager {</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span>(topic<span class="op">,</span> handler) {</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> unsubscribe <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(topic<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">push</span>(unsubscribe)<span class="op">;</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unsubscribe<span class="op">;</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unsubscribeAll</span>() {</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">forEach</span>(unsubscribe <span class="kw">=&gt;</span> <span class="fu">unsubscribe</span>())<span class="op">;</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in component</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subs</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">SubscriptionManager</span>()<span class="op">;</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subs</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleLogin</span>)<span class="op">;</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subs</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.logout&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleLogout</span>)<span class="op">;</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subs</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.theme.changed&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleThemeChange</span>)<span class="op">;</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subs</span><span class="op">.</span><span class="fu">unsubscribeAll</span>()<span class="op">;</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>  handleLogin <span class="op">=</span> (data) <span class="kw">=&gt;</span> { <span class="co">/* ... */</span> }</span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>  handleLogout <span class="op">=</span> (data) <span class="kw">=&gt;</span> { <span class="co">/* ... */</span> }</span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>  handleThemeChange <span class="op">=</span> (data) <span class="kw">=&gt;</span> { <span class="co">/* ... */</span> }</span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.4.4" id="conditional-subscriptions"><span
class="header-section-number">5.4.4</span> Conditional
Subscriptions</h3>
<p>Subscribe only when conditions are met:</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserDashboard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to user-specific events only when user is logged in</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeAuth</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;auth.state.changed&#39;</span><span class="op">,</span> ({ isAuthenticated<span class="op">,</span> user }) <span class="kw">=&gt;</span> {</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (isAuthenticated) {</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">subscribeToUserEvents</span>(user<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeFromUserEvents</span>()<span class="op">;</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribeToUserEvents</span>(userId) {</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserActivity</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.activity&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">userId</span> <span class="op">===</span> userId) {</span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateActivity</span>(data)<span class="op">;</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserNotifications</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.notifications&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (data<span class="op">.</span><span class="at">userId</span> <span class="op">===</span> userId) {</span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(data)<span class="op">;</span></span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unsubscribeFromUserEvents</span>() {</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserActivity</span>) {</span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeUserActivity</span>()<span class="op">;</span></span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserActivity</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserNotifications</span>) {</span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribeUserNotifications</span>()<span class="op">;</span></span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribeUserNotifications</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="5.4.5" id="filtering-events"><span
class="header-section-number">5.4.5</span> Filtering Events</h3>
<p>Filter events in the subscriber:</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;task.updated&#39;</span><span class="op">,</span> (task) <span class="kw">=&gt;</span> {</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Only handle tasks assigned to current user</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (task<span class="op">.</span><span class="at">assignedTo</span> <span class="op">===</span> currentUser<span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateTaskDisplay</span>(task)<span class="op">;</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;notification.*&#39;</span><span class="op">,</span> (notification) <span class="kw">=&gt;</span> {</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Only show high-priority notifications</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (notification<span class="op">.</span><span class="at">priority</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(notification)<span class="op">;</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="5.5" id="message-patterns-1"><span
class="header-section-number">5.5</span> Message Patterns</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-6.png"
alt="Figure 5.5: Event Pattern Comparison" />
<figcaption aria-hidden="true"><strong>Figure 5.5:</strong> Event
Pattern Comparison</figcaption>
</figure>
<p>The PAN bus supports several messaging patterns for different use
cases.</p>
<h3 data-number="5.5.1" id="fire-and-forget-1"><span
class="header-section-number">5.5.1</span> 1. Fire and Forget</h3>
<p>Most common pattern. Publish and continue without waiting:</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Publisher</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">saveSettings</span>(settings) {</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;settings&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(settings))<span class="op">;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;settings.saved&#39;</span><span class="op">,</span> settings)<span class="op">;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscriber</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;settings.saved&#39;</span><span class="op">,</span> (settings) <span class="kw">=&gt;</span> {</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Settings updated:&#39;</span><span class="op">,</span> settings)<span class="op">;</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateUI</span>(settings)<span class="op">;</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Multiple components may react</li>
<li>You don’t need confirmation</li>
<li>Action is non-critical</li>
</ul>
<h3 data-number="5.5.2" id="requestresponse-1"><span
class="header-section-number">5.5.2</span> 2. Request/Response</h3>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-5.png"
alt="Figure 5.6: Request/Response Pattern" />
<figcaption aria-hidden="true"><strong>Figure 5.6:</strong>
Request/Response Pattern</figcaption>
</figure>
<p>Request data and wait for a response:</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Responder</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">respond</span>(<span class="st">&#39;auth.token.get&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;authToken&#39;</span>)<span class="op">;</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Requester</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> token <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.token.get&#39;</span>)<span class="op">;</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Token:&#39;</span><span class="op">,</span> token)<span class="op">;</span></span></code></pre></div>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In PAN library</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PAN {</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">request</span>(topic<span class="op">,</span> data<span class="op">,</span> timeout <span class="op">=</span> <span class="dv">5000</span>) {</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> responseId <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">:</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Subscribe to response</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> unsubscribe <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:response:</span><span class="sc">${</span>responseId<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> (response) <span class="kw">=&gt;</span> {</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>        <span class="pp">clearTimeout</span>(timer)<span class="op">;</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>(response)<span class="op">;</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Set timeout</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> timer <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Request timeout: </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> timeout)<span class="op">;</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Publish request</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">publish</span>(<span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:request`</span><span class="op">,</span> {</span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>data<span class="op">,</span></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">_responseId</span><span class="op">:</span> responseId</span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">respond</span>(topic<span class="op">,</span> handler) {</span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">subscribe</span>(<span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:request`</span><span class="op">,</span> <span class="kw">async</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="fu">handler</span>(data)<span class="op">;</span></span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">publish</span>(<span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:response:</span><span class="sc">${</span>data<span class="op">.</span><span class="at">_responseId</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">publish</span>(<span class="vs">`</span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:response:</span><span class="sc">${</span>data<span class="op">.</span><span class="at">_responseId</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>          <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Need data from another component</li>
<li>Waiting for response is acceptable</li>
<li>Asynchronous operations</li>
</ul>
<h3 data-number="5.5.3" id="command-pattern"><span
class="header-section-number">5.5.3</span> 3. Command Pattern</h3>
<p>Issue commands that components execute:</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Command issuer</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;modal.open&#39;</span><span class="op">,</span> {</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">component</span><span class="op">:</span> <span class="st">&#39;user-profile&#39;</span><span class="op">,</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">props</span><span class="op">:</span> { <span class="dt">userId</span><span class="op">:</span> <span class="dv">123</span> }</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Command handler</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;modal.open&#39;</span><span class="op">,</span> ({ component<span class="op">,</span> props }) <span class="kw">=&gt;</span> {</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> modal <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;app-modal&#39;</span>)<span class="op">;</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>  modal<span class="op">.</span><span class="at">component</span> <span class="op">=</span> component<span class="op">;</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>  modal<span class="op">.</span><span class="at">props</span> <span class="op">=</span> props<span class="op">;</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(modal)<span class="op">;</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Triggering actions in other components</li>
<li>Implementing undo/redo</li>
<li>Building command palette UIs</li>
</ul>
<h3 data-number="5.5.4" id="event-sourcing"><span
class="header-section-number">5.5.4</span> 4. Event Sourcing</h3>
<p>Store events for replay or auditing:</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> eventStore <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Store all events</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  eventStore<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    topic<span class="op">,</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">,</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Replay events</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">replayEvents</span>(fromTimestamp) {</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  eventStore</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> <span class="bu">event</span><span class="op">.</span><span class="at">timestamp</span> <span class="op">&gt;=</span> fromTimestamp)</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forEach</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> {</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="bu">event</span><span class="op">.</span><span class="at">topic</span><span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Get events for debugging</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getEventHistory</span>(topic) {</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> eventStore<span class="op">.</span><span class="fu">filter</span>(<span class="bu">event</span> <span class="kw">=&gt;</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">event</span><span class="op">.</span><span class="at">topic</span> <span class="op">===</span> topic <span class="op">||</span> <span class="bu">event</span><span class="op">.</span><span class="at">topic</span><span class="op">.</span><span class="fu">startsWith</span>(topic <span class="op">+</span> <span class="st">&#39;.&#39;</span>)</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Debugging complex interactions</li>
<li>Implementing undo/redo</li>
<li>Auditing user actions</li>
<li>Syncing state across sessions</li>
</ul>
<h3 data-number="5.5.5" id="aggregation-pattern"><span
class="header-section-number">5.5.5</span> 5. Aggregation Pattern</h3>
<p>Collect multiple events before acting:</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataAggregator <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">pendingUpdates</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.item.updated&#39;</span><span class="op">,</span> ({ id }) <span class="kw">=&gt;</span> {</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pendingUpdates</span><span class="op">.</span><span class="fu">add</span>(id)<span class="op">;</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">scheduleRefresh</span>()<span class="op">;</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scheduleRefresh</span>() {</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span>)<span class="op">;</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">debounceTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">refreshItems</span>(<span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">pendingUpdates</span>))<span class="op">;</span></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">pendingUpdates</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">refreshItems</span>(ids) {</span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> items <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetchItems</span>(ids)<span class="op">;</span></span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(items)<span class="op">;</span></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Avoiding excessive updates</li>
<li>Batching API requests</li>
<li>Debouncing rapid events</li>
</ul>
<h3 data-number="5.5.6" id="saga-pattern"><span
class="header-section-number">5.5.6</span> 6. Saga Pattern</h3>
<p>Coordinate multi-step processes:</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutSaga {</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupListeners</span>()<span class="op">;</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupListeners</span>() {</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.started&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleCheckoutStart</span>)<span class="op">;</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;payment.completed&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handlePaymentComplete</span>)<span class="op">;</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;order.created&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleOrderCreated</span>)<span class="op">;</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>  handleCheckoutStart <span class="op">=</span> <span class="kw">async</span> ({ cart }) <span class="kw">=&gt;</span> {</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Step 1: Validate cart</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.validating&#39;</span><span class="op">,</span> { cart })<span class="op">;</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateCart</span>(cart)<span class="op">;</span></span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Step 2: Calculate totals</span></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.calculating&#39;</span><span class="op">,</span> { cart })<span class="op">;</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> totals <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculateTotals</span>(cart)<span class="op">;</span></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Step 3: Request payment</span></span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;payment.requested&#39;</span><span class="op">,</span> { totals })<span class="op">;</span></span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.failed&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-28"><a href="#cb140-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-29"><a href="#cb140-29" aria-hidden="true" tabindex="-1"></a>  handlePaymentComplete <span class="op">=</span> <span class="kw">async</span> ({ paymentId<span class="op">,</span> totals }) <span class="kw">=&gt;</span> {</span>
<span id="cb140-30"><a href="#cb140-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb140-31"><a href="#cb140-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Step 4: Create order</span></span>
<span id="cb140-32"><a href="#cb140-32" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.creating&#39;</span><span class="op">,</span> { paymentId })<span class="op">;</span></span>
<span id="cb140-33"><a href="#cb140-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> order <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">createOrder</span>(paymentId<span class="op">,</span> totals)<span class="op">;</span></span>
<span id="cb140-34"><a href="#cb140-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-35"><a href="#cb140-35" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.created&#39;</span><span class="op">,</span> { order })<span class="op">;</span></span>
<span id="cb140-36"><a href="#cb140-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb140-37"><a href="#cb140-37" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Compensating transaction: refund payment</span></span>
<span id="cb140-38"><a href="#cb140-38" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;payment.refund-requested&#39;</span><span class="op">,</span> { paymentId })<span class="op">;</span></span>
<span id="cb140-39"><a href="#cb140-39" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.failed&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb140-40"><a href="#cb140-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb140-41"><a href="#cb140-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-42"><a href="#cb140-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-43"><a href="#cb140-43" aria-hidden="true" tabindex="-1"></a>  handleOrderCreated <span class="op">=</span> <span class="kw">async</span> ({ order }) <span class="kw">=&gt;</span> {</span>
<span id="cb140-44"><a href="#cb140-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 5: Send confirmation</span></span>
<span id="cb140-45"><a href="#cb140-45" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.confirmation-sending&#39;</span><span class="op">,</span> { order })<span class="op">;</span></span>
<span id="cb140-46"><a href="#cb140-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">sendConfirmation</span>(order)<span class="op">;</span></span>
<span id="cb140-47"><a href="#cb140-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-48"><a href="#cb140-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Step 6: Complete checkout</span></span>
<span id="cb140-49"><a href="#cb140-49" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.completed&#39;</span><span class="op">,</span> { order })<span class="op">;</span></span>
<span id="cb140-50"><a href="#cb140-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb140-51"><a href="#cb140-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Use when:</strong></p>
<ul>
<li>Complex multi-step workflows</li>
<li>Need to handle failures and rollbacks</li>
<li>Coordinating multiple services</li>
</ul>
<h2 data-number="5.6" id="debugging-pan-communication"><span
class="header-section-number">5.6</span> Debugging PAN
Communication</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/05-pan-bus-10.png"
alt="Figure 5.7: PAN Bus Internal Architecture" />
<figcaption aria-hidden="true"><strong>Figure 5.7:</strong> PAN Bus
Internal Architecture</figcaption>
</figure>
<p>Debugging event-driven systems requires different techniques than
traditional debugging.</p>
<h3 data-number="5.6.1" id="logging-all-events"><span
class="header-section-number">5.6.1</span> Logging All Events</h3>
<div class="sourceCode" id="cb141"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Enable debug mode</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">debug</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Or manually subscribe to all events</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">group</span>(<span class="vs">`[PAN] </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Data:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Timestamp:&#39;</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>())<span class="op">;</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">trace</span>(<span class="st">&#39;Stack trace&#39;</span>)<span class="op">;</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">groupEnd</span>()<span class="op">;</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.6.2" id="event-inspector"><span
class="header-section-number">5.6.2</span> Event Inspector</h3>
<p>Build a visual event inspector:</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanInspector <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">events</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxEvents</span> <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logEvent</span>(topic<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logEvent</span>(topic<span class="op">,</span> data) {</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="fu">unshift</span>({</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>      topic<span class="op">,</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxEvents</span>) {</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        .pan-inspector {</span></span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          bottom: 0;</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 400px;</span></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 300px;</span></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ccc;</span></span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: auto;</span></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-family: monospace;</span></span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 12px;</span></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        .event {</span></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px;</span></span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #eee;</span></span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        .event:hover {</span></span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a><span class="vs">        .topic {</span></span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #667eea;</span></span>
<span id="cb142-58"><a href="#cb142-58" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-59"><a href="#cb142-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-60"><a href="#cb142-60" aria-hidden="true" tabindex="-1"></a><span class="vs">        .timestamp {</span></span>
<span id="cb142-61"><a href="#cb142-61" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #999;</span></span>
<span id="cb142-62"><a href="#cb142-62" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 10px;</span></span>
<span id="cb142-63"><a href="#cb142-63" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-64"><a href="#cb142-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-65"><a href="#cb142-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        .data {</span></span>
<span id="cb142-66"><a href="#cb142-66" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 4px;</span></span>
<span id="cb142-67"><a href="#cb142-67" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #333;</span></span>
<span id="cb142-68"><a href="#cb142-68" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb142-69"><a href="#cb142-69" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb142-70"><a href="#cb142-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-71"><a href="#cb142-71" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;pan-inspector&quot;&gt;</span></span>
<span id="cb142-72"><a href="#cb142-72" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;PAN Event Inspector&lt;/h3&gt;</span></span>
<span id="cb142-73"><a href="#cb142-73" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="fu">map</span>(<span class="bu">event</span> <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb142-74"><a href="#cb142-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;event&quot;&gt;</span></span>
<span id="cb142-75"><a href="#cb142-75" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;topic&quot;&gt;</span><span class="sc">${</span><span class="bu">event</span><span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb142-76"><a href="#cb142-76" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;timestamp&quot;&gt;</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(<span class="bu">event</span><span class="op">.</span><span class="at">timestamp</span>)<span class="op">.</span><span class="fu">toLocaleTimeString</span>()<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb142-77"><a href="#cb142-77" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;data&quot;&gt;</span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb142-78"><a href="#cb142-78" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb142-79"><a href="#cb142-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb142-80"><a href="#cb142-80" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb142-81"><a href="#cb142-81" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb142-82"><a href="#cb142-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb142-83"><a href="#cb142-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-84"><a href="#cb142-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-85"><a href="#cb142-85" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;pan-inspector&#39;</span><span class="op">,</span> PanInspector)<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.6.3" id="event-filtering"><span
class="header-section-number">5.6.3</span> Event Filtering</h3>
<p>Filter events for specific topics:</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">filterEvents</span>(pattern) {</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> regex <span class="op">=</span> <span class="kw">new</span> <span class="bu">RegExp</span>(pattern<span class="op">.</span><span class="fu">replace</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="st">&#39;.*&#39;</span>))<span class="op">;</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (regex<span class="op">.</span><span class="fu">test</span>(topic)) {</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[FILTERED] </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="fu">filterEvents</span>(<span class="st">&#39;user.*&#39;</span>)<span class="op">;</span>     <span class="co">// Only user events</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="fu">filterEvents</span>(<span class="st">&#39;*.error&#39;</span>)<span class="op">;</span>    <span class="co">// All error events</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="fu">filterEvents</span>(<span class="st">&#39;cart|order&#39;</span>)<span class="op">;</span> <span class="co">// Cart or order events</span></span></code></pre></div>
<h3 data-number="5.6.4" id="performance-monitoring"><span
class="header-section-number">5.6.4</span> Performance Monitoring</h3>
<p>Track event frequency and performance:</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanMonitor {</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stats</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic) <span class="kw">=&gt;</span> {</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> stat <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="fu">get</span>(topic) <span class="op">||</span> { <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">timestamps</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>      stat<span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>      stat<span class="op">.</span><span class="at">timestamps</span><span class="op">.</span><span class="fu">push</span>(<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>())<span class="op">;</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Keep only last 100 timestamps</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (stat<span class="op">.</span><span class="at">timestamps</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">100</span>) {</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>        stat<span class="op">.</span><span class="at">timestamps</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="fu">set</span>(topic<span class="op">,</span> stat)<span class="op">;</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getStats</span>(topic) {</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> stat <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="fu">get</span>(topic)<span class="op">;</span></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>stat) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> timestamps <span class="op">=</span> stat<span class="op">.</span><span class="at">timestamps</span><span class="op">;</span></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duration <span class="op">=</span> timestamps[timestamps<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">-</span> timestamps[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> frequency <span class="op">=</span> timestamps<span class="op">.</span><span class="at">length</span> <span class="op">/</span> (duration <span class="op">/</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>      topic<span class="op">,</span></span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">count</span><span class="op">:</span> stat<span class="op">.</span><span class="at">count</span><span class="op">,</span></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">frequency</span><span class="op">:</span> frequency<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">+</span> <span class="st">&#39; events/sec&#39;</span><span class="op">,</span></span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lastEvent</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>(timestamps[timestamps<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAllStats</span>() {</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> results <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="fu">forEach</span>((_<span class="op">,</span> topic) <span class="kw">=&gt;</span> {</span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>      results<span class="op">.</span><span class="fu">push</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getStats</span>(topic))<span class="op">;</span></span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> b<span class="op">.</span><span class="at">count</span> <span class="op">-</span> a<span class="op">.</span><span class="at">count</span>)<span class="op">;</span></span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reset</span>() {</span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-50"><a href="#cb144-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-51"><a href="#cb144-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb144-52"><a href="#cb144-52" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> monitor <span class="op">=</span> <span class="kw">new</span> <span class="fu">PanMonitor</span>()<span class="op">;</span></span>
<span id="cb144-53"><a href="#cb144-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-54"><a href="#cb144-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Later, check stats</span></span>
<span id="cb144-55"><a href="#cb144-55" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">table</span>(monitor<span class="op">.</span><span class="fu">getAllStats</span>())<span class="op">;</span></span></code></pre></div>
<h3 data-number="5.6.5" id="event-replay"><span
class="header-section-number">5.6.5</span> Event Replay</h3>
<p>Capture and replay events for testing:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EventRecorder {</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">recording</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">events</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">start</span>() {</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">recording</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">events</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">recording</span>) {</span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="fu">push</span>({ topic<span class="op">,</span> data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb145-15"><a href="#cb145-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb145-16"><a href="#cb145-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-17"><a href="#cb145-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-18"><a href="#cb145-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>() {</span>
<span id="cb145-19"><a href="#cb145-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">recording</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb145-20"><a href="#cb145-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span>) {</span>
<span id="cb145-21"><a href="#cb145-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb145-22"><a href="#cb145-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb145-23"><a href="#cb145-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-24"><a href="#cb145-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">events</span><span class="op">;</span></span>
<span id="cb145-25"><a href="#cb145-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-26"><a href="#cb145-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-27"><a href="#cb145-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replay</span>(events<span class="op">,</span> speed <span class="op">=</span> <span class="dv">1</span>) {</span>
<span id="cb145-28"><a href="#cb145-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>events <span class="op">||</span> events<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb145-29"><a href="#cb145-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-30"><a href="#cb145-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startTime <span class="op">=</span> events[<span class="dv">0</span>]<span class="op">.</span><span class="at">timestamp</span><span class="op">;</span></span>
<span id="cb145-31"><a href="#cb145-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-32"><a href="#cb145-32" aria-hidden="true" tabindex="-1"></a>    events<span class="op">.</span><span class="fu">forEach</span>((<span class="bu">event</span><span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb145-33"><a href="#cb145-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> delay <span class="op">=</span> (<span class="bu">event</span><span class="op">.</span><span class="at">timestamp</span> <span class="op">-</span> startTime) <span class="op">/</span> speed<span class="op">;</span></span>
<span id="cb145-34"><a href="#cb145-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-35"><a href="#cb145-35" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb145-36"><a href="#cb145-36" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="bu">event</span><span class="op">.</span><span class="at">topic</span><span class="op">,</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb145-37"><a href="#cb145-37" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb145-38"><a href="#cb145-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb145-39"><a href="#cb145-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-40"><a href="#cb145-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-41"><a href="#cb145-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(name) {</span>
<span id="cb145-42"><a href="#cb145-42" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="vs">`pan-recording-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">events</span>))<span class="op">;</span></span>
<span id="cb145-43"><a href="#cb145-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-44"><a href="#cb145-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-45"><a href="#cb145-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(name) {</span>
<span id="cb145-46"><a href="#cb145-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="vs">`pan-recording-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb145-47"><a href="#cb145-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data) <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb145-48"><a href="#cb145-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb145-49"><a href="#cb145-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-50"><a href="#cb145-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-51"><a href="#cb145-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb145-52"><a href="#cb145-52" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> recorder <span class="op">=</span> <span class="kw">new</span> <span class="fu">EventRecorder</span>()<span class="op">;</span></span>
<span id="cb145-53"><a href="#cb145-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-54"><a href="#cb145-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Start recording</span></span>
<span id="cb145-55"><a href="#cb145-55" aria-hidden="true" tabindex="-1"></a>recorder<span class="op">.</span><span class="fu">start</span>()<span class="op">;</span></span>
<span id="cb145-56"><a href="#cb145-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-57"><a href="#cb145-57" aria-hidden="true" tabindex="-1"></a><span class="co">// ... perform actions ...</span></span>
<span id="cb145-58"><a href="#cb145-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-59"><a href="#cb145-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Stop and save</span></span>
<span id="cb145-60"><a href="#cb145-60" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> events <span class="op">=</span> recorder<span class="op">.</span><span class="fu">stop</span>()<span class="op">;</span></span>
<span id="cb145-61"><a href="#cb145-61" aria-hidden="true" tabindex="-1"></a>recorder<span class="op">.</span><span class="fu">save</span>(<span class="st">&#39;my-test-scenario&#39;</span>)<span class="op">;</span></span>
<span id="cb145-62"><a href="#cb145-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-63"><a href="#cb145-63" aria-hidden="true" tabindex="-1"></a><span class="co">// Later, replay</span></span>
<span id="cb145-64"><a href="#cb145-64" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> events <span class="op">=</span> recorder<span class="op">.</span><span class="fu">load</span>(<span class="st">&#39;my-test-scenario&#39;</span>)<span class="op">;</span></span>
<span id="cb145-65"><a href="#cb145-65" aria-hidden="true" tabindex="-1"></a>recorder<span class="op">.</span><span class="fu">replay</span>(events<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span> <span class="co">// 2x speed</span></span></code></pre></div>
<h2 data-number="5.7" id="summary-4"><span
class="header-section-number">5.7</span> Summary</h2>
<p>This chapter covered:</p>
<ul>
<li><strong>Pub/Sub Architecture</strong>: Decoupled communication via
topics</li>
<li><strong>Topics and Namespaces</strong>: Organizing events with
hierarchical naming</li>
<li><strong>Publishing</strong>: Sending messages and event
patterns</li>
<li><strong>Subscribing</strong>: Receiving and filtering events</li>
<li><strong>Message Patterns</strong>: Fire-and-forget,
request/response, commands, sagas</li>
<li><strong>Debugging</strong>: Logging, inspection, monitoring, and
replay tools</li>
</ul>
<p>The PAN bus is central to LARC applications. Mastering it enables you
to build scalable, maintainable applications where components
collaborate without tight coupling.</p>
<hr />
<h2 data-number="5.8" id="best-practices-1"><span
class="header-section-number">5.8</span> Best Practices</h2>
<ol type="1">
<li><strong>Use descriptive topic names</strong>
<ul>
<li><code>user.profile.updated</code> not <code>userUpdated</code></li>
<li>Past tense for events that happened</li>
<li>Include context in message data</li>
</ul></li>
<li><strong>Clean up subscriptions</strong>
<ul>
<li>Always unsubscribe in <code>disconnectedCallback</code></li>
<li>Use subscription managers for multiple subscriptions</li>
<li>Avoid memory leaks</li>
</ul></li>
<li><strong>Avoid infinite loops</strong>
<ul>
<li>Don’t publish the same event you’re subscribed to</li>
<li>Use different topics for input and output</li>
<li>Add loop detection in debug mode</li>
</ul></li>
<li><strong>Keep handlers fast</strong>
<ul>
<li>Don’t block the event loop</li>
<li>Use async/await for long operations</li>
<li>Consider debouncing rapid events</li>
</ul></li>
<li><strong>Include metadata</strong>
<ul>
<li>Timestamp, source, user ID for debugging</li>
<li>Request IDs for tracing</li>
<li>Error details for failures</li>
</ul></li>
<li><strong>Test event flows</strong>
<ul>
<li>Use event recorders for integration tests</li>
<li>Mock pan.publish/subscribe in unit tests</li>
<li>Verify event contracts between components</li>
</ul></li>
</ol>
<hr />
<h2 data-number="5.9" id="further-reading-4"><span
class="header-section-number">5.9</span> Further Reading</h2>
<p><strong>For complete PAN bus API reference:</strong> - <em>Building
with LARC</em> Chapter 2: Core Concepts - Message bus architecture deep
dive - <em>Building with LARC</em> Appendix A: Message Topics Reference
- Standard topic conventions - <em>Building with LARC</em> Appendix B:
Event Envelope Specification - Message format details</p>
<div class="pagebreak">

</div>
<h1 data-number="6" id="state-management"><span
class="header-section-number">6</span> State Management</h1>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/06-state-management-3.png"
alt="Figure 6.1: State Management Hierarchy" />
<figcaption aria-hidden="true"><strong>Figure 6.1:</strong> State
Management Hierarchy</figcaption>
</figure>
<p>State management is one of the most critical aspects of application
development. Poor state management leads to bugs, performance issues,
and maintenance nightmares. Good state management makes applications
predictable, testable, and maintainable.</p>
<p>LARC takes a pragmatic approach: start simple and scale complexity
only when needed. This chapter explores state management at every level,
from component-local state to distributed, offline-first
architectures.</p>
<h2 data-number="6.1" id="component-local-state-1"><span
class="header-section-number">6.1</span> Component-Local State</h2>
<p>The simplest form of state lives entirely within a single component.
This is your first choice for most scenarios.</p>
<h3 data-number="6.1.1" id="instance-properties"><span
class="header-section-number">6.1.1</span> Instance Properties</h3>
<p>Use instance properties for component-specific state:</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ToggleSwitch <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Local state</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">isOn</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">isOn</span> <span class="op">=</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">isOn</span><span class="op">;</span>  <span class="co">// Update state</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span>            <span class="co">// Re-render</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Notify others</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;toggle&#39;</span><span class="op">,</span> {</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">detail</span><span class="op">:</span> { <span class="dt">isOn</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">isOn</span> }</span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">isOn</span> <span class="op">?</span> <span class="st">&#39;#48bb78&#39;</span> <span class="op">:</span> <span class="st">&#39;#cbd5e0&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px 16px;</span></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">isOn</span> <span class="op">?</span> <span class="st">&#39;ON&#39;</span> <span class="op">:</span> <span class="st">&#39;OFF&#39;</span><span class="sc">}</span><span class="vs">&lt;/button&gt;</span></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>When to use:</strong></p>
<ul>
<li>UI state (expanded/collapsed, selected, etc.)</li>
<li>Temporary values (search input, form drafts)</li>
<li>Component-specific configuration</li>
</ul>
<p><strong>Advantages:</strong></p>
<ul>
<li>Simple and straightforward</li>
<li>No dependencies on external state</li>
<li>Easy to reason about</li>
<li>Easy to test</li>
</ul>
<h3 data-number="6.1.2" id="private-fields"><span
class="header-section-number">6.1.2</span> Private Fields</h3>
<p>Use private fields (with <code>#</code>) for true encapsulation:</p>
<div class="sourceCode" id="cb147"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Private fields</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  #count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  #max <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  #min <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Public getter</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">count</span>() {</span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span>#<span class="at">count</span><span class="op">;</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Public setter with validation</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">count</span>(value) {</span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newCount <span class="op">=</span> <span class="bu">Number</span>(value)<span class="op">;</span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="pp">isNaN</span>(newCount)) {</span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Count must be a number&#39;</span>)<span class="op">;</span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (newCount <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span>#<span class="at">min</span> <span class="op">||</span> newCount <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span>#<span class="at">max</span>) {</span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Count must be between </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span>#<span class="at">min</span><span class="sc">}</span><span class="vs"> and </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span>#<span class="at">max</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>#<span class="at">count</span> <span class="op">=</span> newCount<span class="op">;</span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span>() {</span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="kw">this</span><span class="op">.</span>#<span class="at">count</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span>#<span class="at">max</span>)<span class="op">;</span></span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decrement</span>() {</span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="kw">this</span><span class="op">.</span>#<span class="at">count</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span>#<span class="at">min</span>)<span class="op">;</span></span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span>#<span class="at">count</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>True privacy (can’t access from outside)</li>
<li>Validation at setter boundaries</li>
<li>Clear public API</li>
</ul>
<h3 data-number="6.1.3" id="state-objects"><span
class="header-section-number">6.1.3</span> State Objects</h3>
<p>Organize related state in objects:</p>
<div class="sourceCode" id="cb148"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Group related state</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">editMode</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setState</span>(updates) {</span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Merge updates into state</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>updates</span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadUser</span>(userId) {</span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ <span class="dt">loading</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span> })<span class="op">;</span></span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ user<span class="op">,</span> <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span><span class="op">,</span> <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { user<span class="op">,</span> loading<span class="op">,</span> error<span class="op">,</span> editMode } <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">;</span></span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (loading) {</span>
<span id="cb148-42"><a href="#cb148-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div&gt;Loading...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb148-43"><a href="#cb148-43" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (error) {</span>
<span id="cb148-44"><a href="#cb148-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span>error<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb148-45"><a href="#cb148-45" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (user) {</span>
<span id="cb148-46"><a href="#cb148-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb148-47"><a href="#cb148-47" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div&gt;</span></span>
<span id="cb148-48"><a href="#cb148-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h2&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h2&gt;</span></span>
<span id="cb148-49"><a href="#cb148-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>editMode <span class="op">?</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderEditForm</span>() <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderDisplay</span>()<span class="sc">}</span></span>
<span id="cb148-50"><a href="#cb148-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb148-51"><a href="#cb148-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb148-52"><a href="#cb148-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb148-53"><a href="#cb148-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-54"><a href="#cb148-54" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Benefits:</strong></p>
<ul>
<li>Organized state structure</li>
<li>Single method to update state</li>
<li>Clear state shape</li>
<li>Easier debugging (log entire state)</li>
</ul>
<h2 data-number="6.2" id="shared-state-patterns"><span
class="header-section-number">6.2</span> Shared State Patterns</h2>
<p>When multiple components need access to the same data, you need
shared state.</p>
<h3 data-number="6.2.1" id="simple-global-state"><span
class="header-section-number">6.2.1</span> Simple Global State</h3>
<p>Create a shared state object:</p>
<div class="sourceCode" id="cb149"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/state.js</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> appState <span class="op">=</span> {</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">,</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">language</span><span class="op">:</span> <span class="st">&#39;en&#39;</span><span class="op">,</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">notifications</span><span class="op">:</span> []</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Update state</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">updateState</span>(updates) {</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(appState<span class="op">,</span> updates)<span class="op">;</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.state.changed&#39;</span><span class="op">,</span> appState)<span class="op">;</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Get state</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">getState</span>() {</span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> { <span class="op">...</span>appState }<span class="op">;</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage in components:</strong></p>
<div class="sourceCode" id="cb150"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { appState<span class="op">,</span> updateState } <span class="im">from</span> <span class="st">&#39;../lib/state.js&#39;</span><span class="op">;</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeSwitcher <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read initial state</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(appState<span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to changes</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;app.state.changed&#39;</span><span class="op">,</span> (state) <span class="kw">=&gt;</span> {</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(state<span class="op">.</span><span class="at">theme</span>)<span class="op">;</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add event listener</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> newTheme <span class="op">=</span> appState<span class="op">.</span><span class="at">theme</span> <span class="op">===</span> <span class="st">&#39;light&#39;</span> <span class="op">?</span> <span class="st">&#39;dark&#39;</span> <span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">;</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateState</span>({ <span class="dt">theme</span><span class="op">:</span> newTheme })<span class="op">;</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(theme) {</span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Theme: </span><span class="sc">${</span>theme<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="6.2.2" id="reactive-state-with-proxy"><span
class="header-section-number">6.2.2</span> Reactive State with
Proxy</h3>
<p>Make state changes automatically trigger updates:</p>
<div class="sourceCode" id="cb151"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/reactive-state.js</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">createReactiveState</span>(initialState) {</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> listeners <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> state <span class="op">=</span> <span class="kw">new</span> <span class="bu">Proxy</span>(initialState<span class="op">,</span> {</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span>(target<span class="op">,</span> property<span class="op">,</span> value) {</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> oldValue <span class="op">=</span> target[property]<span class="op">;</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>      target[property] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Notify listeners</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">forEach</span>(listener <span class="kw">=&gt;</span> {</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">listener</span>(property<span class="op">,</span> value<span class="op">,</span> oldValue)<span class="op">;</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Also publish via PAN</span></span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;state.changed&#39;</span><span class="op">,</span> {</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>        property<span class="op">,</span></span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>        value<span class="op">,</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>        oldValue</span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">get</span>(target<span class="op">,</span> property) {</span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> target[property]<span class="op">;</span></span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>    state<span class="op">,</span></span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subscribe</span>(listener) {</span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">add</span>(listener)<span class="op">;</span></span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> () <span class="kw">=&gt;</span> listeners<span class="op">.</span><span class="fu">delete</span>(listener)<span class="op">;</span></span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getState</span>() {</span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="op">...</span>state }<span class="op">;</span></span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-39"><a href="#cb151-39" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb151-40"><a href="#cb151-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create reactive state</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { state<span class="op">,</span> subscribe } <span class="op">=</span> <span class="fu">createReactiveState</span>({</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">count</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Components automatically react to changes</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CountDisplay <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to specific property changes</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> <span class="fu">subscribe</span>((property<span class="op">,</span> value) <span class="kw">=&gt;</span> {</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (property <span class="op">===</span> <span class="st">&#39;count&#39;</span>) {</span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Count: </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initial render</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`Count: </span><span class="sc">${</span>state<span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Update state (automatically triggers updates)</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>state<span class="op">.</span><span class="at">count</span><span class="op">++;</span>  <span class="co">// All subscribers notified</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>state<span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">42</span><span class="op">;</span>  <span class="co">// All subscribers notified</span></span></code></pre></div>
<h3 data-number="6.2.3" id="store-pattern"><span
class="header-section-number">6.2.3</span> Store Pattern</h3>
<p>Build a more sophisticated store:</p>
<div class="sourceCode" id="cb153"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/store.js</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Store {</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(initialState <span class="op">=</span> {}) {</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> initialState<span class="op">;</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">listeners</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">middleware</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getState</span>() {</span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span> }<span class="op">;</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setState</span>(updates) {</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> oldState <span class="op">=</span> { <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span> }<span class="op">;</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> { <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> <span class="op">...</span>updates }<span class="op">;</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Run middleware</span></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">middleware</span><span class="op">.</span><span class="fu">forEach</span>(fn <span class="kw">=&gt;</span> <span class="fu">fn</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> oldState))<span class="op">;</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Notify listeners</span></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">listeners</span><span class="op">.</span><span class="fu">forEach</span>((listeners<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (key <span class="op">===</span> <span class="st">&#39;*&#39;</span> <span class="op">||</span> key <span class="kw">in</span> updates) {</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>        listeners<span class="op">.</span><span class="fu">forEach</span>(listener <span class="kw">=&gt;</span> {</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">listener</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> oldState)<span class="op">;</span></span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span>(key<span class="op">,</span> listener) {</span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">listeners</span><span class="op">.</span><span class="fu">has</span>(key)) {</span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">listeners</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> <span class="kw">new</span> <span class="bu">Set</span>())<span class="op">;</span></span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">listeners</span><span class="op">.</span><span class="fu">get</span>(key)<span class="op">.</span><span class="fu">add</span>(listener)<span class="op">;</span></span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return unsubscribe function</span></span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> listeners <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">listeners</span><span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (listeners) {</span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>        listeners<span class="op">.</span><span class="fu">delete</span>(listener)<span class="op">;</span></span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-46"><a href="#cb153-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">use</span>(middleware) {</span>
<span id="cb153-47"><a href="#cb153-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">middleware</span><span class="op">.</span><span class="fu">push</span>(middleware)<span class="op">;</span></span>
<span id="cb153-48"><a href="#cb153-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-49"><a href="#cb153-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-50"><a href="#cb153-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dispatch</span>(action) {</span>
<span id="cb153-51"><a href="#cb153-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Action pattern: { type, payload }</span></span>
<span id="cb153-52"><a href="#cb153-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (action<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb153-53"><a href="#cb153-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;user/login&#39;</span><span class="op">:</span></span>
<span id="cb153-54"><a href="#cb153-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ <span class="dt">user</span><span class="op">:</span> action<span class="op">.</span><span class="at">payload</span> })<span class="op">;</span></span>
<span id="cb153-55"><a href="#cb153-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb153-56"><a href="#cb153-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;user/logout&#39;</span><span class="op">:</span></span>
<span id="cb153-57"><a href="#cb153-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span> })<span class="op">;</span></span>
<span id="cb153-58"><a href="#cb153-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb153-59"><a href="#cb153-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;theme/change&#39;</span><span class="op">:</span></span>
<span id="cb153-60"><a href="#cb153-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({ <span class="dt">theme</span><span class="op">:</span> action<span class="op">.</span><span class="at">payload</span> })<span class="op">;</span></span>
<span id="cb153-61"><a href="#cb153-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb153-62"><a href="#cb153-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb153-63"><a href="#cb153-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Unknown action: </span><span class="sc">${</span>action<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb153-64"><a href="#cb153-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-65"><a href="#cb153-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb153-66"><a href="#cb153-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb153-67"><a href="#cb153-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-68"><a href="#cb153-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Create store instance</span></span>
<span id="cb153-69"><a href="#cb153-69" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> store <span class="op">=</span> <span class="kw">new</span> <span class="fu">Store</span>({</span>
<span id="cb153-70"><a href="#cb153-70" aria-hidden="true" tabindex="-1"></a>  <span class="dt">user</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb153-71"><a href="#cb153-71" aria-hidden="true" tabindex="-1"></a>  <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">,</span></span>
<span id="cb153-72"><a href="#cb153-72" aria-hidden="true" tabindex="-1"></a>  <span class="dt">notifications</span><span class="op">:</span> []</span>
<span id="cb153-73"><a href="#cb153-73" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb153-74"><a href="#cb153-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-75"><a href="#cb153-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Add logging middleware</span></span>
<span id="cb153-76"><a href="#cb153-76" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">use</span>((state<span class="op">,</span> oldState) <span class="kw">=&gt;</span> {</span>
<span id="cb153-77"><a href="#cb153-77" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;State changed:&#39;</span><span class="op">,</span> { <span class="dt">old</span><span class="op">:</span> oldState<span class="op">,</span> <span class="kw">new</span><span class="op">:</span> state })<span class="op">;</span></span>
<span id="cb153-78"><a href="#cb153-78" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb153-79"><a href="#cb153-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-80"><a href="#cb153-80" aria-hidden="true" tabindex="-1"></a><span class="co">// Add persistence middleware</span></span>
<span id="cb153-81"><a href="#cb153-81" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">use</span>((state) <span class="kw">=&gt;</span> {</span>
<span id="cb153-82"><a href="#cb153-82" aria-hidden="true" tabindex="-1"></a>  localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;app-state&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(state))<span class="op">;</span></span>
<span id="cb153-83"><a href="#cb153-83" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { store } <span class="im">from</span> <span class="st">&#39;../lib/store.js&#39;</span><span class="op">;</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserMenu <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to user changes only</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribe</span> <span class="op">=</span> store<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user&#39;</span><span class="op">,</span> (state) <span class="kw">=&gt;</span> {</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(state<span class="op">.</span><span class="at">user</span>)<span class="op">;</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initial render</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(store<span class="op">.</span><span class="fu">getState</span>()<span class="op">.</span><span class="at">user</span>)<span class="op">;</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>()<span class="op">;</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(user) {</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (user) {</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div&gt;Hello, </span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;logout&quot;&gt;Logout&lt;/button&gt;</span></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#logout&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span><span class="fu">dispatch</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user/logout&#39;</span> })<span class="op">;</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;button id=&quot;login&quot;&gt;Login&lt;/button&gt;&#39;</span><span class="op">;</span></span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#login&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Trigger login flow</span></span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.login.requested&#39;</span>)<span class="op">;</span></span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.3" id="the-pan-store-component"><span
class="header-section-number">6.3</span> The pan-store Component</h2>
<figure>
<img
src="/Users/cdr/Projects/larc-repos/docs/books/learning-larc/build/images/06-state-management-9.png"
alt="Figure 6.2: pan-store Architecture" />
<figcaption aria-hidden="true"><strong>Figure 6.2:</strong> pan-store
Architecture</figcaption>
</figure>
<p>LARC provides a built-in component for state management:</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-store</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;app-store&quot;</span><span class="ot"> persist</span><span class="op">=</span><span class="st">&quot;true&quot;</span><span class="dt">&gt;</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Initial state --&gt;</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;application/json&quot;</span><span class="dt">&gt;</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;user&quot;</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;theme&quot;</span><span class="op">:</span> <span class="st">&quot;light&quot;</span><span class="op">,</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;cart&quot;</span><span class="op">:</span> {</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;items&quot;</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;total&quot;</span><span class="op">:</span> <span class="dv">0</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-store</span><span class="dt">&gt;</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;module&quot;</span><span class="dt">&gt;</span></span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> store <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app-store&#39;</span>)<span class="op">;</span></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get state</span></span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> state <span class="op">=</span> store<span class="op">.</span><span class="fu">getState</span>()<span class="op">;</span></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Update state</span></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>  store<span class="op">.</span><span class="fu">setState</span>({ <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;dark&#39;</span> })<span class="op">;</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Subscribe to changes</span></span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>  store<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;state-changed&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;State changed:&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Or use PAN bus</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;store.changed&#39;</span><span class="op">,</span> (state) <span class="kw">=&gt;</span> {</span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;State via PAN:&#39;</span><span class="op">,</span> state)<span class="op">;</span></span>
<span id="cb155-32"><a href="#cb155-32" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb155-33"><a href="#cb155-33" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Features:</strong></p>
<ul>
<li>Declarative state initialization</li>
<li>Optional persistence to localStorage</li>
<li>Integrates with PAN bus</li>
<li>Supports nested state updates</li>
<li>Time-travel debugging in dev mode</li>
</ul>
<p><strong>Advanced usage:</strong></p>
<div class="sourceCode" id="cb156"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get nested state</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cartItems <span class="op">=</span> store<span class="op">.</span><span class="fu">getState</span>(<span class="st">&#39;cart.items&#39;</span>)<span class="op">;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Update nested state</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">setState</span>(<span class="st">&#39;cart.items&#39;</span><span class="op">,</span> [<span class="op">...</span>items<span class="op">,</span> newItem])<span class="op">;</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscribe to specific paths</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.total&#39;</span><span class="op">,</span> (value) <span class="kw">=&gt;</span> {</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Cart total changed:&#39;</span><span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Computed properties</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">computed</span>(<span class="st">&#39;cart.itemCount&#39;</span><span class="op">,</span> (state) <span class="kw">=&gt;</span> {</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> state<span class="op">.</span><span class="at">cart</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span><span class="op">;</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Actions</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">action</span>(<span class="st">&#39;addToCart&#39;</span><span class="op">,</span> (item) <span class="kw">=&gt;</span> {</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cart <span class="op">=</span> store<span class="op">.</span><span class="fu">getState</span>(<span class="st">&#39;cart&#39;</span>)<span class="op">;</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> items <span class="op">=</span> [<span class="op">...</span>cart<span class="op">.</span><span class="at">items</span><span class="op">,</span> item]<span class="op">;</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> total <span class="op">=</span> items<span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">price</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>  store<span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;cart.items&#39;</span><span class="op">:</span> items<span class="op">,</span></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;cart.total&#39;</span><span class="op">:</span> total</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Use action</span></span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>store<span class="op">.</span><span class="fu">dispatch</span>(<span class="st">&#39;addToCart&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Product&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="fl">29.99</span> })<span class="op">;</span></span></code></pre></div>
<h2 data-number="6.4" id="indexeddb-integration"><span
class="header-section-number">6.4</span> IndexedDB Integration</h2>
<p>For large datasets or offline capability, use IndexedDB:</p>
<h3 data-number="6.4.1" id="basic-indexeddb-wrapper"><span
class="header-section-number">6.4.1</span> Basic IndexedDB Wrapper</h3>
<div class="sourceCode" id="cb157"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/db.js</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database {</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(name<span class="op">,</span> version <span class="op">=</span> <span class="dv">1</span>) {</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">version</span> <span class="op">=</span> version<span class="op">;</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">open</span>(stores) {</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> indexedDB<span class="op">.</span><span class="fu">open</span>(<span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">version</span>)<span class="op">;</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> request<span class="op">.</span><span class="at">result</span><span class="op">;</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>(<span class="kw">this</span><span class="op">.</span><span class="at">db</span>)<span class="op">;</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onupgradeneeded</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> db <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">result</span><span class="op">;</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>        stores<span class="op">.</span><span class="fu">forEach</span>(({ name<span class="op">,</span> keyPath<span class="op">,</span> indexes }) <span class="kw">=&gt;</span> {</span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="op">!</span>db<span class="op">.</span><span class="at">objectStoreNames</span><span class="op">.</span><span class="fu">contains</span>(name)) {</span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> store <span class="op">=</span> db<span class="op">.</span><span class="fu">createObjectStore</span>(name<span class="op">,</span> { keyPath })<span class="op">;</span></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a>            indexes<span class="op">?.</span><span class="fu">forEach</span>(({ name<span class="op">,</span> keyPath<span class="op">,</span> options }) <span class="kw">=&gt;</span> {</span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>              store<span class="op">.</span><span class="fu">createIndex</span>(name<span class="op">,</span> keyPath<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">add</span>(storeName<span class="op">,</span> data) {</span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readwrite&#39;</span>)<span class="op">;</span></span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-40"><a href="#cb157-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">add</span>(data)<span class="op">;</span></span>
<span id="cb157-41"><a href="#cb157-41" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-42"><a href="#cb157-42" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-43"><a href="#cb157-43" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-44"><a href="#cb157-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-45"><a href="#cb157-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-46"><a href="#cb157-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">get</span>(storeName<span class="op">,</span> key) {</span>
<span id="cb157-47"><a href="#cb157-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readonly&#39;</span>)<span class="op">;</span></span>
<span id="cb157-48"><a href="#cb157-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-49"><a href="#cb157-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-50"><a href="#cb157-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-51"><a href="#cb157-51" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb157-52"><a href="#cb157-52" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-53"><a href="#cb157-53" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-54"><a href="#cb157-54" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-55"><a href="#cb157-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-56"><a href="#cb157-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-57"><a href="#cb157-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getAll</span>(storeName) {</span>
<span id="cb157-58"><a href="#cb157-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readonly&#39;</span>)<span class="op">;</span></span>
<span id="cb157-59"><a href="#cb157-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-60"><a href="#cb157-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-61"><a href="#cb157-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-62"><a href="#cb157-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb157-63"><a href="#cb157-63" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-64"><a href="#cb157-64" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-65"><a href="#cb157-65" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-66"><a href="#cb157-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-67"><a href="#cb157-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-68"><a href="#cb157-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">update</span>(storeName<span class="op">,</span> data) {</span>
<span id="cb157-69"><a href="#cb157-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readwrite&#39;</span>)<span class="op">;</span></span>
<span id="cb157-70"><a href="#cb157-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-71"><a href="#cb157-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-72"><a href="#cb157-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-73"><a href="#cb157-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">put</span>(data)<span class="op">;</span></span>
<span id="cb157-74"><a href="#cb157-74" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-75"><a href="#cb157-75" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-76"><a href="#cb157-76" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-77"><a href="#cb157-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-78"><a href="#cb157-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-79"><a href="#cb157-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">delete</span>(storeName<span class="op">,</span> key) {</span>
<span id="cb157-80"><a href="#cb157-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readwrite&#39;</span>)<span class="op">;</span></span>
<span id="cb157-81"><a href="#cb157-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-82"><a href="#cb157-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-83"><a href="#cb157-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-84"><a href="#cb157-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">delete</span>(key)<span class="op">;</span></span>
<span id="cb157-85"><a href="#cb157-85" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-86"><a href="#cb157-86" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-87"><a href="#cb157-87" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-88"><a href="#cb157-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-89"><a href="#cb157-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-90"><a href="#cb157-90" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">clear</span>(storeName) {</span>
<span id="cb157-91"><a href="#cb157-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">transaction</span>(storeName<span class="op">,</span> <span class="st">&#39;readwrite&#39;</span>)<span class="op">;</span></span>
<span id="cb157-92"><a href="#cb157-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> store <span class="op">=</span> tx<span class="op">.</span><span class="fu">objectStore</span>(storeName)<span class="op">;</span></span>
<span id="cb157-93"><a href="#cb157-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-94"><a href="#cb157-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb157-95"><a href="#cb157-95" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> request <span class="op">=</span> store<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb157-96"><a href="#cb157-96" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onsuccess</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">resolve</span>(request<span class="op">.</span><span class="at">result</span>)<span class="op">;</span></span>
<span id="cb157-97"><a href="#cb157-97" aria-hidden="true" tabindex="-1"></a>      request<span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">reject</span>(request<span class="op">.</span><span class="at">error</span>)<span class="op">;</span></span>
<span id="cb157-98"><a href="#cb157-98" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb157-99"><a href="#cb157-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-100"><a href="#cb157-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-101"><a href="#cb157-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-102"><a href="#cb157-102" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize database</span></span>
<span id="cb157-103"><a href="#cb157-103" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;MyApp&#39;</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb157-104"><a href="#cb157-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-105"><a href="#cb157-105" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> db<span class="op">.</span><span class="fu">open</span>([</span>
<span id="cb157-106"><a href="#cb157-106" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb157-107"><a href="#cb157-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;todos&#39;</span><span class="op">,</span></span>
<span id="cb157-108"><a href="#cb157-108" aria-hidden="true" tabindex="-1"></a>    <span class="dt">keyPath</span><span class="op">:</span> <span class="st">&#39;id&#39;</span><span class="op">,</span></span>
<span id="cb157-109"><a href="#cb157-109" aria-hidden="true" tabindex="-1"></a>    <span class="dt">indexes</span><span class="op">:</span> [</span>
<span id="cb157-110"><a href="#cb157-110" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;by-status&#39;</span><span class="op">,</span> <span class="dt">keyPath</span><span class="op">:</span> <span class="st">&#39;status&#39;</span> }<span class="op">,</span></span>
<span id="cb157-111"><a href="#cb157-111" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;by-created&#39;</span><span class="op">,</span> <span class="dt">keyPath</span><span class="op">:</span> <span class="st">&#39;createdAt&#39;</span> }</span>
<span id="cb157-112"><a href="#cb157-112" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb157-113"><a href="#cb157-113" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb157-114"><a href="#cb157-114" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb157-115"><a href="#cb157-115" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;users&#39;</span><span class="op">,</span></span>
<span id="cb157-116"><a href="#cb157-116" aria-hidden="true" tabindex="-1"></a>    <span class="dt">keyPath</span><span class="op">:</span> <span class="st">&#39;id&#39;</span></span>
<span id="cb157-117"><a href="#cb157-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-118"><a href="#cb157-118" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb158"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { db } <span class="im">from</span> <span class="st">&#39;../lib/db.js&#39;</span><span class="op">;</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load todos from IndexedDB</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="st">&#39;todos&#39;</span>)<span class="op">;</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to changes</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;todo.added&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ todo }) <span class="kw">=&gt;</span> {</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> db<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> todo)<span class="op">;</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="st">&#39;todos&#39;</span>)<span class="op">;</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;todo.updated&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ todo }) <span class="kw">=&gt;</span> {</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> db<span class="op">.</span><span class="fu">update</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> todo)<span class="op">;</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="st">&#39;todos&#39;</span>)<span class="op">;</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;todo.deleted&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ id }) <span class="kw">=&gt;</span> {</span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> db<span class="op">.</span><span class="fu">delete</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> id)<span class="op">;</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="st">&#39;todos&#39;</span>)<span class="op">;</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;ul&gt;</span></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">map</span>(todo <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;li&gt;</span></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span&gt;</span><span class="sc">${</span>todo<span class="op">.</span><span class="at">text</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;button data-id=&quot;</span><span class="sc">${</span>todo<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;&gt;Delete&lt;/button&gt;</span></span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/li&gt;</span></span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/ul&gt;</span></span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="6.4.2" id="cache-first-strategy"><span
class="header-section-number">6.4.2</span> Cache-First Strategy</h3>
<p>Implement cache-first data loading:</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataManager {</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(storeName) {</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">storeName</span> <span class="op">=</span> storeName<span class="op">;</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">get</span>(id) {</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Check memory cache</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">has</span>(id)) {</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(id)<span class="op">;</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Check IndexedDB</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">get</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span><span class="op">,</span> id)<span class="op">;</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached) {</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> cached)<span class="op">;</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cached<span class="op">;</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. Fetch from API</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchFromAPI</span>(id)<span class="op">;</span></span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. Store in cache and IndexedDB</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">add</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetchFromAPI</span>(id) {</span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">storeName</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">refresh</span>(id) {</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Force refresh from API</span></span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchFromAPI</span>(id)<span class="op">;</span></span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update cache and IndexedDB</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(id<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">update</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getAll</span>() {</span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load from IndexedDB first</span></span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> items <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="kw">this</span><span class="op">.</span><span class="at">storeName</span>)<span class="op">;</span></span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cache in memory</span></span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(item<span class="op">.</span><span class="at">id</span><span class="op">,</span> item)<span class="op">;</span></span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> items<span class="op">;</span></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">DataManager</span>(<span class="st">&#39;users&#39;</span>)<span class="op">;</span></span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a><span class="co">// Always returns fast (from cache if available)</span></span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> userManager<span class="op">.</span><span class="fu">get</span>(<span class="dv">123</span>)<span class="op">;</span></span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a><span class="co">// Force refresh</span></span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> freshUser <span class="op">=</span> <span class="cf">await</span> userManager<span class="op">.</span><span class="fu">refresh</span>(<span class="dv">123</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="6.5" id="persistence-strategies"><span
class="header-section-number">6.5</span> Persistence Strategies</h2>
<h3 data-number="6.5.1" id="localstorage"><span
class="header-section-number">6.5.1</span> localStorage</h3>
<p>Simple key-value storage:</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PersistentState {</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(key) {</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">key</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">load</span>()<span class="op">;</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>() {</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data) <span class="op">:</span> {}<span class="op">;</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load state:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {}<span class="op">;</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>() {</span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span>))<span class="op">;</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to save state:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(path) {</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getNestedValue</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> path)<span class="op">;</span></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(path<span class="op">,</span> value) {</span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setNestedValue</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span> path<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">save</span>()<span class="op">;</span></span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getNestedValue</span>(obj<span class="op">,</span> path) {</span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">.</span><span class="fu">reduce</span>((current<span class="op">,</span> key) <span class="kw">=&gt;</span> current<span class="op">?.</span>[key]<span class="op">,</span> obj)<span class="op">;</span></span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNestedValue</span>(obj<span class="op">,</span> path<span class="op">,</span> value) {</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> keys <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">;</span></span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lastKey <span class="op">=</span> keys<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> target <span class="op">=</span> keys<span class="op">.</span><span class="fu">reduce</span>((current<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>(key <span class="kw">in</span> current)) current[key] <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> current[key]<span class="op">;</span></span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> obj)<span class="op">;</span></span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>    target[lastKey] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clear</span>() {</span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> settings <span class="op">=</span> <span class="kw">new</span> <span class="fu">PersistentState</span>(<span class="st">&#39;app-settings&#39;</span>)<span class="op">;</span></span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>settings<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> <span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>settings<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;user.preferences.notifications&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(settings<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;theme&#39;</span>))<span class="op">;</span>  <span class="co">// &#39;dark&#39;</span></span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(settings<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;user.preferences.notifications&#39;</span>))<span class="op">;</span>  <span class="co">// true</span></span></code></pre></div>
<h3 data-number="6.5.2" id="sessionstorage"><span
class="header-section-number">6.5.2</span> sessionStorage</h3>
<p>For temporary session data:</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionState {</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(key) {</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">key</span> <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(data) {</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>    sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data))<span class="op">;</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>() {</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> sessionStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data) <span class="op">:</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clear</span>() {</span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>    sessionStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage - data persists only for the session</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sessionData <span class="op">=</span> <span class="kw">new</span> <span class="fu">SessionState</span>(<span class="st">&#39;form-draft&#39;</span>)<span class="op">;</span></span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Save form draft</span></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>sessionData<span class="op">.</span><span class="fu">set</span>({ <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;user@example.com&#39;</span><span class="op">,</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Draft...&#39;</span> })<span class="op">;</span></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Restore on page reload (same session)</span></span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> draft <span class="op">=</span> sessionData<span class="op">.</span><span class="fu">get</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.5.3" id="hybrid-strategy"><span
class="header-section-number">6.5.3</span> Hybrid Strategy</h3>
<p>Combine localStorage and IndexedDB:</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HybridStorage {</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(namespace) {</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">namespace</span> <span class="op">=</span> namespace<span class="op">;</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">set</span>(key<span class="op">,</span> value) {</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fullKey <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">namespace</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store small data in localStorage</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">isSmall</span>(value)) {</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(fullKey<span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(value))<span class="op">;</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Store large data in IndexedDB</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> db<span class="op">.</span><span class="fu">update</span>(<span class="st">&#39;storage&#39;</span><span class="op">,</span> { <span class="dt">key</span><span class="op">:</span> fullKey<span class="op">,</span> value })<span class="op">;</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">get</span>(key) {</span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> fullKey <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">namespace</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try localStorage first</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> local <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(fullKey)<span class="op">;</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (local) {</span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(local)<span class="op">;</span></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try IndexedDB</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;storage&#39;</span><span class="op">,</span> fullKey)<span class="op">;</span></span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">?.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isSmall</span>(value) {</span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> str <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(value)<span class="op">;</span></span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> str<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">10</span><span class="op">;</span> <span class="co">// 10KB threshold</span></span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">clear</span>() {</span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear localStorage items</span></span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(localStorage)<span class="op">.</span><span class="fu">forEach</span>(key <span class="kw">=&gt;</span> {</span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (key<span class="op">.</span><span class="fu">startsWith</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">namespace</span><span class="sc">}</span><span class="vs">:`</span>)) {</span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a>        localStorage<span class="op">.</span><span class="fu">removeItem</span>(key)<span class="op">;</span></span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear IndexedDB items</span></span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> all <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">getAll</span>(<span class="st">&#39;storage&#39;</span>)<span class="op">;</span></span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> item <span class="kw">of</span> all) {</span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (item<span class="op">.</span><span class="at">key</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">namespace</span><span class="sc">}</span><span class="vs">:`</span>)) {</span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> db<span class="op">.</span><span class="fu">delete</span>(<span class="st">&#39;storage&#39;</span><span class="op">,</span> item<span class="op">.</span><span class="at">key</span>)<span class="op">;</span></span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-53"><a href="#cb162-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.6" id="offline-first-applications"><span
class="header-section-number">6.6</span> Offline-First Applications</h2>
<p>Build applications that work without connectivity:</p>
<h3 data-number="6.6.1" id="service-worker-state-management"><span
class="header-section-number">6.6.1</span> Service Worker + State
Management</h3>
<div class="sourceCode" id="cb163"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co">// sw.js - Service Worker</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;install&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">waitUntil</span>(</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">open</span>(<span class="st">&#39;v1&#39;</span>)<span class="op">.</span><span class="fu">then</span>((cache) <span class="kw">=&gt;</span> {</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cache<span class="op">.</span><span class="fu">addAll</span>([</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/&#39;</span><span class="op">,</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/index.html&#39;</span><span class="op">,</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/src/app.js&#39;</span><span class="op">,</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;/&#39;</span><span class="op">,</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cache critical assets</span></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>      ])<span class="op">;</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;fetch&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">respondWith</span>(</span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">match</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>)<span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Return cached version or fetch</span></span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response <span class="op">||</span> <span class="fu">fetch</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>)<span class="op">;</span></span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="6.6.2" id="sync-queue"><span
class="header-section-number">6.6.2</span> Sync Queue</h3>
<p>Queue operations when offline:</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/sync-queue.js</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyncQueue {</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">queue</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadQueue</span>()<span class="op">;</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">processing</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for online events</span></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;online&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">process</span>()<span class="op">;</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start processing if online</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span>) {</span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">process</span>()<span class="op">;</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loadQueue</span>() {</span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;sync-queue&#39;</span>)<span class="op">;</span></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data <span class="op">?</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data) <span class="op">:</span> []<span class="op">;</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveQueue</span>() {</span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;sync-queue&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">queue</span>))<span class="op">;</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add</span>(operation) {</span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="op">,</span></span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a>      operation<span class="op">,</span></span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">attempts</span><span class="op">:</span> <span class="dv">0</span></span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">saveQueue</span>()<span class="op">;</span></span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span>) {</span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">process</span>()<span class="op">;</span></span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="bu">process</span>() {</span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">processing</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">processing</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb164-48"><a href="#cb164-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-49"><a href="#cb164-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (<span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span>) {</span>
<span id="cb164-50"><a href="#cb164-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> item <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">queue</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb164-51"><a href="#cb164-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-52"><a href="#cb164-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb164-53"><a href="#cb164-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">executeOperation</span>(item<span class="op">.</span><span class="at">operation</span>)<span class="op">;</span></span>
<span id="cb164-54"><a href="#cb164-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-55"><a href="#cb164-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Success - remove from queue</span></span>
<span id="cb164-56"><a href="#cb164-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb164-57"><a href="#cb164-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">saveQueue</span>()<span class="op">;</span></span>
<span id="cb164-58"><a href="#cb164-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-59"><a href="#cb164-59" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sync.success&#39;</span><span class="op">,</span> { <span class="dt">operation</span><span class="op">:</span> item<span class="op">.</span><span class="at">operation</span> })<span class="op">;</span></span>
<span id="cb164-60"><a href="#cb164-60" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb164-61"><a href="#cb164-61" aria-hidden="true" tabindex="-1"></a>        item<span class="op">.</span><span class="at">attempts</span><span class="op">++;</span></span>
<span id="cb164-62"><a href="#cb164-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-63"><a href="#cb164-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (item<span class="op">.</span><span class="at">attempts</span> <span class="op">&gt;=</span> <span class="dv">3</span>) {</span>
<span id="cb164-64"><a href="#cb164-64" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Max attempts - remove and report error</span></span>
<span id="cb164-65"><a href="#cb164-65" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb164-66"><a href="#cb164-66" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">saveQueue</span>()<span class="op">;</span></span>
<span id="cb164-67"><a href="#cb164-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-68"><a href="#cb164-68" aria-hidden="true" tabindex="-1"></a>          pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sync.failed&#39;</span><span class="op">,</span> {</span>
<span id="cb164-69"><a href="#cb164-69" aria-hidden="true" tabindex="-1"></a>            <span class="dt">operation</span><span class="op">:</span> item<span class="op">.</span><span class="at">operation</span><span class="op">,</span></span>
<span id="cb164-70"><a href="#cb164-70" aria-hidden="true" tabindex="-1"></a>            <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb164-71"><a href="#cb164-71" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb164-72"><a href="#cb164-72" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb164-73"><a href="#cb164-73" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Retry later</span></span>
<span id="cb164-74"><a href="#cb164-74" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb164-75"><a href="#cb164-75" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb164-76"><a href="#cb164-76" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb164-77"><a href="#cb164-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb164-78"><a href="#cb164-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-79"><a href="#cb164-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">processing</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb164-80"><a href="#cb164-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-81"><a href="#cb164-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-82"><a href="#cb164-82" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">executeOperation</span>(operation) {</span>
<span id="cb164-83"><a href="#cb164-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (operation<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb164-84"><a href="#cb164-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;CREATE&#39;</span><span class="op">:</span></span>
<span id="cb164-85"><a href="#cb164-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">create</span>(operation<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb164-86"><a href="#cb164-86" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;UPDATE&#39;</span><span class="op">:</span></span>
<span id="cb164-87"><a href="#cb164-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">update</span>(operation<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb164-88"><a href="#cb164-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;DELETE&#39;</span><span class="op">:</span></span>
<span id="cb164-89"><a href="#cb164-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">delete</span>(operation<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb164-90"><a href="#cb164-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb164-91"><a href="#cb164-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Unknown operation: </span><span class="sc">${</span>operation<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb164-92"><a href="#cb164-92" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb164-93"><a href="#cb164-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-94"><a href="#cb164-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-95"><a href="#cb164-95" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">create</span>(data) {</span>
<span id="cb164-96"><a href="#cb164-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/items&#39;</span><span class="op">,</span> {</span>
<span id="cb164-97"><a href="#cb164-97" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb164-98"><a href="#cb164-98" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb164-99"><a href="#cb164-99" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb164-100"><a href="#cb164-100" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-101"><a href="#cb164-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-102"><a href="#cb164-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Create failed&#39;</span>)<span class="op">;</span></span>
<span id="cb164-103"><a href="#cb164-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb164-104"><a href="#cb164-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-105"><a href="#cb164-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-106"><a href="#cb164-106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">update</span>(data) {</span>
<span id="cb164-107"><a href="#cb164-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/items/</span><span class="sc">${</span>data<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb164-108"><a href="#cb164-108" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;PUT&#39;</span><span class="op">,</span></span>
<span id="cb164-109"><a href="#cb164-109" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb164-110"><a href="#cb164-110" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb164-111"><a href="#cb164-111" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-112"><a href="#cb164-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-113"><a href="#cb164-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Update failed&#39;</span>)<span class="op">;</span></span>
<span id="cb164-114"><a href="#cb164-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb164-115"><a href="#cb164-115" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-116"><a href="#cb164-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-117"><a href="#cb164-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">delete</span>(id) {</span>
<span id="cb164-118"><a href="#cb164-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/items/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb164-119"><a href="#cb164-119" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;DELETE&#39;</span></span>
<span id="cb164-120"><a href="#cb164-120" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb164-121"><a href="#cb164-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-122"><a href="#cb164-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Delete failed&#39;</span>)<span class="op">;</span></span>
<span id="cb164-123"><a href="#cb164-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-124"><a href="#cb164-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-125"><a href="#cb164-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clear</span>() {</span>
<span id="cb164-126"><a href="#cb164-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">queue</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb164-127"><a href="#cb164-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">saveQueue</span>()<span class="op">;</span></span>
<span id="cb164-128"><a href="#cb164-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-129"><a href="#cb164-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-130"><a href="#cb164-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getStatus</span>() {</span>
<span id="cb164-131"><a href="#cb164-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb164-132"><a href="#cb164-132" aria-hidden="true" tabindex="-1"></a>      <span class="dt">queued</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">queue</span><span class="op">.</span><span class="at">length</span><span class="op">,</span></span>
<span id="cb164-133"><a href="#cb164-133" aria-hidden="true" tabindex="-1"></a>      <span class="dt">online</span><span class="op">:</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span><span class="op">,</span></span>
<span id="cb164-134"><a href="#cb164-134" aria-hidden="true" tabindex="-1"></a>      <span class="dt">processing</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">processing</span></span>
<span id="cb164-135"><a href="#cb164-135" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb164-136"><a href="#cb164-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb164-137"><a href="#cb164-137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb164-138"><a href="#cb164-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-139"><a href="#cb164-139" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> syncQueue <span class="op">=</span> <span class="kw">new</span> <span class="fu">SyncQueue</span>()<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb165"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { syncQueue } <span class="im">from</span> <span class="st">&#39;../lib/sync-queue.js&#39;</span><span class="op">;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoManager {</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">addTodo</span>(text) {</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> todo <span class="op">=</span> {</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>      text<span class="op">,</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">completed</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save locally immediately</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> todo)<span class="op">;</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;todo.added&#39;</span><span class="op">,</span> { todo })<span class="op">;</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Queue for server sync</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="bu">navigator</span><span class="op">.</span><span class="at">onLine</span>) {</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>      syncQueue<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;CREATE&#39;</span><span class="op">,</span></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> todo</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.info&#39;</span><span class="op">,</span> {</span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Saved locally. Will sync when online.&#39;</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Online - sync immediately</span></span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">syncToServer</span>(todo)<span class="op">;</span></span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Failed - add to queue</span></span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>        syncQueue<span class="op">.</span><span class="fu">add</span>({</span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>          <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;CREATE&#39;</span><span class="op">,</span></span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a>          <span class="dt">data</span><span class="op">:</span> todo</span>
<span id="cb165-35"><a href="#cb165-35" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb165-36"><a href="#cb165-36" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-37"><a href="#cb165-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-38"><a href="#cb165-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb165-39"><a href="#cb165-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-40"><a href="#cb165-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">syncToServer</span>(todo) {</span>
<span id="cb165-41"><a href="#cb165-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/todos&#39;</span><span class="op">,</span> {</span>
<span id="cb165-42"><a href="#cb165-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb165-43"><a href="#cb165-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb165-44"><a href="#cb165-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(todo)</span>
<span id="cb165-45"><a href="#cb165-45" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb165-46"><a href="#cb165-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-47"><a href="#cb165-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb165-48"><a href="#cb165-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Sync failed&#39;</span>)<span class="op">;</span></span>
<span id="cb165-49"><a href="#cb165-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-50"><a href="#cb165-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-51"><a href="#cb165-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb165-52"><a href="#cb165-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-53"><a href="#cb165-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update local copy with server ID</span></span>
<span id="cb165-54"><a href="#cb165-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">update</span>(<span class="st">&#39;todos&#39;</span><span class="op">,</span> { <span class="op">...</span>todo<span class="op">,</span> <span class="dt">serverId</span><span class="op">:</span> result<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb165-55"><a href="#cb165-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb165-56"><a href="#cb165-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="6.7" id="summary-5"><span
class="header-section-number">6.7</span> Summary</h2>
<p>This chapter covered state management at every level:</p>
<ul>
<li><strong>Component-Local State</strong>: Instance properties, private
fields, and state objects</li>
<li><strong>Shared State</strong>: Global state, reactive proxies, and
store patterns</li>
<li><strong>pan-store</strong>: Built-in state management component</li>
<li><strong>IndexedDB</strong>: Large dataset storage and offline
capability</li>
<li><strong>Persistence</strong>: localStorage, sessionStorage, and
hybrid strategies</li>
<li><strong>Offline-First</strong>: Service workers, sync queues, and
conflict resolution</li>
</ul>
<p>Choose the simplest solution that meets your needs, then scale up
complexity as requirements grow.</p>
<hr />
<h2 data-number="6.8" id="best-practices-2"><span
class="header-section-number">6.8</span> Best Practices</h2>
<ol type="1">
<li><strong>Start with local state</strong>
<ul>
<li>Only share state when necessary</li>
<li>Keeps components independent</li>
<li>Easier to test and debug</li>
</ul></li>
<li><strong>Use IndexedDB for large data</strong>
<ul>
<li>localStorage limited to ~5-10MB</li>
<li>IndexedDB can store gigabytes</li>
<li>Better performance for large datasets</li>
</ul></li>
<li><strong>Implement cache-first strategies</strong>
<ul>
<li>Load from cache immediately</li>
<li>Update from server in background</li>
<li>Show stale data rather than loading spinner</li>
</ul></li>
<li><strong>Queue offline operations</strong>
<ul>
<li>Don’t lose user data</li>
<li>Sync when connection restored</li>
<li>Show sync status to user</li>
</ul></li>
<li><strong>Test offline scenarios</strong>
<ul>
<li>Use DevTools to simulate offline</li>
<li>Test sync queue behavior</li>
<li>Verify conflict resolution</li>
</ul></li>
<li><strong>Monitor storage usage</strong>
<ul>
<li>Check quota before storing</li>
<li>Clean up old data</li>
<li>Provide clear error messages when full</li>
</ul></li>
</ol>
<hr />
<h2 data-number="6.9" id="further-reading-5"><span
class="header-section-number">6.9</span> Further Reading</h2>
<strong>For complete state management reference:</strong> - <em>Building
with LARC</em> Chapter 4: State Management - All state patterns and
strategies - <em>Building with LARC</em> Chapter 18: Data Components -
pan-store and pan-idb API reference - <em>Building with LARC</em>
Appendix E: Recipes and Patterns - State management recipes
<div class="pagebreak">

</div>
<h1 data-number="7" id="advanced-component-patterns"><span
class="header-section-number">7</span> Advanced Component Patterns</h1>
<p>As your LARC applications grow, you’ll encounter scenarios that
require sophisticated component architectures. This chapter explores
advanced patterns that enable code reuse, flexible composition, and
optimal performance.</p>
<p>These patterns come from years of component-based development across
frameworks. LARC implements them using web standards, making them
portable and future-proof.</p>
<h2 data-number="7.1" id="compound-components"><span
class="header-section-number">7.1</span> Compound Components</h2>
<p>Compound components work together as a set, sharing implicit state.
Think of HTML’s <code>&lt;select&gt;</code> and
<code>&lt;option&gt;</code> elements—they form a cohesive unit.</p>
<h3 data-number="7.1.1" id="basic-compound-component"><span
class="header-section-number">7.1.1</span> Basic Compound Component</h3>
<div class="sourceCode" id="cb166"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co">// tabs.js - Container component</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TabGroup <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">activeTab</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupTabs</span>()<span class="op">;</span></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupTabs</span>() {</span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get all tab headers</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;tab-header&#39;</span>)<span class="op">;</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">.</span><span class="fu">forEach</span>((header<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>      header<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">activeTab</span> <span class="op">=</span> index<span class="op">;</span></span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">updateTabs</span>()<span class="op">;</span></span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateTabs</span>()<span class="op">;</span></span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateTabs</span>() {</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update headers</span></span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;tab-header&#39;</span>)<span class="op">;</span></span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">.</span><span class="fu">forEach</span>((header<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a>      header<span class="op">.</span><span class="at">active</span> <span class="op">=</span> index <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">activeTab</span><span class="op">;</span></span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update panels</span></span>
<span id="cb166-35"><a href="#cb166-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> panels <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;tab-panel&#39;</span>)<span class="op">;</span></span>
<span id="cb166-36"><a href="#cb166-36" aria-hidden="true" tabindex="-1"></a>    panels<span class="op">.</span><span class="fu">forEach</span>((panel<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb166-37"><a href="#cb166-37" aria-hidden="true" tabindex="-1"></a>      panel<span class="op">.</span><span class="at">active</span> <span class="op">=</span> index <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">activeTab</span><span class="op">;</span></span>
<span id="cb166-38"><a href="#cb166-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb166-39"><a href="#cb166-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-40"><a href="#cb166-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-41"><a href="#cb166-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb166-42"><a href="#cb166-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb166-43"><a href="#cb166-43" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb166-44"><a href="#cb166-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb166-45"><a href="#cb166-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb166-46"><a href="#cb166-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-47"><a href="#cb166-47" aria-hidden="true" tabindex="-1"></a><span class="vs">        .headers {</span></span>
<span id="cb166-48"><a href="#cb166-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb166-49"><a href="#cb166-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 2px solid #e2e8f0;</span></span>
<span id="cb166-50"><a href="#cb166-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-51"><a href="#cb166-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        .panels {</span></span>
<span id="cb166-52"><a href="#cb166-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 16px 0;</span></span>
<span id="cb166-53"><a href="#cb166-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-54"><a href="#cb166-54" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb166-55"><a href="#cb166-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;headers&quot;&gt;</span></span>
<span id="cb166-56"><a href="#cb166-56" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot name=&quot;headers&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb166-57"><a href="#cb166-57" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb166-58"><a href="#cb166-58" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;panels&quot;&gt;</span></span>
<span id="cb166-59"><a href="#cb166-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot name=&quot;panels&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb166-60"><a href="#cb166-60" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb166-61"><a href="#cb166-61" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb166-62"><a href="#cb166-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-63"><a href="#cb166-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb166-64"><a href="#cb166-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-65"><a href="#cb166-65" aria-hidden="true" tabindex="-1"></a><span class="co">// tab-header.js</span></span>
<span id="cb166-66"><a href="#cb166-66" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TabHeader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb166-67"><a href="#cb166-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb166-68"><a href="#cb166-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb166-69"><a href="#cb166-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb166-70"><a href="#cb166-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-71"><a href="#cb166-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-72"><a href="#cb166-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">active</span>(value) {</span>
<span id="cb166-73"><a href="#cb166-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb166-74"><a href="#cb166-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb166-75"><a href="#cb166-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-76"><a href="#cb166-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-77"><a href="#cb166-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb166-78"><a href="#cb166-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb166-79"><a href="#cb166-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-80"><a href="#cb166-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-81"><a href="#cb166-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb166-82"><a href="#cb166-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb166-83"><a href="#cb166-83" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb166-84"><a href="#cb166-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb166-85"><a href="#cb166-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 12px 24px;</span></span>
<span id="cb166-86"><a href="#cb166-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb166-87"><a href="#cb166-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">?</span> <span class="st">&#39;#667eea&#39;</span> <span class="op">:</span> <span class="st">&#39;transparent&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb166-88"><a href="#cb166-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">?</span> <span class="st">&#39;white&#39;</span> <span class="op">:</span> <span class="st">&#39;#4a5568&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb166-89"><a href="#cb166-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb166-90"><a href="#cb166-90" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">?</span> <span class="st">&#39;600&#39;</span> <span class="op">:</span> <span class="st">&#39;400&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb166-91"><a href="#cb166-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: all 0.2s;</span></span>
<span id="cb166-92"><a href="#cb166-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-93"><a href="#cb166-93" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb166-94"><a href="#cb166-94" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">?</span> <span class="st">&#39;#5a67d8&#39;</span> <span class="op">:</span> <span class="st">&#39;#f7fafc&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb166-95"><a href="#cb166-95" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-96"><a href="#cb166-96" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb166-97"><a href="#cb166-97" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/button&gt;</span></span>
<span id="cb166-98"><a href="#cb166-98" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb166-99"><a href="#cb166-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-100"><a href="#cb166-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb166-101"><a href="#cb166-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-102"><a href="#cb166-102" aria-hidden="true" tabindex="-1"></a><span class="co">// tab-panel.js</span></span>
<span id="cb166-103"><a href="#cb166-103" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TabPanel <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb166-104"><a href="#cb166-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb166-105"><a href="#cb166-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb166-106"><a href="#cb166-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb166-107"><a href="#cb166-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-108"><a href="#cb166-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-109"><a href="#cb166-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">active</span>(value) {</span>
<span id="cb166-110"><a href="#cb166-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_active</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb166-111"><a href="#cb166-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> value <span class="op">?</span> <span class="st">&#39;block&#39;</span> <span class="op">:</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb166-112"><a href="#cb166-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-113"><a href="#cb166-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-114"><a href="#cb166-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb166-115"><a href="#cb166-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb166-116"><a href="#cb166-116" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb166-117"><a href="#cb166-117" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb166-118"><a href="#cb166-118" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb166-119"><a href="#cb166-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb166-120"><a href="#cb166-120" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb166-121"><a href="#cb166-121" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb166-122"><a href="#cb166-122" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb166-123"><a href="#cb166-123" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-124"><a href="#cb166-124" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb166-125"><a href="#cb166-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-126"><a href="#cb166-126" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;tab-group&#39;</span><span class="op">,</span> TabGroup)<span class="op">;</span></span>
<span id="cb166-127"><a href="#cb166-127" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;tab-header&#39;</span><span class="op">,</span> TabHeader)<span class="op">;</span></span>
<span id="cb166-128"><a href="#cb166-128" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;tab-panel&#39;</span><span class="op">,</span> TabPanel)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb167"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">tab-group</span><span class="dt">&gt;</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-header</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;headers&quot;</span><span class="dt">&gt;</span>Profile<span class="dt">&lt;/</span><span class="kw">tab-header</span><span class="dt">&gt;</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-header</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;headers&quot;</span><span class="dt">&gt;</span>Settings<span class="dt">&lt;/</span><span class="kw">tab-header</span><span class="dt">&gt;</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-header</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;headers&quot;</span><span class="dt">&gt;</span>Billing<span class="dt">&lt;/</span><span class="kw">tab-header</span><span class="dt">&gt;</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-panel</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panels&quot;</span><span class="dt">&gt;</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Profile Content<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>User profile information...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">tab-panel</span><span class="dt">&gt;</span></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-panel</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panels&quot;</span><span class="dt">&gt;</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Settings Content<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Application settings...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">tab-panel</span><span class="dt">&gt;</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">tab-panel</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;panels&quot;</span><span class="dt">&gt;</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Billing Content<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Billing information...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">tab-panel</span><span class="dt">&gt;</span></span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">tab-group</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="7.1.2" id="context-api-for-compound-components"><span
class="header-section-number">7.1.2</span> Context API for Compound
Components</h3>
<p>Share state without prop drilling:</p>
<div class="sourceCode" id="cb168"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/context.js</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> contexts <span class="op">=</span> <span class="kw">new</span> <span class="bu">WeakMap</span>()<span class="op">;</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">createContext</span>(defaultValue) {</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Provider</span><span class="op">:</span> <span class="kw">class</span> <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">constructor</span>() {</span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> defaultValue<span class="op">;</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        contexts<span class="op">.</span><span class="fu">set</span>(<span class="kw">this</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">provide</span>(value) {</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>        contexts<span class="op">.</span><span class="fu">set</span>(<span class="kw">this</span><span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">notifyConsumers</span>()<span class="op">;</span></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">notifyConsumers</span>() {</span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> consumers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-context-consumer]&#39;</span>)<span class="op">;</span></span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>        consumers<span class="op">.</span><span class="fu">forEach</span>(consumer <span class="kw">=&gt;</span> {</span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (consumer<span class="op">.</span><span class="at">onContextChange</span>) {</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>            consumer<span class="op">.</span><span class="fu">onContextChange</span>(<span class="kw">this</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">connectedCallback</span>() {</span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;slot&gt;&lt;/slot&gt;`</span><span class="op">;</span></span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Consumer</span><span class="op">:</span> <span class="kw">class</span> <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">connectedCallback</span>() {</span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-context-consumer&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find provider up the tree</span></span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> provider <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&#39;[data-context-provider]&#39;</span>)<span class="op">;</span></span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (provider <span class="op">&amp;&amp;</span> contexts<span class="op">.</span><span class="fu">has</span>(provider)) {</span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">onContextChange</span>(contexts<span class="op">.</span><span class="fu">get</span>(provider))<span class="op">;</span></span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-43"><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-44"><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">onContextChange</span>(value) {</span>
<span id="cb168-45"><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Override in subclasses</span></span>
<span id="cb168-46"><a href="#cb168-46" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb168-47"><a href="#cb168-47" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb168-48"><a href="#cb168-48" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb168-49"><a href="#cb168-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create context</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ThemeContext <span class="op">=</span> <span class="fu">createContext</span>({ <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span> })<span class="op">;</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Provider component</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeProvider <span class="kw">extends</span> ThemeContext<span class="op">.</span><span class="at">Provider</span> {</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">connectedCallback</span>()<span class="op">;</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;data-context-provider&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">provide</span>({</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">,</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">toggleTheme</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> newTheme <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="at">theme</span> <span class="op">===</span> <span class="st">&#39;light&#39;</span> <span class="op">?</span> <span class="st">&#39;dark&#39;</span> <span class="op">:</span> <span class="st">&#39;light&#39;</span><span class="op">;</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">provide</span>({ <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">value</span><span class="op">,</span> <span class="dt">theme</span><span class="op">:</span> newTheme })<span class="op">;</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Consumer component</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemedButton <span class="kw">extends</span> ThemeContext<span class="op">.</span><span class="at">Consumer</span> {</span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onContextChange</span>(context) {</span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">context</span> <span class="op">=</span> context<span class="op">;</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { theme } <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">context</span> <span class="op">||</span> { <span class="dt">theme</span><span class="op">:</span> <span class="st">&#39;light&#39;</span> }<span class="op">;</span></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button style=&quot;</span></span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: </span><span class="sc">${</span>theme <span class="op">===</span> <span class="st">&#39;dark&#39;</span> <span class="op">?</span> <span class="st">&#39;#333&#39;</span> <span class="op">:</span> <span class="st">&#39;#fff&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        color: </span><span class="sc">${</span>theme <span class="op">===</span> <span class="st">&#39;dark&#39;</span> <span class="op">?</span> <span class="st">&#39;#fff&#39;</span> <span class="op">:</span> <span class="st">&#39;#333&#39;</span><span class="sc">}</span><span class="vs">;</span></span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a><span class="vs">      &quot;&gt;</span></span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/button&gt;</span></span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;theme-provider&#39;</span><span class="op">,</span> ThemeProvider)<span class="op">;</span></span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;themed-button&#39;</span><span class="op">,</span> ThemedButton)<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb170"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">theme-provider</span><span class="dt">&gt;</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">themed-button</span><span class="dt">&gt;</span>Light/Dark<span class="dt">&lt;/</span><span class="kw">themed-button</span><span class="dt">&gt;</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">themed-button</span><span class="dt">&gt;</span>Another Button<span class="dt">&lt;/</span><span class="kw">themed-button</span><span class="dt">&gt;</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">theme-provider</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="7.2" id="higher-order-components"><span
class="header-section-number">7.2</span> Higher-Order Components</h2>
<p>Higher-order components (HOCs) wrap other components to add
functionality.</p>
<h3 data-number="7.2.1" id="mixin-pattern"><span
class="header-section-number">7.2.1</span> Mixin Pattern</h3>
<p>JavaScript mixins add functionality to classes:</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixins/observable.js</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> ObservableMixin <span class="op">=</span> (Base) <span class="kw">=&gt;</span> <span class="kw">class</span> <span class="kw">extends</span> Base {</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_observers</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">observe</span>(property<span class="op">,</span> callback) {</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">_observers</span><span class="op">.</span><span class="fu">has</span>(property)) {</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_observers</span><span class="op">.</span><span class="fu">set</span>(property<span class="op">,</span> <span class="kw">new</span> <span class="bu">Set</span>())<span class="op">;</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_observers</span><span class="op">.</span><span class="fu">get</span>(property)<span class="op">.</span><span class="fu">add</span>(callback)<span class="op">;</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return unobserve function</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_observers</span><span class="op">.</span><span class="fu">get</span>(property)<span class="op">?.</span><span class="fu">delete</span>(callback)<span class="op">;</span></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">notify</span>(property<span class="op">,</span> value) {</span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_observers</span><span class="op">.</span><span class="fu">get</span>(property)<span class="op">?.</span><span class="fu">forEach</span>(callback <span class="kw">=&gt;</span> {</span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback</span>(value)<span class="op">;</span></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(property<span class="op">,</span> value) {</span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>[<span class="vs">`_</span><span class="sc">${</span>property<span class="sc">}</span><span class="vs">`</span>] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">notify</span>(property<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(property) {</span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span>[<span class="vs">`_</span><span class="sc">${</span>property<span class="sc">}</span><span class="vs">`</span>]<span class="op">;</span></span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a><span class="co">// mixins/resizable.js</span></span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> ResizableMixin <span class="op">=</span> (Base) <span class="kw">=&gt;</span> <span class="kw">class</span> <span class="kw">extends</span> Base {</span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="at">connectedCallback</span><span class="op">?.</span>()<span class="op">;</span></span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resizeObserver</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">ResizeObserver</span>((entries) <span class="kw">=&gt;</span> {</span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> entries) {</span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">onResize</span><span class="op">?.</span>(entry<span class="op">.</span><span class="at">contentRect</span>)<span class="op">;</span></span>
<span id="cb171-44"><a href="#cb171-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb171-45"><a href="#cb171-45" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb171-46"><a href="#cb171-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-47"><a href="#cb171-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resizeObserver</span><span class="op">.</span><span class="fu">observe</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb171-48"><a href="#cb171-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-49"><a href="#cb171-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-50"><a href="#cb171-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb171-51"><a href="#cb171-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="at">disconnectedCallback</span><span class="op">?.</span>()<span class="op">;</span></span>
<span id="cb171-52"><a href="#cb171-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">resizeObserver</span><span class="op">?.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb171-53"><a href="#cb171-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-54"><a href="#cb171-54" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb171-55"><a href="#cb171-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-56"><a href="#cb171-56" aria-hidden="true" tabindex="-1"></a><span class="co">// mixins/loading.js</span></span>
<span id="cb171-57"><a href="#cb171-57" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> LoadingMixin <span class="op">=</span> (Base) <span class="kw">=&gt;</span> <span class="kw">class</span> <span class="kw">extends</span> Base {</span>
<span id="cb171-58"><a href="#cb171-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb171-59"><a href="#cb171-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb171-60"><a href="#cb171-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb171-61"><a href="#cb171-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-62"><a href="#cb171-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-63"><a href="#cb171-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">startLoading</span>() {</span>
<span id="cb171-64"><a href="#cb171-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb171-65"><a href="#cb171-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;loading&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb171-66"><a href="#cb171-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">onLoadingChange</span><span class="op">?.</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb171-67"><a href="#cb171-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-68"><a href="#cb171-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-69"><a href="#cb171-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopLoading</span>() {</span>
<span id="cb171-70"><a href="#cb171-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb171-71"><a href="#cb171-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;loading&#39;</span>)<span class="op">;</span></span>
<span id="cb171-72"><a href="#cb171-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">onLoadingChange</span><span class="op">?.</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb171-73"><a href="#cb171-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-74"><a href="#cb171-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-75"><a href="#cb171-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">loading</span>() {</span>
<span id="cb171-76"><a href="#cb171-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">_loading</span><span class="op">;</span></span>
<span id="cb171-77"><a href="#cb171-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb171-78"><a href="#cb171-78" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ObservableMixin } <span class="im">from</span> <span class="st">&#39;./mixins/observable.js&#39;</span><span class="op">;</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ResizableMixin } <span class="im">from</span> <span class="st">&#39;./mixins/resizable.js&#39;</span><span class="op">;</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { LoadingMixin } <span class="im">from</span> <span class="st">&#39;./mixins/loading.js&#39;</span><span class="op">;</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Compose multiple mixins</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataTable <span class="kw">extends</span> <span class="fu">LoadingMixin</span>(<span class="fu">ResizableMixin</span>(<span class="fu">ObservableMixin</span>(<span class="bu">HTMLElement</span>))) {</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">connectedCallback</span>()<span class="op">;</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use Observable mixin</span></span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">observe</span>(<span class="st">&#39;data&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Data changed:&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use Loading mixin</span></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">startLoading</span>()<span class="op">;</span></span>
<span id="cb172-23"><a href="#cb172-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchData</span>()<span class="op">;</span></span>
<span id="cb172-24"><a href="#cb172-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;data&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb172-25"><a href="#cb172-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">stopLoading</span>()<span class="op">;</span></span>
<span id="cb172-26"><a href="#cb172-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-27"><a href="#cb172-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-28"><a href="#cb172-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use Resizable mixin</span></span>
<span id="cb172-29"><a href="#cb172-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onResize</span>(rect) {</span>
<span id="cb172-30"><a href="#cb172-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Component resized:&#39;</span><span class="op">,</span> rect<span class="op">.</span><span class="at">width</span><span class="op">,</span> rect<span class="op">.</span><span class="at">height</span>)<span class="op">;</span></span>
<span id="cb172-31"><a href="#cb172-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateLayout</span>()<span class="op">;</span></span>
<span id="cb172-32"><a href="#cb172-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-33"><a href="#cb172-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-34"><a href="#cb172-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onLoadingChange</span>(loading) {</span>
<span id="cb172-35"><a href="#cb172-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb172-36"><a href="#cb172-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-37"><a href="#cb172-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-38"><a href="#cb172-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetchData</span>() {</span>
<span id="cb172-39"><a href="#cb172-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span>)<span class="op">;</span></span>
<span id="cb172-40"><a href="#cb172-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb172-41"><a href="#cb172-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-42"><a href="#cb172-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-43"><a href="#cb172-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb172-44"><a href="#cb172-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render based on state</span></span>
<span id="cb172-45"><a href="#cb172-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-46"><a href="#cb172-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb172-47"><a href="#cb172-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-48"><a href="#cb172-48" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;data-table&#39;</span><span class="op">,</span> DataTable)<span class="op">;</span></span></code></pre></div>
<h3 data-number="7.2.2" id="decorator-pattern"><span
class="header-section-number">7.2.2</span> Decorator Pattern</h3>
<p>Wrap components to enhance them:</p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co">// decorators/with-loading.js</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">withLoading</span>(ComponentClass) {</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">class</span> <span class="kw">extends</span> ComponentClass {</span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">constructor</span>() {</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_originalConnectedCallback</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">connectedCallback</span><span class="op">;</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">connectedCallback</span>() {</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Inject loading overlay</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> loadingOverlay <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>      loadingOverlay<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;loading-overlay&#39;</span><span class="op">;</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>      loadingOverlay<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">cssText</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        position: absolute;</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        top: 0;</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        left: 0;</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        right: 0;</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        bottom: 0;</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        background: rgba(255,255,255,0.8);</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        display: none;</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        align-items: center;</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        justify-content: center;</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>      loadingOverlay<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;spinner&quot;&gt;&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(loadingOverlay)<span class="op">;</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_loadingOverlay</span> <span class="op">=</span> loadingOverlay<span class="op">;</span></span>
<span id="cb173-28"><a href="#cb173-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-29"><a href="#cb173-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Call original</span></span>
<span id="cb173-30"><a href="#cb173-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_originalConnectedCallback</span>) {</span>
<span id="cb173-31"><a href="#cb173-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">_originalConnectedCallback</span><span class="op">.</span><span class="fu">call</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb173-32"><a href="#cb173-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb173-33"><a href="#cb173-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-34"><a href="#cb173-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-35"><a href="#cb173-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">showLoading</span>() {</span>
<span id="cb173-36"><a href="#cb173-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_loadingOverlay</span>) {</span>
<span id="cb173-37"><a href="#cb173-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">_loadingOverlay</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;flex&#39;</span><span class="op">;</span></span>
<span id="cb173-38"><a href="#cb173-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb173-39"><a href="#cb173-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-40"><a href="#cb173-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-41"><a href="#cb173-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hideLoading</span>() {</span>
<span id="cb173-42"><a href="#cb173-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_loadingOverlay</span>) {</span>
<span id="cb173-43"><a href="#cb173-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">_loadingOverlay</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb173-44"><a href="#cb173-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb173-45"><a href="#cb173-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb173-46"><a href="#cb173-46" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb173-47"><a href="#cb173-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb173-48"><a href="#cb173-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-49"><a href="#cb173-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb173-50"><a href="#cb173-50" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb173-51"><a href="#cb173-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb173-52"><a href="#cb173-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showLoading</span>()<span class="op">;</span></span>
<span id="cb173-53"><a href="#cb173-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-54"><a href="#cb173-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/user&#39;</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb173-55"><a href="#cb173-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(user)<span class="op">;</span></span>
<span id="cb173-56"><a href="#cb173-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-57"><a href="#cb173-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">hideLoading</span>()<span class="op">;</span></span>
<span id="cb173-58"><a href="#cb173-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-59"><a href="#cb173-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-60"><a href="#cb173-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(user) {</span>
<span id="cb173-61"><a href="#cb173-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;h1&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h1&gt;`</span><span class="op">;</span></span>
<span id="cb173-62"><a href="#cb173-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb173-63"><a href="#cb173-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb173-64"><a href="#cb173-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-65"><a href="#cb173-65" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply decorator</span></span>
<span id="cb173-66"><a href="#cb173-66" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> UserProfileWithLoading <span class="op">=</span> <span class="fu">withLoading</span>(UserProfile)<span class="op">;</span></span>
<span id="cb173-67"><a href="#cb173-67" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-profile&#39;</span><span class="op">,</span> UserProfileWithLoading)<span class="op">;</span></span></code></pre></div>
<h2 data-number="7.3" id="component-composition"><span
class="header-section-number">7.3</span> Component Composition</h2>
<p>Build complex UIs from simple, focused components.</p>
<h3 data-number="7.3.1" id="containerpresentational-pattern"><span
class="header-section-number">7.3.1</span> Container/Presentational
Pattern</h3>
<p>Separate logic from presentation:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Presentational - no logic, just rendering</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">user</span>(value) {</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_user</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;img src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">avatar</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;follow-btn&quot;&gt;Follow&lt;/button&gt;</span></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Emit events, don&#39;t handle logic</span></span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.follow-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;follow&#39;</span><span class="op">,</span> {</span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">detail</span><span class="op">:</span> { <span class="dt">userId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">_user</span><span class="op">.</span><span class="at">id</span> }</span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-29"><a href="#cb174-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Container - handles logic and data</span></span>
<span id="cb174-30"><a href="#cb174-30" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCardContainer <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb174-31"><a href="#cb174-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb174-32"><a href="#cb174-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">;</span></span>
<span id="cb174-33"><a href="#cb174-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-34"><a href="#cb174-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fetch data</span></span>
<span id="cb174-35"><a href="#cb174-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchUser</span>(userId)<span class="op">;</span></span>
<span id="cb174-36"><a href="#cb174-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-37"><a href="#cb174-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create presentational component</span></span>
<span id="cb174-38"><a href="#cb174-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> card <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;user-card&#39;</span>)<span class="op">;</span></span>
<span id="cb174-39"><a href="#cb174-39" aria-hidden="true" tabindex="-1"></a>    card<span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">;</span></span>
<span id="cb174-40"><a href="#cb174-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-41"><a href="#cb174-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle events</span></span>
<span id="cb174-42"><a href="#cb174-42" aria-hidden="true" tabindex="-1"></a>    card<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;follow&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb174-43"><a href="#cb174-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">followUser</span>(e<span class="op">.</span><span class="at">detail</span><span class="op">.</span><span class="at">userId</span>)<span class="op">;</span></span>
<span id="cb174-44"><a href="#cb174-44" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb174-45"><a href="#cb174-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-46"><a href="#cb174-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(card)<span class="op">;</span></span>
<span id="cb174-47"><a href="#cb174-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-48"><a href="#cb174-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-49"><a href="#cb174-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetchUser</span>(id) {</span>
<span id="cb174-50"><a href="#cb174-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb174-51"><a href="#cb174-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb174-52"><a href="#cb174-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-53"><a href="#cb174-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-54"><a href="#cb174-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">followUser</span>(userId) {</span>
<span id="cb174-55"><a href="#cb174-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>userId<span class="sc">}</span><span class="vs">/follow`</span><span class="op">,</span> { <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span> })<span class="op">;</span></span>
<span id="cb174-56"><a href="#cb174-56" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.followed&#39;</span><span class="op">,</span> { userId })<span class="op">;</span></span>
<span id="cb174-57"><a href="#cb174-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-58"><a href="#cb174-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb174-59"><a href="#cb174-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-60"><a href="#cb174-60" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-card&#39;</span><span class="op">,</span> UserCard)<span class="op">;</span></span>
<span id="cb174-61"><a href="#cb174-61" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-card-container&#39;</span><span class="op">,</span> UserCardContainer)<span class="op">;</span></span></code></pre></div>
<h3 data-number="7.3.2" id="render-props-pattern"><span
class="header-section-number">7.3.2</span> Render Props Pattern</h3>
<p>Pass rendering logic as a slot:</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataProvider <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;url&#39;</span>)<span class="op">;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render loading state</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;slot name=&quot;loading&quot;&gt;Loading...&lt;/slot&gt;&#39;</span><span class="op">;</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url)<span class="op">;</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render with data</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> renderSlot <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;render&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (renderSlot) {</span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>        renderSlot<span class="op">.</span><span class="at">data</span> <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(renderSlot)<span class="op">;</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render error state</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;slot name=&quot;error&quot;&gt;Error: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/slot&gt;`</span><span class="op">;</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;data-provider&#39;</span><span class="op">,</span> DataProvider)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">data-provider</span><span class="ot"> url</span><span class="op">=</span><span class="st">&quot;/api/users&quot;</span><span class="dt">&gt;</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;loading&quot;</span><span class="dt">&gt;</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">spinner-component</span><span class="dt">&gt;&lt;/</span><span class="kw">spinner-component</span><span class="dt">&gt;</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">user-list</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;render&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">user-list</span><span class="dt">&gt;</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;error&quot;</span><span class="dt">&gt;</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">error-message</span><span class="dt">&gt;&lt;/</span><span class="kw">error-message</span><span class="dt">&gt;</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">data-provider</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="7.4" id="slots-and-content-projection"><span
class="header-section-number">7.4</span> Slots and Content
Projection</h2>
<p>Slots are powerful for flexible component composition.</p>
<h3 data-number="7.4.1" id="named-slots"><span
class="header-section-number">7.4.1</span> Named Slots</h3>
<div class="sourceCode" id="cb177"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CardComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        .card {</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #e2e8f0;</span></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow: hidden;</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .header {</span></span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f7fafc;</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 16px;</span></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #e2e8f0;</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        .body {</span></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 16px;</span></span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        .footer {</span></span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f7fafc;</span></span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 12px 16px;</span></span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-top: 1px solid #e2e8f0;</span></span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: flex-end;</span></span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 8px;</span></span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-30"><a href="#cb177-30" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb177-31"><a href="#cb177-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;header&quot;&gt;</span></span>
<span id="cb177-32"><a href="#cb177-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;header&quot;&gt;Default Header&lt;/slot&gt;</span></span>
<span id="cb177-33"><a href="#cb177-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb177-34"><a href="#cb177-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;body&quot;&gt;</span></span>
<span id="cb177-35"><a href="#cb177-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb177-36"><a href="#cb177-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb177-37"><a href="#cb177-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;footer&quot;&gt;</span></span>
<span id="cb177-38"><a href="#cb177-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;footer&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb177-39"><a href="#cb177-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb177-40"><a href="#cb177-40" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb177-41"><a href="#cb177-41" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb177-42"><a href="#cb177-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb177-43"><a href="#cb177-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb177-44"><a href="#cb177-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-45"><a href="#cb177-45" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;card-component&#39;</span><span class="op">,</span> CardComponent)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">card-component</span><span class="dt">&gt;</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">h2</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;header&quot;</span><span class="dt">&gt;</span>User Profile<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Default slot --&gt;</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>User profile content goes here...<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> slot</span><span class="op">=</span><span class="st">&quot;footer&quot;</span><span class="dt">&gt;</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="dt">&gt;</span>Save<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">button</span><span class="dt">&gt;</span>Cancel<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">card-component</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="7.4.2" id="slot-change-detection"><span
class="header-section-number">7.4.2</span> Slot Change Detection</h3>
<p>React to slot content changes:</p>
<div class="sourceCode" id="cb179"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DynamicList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        .count { font-weight: bold; color: #667eea; }</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;count&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for slot changes</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> slot <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;slot&#39;</span>)<span class="op">;</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    slot<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;slotchange&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateCount</span>()<span class="op">;</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">updateCount</span>()<span class="op">;</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateCount</span>() {</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> slot <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;slot&#39;</span>)<span class="op">;</span></span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> elements <span class="op">=</span> slot<span class="op">.</span><span class="fu">assignedElements</span>()<span class="op">;</span></span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> count <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.count&#39;</span>)<span class="op">;</span></span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>    count<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>elements<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> items`</span><span class="op">;</span></span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;dynamic-list&#39;</span><span class="op">,</span> DynamicList)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">dynamic-list</span><span class="dt">&gt;</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span>Item 1<span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span>Item 2<span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">div</span><span class="dt">&gt;</span>Item 3<span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">dynamic-list</span><span class="dt">&gt;</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> list <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;dynamic-list&#39;</span>)<span class="op">;</span></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add item dynamically</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> newItem <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>  newItem<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Item 4&#39;</span><span class="op">;</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">appendChild</span>(newItem)<span class="op">;</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Count automatically updates!</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="7.4.3" id="conditional-slots"><span
class="header-section-number">7.4.3</span> Conditional Slots</h3>
<p>Show/hide content based on slot presence:</p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConditionalCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> hasHeader <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;header&quot;]&#39;</span>) <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> hasFooter <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;footer&quot;]&#39;</span>) <span class="op">!==</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        .card { border: 1px solid #ddd; border-radius: 8px; }</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        .header, .footer { background: #f5f5f5; padding: 16px; }</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .body { padding: 16px; }</span></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        .hidden { display: none; }</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;header </span><span class="sc">${</span>hasHeader <span class="op">?</span> <span class="st">&#39;&#39;</span> <span class="op">:</span> <span class="st">&#39;hidden&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;header&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;body&quot;&gt;</span></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;footer </span><span class="sc">${</span>hasFooter <span class="op">?</span> <span class="st">&#39;&#39;</span> <span class="op">:</span> <span class="st">&#39;hidden&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;footer&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-31"><a href="#cb181-31" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;conditional-card&#39;</span><span class="op">,</span> ConditionalCard)<span class="op">;</span></span></code></pre></div>
<h2 data-number="7.5" id="dynamic-component-loading"><span
class="header-section-number">7.5</span> Dynamic Component Loading</h2>
<p>Load components on demand for better performance.</p>
<h3 data-number="7.5.1" id="lazy-loading"><span
class="header-section-number">7.5.1</span> Lazy Loading</h3>
<div class="sourceCode" id="cb182"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LazyLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> component <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;component&#39;</span>)<span class="op">;</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> src <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;src&#39;</span>)<span class="op">;</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show placeholder</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div&gt;Loading component...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Dynamically import component</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="im">import</span>(src)<span class="op">;</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Wait for component to be defined</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(component)<span class="op">;</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Create and append component</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(component)<span class="op">;</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Copy attributes</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">attributes</span>)<span class="op">.</span><span class="fu">forEach</span>(attr <span class="kw">=&gt;</span> {</span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (attr<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;component&#39;</span> <span class="op">&amp;&amp;</span> attr<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;src&#39;</span>) {</span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>          element<span class="op">.</span><span class="fu">setAttribute</span>(attr<span class="op">.</span><span class="at">name</span><span class="op">,</span> attr<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;div class=&quot;error&quot;&gt;Failed to load component: </span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb182-30"><a href="#cb182-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;lazy-loader&#39;</span><span class="op">,</span> LazyLoader)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Component loads when added to DOM --&gt;</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">lazy-loader</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  component</span><span class="op">=</span><span class="st">&quot;heavy-chart&quot;</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  src</span><span class="op">=</span><span class="st">&quot;/components/heavy-chart.js&quot;</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  data-url</span><span class="op">=</span><span class="st">&quot;/api/chart-data&quot;</span><span class="dt">&gt;</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">lazy-loader</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="7.5.2"
id="intersection-observer-for-viewport-loading"><span
class="header-section-number">7.5.2</span> Intersection Observer for
Viewport Loading</h3>
<p>Load components when they enter the viewport:</p>
<div class="sourceCode" id="cb184"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ViewportLoader <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>((entries) <span class="kw">=&gt;</span> {</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>      entries<span class="op">.</span><span class="fu">forEach</span>(entry <span class="kw">=&gt;</span> {</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (entry<span class="op">.</span><span class="at">isIntersecting</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">loaded</span>) {</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">load</span>()<span class="op">;</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> {</span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">rootMargin</span><span class="op">:</span> <span class="st">&#39;50px&#39;</span>  <span class="co">// Start loading 50px before visible</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span><span class="op">.</span><span class="fu">observe</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">observer</span><span class="op">?.</span><span class="fu">disconnect</span>()<span class="op">;</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">load</span>() {</span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loaded</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> component <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;component&#39;</span>)<span class="op">;</span></span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> src <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;src&#39;</span>)<span class="op">;</span></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="im">import</span>(src)<span class="op">;</span></span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(component)<span class="op">;</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> element <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(component)<span class="op">;</span></span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">attributes</span>)<span class="op">.</span><span class="fu">forEach</span>(attr <span class="kw">=&gt;</span> {</span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>[<span class="st">&#39;component&#39;</span><span class="op">,</span> <span class="st">&#39;src&#39;</span>]<span class="op">.</span><span class="fu">includes</span>(attr<span class="op">.</span><span class="at">name</span>)) {</span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a>        element<span class="op">.</span><span class="fu">setAttribute</span>(attr<span class="op">.</span><span class="at">name</span><span class="op">,</span> attr<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(element)<span class="op">;</span></span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;viewport-loader&#39;</span><span class="op">,</span> ViewportLoader)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Heavy image gallery - only loads when scrolled into view --&gt;</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">viewport-loader</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  component</span><span class="op">=</span><span class="st">&quot;image-gallery&quot;</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  src</span><span class="op">=</span><span class="st">&quot;/components/image-gallery.js&quot;</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  album-id</span><span class="op">=</span><span class="st">&quot;123&quot;</span><span class="dt">&gt;</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">viewport-loader</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="7.6" id="performance-optimization"><span
class="header-section-number">7.6</span> Performance Optimization</h2>
<h3 data-number="7.6.1" id="virtual-scrolling"><span
class="header-section-number">7.6.1</span> Virtual Scrolling</h3>
<p>Render only visible items in long lists:</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VirtualList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span> <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span> <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">data</span>(items) {</span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> items<span class="op">;</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 100%;</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-y: auto;</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: relative;</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        .viewport {</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: relative;</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        .item {</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0 16px;</span></span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #eee;</span></span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;viewport&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">viewport</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.viewport&#39;</span>)<span class="op">;</span></span>
<span id="cb186-44"><a href="#cb186-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-45"><a href="#cb186-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb186-46"><a href="#cb186-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span><span class="op">;</span></span>
<span id="cb186-47"><a href="#cb186-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderVisibleItems</span>()<span class="op">;</span></span>
<span id="cb186-48"><a href="#cb186-48" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb186-49"><a href="#cb186-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-50"><a href="#cb186-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-51"><a href="#cb186-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb186-52"><a href="#cb186-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">viewport</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb186-53"><a href="#cb186-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-54"><a href="#cb186-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set total height</span></span>
<span id="cb186-55"><a href="#cb186-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> totalHeight <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="op">;</span></span>
<span id="cb186-56"><a href="#cb186-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">viewport</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>totalHeight<span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb186-57"><a href="#cb186-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-58"><a href="#cb186-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">renderVisibleItems</span>()<span class="op">;</span></span>
<span id="cb186-59"><a href="#cb186-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-60"><a href="#cb186-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-61"><a href="#cb186-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderVisibleItems</span>() {</span>
<span id="cb186-62"><a href="#cb186-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span>)<span class="op">;</span></span>
<span id="cb186-63"><a href="#cb186-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> endIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(</span>
<span id="cb186-64"><a href="#cb186-64" aria-hidden="true" tabindex="-1"></a>      startIndex <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span><span class="op">,</span></span>
<span id="cb186-65"><a href="#cb186-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span></span>
<span id="cb186-66"><a href="#cb186-66" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb186-67"><a href="#cb186-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-68"><a href="#cb186-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear existing items</span></span>
<span id="cb186-69"><a href="#cb186-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">viewport</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb186-70"><a href="#cb186-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-71"><a href="#cb186-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render only visible items</span></span>
<span id="cb186-72"><a href="#cb186-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> startIndex<span class="op">;</span> i <span class="op">&lt;</span> endIndex<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb186-73"><a href="#cb186-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> item <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb186-74"><a href="#cb186-74" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;item&#39;</span><span class="op">;</span></span>
<span id="cb186-75"><a href="#cb186-75" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">top</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>i <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px`</span><span class="op">;</span></span>
<span id="cb186-76"><a href="#cb186-76" aria-hidden="true" tabindex="-1"></a>      item<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span>[i]<span class="op">;</span></span>
<span id="cb186-77"><a href="#cb186-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-78"><a href="#cb186-78" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">viewport</span><span class="op">.</span><span class="fu">appendChild</span>(item)<span class="op">;</span></span>
<span id="cb186-79"><a href="#cb186-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb186-80"><a href="#cb186-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb186-81"><a href="#cb186-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb186-82"><a href="#cb186-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-83"><a href="#cb186-83" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;virtual-list&#39;</span><span class="op">,</span> VirtualList)<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> list <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;virtual-list&#39;</span>)<span class="op">;</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>list<span class="op">.</span><span class="at">data</span> <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>({ <span class="dt">length</span><span class="op">:</span> <span class="dv">10000</span> }<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`Item </span><span class="sc">${</span>i <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>list<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> <span class="st">&#39;400px&#39;</span><span class="op">;</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(list)<span class="op">;</span></span></code></pre></div>
<h3 data-number="7.6.2" id="memoization"><span
class="header-section-number">7.6.2</span> Memoization</h3>
<p>Cache expensive computations:</p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MemoizedComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">memoize</span>(fn<span class="op">,</span> keyFn) {</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="op">...</span>args) <span class="kw">=&gt;</span> {</span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> key <span class="op">=</span> keyFn <span class="op">?</span> <span class="fu">keyFn</span>(<span class="op">...</span>args) <span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(args)<span class="op">;</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">has</span>(key)) {</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="fu">fn</span>(<span class="op">...</span>args)<span class="op">;</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>  computeExpensiveValue <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">memoize</span>(</span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>    (data) <span class="kw">=&gt;</span> {</span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Expensive computation</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Computing...&#39;</span>)<span class="op">;</span></span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> data<span class="op">.</span><span class="fu">reduce</span>((acc<span class="op">,</span> val) <span class="kw">=&gt;</span> acc <span class="op">+</span> val<span class="op">.</span><span class="at">price</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>    (data) <span class="kw">=&gt;</span> data<span class="op">.</span><span class="fu">map</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;,&#39;</span>)</span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> [</span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">100</span> }<span class="op">,</span></span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">200</span> }</span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-37"><a href="#cb188-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First call - computes</span></span>
<span id="cb188-38"><a href="#cb188-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">computeExpensiveValue</span>(data))<span class="op">;</span></span>
<span id="cb188-39"><a href="#cb188-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-40"><a href="#cb188-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Second call - cached</span></span>
<span id="cb188-41"><a href="#cb188-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">computeExpensiveValue</span>(data))<span class="op">;</span></span>
<span id="cb188-42"><a href="#cb188-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-43"><a href="#cb188-43" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="7.6.3" id="debouncing-and-throttling"><span
class="header-section-number">7.6.3</span> Debouncing and
Throttling</h3>
<p>Limit expensive operations:</p>
<div class="sourceCode" id="cb189"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/performance.js</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">debounce</span>(fn<span class="op">,</span> delay) {</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> timeoutId<span class="op">;</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>      fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">throttle</span>(fn<span class="op">,</span> limit) {</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> inThrottle<span class="op">;</span></span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>inThrottle) {</span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>      fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>      inThrottle <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>        inThrottle <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> limit)<span class="op">;</span></span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb189-28"><a href="#cb189-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-29"><a href="#cb189-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb189-30"><a href="#cb189-30" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchBox <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb189-31"><a href="#cb189-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb189-32"><a href="#cb189-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb189-33"><a href="#cb189-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-34"><a href="#cb189-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounce search - wait for user to stop typing</span></span>
<span id="cb189-35"><a href="#cb189-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">handleSearch</span> <span class="op">=</span> <span class="fu">debounce</span>(<span class="kw">this</span><span class="op">.</span><span class="at">search</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb189-36"><a href="#cb189-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-37"><a href="#cb189-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Throttle scroll - limit updates</span></span>
<span id="cb189-38"><a href="#cb189-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">handleScroll</span> <span class="op">=</span> <span class="fu">throttle</span>(<span class="kw">this</span><span class="op">.</span><span class="at">onScroll</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb189-39"><a href="#cb189-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-40"><a href="#cb189-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-41"><a href="#cb189-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb189-42"><a href="#cb189-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;input type=&quot;search&quot; placeholder=&quot;Search...&quot;&gt;&#39;</span><span class="op">;</span></span>
<span id="cb189-43"><a href="#cb189-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-44"><a href="#cb189-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb189-45"><a href="#cb189-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleSearch</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb189-46"><a href="#cb189-46" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb189-47"><a href="#cb189-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-48"><a href="#cb189-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleScroll</span>)<span class="op">;</span></span>
<span id="cb189-49"><a href="#cb189-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-50"><a href="#cb189-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-51"><a href="#cb189-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">search</span>(query) {</span>
<span id="cb189-52"><a href="#cb189-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Searching for:&#39;</span><span class="op">,</span> query)<span class="op">;</span></span>
<span id="cb189-53"><a href="#cb189-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Perform search</span></span>
<span id="cb189-54"><a href="#cb189-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-55"><a href="#cb189-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-56"><a href="#cb189-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onScroll</span>() {</span>
<span id="cb189-57"><a href="#cb189-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Scrolled&#39;</span>)<span class="op">;</span></span>
<span id="cb189-58"><a href="#cb189-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update UI based on scroll</span></span>
<span id="cb189-59"><a href="#cb189-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-60"><a href="#cb189-60" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="7.7" id="summary-6"><span
class="header-section-number">7.7</span> Summary</h2>
<p>This chapter explored advanced component patterns:</p>
<ul>
<li><strong>Compound Components</strong>: Components that work together
as a cohesive unit</li>
<li><strong>Higher-Order Components</strong>: Mixins and decorators for
code reuse</li>
<li><strong>Component Composition</strong>: Container/presentational
pattern and render props</li>
<li><strong>Slots</strong>: Named slots, slot change detection, and
conditional rendering</li>
<li><strong>Dynamic Loading</strong>: Lazy loading and viewport-based
loading</li>
<li><strong>Performance</strong>: Virtual scrolling, memoization,
debouncing, and throttling</li>
</ul>
<p>These patterns enable you to build sophisticated, performant
applications while keeping code maintainable and testable.</p>
<hr />
<h2 data-number="7.8" id="best-practices-3"><span
class="header-section-number">7.8</span> Best Practices</h2>
<ol type="1">
<li><strong>Favor composition over inheritance</strong>
<ul>
<li>Build complex components from simple ones</li>
<li>Use slots for flexibility</li>
<li>Keep components focused</li>
</ul></li>
<li><strong>Use mixins for cross-cutting concerns</strong>
<ul>
<li>Observable behavior</li>
<li>Resize handling</li>
<li>Loading states</li>
</ul></li>
<li><strong>Separate logic from presentation</strong>
<ul>
<li>Container components handle data</li>
<li>Presentational components handle UI</li>
<li>Easier to test and reuse</li>
</ul></li>
<li><strong>Lazy load heavy components</strong>
<ul>
<li>Reduce initial bundle size</li>
<li>Load on demand or when visible</li>
<li>Show loading states</li>
</ul></li>
<li><strong>Optimize expensive operations</strong>
<ul>
<li>Memoize pure functions</li>
<li>Debounce user input</li>
<li>Throttle scroll/resize handlers</li>
<li>Use virtual scrolling for long lists</li>
</ul></li>
<li><strong>Keep performance in mind</strong>
<ul>
<li>Profile before optimizing</li>
<li>Measure impact of changes</li>
<li>Don’t over-optimize prematurely</li>
</ul></li>
</ol>
<hr />
<h2 data-number="7.9" id="further-reading-6"><span
class="header-section-number">7.9</span> Further Reading</h2>
<p><strong>For advanced patterns and optimization:</strong> -
<em>Building with LARC</em> Chapter 15: Advanced Patterns -
Micro-frontends, plugin systems, middleware - <em>Building with
LARC</em> Chapter 12: Performance Optimization - Virtual scrolling, lazy
loading, profiling - <em>Building with LARC</em> Appendix E: Recipes and
Patterns - Advanced component patterns</p>
<div class="pagebreak">

</div>
<h1 data-number="8" id="business-logic-patterns"><span
class="header-section-number">8</span> Business Logic Patterns</h1>
<p>In the previous chapters, we’ve learned how to build components,
communicate via the PAN bus, and manage state. But when building
real-world applications, you’ll inevitably need to inject your own
custom business logic: validation rules, pricing calculations, access
control, analytics tracking, and countless other domain-specific
concerns.</p>
<p>A common question developers ask when adopting LARC is: <em>“Where do
I put my business logic?”</em> This chapter explores the architectural
patterns for integrating business logic into LARC applications, helping
you make informed decisions about code organization and separation of
concerns.</p>
<h2 data-number="8.1" id="the-philosophy-separation-of-concerns"><span
class="header-section-number">8.1</span> The Philosophy: Separation of
Concerns</h2>
<p>LARC’s architecture naturally encourages a clean separation
between:</p>
<ul>
<li><strong>Components</strong>: UI and interaction concerns</li>
<li><strong>PAN Bus</strong>: Communication layer</li>
<li><strong>Business Logic</strong>: Domain rules and workflows</li>
</ul>
<p>This separation isn’t just academic—it makes your code:</p>
<ul>
<li><strong>Testable</strong>: Logic can be tested independently of
UI</li>
<li><strong>Maintainable</strong>: Changes to business rules don’t
require touching components</li>
<li><strong>Reusable</strong>: Logic can be shared across multiple
components</li>
<li><strong>Flexible</strong>: Easy to modify workflows without
refactoring components</li>
</ul>
<p>Let’s explore the patterns that make this possible.</p>
<h2 data-number="8.2" id="pattern-1-pan-bus-listeners-recommended"><span
class="header-section-number">8.2</span> Pattern 1: PAN Bus Listeners
(Recommended)</h2>
<p>The most common and recommended approach is to create separate
modules that listen to PAN bus events and implement your business logic.
This pattern treats business logic as a <strong>first-class
concern</strong>, separate from both UI components and state
management.</p>
<h3 data-number="8.2.1" id="when-to-use"><span
class="header-section-number">8.2.1</span> When to Use</h3>
<p>Use PAN bus listeners when you need to:</p>
<ul>
<li>Coordinate behavior across multiple components</li>
<li>Implement cross-cutting concerns (analytics, logging,
validation)</li>
<li>Add business rules that aren’t tied to a specific component</li>
<li>Keep components generic and reusable</li>
</ul>
<h3 data-number="8.2.2" id="basic-implementation"><span
class="header-section-number">8.2.2</span> Basic Implementation</h3>
<p>Let’s build an e-commerce application where we need to enforce
business rules around cart operations:</p>
<div class="sourceCode" id="cb190"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">// business-logic/cart-rules.js</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CartBusinessRules {</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxItemsPerOrder</span> <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxQuantityPerItem</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>() {</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to cart events</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleItemAdd</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.item.update&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleItemUpdate</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.checkout.start&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleCheckout</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleItemAdd</span>(data) {</span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Business rule: Validating item add&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check current cart state</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentCart <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;cart.get&#39;</span>)<span class="op">;</span></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule 1: Maximum items per order</span></span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (currentCart<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;=</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxItemsPerOrder</span>) {</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MAX_ITEMS_EXCEEDED&#39;</span><span class="op">,</span></span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="vs">`Cannot add more than </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">maxItemsPerOrder</span><span class="sc">}</span><span class="vs"> items to cart`</span></span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule 2: Check inventory</span></span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> available <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">checkInventory</span>(data<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>available <span class="op">||</span> available <span class="op">&lt;</span> data<span class="op">.</span><span class="at">quantity</span>) {</span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;INSUFFICIENT_INVENTORY&#39;</span><span class="op">,</span></span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;This item is currently out of stock&#39;</span><span class="op">,</span></span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">product</span><span class="op">:</span> data<span class="op">.</span><span class="at">product</span></span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule 3: Apply pricing</span></span>
<span id="cb190-44"><a href="#cb190-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculatePrice</span>(data<span class="op">.</span><span class="at">product</span><span class="op">,</span> data<span class="op">.</span><span class="at">quantity</span>)<span class="op">;</span></span>
<span id="cb190-45"><a href="#cb190-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-46"><a href="#cb190-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All validations passed - allow the add and publish enriched data</span></span>
<span id="cb190-47"><a href="#cb190-47" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.validated&#39;</span><span class="op">,</span> {</span>
<span id="cb190-48"><a href="#cb190-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>data<span class="op">,</span></span>
<span id="cb190-49"><a href="#cb190-49" aria-hidden="true" tabindex="-1"></a>      pricing<span class="op">,</span></span>
<span id="cb190-50"><a href="#cb190-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb190-51"><a href="#cb190-51" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb190-52"><a href="#cb190-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-53"><a href="#cb190-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-54"><a href="#cb190-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleItemUpdate</span>(data) {</span>
<span id="cb190-55"><a href="#cb190-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: Quantity limits</span></span>
<span id="cb190-56"><a href="#cb190-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">quantity</span> <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxQuantityPerItem</span>) {</span>
<span id="cb190-57"><a href="#cb190-57" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-58"><a href="#cb190-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MAX_QUANTITY_EXCEEDED&#39;</span><span class="op">,</span></span>
<span id="cb190-59"><a href="#cb190-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="vs">`Maximum </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">maxQuantityPerItem</span><span class="sc">}</span><span class="vs"> per item`</span></span>
<span id="cb190-60"><a href="#cb190-60" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-61"><a href="#cb190-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-62"><a href="#cb190-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-63"><a href="#cb190-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-64"><a href="#cb190-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check inventory for new quantity</span></span>
<span id="cb190-65"><a href="#cb190-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> available <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">checkInventory</span>(data<span class="op">.</span><span class="at">productId</span>)<span class="op">;</span></span>
<span id="cb190-66"><a href="#cb190-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (available <span class="op">&lt;</span> data<span class="op">.</span><span class="at">quantity</span>) {</span>
<span id="cb190-67"><a href="#cb190-67" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-68"><a href="#cb190-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;INSUFFICIENT_INVENTORY&#39;</span><span class="op">,</span></span>
<span id="cb190-69"><a href="#cb190-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="vs">`Only </span><span class="sc">${</span>available<span class="sc">}</span><span class="vs"> available`</span><span class="op">,</span></span>
<span id="cb190-70"><a href="#cb190-70" aria-hidden="true" tabindex="-1"></a>        available</span>
<span id="cb190-71"><a href="#cb190-71" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-72"><a href="#cb190-72" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-73"><a href="#cb190-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-74"><a href="#cb190-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-75"><a href="#cb190-75" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.update.validated&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb190-76"><a href="#cb190-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-77"><a href="#cb190-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-78"><a href="#cb190-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleCheckout</span>(data) {</span>
<span id="cb190-79"><a href="#cb190-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: Minimum order value</span></span>
<span id="cb190-80"><a href="#cb190-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cart <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;cart.get&#39;</span>)<span class="op">;</span></span>
<span id="cb190-81"><a href="#cb190-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> total <span class="op">=</span> cart<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">total</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb190-82"><a href="#cb190-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-83"><a href="#cb190-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (total <span class="op">&lt;</span> <span class="dv">10</span>) {</span>
<span id="cb190-84"><a href="#cb190-84" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-85"><a href="#cb190-85" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MINIMUM_ORDER_NOT_MET&#39;</span><span class="op">,</span></span>
<span id="cb190-86"><a href="#cb190-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Minimum order value is $10&#39;</span><span class="op">,</span></span>
<span id="cb190-87"><a href="#cb190-87" aria-hidden="true" tabindex="-1"></a>        <span class="dt">current</span><span class="op">:</span> total<span class="op">,</span></span>
<span id="cb190-88"><a href="#cb190-88" aria-hidden="true" tabindex="-1"></a>        <span class="dt">required</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb190-89"><a href="#cb190-89" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-90"><a href="#cb190-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-91"><a href="#cb190-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-92"><a href="#cb190-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-93"><a href="#cb190-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: User must be logged in</span></span>
<span id="cb190-94"><a href="#cb190-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb190-95"><a href="#cb190-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb190-96"><a href="#cb190-96" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb190-97"><a href="#cb190-97" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;AUTH_REQUIRED&#39;</span><span class="op">,</span></span>
<span id="cb190-98"><a href="#cb190-98" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Please log in to continue&#39;</span></span>
<span id="cb190-99"><a href="#cb190-99" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb190-100"><a href="#cb190-100" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-101"><a href="#cb190-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-102"><a href="#cb190-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-103"><a href="#cb190-103" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.validated&#39;</span><span class="op">,</span> { cart<span class="op">,</span> user })<span class="op">;</span></span>
<span id="cb190-104"><a href="#cb190-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-105"><a href="#cb190-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-106"><a href="#cb190-106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">checkInventory</span>(productId) {</span>
<span id="cb190-107"><a href="#cb190-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// In real app, this would call your backend</span></span>
<span id="cb190-108"><a href="#cb190-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/inventory/</span><span class="sc">${</span>productId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb190-109"><a href="#cb190-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb190-110"><a href="#cb190-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">.</span><span class="at">available</span><span class="op">;</span></span>
<span id="cb190-111"><a href="#cb190-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-112"><a href="#cb190-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-113"><a href="#cb190-113" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">calculatePrice</span>(product<span class="op">,</span> quantity) {</span>
<span id="cb190-114"><a href="#cb190-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply business logic: bulk discounts, promotions, etc.</span></span>
<span id="cb190-115"><a href="#cb190-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> unitPrice <span class="op">=</span> product<span class="op">.</span><span class="at">price</span><span class="op">;</span></span>
<span id="cb190-116"><a href="#cb190-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-117"><a href="#cb190-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bulk discount: 10% off for 5+ items</span></span>
<span id="cb190-118"><a href="#cb190-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (quantity <span class="op">&gt;=</span> <span class="dv">5</span>) {</span>
<span id="cb190-119"><a href="#cb190-119" aria-hidden="true" tabindex="-1"></a>      unitPrice <span class="op">=</span> unitPrice <span class="op">*</span> <span class="fl">0.9</span><span class="op">;</span></span>
<span id="cb190-120"><a href="#cb190-120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-121"><a href="#cb190-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-122"><a href="#cb190-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span><span class="al">TODO</span><span class="co">: Check for active promotions</span></span>
<span id="cb190-123"><a href="#cb190-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span><span class="al">TODO</span><span class="co">: Apply user-specific pricing</span></span>
<span id="cb190-124"><a href="#cb190-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-125"><a href="#cb190-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb190-126"><a href="#cb190-126" aria-hidden="true" tabindex="-1"></a>      unitPrice<span class="op">,</span></span>
<span id="cb190-127"><a href="#cb190-127" aria-hidden="true" tabindex="-1"></a>      quantity<span class="op">,</span></span>
<span id="cb190-128"><a href="#cb190-128" aria-hidden="true" tabindex="-1"></a>      <span class="dt">subtotal</span><span class="op">:</span> unitPrice <span class="op">*</span> quantity<span class="op">,</span></span>
<span id="cb190-129"><a href="#cb190-129" aria-hidden="true" tabindex="-1"></a>      <span class="dt">discount</span><span class="op">:</span> quantity <span class="op">&gt;=</span> <span class="dv">5</span> <span class="op">?</span> (product<span class="op">.</span><span class="at">price</span> <span class="op">-</span> unitPrice) <span class="op">*</span> quantity <span class="op">:</span> <span class="dv">0</span></span>
<span id="cb190-130"><a href="#cb190-130" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-131"><a href="#cb190-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-132"><a href="#cb190-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb190-133"><a href="#cb190-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-134"><a href="#cb190-134" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize and export</span></span>
<span id="cb190-135"><a href="#cb190-135" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cartRules <span class="op">=</span> <span class="kw">new</span> <span class="fu">CartBusinessRules</span>()<span class="op">;</span></span>
<span id="cb190-136"><a href="#cb190-136" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> cartRules<span class="op">;</span></span></code></pre></div>
<p>Now in your main application file:</p>
<div class="sourceCode" id="cb191"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app.js</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartRules <span class="im">from</span> <span class="st">&#39;./business-logic/cart-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize business logic</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>cartRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Your components just publish events - the business logic handles the rest</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="co">// No business logic in components themselves!</span></span></code></pre></div>
<p>Your components remain simple and focused on UI:</p>
<div class="sourceCode" id="cb192"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/product-card.js</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... component setup ...</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleAddToCart</span>() {</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Just publish the event - business logic will validate</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> {</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">product</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">,</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">quantity</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show optimistic UI</span></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showAddingState</span>()<span class="op">;</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">connectedCallback</span>()<span class="op">;</span></span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for validation results</span></span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsubscribers</span> <span class="op">=</span> [</span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.item.validated&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (data<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>()<span class="op">;</span></span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> (error) <span class="kw">=&gt;</span> {</span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="8.2.3" id="advantages"><span
class="header-section-number">8.2.3</span> Advantages</h3>
<p>This pattern provides several key benefits:</p>
<ol type="1">
<li><strong>Separation of Concerns</strong>: Components handle UI,
business logic modules handle rules</li>
<li><strong>Easy Testing</strong>: Test business logic without rendering
components</li>
<li><strong>Centralized Rules</strong>: All cart rules in one place,
easy to modify</li>
<li><strong>Reusable</strong>: Multiple components can trigger the same
logic</li>
<li><strong>Flexible</strong>: Easy to add, remove, or modify rules</li>
</ol>
<h3 data-number="8.2.4" id="advanced-composable-business-logic"><span
class="header-section-number">8.2.4</span> Advanced: Composable Business
Logic</h3>
<p>For larger applications, you can compose multiple business logic
modules:</p>
<div class="sourceCode" id="cb193"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">// business-logic/index.js</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartRules <span class="im">from</span> <span class="st">&#39;./cart-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pricingRules <span class="im">from</span> <span class="st">&#39;./pricing-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inventoryRules <span class="im">from</span> <span class="st">&#39;./inventory-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> analyticsRules <span class="im">from</span> <span class="st">&#39;./analytics-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">initBusinessLogic</span>() {</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Initializing business logic...&#39;</span>)<span class="op">;</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize all business logic modules</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>  cartRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>  pricingRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>  inventoryRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>  analyticsRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Business logic ready&#39;</span>)<span class="op">;</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb194"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app.js</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { initBusinessLogic } <span class="im">from</span> <span class="st">&#39;./business-logic/index.js&#39;</span><span class="op">;</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Single call to initialize all business logic</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a><span class="fu">initBusinessLogic</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.3" id="pattern-2-extending-components"><span
class="header-section-number">8.3</span> Pattern 2: Extending
Components</h2>
<p>Sometimes you need to add business logic directly to a component,
especially when:</p>
<ul>
<li>The logic is specific to one component type</li>
<li>You need to override component behavior</li>
<li>You’re creating specialized versions of generic components</li>
</ul>
<h3 data-number="8.3.1" id="when-to-use-1"><span
class="header-section-number">8.3.1</span> When to Use</h3>
<p>Use component extension when:</p>
<ul>
<li>Logic is tightly coupled to component rendering</li>
<li>You need access to component internals (Shadow DOM, private
methods)</li>
<li>Creating specialized variants of base components</li>
<li>Logic doesn’t need to be shared across different component
types</li>
</ul>
<h3 data-number="8.3.2" id="implementation"><span
class="header-section-number">8.3.2</span> Implementation</h3>
<p>Let’s extend a generic product card with business-specific
behavior:</p>
<div class="sourceCode" id="cb195"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/base/product-card.js</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> ProductCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* Base styles */</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;card&quot;&gt;</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;img src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">image</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p class=&quot;price&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatPrice</span>(<span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span>)<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;add-to-cart&quot;&gt;Add to Cart&lt;/button&gt;</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.add-to-cart&#39;</span>)</span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleAddToCart</span>())<span class="op">;</span></span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleAddToCart</span>() {</span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> {</span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">product</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">,</span></span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatPrice</span>(price) {</span>
<span id="cb195-33"><a href="#cb195-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`$</span><span class="sc">${</span>price<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb195-34"><a href="#cb195-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-35"><a href="#cb195-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-36"><a href="#cb195-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">product</span>() {</span>
<span id="cb195-37"><a href="#cb195-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;product&#39;</span>))<span class="op">;</span></span>
<span id="cb195-38"><a href="#cb195-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-39"><a href="#cb195-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb195-40"><a href="#cb195-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-41"><a href="#cb195-41" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;product-card&#39;</span><span class="op">,</span> ProductCard)<span class="op">;</span></span></code></pre></div>
<p>Now extend it with business-specific logic:</p>
<div class="sourceCode" id="cb196"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/premium-product-card.js</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ProductCard } <span class="im">from</span> <span class="st">&#39;./base/product-card.js&#39;</span><span class="op">;</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> PremiumProductCard <span class="kw">extends</span> ProductCard {</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">connectedCallback</span>()<span class="op">;</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add business-specific subscriptions</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_unsubscribers</span> <span class="op">=</span> [</span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;pricing.update&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handlePriceUpdate</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">,</span></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.tier.changed&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleTierChange</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))</span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize premium features</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadMemberPricing</span>()<span class="op">;</span></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadMemberPricing</span>() {</span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (user<span class="op">?.</span><span class="at">tier</span> <span class="op">===</span> <span class="st">&#39;premium&#39;</span>) {</span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">applyPremiumDiscount</span>()<span class="op">;</span></span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-25"><a href="#cb196-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyPremiumDiscount</span>() {</span>
<span id="cb196-26"><a href="#cb196-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: 15% discount for premium members</span></span>
<span id="cb196-27"><a href="#cb196-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> discount <span class="op">=</span> <span class="fl">0.15</span><span class="op">;</span></span>
<span id="cb196-28"><a href="#cb196-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalPrice <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span><span class="op">;</span></span>
<span id="cb196-29"><a href="#cb196-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> discountedPrice <span class="op">=</span> originalPrice <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> discount)<span class="op">;</span></span>
<span id="cb196-30"><a href="#cb196-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-31"><a href="#cb196-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span> <span class="op">=</span> discountedPrice<span class="op">;</span></span>
<span id="cb196-32"><a href="#cb196-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">originalPrice</span> <span class="op">=</span> originalPrice<span class="op">;</span></span>
<span id="cb196-33"><a href="#cb196-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-34"><a href="#cb196-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span> <span class="co">// Re-render with new price</span></span>
<span id="cb196-35"><a href="#cb196-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-36"><a href="#cb196-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-37"><a href="#cb196-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb196-38"><a href="#cb196-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call parent render</span></span>
<span id="cb196-39"><a href="#cb196-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb196-40"><a href="#cb196-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-41"><a href="#cb196-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add premium badge if applicable</span></span>
<span id="cb196-42"><a href="#cb196-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">originalPrice</span>) {</span>
<span id="cb196-43"><a href="#cb196-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">addPremiumBadge</span>()<span class="op">;</span></span>
<span id="cb196-44"><a href="#cb196-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb196-45"><a href="#cb196-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-46"><a href="#cb196-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-47"><a href="#cb196-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPremiumBadge</span>() {</span>
<span id="cb196-48"><a href="#cb196-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> badge <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb196-49"><a href="#cb196-49" aria-hidden="true" tabindex="-1"></a>    badge<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;premium-badge&#39;</span><span class="op">;</span></span>
<span id="cb196-50"><a href="#cb196-50" aria-hidden="true" tabindex="-1"></a>    badge<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb196-51"><a href="#cb196-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb196-52"><a href="#cb196-52" aria-hidden="true" tabindex="-1"></a><span class="vs">        .premium-badge {</span></span>
<span id="cb196-53"><a href="#cb196-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb196-54"><a href="#cb196-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 10px;</span></span>
<span id="cb196-55"><a href="#cb196-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 10px;</span></span>
<span id="cb196-56"><a href="#cb196-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: gold;</span></span>
<span id="cb196-57"><a href="#cb196-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: black;</span></span>
<span id="cb196-58"><a href="#cb196-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 5px 10px;</span></span>
<span id="cb196-59"><a href="#cb196-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 3px;</span></span>
<span id="cb196-60"><a href="#cb196-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb196-61"><a href="#cb196-61" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb196-62"><a href="#cb196-62" aria-hidden="true" tabindex="-1"></a><span class="vs">        .original-price {</span></span>
<span id="cb196-63"><a href="#cb196-63" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-decoration: line-through;</span></span>
<span id="cb196-64"><a href="#cb196-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #999;</span></span>
<span id="cb196-65"><a href="#cb196-65" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 0.9em;</span></span>
<span id="cb196-66"><a href="#cb196-66" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb196-67"><a href="#cb196-67" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb196-68"><a href="#cb196-68" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span&gt;Premium Member&lt;/span&gt;</span></span>
<span id="cb196-69"><a href="#cb196-69" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;original-price&quot;&gt;</span></span>
<span id="cb196-70"><a href="#cb196-70" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatPrice</span>(<span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">originalPrice</span>)<span class="sc">}</span></span>
<span id="cb196-71"><a href="#cb196-71" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb196-72"><a href="#cb196-72" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb196-73"><a href="#cb196-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-74"><a href="#cb196-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.card&#39;</span>)<span class="op">.</span><span class="fu">prepend</span>(badge)<span class="op">;</span></span>
<span id="cb196-75"><a href="#cb196-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-76"><a href="#cb196-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-77"><a href="#cb196-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleAddToCart</span>() {</span>
<span id="cb196-78"><a href="#cb196-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business validation before adding</span></span>
<span id="cb196-79"><a href="#cb196-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> canAddPremiumItem <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validatePremiumAccess</span>()<span class="op">;</span></span>
<span id="cb196-80"><a href="#cb196-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-81"><a href="#cb196-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>canAddPremiumItem) {</span>
<span id="cb196-82"><a href="#cb196-82" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;app.error&#39;</span><span class="op">,</span> {</span>
<span id="cb196-83"><a href="#cb196-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Premium membership required for this product&#39;</span></span>
<span id="cb196-84"><a href="#cb196-84" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb196-85"><a href="#cb196-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb196-86"><a href="#cb196-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb196-87"><a href="#cb196-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-88"><a href="#cb196-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track premium conversions</span></span>
<span id="cb196-89"><a href="#cb196-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">trackPremiumConversion</span>()<span class="op">;</span></span>
<span id="cb196-90"><a href="#cb196-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-91"><a href="#cb196-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call parent behavior</span></span>
<span id="cb196-92"><a href="#cb196-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="fu">handleAddToCart</span>()<span class="op">;</span></span>
<span id="cb196-93"><a href="#cb196-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-94"><a href="#cb196-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-95"><a href="#cb196-95" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">validatePremiumAccess</span>() {</span>
<span id="cb196-96"><a href="#cb196-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">premiumOnly</span>) <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb196-97"><a href="#cb196-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-98"><a href="#cb196-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb196-99"><a href="#cb196-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user<span class="op">?.</span><span class="at">tier</span> <span class="op">===</span> <span class="st">&#39;premium&#39;</span><span class="op">;</span></span>
<span id="cb196-100"><a href="#cb196-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-101"><a href="#cb196-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-102"><a href="#cb196-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trackPremiumConversion</span>() {</span>
<span id="cb196-103"><a href="#cb196-103" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;analytics.track&#39;</span><span class="op">,</span> {</span>
<span id="cb196-104"><a href="#cb196-104" aria-hidden="true" tabindex="-1"></a>      <span class="dt">event</span><span class="op">:</span> <span class="st">&#39;premium_product_add_to_cart&#39;</span><span class="op">,</span></span>
<span id="cb196-105"><a href="#cb196-105" aria-hidden="true" tabindex="-1"></a>      <span class="dt">product</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb196-106"><a href="#cb196-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">price</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span><span class="op">,</span></span>
<span id="cb196-107"><a href="#cb196-107" aria-hidden="true" tabindex="-1"></a>      <span class="dt">discount</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">originalPrice</span> <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span></span>
<span id="cb196-108"><a href="#cb196-108" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb196-109"><a href="#cb196-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-110"><a href="#cb196-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-111"><a href="#cb196-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handlePriceUpdate</span>(data) {</span>
<span id="cb196-112"><a href="#cb196-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">productId</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb196-113"><a href="#cb196-113" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">price</span> <span class="op">=</span> data<span class="op">.</span><span class="at">newPrice</span><span class="op">;</span></span>
<span id="cb196-114"><a href="#cb196-114" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb196-115"><a href="#cb196-115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb196-116"><a href="#cb196-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-117"><a href="#cb196-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-118"><a href="#cb196-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleTierChange</span>(data) {</span>
<span id="cb196-119"><a href="#cb196-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">// User tier changed - recalculate pricing</span></span>
<span id="cb196-120"><a href="#cb196-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadMemberPricing</span>()<span class="op">;</span></span>
<span id="cb196-121"><a href="#cb196-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-122"><a href="#cb196-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-123"><a href="#cb196-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb196-124"><a href="#cb196-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up subscriptions</span></span>
<span id="cb196-125"><a href="#cb196-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_unsubscribers</span><span class="op">.</span><span class="fu">forEach</span>(unsub <span class="kw">=&gt;</span> <span class="fu">unsub</span>())<span class="op">;</span></span>
<span id="cb196-126"><a href="#cb196-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="at">disconnectedCallback</span><span class="op">?.</span>()<span class="op">;</span></span>
<span id="cb196-127"><a href="#cb196-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb196-128"><a href="#cb196-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb196-129"><a href="#cb196-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-130"><a href="#cb196-130" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;premium-product-card&#39;</span><span class="op">,</span> PremiumProductCard)<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.3.3" id="when-this-makes-sense"><span
class="header-section-number">8.3.3</span> When This Makes Sense</h3>
<p>Component extension works well when:</p>
<ol type="1">
<li><strong>The logic changes how the component renders or
behaves</strong></li>
<li><strong>You need multiple variants of a base component</strong>
(premium, free, guest, etc.)</li>
<li><strong>Business logic is closely tied to component
lifecycle</strong></li>
</ol>
<p>However, be cautious: overuse of extension can lead to:</p>
<ul>
<li>Tight coupling between business logic and UI</li>
<li>Harder to test business rules independently</li>
<li>Duplication if multiple components need the same logic</li>
</ul>
<h2 data-number="8.4" id="pattern-3-wrapper-components"><span
class="header-section-number">8.4</span> Pattern 3: Wrapper
Components</h2>
<p>Wrapper components let you add behavior around existing components
without modifying them. This is useful when you want to:</p>
<ul>
<li>Add behavior to third-party components</li>
<li>Keep base components pristine</li>
<li>Compose behaviors dynamically</li>
</ul>
<h3 data-number="8.4.1" id="implementation-1"><span
class="header-section-number">8.4.1</span> Implementation</h3>
<div class="sourceCode" id="cb197"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/business-wrapper.js</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BusinessWrapper <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intercept events from slotted content</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;add-to-cart&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleBusinessLogic</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        .validation-message {</span></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: red;</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px;</span></span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #fee;</span></span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 10px;</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        .validation-message.hidden {</span></span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;validation-message hidden&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleBusinessLogic</span>(e) {</span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stop the event from propagating immediately</span></span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">stopPropagation</span>()<span class="op">;</span></span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply business validation</span></span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validation <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateBusinessRules</span>(e<span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>validation<span class="op">.</span><span class="at">valid</span>) {</span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(validation<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-42"><a href="#cb197-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validation passed - let the event continue</span></span>
<span id="cb197-43"><a href="#cb197-43" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> e<span class="op">.</span><span class="at">detail</span>)<span class="op">;</span></span>
<span id="cb197-44"><a href="#cb197-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-45"><a href="#cb197-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-46"><a href="#cb197-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">validateBusinessRules</span>(data) {</span>
<span id="cb197-47"><a href="#cb197-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check user eligibility</span></span>
<span id="cb197-48"><a href="#cb197-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb197-49"><a href="#cb197-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb197-50"><a href="#cb197-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb197-51"><a href="#cb197-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">valid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb197-52"><a href="#cb197-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Please log in to add items to cart&#39;</span></span>
<span id="cb197-53"><a href="#cb197-53" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb197-54"><a href="#cb197-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-55"><a href="#cb197-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-56"><a href="#cb197-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check age restriction</span></span>
<span id="cb197-57"><a href="#cb197-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">ageRestricted</span> <span class="op">&amp;&amp;</span> user<span class="op">.</span><span class="at">age</span> <span class="op">&lt;</span> <span class="dv">21</span>) {</span>
<span id="cb197-58"><a href="#cb197-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb197-59"><a href="#cb197-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">valid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb197-60"><a href="#cb197-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;This product requires age verification (21+)&#39;</span></span>
<span id="cb197-61"><a href="#cb197-61" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb197-62"><a href="#cb197-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-63"><a href="#cb197-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-64"><a href="#cb197-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check geographic restriction</span></span>
<span id="cb197-65"><a href="#cb197-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (data<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">geoRestricted</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">isAllowedRegion</span>(user<span class="op">.</span><span class="at">region</span>)) {</span>
<span id="cb197-66"><a href="#cb197-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb197-67"><a href="#cb197-67" aria-hidden="true" tabindex="-1"></a>        <span class="dt">valid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb197-68"><a href="#cb197-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;This product is not available in your region&#39;</span></span>
<span id="cb197-69"><a href="#cb197-69" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb197-70"><a href="#cb197-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-71"><a href="#cb197-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-72"><a href="#cb197-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">valid</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">;</span></span>
<span id="cb197-73"><a href="#cb197-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-74"><a href="#cb197-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-75"><a href="#cb197-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isAllowedRegion</span>(region) {</span>
<span id="cb197-76"><a href="#cb197-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business logic for regional restrictions</span></span>
<span id="cb197-77"><a href="#cb197-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> allowedRegions <span class="op">=</span> [<span class="st">&#39;US&#39;</span><span class="op">,</span> <span class="st">&#39;CA&#39;</span><span class="op">,</span> <span class="st">&#39;UK&#39;</span>]<span class="op">;</span></span>
<span id="cb197-78"><a href="#cb197-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> allowedRegions<span class="op">.</span><span class="fu">includes</span>(region)<span class="op">;</span></span>
<span id="cb197-79"><a href="#cb197-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-80"><a href="#cb197-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-81"><a href="#cb197-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(message) {</span>
<span id="cb197-82"><a href="#cb197-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errorEl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.validation-message&#39;</span>)<span class="op">;</span></span>
<span id="cb197-83"><a href="#cb197-83" aria-hidden="true" tabindex="-1"></a>    errorEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> message<span class="op">;</span></span>
<span id="cb197-84"><a href="#cb197-84" aria-hidden="true" tabindex="-1"></a>    errorEl<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span></span>
<span id="cb197-85"><a href="#cb197-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-86"><a href="#cb197-86" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb197-87"><a href="#cb197-87" aria-hidden="true" tabindex="-1"></a>      errorEl<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;hidden&#39;</span>)<span class="op">;</span></span>
<span id="cb197-88"><a href="#cb197-88" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb197-89"><a href="#cb197-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb197-90"><a href="#cb197-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb197-91"><a href="#cb197-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-92"><a href="#cb197-92" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;business-wrapper&#39;</span><span class="op">,</span> BusinessWrapper)<span class="op">;</span></span></code></pre></div>
<p>Usage:</p>
<div class="sourceCode" id="cb198"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Wrap any component with business logic --&gt;</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">business-wrapper</span><span class="dt">&gt;</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">product-card</span><span class="ot"> product-id</span><span class="op">=</span><span class="st">&quot;123&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">product-card</span><span class="dt">&gt;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">business-wrapper</span><span class="dt">&gt;</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">business-wrapper</span><span class="dt">&gt;</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">quick-buy-button</span><span class="ot"> product-id</span><span class="op">=</span><span class="st">&quot;456&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">quick-buy-button</span><span class="dt">&gt;</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">business-wrapper</span><span class="dt">&gt;</span></span></code></pre></div>
<p>The wrapper intercepts events and applies business logic
<strong>without modifying</strong> the wrapped components.</p>
<h2 data-number="8.5" id="pattern-4-behavior-mixins"><span
class="header-section-number">8.5</span> Pattern 4: Behavior Mixins</h2>
<p>Mixins let you share behavior across multiple component types. This
is useful for cross-cutting concerns like analytics, logging, or
validation.</p>
<h3 data-number="8.5.1" id="implementation-2"><span
class="header-section-number">8.5.1</span> Implementation</h3>
<div class="sourceCode" id="cb199"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixins/analytics-mixin.js</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> AnalyticsMixin <span class="op">=</span> (BaseClass) <span class="kw">=&gt;</span> <span class="kw">class</span> <span class="kw">extends</span> BaseClass {</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">track</span>(<span class="bu">event</span><span class="op">,</span> data <span class="op">=</span> {}) {</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;analytics.track&#39;</span><span class="op">,</span> {</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">,</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">component</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">,</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">,</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAnalyticsContext</span>()</span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trackInteraction</span>(element<span class="op">,</span> action) {</span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">track</span>(<span class="vs">`</span><span class="sc">${</span>element<span class="sc">}</span><span class="vs">.</span><span class="sc">${</span>action<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>      element<span class="op">,</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>      action</span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAnalyticsContext</span>() {</span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add common context to all analytics events</span></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">page</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span><span class="op">,</span></span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">referrer</span><span class="op">:</span> <span class="bu">document</span><span class="op">.</span><span class="at">referrer</span></span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="at">connectedCallback</span><span class="op">?.</span>()<span class="op">;</span></span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">track</span>(<span class="st">&#39;component.mounted&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-32"><a href="#cb199-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-33"><a href="#cb199-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb199-34"><a href="#cb199-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">track</span>(<span class="st">&#39;component.unmounted&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb199-35"><a href="#cb199-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span><span class="at">disconnectedCallback</span><span class="op">?.</span>()<span class="op">;</span></span>
<span id="cb199-36"><a href="#cb199-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-37"><a href="#cb199-37" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb200"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co">// mixins/validation-mixin.js</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> ValidationMixin <span class="op">=</span> (BaseClass) <span class="kw">=&gt;</span> <span class="kw">class</span> <span class="kw">extends</span> BaseClass {</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">validate</span>(data<span class="op">,</span> rules) {</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [field<span class="op">,</span> rule] <span class="kw">of</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(rules)) {</span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> value <span class="op">=</span> data[field]<span class="op">;</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="at">required</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>value) {</span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>field<span class="sc">}</span><span class="vs"> is required`</span>)<span class="op">;</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="at">min</span> <span class="op">&amp;&amp;</span> value <span class="op">&lt;</span> rule<span class="op">.</span><span class="at">min</span>) {</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>field<span class="sc">}</span><span class="vs"> must be at least </span><span class="sc">${</span>rule<span class="op">.</span><span class="at">min</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="at">max</span> <span class="op">&amp;&amp;</span> value <span class="op">&gt;</span> rule<span class="op">.</span><span class="at">max</span>) {</span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>field<span class="sc">}</span><span class="vs"> must be at most </span><span class="sc">${</span>rule<span class="op">.</span><span class="at">max</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb200-20"><a href="#cb200-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-21"><a href="#cb200-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="at">pattern</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>rule<span class="op">.</span><span class="at">pattern</span><span class="op">.</span><span class="fu">test</span>(value)) {</span>
<span id="cb200-22"><a href="#cb200-22" aria-hidden="true" tabindex="-1"></a>        errors<span class="op">.</span><span class="fu">push</span>(<span class="vs">`</span><span class="sc">${</span>field<span class="sc">}</span><span class="vs"> is invalid`</span>)<span class="op">;</span></span>
<span id="cb200-23"><a href="#cb200-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb200-24"><a href="#cb200-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-25"><a href="#cb200-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (rule<span class="op">.</span><span class="at">custom</span>) {</span>
<span id="cb200-26"><a href="#cb200-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> customError <span class="op">=</span> <span class="cf">await</span> rule<span class="op">.</span><span class="fu">custom</span>(value<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb200-27"><a href="#cb200-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (customError) errors<span class="op">.</span><span class="fu">push</span>(customError)<span class="op">;</span></span>
<span id="cb200-28"><a href="#cb200-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb200-29"><a href="#cb200-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb200-30"><a href="#cb200-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-31"><a href="#cb200-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb200-32"><a href="#cb200-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">valid</span><span class="op">:</span> errors<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb200-33"><a href="#cb200-33" aria-hidden="true" tabindex="-1"></a>      errors</span>
<span id="cb200-34"><a href="#cb200-34" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb200-35"><a href="#cb200-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb200-36"><a href="#cb200-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-37"><a href="#cb200-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showValidationErrors</span>(errors) {</span>
<span id="cb200-38"><a href="#cb200-38" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;validation.errors&#39;</span><span class="op">,</span> {</span>
<span id="cb200-39"><a href="#cb200-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">component</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">,</span></span>
<span id="cb200-40"><a href="#cb200-40" aria-hidden="true" tabindex="-1"></a>      errors</span>
<span id="cb200-41"><a href="#cb200-41" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb200-42"><a href="#cb200-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb200-43"><a href="#cb200-43" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Use mixins to compose behavior:</p>
<div class="sourceCode" id="cb201"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { AnalyticsMixin } <span class="im">from</span> <span class="st">&#39;./mixins/analytics-mixin.js&#39;</span><span class="op">;</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ValidationMixin } <span class="im">from</span> <span class="st">&#39;./mixins/validation-mixin.js&#39;</span><span class="op">;</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutForm <span class="kw">extends</span> <span class="fu">ValidationMixin</span>(<span class="fu">AnalyticsMixin</span>(<span class="bu">HTMLElement</span>)) {</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>() {</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use validation from mixin</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validation <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validate</span>(<span class="kw">this</span><span class="op">.</span><span class="at">formData</span><span class="op">,</span> {</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> {</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">required</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">pattern</span><span class="op">:</span> <span class="ss">/</span><span class="sc">^[^\s@]+</span><span class="ss">@</span><span class="sc">[^\s@]+\.[^\s@]+$</span><span class="ss">/</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cardNumber</span><span class="op">:</span> {</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">required</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">custom</span><span class="op">:</span> <span class="kw">async</span> (value) <span class="kw">=&gt;</span> {</span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> valid <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateCard</span>(value)<span class="op">;</span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> valid <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> <span class="st">&#39;Invalid card number&#39;</span><span class="op">;</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>validation<span class="op">.</span><span class="at">valid</span>) {</span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showValidationErrors</span>(validation<span class="op">.</span><span class="at">errors</span>)<span class="op">;</span></span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use analytics from mixin</span></span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">track</span>(<span class="st">&#39;checkout.submit&#39;</span><span class="op">,</span> {</span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>      <span class="dt">amount</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">total</span><span class="op">,</span></span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span></span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process checkout</span></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">processOrder</span>()<span class="op">;</span></span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.6" id="pattern-5-service-layer"><span
class="header-section-number">8.6</span> Pattern 5: Service Layer</h2>
<p>For complex business logic, create a dedicated service layer that
components and PAN listeners can both use:</p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/pricing-service.js</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PricingService {</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">calculatePrice</span>(product<span class="op">,</span> quantity<span class="op">,</span> user) {</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> price <span class="op">=</span> product<span class="op">.</span><span class="at">basePrice</span><span class="op">;</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: Volume discounts</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (quantity <span class="op">&gt;=</span> <span class="dv">10</span>) price <span class="op">*=</span> <span class="fl">0.85</span><span class="op">;</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (quantity <span class="op">&gt;=</span> <span class="dv">5</span>) price <span class="op">*=</span> <span class="fl">0.90</span><span class="op">;</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: Member discounts</span></span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (user<span class="op">?.</span><span class="at">tier</span> <span class="op">===</span> <span class="st">&#39;premium&#39;</span>) {</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>      price <span class="op">*=</span> <span class="fl">0.85</span><span class="op">;</span></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (user<span class="op">?.</span><span class="at">tier</span> <span class="op">===</span> <span class="st">&#39;gold&#39;</span>) {</span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>      price <span class="op">*=</span> <span class="fl">0.90</span><span class="op">;</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business Rule: Active promotions</span></span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> promotions <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getActivePromotions</span>(product<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb202-19"><a href="#cb202-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> promo <span class="kw">of</span> promotions) {</span>
<span id="cb202-20"><a href="#cb202-20" aria-hidden="true" tabindex="-1"></a>      price <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">applyPromotion</span>(price<span class="op">,</span> promo)<span class="op">;</span></span>
<span id="cb202-21"><a href="#cb202-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb202-22"><a href="#cb202-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-23"><a href="#cb202-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb202-24"><a href="#cb202-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">unitPrice</span><span class="op">:</span> price<span class="op">,</span></span>
<span id="cb202-25"><a href="#cb202-25" aria-hidden="true" tabindex="-1"></a>      quantity<span class="op">,</span></span>
<span id="cb202-26"><a href="#cb202-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">subtotal</span><span class="op">:</span> price <span class="op">*</span> quantity<span class="op">,</span></span>
<span id="cb202-27"><a href="#cb202-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">savings</span><span class="op">:</span> (product<span class="op">.</span><span class="at">basePrice</span> <span class="op">-</span> price) <span class="op">*</span> quantity</span>
<span id="cb202-28"><a href="#cb202-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb202-29"><a href="#cb202-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb202-30"><a href="#cb202-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-31"><a href="#cb202-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getActivePromotions</span>(productId) {</span>
<span id="cb202-32"><a href="#cb202-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/promotions?product=</span><span class="sc">${</span>productId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb202-33"><a href="#cb202-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb202-34"><a href="#cb202-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb202-35"><a href="#cb202-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-36"><a href="#cb202-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyPromotion</span>(price<span class="op">,</span> promotion) {</span>
<span id="cb202-37"><a href="#cb202-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (promotion<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;percentage&#39;</span>) {</span>
<span id="cb202-38"><a href="#cb202-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> promotion<span class="op">.</span><span class="at">value</span> <span class="op">/</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb202-39"><a href="#cb202-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (promotion<span class="op">.</span><span class="at">type</span> <span class="op">===</span> <span class="st">&#39;fixed&#39;</span>) {</span>
<span id="cb202-40"><a href="#cb202-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">0</span><span class="op">,</span> price <span class="op">-</span> promotion<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb202-41"><a href="#cb202-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb202-42"><a href="#cb202-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> price<span class="op">;</span></span>
<span id="cb202-43"><a href="#cb202-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb202-44"><a href="#cb202-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-45"><a href="#cb202-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getTax</span>(subtotal<span class="op">,</span> region) {</span>
<span id="cb202-46"><a href="#cb202-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> taxRates <span class="op">=</span> {</span>
<span id="cb202-47"><a href="#cb202-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;CA&#39;</span><span class="op">:</span> <span class="fl">0.0725</span><span class="op">,</span></span>
<span id="cb202-48"><a href="#cb202-48" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;NY&#39;</span><span class="op">:</span> <span class="fl">0.08</span><span class="op">,</span></span>
<span id="cb202-49"><a href="#cb202-49" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;TX&#39;</span><span class="op">:</span> <span class="fl">0.0625</span></span>
<span id="cb202-50"><a href="#cb202-50" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb202-51"><a href="#cb202-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-52"><a href="#cb202-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subtotal <span class="op">*</span> (taxRates[region] <span class="op">||</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb202-53"><a href="#cb202-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb202-54"><a href="#cb202-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb202-55"><a href="#cb202-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-56"><a href="#cb202-56" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="kw">new</span> <span class="fu">PricingService</span>()<span class="op">;</span></span></code></pre></div>
<p>Use the service from both components and PAN listeners:</p>
<div class="sourceCode" id="cb203"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In a component</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pricingService <span class="im">from</span> <span class="st">&#39;./services/pricing-service.js&#39;</span><span class="op">;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">updatePrice</span>() {</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(</span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">,</span></span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">quantity</span><span class="op">,</span></span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>      user</span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">displayPrice</span>(pricing)<span class="op">;</span></span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb204"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In business logic</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pricingService <span class="im">from</span> <span class="st">&#39;./services/pricing-service.js&#39;</span><span class="op">;</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CartBusinessLogic {</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>() {</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> <span class="kw">async</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(</span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">product</span><span class="op">,</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">quantity</span><span class="op">,</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>        user</span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.priced&#39;</span><span class="op">,</span> { <span class="op">...</span>data<span class="op">,</span> pricing })<span class="op">;</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.7" id="decision-matrix"><span
class="header-section-number">8.7</span> Decision Matrix</h2>
<p>Here’s how to choose the right pattern:</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 55%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended Pattern</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cross-component coordination</td>
<td>PAN Bus Listeners</td>
<td>Decoupled, flexible</td>
</tr>
<tr>
<td>Analytics/logging</td>
<td>Mixins</td>
<td>Reusable across all components</td>
</tr>
<tr>
<td>Validation before actions</td>
<td>PAN Bus Listeners</td>
<td>Centralized rules</td>
</tr>
<tr>
<td>Component-specific UI logic</td>
<td>Extend Component</td>
<td>Access to internals</td>
</tr>
<tr>
<td>Add behavior to third-party components</td>
<td>Wrapper</td>
<td>Non-invasive</td>
</tr>
<tr>
<td>Complex business calculations</td>
<td>Service Layer</td>
<td>Testable, reusable</td>
</tr>
<tr>
<td>Component variants (premium, free)</td>
<td>Extend Component</td>
<td>Clear inheritance</td>
</tr>
<tr>
<td>Feature flags / A-B testing</td>
<td>Wrapper or PAN Listeners</td>
<td>Easy to toggle</td>
</tr>
</tbody>
</table>
<h2 data-number="8.8" id="real-world-example-e-commerce-checkout"><span
class="header-section-number">8.8</span> Real-World Example: E-Commerce
Checkout</h2>
<p>Let’s see how these patterns work together in a complete checkout
flow:</p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/checkout-service.js</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutService {</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">processOrder</span>(cart<span class="op">,</span> paymentInfo<span class="op">,</span> shippingInfo) {</span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Complex business logic</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculateFinalPricing</span>(cart)<span class="op">;</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> shipping <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculateShipping</span>(cart<span class="op">,</span> shippingInfo)<span class="op">;</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tax <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculateTax</span>(pricing<span class="op">.</span><span class="at">subtotal</span><span class="op">,</span> shippingInfo<span class="op">.</span><span class="at">state</span>)<span class="op">;</span></span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> cart<span class="op">.</span><span class="at">items</span><span class="op">,</span></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>      pricing<span class="op">,</span></span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a>      shipping<span class="op">,</span></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>      tax<span class="op">,</span></span>
<span id="cb205-14"><a href="#cb205-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">total</span><span class="op">:</span> pricing<span class="op">.</span><span class="at">subtotal</span> <span class="op">+</span> shipping<span class="op">.</span><span class="at">cost</span> <span class="op">+</span> tax</span>
<span id="cb205-15"><a href="#cb205-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb205-16"><a href="#cb205-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-17"><a href="#cb205-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-18"><a href="#cb205-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">calculateFinalPricing</span>(cart) {</span>
<span id="cb205-19"><a href="#cb205-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply all discounts, coupons, etc.</span></span>
<span id="cb205-20"><a href="#cb205-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> subtotal <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb205-21"><a href="#cb205-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> savings <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb205-22"><a href="#cb205-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-23"><a href="#cb205-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> item <span class="kw">of</span> cart<span class="op">.</span><span class="at">items</span>) {</span>
<span id="cb205-24"><a href="#cb205-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> itemPricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(</span>
<span id="cb205-25"><a href="#cb205-25" aria-hidden="true" tabindex="-1"></a>        item<span class="op">.</span><span class="at">product</span><span class="op">,</span></span>
<span id="cb205-26"><a href="#cb205-26" aria-hidden="true" tabindex="-1"></a>        item<span class="op">.</span><span class="at">quantity</span><span class="op">,</span></span>
<span id="cb205-27"><a href="#cb205-27" aria-hidden="true" tabindex="-1"></a>        cart<span class="op">.</span><span class="at">user</span></span>
<span id="cb205-28"><a href="#cb205-28" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb205-29"><a href="#cb205-29" aria-hidden="true" tabindex="-1"></a>      subtotal <span class="op">+=</span> itemPricing<span class="op">.</span><span class="at">subtotal</span><span class="op">;</span></span>
<span id="cb205-30"><a href="#cb205-30" aria-hidden="true" tabindex="-1"></a>      savings <span class="op">+=</span> itemPricing<span class="op">.</span><span class="at">savings</span><span class="op">;</span></span>
<span id="cb205-31"><a href="#cb205-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb205-32"><a href="#cb205-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-33"><a href="#cb205-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { subtotal<span class="op">,</span> savings }<span class="op">;</span></span>
<span id="cb205-34"><a href="#cb205-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-35"><a href="#cb205-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-36"><a href="#cb205-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">calculateShipping</span>(cart<span class="op">,</span> shippingInfo) {</span>
<span id="cb205-37"><a href="#cb205-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Shipping business rules</span></span>
<span id="cb205-38"><a href="#cb205-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cart<span class="op">.</span><span class="at">total</span> <span class="op">&gt;=</span> <span class="dv">50</span>) {</span>
<span id="cb205-39"><a href="#cb205-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;standard&#39;</span><span class="op">,</span> <span class="dt">cost</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">freeShipping</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">;</span></span>
<span id="cb205-40"><a href="#cb205-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb205-41"><a href="#cb205-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-42"><a href="#cb205-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> weight <span class="op">=</span> cart<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">weight</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb205-43"><a href="#cb205-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> zone <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getShippingZone</span>(shippingInfo<span class="op">.</span><span class="at">state</span>)<span class="op">;</span></span>
<span id="cb205-44"><a href="#cb205-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-45"><a href="#cb205-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb205-46"><a href="#cb205-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;standard&#39;</span><span class="op">,</span></span>
<span id="cb205-47"><a href="#cb205-47" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cost</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">calculateShippingCost</span>(weight<span class="op">,</span> zone)<span class="op">,</span></span>
<span id="cb205-48"><a href="#cb205-48" aria-hidden="true" tabindex="-1"></a>      <span class="dt">freeShipping</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb205-49"><a href="#cb205-49" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb205-50"><a href="#cb205-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-51"><a href="#cb205-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-52"><a href="#cb205-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculateShippingCost</span>(weight<span class="op">,</span> zone) {</span>
<span id="cb205-53"><a href="#cb205-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> baseRate <span class="op">=</span> { <span class="dv">1</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">2</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">3</span><span class="op">:</span> <span class="dv">10</span> }<span class="op">;</span></span>
<span id="cb205-54"><a href="#cb205-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> baseRate[zone] <span class="op">+</span> (weight <span class="op">&gt;</span> <span class="dv">5</span> <span class="op">?</span> (weight <span class="op">-</span> <span class="dv">5</span>) <span class="op">*</span> <span class="fl">0.5</span> <span class="op">:</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb205-55"><a href="#cb205-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-56"><a href="#cb205-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-57"><a href="#cb205-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getShippingZone</span>(state) {</span>
<span id="cb205-58"><a href="#cb205-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> zones <span class="op">=</span> {</span>
<span id="cb205-59"><a href="#cb205-59" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> [<span class="st">&#39;CA&#39;</span><span class="op">,</span> <span class="st">&#39;OR&#39;</span><span class="op">,</span> <span class="st">&#39;WA&#39;</span>]<span class="op">,</span></span>
<span id="cb205-60"><a href="#cb205-60" aria-hidden="true" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> [<span class="st">&#39;NV&#39;</span><span class="op">,</span> <span class="st">&#39;AZ&#39;</span><span class="op">,</span> <span class="st">&#39;UT&#39;</span><span class="op">,</span> <span class="st">&#39;ID&#39;</span>]<span class="op">,</span></span>
<span id="cb205-61"><a href="#cb205-61" aria-hidden="true" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> [] <span class="co">// All other states</span></span>
<span id="cb205-62"><a href="#cb205-62" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb205-63"><a href="#cb205-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-64"><a href="#cb205-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [zone<span class="op">,</span> states] <span class="kw">of</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(zones)) {</span>
<span id="cb205-65"><a href="#cb205-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (states<span class="op">.</span><span class="fu">includes</span>(state)) <span class="cf">return</span> <span class="pp">parseInt</span>(zone)<span class="op">;</span></span>
<span id="cb205-66"><a href="#cb205-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb205-67"><a href="#cb205-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb205-68"><a href="#cb205-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-69"><a href="#cb205-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-70"><a href="#cb205-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">calculateTax</span>(subtotal<span class="op">,</span> state) {</span>
<span id="cb205-71"><a href="#cb205-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pricingService<span class="op">.</span><span class="fu">getTax</span>(subtotal<span class="op">,</span> state)<span class="op">;</span></span>
<span id="cb205-72"><a href="#cb205-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-73"><a href="#cb205-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb205-74"><a href="#cb205-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-75"><a href="#cb205-75" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="kw">new</span> <span class="fu">CheckoutService</span>()<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb206"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co">// business-logic/checkout-rules.js</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> checkoutService <span class="im">from</span> <span class="st">&#39;../services/checkout-service.js&#39;</span><span class="op">;</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutBusinessRules {</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">init</span>() {</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.start&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleCheckoutStart</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.submit&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleCheckoutSubmit</span><span class="op">.</span><span class="fu">bind</span>(<span class="kw">this</span>))<span class="op">;</span></span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleCheckoutStart</span>(data) {</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business validations</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cart <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;cart.get&#39;</span>)<span class="op">;</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validation 1: Cart not empty</span></span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>cart<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;EMPTY_CART&#39;</span><span class="op">,</span></span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Your cart is empty&#39;</span></span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validation 2: User logged in</span></span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user) {</span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;AUTH_REQUIRED&#39;</span><span class="op">,</span></span>
<span id="cb206-28"><a href="#cb206-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Please log in to continue&#39;</span></span>
<span id="cb206-29"><a href="#cb206-29" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb206-30"><a href="#cb206-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb206-31"><a href="#cb206-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb206-32"><a href="#cb206-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-33"><a href="#cb206-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validation 3: Inventory check</span></span>
<span id="cb206-34"><a href="#cb206-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> item <span class="kw">of</span> cart<span class="op">.</span><span class="at">items</span>) {</span>
<span id="cb206-35"><a href="#cb206-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> available <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">checkInventory</span>(item<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb206-36"><a href="#cb206-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (available <span class="op">&lt;</span> item<span class="op">.</span><span class="at">quantity</span>) {</span>
<span id="cb206-37"><a href="#cb206-37" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb206-38"><a href="#cb206-38" aria-hidden="true" tabindex="-1"></a>          <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;INSUFFICIENT_INVENTORY&#39;</span><span class="op">,</span></span>
<span id="cb206-39"><a href="#cb206-39" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> <span class="vs">`Only </span><span class="sc">${</span>available<span class="sc">}</span><span class="vs"> of &quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot; available`</span><span class="op">,</span></span>
<span id="cb206-40"><a href="#cb206-40" aria-hidden="true" tabindex="-1"></a>          item</span>
<span id="cb206-41"><a href="#cb206-41" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb206-42"><a href="#cb206-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb206-43"><a href="#cb206-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb206-44"><a href="#cb206-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb206-45"><a href="#cb206-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-46"><a href="#cb206-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All validations passed</span></span>
<span id="cb206-47"><a href="#cb206-47" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.validated&#39;</span><span class="op">,</span> { cart<span class="op">,</span> user })<span class="op">;</span></span>
<span id="cb206-48"><a href="#cb206-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb206-49"><a href="#cb206-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-50"><a href="#cb206-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleCheckoutSubmit</span>(data) {</span>
<span id="cb206-51"><a href="#cb206-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb206-52"><a href="#cb206-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Process order through service</span></span>
<span id="cb206-53"><a href="#cb206-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> order <span class="op">=</span> <span class="cf">await</span> checkoutService<span class="op">.</span><span class="fu">processOrder</span>(</span>
<span id="cb206-54"><a href="#cb206-54" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">cart</span><span class="op">,</span></span>
<span id="cb206-55"><a href="#cb206-55" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">paymentInfo</span><span class="op">,</span></span>
<span id="cb206-56"><a href="#cb206-56" aria-hidden="true" tabindex="-1"></a>        data<span class="op">.</span><span class="at">shippingInfo</span></span>
<span id="cb206-57"><a href="#cb206-57" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb206-58"><a href="#cb206-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-59"><a href="#cb206-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Submit to backend</span></span>
<span id="cb206-60"><a href="#cb206-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/orders&#39;</span><span class="op">,</span> {</span>
<span id="cb206-61"><a href="#cb206-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb206-62"><a href="#cb206-62" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb206-63"><a href="#cb206-63" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(order)</span>
<span id="cb206-64"><a href="#cb206-64" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb206-65"><a href="#cb206-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-66"><a href="#cb206-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb206-67"><a href="#cb206-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Order submission failed&#39;</span>)<span class="op">;</span></span>
<span id="cb206-68"><a href="#cb206-68" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb206-69"><a href="#cb206-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-70"><a href="#cb206-70" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb206-71"><a href="#cb206-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-72"><a href="#cb206-72" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Success</span></span>
<span id="cb206-73"><a href="#cb206-73" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.success&#39;</span><span class="op">,</span> {</span>
<span id="cb206-74"><a href="#cb206-74" aria-hidden="true" tabindex="-1"></a>        <span class="dt">orderId</span><span class="op">:</span> result<span class="op">.</span><span class="at">orderId</span><span class="op">,</span></span>
<span id="cb206-75"><a href="#cb206-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">order</span><span class="op">:</span> result</span>
<span id="cb206-76"><a href="#cb206-76" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb206-77"><a href="#cb206-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-78"><a href="#cb206-78" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Clear cart</span></span>
<span id="cb206-79"><a href="#cb206-79" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.clear&#39;</span>)<span class="op">;</span></span>
<span id="cb206-80"><a href="#cb206-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-81"><a href="#cb206-81" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb206-82"><a href="#cb206-82" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb206-83"><a href="#cb206-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;SUBMISSION_FAILED&#39;</span><span class="op">,</span></span>
<span id="cb206-84"><a href="#cb206-84" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Unable to process order. Please try again.&#39;</span><span class="op">,</span></span>
<span id="cb206-85"><a href="#cb206-85" aria-hidden="true" tabindex="-1"></a>        error</span>
<span id="cb206-86"><a href="#cb206-86" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb206-87"><a href="#cb206-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb206-88"><a href="#cb206-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb206-89"><a href="#cb206-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-90"><a href="#cb206-90" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">checkInventory</span>(productId) {</span>
<span id="cb206-91"><a href="#cb206-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/inventory/</span><span class="sc">${</span>productId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb206-92"><a href="#cb206-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb206-93"><a href="#cb206-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">.</span><span class="at">available</span><span class="op">;</span></span>
<span id="cb206-94"><a href="#cb206-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb206-95"><a href="#cb206-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb206-96"><a href="#cb206-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-97"><a href="#cb206-97" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> <span class="kw">new</span> <span class="fu">CheckoutBusinessRules</span>()<span class="op">;</span></span></code></pre></div>
<p>The checkout component stays simple:</p>
<div class="sourceCode" id="cb207"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/checkout-form.js</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachEventListeners</span>()<span class="op">;</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">subscribeToEvents</span>()<span class="op">;</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribeToEvents</span>() {</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_unsubscribers</span> <span class="op">=</span> [</span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.validated&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showCheckoutForm</span>()<span class="op">;</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> (error) <span class="kw">=&gt;</span> {</span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;checkout.success&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>(data<span class="op">.</span><span class="at">orderId</span>)<span class="op">;</span></span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleSubmit</span>(e) {</span>
<span id="cb207-27"><a href="#cb207-27" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb207-28"><a href="#cb207-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-29"><a href="#cb207-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Just collect data and publish - business logic handles the rest</span></span>
<span id="cb207-30"><a href="#cb207-30" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.submit&#39;</span><span class="op">,</span> {</span>
<span id="cb207-31"><a href="#cb207-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cart</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">cart</span><span class="op">,</span></span>
<span id="cb207-32"><a href="#cb207-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">paymentInfo</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getPaymentInfo</span>()<span class="op">,</span></span>
<span id="cb207-33"><a href="#cb207-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">shippingInfo</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getShippingInfo</span>()</span>
<span id="cb207-34"><a href="#cb207-34" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb207-35"><a href="#cb207-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-36"><a href="#cb207-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">showProcessing</span>()<span class="op">;</span></span>
<span id="cb207-37"><a href="#cb207-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb207-38"><a href="#cb207-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-39"><a href="#cb207-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// UI methods only - no business logic</span></span>
<span id="cb207-40"><a href="#cb207-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showCheckoutForm</span>() { <span class="co">/* ... */</span> }</span>
<span id="cb207-41"><a href="#cb207-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(message) { <span class="co">/* ... */</span> }</span>
<span id="cb207-42"><a href="#cb207-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showSuccess</span>(orderId) { <span class="co">/* ... */</span> }</span>
<span id="cb207-43"><a href="#cb207-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showProcessing</span>() { <span class="co">/* ... */</span> }</span>
<span id="cb207-44"><a href="#cb207-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.9" id="testing-business-logic"><span
class="header-section-number">8.9</span> Testing Business Logic</h2>
<p>One of the biggest advantages of separating business logic is
testability. Here’s how to test each pattern:</p>
<h3 data-number="8.9.1" id="testing-pan-bus-listeners"><span
class="header-section-number">8.9.1</span> Testing PAN Bus
Listeners</h3>
<div class="sourceCode" id="cb208"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co">// __tests__/cart-rules.test.js</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { describe<span class="op">,</span> it<span class="op">,</span> expect<span class="op">,</span> beforeEach<span class="op">,</span> vi } <span class="im">from</span> <span class="st">&#39;vitest&#39;</span><span class="op">;</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartRules <span class="im">from</span> <span class="st">&#39;../business-logic/cart-rules.js&#39;</span><span class="op">;</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Cart Business Rules&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reset PAN bus between tests</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a>    cartRules<span class="op">.</span><span class="fu">init</span>()<span class="op">;</span></span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should reject adding more than max items&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mock cart with max items</span></span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">respond</span>(<span class="st">&#39;cart.get&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> ({</span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Array</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">fill</span>({})</span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errorHandler <span class="op">=</span> vi<span class="op">.</span><span class="fu">fn</span>()<span class="op">;</span></span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.error&#39;</span><span class="op">,</span> errorHandler)<span class="op">;</span></span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-22"><a href="#cb208-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try to add another item</span></span>
<span id="cb208-23"><a href="#cb208-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> {</span>
<span id="cb208-24"><a href="#cb208-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">product</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Test&#39;</span> }<span class="op">,</span></span>
<span id="cb208-25"><a href="#cb208-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb208-26"><a href="#cb208-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb208-27"><a href="#cb208-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-28"><a href="#cb208-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(errorHandler)<span class="op">.</span><span class="fu">toHaveBeenCalledWith</span>({</span>
<span id="cb208-29"><a href="#cb208-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">code</span><span class="op">:</span> <span class="st">&#39;MAX_ITEMS_EXCEEDED&#39;</span><span class="op">,</span></span>
<span id="cb208-30"><a href="#cb208-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> expect<span class="op">.</span><span class="fu">stringContaining</span>(<span class="st">&#39;50 items&#39;</span>)</span>
<span id="cb208-31"><a href="#cb208-31" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb208-32"><a href="#cb208-32" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb208-33"><a href="#cb208-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-34"><a href="#cb208-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should apply bulk discount for 5+ items&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb208-35"><a href="#cb208-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validated <span class="op">=</span> vi<span class="op">.</span><span class="fu">fn</span>()<span class="op">;</span></span>
<span id="cb208-36"><a href="#cb208-36" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.item.validated&#39;</span><span class="op">,</span> validated)<span class="op">;</span></span>
<span id="cb208-37"><a href="#cb208-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-38"><a href="#cb208-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> {</span>
<span id="cb208-39"><a href="#cb208-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">product</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Test&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">100</span> }<span class="op">,</span></span>
<span id="cb208-40"><a href="#cb208-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">quantity</span><span class="op">:</span> <span class="dv">5</span></span>
<span id="cb208-41"><a href="#cb208-41" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb208-42"><a href="#cb208-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-43"><a href="#cb208-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(validated)<span class="op">.</span><span class="fu">toHaveBeenCalledWith</span>(</span>
<span id="cb208-44"><a href="#cb208-44" aria-hidden="true" tabindex="-1"></a>      expect<span class="op">.</span><span class="fu">objectContaining</span>({</span>
<span id="cb208-45"><a href="#cb208-45" aria-hidden="true" tabindex="-1"></a>        <span class="dt">pricing</span><span class="op">:</span> expect<span class="op">.</span><span class="fu">objectContaining</span>({</span>
<span id="cb208-46"><a href="#cb208-46" aria-hidden="true" tabindex="-1"></a>          <span class="dt">unitPrice</span><span class="op">:</span> <span class="dv">90</span><span class="op">,</span> <span class="co">// 10% discount</span></span>
<span id="cb208-47"><a href="#cb208-47" aria-hidden="true" tabindex="-1"></a>          <span class="dt">discount</span><span class="op">:</span> <span class="dv">50</span></span>
<span id="cb208-48"><a href="#cb208-48" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb208-49"><a href="#cb208-49" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb208-50"><a href="#cb208-50" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb208-51"><a href="#cb208-51" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb208-52"><a href="#cb208-52" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="8.9.2" id="testing-services"><span
class="header-section-number">8.9.2</span> Testing Services</h3>
<div class="sourceCode" id="cb209"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co">// __tests__/pricing-service.test.js</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { describe<span class="op">,</span> it<span class="op">,</span> expect } <span class="im">from</span> <span class="st">&#39;vitest&#39;</span><span class="op">;</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pricingService <span class="im">from</span> <span class="st">&#39;../services/pricing-service.js&#39;</span><span class="op">;</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Pricing Service&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should apply volume discount&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> product <span class="op">=</span> { <span class="dt">basePrice</span><span class="op">:</span> <span class="dv">100</span> }<span class="op">;</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(product<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(pricing<span class="op">.</span><span class="at">unitPrice</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">85</span>)<span class="op">;</span> <span class="co">// 15% off for 10+</span></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(pricing<span class="op">.</span><span class="at">subtotal</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="dv">850</span>)<span class="op">;</span></span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should stack member and volume discounts&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> product <span class="op">=</span> { <span class="dt">basePrice</span><span class="op">:</span> <span class="dv">100</span> }<span class="op">;</span></span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> { <span class="dt">tier</span><span class="op">:</span> <span class="st">&#39;premium&#39;</span> }<span class="op">;</span></span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(product<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-20"><a href="#cb209-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 15% volume + 15% premium = 72.25</span></span>
<span id="cb209-21"><a href="#cb209-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(pricing<span class="op">.</span><span class="at">unitPrice</span>)<span class="op">.</span><span class="fu">toBe</span>(<span class="fl">72.25</span>)<span class="op">;</span></span>
<span id="cb209-22"><a href="#cb209-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb209-23"><a href="#cb209-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="8.10" id="best-practices-4"><span
class="header-section-number">8.10</span> Best Practices</h2>
<h3 data-number="8.10.1" id="keep-components-dumb"><span
class="header-section-number">8.10.1</span> 1. Keep Components Dumb</h3>
<p>Components should focus on UI and user interaction. They publish
events but don’t implement business rules.</p>
<p><strong>Good:</strong></p>
<div class="sourceCode" id="cb210"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">handleAddToCart</span>() {</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.item.add&#39;</span><span class="op">,</span> { <span class="dt">product</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span> })<span class="op">;</span></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Bad:</strong></p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">handleAddToCart</span>() {</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Business logic in component - hard to test and reuse</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> inventory <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/inventory&#39;</span>)<span class="op">;</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (inventory <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">quantity</span>) {</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alert</span>(<span class="st">&#39;Out of stock&#39;</span>)<span class="op">;</span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/user&#39;</span>)<span class="op">;</span></span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (user<span class="op">.</span><span class="at">age</span> <span class="op">&lt;</span> <span class="dv">21</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">product</span><span class="op">.</span><span class="at">ageRestricted</span>) {</span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alert</span>(<span class="st">&#39;Age restricted&#39;</span>)<span class="op">;</span></span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ... more business logic</span></span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="8.10.2" id="use-services-for-complex-logic"><span
class="header-section-number">8.10.2</span> 2. Use Services for Complex
Logic</h3>
<p>If business logic involves multiple steps, calculations, or external
APIs, put it in a service:</p>
<div class="sourceCode" id="cb212"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: Service handles complexity</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pricing <span class="op">=</span> <span class="cf">await</span> pricingService<span class="op">.</span><span class="fu">calculatePrice</span>(product<span class="op">,</span> quantity<span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad: Business logic scattered across components and PAN listeners</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> basePrice <span class="op">=</span> product<span class="op">.</span><span class="at">price</span><span class="op">;</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> volumeDiscount <span class="op">=</span> quantity <span class="op">&gt;=</span> <span class="dv">10</span> <span class="op">?</span> <span class="fl">0.15</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> memberDiscount <span class="op">=</span> user<span class="op">?.</span><span class="at">tier</span> <span class="op">===</span> <span class="st">&#39;premium&#39;</span> <span class="op">?</span> <span class="fl">0.15</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="co">// ... etc</span></span></code></pre></div>
<h3 data-number="8.10.3" id="make-business-logic-observable"><span
class="header-section-number">8.10.3</span> 3. Make Business Logic
Observable</h3>
<p>Use PAN bus to make business logic transparent:</p>
<div class="sourceCode" id="cb213"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OrderProcessor {</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">processOrder</span>(order) {</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.processing.start&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateOrder</span>(order)<span class="op">;</span></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.validated&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">chargePayment</span>(order)<span class="op">;</span></span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.charged&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">createShipment</span>(order)<span class="op">;</span></span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.shipped&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.complete&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.failed&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> order<span class="op">.</span><span class="at">id</span><span class="op">,</span> error })<span class="op">;</span></span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now other parts of your app can react to these events (analytics,
notifications, UI updates, etc.).</p>
<h3 data-number="8.10.4" id="document-business-rules"><span
class="header-section-number">8.10.4</span> 4. Document Business
Rules</h3>
<p>Make business rules explicit and documented:</p>
<div class="sourceCode" id="cb214"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Shopping Cart Business Rules</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * 1. Maximum 50 items per order</span></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * 2. Maximum 10 quantity per item</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * 3. Free shipping over $50</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * 4. Volume discounts:</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a><span class="co"> *    - 5-9 items: 10% off</span></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a><span class="co"> *    - 10+ items: 15% off</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * 5. Member discounts:</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a><span class="co"> *    - Premium: 15% off</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a><span class="co"> *    - Gold: 10% off</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * 6. Minimum order value: $10</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CartBusinessRules {</span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Implementation</span></span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="8.10.5" id="use-feature-flags"><span
class="header-section-number">8.10.5</span> 5. Use Feature Flags</h3>
<p>Make business logic toggleable:</p>
<div class="sourceCode" id="cb215"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutRules {</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">features</span> <span class="op">=</span> {</span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">guestCheckout</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">expressCheckout</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">digitalWallet</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleCheckout</span>(data) {</span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">features</span><span class="op">.</span><span class="at">guestCheckout</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>data<span class="op">.</span><span class="at">user</span>) {</span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;checkout.error&#39;</span><span class="op">,</span> {</span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Account required for checkout&#39;</span></span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... rest of logic</span></span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="8.11" id="summary-7"><span
class="header-section-number">8.11</span> Summary</h2>
<p>When integrating business logic into LARC applications:</p>
<ol type="1">
<li><strong>Default to PAN Bus listeners</strong> for most business
logic - it’s decoupled, testable, and flexible</li>
<li><strong>Use services</strong> for complex calculations and
workflows</li>
<li><strong>Extend components</strong> only when logic is tightly
coupled to UI</li>
<li><strong>Use mixins</strong> for cross-cutting concerns like
analytics</li>
<li><strong>Wrap components</strong> when adding behavior to third-party
code</li>
<li><strong>Keep components dumb</strong> - they publish events,
business logic handles the rest</li>
</ol>
<p>This separation of concerns makes your application:</p>
<ul>
<li><strong>Easier to test</strong> - business logic without rendering
components</li>
<li><strong>More maintainable</strong> - business rules in one
place</li>
<li><strong>More flexible</strong> - easy to change rules without
touching UI</li>
<li><strong>More reusable</strong> - logic can be shared across
components</li>
</ul>
<p>In the next chapter, we’ll explore routing and navigation, building
on these patterns to create complete single-page applications.</p>
<hr />
<h2 data-number="8.12" id="further-reading-7"><span
class="header-section-number">8.12</span> Further Reading</h2>
<p><strong>For business logic and architecture patterns:</strong> -
<em>Building with LARC</em> Chapter 15: Advanced Patterns - Architecture
patterns and middleware - <em>Building with LARC</em> Chapter 4: State
Management - State management strategies - <em>Building with LARC</em>
Appendix E: Recipes and Patterns - Design patterns and anti-patterns</p>
<div class="pagebreak">

</div>
<h1 data-number="9" id="routing-and-navigation"><span
class="header-section-number">9</span> Routing and Navigation</h1>
<p>Client-side routing enables single-page applications (SPAs) to feel
like multi-page websites without full page reloads. LARC provides
routing through web standards and the PAN bus, keeping things simple and
framework-free.</p>
<h2 data-number="9.1" id="client-side-routing-basics"><span
class="header-section-number">9.1</span> Client-Side Routing Basics</h2>
<p>Client-side routing intercepts link clicks and updates the URL
without reloading:</p>
<div class="sourceCode" id="cb216"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co">// lib/router.js</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Router {</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">routes</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentRoute</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intercept link clicks</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">matches</span>(<span class="st">&#39;a[href^=&quot;/&quot;]&#39;</span>)) {</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">navigate</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;href&#39;</span>))<span class="op">;</span></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb216-14"><a href="#cb216-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-15"><a href="#cb216-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle browser back/forward</span></span>
<span id="cb216-16"><a href="#cb216-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;popstate&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb216-17"><a href="#cb216-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb216-18"><a href="#cb216-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb216-19"><a href="#cb216-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-20"><a href="#cb216-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-21"><a href="#cb216-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">register</span>(path<span class="op">,</span> handler) {</span>
<span id="cb216-22"><a href="#cb216-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">routes</span><span class="op">.</span><span class="fu">set</span>(path<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb216-23"><a href="#cb216-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-24"><a href="#cb216-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-25"><a href="#cb216-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">navigate</span>(path<span class="op">,</span> state <span class="op">=</span> {}) {</span>
<span id="cb216-26"><a href="#cb216-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">pushState</span>(state<span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> path)<span class="op">;</span></span>
<span id="cb216-27"><a href="#cb216-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(path)<span class="op">;</span></span>
<span id="cb216-28"><a href="#cb216-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-29"><a href="#cb216-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Publish navigation event</span></span>
<span id="cb216-30"><a href="#cb216-30" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigated&#39;</span><span class="op">,</span> { path<span class="op">,</span> state })<span class="op">;</span></span>
<span id="cb216-31"><a href="#cb216-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-32"><a href="#cb216-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-33"><a href="#cb216-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleRoute</span>(path) {</span>
<span id="cb216-34"><a href="#cb216-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find matching route</span></span>
<span id="cb216-35"><a href="#cb216-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> [pattern<span class="op">,</span> handler] <span class="kw">of</span> <span class="kw">this</span><span class="op">.</span><span class="at">routes</span>) {</span>
<span id="cb216-36"><a href="#cb216-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> params <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">matchRoute</span>(pattern<span class="op">,</span> path)<span class="op">;</span></span>
<span id="cb216-37"><a href="#cb216-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (params) {</span>
<span id="cb216-38"><a href="#cb216-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">currentRoute</span> <span class="op">=</span> { path<span class="op">,</span> pattern<span class="op">,</span> params }<span class="op">;</span></span>
<span id="cb216-39"><a href="#cb216-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">handler</span>(params)<span class="op">;</span></span>
<span id="cb216-40"><a href="#cb216-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb216-41"><a href="#cb216-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb216-42"><a href="#cb216-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb216-43"><a href="#cb216-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-44"><a href="#cb216-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 404 - no match</span></span>
<span id="cb216-45"><a href="#cb216-45" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.not-found&#39;</span><span class="op">,</span> { path })<span class="op">;</span></span>
<span id="cb216-46"><a href="#cb216-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-47"><a href="#cb216-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-48"><a href="#cb216-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matchRoute</span>(pattern<span class="op">,</span> path) {</span>
<span id="cb216-49"><a href="#cb216-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple pattern matching</span></span>
<span id="cb216-50"><a href="#cb216-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> patternParts <span class="op">=</span> pattern<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">filter</span>(<span class="bu">Boolean</span>)<span class="op">;</span></span>
<span id="cb216-51"><a href="#cb216-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pathParts <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">filter</span>(<span class="bu">Boolean</span>)<span class="op">;</span></span>
<span id="cb216-52"><a href="#cb216-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-53"><a href="#cb216-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (patternParts<span class="op">.</span><span class="at">length</span> <span class="op">!==</span> pathParts<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb216-54"><a href="#cb216-54" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb216-55"><a href="#cb216-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb216-56"><a href="#cb216-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-57"><a href="#cb216-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb216-58"><a href="#cb216-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-59"><a href="#cb216-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> patternParts<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb216-60"><a href="#cb216-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> patternPart <span class="op">=</span> patternParts[i]<span class="op">;</span></span>
<span id="cb216-61"><a href="#cb216-61" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> pathPart <span class="op">=</span> pathParts[i]<span class="op">;</span></span>
<span id="cb216-62"><a href="#cb216-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-63"><a href="#cb216-63" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (patternPart<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;:&#39;</span>)) {</span>
<span id="cb216-64"><a href="#cb216-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Dynamic segment</span></span>
<span id="cb216-65"><a href="#cb216-65" aria-hidden="true" tabindex="-1"></a>        params[patternPart<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)] <span class="op">=</span> pathPart<span class="op">;</span></span>
<span id="cb216-66"><a href="#cb216-66" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (patternPart <span class="op">!==</span> pathPart) {</span>
<span id="cb216-67"><a href="#cb216-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Mismatch</span></span>
<span id="cb216-68"><a href="#cb216-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb216-69"><a href="#cb216-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb216-70"><a href="#cb216-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb216-71"><a href="#cb216-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-72"><a href="#cb216-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> params<span class="op">;</span></span>
<span id="cb216-73"><a href="#cb216-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-74"><a href="#cb216-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-75"><a href="#cb216-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">start</span>() {</span>
<span id="cb216-76"><a href="#cb216-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb216-77"><a href="#cb216-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb216-78"><a href="#cb216-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb216-79"><a href="#cb216-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-80"><a href="#cb216-80" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> router <span class="op">=</span> <span class="kw">new</span> <span class="fu">Router</span>()<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb217"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { router } <span class="im">from</span> <span class="st">&#39;./lib/router.js&#39;</span><span class="op">;</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Register routes</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;home-page&gt;&lt;/home-page&gt;&#39;</span><span class="op">;</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/about&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;about-page&gt;&lt;/about-page&gt;&#39;</span><span class="op">;</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/users/:id&#39;</span><span class="op">,</span> (params) <span class="kw">=&gt;</span> {</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> page <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;user-page&#39;</span>)<span class="op">;</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a>  page<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;user-id&#39;</span><span class="op">,</span> params<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)<span class="op">.</span><span class="fu">appendChild</span>(page)<span class="op">;</span></span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Start router</span></span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>router<span class="op">.</span><span class="fu">start</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.2" id="the-pan-router-component"><span
class="header-section-number">9.2</span> The pan-router Component</h2>
<p>LARC provides a declarative router component:</p>
<div class="sourceCode" id="cb218"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;home-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/about&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;about-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/users/:id&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;user-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/posts/:postId/comments/:commentId&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;comment-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;*&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;not-found-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb219"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanRouter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">routes</span> <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;pan-route&#39;</span>))<span class="op">.</span><span class="fu">map</span>(route <span class="kw">=&gt;</span> ({</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">path</span><span class="op">:</span> route<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;path&#39;</span>)<span class="op">,</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">component</span><span class="op">:</span> route<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;component&#39;</span>)<span class="op">,</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">guard</span><span class="op">:</span> route<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;guard&#39;</span>)</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create outlet</span></span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">outlet</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">outlet</span><span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;router-outlet&#39;</span><span class="op">;</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(<span class="kw">this</span><span class="op">.</span><span class="at">outlet</span>)<span class="op">;</span></span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for navigation</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> ({ path<span class="op">,</span> params }) <span class="kw">=&gt;</span> {</span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">navigate</span>(path<span class="op">,</span> params)<span class="op">;</span></span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb219-18"><a href="#cb219-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-19"><a href="#cb219-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle browser navigation</span></span>
<span id="cb219-20"><a href="#cb219-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;popstate&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb219-21"><a href="#cb219-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb219-22"><a href="#cb219-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb219-23"><a href="#cb219-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-24"><a href="#cb219-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intercept links</span></span>
<span id="cb219-25"><a href="#cb219-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb219-26"><a href="#cb219-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> link <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="fu">closest</span>(<span class="st">&#39;a[href^=&quot;/&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb219-27"><a href="#cb219-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (link) {</span>
<span id="cb219-28"><a href="#cb219-28" aria-hidden="true" tabindex="-1"></a>        e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb219-29"><a href="#cb219-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">navigate</span>(link<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;href&#39;</span>))<span class="op">;</span></span>
<span id="cb219-30"><a href="#cb219-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb219-31"><a href="#cb219-31" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb219-32"><a href="#cb219-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-33"><a href="#cb219-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initial route</span></span>
<span id="cb219-34"><a href="#cb219-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb219-35"><a href="#cb219-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-36"><a href="#cb219-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-37"><a href="#cb219-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">navigate</span>(path<span class="op">,</span> params <span class="op">=</span> {}) {</span>
<span id="cb219-38"><a href="#cb219-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">history</span><span class="op">.</span><span class="fu">pushState</span>(params<span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> path)<span class="op">;</span></span>
<span id="cb219-39"><a href="#cb219-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">handleRoute</span>(path)<span class="op">;</span></span>
<span id="cb219-40"><a href="#cb219-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-41"><a href="#cb219-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-42"><a href="#cb219-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleRoute</span>(path) {</span>
<span id="cb219-43"><a href="#cb219-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Find matching route</span></span>
<span id="cb219-44"><a href="#cb219-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> route <span class="kw">of</span> <span class="kw">this</span><span class="op">.</span><span class="at">routes</span>) {</span>
<span id="cb219-45"><a href="#cb219-45" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> params <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">matchRoute</span>(route<span class="op">.</span><span class="at">path</span><span class="op">,</span> path)<span class="op">;</span></span>
<span id="cb219-46"><a href="#cb219-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-47"><a href="#cb219-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (params) {</span>
<span id="cb219-48"><a href="#cb219-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check route guard</span></span>
<span id="cb219-49"><a href="#cb219-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (route<span class="op">.</span><span class="at">guard</span>) {</span>
<span id="cb219-50"><a href="#cb219-50" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> canActivate <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">runGuard</span>(route<span class="op">.</span><span class="at">guard</span><span class="op">,</span> params)<span class="op">;</span></span>
<span id="cb219-51"><a href="#cb219-51" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="op">!</span>canActivate) {</span>
<span id="cb219-52"><a href="#cb219-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb219-53"><a href="#cb219-53" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb219-54"><a href="#cb219-54" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb219-55"><a href="#cb219-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-56"><a href="#cb219-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Render component</span></span>
<span id="cb219-57"><a href="#cb219-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderComponent</span>(route<span class="op">.</span><span class="at">component</span><span class="op">,</span> params)<span class="op">;</span></span>
<span id="cb219-58"><a href="#cb219-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb219-59"><a href="#cb219-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb219-60"><a href="#cb219-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb219-61"><a href="#cb219-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-62"><a href="#cb219-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 404</span></span>
<span id="cb219-63"><a href="#cb219-63" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.not-found&#39;</span><span class="op">,</span> { path })<span class="op">;</span></span>
<span id="cb219-64"><a href="#cb219-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-65"><a href="#cb219-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-66"><a href="#cb219-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matchRoute</span>(pattern<span class="op">,</span> path) {</span>
<span id="cb219-67"><a href="#cb219-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pattern <span class="op">===</span> <span class="st">&#39;*&#39;</span>) <span class="cf">return</span> {}<span class="op">;</span></span>
<span id="cb219-68"><a href="#cb219-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-69"><a href="#cb219-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> patternParts <span class="op">=</span> pattern<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">filter</span>(<span class="bu">Boolean</span>)<span class="op">;</span></span>
<span id="cb219-70"><a href="#cb219-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> pathParts <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">filter</span>(<span class="bu">Boolean</span>)<span class="op">;</span></span>
<span id="cb219-71"><a href="#cb219-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-72"><a href="#cb219-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (patternParts<span class="op">.</span><span class="at">length</span> <span class="op">!==</span> pathParts<span class="op">.</span><span class="at">length</span>) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb219-73"><a href="#cb219-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-74"><a href="#cb219-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb219-75"><a href="#cb219-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-76"><a href="#cb219-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> patternParts<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb219-77"><a href="#cb219-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (patternParts[i]<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;:&#39;</span>)) {</span>
<span id="cb219-78"><a href="#cb219-78" aria-hidden="true" tabindex="-1"></a>        params[patternParts[i]<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)] <span class="op">=</span> pathParts[i]<span class="op">;</span></span>
<span id="cb219-79"><a href="#cb219-79" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (patternParts[i] <span class="op">!==</span> pathParts[i]) {</span>
<span id="cb219-80"><a href="#cb219-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb219-81"><a href="#cb219-81" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb219-82"><a href="#cb219-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb219-83"><a href="#cb219-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-84"><a href="#cb219-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> params<span class="op">;</span></span>
<span id="cb219-85"><a href="#cb219-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-86"><a href="#cb219-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-87"><a href="#cb219-87" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">runGuard</span>(guardName<span class="op">,</span> params) {</span>
<span id="cb219-88"><a href="#cb219-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="vs">`guard.</span><span class="sc">${</span>guardName<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> params)<span class="op">;</span></span>
<span id="cb219-89"><a href="#cb219-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result <span class="op">!==</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb219-90"><a href="#cb219-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-91"><a href="#cb219-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-92"><a href="#cb219-92" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">renderComponent</span>(componentName<span class="op">,</span> params) {</span>
<span id="cb219-93"><a href="#cb219-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for component to be defined</span></span>
<span id="cb219-94"><a href="#cb219-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> customElements<span class="op">.</span><span class="fu">whenDefined</span>(componentName)<span class="op">;</span></span>
<span id="cb219-95"><a href="#cb219-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-96"><a href="#cb219-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create component</span></span>
<span id="cb219-97"><a href="#cb219-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> component <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(componentName)<span class="op">;</span></span>
<span id="cb219-98"><a href="#cb219-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-99"><a href="#cb219-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass route params</span></span>
<span id="cb219-100"><a href="#cb219-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(params)<span class="op">.</span><span class="fu">forEach</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> {</span>
<span id="cb219-101"><a href="#cb219-101" aria-hidden="true" tabindex="-1"></a>      component<span class="op">.</span><span class="fu">setAttribute</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb219-102"><a href="#cb219-102" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb219-103"><a href="#cb219-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-104"><a href="#cb219-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear outlet and add component</span></span>
<span id="cb219-105"><a href="#cb219-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">outlet</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb219-106"><a href="#cb219-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">outlet</span><span class="op">.</span><span class="fu">appendChild</span>(component)<span class="op">;</span></span>
<span id="cb219-107"><a href="#cb219-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-108"><a href="#cb219-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Publish route change</span></span>
<span id="cb219-109"><a href="#cb219-109" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.changed&#39;</span><span class="op">,</span> { <span class="dt">component</span><span class="op">:</span> componentName<span class="op">,</span> params })<span class="op">;</span></span>
<span id="cb219-110"><a href="#cb219-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb219-111"><a href="#cb219-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb219-112"><a href="#cb219-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-113"><a href="#cb219-113" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;pan-router&#39;</span><span class="op">,</span> PanRouter)<span class="op">;</span></span>
<span id="cb219-114"><a href="#cb219-114" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;pan-route&#39;</span><span class="op">,</span> <span class="kw">class</span> <span class="kw">extends</span> <span class="bu">HTMLElement</span> {})<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.3" id="route-parameters"><span
class="header-section-number">9.3</span> Route Parameters</h2>
<p>Access route parameters in components:</p>
<div class="sourceCode" id="cb220"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserPage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> <span class="kw">get</span> <span class="fu">observedAttributes</span>() {</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">&#39;user-id&#39;</span>]<span class="op">;</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;user-id&#39;</span> <span class="op">&amp;&amp;</span> newValue) {</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">loadUser</span>(newValue)<span class="op">;</span></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadUser</span>(id) {</span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/users/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(user)<span class="op">;</span></span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(user) {</span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h1&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h1&gt;</span></span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-page&#39;</span><span class="op">,</span> UserPage)<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.4" id="route-guards"><span
class="header-section-number">9.4</span> Route Guards</h2>
<p>Protect routes with authentication checks:</p>
<div class="sourceCode" id="cb221"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Respond to auth guard</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">respond</span>(<span class="st">&#39;guard.auth&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;authToken&#39;</span>)<span class="op">;</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>token) {</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Redirect to login</span></span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Verify token</span></span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/verify&#39;</span><span class="op">,</span> {</span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span> }</span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="at">ok</span><span class="op">;</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> {</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Respond to admin guard</span></span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">respond</span>(<span class="st">&#39;guard.admin&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> pan<span class="op">.</span><span class="fu">request</span>(<span class="st">&#39;auth.user.get&#39;</span>)<span class="op">;</span></span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> user<span class="op">?.</span><span class="at">role</span> <span class="op">===</span> <span class="st">&#39;admin&#39;</span><span class="op">;</span></span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Usage:</strong></p>
<div class="sourceCode" id="cb222"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/login&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;login-page&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/dashboard&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;dashboard-page&quot;</span><span class="ot"> guard</span><span class="op">=</span><span class="st">&quot;auth&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/admin&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;admin-page&quot;</span><span class="ot"> guard</span><span class="op">=</span><span class="st">&quot;admin&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="9.5" id="nested-routes"><span
class="header-section-number">9.5</span> Nested Routes</h2>
<p>Support hierarchical routing:</p>
<div class="sourceCode" id="cb223"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/settings&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;settings-layout&quot;</span><span class="dt">&gt;</span></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/settings/profile&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;profile-settings&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/settings/security&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;security-settings&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">pan-route</span><span class="ot"> path</span><span class="op">=</span><span class="st">&quot;/settings/billing&quot;</span><span class="ot"> component</span><span class="op">=</span><span class="st">&quot;billing-settings&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">pan-route</span><span class="dt">&gt;</span></span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-router</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="9.6" id="programmatic-navigation"><span
class="header-section-number">9.6</span> Programmatic Navigation</h2>
<p>Navigate from JavaScript:</p>
<div class="sourceCode" id="cb224"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Navigate to a path</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/users/123&#39;</span> })<span class="op">;</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Navigate with state</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> {</span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/search&#39;</span><span class="op">,</span></span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">state</span><span class="op">:</span> { <span class="dt">query</span><span class="op">:</span> <span class="st">&#39;web components&#39;</span> }</span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Go back</span></span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.back&#39;</span>)<span class="op">;</span></span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Go forward</span></span>
<span id="cb224-14"><a href="#cb224-14" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.forward&#39;</span>)<span class="op">;</span></span>
<span id="cb224-15"><a href="#cb224-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-16"><a href="#cb224-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace current route (no history entry)</span></span>
<span id="cb224-17"><a href="#cb224-17" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.replace&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/new-path&#39;</span> })<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.7" id="query-parameters"><span
class="header-section-number">9.7</span> Query Parameters</h2>
<p>Parse and use query parameters:</p>
<div class="sourceCode" id="cb225"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchPage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parse query params</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> query <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;q&#39;</span>)<span class="op">;</span></span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> page <span class="op">=</span> <span class="pp">parseInt</span>(params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;page&#39;</span>) <span class="op">||</span> <span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">performSearch</span>(query<span class="op">,</span> page)<span class="op">;</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Listen for query changes</span></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;router.changed&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> newQuery <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;q&#39;</span>)<span class="op">;</span></span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> newPage <span class="op">=</span> <span class="pp">parseInt</span>(params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;page&#39;</span>) <span class="op">||</span> <span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (newQuery <span class="op">!==</span> query <span class="op">||</span> newPage <span class="op">!==</span> page) {</span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">performSearch</span>(newQuery<span class="op">,</span> newPage)<span class="op">;</span></span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb225-21"><a href="#cb225-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-22"><a href="#cb225-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">performSearch</span>(query<span class="op">,</span> page) {</span>
<span id="cb225-23"><a href="#cb225-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Search implementation</span></span>
<span id="cb225-24"><a href="#cb225-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb225-25"><a href="#cb225-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Update query params:</strong></p>
<div class="sourceCode" id="cb226"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateQuery</span>(params) {</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span>)<span class="op">;</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(params)<span class="op">.</span><span class="fu">forEach</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> {</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>    url<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> url<span class="op">.</span><span class="at">pathname</span> <span class="op">+</span> url<span class="op">.</span><span class="at">search</span> })<span class="op">;</span></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a><span class="fu">updateQuery</span>({ <span class="dt">q</span><span class="op">:</span> <span class="st">&#39;web components&#39;</span><span class="op">,</span> <span class="dt">page</span><span class="op">:</span> <span class="st">&#39;2&#39;</span> })<span class="op">;</span></span></code></pre></div>
<h2 data-number="9.8" id="summary-8"><span
class="header-section-number">9.8</span> Summary</h2>
<p>LARC routing provides:</p>
<ul>
<li>Client-side navigation without page reloads</li>
<li>Declarative route configuration</li>
<li>Route parameters and guards</li>
<li>Nested routing support</li>
<li>Browser history integration</li>
<li>PAN bus integration</li>
</ul>
<hr />
<h2 data-number="9.9" id="best-practices-5"><span
class="header-section-number">9.9</span> Best Practices</h2>
<ol type="1">
<li><strong>Use declarative routing</strong> - Prefer
<code>&lt;pan-router&gt;</code> over imperative API</li>
<li><strong>Implement route guards</strong> - Protect sensitive
routes</li>
<li><strong>Handle 404s gracefully</strong> - Always include catch-all
route</li>
<li><strong>Preserve scroll position</strong> - Restore scroll on back
navigation</li>
<li><strong>Use query params for filters</strong> - Makes URLs
shareable</li>
</ol>
<hr />
<h2 data-number="9.10" id="further-reading-8"><span
class="header-section-number">9.10</span> Further Reading</h2>
<p><strong>For complete routing reference:</strong> - <em>Building with
LARC</em> Chapter 5: Routing and Navigation - All routing patterns and
guards - <em>Building with LARC</em> Chapter 17: Core Components -
pan-routes API reference - <em>Building with LARC</em> Appendix E:
Recipes and Patterns - Routing recipes and examples</p>
<div class="pagebreak">

</div>
<h1 data-number="10" id="forms-and-validation"><span
class="header-section-number">10</span> Forms and Validation</h1>
<p>Forms are the primary way users input data into web applications.
LARC provides patterns for building accessible, validated forms using
web standards and the PAN bus.</p>
<h2 data-number="10.1" id="form-components"><span
class="header-section-number">10.1</span> Form Components</h2>
<h3 data-number="10.1.1" id="basic-form-component"><span
class="header-section-number">10.1.1</span> Basic Form Component</h3>
<div class="sourceCode" id="cb227"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ContactForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachEventListeners</span>()<span class="op">;</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attachEventListeners</span>() {</span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb227-16"><a href="#cb227-16" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb227-17"><a href="#cb227-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-18"><a href="#cb227-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">validate</span>()) {</span>
<span id="cb227-19"><a href="#cb227-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getFormData</span>()<span class="op">;</span></span>
<span id="cb227-20"><a href="#cb227-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>(data)<span class="op">;</span></span>
<span id="cb227-21"><a href="#cb227-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb227-22"><a href="#cb227-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb227-23"><a href="#cb227-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-24"><a href="#cb227-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-25"><a href="#cb227-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getFormData</span>() {</span>
<span id="cb227-26"><a href="#cb227-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb227-27"><a href="#cb227-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(form)<span class="op">;</span></span>
<span id="cb227-28"><a href="#cb227-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(formData)<span class="op">;</span></span>
<span id="cb227-29"><a href="#cb227-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-30"><a href="#cb227-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-31"><a href="#cb227-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate</span>() {</span>
<span id="cb227-32"><a href="#cb227-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb227-33"><a href="#cb227-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> form<span class="op">.</span><span class="fu">checkValidity</span>()<span class="op">;</span></span>
<span id="cb227-34"><a href="#cb227-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-35"><a href="#cb227-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-36"><a href="#cb227-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(data) {</span>
<span id="cb227-37"><a href="#cb227-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb227-38"><a href="#cb227-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/contact&#39;</span><span class="op">,</span> {</span>
<span id="cb227-39"><a href="#cb227-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb227-40"><a href="#cb227-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb227-41"><a href="#cb227-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb227-42"><a href="#cb227-42" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb227-43"><a href="#cb227-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-44"><a href="#cb227-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb227-45"><a href="#cb227-45" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;form.submitted&#39;</span><span class="op">,</span> { <span class="dt">form</span><span class="op">:</span> <span class="st">&#39;contact&#39;</span><span class="op">,</span> data })<span class="op">;</span></span>
<span id="cb227-46"><a href="#cb227-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>()<span class="op">;</span></span>
<span id="cb227-47"><a href="#cb227-47" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb227-48"><a href="#cb227-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Submission failed&#39;</span>)<span class="op">;</span></span>
<span id="cb227-49"><a href="#cb227-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb227-50"><a href="#cb227-50" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb227-51"><a href="#cb227-51" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb227-52"><a href="#cb227-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb227-53"><a href="#cb227-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-54"><a href="#cb227-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-55"><a href="#cb227-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showSuccess</span>() {</span>
<span id="cb227-56"><a href="#cb227-56" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.success&#39;</span><span class="op">,</span> { <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Form submitted successfully!&#39;</span> })<span class="op">;</span></span>
<span id="cb227-57"><a href="#cb227-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb227-58"><a href="#cb227-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-59"><a href="#cb227-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-60"><a href="#cb227-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(message) {</span>
<span id="cb227-61"><a href="#cb227-61" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.error&#39;</span><span class="op">,</span> { message })<span class="op">;</span></span>
<span id="cb227-62"><a href="#cb227-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-63"><a href="#cb227-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-64"><a href="#cb227-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb227-65"><a href="#cb227-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb227-66"><a href="#cb227-66" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb227-67"><a href="#cb227-67" aria-hidden="true" tabindex="-1"></a><span class="vs">        form { max-width: 500px; }</span></span>
<span id="cb227-68"><a href="#cb227-68" aria-hidden="true" tabindex="-1"></a><span class="vs">        .field { margin-bottom: 16px; }</span></span>
<span id="cb227-69"><a href="#cb227-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        label {</span></span>
<span id="cb227-70"><a href="#cb227-70" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb227-71"><a href="#cb227-71" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 4px;</span></span>
<span id="cb227-72"><a href="#cb227-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb227-73"><a href="#cb227-73" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb227-74"><a href="#cb227-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        input, textarea {</span></span>
<span id="cb227-75"><a href="#cb227-75" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb227-76"><a href="#cb227-76" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px 12px;</span></span>
<span id="cb227-77"><a href="#cb227-77" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #cbd5e0;</span></span>
<span id="cb227-78"><a href="#cb227-78" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb227-79"><a href="#cb227-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb227-80"><a href="#cb227-80" aria-hidden="true" tabindex="-1"></a><span class="vs">        input:invalid, textarea:invalid {</span></span>
<span id="cb227-81"><a href="#cb227-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-color: #fc8181;</span></span>
<span id="cb227-82"><a href="#cb227-82" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb227-83"><a href="#cb227-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb227-84"><a href="#cb227-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #667eea;</span></span>
<span id="cb227-85"><a href="#cb227-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb227-86"><a href="#cb227-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px 24px;</span></span>
<span id="cb227-87"><a href="#cb227-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb227-88"><a href="#cb227-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb227-89"><a href="#cb227-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb227-90"><a href="#cb227-90" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb227-91"><a href="#cb227-91" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb227-92"><a href="#cb227-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-93"><a href="#cb227-93" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb227-94"><a href="#cb227-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb227-95"><a href="#cb227-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;name&quot;&gt;Name *&lt;/label&gt;</span></span>
<span id="cb227-96"><a href="#cb227-96" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;text&quot; id=&quot;name&quot; name=&quot;name&quot; required minlength=&quot;2&quot;&gt;</span></span>
<span id="cb227-97"><a href="#cb227-97" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb227-98"><a href="#cb227-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-99"><a href="#cb227-99" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb227-100"><a href="#cb227-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;email&quot;&gt;Email *&lt;/label&gt;</span></span>
<span id="cb227-101"><a href="#cb227-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; required&gt;</span></span>
<span id="cb227-102"><a href="#cb227-102" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb227-103"><a href="#cb227-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-104"><a href="#cb227-104" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb227-105"><a href="#cb227-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;message&quot;&gt;Message *&lt;/label&gt;</span></span>
<span id="cb227-106"><a href="#cb227-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;textarea id=&quot;message&quot; name=&quot;message&quot; required minlength=&quot;10&quot; rows=&quot;5&quot;&gt;&lt;/textarea&gt;</span></span>
<span id="cb227-107"><a href="#cb227-107" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb227-108"><a href="#cb227-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-109"><a href="#cb227-109" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot;&gt;Send Message&lt;/button&gt;</span></span>
<span id="cb227-110"><a href="#cb227-110" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb227-111"><a href="#cb227-111" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb227-112"><a href="#cb227-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb227-113"><a href="#cb227-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb227-114"><a href="#cb227-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-115"><a href="#cb227-115" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;contact-form&#39;</span><span class="op">,</span> ContactForm)<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.2" id="two-way-data-binding"><span
class="header-section-number">10.2</span> Two-Way Data Binding</h2>
<p>Sync form inputs with component state:</p>
<div class="sourceCode" id="cb228"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataBoundForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">firstName</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lastName</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;&#39;</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">bindInputs</span>()<span class="op">;</span></span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bindInputs</span>() {</span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inputs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-20"><a href="#cb228-20" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">forEach</span>(input <span class="kw">=&gt;</span> {</span>
<span id="cb228-21"><a href="#cb228-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update state when input changes</span></span>
<span id="cb228-22"><a href="#cb228-22" aria-hidden="true" tabindex="-1"></a>      input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb228-23"><a href="#cb228-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">state</span>[e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">name</span>] <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb228-24"><a href="#cb228-24" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;form.state.changed&#39;</span><span class="op">,</span> { <span class="dt">state</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span> })<span class="op">;</span></span>
<span id="cb228-25"><a href="#cb228-25" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb228-26"><a href="#cb228-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-27"><a href="#cb228-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update input when state changes</span></span>
<span id="cb228-28"><a href="#cb228-28" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;form.state.update&#39;</span><span class="op">,</span> (updates) <span class="kw">=&gt;</span> {</span>
<span id="cb228-29"><a href="#cb228-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (updates[input<span class="op">.</span><span class="at">name</span>] <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb228-30"><a href="#cb228-30" aria-hidden="true" tabindex="-1"></a>          input<span class="op">.</span><span class="at">value</span> <span class="op">=</span> updates[input<span class="op">.</span><span class="at">name</span>]<span class="op">;</span></span>
<span id="cb228-31"><a href="#cb228-31" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="at">state</span>[input<span class="op">.</span><span class="at">name</span>] <span class="op">=</span> updates[input<span class="op">.</span><span class="at">name</span>]<span class="op">;</span></span>
<span id="cb228-32"><a href="#cb228-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb228-33"><a href="#cb228-33" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb228-34"><a href="#cb228-34" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb228-35"><a href="#cb228-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-36"><a href="#cb228-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-37"><a href="#cb228-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb228-38"><a href="#cb228-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb228-39"><a href="#cb228-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb228-40"><a href="#cb228-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;text&quot; name=&quot;firstName&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">firstName</span><span class="sc">}</span><span class="vs">&quot; placeholder=&quot;First Name&quot;&gt;</span></span>
<span id="cb228-41"><a href="#cb228-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;text&quot; name=&quot;lastName&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">lastName</span><span class="sc">}</span><span class="vs">&quot; placeholder=&quot;Last Name&quot;&gt;</span></span>
<span id="cb228-42"><a href="#cb228-42" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;email&quot; name=&quot;email&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&quot; placeholder=&quot;Email&quot;&gt;</span></span>
<span id="cb228-43"><a href="#cb228-43" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb228-44"><a href="#cb228-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;preview&quot;&gt;</span></span>
<span id="cb228-45"><a href="#cb228-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Hello, </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">firstName</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">lastName</span><span class="sc">}</span><span class="vs">!&lt;/p&gt;</span></span>
<span id="cb228-46"><a href="#cb228-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Email: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb228-47"><a href="#cb228-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb228-48"><a href="#cb228-48" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb228-49"><a href="#cb228-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb228-50"><a href="#cb228-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.3" id="validation-strategies"><span
class="header-section-number">10.3</span> Validation Strategies</h2>
<h3 data-number="10.3.1" id="native-html5-validation"><span
class="header-section-number">10.3.1</span> Native HTML5 Validation</h3>
<div class="sourceCode" id="cb229"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> required</span><span class="dt">&gt;</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;number&quot;</span><span class="ot"> min</span><span class="op">=</span><span class="st">&quot;1&quot;</span><span class="ot"> max</span><span class="op">=</span><span class="st">&quot;100&quot;</span><span class="dt">&gt;</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;text&quot;</span><span class="ot"> pattern</span><span class="op">=</span><span class="st">&quot;[A-Za-z]{3,}&quot;</span><span class="ot"> title</span><span class="op">=</span><span class="st">&quot;At least 3 letters&quot;</span><span class="dt">&gt;</span></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;url&quot;</span><span class="ot"> required</span><span class="dt">&gt;</span></span></code></pre></div>
<h3 data-number="10.3.2" id="custom-validation"><span
class="header-section-number">10.3.2</span> Custom Validation</h3>
<div class="sourceCode" id="cb230"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ValidatedInput <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;input type=&quot;text&quot; id=&quot;input&quot;&gt;</span></span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span class=&quot;error&quot;&gt;&lt;/span&gt;</span></span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> error <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.error&#39;</span>)<span class="op">;</span></span>
<span id="cb230-10"><a href="#cb230-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-11"><a href="#cb230-11" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;blur&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb230-12"><a href="#cb230-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> validationResult <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">customValidate</span>(input<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb230-13"><a href="#cb230-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-14"><a href="#cb230-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>validationResult<span class="op">.</span><span class="at">valid</span>) {</span>
<span id="cb230-15"><a href="#cb230-15" aria-hidden="true" tabindex="-1"></a>        error<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> validationResult<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb230-16"><a href="#cb230-16" aria-hidden="true" tabindex="-1"></a>        input<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;invalid&#39;</span>)<span class="op">;</span></span>
<span id="cb230-17"><a href="#cb230-17" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb230-18"><a href="#cb230-18" aria-hidden="true" tabindex="-1"></a>        error<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb230-19"><a href="#cb230-19" aria-hidden="true" tabindex="-1"></a>        input<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;invalid&#39;</span>)<span class="op">;</span></span>
<span id="cb230-20"><a href="#cb230-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb230-21"><a href="#cb230-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb230-22"><a href="#cb230-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb230-23"><a href="#cb230-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-24"><a href="#cb230-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">customValidate</span>(value) {</span>
<span id="cb230-25"><a href="#cb230-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Custom validation logic</span></span>
<span id="cb230-26"><a href="#cb230-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (value<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb230-27"><a href="#cb230-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">valid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Must be at least 3 characters&#39;</span> }<span class="op">;</span></span>
<span id="cb230-28"><a href="#cb230-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb230-29"><a href="#cb230-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-30"><a href="#cb230-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="ss">/</span><span class="sc">^[a-zA-Z]+$</span><span class="ss">/</span><span class="op">.</span><span class="fu">test</span>(value)) {</span>
<span id="cb230-31"><a href="#cb230-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> { <span class="dt">valid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Only letters allowed&#39;</span> }<span class="op">;</span></span>
<span id="cb230-32"><a href="#cb230-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb230-33"><a href="#cb230-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-34"><a href="#cb230-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">valid</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">;</span></span>
<span id="cb230-35"><a href="#cb230-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb230-36"><a href="#cb230-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="10.3.3" id="async-validation"><span
class="header-section-number">10.3.3</span> Async Validation</h3>
<div class="sourceCode" id="cb231"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UsernameInput <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> timeoutId<span class="op">;</span></span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a>      timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">checkAvailability</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb231-13"><a href="#cb231-13" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> <span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb231-14"><a href="#cb231-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb231-15"><a href="#cb231-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-16"><a href="#cb231-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-17"><a href="#cb231-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">checkAvailability</span>(username) {</span>
<span id="cb231-18"><a href="#cb231-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> status <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status&#39;</span>)<span class="op">;</span></span>
<span id="cb231-19"><a href="#cb231-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-20"><a href="#cb231-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (username<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb231-21"><a href="#cb231-21" aria-hidden="true" tabindex="-1"></a>      status<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb231-22"><a href="#cb231-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb231-23"><a href="#cb231-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb231-24"><a href="#cb231-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-25"><a href="#cb231-25" aria-hidden="true" tabindex="-1"></a>    status<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Checking...&#39;</span><span class="op">;</span></span>
<span id="cb231-26"><a href="#cb231-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-27"><a href="#cb231-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb231-28"><a href="#cb231-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/check-username?username=</span><span class="sc">${</span>username<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb231-29"><a href="#cb231-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { available } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb231-30"><a href="#cb231-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-31"><a href="#cb231-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (available) {</span>
<span id="cb231-32"><a href="#cb231-32" aria-hidden="true" tabindex="-1"></a>        status<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;✓ Available&#39;</span><span class="op">;</span></span>
<span id="cb231-33"><a href="#cb231-33" aria-hidden="true" tabindex="-1"></a>        status<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;status success&#39;</span><span class="op">;</span></span>
<span id="cb231-34"><a href="#cb231-34" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb231-35"><a href="#cb231-35" aria-hidden="true" tabindex="-1"></a>        status<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;✗ Already taken&#39;</span><span class="op">;</span></span>
<span id="cb231-36"><a href="#cb231-36" aria-hidden="true" tabindex="-1"></a>        status<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;status error&#39;</span><span class="op">;</span></span>
<span id="cb231-37"><a href="#cb231-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb231-38"><a href="#cb231-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb231-39"><a href="#cb231-39" aria-hidden="true" tabindex="-1"></a>      status<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Could not check availability&#39;</span><span class="op">;</span></span>
<span id="cb231-40"><a href="#cb231-40" aria-hidden="true" tabindex="-1"></a>      status<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="st">&#39;status error&#39;</span><span class="op">;</span></span>
<span id="cb231-41"><a href="#cb231-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb231-42"><a href="#cb231-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-43"><a href="#cb231-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-44"><a href="#cb231-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb231-45"><a href="#cb231-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb231-46"><a href="#cb231-46" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;label&gt;Username&lt;/label&gt;</span></span>
<span id="cb231-47"><a href="#cb231-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;input type=&quot;text&quot; placeholder=&quot;Choose a username&quot;&gt;</span></span>
<span id="cb231-48"><a href="#cb231-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;span class=&quot;status&quot;&gt;&lt;/span&gt;</span></span>
<span id="cb231-49"><a href="#cb231-49" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb231-50"><a href="#cb231-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb231-51"><a href="#cb231-51" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.4" id="error-handling"><span
class="header-section-number">10.4</span> Error Handling</h2>
<p>Display validation errors elegantly:</p>
<div class="sourceCode" id="cb232"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FormWithErrors <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-15"><a href="#cb232-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">clearErrors</span>()<span class="op">;</span></span>
<span id="cb232-16"><a href="#cb232-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> errors <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validateForm</span>()<span class="op">;</span></span>
<span id="cb232-17"><a href="#cb232-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-18"><a href="#cb232-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(errors)<span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb232-19"><a href="#cb232-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>()<span class="op">;</span></span>
<span id="cb232-20"><a href="#cb232-20" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb232-21"><a href="#cb232-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showErrors</span>(errors)<span class="op">;</span></span>
<span id="cb232-22"><a href="#cb232-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb232-23"><a href="#cb232-23" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb232-24"><a href="#cb232-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-25"><a href="#cb232-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-26"><a href="#cb232-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validateForm</span>() {</span>
<span id="cb232-27"><a href="#cb232-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb232-28"><a href="#cb232-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inputs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb232-29"><a href="#cb232-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-30"><a href="#cb232-30" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">forEach</span>(input <span class="kw">=&gt;</span> {</span>
<span id="cb232-31"><a href="#cb232-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">valid</span>) {</span>
<span id="cb232-32"><a href="#cb232-32" aria-hidden="true" tabindex="-1"></a>        errors[input<span class="op">.</span><span class="at">name</span>] <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getErrorMessage</span>(input)<span class="op">;</span></span>
<span id="cb232-33"><a href="#cb232-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb232-34"><a href="#cb232-34" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb232-35"><a href="#cb232-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-36"><a href="#cb232-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> errors<span class="op">;</span></span>
<span id="cb232-37"><a href="#cb232-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-38"><a href="#cb232-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-39"><a href="#cb232-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getErrorMessage</span>(input) {</span>
<span id="cb232-40"><a href="#cb232-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">valueMissing</span>) {</span>
<span id="cb232-41"><a href="#cb232-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">&#39;This field is required&#39;</span><span class="op">;</span></span>
<span id="cb232-42"><a href="#cb232-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb232-43"><a href="#cb232-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">typeMismatch</span>) {</span>
<span id="cb232-44"><a href="#cb232-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`Please enter a valid </span><span class="sc">${</span>input<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb232-45"><a href="#cb232-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb232-46"><a href="#cb232-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">tooShort</span>) {</span>
<span id="cb232-47"><a href="#cb232-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`Must be at least </span><span class="sc">${</span>input<span class="op">.</span><span class="at">minLength</span><span class="sc">}</span><span class="vs"> characters`</span><span class="op">;</span></span>
<span id="cb232-48"><a href="#cb232-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb232-49"><a href="#cb232-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">tooLong</span>) {</span>
<span id="cb232-50"><a href="#cb232-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`Must be no more than </span><span class="sc">${</span>input<span class="op">.</span><span class="at">maxLength</span><span class="sc">}</span><span class="vs"> characters`</span><span class="op">;</span></span>
<span id="cb232-51"><a href="#cb232-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb232-52"><a href="#cb232-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (input<span class="op">.</span><span class="at">validity</span><span class="op">.</span><span class="at">patternMismatch</span>) {</span>
<span id="cb232-53"><a href="#cb232-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> input<span class="op">.</span><span class="at">title</span> <span class="op">||</span> <span class="st">&#39;Invalid format&#39;</span><span class="op">;</span></span>
<span id="cb232-54"><a href="#cb232-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb232-55"><a href="#cb232-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-56"><a href="#cb232-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;Invalid input&#39;</span><span class="op">;</span></span>
<span id="cb232-57"><a href="#cb232-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-58"><a href="#cb232-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-59"><a href="#cb232-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showErrors</span>(errors) {</span>
<span id="cb232-60"><a href="#cb232-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(errors)<span class="op">.</span><span class="fu">forEach</span>(([fieldName<span class="op">,</span> message]) <span class="kw">=&gt;</span> {</span>
<span id="cb232-61"><a href="#cb232-61" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> field <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`[name=&quot;</span><span class="sc">${</span>fieldName<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb232-62"><a href="#cb232-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> errorEl <span class="op">=</span> field<span class="op">.</span><span class="at">parentElement</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.error&#39;</span>)<span class="op">;</span></span>
<span id="cb232-63"><a href="#cb232-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-64"><a href="#cb232-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (errorEl) {</span>
<span id="cb232-65"><a href="#cb232-65" aria-hidden="true" tabindex="-1"></a>        errorEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> message<span class="op">;</span></span>
<span id="cb232-66"><a href="#cb232-66" aria-hidden="true" tabindex="-1"></a>        field<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;invalid&#39;</span>)<span class="op">;</span></span>
<span id="cb232-67"><a href="#cb232-67" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb232-68"><a href="#cb232-68" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb232-69"><a href="#cb232-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-70"><a href="#cb232-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-71"><a href="#cb232-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clearErrors</span>() {</span>
<span id="cb232-72"><a href="#cb232-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.error&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> {</span>
<span id="cb232-73"><a href="#cb232-73" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb232-74"><a href="#cb232-74" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb232-75"><a href="#cb232-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-76"><a href="#cb232-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.invalid&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> {</span>
<span id="cb232-77"><a href="#cb232-77" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="at">classList</span><span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;invalid&#39;</span>)<span class="op">;</span></span>
<span id="cb232-78"><a href="#cb232-78" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb232-79"><a href="#cb232-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-80"><a href="#cb232-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-81"><a href="#cb232-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb232-82"><a href="#cb232-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb232-83"><a href="#cb232-83" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb232-84"><a href="#cb232-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb232-85"><a href="#cb232-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label&gt;Email&lt;/label&gt;</span></span>
<span id="cb232-86"><a href="#cb232-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;email&quot; name=&quot;email&quot; required&gt;</span></span>
<span id="cb232-87"><a href="#cb232-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;error&quot;&gt;&lt;/span&gt;</span></span>
<span id="cb232-88"><a href="#cb232-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb232-89"><a href="#cb232-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-90"><a href="#cb232-90" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb232-91"><a href="#cb232-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label&gt;Password&lt;/label&gt;</span></span>
<span id="cb232-92"><a href="#cb232-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; name=&quot;password&quot; required minlength=&quot;8&quot;&gt;</span></span>
<span id="cb232-93"><a href="#cb232-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;error&quot;&gt;&lt;/span&gt;</span></span>
<span id="cb232-94"><a href="#cb232-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb232-95"><a href="#cb232-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-96"><a href="#cb232-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;</span></span>
<span id="cb232-97"><a href="#cb232-97" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb232-98"><a href="#cb232-98" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb232-99"><a href="#cb232-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-100"><a href="#cb232-100" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="10.5" id="file-uploads"><span
class="header-section-number">10.5</span> File Uploads</h2>
<p>Handle file uploads with progress tracking:</p>
<div class="sourceCode" id="cb233"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileUpload <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input[type=&quot;file&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> button <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">;</span></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> file <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (file) {</span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showPreview</span>(file)<span class="op">;</span></span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a>        button<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a>    button<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> file <span class="op">=</span> input<span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (file) {</span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">uploadFile</span>(file)<span class="op">;</span></span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-23"><a href="#cb233-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-24"><a href="#cb233-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showPreview</span>(file) {</span>
<span id="cb233-25"><a href="#cb233-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> preview <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.preview&#39;</span>)<span class="op">;</span></span>
<span id="cb233-26"><a href="#cb233-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-27"><a href="#cb233-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (file<span class="op">.</span><span class="at">type</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;image/&#39;</span>)) {</span>
<span id="cb233-28"><a href="#cb233-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> reader <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileReader</span>()<span class="op">;</span></span>
<span id="cb233-29"><a href="#cb233-29" aria-hidden="true" tabindex="-1"></a>      reader<span class="op">.</span><span class="at">onload</span> <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb233-30"><a href="#cb233-30" aria-hidden="true" tabindex="-1"></a>        preview<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;img src=&quot;</span><span class="sc">${</span>e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">result</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;Preview&quot;&gt;`</span><span class="op">;</span></span>
<span id="cb233-31"><a href="#cb233-31" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb233-32"><a href="#cb233-32" aria-hidden="true" tabindex="-1"></a>      reader<span class="op">.</span><span class="fu">readAsDataURL</span>(file)<span class="op">;</span></span>
<span id="cb233-33"><a href="#cb233-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb233-34"><a href="#cb233-34" aria-hidden="true" tabindex="-1"></a>      preview<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb233-35"><a href="#cb233-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;</span><span class="sc">${</span>file<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb233-36"><a href="#cb233-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatFileSize</span>(file<span class="op">.</span><span class="at">size</span>)<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb233-37"><a href="#cb233-37" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb233-38"><a href="#cb233-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb233-39"><a href="#cb233-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-40"><a href="#cb233-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-41"><a href="#cb233-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">uploadFile</span>(file) {</span>
<span id="cb233-42"><a href="#cb233-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb233-43"><a href="#cb233-43" aria-hidden="true" tabindex="-1"></a>    formData<span class="op">.</span><span class="fu">append</span>(<span class="st">&#39;file&#39;</span><span class="op">,</span> file)<span class="op">;</span></span>
<span id="cb233-44"><a href="#cb233-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-45"><a href="#cb233-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> xhr <span class="op">=</span> <span class="kw">new</span> <span class="bu">XMLHttpRequest</span>()<span class="op">;</span></span>
<span id="cb233-46"><a href="#cb233-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-47"><a href="#cb233-47" aria-hidden="true" tabindex="-1"></a>    xhr<span class="op">.</span><span class="at">upload</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;progress&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb233-48"><a href="#cb233-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> percent <span class="op">=</span> (e<span class="op">.</span><span class="at">loaded</span> <span class="op">/</span> e<span class="op">.</span><span class="at">total</span>) <span class="op">*</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb233-49"><a href="#cb233-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateProgress</span>(percent)<span class="op">;</span></span>
<span id="cb233-50"><a href="#cb233-50" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb233-51"><a href="#cb233-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-52"><a href="#cb233-52" aria-hidden="true" tabindex="-1"></a>    xhr<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb233-53"><a href="#cb233-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (xhr<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">200</span>) {</span>
<span id="cb233-54"><a href="#cb233-54" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;file.uploaded&#39;</span><span class="op">,</span> {</span>
<span id="cb233-55"><a href="#cb233-55" aria-hidden="true" tabindex="-1"></a>          <span class="dt">filename</span><span class="op">:</span> file<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb233-56"><a href="#cb233-56" aria-hidden="true" tabindex="-1"></a>          <span class="dt">response</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(xhr<span class="op">.</span><span class="at">response</span>)</span>
<span id="cb233-57"><a href="#cb233-57" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb233-58"><a href="#cb233-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>()<span class="op">;</span></span>
<span id="cb233-59"><a href="#cb233-59" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb233-60"><a href="#cb233-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Upload failed&#39;</span>)<span class="op">;</span></span>
<span id="cb233-61"><a href="#cb233-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb233-62"><a href="#cb233-62" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb233-63"><a href="#cb233-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-64"><a href="#cb233-64" aria-hidden="true" tabindex="-1"></a>    xhr<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb233-65"><a href="#cb233-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Upload failed&#39;</span>)<span class="op">;</span></span>
<span id="cb233-66"><a href="#cb233-66" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb233-67"><a href="#cb233-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-68"><a href="#cb233-68" aria-hidden="true" tabindex="-1"></a>    xhr<span class="op">.</span><span class="fu">open</span>(<span class="st">&#39;POST&#39;</span><span class="op">,</span> <span class="st">&#39;/api/upload&#39;</span>)<span class="op">;</span></span>
<span id="cb233-69"><a href="#cb233-69" aria-hidden="true" tabindex="-1"></a>    xhr<span class="op">.</span><span class="fu">send</span>(formData)<span class="op">;</span></span>
<span id="cb233-70"><a href="#cb233-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-71"><a href="#cb233-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-72"><a href="#cb233-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateProgress</span>(percent) {</span>
<span id="cb233-73"><a href="#cb233-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> progress <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.progress-bar&#39;</span>)<span class="op">;</span></span>
<span id="cb233-74"><a href="#cb233-74" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>percent<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb233-75"><a href="#cb233-75" aria-hidden="true" tabindex="-1"></a>    progress<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(percent)<span class="sc">}</span><span class="vs">%`</span><span class="op">;</span></span>
<span id="cb233-76"><a href="#cb233-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-77"><a href="#cb233-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-78"><a href="#cb233-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatFileSize</span>(bytes) {</span>
<span id="cb233-79"><a href="#cb233-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (bytes <span class="op">&lt;</span> <span class="dv">1024</span>) <span class="cf">return</span> bytes <span class="op">+</span> <span class="st">&#39; B&#39;</span><span class="op">;</span></span>
<span id="cb233-80"><a href="#cb233-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (bytes <span class="op">&lt;</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>) <span class="cf">return</span> (bytes <span class="op">/</span> <span class="dv">1024</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">&#39; KB&#39;</span><span class="op">;</span></span>
<span id="cb233-81"><a href="#cb233-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (bytes <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>))<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">&#39; MB&#39;</span><span class="op">;</span></span>
<span id="cb233-82"><a href="#cb233-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-83"><a href="#cb233-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-84"><a href="#cb233-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showSuccess</span>() {</span>
<span id="cb233-85"><a href="#cb233-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;✓ Uploaded successfully&#39;</span><span class="op">;</span></span>
<span id="cb233-86"><a href="#cb233-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-87"><a href="#cb233-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-88"><a href="#cb233-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">showError</span>(message) {</span>
<span id="cb233-89"><a href="#cb233-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`✗ </span><span class="sc">${</span>message<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb233-90"><a href="#cb233-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-91"><a href="#cb233-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-92"><a href="#cb233-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb233-93"><a href="#cb233-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb233-94"><a href="#cb233-94" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;upload-container&quot;&gt;</span></span>
<span id="cb233-95"><a href="#cb233-95" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;file&quot; accept=&quot;image/*&quot;&gt;</span></span>
<span id="cb233-96"><a href="#cb233-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;preview&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb233-97"><a href="#cb233-97" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;progress&quot;&gt;</span></span>
<span id="cb233-98"><a href="#cb233-98" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;progress-bar&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb233-99"><a href="#cb233-99" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb233-100"><a href="#cb233-100" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button disabled&gt;Upload&lt;/button&gt;</span></span>
<span id="cb233-101"><a href="#cb233-101" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;status&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb233-102"><a href="#cb233-102" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb233-103"><a href="#cb233-103" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb233-104"><a href="#cb233-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb233-105"><a href="#cb233-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb233-106"><a href="#cb233-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-107"><a href="#cb233-107" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;file-upload&#39;</span><span class="op">,</span> FileUpload)<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.6" id="form-submission"><span
class="header-section-number">10.6</span> Form Submission</h2>
<p>Handle form submission with loading states and error recovery:</p>
<div class="sourceCode" id="cb234"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SmartForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">submitting</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">submitting</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">submitting</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">disableForm</span>()<span class="op">;</span></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getFormData</span>()<span class="op">;</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">submitForm</span>(data)<span class="op">;</span></span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handleSuccess</span>()<span class="op">;</span></span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb234-24"><a href="#cb234-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">handleError</span>(error)<span class="op">;</span></span>
<span id="cb234-25"><a href="#cb234-25" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">finally</span> {</span>
<span id="cb234-26"><a href="#cb234-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">submitting</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb234-27"><a href="#cb234-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">enableForm</span>()<span class="op">;</span></span>
<span id="cb234-28"><a href="#cb234-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb234-29"><a href="#cb234-29" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb234-30"><a href="#cb234-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-31"><a href="#cb234-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-32"><a href="#cb234-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getFormData</span>() {</span>
<span id="cb234-33"><a href="#cb234-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb234-34"><a href="#cb234-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>(form)<span class="op">;</span></span>
<span id="cb234-35"><a href="#cb234-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">fromEntries</span>(formData)<span class="op">;</span></span>
<span id="cb234-36"><a href="#cb234-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-37"><a href="#cb234-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-38"><a href="#cb234-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">submitForm</span>(data) {</span>
<span id="cb234-39"><a href="#cb234-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/submit&#39;</span><span class="op">,</span> {</span>
<span id="cb234-40"><a href="#cb234-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb234-41"><a href="#cb234-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb234-42"><a href="#cb234-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb234-43"><a href="#cb234-43" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb234-44"><a href="#cb234-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-45"><a href="#cb234-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb234-46"><a href="#cb234-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb234-47"><a href="#cb234-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(error<span class="op">.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Submission failed&#39;</span>)<span class="op">;</span></span>
<span id="cb234-48"><a href="#cb234-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb234-49"><a href="#cb234-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-50"><a href="#cb234-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb234-51"><a href="#cb234-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-52"><a href="#cb234-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-53"><a href="#cb234-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disableForm</span>() {</span>
<span id="cb234-54"><a href="#cb234-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inputs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;input, button, textarea&#39;</span>)<span class="op">;</span></span>
<span id="cb234-55"><a href="#cb234-55" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> el<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb234-56"><a href="#cb234-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-57"><a href="#cb234-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loading&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;block&#39;</span><span class="op">;</span></span>
<span id="cb234-58"><a href="#cb234-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-59"><a href="#cb234-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-60"><a href="#cb234-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enableForm</span>() {</span>
<span id="cb234-61"><a href="#cb234-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> inputs <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;input, button, textarea&#39;</span>)<span class="op">;</span></span>
<span id="cb234-62"><a href="#cb234-62" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> el<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb234-63"><a href="#cb234-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-64"><a href="#cb234-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loading&#39;</span>)<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">display</span> <span class="op">=</span> <span class="st">&#39;none&#39;</span><span class="op">;</span></span>
<span id="cb234-65"><a href="#cb234-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-66"><a href="#cb234-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-67"><a href="#cb234-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleSuccess</span>() {</span>
<span id="cb234-68"><a href="#cb234-68" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.success&#39;</span><span class="op">,</span> { <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Form submitted successfully!&#39;</span> })<span class="op">;</span></span>
<span id="cb234-69"><a href="#cb234-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb234-70"><a href="#cb234-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-71"><a href="#cb234-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-72"><a href="#cb234-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleError</span>(error) {</span>
<span id="cb234-73"><a href="#cb234-73" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.error&#39;</span><span class="op">,</span> { <span class="dt">message</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb234-74"><a href="#cb234-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-75"><a href="#cb234-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-76"><a href="#cb234-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb234-77"><a href="#cb234-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb234-78"><a href="#cb234-78" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb234-79"><a href="#cb234-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        .loading {</span></span>
<span id="cb234-80"><a href="#cb234-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb234-81"><a href="#cb234-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb234-82"><a href="#cb234-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 16px;</span></span>
<span id="cb234-83"><a href="#cb234-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb234-84"><a href="#cb234-84" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb234-85"><a href="#cb234-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-86"><a href="#cb234-86" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb234-87"><a href="#cb234-87" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;!-- Form fields --&gt;</span></span>
<span id="cb234-88"><a href="#cb234-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;</span></span>
<span id="cb234-89"><a href="#cb234-89" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb234-90"><a href="#cb234-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-91"><a href="#cb234-91" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;loading&quot;&gt;</span></span>
<span id="cb234-92"><a href="#cb234-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;spinner&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb234-93"><a href="#cb234-93" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Submitting...&lt;/p&gt;</span></span>
<span id="cb234-94"><a href="#cb234-94" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb234-95"><a href="#cb234-95" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb234-96"><a href="#cb234-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb234-97"><a href="#cb234-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb234-98"><a href="#cb234-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-99"><a href="#cb234-99" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;smart-form&#39;</span><span class="op">,</span> SmartForm)<span class="op">;</span></span></code></pre></div>
<h2 data-number="10.7" id="summary-9"><span
class="header-section-number">10.7</span> Summary</h2>
<p>This chapter covered:</p>
<ul>
<li>Building accessible form components</li>
<li>Two-way data binding patterns</li>
<li>Validation strategies (native and custom)</li>
<li>Error handling and display</li>
<li>File upload with progress tracking</li>
<li>Form submission with loading states</li>
</ul>
<hr />
<h2 data-number="10.8" id="best-practices-6"><span
class="header-section-number">10.8</span> Best Practices</h2>
<ol type="1">
<li><strong>Use native validation first</strong> - HTML5 provides
powerful built-in validation</li>
<li><strong>Provide clear error messages</strong> - Tell users exactly
what’s wrong</li>
<li><strong>Validate on blur</strong> - Don’t show errors while user is
typing</li>
<li><strong>Disable during submission</strong> - Prevent
double-submission</li>
<li><strong>Show progress for uploads</strong> - Users want to see
progress</li>
<li><strong>Handle errors gracefully</strong> - Network can fail, handle
it well</li>
</ol>
<hr />
<h2 data-number="10.9" id="further-reading-9"><span
class="header-section-number">10.9</span> Further Reading</h2>
<p><strong>For complete forms and validation reference:</strong> -
<em>Building with LARC</em> Chapter 6: Forms and User Input - All form
patterns and validation strategies - <em>Building with LARC</em> Chapter
19: UI Components - pan-files and pan-markdown-editor reference -
<em>Building with LARC</em> Appendix E: Recipes and Patterns - Form
validation recipes</p>
<div class="pagebreak">

</div>
<h1 data-number="11" id="data-fetching-and-apis"><span
class="header-section-number">11</span> Data Fetching and APIs</h1>
<p>Every meaningful web application needs to communicate with servers.
Whether you’re loading user profiles, submitting forms, or streaming
real-time updates, data fetching is the bridge between your frontend and
the outside world. LARC embraces the browser’s native fetch API while
providing patterns that make common tasks simple and complex scenarios
manageable.</p>
<h2 data-number="11.1" id="the-fetch-api-your-foundation"><span
class="header-section-number">11.1</span> The Fetch API: Your
Foundation</h2>
<p>The Fetch API is built into every modern browser, and it’s genuinely
excellent. Unlike the XMLHttpRequest it replaced, fetch returns
Promises, works naturally with async/await, and provides a clean
interface for HTTP operations.</p>
<p>Here’s the simplest possible fetch:</p>
<div class="sourceCode" id="cb235"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/users&#39;</span>)<span class="op">;</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span></code></pre></div>
<p>Two lines. No libraries. No configuration. This is the foundation
everything else builds upon.</p>
<p>But real applications need more: error handling, loading states,
retries, caching. Let’s build these capabilities systematically.</p>
<h2 data-number="11.2" id="building-an-api-client"><span
class="header-section-number">11.2</span> Building an API Client</h2>
<p>Rather than scattering fetch calls throughout your application,
centralize them in an API client. This gives you one place to handle
authentication, errors, and common patterns:</p>
<div class="sourceCode" id="cb236"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co">// api-client.js</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ApiClient {</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(baseUrl <span class="op">=</span> <span class="st">&#39;/api&#39;</span>) {</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span> <span class="op">=</span> baseUrl<span class="op">;</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> config <span class="op">=</span> {</span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span>options<span class="op">.</span><span class="at">headers</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>options</span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add auth token if available</span></span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;authToken&#39;</span>)<span class="op">;</span></span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (token) {</span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a>      config<span class="op">.</span><span class="at">headers</span>[<span class="st">&#39;Authorization&#39;</span>] <span class="op">=</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> config)<span class="op">;</span></span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">.</span><span class="fu">catch</span>(() <span class="kw">=&gt;</span> ({}))<span class="op">;</span></span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ApiError</span>(response<span class="op">.</span><span class="at">status</span><span class="op">,</span> error<span class="op">.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Request failed&#39;</span>)<span class="op">;</span></span>
<span id="cb236-30"><a href="#cb236-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb236-31"><a href="#cb236-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-32"><a href="#cb236-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb236-33"><a href="#cb236-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb236-34"><a href="#cb236-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error <span class="kw">instanceof</span> ApiError) <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb236-35"><a href="#cb236-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ApiError</span>(<span class="dv">0</span><span class="op">,</span> <span class="st">&#39;Network error&#39;</span>)<span class="op">;</span></span>
<span id="cb236-36"><a href="#cb236-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb236-37"><a href="#cb236-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-38"><a href="#cb236-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-39"><a href="#cb236-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(endpoint) {</span>
<span id="cb236-40"><a href="#cb236-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetch</span>(endpoint)<span class="op">;</span></span>
<span id="cb236-41"><a href="#cb236-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-42"><a href="#cb236-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-43"><a href="#cb236-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">post</span>(endpoint<span class="op">,</span> data) {</span>
<span id="cb236-44"><a href="#cb236-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetch</span>(endpoint<span class="op">,</span> {</span>
<span id="cb236-45"><a href="#cb236-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb236-46"><a href="#cb236-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb236-47"><a href="#cb236-47" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb236-48"><a href="#cb236-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-49"><a href="#cb236-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-50"><a href="#cb236-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">put</span>(endpoint<span class="op">,</span> data) {</span>
<span id="cb236-51"><a href="#cb236-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetch</span>(endpoint<span class="op">,</span> {</span>
<span id="cb236-52"><a href="#cb236-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;PUT&#39;</span><span class="op">,</span></span>
<span id="cb236-53"><a href="#cb236-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)</span>
<span id="cb236-54"><a href="#cb236-54" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb236-55"><a href="#cb236-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-56"><a href="#cb236-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-57"><a href="#cb236-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">delete</span>(endpoint) {</span>
<span id="cb236-58"><a href="#cb236-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetch</span>(endpoint<span class="op">,</span> { <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;DELETE&#39;</span> })<span class="op">;</span></span>
<span id="cb236-59"><a href="#cb236-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-60"><a href="#cb236-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb236-61"><a href="#cb236-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-62"><a href="#cb236-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ApiError <span class="kw">extends</span> <span class="bu">Error</span> {</span>
<span id="cb236-63"><a href="#cb236-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(status<span class="op">,</span> message) {</span>
<span id="cb236-64"><a href="#cb236-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(message)<span class="op">;</span></span>
<span id="cb236-65"><a href="#cb236-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">status</span> <span class="op">=</span> status<span class="op">;</span></span>
<span id="cb236-66"><a href="#cb236-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb236-67"><a href="#cb236-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb236-68"><a href="#cb236-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-69"><a href="#cb236-69" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> api <span class="op">=</span> <span class="kw">new</span> <span class="fu">ApiClient</span>()<span class="op">;</span></span></code></pre></div>
<p>Now every component in your application can import this client and
make requests with consistent error handling and authentication.</p>
<h2 data-number="11.3" id="integrating-with-the-pan-bus"><span
class="header-section-number">11.3</span> Integrating with the PAN
Bus</h2>
<p>Here’s where LARC shines. Instead of each component managing its own
loading states and error handling, broadcast API events on the PAN
bus:</p>
<div class="sourceCode" id="cb237"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co">// api-client.js (enhanced)</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@aspect/pan-client&#39;</span><span class="op">;</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ApiClient {</span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> requestId <span class="op">=</span> crypto<span class="op">.</span><span class="fu">randomUUID</span>()<span class="op">;</span></span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Announce request start</span></span>
<span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.request.start&#39;</span><span class="op">,</span> { requestId<span class="op">,</span> endpoint })<span class="op">;</span></span>
<span id="cb237-10"><a href="#cb237-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-11"><a href="#cb237-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb237-12"><a href="#cb237-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="co">/* ... */</span>)<span class="op">;</span></span>
<span id="cb237-13"><a href="#cb237-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb237-14"><a href="#cb237-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-15"><a href="#cb237-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Announce success</span></span>
<span id="cb237-16"><a href="#cb237-16" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.request.success&#39;</span><span class="op">,</span> { requestId<span class="op">,</span> endpoint<span class="op">,</span> data })<span class="op">;</span></span>
<span id="cb237-17"><a href="#cb237-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb237-18"><a href="#cb237-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-19"><a href="#cb237-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb237-20"><a href="#cb237-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Announce failure</span></span>
<span id="cb237-21"><a href="#cb237-21" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.request.error&#39;</span><span class="op">,</span> { requestId<span class="op">,</span> endpoint<span class="op">,</span> error })<span class="op">;</span></span>
<span id="cb237-22"><a href="#cb237-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb237-23"><a href="#cb237-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb237-24"><a href="#cb237-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb237-25"><a href="#cb237-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now any component can listen for API events. A loading indicator
component might subscribe to <code>api.request.start</code> and
<code>api.request.success</code>. An error toast might listen only for
<code>api.request.error</code>. Components become loosely coupled—they
don’t need to know about each other, just the messages they care
about.</p>
<h2 data-number="11.4" id="caching-strategies"><span
class="header-section-number">11.4</span> Caching Strategies</h2>
<p>Network requests are slow and expensive. Smart caching makes your
application feel instant while reducing server load.</p>
<h3 data-number="11.4.1" id="cache-first-strategy-1"><span
class="header-section-number">11.4.1</span> Cache-First Strategy</h3>
<p>For data that changes infrequently, serve from cache immediately and
update in the background:</p>
<div class="sourceCode" id="cb238"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CachedApiClient <span class="kw">extends</span> ApiClient {</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getCached</span>(endpoint<span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">60000</span>) {</span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached <span class="op">&amp;&amp;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> cached<span class="op">.</span><span class="at">timestamp</span> <span class="op">&lt;</span> maxAge) {</span>
<span id="cb238-11"><a href="#cb238-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Return cached data immediately</span></span>
<span id="cb238-12"><a href="#cb238-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cached<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb238-13"><a href="#cb238-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb238-14"><a href="#cb238-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-15"><a href="#cb238-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fetch fresh data</span></span>
<span id="cb238-16"><a href="#cb238-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb238-17"><a href="#cb238-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(endpoint<span class="op">,</span> { data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb238-18"><a href="#cb238-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb238-19"><a href="#cb238-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb238-20"><a href="#cb238-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-21"><a href="#cb238-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getStaleWhileRevalidate</span>(endpoint<span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">60000</span>) {</span>
<span id="cb238-22"><a href="#cb238-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb238-23"><a href="#cb238-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-24"><a href="#cb238-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return stale data immediately if available</span></span>
<span id="cb238-25"><a href="#cb238-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached) {</span>
<span id="cb238-26"><a href="#cb238-26" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Revalidate in background</span></span>
<span id="cb238-27"><a href="#cb238-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">.</span><span class="fu">then</span>(data <span class="kw">=&gt;</span> {</span>
<span id="cb238-28"><a href="#cb238-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(endpoint<span class="op">,</span> { data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb238-29"><a href="#cb238-29" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="vs">`cache.updated.</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> { data })<span class="op">;</span></span>
<span id="cb238-30"><a href="#cb238-30" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb238-31"><a href="#cb238-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-32"><a href="#cb238-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cached<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb238-33"><a href="#cb238-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb238-34"><a href="#cb238-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-35"><a href="#cb238-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No cache, must wait for network</span></span>
<span id="cb238-36"><a href="#cb238-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb238-37"><a href="#cb238-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(endpoint<span class="op">,</span> { data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb238-38"><a href="#cb238-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb238-39"><a href="#cb238-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb238-40"><a href="#cb238-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.4.2" id="network-first-strategy"><span
class="header-section-number">11.4.2</span> Network-First Strategy</h3>
<p>For data that must be current, try the network first and fall back to
cache:</p>
<div class="sourceCode" id="cb239"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="fu">getNetworkFirst</span>(endpoint<span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">300000</span>) {</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(endpoint<span class="op">,</span> { data<span class="op">,</span> <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() })<span class="op">;</span></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached <span class="op">&amp;&amp;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> cached<span class="op">.</span><span class="at">timestamp</span> <span class="op">&lt;</span> maxAge) {</span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="st">&#39;Using cached data due to network error&#39;</span>)<span class="op">;</span></span>
<span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cached<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb239-13"><a href="#cb239-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb239-14"><a href="#cb239-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.5" id="websocket-communication"><span
class="header-section-number">11.5</span> WebSocket Communication</h2>
<p>When you need real-time bidirectional communication, WebSockets
provide a persistent connection between browser and server:</p>
<div class="sourceCode" id="cb240"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co">// websocket-client.js</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WebSocketClient {</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(url) {</span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">url</span> <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxReconnectAttempts</span> <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connect</span>() {</span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="kw">this</span><span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">.</span><span class="at">onopen</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.connected&#39;</span>)<span class="op">;</span></span>
<span id="cb240-16"><a href="#cb240-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb240-17"><a href="#cb240-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-18"><a href="#cb240-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb240-19"><a href="#cb240-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> message <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb240-20"><a href="#cb240-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Broadcast message on PAN bus</span></span>
<span id="cb240-21"><a href="#cb240-21" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="vs">`ws.message.</span><span class="sc">${</span>message<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> message<span class="op">.</span><span class="at">payload</span>)<span class="op">;</span></span>
<span id="cb240-22"><a href="#cb240-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb240-23"><a href="#cb240-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-24"><a href="#cb240-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">.</span><span class="at">onclose</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb240-25"><a href="#cb240-25" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.disconnected&#39;</span>)<span class="op">;</span></span>
<span id="cb240-26"><a href="#cb240-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">attemptReconnect</span>()<span class="op">;</span></span>
<span id="cb240-27"><a href="#cb240-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb240-28"><a href="#cb240-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-29"><a href="#cb240-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> (error) <span class="kw">=&gt;</span> {</span>
<span id="cb240-30"><a href="#cb240-30" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;ws.error&#39;</span><span class="op">,</span> { error })<span class="op">;</span></span>
<span id="cb240-31"><a href="#cb240-31" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb240-32"><a href="#cb240-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-33"><a href="#cb240-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-34"><a href="#cb240-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">send</span>(type<span class="op">,</span> payload) {</span>
<span id="cb240-35"><a href="#cb240-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">?.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb240-36"><a href="#cb240-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">socket</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ type<span class="op">,</span> payload }))<span class="op">;</span></span>
<span id="cb240-37"><a href="#cb240-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb240-38"><a href="#cb240-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-39"><a href="#cb240-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-40"><a href="#cb240-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attemptReconnect</span>() {</span>
<span id="cb240-41"><a href="#cb240-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span> <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxReconnectAttempts</span>) {</span>
<span id="cb240-42"><a href="#cb240-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span><span class="op">++;</span></span>
<span id="cb240-43"><a href="#cb240-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">1000</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">reconnectAttempts</span>)<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb240-44"><a href="#cb240-44" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">connect</span>()<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb240-45"><a href="#cb240-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb240-46"><a href="#cb240-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-47"><a href="#cb240-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The beauty of this approach: your components don’t know or care that
data comes from a WebSocket. They just subscribe to PAN bus topics like
<code>ws.message.user-joined</code> or
<code>ws.message.chat-message</code>.</p>
<h2 data-number="11.6" id="server-sent-events"><span
class="header-section-number">11.6</span> Server-Sent Events</h2>
<p>When you only need server-to-client updates (no bidirectional
communication), Server-Sent Events (SSE) are simpler and more reliable
than WebSockets:</p>
<div class="sourceCode" id="cb241"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co">// sse-client.js</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SSEClient {</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(url) {</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">url</span> <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connect</span>() {</span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">EventSource</span>(<span class="kw">this</span><span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.message&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;notification&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.notification&#39;</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span><span class="op">.</span><span class="at">onerror</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb241-22"><a href="#cb241-22" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;sse.error&#39;</span>)<span class="op">;</span></span>
<span id="cb241-23"><a href="#cb241-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// EventSource automatically reconnects</span></span>
<span id="cb241-24"><a href="#cb241-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb241-25"><a href="#cb241-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb241-26"><a href="#cb241-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-27"><a href="#cb241-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnect</span>() {</span>
<span id="cb241-28"><a href="#cb241-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">eventSource</span><span class="op">?.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb241-29"><a href="#cb241-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb241-30"><a href="#cb241-30" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>SSE reconnects automatically, handles authentication through cookies,
and works through proxies that might block WebSockets. For many
real-time use cases, it’s the better choice.</p>
<h2 data-number="11.7" id="retry-logic-with-exponential-backoff"><span
class="header-section-number">11.7</span> Retry Logic with Exponential
Backoff</h2>
<p>Network requests fail. Good applications handle failure
gracefully:</p>
<div class="sourceCode" id="cb242"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">fetchWithRetry</span>(url<span class="op">,</span> options <span class="op">=</span> {}<span class="op">,</span> maxRetries <span class="op">=</span> <span class="dv">3</span>) {</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lastError<span class="op">;</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> attempt <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> attempt <span class="op">&lt;</span> maxRetries<span class="op">;</span> attempt<span class="op">++</span>) {</span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) <span class="cf">return</span> response<span class="op">;</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Don&#39;t retry client errors (4xx)</span></span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">&gt;=</span> <span class="dv">400</span> <span class="op">&amp;&amp;</span> response<span class="op">.</span><span class="at">status</span> <span class="op">&lt;</span> <span class="dv">500</span>) {</span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Client error: </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-14"><a href="#cb242-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Server error: </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb242-15"><a href="#cb242-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb242-16"><a href="#cb242-16" aria-hidden="true" tabindex="-1"></a>      lastError <span class="op">=</span> error<span class="op">;</span></span>
<span id="cb242-17"><a href="#cb242-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-18"><a href="#cb242-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (attempt <span class="op">&lt;</span> maxRetries <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb242-19"><a href="#cb242-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Exponential backoff: 1s, 2s, 4s...</span></span>
<span id="cb242-20"><a href="#cb242-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> delay <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span><span class="op">,</span> attempt) <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb242-21"><a href="#cb242-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> delay))<span class="op">;</span></span>
<span id="cb242-22"><a href="#cb242-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb242-23"><a href="#cb242-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb242-24"><a href="#cb242-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb242-25"><a href="#cb242-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-26"><a href="#cb242-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">throw</span> lastError<span class="op">;</span></span>
<span id="cb242-27"><a href="#cb242-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.8" id="putting-it-all-together"><span
class="header-section-number">11.8</span> Putting It All Together</h2>
<p>Here’s a component that fetches user data with loading states,
caching, and error handling—all integrated with the PAN bus:</p>
<div class="sourceCode" id="cb243"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">users</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to cache updates</span></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cache.updated./api/users&#39;</span><span class="op">,</span> ({ data }) <span class="kw">=&gt;</span> {</span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">users</span> <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">users</span> <span class="op">=</span> <span class="cf">await</span> api<span class="op">.</span><span class="fu">getStaleWhileRevalidate</span>(<span class="st">&#39;/users&#39;</span>)<span class="op">;</span></span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb243-21"><a href="#cb243-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> error<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb243-22"><a href="#cb243-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb243-23"><a href="#cb243-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb243-24"><a href="#cb243-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-25"><a href="#cb243-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb243-26"><a href="#cb243-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb243-27"><a href="#cb243-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-28"><a href="#cb243-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb243-29"><a href="#cb243-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb243-30"><a href="#cb243-30" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb243-31"><a href="#cb243-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host { display: block; }</span></span>
<span id="cb243-32"><a href="#cb243-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        .loading { color: #666; }</span></span>
<span id="cb243-33"><a href="#cb243-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error { color: red; }</span></span>
<span id="cb243-34"><a href="#cb243-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        .user { padding: 8px; border-bottom: 1px solid #eee; }</span></span>
<span id="cb243-35"><a href="#cb243-35" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb243-36"><a href="#cb243-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-37"><a href="#cb243-37" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;&lt;p class=&quot;loading&quot;&gt;Loading users...&lt;/p&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb243-38"><a href="#cb243-38" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`&lt;p class=&quot;error&quot;&gt;Error: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/p&gt;`</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb243-39"><a href="#cb243-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-40"><a href="#cb243-40" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;users&quot;&gt;</span></span>
<span id="cb243-41"><a href="#cb243-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">map</span>(user <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb243-42"><a href="#cb243-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;user&quot;&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> - </span><span class="sc">${</span>user<span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb243-43"><a href="#cb243-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb243-44"><a href="#cb243-44" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb243-45"><a href="#cb243-45" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb243-46"><a href="#cb243-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb243-47"><a href="#cb243-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb243-48"><a href="#cb243-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-49"><a href="#cb243-49" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-list&#39;</span><span class="op">,</span> UserList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="11.9" id="graphql-integration"><span
class="header-section-number">11.9</span> GraphQL Integration</h2>
<p>While REST APIs are common, GraphQL offers precise data
fetching—request exactly what you need, nothing more. Here’s how to
integrate GraphQL with LARC:</p>
<div class="sourceCode" id="cb244"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co">// graphql-client.js</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GraphQLClient {</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(endpoint) {</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">endpoint</span> <span class="op">=</span> endpoint<span class="op">;</span></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">query</span>(query<span class="op">,</span> variables <span class="op">=</span> {}) {</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="kw">this</span><span class="op">.</span><span class="at">endpoint</span><span class="op">,</span> {</span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span>localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;authToken&#39;</span>)<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ query<span class="op">,</span> variables })</span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { data<span class="op">,</span> errors } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (errors) {</span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">GraphQLError</span>(errors)<span class="op">;</span></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">mutation</span>(mutation<span class="op">,</span> variables <span class="op">=</span> {}) {</span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">query</span>(mutation<span class="op">,</span> variables)<span class="op">;</span></span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GraphQLError <span class="kw">extends</span> <span class="bu">Error</span> {</span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(errors) {</span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(errors<span class="op">.</span><span class="fu">map</span>(e <span class="kw">=&gt;</span> e<span class="op">.</span><span class="at">message</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;, &#39;</span>))<span class="op">;</span></span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb244-36"><a href="#cb244-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb244-37"><a href="#cb244-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-38"><a href="#cb244-38" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> graphql <span class="op">=</span> <span class="kw">new</span> <span class="fu">GraphQLClient</span>(<span class="st">&#39;/graphql&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h3 data-number="11.9.1" id="using-graphql-in-components"><span
class="header-section-number">11.9.1</span> Using GraphQL in
Components</h3>
<div class="sourceCode" id="cb245"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProfile <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">;</span></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      query GetUser($id: ID!) {</span></span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        user(id: $id) {</span></span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          id</span></span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          name</span></span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          email</span></span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          avatar</span></span>
<span id="cb245-12"><a href="#cb245-12" aria-hidden="true" tabindex="-1"></a><span class="vs">          posts {</span></span>
<span id="cb245-13"><a href="#cb245-13" aria-hidden="true" tabindex="-1"></a><span class="vs">            id</span></span>
<span id="cb245-14"><a href="#cb245-14" aria-hidden="true" tabindex="-1"></a><span class="vs">            title</span></span>
<span id="cb245-15"><a href="#cb245-15" aria-hidden="true" tabindex="-1"></a><span class="vs">            publishedAt</span></span>
<span id="cb245-16"><a href="#cb245-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb245-17"><a href="#cb245-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb245-18"><a href="#cb245-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      }</span></span>
<span id="cb245-19"><a href="#cb245-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb245-20"><a href="#cb245-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-21"><a href="#cb245-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb245-22"><a href="#cb245-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { user } <span class="op">=</span> <span class="cf">await</span> graphql<span class="op">.</span><span class="fu">query</span>(query<span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> userId })<span class="op">;</span></span>
<span id="cb245-23"><a href="#cb245-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderUser</span>(user)<span class="op">;</span></span>
<span id="cb245-24"><a href="#cb245-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb245-25"><a href="#cb245-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderError</span>(error)<span class="op">;</span></span>
<span id="cb245-26"><a href="#cb245-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb245-27"><a href="#cb245-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb245-28"><a href="#cb245-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-29"><a href="#cb245-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderUser</span>(user) {</span>
<span id="cb245-30"><a href="#cb245-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb245-31"><a href="#cb245-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;profile&quot;&gt;</span></span>
<span id="cb245-32"><a href="#cb245-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;img src=&quot;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">avatar</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb245-33"><a href="#cb245-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h2&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h2&gt;</span></span>
<span id="cb245-34"><a href="#cb245-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;</span><span class="sc">${</span>user<span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb245-35"><a href="#cb245-35" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;Recent Posts&lt;/h3&gt;</span></span>
<span id="cb245-36"><a href="#cb245-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;ul&gt;</span></span>
<span id="cb245-37"><a href="#cb245-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>user<span class="op">.</span><span class="at">posts</span><span class="op">.</span><span class="fu">map</span>(post <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb245-38"><a href="#cb245-38" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;li&gt;</span><span class="sc">${</span>post<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(post<span class="op">.</span><span class="at">publishedAt</span>)<span class="op">.</span><span class="fu">toLocaleDateString</span>()<span class="sc">}</span><span class="vs">)&lt;/li&gt;</span></span>
<span id="cb245-39"><a href="#cb245-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb245-40"><a href="#cb245-40" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/ul&gt;</span></span>
<span id="cb245-41"><a href="#cb245-41" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb245-42"><a href="#cb245-42" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb245-43"><a href="#cb245-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb245-44"><a href="#cb245-44" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.10"
id="real-world-example-building-a-dashboard"><span
class="header-section-number">11.10</span> Real-World Example: Building
a Dashboard</h2>
<p>Let’s build a complete dashboard that fetches data from multiple API
endpoints, handles loading states, and updates in real-time.</p>
<h3 data-number="11.10.1" id="the-dashboard-component"><span
class="header-section-number">11.10.1</span> The Dashboard
Component</h3>
<div class="sourceCode" id="cb246"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/dashboard.js</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { api } <span class="im">from</span> <span class="st">&#39;../lib/api-client.js&#39;</span><span class="op">;</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dashboard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stats</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">activity</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">loading</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-16"><a href="#cb246-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-17"><a href="#cb246-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb246-18"><a href="#cb246-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to real-time updates</span></span>
<span id="cb246-19"><a href="#cb246-19" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message.stats-updated&#39;</span><span class="op">,</span> ({ stats }) <span class="kw">=&gt;</span> {</span>
<span id="cb246-20"><a href="#cb246-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span> <span class="op">=</span> stats<span class="op">;</span></span>
<span id="cb246-21"><a href="#cb246-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb246-22"><a href="#cb246-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb246-23"><a href="#cb246-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-24"><a href="#cb246-24" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message.activity-added&#39;</span><span class="op">,</span> ({ activity }) <span class="kw">=&gt;</span> {</span>
<span id="cb246-25"><a href="#cb246-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">activity</span><span class="op">.</span><span class="fu">unshift</span>(activity)<span class="op">;</span></span>
<span id="cb246-26"><a href="#cb246-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb246-27"><a href="#cb246-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb246-28"><a href="#cb246-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-29"><a href="#cb246-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb246-30"><a href="#cb246-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb246-31"><a href="#cb246-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-32"><a href="#cb246-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-33"><a href="#cb246-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadData</span>() {</span>
<span id="cb246-34"><a href="#cb246-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb246-35"><a href="#cb246-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load multiple endpoints in parallel</span></span>
<span id="cb246-36"><a href="#cb246-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> [stats<span class="op">,</span> activity] <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>([</span>
<span id="cb246-37"><a href="#cb246-37" aria-hidden="true" tabindex="-1"></a>        api<span class="op">.</span><span class="fu">getCached</span>(<span class="st">&#39;/stats&#39;</span><span class="op">,</span> <span class="dv">30000</span>)<span class="op">,</span></span>
<span id="cb246-38"><a href="#cb246-38" aria-hidden="true" tabindex="-1"></a>        api<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/activity?limit=10&#39;</span>)</span>
<span id="cb246-39"><a href="#cb246-39" aria-hidden="true" tabindex="-1"></a>      ])<span class="op">;</span></span>
<span id="cb246-40"><a href="#cb246-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-41"><a href="#cb246-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb246-42"><a href="#cb246-42" aria-hidden="true" tabindex="-1"></a>        stats<span class="op">,</span></span>
<span id="cb246-43"><a href="#cb246-43" aria-hidden="true" tabindex="-1"></a>        activity<span class="op">,</span></span>
<span id="cb246-44"><a href="#cb246-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb246-45"><a href="#cb246-45" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb246-46"><a href="#cb246-46" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb246-47"><a href="#cb246-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb246-48"><a href="#cb246-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb246-49"><a href="#cb246-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">,</span></span>
<span id="cb246-50"><a href="#cb246-50" aria-hidden="true" tabindex="-1"></a>        <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb246-51"><a href="#cb246-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span></span>
<span id="cb246-52"><a href="#cb246-52" aria-hidden="true" tabindex="-1"></a>      }<span class="op">;</span></span>
<span id="cb246-53"><a href="#cb246-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb246-54"><a href="#cb246-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-55"><a href="#cb246-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-56"><a href="#cb246-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">refreshData</span>() {</span>
<span id="cb246-57"><a href="#cb246-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb246-58"><a href="#cb246-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb246-59"><a href="#cb246-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb246-60"><a href="#cb246-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb246-61"><a href="#cb246-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-62"><a href="#cb246-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-63"><a href="#cb246-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb246-64"><a href="#cb246-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb246-65"><a href="#cb246-65" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb246-66"><a href="#cb246-66" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb246-67"><a href="#cb246-67" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb246-68"><a href="#cb246-68" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 20px;</span></span>
<span id="cb246-69"><a href="#cb246-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-70"><a href="#cb246-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-71"><a href="#cb246-71" aria-hidden="true" tabindex="-1"></a><span class="vs">        .header {</span></span>
<span id="cb246-72"><a href="#cb246-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb246-73"><a href="#cb246-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: space-between;</span></span>
<span id="cb246-74"><a href="#cb246-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb246-75"><a href="#cb246-75" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 20px;</span></span>
<span id="cb246-76"><a href="#cb246-76" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-77"><a href="#cb246-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-78"><a href="#cb246-78" aria-hidden="true" tabindex="-1"></a><span class="vs">        .stats {</span></span>
<span id="cb246-79"><a href="#cb246-79" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: grid;</span></span>
<span id="cb246-80"><a href="#cb246-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));</span></span>
<span id="cb246-81"><a href="#cb246-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 20px;</span></span>
<span id="cb246-82"><a href="#cb246-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 30px;</span></span>
<span id="cb246-83"><a href="#cb246-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-84"><a href="#cb246-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-85"><a href="#cb246-85" aria-hidden="true" tabindex="-1"></a><span class="vs">        .stat-card {</span></span>
<span id="cb246-86"><a href="#cb246-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb246-87"><a href="#cb246-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 20px;</span></span>
<span id="cb246-88"><a href="#cb246-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb246-89"><a href="#cb246-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 2px 4px rgba(0,0,0,0.1);</span></span>
<span id="cb246-90"><a href="#cb246-90" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-91"><a href="#cb246-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-92"><a href="#cb246-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        .stat-value {</span></span>
<span id="cb246-93"><a href="#cb246-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 32px;</span></span>
<span id="cb246-94"><a href="#cb246-94" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb246-95"><a href="#cb246-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #667eea;</span></span>
<span id="cb246-96"><a href="#cb246-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-97"><a href="#cb246-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-98"><a href="#cb246-98" aria-hidden="true" tabindex="-1"></a><span class="vs">        .stat-label {</span></span>
<span id="cb246-99"><a href="#cb246-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb246-100"><a href="#cb246-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 5px;</span></span>
<span id="cb246-101"><a href="#cb246-101" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-102"><a href="#cb246-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-103"><a href="#cb246-103" aria-hidden="true" tabindex="-1"></a><span class="vs">        .activity {</span></span>
<span id="cb246-104"><a href="#cb246-104" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb246-105"><a href="#cb246-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb246-106"><a href="#cb246-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 2px 4px rgba(0,0,0,0.1);</span></span>
<span id="cb246-107"><a href="#cb246-107" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-108"><a href="#cb246-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-109"><a href="#cb246-109" aria-hidden="true" tabindex="-1"></a><span class="vs">        .activity-header {</span></span>
<span id="cb246-110"><a href="#cb246-110" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 20px;</span></span>
<span id="cb246-111"><a href="#cb246-111" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #eee;</span></span>
<span id="cb246-112"><a href="#cb246-112" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb246-113"><a href="#cb246-113" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-114"><a href="#cb246-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-115"><a href="#cb246-115" aria-hidden="true" tabindex="-1"></a><span class="vs">        .activity-item {</span></span>
<span id="cb246-116"><a href="#cb246-116" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 15px 20px;</span></span>
<span id="cb246-117"><a href="#cb246-117" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #eee;</span></span>
<span id="cb246-118"><a href="#cb246-118" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-119"><a href="#cb246-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-120"><a href="#cb246-120" aria-hidden="true" tabindex="-1"></a><span class="vs">        .activity-item:last-child {</span></span>
<span id="cb246-121"><a href="#cb246-121" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: none;</span></span>
<span id="cb246-122"><a href="#cb246-122" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-123"><a href="#cb246-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-124"><a href="#cb246-124" aria-hidden="true" tabindex="-1"></a><span class="vs">        .loading {</span></span>
<span id="cb246-125"><a href="#cb246-125" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb246-126"><a href="#cb246-126" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 40px;</span></span>
<span id="cb246-127"><a href="#cb246-127" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb246-128"><a href="#cb246-128" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-129"><a href="#cb246-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-130"><a href="#cb246-130" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error {</span></span>
<span id="cb246-131"><a href="#cb246-131" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #fee;</span></span>
<span id="cb246-132"><a href="#cb246-132" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #c00;</span></span>
<span id="cb246-133"><a href="#cb246-133" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 15px;</span></span>
<span id="cb246-134"><a href="#cb246-134" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb246-135"><a href="#cb246-135" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-136"><a href="#cb246-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-137"><a href="#cb246-137" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb246-138"><a href="#cb246-138" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #667eea;</span></span>
<span id="cb246-139"><a href="#cb246-139" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb246-140"><a href="#cb246-140" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb246-141"><a href="#cb246-141" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px 20px;</span></span>
<span id="cb246-142"><a href="#cb246-142" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb246-143"><a href="#cb246-143" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb246-144"><a href="#cb246-144" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-145"><a href="#cb246-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-146"><a href="#cb246-146" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb246-147"><a href="#cb246-147" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #5568d3;</span></span>
<span id="cb246-148"><a href="#cb246-148" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb246-149"><a href="#cb246-149" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb246-150"><a href="#cb246-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-151"><a href="#cb246-151" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;header&quot;&gt;</span></span>
<span id="cb246-152"><a href="#cb246-152" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h1&gt;Dashboard&lt;/h1&gt;</span></span>
<span id="cb246-153"><a href="#cb246-153" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button @click=&quot;</span><span class="sc">${</span>() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">refreshData</span>()<span class="sc">}</span><span class="vs">&quot;&gt;Refresh&lt;/button&gt;</span></span>
<span id="cb246-154"><a href="#cb246-154" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb246-155"><a href="#cb246-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-156"><a href="#cb246-156" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb246-157"><a href="#cb246-157" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;loading&quot;&gt;Loading dashboard...&lt;/div&gt;</span></span>
<span id="cb246-158"><a href="#cb246-158" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb246-159"><a href="#cb246-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-160"><a href="#cb246-160" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb246-161"><a href="#cb246-161" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;error&quot;&gt;Error: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb246-162"><a href="#cb246-162" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb246-163"><a href="#cb246-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-164"><a href="#cb246-164" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb246-165"><a href="#cb246-165" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;stats&quot;&gt;</span></span>
<span id="cb246-166"><a href="#cb246-166" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;stat-card&quot;&gt;</span></span>
<span id="cb246-167"><a href="#cb246-167" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-value&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">totalUsers</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb246-168"><a href="#cb246-168" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-label&quot;&gt;Total Users&lt;/div&gt;</span></span>
<span id="cb246-169"><a href="#cb246-169" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb246-170"><a href="#cb246-170" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;stat-card&quot;&gt;</span></span>
<span id="cb246-171"><a href="#cb246-171" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-value&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">activeUsers</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb246-172"><a href="#cb246-172" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-label&quot;&gt;Active Users&lt;/div&gt;</span></span>
<span id="cb246-173"><a href="#cb246-173" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb246-174"><a href="#cb246-174" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;stat-card&quot;&gt;</span></span>
<span id="cb246-175"><a href="#cb246-175" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-value&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">revenue</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb246-176"><a href="#cb246-176" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-label&quot;&gt;Revenue&lt;/div&gt;</span></span>
<span id="cb246-177"><a href="#cb246-177" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb246-178"><a href="#cb246-178" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;stat-card&quot;&gt;</span></span>
<span id="cb246-179"><a href="#cb246-179" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-value&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">conversionRate</span><span class="sc">}</span><span class="vs">%&lt;/div&gt;</span></span>
<span id="cb246-180"><a href="#cb246-180" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;stat-label&quot;&gt;Conversion Rate&lt;/div&gt;</span></span>
<span id="cb246-181"><a href="#cb246-181" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb246-182"><a href="#cb246-182" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb246-183"><a href="#cb246-183" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb246-184"><a href="#cb246-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-185"><a href="#cb246-185" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">activity</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb246-186"><a href="#cb246-186" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;activity&quot;&gt;</span></span>
<span id="cb246-187"><a href="#cb246-187" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;activity-header&quot;&gt;Recent Activity&lt;/div&gt;</span></span>
<span id="cb246-188"><a href="#cb246-188" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">activity</span><span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb246-189"><a href="#cb246-189" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;activity-item&quot;&gt;</span></span>
<span id="cb246-190"><a href="#cb246-190" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;strong&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">user</span><span class="sc">}</span><span class="vs">&lt;/strong&gt; </span><span class="sc">${</span>item<span class="op">.</span><span class="at">action</span><span class="sc">}</span></span>
<span id="cb246-191"><a href="#cb246-191" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;span style=&quot;color: #999; font-size: 14px;&quot;&gt;</span></span>
<span id="cb246-192"><a href="#cb246-192" aria-hidden="true" tabindex="-1"></a><span class="vs">                </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">formatTime</span>(item<span class="op">.</span><span class="at">timestamp</span>)<span class="sc">}</span></span>
<span id="cb246-193"><a href="#cb246-193" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/span&gt;</span></span>
<span id="cb246-194"><a href="#cb246-194" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb246-195"><a href="#cb246-195" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb246-196"><a href="#cb246-196" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb246-197"><a href="#cb246-197" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb246-198"><a href="#cb246-198" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb246-199"><a href="#cb246-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-200"><a href="#cb246-200" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach event listeners</span></span>
<span id="cb246-201"><a href="#cb246-201" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> refreshBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">;</span></span>
<span id="cb246-202"><a href="#cb246-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (refreshBtn) {</span>
<span id="cb246-203"><a href="#cb246-203" aria-hidden="true" tabindex="-1"></a>      refreshBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">refreshData</span>())<span class="op">;</span></span>
<span id="cb246-204"><a href="#cb246-204" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb246-205"><a href="#cb246-205" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-206"><a href="#cb246-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-207"><a href="#cb246-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatTime</span>(timestamp) {</span>
<span id="cb246-208"><a href="#cb246-208" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(timestamp)<span class="op">;</span></span>
<span id="cb246-209"><a href="#cb246-209" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> now <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">;</span></span>
<span id="cb246-210"><a href="#cb246-210" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> diff <span class="op">=</span> now <span class="op">-</span> date<span class="op">;</span></span>
<span id="cb246-211"><a href="#cb246-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-212"><a href="#cb246-212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&lt;</span> <span class="dv">60000</span>) <span class="cf">return</span> <span class="st">&#39;just now&#39;</span><span class="op">;</span></span>
<span id="cb246-213"><a href="#cb246-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&lt;</span> <span class="dv">3600000</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(diff <span class="op">/</span> <span class="dv">60000</span>)<span class="sc">}</span><span class="vs">m ago`</span><span class="op">;</span></span>
<span id="cb246-214"><a href="#cb246-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&lt;</span> <span class="dv">86400000</span>) <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(diff <span class="op">/</span> <span class="dv">3600000</span>)<span class="sc">}</span><span class="vs">h ago`</span><span class="op">;</span></span>
<span id="cb246-215"><a href="#cb246-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> date<span class="op">.</span><span class="fu">toLocaleDateString</span>()<span class="op">;</span></span>
<span id="cb246-216"><a href="#cb246-216" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb246-217"><a href="#cb246-217" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-218"><a href="#cb246-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-219"><a href="#cb246-219" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;app-dashboard&#39;</span><span class="op">,</span> Dashboard)<span class="op">;</span></span></code></pre></div>
<p>This dashboard demonstrates:</p>
<ul>
<li><strong>Parallel data loading</strong> with
<code>Promise.all</code></li>
<li><strong>Caching</strong> for stats that don’t change often</li>
<li><strong>Real-time updates</strong> via PAN bus</li>
<li><strong>Loading and error states</strong></li>
<li><strong>Manual refresh</strong> capability</li>
<li><strong>Relative time formatting</strong></li>
</ul>
<h2 data-number="11.11" id="error-handling-patterns"><span
class="header-section-number">11.11</span> Error Handling Patterns</h2>
<h3 data-number="11.11.1" id="circuit-breaker-pattern"><span
class="header-section-number">11.11.1</span> Circuit Breaker
Pattern</h3>
<p>Prevent cascading failures by stopping requests to failing
services:</p>
<div class="sourceCode" id="cb247"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CircuitBreaker {</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(threshold <span class="op">=</span> <span class="dv">5</span><span class="op">,</span> timeout <span class="op">=</span> <span class="dv">60000</span>) {</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">failureCount</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">threshold</span> <span class="op">=</span> threshold<span class="op">;</span></span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">timeout</span> <span class="op">=</span> timeout<span class="op">;</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="st">&#39;CLOSED&#39;</span><span class="op">;</span> <span class="co">// CLOSED, OPEN, HALF_OPEN</span></span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">nextAttempt</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">execute</span>(fn) {</span>
<span id="cb247-11"><a href="#cb247-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">===</span> <span class="st">&#39;OPEN&#39;</span>) {</span>
<span id="cb247-12"><a href="#cb247-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">nextAttempt</span>) {</span>
<span id="cb247-13"><a href="#cb247-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Circuit breaker is OPEN&#39;</span>)<span class="op">;</span></span>
<span id="cb247-14"><a href="#cb247-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb247-15"><a href="#cb247-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="st">&#39;HALF_OPEN&#39;</span><span class="op">;</span></span>
<span id="cb247-16"><a href="#cb247-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb247-17"><a href="#cb247-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-18"><a href="#cb247-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb247-19"><a href="#cb247-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="fu">fn</span>()<span class="op">;</span></span>
<span id="cb247-20"><a href="#cb247-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">onSuccess</span>()<span class="op">;</span></span>
<span id="cb247-21"><a href="#cb247-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb247-22"><a href="#cb247-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb247-23"><a href="#cb247-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">onFailure</span>()<span class="op">;</span></span>
<span id="cb247-24"><a href="#cb247-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb247-25"><a href="#cb247-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb247-26"><a href="#cb247-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-27"><a href="#cb247-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-28"><a href="#cb247-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onSuccess</span>() {</span>
<span id="cb247-29"><a href="#cb247-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">failureCount</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb247-30"><a href="#cb247-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="st">&#39;CLOSED&#39;</span><span class="op">;</span></span>
<span id="cb247-31"><a href="#cb247-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-32"><a href="#cb247-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-33"><a href="#cb247-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">onFailure</span>() {</span>
<span id="cb247-34"><a href="#cb247-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">failureCount</span><span class="op">++;</span></span>
<span id="cb247-35"><a href="#cb247-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">failureCount</span> <span class="op">&gt;=</span> <span class="kw">this</span><span class="op">.</span><span class="at">threshold</span>) {</span>
<span id="cb247-36"><a href="#cb247-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="st">&#39;OPEN&#39;</span><span class="op">;</span></span>
<span id="cb247-37"><a href="#cb247-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">nextAttempt</span> <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">timeout</span><span class="op">;</span></span>
<span id="cb247-38"><a href="#cb247-38" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;circuit-breaker.opened&#39;</span><span class="op">,</span> {</span>
<span id="cb247-39"><a href="#cb247-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">breaker</span><span class="op">:</span> <span class="kw">this</span></span>
<span id="cb247-40"><a href="#cb247-40" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb247-41"><a href="#cb247-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb247-42"><a href="#cb247-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb247-43"><a href="#cb247-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb247-44"><a href="#cb247-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-45"><a href="#cb247-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb247-46"><a href="#cb247-46" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> userApiBreaker <span class="op">=</span> <span class="kw">new</span> <span class="fu">CircuitBreaker</span>()<span class="op">;</span></span>
<span id="cb247-47"><a href="#cb247-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-48"><a href="#cb247-48" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">fetchUsers</span>() {</span>
<span id="cb247-49"><a href="#cb247-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> userApiBreaker<span class="op">.</span><span class="fu">execute</span>(() <span class="kw">=&gt;</span> api<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/users&#39;</span>))<span class="op">;</span></span>
<span id="cb247-50"><a href="#cb247-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.11.2" id="fallback-strategies"><span
class="header-section-number">11.11.2</span> Fallback Strategies</h3>
<p>Provide graceful degradation when APIs fail:</p>
<div class="sourceCode" id="cb248"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FallbackApiClient <span class="kw">extends</span> ApiClient {</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getWithFallback</span>(endpoint<span class="op">,</span> fallbackData) {</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`API call failed, using fallback for </span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;api.fallback&#39;</span><span class="op">,</span> { endpoint<span class="op">,</span> error })<span class="op">;</span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> fallbackData<span class="op">;</span></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getWithCacheFallback</span>(endpoint) {</span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">get</span>(endpoint)<span class="op">;</span></span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="vs">`fallback:</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data))<span class="op">;</span></span>
<span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cached <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="vs">`fallback:</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cached) {</span>
<span id="cb248-20"><a href="#cb248-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(cached)<span class="op">;</span></span>
<span id="cb248-21"><a href="#cb248-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb248-22"><a href="#cb248-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb248-23"><a href="#cb248-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb248-24"><a href="#cb248-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb248-25"><a href="#cb248-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.12" id="optimistic-updates"><span
class="header-section-number">11.12</span> Optimistic Updates</h2>
<p>Update UI immediately before the server responds:</p>
<div class="sourceCode" id="cb249"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">addTodo</span>(text) {</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> optimisticTodo <span class="op">=</span> {</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="vs">`temp-</span><span class="sc">${</span><span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>      text<span class="op">,</span></span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">completed</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pending</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add to UI immediately</span></span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">push</span>(optimisticTodo)<span class="op">;</span></span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Send to server</span></span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> savedTodo <span class="op">=</span> <span class="cf">await</span> api<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/todos&#39;</span><span class="op">,</span> { text })<span class="op">;</span></span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-18"><a href="#cb249-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace optimistic todo with server response</span></span>
<span id="cb249-19"><a href="#cb249-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> index <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">findIndex</span>(t <span class="kw">=&gt;</span> t<span class="op">.</span><span class="at">id</span> <span class="op">===</span> optimisticTodo<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb249-20"><a href="#cb249-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span>[index] <span class="op">=</span> savedTodo<span class="op">;</span></span>
<span id="cb249-21"><a href="#cb249-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb249-22"><a href="#cb249-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-23"><a href="#cb249-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb249-24"><a href="#cb249-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Revert on failure</span></span>
<span id="cb249-25"><a href="#cb249-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">todos</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">todos</span><span class="op">.</span><span class="fu">filter</span>(t <span class="kw">=&gt;</span> t<span class="op">.</span><span class="at">id</span> <span class="op">!==</span> optimisticTodo<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb249-26"><a href="#cb249-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb249-27"><a href="#cb249-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-28"><a href="#cb249-28" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.error&#39;</span><span class="op">,</span> {</span>
<span id="cb249-29"><a href="#cb249-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Failed to add todo&#39;</span></span>
<span id="cb249-30"><a href="#cb249-30" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb249-31"><a href="#cb249-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb249-32"><a href="#cb249-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb249-33"><a href="#cb249-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.13" id="infinite-scroll-pagination"><span
class="header-section-number">11.13</span> Infinite Scroll /
Pagination</h2>
<p>Load more data as the user scrolls:</p>
<div class="sourceCode" id="cb250"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InfiniteList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadMore</span>()<span class="op">;</span></span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-14"><a href="#cb250-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intersection Observer for infinite scroll</span></span>
<span id="cb250-15"><a href="#cb250-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sentinel <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.sentinel&#39;</span>)<span class="op">;</span></span>
<span id="cb250-16"><a href="#cb250-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>(entries <span class="kw">=&gt;</span> {</span>
<span id="cb250-17"><a href="#cb250-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (entries[<span class="dv">0</span>]<span class="op">.</span><span class="at">isIntersecting</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span>) {</span>
<span id="cb250-18"><a href="#cb250-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">loadMore</span>()<span class="op">;</span></span>
<span id="cb250-19"><a href="#cb250-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb250-20"><a href="#cb250-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb250-21"><a href="#cb250-21" aria-hidden="true" tabindex="-1"></a>    observer<span class="op">.</span><span class="fu">observe</span>(sentinel)<span class="op">;</span></span>
<span id="cb250-22"><a href="#cb250-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-23"><a href="#cb250-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-24"><a href="#cb250-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadMore</span>() {</span>
<span id="cb250-25"><a href="#cb250-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">||</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb250-26"><a href="#cb250-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-27"><a href="#cb250-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb250-28"><a href="#cb250-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb250-29"><a href="#cb250-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-30"><a href="#cb250-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb250-31"><a href="#cb250-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> api<span class="op">.</span><span class="fu">get</span>(<span class="vs">`/items?page=</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">page</span><span class="sc">}</span><span class="vs">&amp;limit=20`</span>)<span class="op">;</span></span>
<span id="cb250-32"><a href="#cb250-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-33"><a href="#cb250-33" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">push</span>(<span class="op">...</span>data<span class="op">.</span><span class="at">items</span>)<span class="op">;</span></span>
<span id="cb250-34"><a href="#cb250-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">=</span> data<span class="op">.</span><span class="at">hasMore</span><span class="op">;</span></span>
<span id="cb250-35"><a href="#cb250-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">page</span><span class="op">++;</span></span>
<span id="cb250-36"><a href="#cb250-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-37"><a href="#cb250-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb250-38"><a href="#cb250-38" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load more items:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb250-39"><a href="#cb250-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">finally</span> {</span>
<span id="cb250-40"><a href="#cb250-40" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb250-41"><a href="#cb250-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb250-42"><a href="#cb250-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb250-43"><a href="#cb250-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-44"><a href="#cb250-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-45"><a href="#cb250-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb250-46"><a href="#cb250-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb250-47"><a href="#cb250-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;items&quot;&gt;</span></span>
<span id="cb250-48"><a href="#cb250-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb250-49"><a href="#cb250-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;item&quot;&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb250-50"><a href="#cb250-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb250-51"><a href="#cb250-51" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb250-52"><a href="#cb250-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-53"><a href="#cb250-53" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;&lt;div class=&quot;loading&quot;&gt;Loading...&lt;/div&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb250-54"><a href="#cb250-54" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">?</span> <span class="st">&#39;&lt;div class=&quot;sentinel&quot;&gt;&lt;/div&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb250-55"><a href="#cb250-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">hasMore</span> <span class="op">?</span> <span class="st">&#39;&lt;div class=&quot;end&quot;&gt;No more items&lt;/div&gt;&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb250-56"><a href="#cb250-56" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb250-57"><a href="#cb250-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-58"><a href="#cb250-58" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="11.14" id="troubleshooting"><span
class="header-section-number">11.14</span> Troubleshooting</h2>
<h3 data-number="11.14.1" id="problem-cors-errors"><span
class="header-section-number">11.14.1</span> Problem: CORS Errors</h3>
<p><strong>Symptom</strong>:
<code>Access to fetch at 'https://api.example.com' from origin 'http://localhost:3000' has been blocked by CORS policy</code></p>
<p><strong>Solution</strong>: Configure your server to send CORS
headers:</p>
<div class="sourceCode" id="cb251"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Express.js example</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Origin&#39;</span><span class="op">,</span> <span class="st">&#39;http://localhost:3000&#39;</span>)<span class="op">;</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Methods&#39;</span><span class="op">,</span> <span class="st">&#39;GET, POST, PUT, DELETE&#39;</span>)<span class="op">;</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Headers&#39;</span><span class="op">,</span> <span class="st">&#39;Content-Type, Authorization&#39;</span>)<span class="op">;</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Credentials&#39;</span><span class="op">,</span> <span class="st">&#39;true&#39;</span>)<span class="op">;</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Or use a proxy in development:</p>
<div class="sourceCode" id="cb252"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co">// vite.config.js</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">server</span><span class="op">:</span> {</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">proxy</span><span class="op">:</span> {</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;/api&#39;</span><span class="op">:</span> {</span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">target</span><span class="op">:</span> <span class="st">&#39;https://api.example.com&#39;</span><span class="op">,</span></span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">changeOrigin</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">rewrite</span><span class="op">:</span> (path) <span class="kw">=&gt;</span> path<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/</span><span class="sc">^\/</span><span class="ss">api/</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 data-number="11.14.2" id="problem-requests-timing-out"><span
class="header-section-number">11.14.2</span> Problem: Requests Timing
Out</h3>
<p><strong>Symptom</strong>: Fetch hangs indefinitely or takes too
long</p>
<p><strong>Solution</strong>: Add timeout to fetch requests:</p>
<div class="sourceCode" id="cb253"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">fetchWithTimeout</span>(url<span class="op">,</span> options <span class="op">=</span> {}<span class="op">,</span> timeout <span class="op">=</span> <span class="dv">5000</span>) {</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> controller <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> id <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> controller<span class="op">.</span><span class="fu">abort</span>()<span class="op">,</span> timeout)<span class="op">;</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(url<span class="op">,</span> {</span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>options<span class="op">,</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">signal</span><span class="op">:</span> controller<span class="op">.</span><span class="at">signal</span></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(id)<span class="op">;</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">;</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(id)<span class="op">;</span></span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">===</span> <span class="st">&#39;AbortError&#39;</span>) {</span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Request timeout&#39;</span>)<span class="op">;</span></span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb253-18"><a href="#cb253-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb253-19"><a href="#cb253-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.14.3"
id="problem-memory-leaks-from-uncancelled-requests"><span
class="header-section-number">11.14.3</span> Problem: Memory Leaks from
Uncancelled Requests</h3>
<p><strong>Symptom</strong>: Component removed but requests still
updating state</p>
<p><strong>Solution</strong>: Cancel requests when component
disconnects:</p>
<div class="sourceCode" id="cb254"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> {</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">signal</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="at">signal</span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(users)<span class="op">;</span></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;AbortError&#39;</span>) {</span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="11.14.4" id="problem-stale-data-after-navigation"><span
class="header-section-number">11.14.4</span> Problem: Stale Data After
Navigation</h3>
<p><strong>Symptom</strong>: Old data briefly appears before loading new
data</p>
<p><strong>Solution</strong>: Clear cache or reset state on
navigation:</p>
<div class="sourceCode" id="cb255"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;navigation.changed&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Clear API cache</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>  api<span class="op">.</span><span class="fu">clearCache</span>()<span class="op">;</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Or invalidate specific endpoints</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>  api<span class="op">.</span><span class="fu">invalidate</span>(<span class="st">&#39;/users&#39;</span>)<span class="op">;</span></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="11.15" id="best-practices-7"><span
class="header-section-number">11.15</span> Best Practices</h2>
<ol type="1">
<li><strong>Centralize API logic</strong> - Use a single API client, not
scattered fetch calls</li>
<li><strong>Handle loading states</strong> - Always show feedback during
async operations</li>
<li><strong>Implement caching</strong> - Reduce server load and improve
perceived performance</li>
<li><strong>Use optimistic updates</strong> - Make UI feel instant for
common operations</li>
<li><strong>Fail gracefully</strong> - Provide fallbacks, don’t just
show error messages</li>
<li><strong>Cancel requests</strong> - Clean up when components
unmount</li>
<li><strong>Use the PAN bus</strong> - Decouple components from API
implementation details</li>
<li><strong>Implement retries</strong> - Networks are unreliable, retry
with backoff</li>
<li><strong>Monitor API health</strong> - Use circuit breakers for
failing services</li>
<li><strong>Test with mocks</strong> - Don’t depend on live APIs for
tests</li>
</ol>
<h2 data-number="11.16" id="exercises-1"><span
class="header-section-number">11.16</span> Exercises</h2>
<h3 data-number="11.16.1" id="exercise-1-weather-dashboard"><span
class="header-section-number">11.16.1</span> Exercise 1: Weather
Dashboard</h3>
<p>Build a weather dashboard that:</p>
<ul>
<li>Fetches current weather for a city</li>
<li>Displays 5-day forecast</li>
<li>Caches results for 30 minutes</li>
<li>Updates automatically when city changes</li>
<li>Shows loading spinner during fetch</li>
<li>Handles API errors gracefully</li>
</ul>
<p><strong>Bonus</strong>: Add geolocation to auto-detect user’s
city.</p>
<h3 data-number="11.16.2" id="exercise-2-infinite-scroll-blog"><span
class="header-section-number">11.16.2</span> Exercise 2: Infinite Scroll
Blog</h3>
<p>Create a blog list with infinite scroll that:</p>
<ul>
<li>Loads 10 posts initially</li>
<li>Loads 10 more as user scrolls down</li>
<li>Shows loading indicator at bottom</li>
<li>Handles “no more posts” state</li>
<li>Implements pull-to-refresh on mobile</li>
</ul>
<p><strong>Bonus</strong>: Add search that filters posts while
maintaining infinite scroll.</p>
<h3 data-number="11.16.3" id="exercise-3-real-time-chat"><span
class="header-section-number">11.16.3</span> Exercise 3: Real-Time
Chat</h3>
<p>Build a simple chat application that:</p>
<ul>
<li>Uses WebSockets for real-time messages</li>
<li>Shows typing indicators</li>
<li>Displays online/offline status</li>
<li>Reconnects automatically when connection drops</li>
<li>Falls back to polling if WebSockets unavailable</li>
</ul>
<p><strong>Bonus</strong>: Add message read receipts and “User is
typing…” indicators.</p>
<h3 data-number="11.16.4" id="exercise-4-optimistic-todo-list"><span
class="header-section-number">11.16.4</span> Exercise 4: Optimistic Todo
List</h3>
<p>Create a todo list with optimistic updates:</p>
<ul>
<li>Add todos instantly (before server confirms)</li>
<li>Revert if server rejects</li>
<li>Show pending state with different styling</li>
<li>Handle offline mode (queue operations)</li>
<li>Sync when connection restored</li>
</ul>
<p><strong>Bonus</strong>: Use IndexedDB for offline storage and sync
queue.</p>
<hr />
<h2 data-number="11.17" id="summary-10"><span
class="header-section-number">11.17</span> Summary</h2>
<p>Data fetching is the bridge between your frontend and the world. LARC
embraces native browser APIs (fetch, WebSocket, EventSource) while
providing patterns that make common tasks simple:</p>
<ul>
<li><strong>Use fetch</strong> for HTTP requests, enhance with retries
and timeouts</li>
<li><strong>Build an API client</strong> to centralize authentication
and error handling</li>
<li><strong>Integrate with PAN bus</strong> to decouple components from
API details</li>
<li><strong>Implement caching</strong> to improve performance and reduce
server load</li>
<li><strong>Handle errors gracefully</strong> with circuit breakers and
fallbacks</li>
<li><strong>Use optimistic updates</strong> to make UI feel instant</li>
<li><strong>Choose the right tool</strong>: REST for standard APIs,
GraphQL for flexible queries, WebSockets for bidirectional real-time,
SSE for server push</li>
</ul>
<p>The web platform provides excellent data fetching capabilities. LARC
helps you use them effectively.</p>
<hr />
<h2 data-number="11.18" id="further-reading-10"><span
class="header-section-number">11.18</span> Further Reading</h2>
<p><strong>For complete API integration reference:</strong> -
<em>Building with LARC</em> Chapter 7: Data Fetching and APIs - All
patterns and strategies - <em>Building with LARC</em> Chapter 20:
Integration Components - pan-data-connector, pan-websocket, pan-sse API
reference - <em>Building with LARC</em> Appendix E: Recipes and Patterns
- API integration recipes</p>
<div class="pagebreak">

</div>
<h1 data-number="12" id="authentication-and-security"><span
class="header-section-number">12</span> Authentication and Security</h1>
<p>Authentication is the bouncer at your application’s door. Get it
wrong, and either legitimate users can’t get in, or everyone can.
Security isn’t a feature you add later—it’s a mindset that shapes every
decision from the start.</p>
<h2 data-number="12.1"
id="understanding-authentication-vs-authorization"><span
class="header-section-number">12.1</span> Understanding Authentication
vs Authorization</h2>
<p>These terms often get conflated, but they’re distinct:</p>
<p><strong>Authentication</strong> answers: “Who are you?” It’s
verifying identity—matching a username and password, validating a token,
confirming you are who you claim to be.</p>
<p><strong>Authorization</strong> answers: “What can you do?” Once we
know who you are, authorization determines your permissions—can you view
this page, edit this record, delete this user?</p>
<p>LARC applications typically handle authentication with JWT tokens and
authorization with role-based or permission-based access control.</p>
<h2 data-number="12.2" id="jwt-token-management"><span
class="header-section-number">12.2</span> JWT Token Management</h2>
<p>JSON Web Tokens (JWTs) are the standard for stateless authentication.
A JWT contains encoded claims about the user, signed by the server:</p>
<div class="sourceCode" id="cb256"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co">// auth-service.js</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthService {</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">tokenKey</span> <span class="op">=</span> <span class="st">&#39;auth_token&#39;</span><span class="op">;</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">refreshKey</span> <span class="op">=</span> <span class="st">&#39;refresh_token&#39;</span><span class="op">;</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">login</span>(email<span class="op">,</span> password) {</span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/login&#39;</span><span class="op">,</span> {</span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ email<span class="op">,</span> password })</span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb256-17"><a href="#cb256-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(error<span class="op">.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Login failed&#39;</span>)<span class="op">;</span></span>
<span id="cb256-18"><a href="#cb256-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-19"><a href="#cb256-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-20"><a href="#cb256-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { accessToken<span class="op">,</span> refreshToken<span class="op">,</span> user } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb256-21"><a href="#cb256-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-22"><a href="#cb256-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setTokens</span>(accessToken<span class="op">,</span> refreshToken)<span class="op">;</span></span>
<span id="cb256-23"><a href="#cb256-23" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.login&#39;</span><span class="op">,</span> { user }<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb256-24"><a href="#cb256-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-25"><a href="#cb256-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb256-26"><a href="#cb256-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-27"><a href="#cb256-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-28"><a href="#cb256-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setTokens</span>(accessToken<span class="op">,</span> refreshToken) {</span>
<span id="cb256-29"><a href="#cb256-29" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">tokenKey</span><span class="op">,</span> accessToken)<span class="op">;</span></span>
<span id="cb256-30"><a href="#cb256-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (refreshToken) {</span>
<span id="cb256-31"><a href="#cb256-31" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">refreshKey</span><span class="op">,</span> refreshToken)<span class="op">;</span></span>
<span id="cb256-32"><a href="#cb256-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-33"><a href="#cb256-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-34"><a href="#cb256-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-35"><a href="#cb256-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getToken</span>() {</span>
<span id="cb256-36"><a href="#cb256-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">tokenKey</span>)<span class="op">;</span></span>
<span id="cb256-37"><a href="#cb256-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-38"><a href="#cb256-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-39"><a href="#cb256-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isAuthenticated</span>() {</span>
<span id="cb256-40"><a href="#cb256-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb256-41"><a href="#cb256-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>token) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb256-42"><a href="#cb256-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-43"><a href="#cb256-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb256-44"><a href="#cb256-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> payload <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">decodeToken</span>(token)<span class="op">;</span></span>
<span id="cb256-45"><a href="#cb256-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> payload<span class="op">.</span><span class="at">exp</span> <span class="op">*</span> <span class="dv">1000</span> <span class="op">&gt;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb256-46"><a href="#cb256-46" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> {</span>
<span id="cb256-47"><a href="#cb256-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb256-48"><a href="#cb256-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-49"><a href="#cb256-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-50"><a href="#cb256-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-51"><a href="#cb256-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decodeToken</span>(token) {</span>
<span id="cb256-52"><a href="#cb256-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> base64Url <span class="op">=</span> token<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb256-53"><a href="#cb256-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> base64 <span class="op">=</span> base64Url<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/-/g</span><span class="op">,</span> <span class="st">&#39;+&#39;</span>)<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/_/g</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="op">;</span></span>
<span id="cb256-54"><a href="#cb256-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="fu">atob</span>(base64))<span class="op">;</span></span>
<span id="cb256-55"><a href="#cb256-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-56"><a href="#cb256-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-57"><a href="#cb256-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">refresh</span>() {</span>
<span id="cb256-58"><a href="#cb256-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> refreshToken <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">refreshKey</span>)<span class="op">;</span></span>
<span id="cb256-59"><a href="#cb256-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>refreshToken) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;No refresh token&#39;</span>)<span class="op">;</span></span>
<span id="cb256-60"><a href="#cb256-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-61"><a href="#cb256-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/refresh&#39;</span><span class="op">,</span> {</span>
<span id="cb256-62"><a href="#cb256-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb256-63"><a href="#cb256-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb256-64"><a href="#cb256-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ refreshToken })</span>
<span id="cb256-65"><a href="#cb256-65" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb256-66"><a href="#cb256-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-67"><a href="#cb256-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb256-68"><a href="#cb256-68" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb256-69"><a href="#cb256-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Token refresh failed&#39;</span>)<span class="op">;</span></span>
<span id="cb256-70"><a href="#cb256-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-71"><a href="#cb256-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-72"><a href="#cb256-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { accessToken } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb256-73"><a href="#cb256-73" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">tokenKey</span><span class="op">,</span> accessToken)<span class="op">;</span></span>
<span id="cb256-74"><a href="#cb256-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> accessToken<span class="op">;</span></span>
<span id="cb256-75"><a href="#cb256-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-76"><a href="#cb256-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-77"><a href="#cb256-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logout</span>() {</span>
<span id="cb256-78"><a href="#cb256-78" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">tokenKey</span>)<span class="op">;</span></span>
<span id="cb256-79"><a href="#cb256-79" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="kw">this</span><span class="op">.</span><span class="at">refreshKey</span>)<span class="op">;</span></span>
<span id="cb256-80"><a href="#cb256-80" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.logout&#39;</span><span class="op">,</span> {}<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb256-81"><a href="#cb256-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-82"><a href="#cb256-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-83"><a href="#cb256-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCurrentUser</span>() {</span>
<span id="cb256-84"><a href="#cb256-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb256-85"><a href="#cb256-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>token) <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb256-86"><a href="#cb256-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-87"><a href="#cb256-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb256-88"><a href="#cb256-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">decodeToken</span>(token)<span class="op">;</span></span>
<span id="cb256-89"><a href="#cb256-89" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> {</span>
<span id="cb256-90"><a href="#cb256-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb256-91"><a href="#cb256-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb256-92"><a href="#cb256-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb256-93"><a href="#cb256-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb256-94"><a href="#cb256-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-95"><a href="#cb256-95" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> auth <span class="op">=</span> <span class="kw">new</span> <span class="fu">AuthService</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="12.3" id="automatic-token-refresh"><span
class="header-section-number">12.3</span> Automatic Token Refresh</h2>
<p>Tokens expire. Good applications refresh them transparently:</p>
<div class="sourceCode" id="cb257"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co">// api-client.js with token refresh</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AuthenticatedApiClient {</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// First attempt</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">doFetch</span>(endpoint<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If 401, try refreshing token</span></span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (error<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">401</span>) {</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> auth<span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Retry with new token</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">doFetch</span>(endpoint<span class="op">,</span> options)<span class="op">;</span></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (refreshError) {</span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>          <span class="co">// Refresh failed, user must log in again</span></span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>          auth<span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb257-22"><a href="#cb257-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb257-23"><a href="#cb257-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-24"><a href="#cb257-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">doFetch</span>(endpoint<span class="op">,</span> options) {</span>
<span id="cb257-25"><a href="#cb257-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> auth<span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb257-26"><a href="#cb257-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headers <span class="op">=</span> {</span>
<span id="cb257-27"><a href="#cb257-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb257-28"><a href="#cb257-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>options<span class="op">.</span><span class="at">headers</span></span>
<span id="cb257-29"><a href="#cb257-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb257-30"><a href="#cb257-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-31"><a href="#cb257-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (token) {</span>
<span id="cb257-32"><a href="#cb257-32" aria-hidden="true" tabindex="-1"></a>      headers[<span class="st">&#39;Authorization&#39;</span>] <span class="op">=</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb257-33"><a href="#cb257-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb257-34"><a href="#cb257-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-35"><a href="#cb257-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> { <span class="op">...</span>options<span class="op">,</span> headers })<span class="op">;</span></span>
<span id="cb257-36"><a href="#cb257-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-37"><a href="#cb257-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb257-38"><a href="#cb257-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> { <span class="dt">status</span><span class="op">:</span> response<span class="op">.</span><span class="at">status</span><span class="op">,</span> <span class="dt">message</span><span class="op">:</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>() }<span class="op">;</span></span>
<span id="cb257-39"><a href="#cb257-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb257-40"><a href="#cb257-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-41"><a href="#cb257-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb257-42"><a href="#cb257-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb257-43"><a href="#cb257-43" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.4" id="protected-routes"><span
class="header-section-number">12.4</span> Protected Routes</h2>
<p>Some pages should only be accessible to authenticated users. Here’s a
route guard pattern:</p>
<div class="sourceCode" id="cb258"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co">// route-guard.js</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RouteGuard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">checkAuth</span>()<span class="op">;</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;auth.logout&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">checkAuth</span>())<span class="op">;</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkAuth</span>() {</span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>auth<span class="op">.</span><span class="fu">isAuthenticated</span>()) {</span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Store intended destination</span></span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a>      sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;returnUrl&#39;</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Redirect to login</span></span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb258-14"><a href="#cb258-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb258-15"><a href="#cb258-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb258-16"><a href="#cb258-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb258-17"><a href="#cb258-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-18"><a href="#cb258-18" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;route-guard&#39;</span><span class="op">,</span> RouteGuard)<span class="op">;</span></span></code></pre></div>
<p>Use it to wrap protected content:</p>
<div class="sourceCode" id="cb259"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">route-guard</span><span class="dt">&gt;</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">dashboard-page</span><span class="dt">&gt;&lt;/</span><span class="kw">dashboard-page</span><span class="dt">&gt;</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">route-guard</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="12.5" id="role-based-access-control"><span
class="header-section-number">12.5</span> Role-Based Access Control</h2>
<p>Different users have different permissions. A simple RBAC
implementation:</p>
<div class="sourceCode" id="cb260"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="co">// rbac.js</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RBAC {</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">permissions</span> <span class="op">=</span> {</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">admin</span><span class="op">:</span> [<span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="st">&#39;write&#39;</span><span class="op">,</span> <span class="st">&#39;delete&#39;</span><span class="op">,</span> <span class="st">&#39;manage-users&#39;</span>]<span class="op">,</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">editor</span><span class="op">:</span> [<span class="st">&#39;read&#39;</span><span class="op">,</span> <span class="st">&#39;write&#39;</span>]<span class="op">,</span></span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">viewer</span><span class="op">:</span> [<span class="st">&#39;read&#39;</span>]</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">can</span>(user<span class="op">,</span> action) {</span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>user<span class="op">?.</span><span class="at">role</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> allowed <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">permissions</span>[user<span class="op">.</span><span class="at">role</span>] <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> allowed<span class="op">.</span><span class="fu">includes</span>(action)<span class="op">;</span></span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb260-17"><a href="#cb260-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-18"><a href="#cb260-18" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> rbac <span class="op">=</span> <span class="kw">new</span> <span class="fu">RBAC</span>()<span class="op">;</span></span></code></pre></div>
<p>Use it in components:</p>
<div class="sourceCode" id="cb261"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AdminPanel <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> auth<span class="op">.</span><span class="fu">getCurrentUser</span>()<span class="op">;</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>rbac<span class="op">.</span><span class="fu">can</span>(user<span class="op">,</span> <span class="st">&#39;manage-users&#39;</span>)) {</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;p&gt;Access denied&lt;/p&gt;&#39;</span><span class="op">;</span></span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb261-12"><a href="#cb261-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.6" id="security-best-practices"><span
class="header-section-number">12.6</span> Security Best Practices</h2>
<h3 data-number="12.6.1" id="sanitize-user-input"><span
class="header-section-number">12.6.1</span> Sanitize User Input</h3>
<p>Never trust user input. Always sanitize before rendering:</p>
<div class="sourceCode" id="cb262"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">escapeHtml</span>(text) {</span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> div <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> text<span class="op">;</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> div<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe rendering</span></span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;p&gt;</span><span class="sc">${</span><span class="fu">escapeHtml</span>(userInput)<span class="sc">}</span><span class="vs">&lt;/p&gt;`</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="12.6.2" id="use-https"><span
class="header-section-number">12.6.2</span> Use HTTPS</h3>
<p>Always serve your application over HTTPS. This protects tokens in
transit and enables secure cookies.</p>
<h3 data-number="12.6.3" id="secure-token-storage"><span
class="header-section-number">12.6.3</span> Secure Token Storage</h3>
<p>LocalStorage is convenient but accessible to JavaScript. For
high-security applications, consider httpOnly cookies:</p>
<div class="sourceCode" id="cb263"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Server sets cookie</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>res<span class="op">.</span><span class="fu">cookie</span>(<span class="st">&#39;token&#39;</span><span class="op">,</span> jwt<span class="op">,</span> {</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">httpOnly</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">secure</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sameSite</span><span class="op">:</span> <span class="st">&#39;strict&#39;</span></span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.6.4" id="content-security-policy"><span
class="header-section-number">12.6.4</span> Content Security Policy</h3>
<p>Set CSP headers to prevent XSS attacks:</p>
<div class="sourceCode" id="cb264"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> http-equiv</span><span class="op">=</span><span class="st">&quot;Content-Security-Policy&quot;</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="ot">      content</span><span class="op">=</span><span class="st">&quot;default-src &#39;self&#39;; script-src &#39;self&#39;&quot;</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="12.7" id="complete-loginsignup-flow"><span
class="header-section-number">12.7</span> Complete Login/Signup
Flow</h2>
<p>Let’s build a complete authentication system with login and signup
components that work together:</p>
<h3 data-number="12.7.1" id="login-component"><span
class="header-section-number">12.7.1</span> Login Component</h3>
<div class="sourceCode" id="cb265"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/login-form.js</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { auth } <span class="im">from</span> <span class="st">&#39;../services/auth.js&#39;</span><span class="op">;</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { pan } <span class="im">from</span> <span class="st">&#39;@larcjs/core&#39;</span><span class="op">;</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LoginForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">error</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-20"><a href="#cb265-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-21"><a href="#cb265-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(e) {</span>
<span id="cb265-22"><a href="#cb265-22" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb265-23"><a href="#cb265-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-24"><a href="#cb265-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb265-25"><a href="#cb265-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb265-26"><a href="#cb265-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb265-27"><a href="#cb265-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-28"><a href="#cb265-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb265-29"><a href="#cb265-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> auth<span class="op">.</span><span class="fu">login</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span>)<span class="op">;</span></span>
<span id="cb265-30"><a href="#cb265-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-31"><a href="#cb265-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Redirect to intended destination or dashboard</span></span>
<span id="cb265-32"><a href="#cb265-32" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> returnUrl <span class="op">=</span> sessionStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;returnUrl&#39;</span>) <span class="op">||</span> <span class="st">&#39;/dashboard&#39;</span><span class="op">;</span></span>
<span id="cb265-33"><a href="#cb265-33" aria-hidden="true" tabindex="-1"></a>      sessionStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="st">&#39;returnUrl&#39;</span>)<span class="op">;</span></span>
<span id="cb265-34"><a href="#cb265-34" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> returnUrl })<span class="op">;</span></span>
<span id="cb265-35"><a href="#cb265-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-36"><a href="#cb265-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb265-37"><a href="#cb265-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">=</span> error<span class="op">.</span><span class="at">message</span><span class="op">;</span></span>
<span id="cb265-38"><a href="#cb265-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb265-39"><a href="#cb265-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb265-40"><a href="#cb265-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb265-41"><a href="#cb265-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-42"><a href="#cb265-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-43"><a href="#cb265-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb265-44"><a href="#cb265-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb265-45"><a href="#cb265-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb265-46"><a href="#cb265-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb265-47"><a href="#cb265-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb265-48"><a href="#cb265-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 400px;</span></span>
<span id="cb265-49"><a href="#cb265-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 50px auto;</span></span>
<span id="cb265-50"><a href="#cb265-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-51"><a href="#cb265-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-52"><a href="#cb265-52" aria-hidden="true" tabindex="-1"></a><span class="vs">        form {</span></span>
<span id="cb265-53"><a href="#cb265-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb265-54"><a href="#cb265-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 30px;</span></span>
<span id="cb265-55"><a href="#cb265-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb265-56"><a href="#cb265-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 2px 10px rgba(0,0,0,0.1);</span></span>
<span id="cb265-57"><a href="#cb265-57" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-58"><a href="#cb265-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-59"><a href="#cb265-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        h2 {</span></span>
<span id="cb265-60"><a href="#cb265-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0 0 20px;</span></span>
<span id="cb265-61"><a href="#cb265-61" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #333;</span></span>
<span id="cb265-62"><a href="#cb265-62" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-63"><a href="#cb265-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-64"><a href="#cb265-64" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error {</span></span>
<span id="cb265-65"><a href="#cb265-65" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #fee;</span></span>
<span id="cb265-66"><a href="#cb265-66" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #c00;</span></span>
<span id="cb265-67"><a href="#cb265-67" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px;</span></span>
<span id="cb265-68"><a href="#cb265-68" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb265-69"><a href="#cb265-69" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 15px;</span></span>
<span id="cb265-70"><a href="#cb265-70" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-71"><a href="#cb265-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-72"><a href="#cb265-72" aria-hidden="true" tabindex="-1"></a><span class="vs">        .form-group {</span></span>
<span id="cb265-73"><a href="#cb265-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 15px;</span></span>
<span id="cb265-74"><a href="#cb265-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-75"><a href="#cb265-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-76"><a href="#cb265-76" aria-hidden="true" tabindex="-1"></a><span class="vs">        label {</span></span>
<span id="cb265-77"><a href="#cb265-77" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb265-78"><a href="#cb265-78" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 5px;</span></span>
<span id="cb265-79"><a href="#cb265-79" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb265-80"><a href="#cb265-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #555;</span></span>
<span id="cb265-81"><a href="#cb265-81" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-82"><a href="#cb265-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-83"><a href="#cb265-83" aria-hidden="true" tabindex="-1"></a><span class="vs">        input {</span></span>
<span id="cb265-84"><a href="#cb265-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb265-85"><a href="#cb265-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px;</span></span>
<span id="cb265-86"><a href="#cb265-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb265-87"><a href="#cb265-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb265-88"><a href="#cb265-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 14px;</span></span>
<span id="cb265-89"><a href="#cb265-89" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-90"><a href="#cb265-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-91"><a href="#cb265-91" aria-hidden="true" tabindex="-1"></a><span class="vs">        input:focus {</span></span>
<span id="cb265-92"><a href="#cb265-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          outline: none;</span></span>
<span id="cb265-93"><a href="#cb265-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-color: #667eea;</span></span>
<span id="cb265-94"><a href="#cb265-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-95"><a href="#cb265-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-96"><a href="#cb265-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb265-97"><a href="#cb265-97" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb265-98"><a href="#cb265-98" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 12px;</span></span>
<span id="cb265-99"><a href="#cb265-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #667eea;</span></span>
<span id="cb265-100"><a href="#cb265-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb265-101"><a href="#cb265-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb265-102"><a href="#cb265-102" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb265-103"><a href="#cb265-103" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 16px;</span></span>
<span id="cb265-104"><a href="#cb265-104" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb265-105"><a href="#cb265-105" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-106"><a href="#cb265-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-107"><a href="#cb265-107" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover:not(:disabled) {</span></span>
<span id="cb265-108"><a href="#cb265-108" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #5568d3;</span></span>
<span id="cb265-109"><a href="#cb265-109" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-110"><a href="#cb265-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-111"><a href="#cb265-111" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:disabled {</span></span>
<span id="cb265-112"><a href="#cb265-112" aria-hidden="true" tabindex="-1"></a><span class="vs">          opacity: 0.6;</span></span>
<span id="cb265-113"><a href="#cb265-113" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: not-allowed;</span></span>
<span id="cb265-114"><a href="#cb265-114" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-115"><a href="#cb265-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-116"><a href="#cb265-116" aria-hidden="true" tabindex="-1"></a><span class="vs">        .signup-link {</span></span>
<span id="cb265-117"><a href="#cb265-117" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: center;</span></span>
<span id="cb265-118"><a href="#cb265-118" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 15px;</span></span>
<span id="cb265-119"><a href="#cb265-119" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb265-120"><a href="#cb265-120" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-121"><a href="#cb265-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-122"><a href="#cb265-122" aria-hidden="true" tabindex="-1"></a><span class="vs">        .signup-link a {</span></span>
<span id="cb265-123"><a href="#cb265-123" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #667eea;</span></span>
<span id="cb265-124"><a href="#cb265-124" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-decoration: none;</span></span>
<span id="cb265-125"><a href="#cb265-125" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb265-126"><a href="#cb265-126" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb265-127"><a href="#cb265-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-128"><a href="#cb265-128" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb265-129"><a href="#cb265-129" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h2&gt;Login&lt;/h2&gt;</span></span>
<span id="cb265-130"><a href="#cb265-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-131"><a href="#cb265-131" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb265-132"><a href="#cb265-132" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">error</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb265-133"><a href="#cb265-133" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb265-134"><a href="#cb265-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-135"><a href="#cb265-135" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb265-136"><a href="#cb265-136" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span></span>
<span id="cb265-137"><a href="#cb265-137" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input</span></span>
<span id="cb265-138"><a href="#cb265-138" aria-hidden="true" tabindex="-1"></a><span class="vs">            type=&quot;email&quot;</span></span>
<span id="cb265-139"><a href="#cb265-139" aria-hidden="true" tabindex="-1"></a><span class="vs">            id=&quot;email&quot;</span></span>
<span id="cb265-140"><a href="#cb265-140" aria-hidden="true" tabindex="-1"></a><span class="vs">            value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb265-141"><a href="#cb265-141" aria-hidden="true" tabindex="-1"></a><span class="vs">            required</span></span>
<span id="cb265-142"><a href="#cb265-142" aria-hidden="true" tabindex="-1"></a><span class="vs">            autocomplete=&quot;email&quot;</span></span>
<span id="cb265-143"><a href="#cb265-143" aria-hidden="true" tabindex="-1"></a><span class="vs">          &gt;</span></span>
<span id="cb265-144"><a href="#cb265-144" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb265-145"><a href="#cb265-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-146"><a href="#cb265-146" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb265-147"><a href="#cb265-147" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span></span>
<span id="cb265-148"><a href="#cb265-148" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input</span></span>
<span id="cb265-149"><a href="#cb265-149" aria-hidden="true" tabindex="-1"></a><span class="vs">            type=&quot;password&quot;</span></span>
<span id="cb265-150"><a href="#cb265-150" aria-hidden="true" tabindex="-1"></a><span class="vs">            id=&quot;password&quot;</span></span>
<span id="cb265-151"><a href="#cb265-151" aria-hidden="true" tabindex="-1"></a><span class="vs">            value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb265-152"><a href="#cb265-152" aria-hidden="true" tabindex="-1"></a><span class="vs">            required</span></span>
<span id="cb265-153"><a href="#cb265-153" aria-hidden="true" tabindex="-1"></a><span class="vs">            autocomplete=&quot;current-password&quot;</span></span>
<span id="cb265-154"><a href="#cb265-154" aria-hidden="true" tabindex="-1"></a><span class="vs">          &gt;</span></span>
<span id="cb265-155"><a href="#cb265-155" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb265-156"><a href="#cb265-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-157"><a href="#cb265-157" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; ?disabled=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb265-158"><a href="#cb265-158" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;Logging in...&#39;</span> <span class="op">:</span> <span class="st">&#39;Login&#39;</span><span class="sc">}</span></span>
<span id="cb265-159"><a href="#cb265-159" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb265-160"><a href="#cb265-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-161"><a href="#cb265-161" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;signup-link&quot;&gt;</span></span>
<span id="cb265-162"><a href="#cb265-162" aria-hidden="true" tabindex="-1"></a><span class="vs">          Don&#39;t have an account? &lt;a href=&quot;/signup&quot;&gt;Sign up&lt;/a&gt;</span></span>
<span id="cb265-163"><a href="#cb265-163" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb265-164"><a href="#cb265-164" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb265-165"><a href="#cb265-165" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb265-166"><a href="#cb265-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-167"><a href="#cb265-167" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach event listeners</span></span>
<span id="cb265-168"><a href="#cb265-168" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb265-169"><a href="#cb265-169" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> emailInput <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#email&#39;</span>)<span class="op">;</span></span>
<span id="cb265-170"><a href="#cb265-170" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> passwordInput <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#password&#39;</span>)<span class="op">;</span></span>
<span id="cb265-171"><a href="#cb265-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-172"><a href="#cb265-172" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>(e))<span class="op">;</span></span>
<span id="cb265-173"><a href="#cb265-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-174"><a href="#cb265-174" aria-hidden="true" tabindex="-1"></a>    emailInput<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb265-175"><a href="#cb265-175" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb265-176"><a href="#cb265-176" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb265-177"><a href="#cb265-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-178"><a href="#cb265-178" aria-hidden="true" tabindex="-1"></a>    passwordInput<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb265-179"><a href="#cb265-179" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb265-180"><a href="#cb265-180" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb265-181"><a href="#cb265-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-182"><a href="#cb265-182" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle signup link</span></span>
<span id="cb265-183"><a href="#cb265-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> signupLink <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.signup-link a&#39;</span>)<span class="op">;</span></span>
<span id="cb265-184"><a href="#cb265-184" aria-hidden="true" tabindex="-1"></a>    signupLink<span class="op">?.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb265-185"><a href="#cb265-185" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb265-186"><a href="#cb265-186" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/signup&#39;</span> })<span class="op">;</span></span>
<span id="cb265-187"><a href="#cb265-187" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb265-188"><a href="#cb265-188" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb265-189"><a href="#cb265-189" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb265-190"><a href="#cb265-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-191"><a href="#cb265-191" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;login-form&#39;</span><span class="op">,</span> LoginForm)<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.7.2" id="signup-component"><span
class="header-section-number">12.7.2</span> Signup Component</h3>
<div class="sourceCode" id="cb266"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/signup-form.js</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SignupForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">confirmPassword</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">loading</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">errors</span><span class="op">:</span> {}</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-15"><a href="#cb266-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-16"><a href="#cb266-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb266-17"><a href="#cb266-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb266-18"><a href="#cb266-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-19"><a href="#cb266-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-20"><a href="#cb266-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate</span>() {</span>
<span id="cb266-21"><a href="#cb266-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb266-22"><a href="#cb266-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-23"><a href="#cb266-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">name</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb266-24"><a href="#cb266-24" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;Name must be at least 2 characters&#39;</span><span class="op">;</span></span>
<span id="cb266-25"><a href="#cb266-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-26"><a href="#cb266-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-27"><a href="#cb266-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> emailRegex <span class="op">=</span> <span class="ss">/</span><span class="sc">^[^\s@]+</span><span class="ss">@</span><span class="sc">[^\s@]+\.[^\s@]+$</span><span class="ss">/</span><span class="op">;</span></span>
<span id="cb266-28"><a href="#cb266-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>emailRegex<span class="op">.</span><span class="fu">test</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span>)) {</span>
<span id="cb266-29"><a href="#cb266-29" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">email</span> <span class="op">=</span> <span class="st">&#39;Invalid email address&#39;</span><span class="op">;</span></span>
<span id="cb266-30"><a href="#cb266-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-31"><a href="#cb266-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-32"><a href="#cb266-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span><span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">8</span>) {</span>
<span id="cb266-33"><a href="#cb266-33" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">password</span> <span class="op">=</span> <span class="st">&#39;Password must be at least 8 characters&#39;</span><span class="op">;</span></span>
<span id="cb266-34"><a href="#cb266-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-35"><a href="#cb266-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-36"><a href="#cb266-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span> <span class="op">!==</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">confirmPassword</span>) {</span>
<span id="cb266-37"><a href="#cb266-37" aria-hidden="true" tabindex="-1"></a>      errors<span class="op">.</span><span class="at">confirmPassword</span> <span class="op">=</span> <span class="st">&#39;Passwords do not match&#39;</span><span class="op">;</span></span>
<span id="cb266-38"><a href="#cb266-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-39"><a href="#cb266-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-40"><a href="#cb266-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> errors<span class="op">;</span></span>
<span id="cb266-41"><a href="#cb266-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-42"><a href="#cb266-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-43"><a href="#cb266-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleSubmit</span>(e) {</span>
<span id="cb266-44"><a href="#cb266-44" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb266-45"><a href="#cb266-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-46"><a href="#cb266-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> errors <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">validate</span>()<span class="op">;</span></span>
<span id="cb266-47"><a href="#cb266-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">Object</span><span class="op">.</span><span class="fu">keys</span>(errors)<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb266-48"><a href="#cb266-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></span>
<span id="cb266-49"><a href="#cb266-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb266-50"><a href="#cb266-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb266-51"><a href="#cb266-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-52"><a href="#cb266-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-53"><a href="#cb266-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb266-54"><a href="#cb266-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb266-55"><a href="#cb266-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb266-56"><a href="#cb266-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-57"><a href="#cb266-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb266-58"><a href="#cb266-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/signup&#39;</span><span class="op">,</span> {</span>
<span id="cb266-59"><a href="#cb266-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb266-60"><a href="#cb266-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb266-61"><a href="#cb266-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb266-62"><a href="#cb266-62" aria-hidden="true" tabindex="-1"></a>          <span class="dt">name</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb266-63"><a href="#cb266-63" aria-hidden="true" tabindex="-1"></a>          <span class="dt">email</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="op">,</span></span>
<span id="cb266-64"><a href="#cb266-64" aria-hidden="true" tabindex="-1"></a>          <span class="dt">password</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">password</span></span>
<span id="cb266-65"><a href="#cb266-65" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb266-66"><a href="#cb266-66" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb266-67"><a href="#cb266-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-68"><a href="#cb266-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb266-69"><a href="#cb266-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> error <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb266-70"><a href="#cb266-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(error<span class="op">.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Signup failed&#39;</span>)<span class="op">;</span></span>
<span id="cb266-71"><a href="#cb266-71" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb266-72"><a href="#cb266-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-73"><a href="#cb266-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> { accessToken<span class="op">,</span> refreshToken<span class="op">,</span> user } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb266-74"><a href="#cb266-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-75"><a href="#cb266-75" aria-hidden="true" tabindex="-1"></a>      auth<span class="op">.</span><span class="fu">setTokens</span>(accessToken<span class="op">,</span> refreshToken)<span class="op">;</span></span>
<span id="cb266-76"><a href="#cb266-76" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.login&#39;</span><span class="op">,</span> { user }<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb266-77"><a href="#cb266-77" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/dashboard&#39;</span> })<span class="op">;</span></span>
<span id="cb266-78"><a href="#cb266-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-79"><a href="#cb266-79" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb266-80"><a href="#cb266-80" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span> <span class="op">=</span> { <span class="dt">general</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }<span class="op">;</span></span>
<span id="cb266-81"><a href="#cb266-81" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb266-82"><a href="#cb266-82" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb266-83"><a href="#cb266-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-84"><a href="#cb266-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-85"><a href="#cb266-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-86"><a href="#cb266-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb266-87"><a href="#cb266-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb266-88"><a href="#cb266-88" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb266-89"><a href="#cb266-89" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* Similar styles to login-form */</span></span>
<span id="cb266-90"><a href="#cb266-90" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb266-91"><a href="#cb266-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb266-92"><a href="#cb266-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 400px;</span></span>
<span id="cb266-93"><a href="#cb266-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 50px auto;</span></span>
<span id="cb266-94"><a href="#cb266-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb266-95"><a href="#cb266-95" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* ... (copy styles from login-form) ... */</span></span>
<span id="cb266-96"><a href="#cb266-96" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb266-97"><a href="#cb266-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-98"><a href="#cb266-98" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form&gt;</span></span>
<span id="cb266-99"><a href="#cb266-99" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h2&gt;Create Account&lt;/h2&gt;</span></span>
<span id="cb266-100"><a href="#cb266-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-101"><a href="#cb266-101" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">general</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb266-102"><a href="#cb266-102" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">general</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb266-103"><a href="#cb266-103" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb266-104"><a href="#cb266-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-105"><a href="#cb266-105" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb266-106"><a href="#cb266-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;name&quot;&gt;Name&lt;/label&gt;</span></span>
<span id="cb266-107"><a href="#cb266-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;text&quot; id=&quot;name&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot; required&gt;</span></span>
<span id="cb266-108"><a href="#cb266-108" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">name</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb266-109"><a href="#cb266-109" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;field-error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb266-110"><a href="#cb266-110" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb266-111"><a href="#cb266-111" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb266-112"><a href="#cb266-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-113"><a href="#cb266-113" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb266-114"><a href="#cb266-114" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span></span>
<span id="cb266-115"><a href="#cb266-115" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;email&quot; id=&quot;email&quot; value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&quot; required&gt;</span></span>
<span id="cb266-116"><a href="#cb266-116" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb266-117"><a href="#cb266-117" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;field-error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb266-118"><a href="#cb266-118" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb266-119"><a href="#cb266-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb266-120"><a href="#cb266-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-121"><a href="#cb266-121" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb266-122"><a href="#cb266-122" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;</span></span>
<span id="cb266-123"><a href="#cb266-123" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; id=&quot;password&quot; required autocomplete=&quot;new-password&quot;&gt;</span></span>
<span id="cb266-124"><a href="#cb266-124" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">password</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb266-125"><a href="#cb266-125" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;field-error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">password</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb266-126"><a href="#cb266-126" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb266-127"><a href="#cb266-127" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb266-128"><a href="#cb266-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-129"><a href="#cb266-129" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;form-group&quot;&gt;</span></span>
<span id="cb266-130"><a href="#cb266-130" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;label for=&quot;confirmPassword&quot;&gt;Confirm Password&lt;/label&gt;</span></span>
<span id="cb266-131"><a href="#cb266-131" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input type=&quot;password&quot; id=&quot;confirmPassword&quot; required&gt;</span></span>
<span id="cb266-132"><a href="#cb266-132" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">confirmPassword</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb266-133"><a href="#cb266-133" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;span class=&quot;field-error&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">confirmPassword</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb266-134"><a href="#cb266-134" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb266-135"><a href="#cb266-135" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb266-136"><a href="#cb266-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-137"><a href="#cb266-137" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; ?disabled=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb266-138"><a href="#cb266-138" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">loading</span> <span class="op">?</span> <span class="st">&#39;Creating account...&#39;</span> <span class="op">:</span> <span class="st">&#39;Sign Up&#39;</span><span class="sc">}</span></span>
<span id="cb266-139"><a href="#cb266-139" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb266-140"><a href="#cb266-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-141"><a href="#cb266-141" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;login-link&quot;&gt;</span></span>
<span id="cb266-142"><a href="#cb266-142" aria-hidden="true" tabindex="-1"></a><span class="vs">          Already have an account? &lt;a href=&quot;/login&quot;&gt;Login&lt;/a&gt;</span></span>
<span id="cb266-143"><a href="#cb266-143" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb266-144"><a href="#cb266-144" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb266-145"><a href="#cb266-145" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb266-146"><a href="#cb266-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-147"><a href="#cb266-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Attach event listeners (similar to login-form)</span></span>
<span id="cb266-148"><a href="#cb266-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb266-149"><a href="#cb266-149" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleSubmit</span>(e))<span class="op">;</span></span>
<span id="cb266-150"><a href="#cb266-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-151"><a href="#cb266-151" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update state on input</span></span>
<span id="cb266-152"><a href="#cb266-152" aria-hidden="true" tabindex="-1"></a>    [<span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;email&#39;</span><span class="op">,</span> <span class="st">&#39;password&#39;</span><span class="op">,</span> <span class="st">&#39;confirmPassword&#39;</span>]<span class="op">.</span><span class="fu">forEach</span>(field <span class="kw">=&gt;</span> {</span>
<span id="cb266-153"><a href="#cb266-153" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`#</span><span class="sc">${</span>field<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb266-154"><a href="#cb266-154" aria-hidden="true" tabindex="-1"></a>      input<span class="op">?.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb266-155"><a href="#cb266-155" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">state</span>[field] <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb266-156"><a href="#cb266-156" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb266-157"><a href="#cb266-157" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb266-158"><a href="#cb266-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-159"><a href="#cb266-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb266-160"><a href="#cb266-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-161"><a href="#cb266-161" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;signup-form&#39;</span><span class="op">,</span> SignupForm)<span class="op">;</span></span></code></pre></div>
<h2 data-number="12.8" id="oauth-integration-github-example"><span
class="header-section-number">12.8</span> OAuth Integration (GitHub
Example)</h2>
<p>OAuth allows users to log in with existing accounts from providers
like GitHub, Google, or Facebook:</p>
<h3 data-number="12.8.1" id="oauth-flow"><span
class="header-section-number">12.8.1</span> OAuth Flow</h3>
<div class="sourceCode" id="cb267"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/oauth.js</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OAuthService {</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">providers</span> <span class="op">=</span> {</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">github</span><span class="op">:</span> {</span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">clientId</span><span class="op">:</span> <span class="st">&#39;your-github-client-id&#39;</span><span class="op">,</span></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">authUrl</span><span class="op">:</span> <span class="st">&#39;https://github.com/login/oauth/authorize&#39;</span><span class="op">,</span></span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scope</span><span class="op">:</span> <span class="st">&#39;read:user user:email&#39;</span></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initiateLogin</span>(provider) {</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> config <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">providers</span>[provider]<span class="op">;</span></span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>config) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="vs">`Unknown provider: </span><span class="sc">${</span>provider<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> redirectUri <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">origin</span><span class="sc">}</span><span class="vs">/auth/callback`</span><span class="op">;</span></span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> state <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">generateState</span>()<span class="op">;</span></span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store state for CSRF protection</span></span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a>    sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;oauth_state&#39;</span><span class="op">,</span> state)<span class="op">;</span></span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-23"><a href="#cb267-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>({</span>
<span id="cb267-24"><a href="#cb267-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">client_id</span><span class="op">:</span> config<span class="op">.</span><span class="at">clientId</span><span class="op">,</span></span>
<span id="cb267-25"><a href="#cb267-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">redirect_uri</span><span class="op">:</span> redirectUri<span class="op">,</span></span>
<span id="cb267-26"><a href="#cb267-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scope</span><span class="op">:</span> config<span class="op">.</span><span class="at">scope</span><span class="op">,</span></span>
<span id="cb267-27"><a href="#cb267-27" aria-hidden="true" tabindex="-1"></a>      state</span>
<span id="cb267-28"><a href="#cb267-28" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb267-29"><a href="#cb267-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-30"><a href="#cb267-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Redirect to provider</span></span>
<span id="cb267-31"><a href="#cb267-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>config<span class="op">.</span><span class="at">authUrl</span><span class="sc">}</span><span class="vs">?</span><span class="sc">${</span>params<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb267-32"><a href="#cb267-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb267-33"><a href="#cb267-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-34"><a href="#cb267-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generateState</span>() {</span>
<span id="cb267-35"><a href="#cb267-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(crypto<span class="op">.</span><span class="fu">getRandomValues</span>(<span class="kw">new</span> <span class="bu">Uint8Array</span>(<span class="dv">16</span>)))</span>
<span id="cb267-36"><a href="#cb267-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(b <span class="kw">=&gt;</span> b<span class="op">.</span><span class="fu">toString</span>(<span class="dv">16</span>)<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>))</span>
<span id="cb267-37"><a href="#cb267-37" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb267-38"><a href="#cb267-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb267-39"><a href="#cb267-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-40"><a href="#cb267-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleCallback</span>() {</span>
<span id="cb267-41"><a href="#cb267-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">;</span></span>
<span id="cb267-42"><a href="#cb267-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> code <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;code&#39;</span>)<span class="op">;</span></span>
<span id="cb267-43"><a href="#cb267-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> state <span class="op">=</span> params<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;state&#39;</span>)<span class="op">;</span></span>
<span id="cb267-44"><a href="#cb267-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-45"><a href="#cb267-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify state (CSRF protection)</span></span>
<span id="cb267-46"><a href="#cb267-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> storedState <span class="op">=</span> sessionStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;oauth_state&#39;</span>)<span class="op">;</span></span>
<span id="cb267-47"><a href="#cb267-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (state <span class="op">!==</span> storedState) {</span>
<span id="cb267-48"><a href="#cb267-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Invalid state parameter&#39;</span>)<span class="op">;</span></span>
<span id="cb267-49"><a href="#cb267-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb267-50"><a href="#cb267-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-51"><a href="#cb267-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Exchange code for token with your backend</span></span>
<span id="cb267-52"><a href="#cb267-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/github/callback&#39;</span><span class="op">,</span> {</span>
<span id="cb267-53"><a href="#cb267-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb267-54"><a href="#cb267-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb267-55"><a href="#cb267-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ code })</span>
<span id="cb267-56"><a href="#cb267-56" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb267-57"><a href="#cb267-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-58"><a href="#cb267-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb267-59"><a href="#cb267-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;OAuth authentication failed&#39;</span>)<span class="op">;</span></span>
<span id="cb267-60"><a href="#cb267-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb267-61"><a href="#cb267-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-62"><a href="#cb267-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { accessToken<span class="op">,</span> refreshToken<span class="op">,</span> user } <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb267-63"><a href="#cb267-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-64"><a href="#cb267-64" aria-hidden="true" tabindex="-1"></a>    auth<span class="op">.</span><span class="fu">setTokens</span>(accessToken<span class="op">,</span> refreshToken)<span class="op">;</span></span>
<span id="cb267-65"><a href="#cb267-65" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;auth.login&#39;</span><span class="op">,</span> { user }<span class="op">,</span> { <span class="dt">retained</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb267-66"><a href="#cb267-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-67"><a href="#cb267-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up</span></span>
<span id="cb267-68"><a href="#cb267-68" aria-hidden="true" tabindex="-1"></a>    sessionStorage<span class="op">.</span><span class="fu">removeItem</span>(<span class="st">&#39;oauth_state&#39;</span>)<span class="op">;</span></span>
<span id="cb267-69"><a href="#cb267-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-70"><a href="#cb267-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb267-71"><a href="#cb267-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb267-72"><a href="#cb267-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb267-73"><a href="#cb267-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-74"><a href="#cb267-74" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> oauth <span class="op">=</span> <span class="kw">new</span> <span class="fu">OAuthService</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.8.2" id="oauth-button-component"><span
class="header-section-number">12.8.2</span> OAuth Button Component</h3>
<div class="sourceCode" id="cb268"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OAuthButtons <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        .oauth-buttons {</span></span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb268-8"><a href="#cb268-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 10px;</span></span>
<span id="cb268-9"><a href="#cb268-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 20px 0;</span></span>
<span id="cb268-10"><a href="#cb268-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb268-11"><a href="#cb268-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-12"><a href="#cb268-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .oauth-button {</span></span>
<span id="cb268-13"><a href="#cb268-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb268-14"><a href="#cb268-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb268-15"><a href="#cb268-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: center;</span></span>
<span id="cb268-16"><a href="#cb268-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 10px;</span></span>
<span id="cb268-17"><a href="#cb268-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 12px;</span></span>
<span id="cb268-18"><a href="#cb268-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb268-19"><a href="#cb268-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb268-20"><a href="#cb268-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb268-21"><a href="#cb268-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb268-22"><a href="#cb268-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          transition: background 0.2s;</span></span>
<span id="cb268-23"><a href="#cb268-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb268-24"><a href="#cb268-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-25"><a href="#cb268-25" aria-hidden="true" tabindex="-1"></a><span class="vs">        .oauth-button:hover {</span></span>
<span id="cb268-26"><a href="#cb268-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb268-27"><a href="#cb268-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb268-28"><a href="#cb268-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-29"><a href="#cb268-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        .oauth-button img {</span></span>
<span id="cb268-30"><a href="#cb268-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 20px;</span></span>
<span id="cb268-31"><a href="#cb268-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 20px;</span></span>
<span id="cb268-32"><a href="#cb268-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb268-33"><a href="#cb268-33" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb268-34"><a href="#cb268-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-35"><a href="#cb268-35" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;oauth-buttons&quot;&gt;</span></span>
<span id="cb268-36"><a href="#cb268-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;oauth-button&quot; data-provider=&quot;github&quot;&gt;</span></span>
<span id="cb268-37"><a href="#cb268-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;img src=&quot;/icons/github.svg&quot; alt=&quot;GitHub&quot;&gt;</span></span>
<span id="cb268-38"><a href="#cb268-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span&gt;Continue with GitHub&lt;/span&gt;</span></span>
<span id="cb268-39"><a href="#cb268-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb268-40"><a href="#cb268-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-41"><a href="#cb268-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;oauth-button&quot; data-provider=&quot;google&quot;&gt;</span></span>
<span id="cb268-42"><a href="#cb268-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;img src=&quot;/icons/google.svg&quot; alt=&quot;Google&quot;&gt;</span></span>
<span id="cb268-43"><a href="#cb268-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span&gt;Continue with Google&lt;/span&gt;</span></span>
<span id="cb268-44"><a href="#cb268-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb268-45"><a href="#cb268-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb268-46"><a href="#cb268-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-47"><a href="#cb268-47" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;divider&quot;&gt;</span></span>
<span id="cb268-48"><a href="#cb268-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span&gt;or&lt;/span&gt;</span></span>
<span id="cb268-49"><a href="#cb268-49" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb268-50"><a href="#cb268-50" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb268-51"><a href="#cb268-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-52"><a href="#cb268-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-provider]&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(button <span class="kw">=&gt;</span> {</span>
<span id="cb268-53"><a href="#cb268-53" aria-hidden="true" tabindex="-1"></a>      button<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb268-54"><a href="#cb268-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> provider <span class="op">=</span> button<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">provider</span><span class="op">;</span></span>
<span id="cb268-55"><a href="#cb268-55" aria-hidden="true" tabindex="-1"></a>        oauth<span class="op">.</span><span class="fu">initiateLogin</span>(provider)<span class="op">;</span></span>
<span id="cb268-56"><a href="#cb268-56" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb268-57"><a href="#cb268-57" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb268-58"><a href="#cb268-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb268-59"><a href="#cb268-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb268-60"><a href="#cb268-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-61"><a href="#cb268-61" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;oauth-buttons&#39;</span><span class="op">,</span> OAuthButtons)<span class="op">;</span></span></code></pre></div>
<h2 data-number="12.9" id="session-management"><span
class="header-section-number">12.9</span> Session Management</h2>
<p>Track active sessions and allow users to log out from all
devices:</p>
<div class="sourceCode" id="cb269"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co">// services/session-manager.js</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionManager {</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getSessions</span>() {</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> api<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/auth/sessions&#39;</span>)<span class="op">;</span></span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">revokeSession</span>(sessionId) {</span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> api<span class="op">.</span><span class="fu">delete</span>(<span class="vs">`/auth/sessions/</span><span class="sc">${</span>sessionId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;session.revoked&#39;</span><span class="op">,</span> { sessionId })<span class="op">;</span></span>
<span id="cb269-10"><a href="#cb269-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb269-11"><a href="#cb269-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-12"><a href="#cb269-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">revokeAllSessions</span>() {</span>
<span id="cb269-13"><a href="#cb269-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> api<span class="op">.</span><span class="fu">delete</span>(<span class="st">&#39;/auth/sessions&#39;</span>)<span class="op">;</span></span>
<span id="cb269-14"><a href="#cb269-14" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;session.all-revoked&#39;</span>)<span class="op">;</span></span>
<span id="cb269-15"><a href="#cb269-15" aria-hidden="true" tabindex="-1"></a>    auth<span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb269-16"><a href="#cb269-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb269-17"><a href="#cb269-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb269-18"><a href="#cb269-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-19"><a href="#cb269-19" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> sessionManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">SessionManager</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.9.1" id="sessions-component"><span
class="header-section-number">12.9.1</span> Sessions Component</h3>
<div class="sourceCode" id="cb270"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SessionsList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">sessions</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadSessions</span>()<span class="op">;</span></span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-11"><a href="#cb270-11" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;session.revoked&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadSessions</span>())<span class="op">;</span></span>
<span id="cb270-12"><a href="#cb270-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-13"><a href="#cb270-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-14"><a href="#cb270-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadSessions</span>() {</span>
<span id="cb270-15"><a href="#cb270-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb270-16"><a href="#cb270-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">sessions</span> <span class="op">=</span> <span class="cf">await</span> sessionManager<span class="op">.</span><span class="fu">getSessions</span>()<span class="op">;</span></span>
<span id="cb270-17"><a href="#cb270-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb270-18"><a href="#cb270-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb270-19"><a href="#cb270-19" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load sessions:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb270-20"><a href="#cb270-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb270-21"><a href="#cb270-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-22"><a href="#cb270-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-23"><a href="#cb270-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">revokeSession</span>(sessionId) {</span>
<span id="cb270-24"><a href="#cb270-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">confirm</span>(<span class="st">&#39;Revoke this session?&#39;</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb270-25"><a href="#cb270-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-26"><a href="#cb270-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb270-27"><a href="#cb270-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> sessionManager<span class="op">.</span><span class="fu">revokeSession</span>(sessionId)<span class="op">;</span></span>
<span id="cb270-28"><a href="#cb270-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb270-29"><a href="#cb270-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">alert</span>(<span class="st">&#39;Failed to revoke session&#39;</span>)<span class="op">;</span></span>
<span id="cb270-30"><a href="#cb270-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb270-31"><a href="#cb270-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-32"><a href="#cb270-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-33"><a href="#cb270-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">revokeAll</span>() {</span>
<span id="cb270-34"><a href="#cb270-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">confirm</span>(<span class="st">&#39;Log out from all devices?&#39;</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb270-35"><a href="#cb270-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-36"><a href="#cb270-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb270-37"><a href="#cb270-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> sessionManager<span class="op">.</span><span class="fu">revokeAllSessions</span>()<span class="op">;</span></span>
<span id="cb270-38"><a href="#cb270-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb270-39"><a href="#cb270-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">alert</span>(<span class="st">&#39;Failed to revoke sessions&#39;</span>)<span class="op">;</span></span>
<span id="cb270-40"><a href="#cb270-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb270-41"><a href="#cb270-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-42"><a href="#cb270-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-43"><a href="#cb270-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb270-44"><a href="#cb270-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb270-45"><a href="#cb270-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;sessions&quot;&gt;</span></span>
<span id="cb270-46"><a href="#cb270-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;Active Sessions&lt;/h3&gt;</span></span>
<span id="cb270-47"><a href="#cb270-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-48"><a href="#cb270-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">sessions</span><span class="op">.</span><span class="fu">map</span>(session <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb270-49"><a href="#cb270-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;session&quot; data-current=&quot;</span><span class="sc">${</span>session<span class="op">.</span><span class="at">isCurrent</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb270-50"><a href="#cb270-50" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;session-info&quot;&gt;</span></span>
<span id="cb270-51"><a href="#cb270-51" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;strong&gt;</span><span class="sc">${</span>session<span class="op">.</span><span class="at">device</span><span class="sc">}</span><span class="vs">&lt;/strong&gt;</span></span>
<span id="cb270-52"><a href="#cb270-52" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;span&gt;</span><span class="sc">${</span>session<span class="op">.</span><span class="at">location</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb270-53"><a href="#cb270-53" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;small&gt;Last active: </span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(session<span class="op">.</span><span class="at">lastActive</span>)<span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs">&lt;/small&gt;</span></span>
<span id="cb270-54"><a href="#cb270-54" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb270-55"><a href="#cb270-55" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>session<span class="op">.</span><span class="at">isCurrent</span> <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb270-56"><a href="#cb270-56" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;span class=&quot;badge&quot;&gt;Current&lt;/span&gt;</span></span>
<span id="cb270-57"><a href="#cb270-57" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span> <span class="op">:</span> <span class="vs">`</span></span>
<span id="cb270-58"><a href="#cb270-58" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;button onclick=&quot;this.closest(&#39;sessions-list&#39;).revokeSession(&#39;</span><span class="sc">${</span>session<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&#39;)&quot;&gt;</span></span>
<span id="cb270-59"><a href="#cb270-59" aria-hidden="true" tabindex="-1"></a><span class="vs">                Revoke</span></span>
<span id="cb270-60"><a href="#cb270-60" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/button&gt;</span></span>
<span id="cb270-61"><a href="#cb270-61" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span><span class="sc">}</span></span>
<span id="cb270-62"><a href="#cb270-62" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb270-63"><a href="#cb270-63" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb270-64"><a href="#cb270-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-65"><a href="#cb270-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;danger&quot; onclick=&quot;this.closest(&#39;sessions-list&#39;).revokeAll()&quot;&gt;</span></span>
<span id="cb270-66"><a href="#cb270-66" aria-hidden="true" tabindex="-1"></a><span class="vs">          Log out from all devices</span></span>
<span id="cb270-67"><a href="#cb270-67" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb270-68"><a href="#cb270-68" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb270-69"><a href="#cb270-69" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb270-70"><a href="#cb270-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb270-71"><a href="#cb270-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb270-72"><a href="#cb270-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-73"><a href="#cb270-73" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;sessions-list&#39;</span><span class="op">,</span> SessionsList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="12.10" id="xss-and-csrf-protection"><span
class="header-section-number">12.10</span> XSS and CSRF Protection</h2>
<h3 data-number="12.10.1" id="preventing-xss-cross-site-scripting"><span
class="header-section-number">12.10.1</span> Preventing XSS (Cross-Site
Scripting)</h3>
<p>Always sanitize user input before rendering:</p>
<div class="sourceCode" id="cb271"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co">// utils/sanitize.js</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ALLOWED_TAGS <span class="op">=</span> [<span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;i&#39;</span><span class="op">,</span> <span class="st">&#39;em&#39;</span><span class="op">,</span> <span class="st">&#39;strong&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;p&#39;</span><span class="op">,</span> <span class="st">&#39;br&#39;</span>]<span class="op">;</span></span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sanitizeHtml</span>(html) {</span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> div <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> html<span class="op">;</span></span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Remove all scripts</span></span>
<span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;script&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> el<span class="op">.</span><span class="fu">remove</span>())<span class="op">;</span></span>
<span id="cb271-10"><a href="#cb271-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-11"><a href="#cb271-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Remove event handlers</span></span>
<span id="cb271-12"><a href="#cb271-12" aria-hidden="true" tabindex="-1"></a>  div<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;*&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> {</span>
<span id="cb271-13"><a href="#cb271-13" aria-hidden="true" tabindex="-1"></a>    [<span class="op">...</span>el<span class="op">.</span><span class="at">attributes</span>]<span class="op">.</span><span class="fu">forEach</span>(attr <span class="kw">=&gt;</span> {</span>
<span id="cb271-14"><a href="#cb271-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (attr<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;on&#39;</span>)) {</span>
<span id="cb271-15"><a href="#cb271-15" aria-hidden="true" tabindex="-1"></a>        el<span class="op">.</span><span class="fu">removeAttribute</span>(attr<span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb271-16"><a href="#cb271-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb271-17"><a href="#cb271-17" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb271-18"><a href="#cb271-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-19"><a href="#cb271-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove tags not in allowlist</span></span>
<span id="cb271-20"><a href="#cb271-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>ALLOWED_TAGS<span class="op">.</span><span class="fu">includes</span>(el<span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>())) {</span>
<span id="cb271-21"><a href="#cb271-21" aria-hidden="true" tabindex="-1"></a>      el<span class="op">.</span><span class="fu">replaceWith</span>(<span class="op">...</span>el<span class="op">.</span><span class="at">childNodes</span>)<span class="op">;</span></span>
<span id="cb271-22"><a href="#cb271-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb271-23"><a href="#cb271-23" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb271-24"><a href="#cb271-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-25"><a href="#cb271-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> div<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb271-26"><a href="#cb271-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb271-27"><a href="#cb271-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-28"><a href="#cb271-28" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> { sanitizeHtml }<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.10.2" id="csrf-protection"><span
class="header-section-number">12.10.2</span> CSRF Protection</h3>
<p>Include CSRF tokens in state-changing requests:</p>
<div class="sourceCode" id="cb272"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co">// api-client.js</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SecureApiClient {</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCsrfToken</span>() {</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get from meta tag or cookie</span></span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span>)<span class="op">?.</span><span class="at">content</span><span class="op">;</span></span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> headers <span class="op">=</span> {</span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;X-CSRF-Token&#39;</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getCsrfToken</span>()<span class="op">,</span></span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>options<span class="op">.</span><span class="at">headers</span></span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">fetch</span>(endpoint<span class="op">,</span> { <span class="op">...</span>options<span class="op">,</span> headers })<span class="op">;</span></span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Server should validate CSRF tokens on state-changing requests (POST,
PUT, DELETE).</p>
<h2 data-number="12.11" id="password-reset-flow"><span
class="header-section-number">12.11</span> Password Reset Flow</h2>
<div class="sourceCode" id="cb273"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/password-reset.js</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PasswordResetForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleRequest</span>(e) {</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> email <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#email&#39;</span>)<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/password-reset&#39;</span><span class="op">,</span> {</span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ email })</span>
<span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-14"><a href="#cb273-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb273-15"><a href="#cb273-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;If an account exists for </span><span class="sc">${</span>email<span class="sc">}</span><span class="vs">, you will receive a password reset email.&lt;/p&gt;</span></span>
<span id="cb273-16"><a href="#cb273-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb273-17"><a href="#cb273-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb273-18"><a href="#cb273-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Failed to send reset email&#39;</span>)<span class="op">;</span></span>
<span id="cb273-19"><a href="#cb273-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb273-20"><a href="#cb273-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb273-21"><a href="#cb273-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-22"><a href="#cb273-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleReset</span>(e) {</span>
<span id="cb273-23"><a href="#cb273-23" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb273-24"><a href="#cb273-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> <span class="kw">new</span> <span class="fu">URLSearchParams</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">search</span>)<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;token&#39;</span>)<span class="op">;</span></span>
<span id="cb273-25"><a href="#cb273-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> password <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#password&#39;</span>)<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb273-26"><a href="#cb273-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-27"><a href="#cb273-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb273-28"><a href="#cb273-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/auth/password-reset/confirm&#39;</span><span class="op">,</span> {</span>
<span id="cb273-29"><a href="#cb273-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb273-30"><a href="#cb273-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb273-31"><a href="#cb273-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ token<span class="op">,</span> password })</span>
<span id="cb273-32"><a href="#cb273-32" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb273-33"><a href="#cb273-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-34"><a href="#cb273-34" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb273-35"><a href="#cb273-35" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.success&#39;</span><span class="op">,</span> {</span>
<span id="cb273-36"><a href="#cb273-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Password reset successful&#39;</span></span>
<span id="cb273-37"><a href="#cb273-37" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb273-38"><a href="#cb273-38" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb273-39"><a href="#cb273-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(<span class="st">&#39;Failed to reset password&#39;</span>)<span class="op">;</span></span>
<span id="cb273-40"><a href="#cb273-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb273-41"><a href="#cb273-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb273-42"><a href="#cb273-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.12" id="troubleshooting-1"><span
class="header-section-number">12.12</span> Troubleshooting</h2>
<h3 data-number="12.12.1" id="problem-token-expires-too-quickly"><span
class="header-section-number">12.12.1</span> Problem: Token Expires Too
Quickly</h3>
<p><strong>Symptom</strong>: Users frequently get logged out</p>
<p><strong>Solution</strong>: Implement automatic token refresh in
background:</p>
<div class="sourceCode" id="cb274"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Auto-refresh tokens before expiry</span></span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TokenRefreshManager {</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">refreshInterval</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">start</span>() {</span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check token every minute</span></span>
<span id="cb274-9"><a href="#cb274-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">refreshInterval</span> <span class="op">=</span> <span class="pp">setInterval</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb274-10"><a href="#cb274-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> token <span class="op">=</span> auth<span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb274-11"><a href="#cb274-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>token) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb274-12"><a href="#cb274-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-13"><a href="#cb274-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> payload <span class="op">=</span> auth<span class="op">.</span><span class="fu">decodeToken</span>(token)<span class="op">;</span></span>
<span id="cb274-14"><a href="#cb274-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> expiresIn <span class="op">=</span> (payload<span class="op">.</span><span class="at">exp</span> <span class="op">*</span> <span class="dv">1000</span>) <span class="op">-</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb274-15"><a href="#cb274-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-16"><a href="#cb274-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Refresh if expires in less than 5 minutes</span></span>
<span id="cb274-17"><a href="#cb274-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (expiresIn <span class="op">&lt;</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>) {</span>
<span id="cb274-18"><a href="#cb274-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb274-19"><a href="#cb274-19" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> auth<span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb274-20"><a href="#cb274-20" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb274-21"><a href="#cb274-21" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Auto-refresh failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb274-22"><a href="#cb274-22" aria-hidden="true" tabindex="-1"></a>          auth<span class="op">.</span><span class="fu">logout</span>()<span class="op">;</span></span>
<span id="cb274-23"><a href="#cb274-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb274-24"><a href="#cb274-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb274-25"><a href="#cb274-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb274-26"><a href="#cb274-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb274-27"><a href="#cb274-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-28"><a href="#cb274-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>() {</span>
<span id="cb274-29"><a href="#cb274-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">refreshInterval</span>) {</span>
<span id="cb274-30"><a href="#cb274-30" aria-hidden="true" tabindex="-1"></a>      <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">refreshInterval</span>)<span class="op">;</span></span>
<span id="cb274-31"><a href="#cb274-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb274-32"><a href="#cb274-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb274-33"><a href="#cb274-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb274-34"><a href="#cb274-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-35"><a href="#cb274-35" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> tokenRefresh <span class="op">=</span> <span class="kw">new</span> <span class="fu">TokenRefreshManager</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.12.2" id="problem-oauth-callback-not-working"><span
class="header-section-number">12.12.2</span> Problem: OAuth Callback Not
Working</h3>
<p><strong>Symptom</strong>: After OAuth redirect, nothing happens</p>
<p><strong>Solution</strong>: Ensure callback route is registered and
handles the code:</p>
<div class="sourceCode" id="cb275"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In your router setup</span></span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;route.changed&#39;</span><span class="op">,</span> ({ path }) <span class="kw">=&gt;</span> {</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (path <span class="op">===</span> <span class="st">&#39;/auth/callback&#39;</span>) {</span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>    oauth<span class="op">.</span><span class="fu">handleCallback</span>()</span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/dashboard&#39;</span> })<span class="op">;</span></span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb275-8"><a href="#cb275-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb275-9"><a href="#cb275-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;OAuth callback failed:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb275-10"><a href="#cb275-10" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb275-11"><a href="#cb275-11" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb275-12"><a href="#cb275-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb275-13"><a href="#cb275-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="12.12.3"
id="problem-users-see-flash-of-protected-content"><span
class="header-section-number">12.12.3</span> Problem: Users See Flash of
Protected Content</h3>
<p><strong>Symptom</strong>: Protected page renders briefly before
redirect to login</p>
<p><strong>Solution</strong>: Check authentication before mounting
component:</p>
<div class="sourceCode" id="cb276"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProtectedPage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Don&#39;t render until auth check complete</span></span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">checkAuthThenRender</span>()<span class="op">;</span></span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">checkAuthThenRender</span>() {</span>
<span id="cb276-8"><a href="#cb276-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>auth<span class="op">.</span><span class="fu">isAuthenticated</span>()) {</span>
<span id="cb276-9"><a href="#cb276-9" aria-hidden="true" tabindex="-1"></a>      sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;returnUrl&#39;</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb276-10"><a href="#cb276-10" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb276-11"><a href="#cb276-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb276-12"><a href="#cb276-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb276-13"><a href="#cb276-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-14"><a href="#cb276-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb276-15"><a href="#cb276-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb276-16"><a href="#cb276-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-17"><a href="#cb276-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb276-18"><a href="#cb276-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only called if authenticated</span></span>
<span id="cb276-19"><a href="#cb276-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb276-20"><a href="#cb276-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h1&gt;Protected Content&lt;/h1&gt;</span></span>
<span id="cb276-21"><a href="#cb276-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;Only authenticated users see this&lt;/p&gt;</span></span>
<span id="cb276-22"><a href="#cb276-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb276-23"><a href="#cb276-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb276-24"><a href="#cb276-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="12.12.4" id="problem-infinite-redirect-loop"><span
class="header-section-number">12.12.4</span> Problem: Infinite Redirect
Loop</h3>
<p><strong>Symptom</strong>: App keeps redirecting between login and
protected route</p>
<p><strong>Solution</strong>: Check for redirect loops in route
guard:</p>
<div class="sourceCode" id="cb277"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RouteGuard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkAuth</span>() {</span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>auth<span class="op">.</span><span class="fu">isAuthenticated</span>() <span class="op">&amp;&amp;</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span> <span class="op">!==</span> <span class="st">&#39;/login&#39;</span>) {</span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>      sessionStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;returnUrl&#39;</span><span class="op">,</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span>)<span class="op">;</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="st">&#39;/login&#39;</span> })<span class="op">;</span></span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="12.13" id="best-practices-8"><span
class="header-section-number">12.13</span> Best Practices</h2>
<ol type="1">
<li><strong>Never store passwords</strong> - Always hash on the
server</li>
<li><strong>Use HTTPS everywhere</strong> - Tokens in plaintext over
HTTP are vulnerable</li>
<li><strong>Implement token refresh</strong> - Don’t force users to
re-login frequently</li>
<li><strong>Validate on the server</strong> - Client-side validation is
for UX, not security</li>
<li><strong>Use httpOnly cookies for tokens</strong> - Protects against
XSS</li>
<li><strong>Implement CSRF protection</strong> - Required for
cookie-based auth</li>
<li><strong>Rate limit authentication endpoints</strong> - Prevent brute
force attacks</li>
<li><strong>Log authentication events</strong> - Track suspicious
activity</li>
<li><strong>Use secure password requirements</strong> - Minimum 8
characters, complexity rules</li>
<li><strong>Provide 2FA</strong> - Add extra layer of security for
sensitive apps</li>
</ol>
<h2 data-number="12.14" id="exercises-2"><span
class="header-section-number">12.14</span> Exercises</h2>
<h3 data-number="12.14.1" id="exercise-1-add-remember-me"><span
class="header-section-number">12.14.1</span> Exercise 1: Add “Remember
Me”</h3>
<p>Extend the login form with a “Remember Me” checkbox that:</p>
<ul>
<li>Uses a longer-lived refresh token when checked</li>
<li>Falls back to session-only auth when unchecked</li>
<li>Persists the preference across sessions</li>
</ul>
<h3 data-number="12.14.2" id="exercise-2-implement-2fa"><span
class="header-section-number">12.14.2</span> Exercise 2: Implement
2FA</h3>
<p>Add two-factor authentication:</p>
<ul>
<li>Generate TOTP secret on enrollment</li>
<li>Display QR code for authenticator apps</li>
<li>Validate TOTP codes on login</li>
<li>Provide backup codes for account recovery</li>
</ul>
<h3 data-number="12.14.3" id="exercise-3-password-strength-meter"><span
class="header-section-number">12.14.3</span> Exercise 3: Password
Strength Meter</h3>
<p>Build a password strength indicator that:</p>
<ul>
<li>Shows strength in real-time as user types</li>
<li>Checks length, character variety, common passwords</li>
<li>Provides feedback on how to improve</li>
<li>Blocks weak passwords on submission</li>
</ul>
<h3 data-number="12.14.4" id="exercise-4-activity-log"><span
class="header-section-number">12.14.4</span> Exercise 4: Activity
Log</h3>
<p>Create an activity log component that:</p>
<ul>
<li>Tracks login attempts, password changes, session activity</li>
<li>Displays timeline of security events</li>
<li>Alerts on suspicious activity (new device, new location)</li>
<li>Allows filtering by event type</li>
</ul>
<hr />
<h2 data-number="12.15" id="summary-11"><span
class="header-section-number">12.15</span> Summary</h2>
<p>Authentication and security are critical to any application that
handles user data. LARC applications use industry-standard patterns:</p>
<ul>
<li><strong>JWT tokens</strong> for stateless authentication</li>
<li><strong>Automatic token refresh</strong> to maintain sessions</li>
<li><strong>OAuth integration</strong> for social login</li>
<li><strong>RBAC</strong> for fine-grained authorization</li>
<li><strong>XSS and CSRF protection</strong> to prevent attacks</li>
<li><strong>Secure token storage</strong> with httpOnly cookies when
possible</li>
<li><strong>Route guards</strong> to protect sensitive pages</li>
<li><strong>Session management</strong> to track and revoke active
sessions</li>
</ul>
<p>Security isn’t a checkbox—it’s an ongoing practice. Stay updated on
security best practices, use HTTPS everywhere, validate all input, and
treat user data with respect.</p>
<hr />
<h2 data-number="12.16" id="further-reading-11"><span
class="header-section-number">12.16</span> Further Reading</h2>
<p><strong>For complete authentication reference:</strong> -
<em>Building with LARC</em> Chapter 8: Authentication and Authorization
- All auth patterns and strategies - <em>Building with LARC</em> Chapter
14: Error Handling and Debugging - Security debugging - <em>Building
with LARC</em> Appendix E: Recipes and Patterns - Auth implementation
recipes</p>
<div class="pagebreak">

</div>
<h1 data-number="13" id="server-integration"><span
class="header-section-number">13</span> Server Integration</h1>
<p>LARC is frontend-agnostic about backends. Whether you’re using
Node.js, Python, PHP, or any other server technology, the patterns
remain the same: your components communicate via HTTP and WebSockets,
and the PAN bus coordinates the frontend.</p>
<h2 data-number="13.1" id="node.js-with-express"><span
class="header-section-number">13.1</span> Node.js with Express</h2>
<p>Express is the most popular Node.js framework, and it pairs naturally
with LARC:</p>
<div class="sourceCode" id="cb278"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co">// server.js</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;cors&#39;</span>)<span class="op">;</span></span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> jwt <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;jsonwebtoken&#39;</span>)<span class="op">;</span></span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>())<span class="op">;</span></span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">static</span>(<span class="st">&#39;public&#39;</span>))<span class="op">;</span></span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Authentication middleware</span></span>
<span id="cb278-13"><a href="#cb278-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">authenticate</span>(req<span class="op">,</span> res<span class="op">,</span> next) {</span>
<span id="cb278-14"><a href="#cb278-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> authHeader <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="at">authorization</span><span class="op">;</span></span>
<span id="cb278-15"><a href="#cb278-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>authHeader<span class="op">?.</span><span class="fu">startsWith</span>(<span class="st">&#39;Bearer &#39;</span>)) {</span>
<span id="cb278-16"><a href="#cb278-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;No token provided&#39;</span> })<span class="op">;</span></span>
<span id="cb278-17"><a href="#cb278-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb278-18"><a href="#cb278-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-19"><a href="#cb278-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> authHeader<span class="op">.</span><span class="fu">slice</span>(<span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb278-20"><a href="#cb278-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb278-21"><a href="#cb278-21" aria-hidden="true" tabindex="-1"></a>    req<span class="op">.</span><span class="at">user</span> <span class="op">=</span> jwt<span class="op">.</span><span class="fu">verify</span>(token<span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span>)<span class="op">;</span></span>
<span id="cb278-22"><a href="#cb278-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">next</span>()<span class="op">;</span></span>
<span id="cb278-23"><a href="#cb278-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> {</span>
<span id="cb278-24"><a href="#cb278-24" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Invalid token&#39;</span> })<span class="op">;</span></span>
<span id="cb278-25"><a href="#cb278-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb278-26"><a href="#cb278-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb278-27"><a href="#cb278-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-28"><a href="#cb278-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Public routes</span></span>
<span id="cb278-29"><a href="#cb278-29" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/auth/login&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb278-30"><a href="#cb278-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { email<span class="op">,</span> password } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb278-31"><a href="#cb278-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-32"><a href="#cb278-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">findByEmail</span>(email)<span class="op">;</span></span>
<span id="cb278-33"><a href="#cb278-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>user <span class="op">||</span> <span class="op">!</span><span class="cf">await</span> bcrypt<span class="op">.</span><span class="fu">compare</span>(password<span class="op">,</span> user<span class="op">.</span><span class="at">password</span>)) {</span>
<span id="cb278-34"><a href="#cb278-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Invalid credentials&#39;</span> })<span class="op">;</span></span>
<span id="cb278-35"><a href="#cb278-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb278-36"><a href="#cb278-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-37"><a href="#cb278-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> accessToken <span class="op">=</span> jwt<span class="op">.</span><span class="fu">sign</span>(</span>
<span id="cb278-38"><a href="#cb278-38" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> user<span class="op">.</span><span class="at">email</span><span class="op">,</span> <span class="dt">role</span><span class="op">:</span> user<span class="op">.</span><span class="at">role</span> }<span class="op">,</span></span>
<span id="cb278-39"><a href="#cb278-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span><span class="op">,</span></span>
<span id="cb278-40"><a href="#cb278-40" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">expiresIn</span><span class="op">:</span> <span class="st">&#39;15m&#39;</span> }</span>
<span id="cb278-41"><a href="#cb278-41" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb278-42"><a href="#cb278-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-43"><a href="#cb278-43" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>({ accessToken<span class="op">,</span> <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> user<span class="op">.</span><span class="at">email</span> } })<span class="op">;</span></span>
<span id="cb278-44"><a href="#cb278-44" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb278-45"><a href="#cb278-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-46"><a href="#cb278-46" aria-hidden="true" tabindex="-1"></a><span class="co">// Protected routes</span></span>
<span id="cb278-47"><a href="#cb278-47" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb278-48"><a href="#cb278-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> users <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">findAll</span>()<span class="op">;</span></span>
<span id="cb278-49"><a href="#cb278-49" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(users)<span class="op">;</span></span>
<span id="cb278-50"><a href="#cb278-50" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb278-51"><a href="#cb278-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-52"><a href="#cb278-52" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb278-53"><a href="#cb278-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="at">users</span><span class="op">.</span><span class="fu">create</span>(req<span class="op">.</span><span class="at">body</span>)<span class="op">;</span></span>
<span id="cb278-54"><a href="#cb278-54" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>(user)<span class="op">;</span></span>
<span id="cb278-55"><a href="#cb278-55" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb278-56"><a href="#cb278-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-57"><a href="#cb278-57" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(<span class="dv">3000</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Server running on port 3000&#39;</span>))<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.2" id="python-with-flask"><span
class="header-section-number">13.2</span> Python with Flask</h2>
<p>Flask provides a lightweight Python backend:</p>
<div class="sourceCode" id="cb279"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app.py</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, jsonify, request</span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_cors <span class="im">import</span> CORS</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> wraps</span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>, static_folder<span class="op">=</span><span class="st">&#39;public&#39;</span>)</span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a>CORS(app)</span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> token_required(f):</span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@wraps</span>(f)</span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decorated(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb279-13"><a href="#cb279-13" aria-hidden="true" tabindex="-1"></a>        auth_header <span class="op">=</span> request.headers.get(<span class="st">&#39;Authorization&#39;</span>)</span>
<span id="cb279-14"><a href="#cb279-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> auth_header <span class="kw">or</span> <span class="kw">not</span> auth_header.startswith(<span class="st">&#39;Bearer &#39;</span>):</span>
<span id="cb279-15"><a href="#cb279-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> jsonify({<span class="st">&#39;error&#39;</span>: <span class="st">&#39;No token provided&#39;</span>}), <span class="dv">401</span></span>
<span id="cb279-16"><a href="#cb279-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-17"><a href="#cb279-17" aria-hidden="true" tabindex="-1"></a>        token <span class="op">=</span> auth_header[<span class="dv">7</span>:]</span>
<span id="cb279-18"><a href="#cb279-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb279-19"><a href="#cb279-19" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> jwt.decode(token, app.config[<span class="st">&#39;SECRET_KEY&#39;</span>], algorithms<span class="op">=</span>[<span class="st">&#39;HS256&#39;</span>])</span>
<span id="cb279-20"><a href="#cb279-20" aria-hidden="true" tabindex="-1"></a>            request.user <span class="op">=</span> data</span>
<span id="cb279-21"><a href="#cb279-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb279-22"><a href="#cb279-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> jsonify({<span class="st">&#39;error&#39;</span>: <span class="st">&#39;Invalid token&#39;</span>}), <span class="dv">401</span></span>
<span id="cb279-23"><a href="#cb279-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-24"><a href="#cb279-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb279-25"><a href="#cb279-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decorated</span>
<span id="cb279-26"><a href="#cb279-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-27"><a href="#cb279-27" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&#39;/api/users&#39;</span>)</span>
<span id="cb279-28"><a href="#cb279-28" aria-hidden="true" tabindex="-1"></a><span class="at">@token_required</span></span>
<span id="cb279-29"><a href="#cb279-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_users():</span>
<span id="cb279-30"><a href="#cb279-30" aria-hidden="true" tabindex="-1"></a>    users <span class="op">=</span> User.query.<span class="bu">all</span>()</span>
<span id="cb279-31"><a href="#cb279-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify([u.to_dict() <span class="cf">for</span> u <span class="kw">in</span> users])</span>
<span id="cb279-32"><a href="#cb279-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-33"><a href="#cb279-33" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&#39;/api/users&#39;</span>, methods<span class="op">=</span>[<span class="st">&#39;POST&#39;</span>])</span>
<span id="cb279-34"><a href="#cb279-34" aria-hidden="true" tabindex="-1"></a><span class="at">@token_required</span></span>
<span id="cb279-35"><a href="#cb279-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_user():</span>
<span id="cb279-36"><a href="#cb279-36" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> request.get_json()</span>
<span id="cb279-37"><a href="#cb279-37" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> User(<span class="op">**</span>data)</span>
<span id="cb279-38"><a href="#cb279-38" aria-hidden="true" tabindex="-1"></a>    db.session.add(user)</span>
<span id="cb279-39"><a href="#cb279-39" aria-hidden="true" tabindex="-1"></a>    db.session.commit()</span>
<span id="cb279-40"><a href="#cb279-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jsonify(user.to_dict()), <span class="dv">201</span></span>
<span id="cb279-41"><a href="#cb279-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-42"><a href="#cb279-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb279-43"><a href="#cb279-43" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<h2 data-number="13.3" id="php-integration"><span
class="header-section-number">13.3</span> PHP Integration</h2>
<p>PHP remains popular for web backends:</p>
<div class="sourceCode" id="cb280"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?php</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="co">// api.php</span></span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a><span class="fu">header</span>(<span class="st">&#39;Content-Type: application/json&#39;</span>)<span class="ot">;</span></span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Origin: *&#39;</span>)<span class="ot">;</span></span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a><span class="fu">header</span>(<span class="st">&#39;Access-Control-Allow-Headers: Content-Type, Authorization&#39;</span>)<span class="ot">;</span></span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a><span class="kw">require_once</span> <span class="st">&#39;vendor/autoload.php&#39;</span><span class="ot">;</span></span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> Firebase\<span class="cn">JWT</span>\<span class="cn">JWT</span><span class="ot">;</span></span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> Firebase\<span class="cn">JWT</span>\<span class="fu">Key</span><span class="ot">;</span></span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> authenticate() {</span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">$headers</span> <span class="op">=</span> <span class="fu">getallheaders</span>()<span class="ot">;</span></span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">$auth</span> <span class="op">=</span> <span class="va">$headers</span>[<span class="st">&#39;Authorization&#39;</span>] <span class="op">??</span> <span class="st">&#39;&#39;</span><span class="ot">;</span></span>
<span id="cb280-14"><a href="#cb280-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-15"><a href="#cb280-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">preg_match</span>(<span class="st">&#39;/Bearer\s+(.*)$/i&#39;</span><span class="ot">,</span> <span class="va">$auth</span><span class="ot">,</span> <span class="va">$matches</span>)) {</span>
<span id="cb280-16"><a href="#cb280-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">http_response_code</span>(<span class="dv">401</span>)<span class="ot">;</span></span>
<span id="cb280-17"><a href="#cb280-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">echo</span> <span class="fu">json_encode</span>([<span class="st">&#39;error&#39;</span> =&gt; <span class="st">&#39;No token provided&#39;</span>])<span class="ot">;</span></span>
<span id="cb280-18"><a href="#cb280-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">exit</span><span class="ot">;</span></span>
<span id="cb280-19"><a href="#cb280-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb280-20"><a href="#cb280-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-21"><a href="#cb280-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb280-22"><a href="#cb280-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">JWT</span>::decode(<span class="va">$matches</span>[<span class="dv">1</span>]<span class="ot">,</span> <span class="kw">new</span> <span class="fu">Key</span>(<span class="va">$_ENV</span>[<span class="st">&#39;JWT_SECRET&#39;</span>]<span class="ot">,</span> <span class="st">&#39;HS256&#39;</span>))<span class="ot">;</span></span>
<span id="cb280-23"><a href="#cb280-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (<span class="bu">Exception</span> <span class="va">$e</span>) {</span>
<span id="cb280-24"><a href="#cb280-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">http_response_code</span>(<span class="dv">401</span>)<span class="ot">;</span></span>
<span id="cb280-25"><a href="#cb280-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">echo</span> <span class="fu">json_encode</span>([<span class="st">&#39;error&#39;</span> =&gt; <span class="st">&#39;Invalid token&#39;</span>])<span class="ot">;</span></span>
<span id="cb280-26"><a href="#cb280-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">exit</span><span class="ot">;</span></span>
<span id="cb280-27"><a href="#cb280-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb280-28"><a href="#cb280-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-29"><a href="#cb280-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-30"><a href="#cb280-30" aria-hidden="true" tabindex="-1"></a><span class="va">$method</span> <span class="op">=</span> <span class="va">$_SERVER</span>[<span class="st">&#39;REQUEST_METHOD&#39;</span>]<span class="ot">;</span></span>
<span id="cb280-31"><a href="#cb280-31" aria-hidden="true" tabindex="-1"></a><span class="va">$path</span> <span class="op">=</span> <span class="fu">parse_url</span>(<span class="va">$_SERVER</span>[<span class="st">&#39;REQUEST_URI&#39;</span>]<span class="ot">,</span> <span class="cn">PHP_URL_PATH</span>)<span class="ot">;</span></span>
<span id="cb280-32"><a href="#cb280-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-33"><a href="#cb280-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="va">$path</span> <span class="op">===</span> <span class="st">&#39;/api/users&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">$method</span> <span class="op">===</span> <span class="st">&#39;GET&#39;</span>) {</span>
<span id="cb280-34"><a href="#cb280-34" aria-hidden="true" tabindex="-1"></a>    <span class="va">$user</span> <span class="op">=</span> authenticate()<span class="ot">;</span></span>
<span id="cb280-35"><a href="#cb280-35" aria-hidden="true" tabindex="-1"></a>    <span class="va">$users</span> <span class="op">=</span> <span class="va">$pdo</span>-&gt;query(<span class="st">&#39;SELECT id, name, email FROM users&#39;</span>)-&gt;fetchAll(<span class="bu">PDO</span>::<span class="cn">FETCH_ASSOC</span>)<span class="ot">;</span></span>
<span id="cb280-36"><a href="#cb280-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">echo</span> <span class="fu">json_encode</span>(<span class="va">$users</span>)<span class="ot">;</span></span>
<span id="cb280-37"><a href="#cb280-37" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="13.4" id="real-time-with-websockets"><span
class="header-section-number">13.4</span> Real-Time with WebSockets</h2>
<p>For real-time features, add WebSocket support. Here’s Node.js with
the <code>ws</code> library:</p>
<div class="sourceCode" id="cb281"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="co">// websocket-server.js</span></span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">WebSocket</span> <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ws&#39;</span>)<span class="op">;</span></span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> jwt <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;jsonwebtoken&#39;</span>)<span class="op">;</span></span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wss <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="fu">Server</span>({ <span class="dt">port</span><span class="op">:</span> <span class="dv">8080</span> })<span class="op">;</span></span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-7"><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> clients <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb281-8"><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-9"><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a>wss<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connection&#39;</span><span class="op">,</span> (ws<span class="op">,</span> req) <span class="kw">=&gt;</span> {</span>
<span id="cb281-10"><a href="#cb281-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Authenticate connection</span></span>
<span id="cb281-11"><a href="#cb281-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(req<span class="op">.</span><span class="at">url</span><span class="op">,</span> <span class="st">&#39;http://localhost&#39;</span>)<span class="op">;</span></span>
<span id="cb281-12"><a href="#cb281-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> url<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;token&#39;</span>)<span class="op">;</span></span>
<span id="cb281-13"><a href="#cb281-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-14"><a href="#cb281-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb281-15"><a href="#cb281-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> jwt<span class="op">.</span><span class="fu">verify</span>(token<span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span>)<span class="op">;</span></span>
<span id="cb281-16"><a href="#cb281-16" aria-hidden="true" tabindex="-1"></a>    clients<span class="op">.</span><span class="fu">set</span>(ws<span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb281-17"><a href="#cb281-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> {</span>
<span id="cb281-18"><a href="#cb281-18" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">close</span>(<span class="dv">4001</span><span class="op">,</span> <span class="st">&#39;Unauthorized&#39;</span>)<span class="op">;</span></span>
<span id="cb281-19"><a href="#cb281-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb281-20"><a href="#cb281-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb281-21"><a href="#cb281-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-22"><a href="#cb281-22" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb281-23"><a href="#cb281-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> message <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data)<span class="op">;</span></span>
<span id="cb281-24"><a href="#cb281-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">handleMessage</span>(ws<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb281-25"><a href="#cb281-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb281-26"><a href="#cb281-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-27"><a href="#cb281-27" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb281-28"><a href="#cb281-28" aria-hidden="true" tabindex="-1"></a>    clients<span class="op">.</span><span class="fu">delete</span>(ws)<span class="op">;</span></span>
<span id="cb281-29"><a href="#cb281-29" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb281-30"><a href="#cb281-30" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb281-31"><a href="#cb281-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-32"><a href="#cb281-32" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">handleMessage</span>(sender<span class="op">,</span> message) {</span>
<span id="cb281-33"><a href="#cb281-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (message<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb281-34"><a href="#cb281-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;broadcast&#39;</span><span class="op">:</span></span>
<span id="cb281-35"><a href="#cb281-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Send to all connected clients</span></span>
<span id="cb281-36"><a href="#cb281-36" aria-hidden="true" tabindex="-1"></a>      wss<span class="op">.</span><span class="at">clients</span><span class="op">.</span><span class="fu">forEach</span>(client <span class="kw">=&gt;</span> {</span>
<span id="cb281-37"><a href="#cb281-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (client<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb281-38"><a href="#cb281-38" aria-hidden="true" tabindex="-1"></a>          client<span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(message))<span class="op">;</span></span>
<span id="cb281-39"><a href="#cb281-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb281-40"><a href="#cb281-40" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb281-41"><a href="#cb281-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb281-42"><a href="#cb281-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-43"><a href="#cb281-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;direct&#39;</span><span class="op">:</span></span>
<span id="cb281-44"><a href="#cb281-44" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Send to specific user</span></span>
<span id="cb281-45"><a href="#cb281-45" aria-hidden="true" tabindex="-1"></a>      clients<span class="op">.</span><span class="fu">forEach</span>((user<span class="op">,</span> client) <span class="kw">=&gt;</span> {</span>
<span id="cb281-46"><a href="#cb281-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (user<span class="op">.</span><span class="at">id</span> <span class="op">===</span> message<span class="op">.</span><span class="at">targetUserId</span> <span class="op">&amp;&amp;</span> client<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb281-47"><a href="#cb281-47" aria-hidden="true" tabindex="-1"></a>          client<span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(message))<span class="op">;</span></span>
<span id="cb281-48"><a href="#cb281-48" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb281-49"><a href="#cb281-49" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb281-50"><a href="#cb281-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb281-51"><a href="#cb281-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb281-52"><a href="#cb281-52" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="13.5" id="database-patterns"><span
class="header-section-number">13.5</span> Database Patterns</h2>
<p>Most backends need a database. Here’s a clean repository pattern:</p>
<div class="sourceCode" id="cb282"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="co">// user-repository.js</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserRepository {</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(db) {</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> db<span class="op">;</span></span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-7"><a href="#cb282-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">findAll</span>() {</span>
<span id="cb282-8"><a href="#cb282-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">query</span>(<span class="st">&#39;SELECT id, name, email FROM users&#39;</span>)<span class="op">;</span></span>
<span id="cb282-9"><a href="#cb282-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-10"><a href="#cb282-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-11"><a href="#cb282-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">findById</span>(id) {</span>
<span id="cb282-12"><a href="#cb282-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [user] <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb282-13"><a href="#cb282-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SELECT id, name, email FROM users WHERE id = ?&#39;</span><span class="op">,</span></span>
<span id="cb282-14"><a href="#cb282-14" aria-hidden="true" tabindex="-1"></a>      [id]</span>
<span id="cb282-15"><a href="#cb282-15" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb282-16"><a href="#cb282-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb282-17"><a href="#cb282-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-18"><a href="#cb282-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-19"><a href="#cb282-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">create</span>(data) {</span>
<span id="cb282-20"><a href="#cb282-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb282-21"><a href="#cb282-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;INSERT INTO users (name, email, password) VALUES (?, ?, ?)&#39;</span><span class="op">,</span></span>
<span id="cb282-22"><a href="#cb282-22" aria-hidden="true" tabindex="-1"></a>      [data<span class="op">.</span><span class="at">name</span><span class="op">,</span> data<span class="op">.</span><span class="at">email</span><span class="op">,</span> data<span class="op">.</span><span class="at">hashedPassword</span>]</span>
<span id="cb282-23"><a href="#cb282-23" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb282-24"><a href="#cb282-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">findById</span>(result<span class="op">.</span><span class="at">insertId</span>)<span class="op">;</span></span>
<span id="cb282-25"><a href="#cb282-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-26"><a href="#cb282-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-27"><a href="#cb282-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">update</span>(id<span class="op">,</span> data) {</span>
<span id="cb282-28"><a href="#cb282-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb282-29"><a href="#cb282-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;UPDATE users SET name = ?, email = ? WHERE id = ?&#39;</span><span class="op">,</span></span>
<span id="cb282-30"><a href="#cb282-30" aria-hidden="true" tabindex="-1"></a>      [data<span class="op">.</span><span class="at">name</span><span class="op">,</span> data<span class="op">.</span><span class="at">email</span><span class="op">,</span> id]</span>
<span id="cb282-31"><a href="#cb282-31" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb282-32"><a href="#cb282-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">findById</span>(id)<span class="op">;</span></span>
<span id="cb282-33"><a href="#cb282-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-34"><a href="#cb282-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-35"><a href="#cb282-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">delete</span>(id) {</span>
<span id="cb282-36"><a href="#cb282-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">query</span>(<span class="st">&#39;DELETE FROM users WHERE id = ?&#39;</span><span class="op">,</span> [id])<span class="op">;</span></span>
<span id="cb282-37"><a href="#cb282-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb282-38"><a href="#cb282-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="13.6" id="complete-crud-api-example"><span
class="header-section-number">13.6</span> Complete CRUD API Example</h2>
<p>Let’s build a complete REST API for a todo application with full CRUD
operations:</p>
<h3 data-number="13.6.1" id="express-backend-with-sqlite"><span
class="header-section-number">13.6.1</span> Express Backend with
SQLite</h3>
<div class="sourceCode" id="cb283"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co">// server/app.js</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;cors&#39;</span>)<span class="op">;</span></span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sqlite3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;sqlite3&#39;</span>)<span class="op">.</span><span class="fu">verbose</span>()<span class="op">;</span></span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { open } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;sqlite&#39;</span>)<span class="op">;</span></span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>())<span class="op">;</span></span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Database setup</span></span>
<span id="cb283-12"><a href="#cb283-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> db<span class="op">;</span></span>
<span id="cb283-13"><a href="#cb283-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb283-14"><a href="#cb283-14" aria-hidden="true" tabindex="-1"></a>  db <span class="op">=</span> <span class="cf">await</span> <span class="fu">open</span>({</span>
<span id="cb283-15"><a href="#cb283-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">filename</span><span class="op">:</span> <span class="st">&#39;./database.sqlite&#39;</span><span class="op">,</span></span>
<span id="cb283-16"><a href="#cb283-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">driver</span><span class="op">:</span> sqlite3<span class="op">.</span><span class="at">Database</span></span>
<span id="cb283-17"><a href="#cb283-17" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb283-18"><a href="#cb283-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-19"><a href="#cb283-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> db<span class="op">.</span><span class="fu">exec</span>(<span class="vs">`</span></span>
<span id="cb283-20"><a href="#cb283-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    CREATE TABLE IF NOT EXISTS todos (</span></span>
<span id="cb283-21"><a href="#cb283-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      id INTEGER PRIMARY KEY AUTOINCREMENT,</span></span>
<span id="cb283-22"><a href="#cb283-22" aria-hidden="true" tabindex="-1"></a><span class="vs">      title TEXT NOT NULL,</span></span>
<span id="cb283-23"><a href="#cb283-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      completed BOOLEAN DEFAULT 0,</span></span>
<span id="cb283-24"><a href="#cb283-24" aria-hidden="true" tabindex="-1"></a><span class="vs">      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,</span></span>
<span id="cb283-25"><a href="#cb283-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP</span></span>
<span id="cb283-26"><a href="#cb283-26" aria-hidden="true" tabindex="-1"></a><span class="vs">    )</span></span>
<span id="cb283-27"><a href="#cb283-27" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb283-28"><a href="#cb283-28" aria-hidden="true" tabindex="-1"></a>})()<span class="op">;</span></span>
<span id="cb283-29"><a href="#cb283-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-30"><a href="#cb283-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Get all todos</span></span>
<span id="cb283-31"><a href="#cb283-31" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/todos&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb283-32"><a href="#cb283-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb283-33"><a href="#cb283-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> todos <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">all</span>(<span class="st">&#39;SELECT * FROM todos ORDER BY created_at DESC&#39;</span>)<span class="op">;</span></span>
<span id="cb283-34"><a href="#cb283-34" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>(todos)<span class="op">;</span></span>
<span id="cb283-35"><a href="#cb283-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb283-36"><a href="#cb283-36" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb283-37"><a href="#cb283-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-38"><a href="#cb283-38" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-39"><a href="#cb283-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-40"><a href="#cb283-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Get single todo</span></span>
<span id="cb283-41"><a href="#cb283-41" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/todos/:id&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb283-42"><a href="#cb283-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb283-43"><a href="#cb283-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> todo <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SELECT * FROM todos WHERE id = ?&#39;</span><span class="op">,</span> req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb283-44"><a href="#cb283-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>todo) {</span>
<span id="cb283-45"><a href="#cb283-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Todo not found&#39;</span> })<span class="op">;</span></span>
<span id="cb283-46"><a href="#cb283-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb283-47"><a href="#cb283-47" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>(todo)<span class="op">;</span></span>
<span id="cb283-48"><a href="#cb283-48" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb283-49"><a href="#cb283-49" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb283-50"><a href="#cb283-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-51"><a href="#cb283-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-52"><a href="#cb283-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-53"><a href="#cb283-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Create todo</span></span>
<span id="cb283-54"><a href="#cb283-54" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/todos&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb283-55"><a href="#cb283-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb283-56"><a href="#cb283-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { title } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb283-57"><a href="#cb283-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>title) {</span>
<span id="cb283-58"><a href="#cb283-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Title is required&#39;</span> })<span class="op">;</span></span>
<span id="cb283-59"><a href="#cb283-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb283-60"><a href="#cb283-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-61"><a href="#cb283-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">run</span>(</span>
<span id="cb283-62"><a href="#cb283-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;INSERT INTO todos (title) VALUES (?)&#39;</span><span class="op">,</span></span>
<span id="cb283-63"><a href="#cb283-63" aria-hidden="true" tabindex="-1"></a>      title</span>
<span id="cb283-64"><a href="#cb283-64" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb283-65"><a href="#cb283-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-66"><a href="#cb283-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> todo <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SELECT * FROM todos WHERE id = ?&#39;</span><span class="op">,</span> result<span class="op">.</span><span class="at">lastID</span>)<span class="op">;</span></span>
<span id="cb283-67"><a href="#cb283-67" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>(todo)<span class="op">;</span></span>
<span id="cb283-68"><a href="#cb283-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb283-69"><a href="#cb283-69" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb283-70"><a href="#cb283-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-71"><a href="#cb283-71" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-72"><a href="#cb283-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-73"><a href="#cb283-73" aria-hidden="true" tabindex="-1"></a><span class="co">// Update todo</span></span>
<span id="cb283-74"><a href="#cb283-74" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">put</span>(<span class="st">&#39;/api/todos/:id&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb283-75"><a href="#cb283-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb283-76"><a href="#cb283-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { title<span class="op">,</span> completed } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb283-77"><a href="#cb283-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-78"><a href="#cb283-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">run</span>(</span>
<span id="cb283-79"><a href="#cb283-79" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;UPDATE todos SET title = ?, completed = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?&#39;</span><span class="op">,</span></span>
<span id="cb283-80"><a href="#cb283-80" aria-hidden="true" tabindex="-1"></a>      title<span class="op">,</span></span>
<span id="cb283-81"><a href="#cb283-81" aria-hidden="true" tabindex="-1"></a>      completed <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb283-82"><a href="#cb283-82" aria-hidden="true" tabindex="-1"></a>      req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span></span>
<span id="cb283-83"><a href="#cb283-83" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb283-84"><a href="#cb283-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-85"><a href="#cb283-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> todo <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SELECT * FROM todos WHERE id = ?&#39;</span><span class="op">,</span> req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb283-86"><a href="#cb283-86" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>(todo)<span class="op">;</span></span>
<span id="cb283-87"><a href="#cb283-87" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb283-88"><a href="#cb283-88" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb283-89"><a href="#cb283-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-90"><a href="#cb283-90" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-91"><a href="#cb283-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-92"><a href="#cb283-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Delete todo</span></span>
<span id="cb283-93"><a href="#cb283-93" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">delete</span>(<span class="st">&#39;/api/todos/:id&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb283-94"><a href="#cb283-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb283-95"><a href="#cb283-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> db<span class="op">.</span><span class="fu">run</span>(<span class="st">&#39;DELETE FROM todos WHERE id = ?&#39;</span><span class="op">,</span> req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb283-96"><a href="#cb283-96" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">204</span>)<span class="op">.</span><span class="fu">send</span>()<span class="op">;</span></span>
<span id="cb283-97"><a href="#cb283-97" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb283-98"><a href="#cb283-98" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb283-99"><a href="#cb283-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-100"><a href="#cb283-100" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-101"><a href="#cb283-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-102"><a href="#cb283-102" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(<span class="dv">3000</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Server running on http://localhost:3000&#39;</span>))<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.6.2" id="frontend-integration"><span
class="header-section-number">13.6.2</span> Frontend Integration</h3>
<div class="sourceCode" id="cb284"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="co">// frontend/services/todo-service.js</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoService {</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(baseUrl <span class="op">=</span> <span class="st">&#39;http://localhost:3000/api&#39;</span>) {</span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span> <span class="op">=</span> baseUrl<span class="op">;</span></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getAll</span>() {</span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/todos`</span>)<span class="op">;</span></span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to fetch todos&#39;</span>)<span class="op">;</span></span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">create</span>(title) {</span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/todos`</span><span class="op">,</span> {</span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ title })</span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to create todo&#39;</span>)<span class="op">;</span></span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb284-21"><a href="#cb284-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-22"><a href="#cb284-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-23"><a href="#cb284-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">update</span>(id<span class="op">,</span> updates) {</span>
<span id="cb284-24"><a href="#cb284-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/todos/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb284-25"><a href="#cb284-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;PUT&#39;</span><span class="op">,</span></span>
<span id="cb284-26"><a href="#cb284-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb284-27"><a href="#cb284-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(updates)</span>
<span id="cb284-28"><a href="#cb284-28" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb284-29"><a href="#cb284-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to update todo&#39;</span>)<span class="op">;</span></span>
<span id="cb284-30"><a href="#cb284-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb284-31"><a href="#cb284-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-32"><a href="#cb284-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-33"><a href="#cb284-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="kw">delete</span>(id) {</span>
<span id="cb284-34"><a href="#cb284-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/todos/</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb284-35"><a href="#cb284-35" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;DELETE&#39;</span></span>
<span id="cb284-36"><a href="#cb284-36" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb284-37"><a href="#cb284-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Failed to delete todo&#39;</span>)<span class="op">;</span></span>
<span id="cb284-38"><a href="#cb284-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-39"><a href="#cb284-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb284-40"><a href="#cb284-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-41"><a href="#cb284-41" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> todoService <span class="op">=</span> <span class="kw">new</span> <span class="fu">TodoService</span>()<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.7" id="using-orms"><span
class="header-section-number">13.7</span> Using ORMs</h2>
<p>Object-Relational Mappers simplify database operations. Here’s Prisma
(Node.js) and SQLAlchemy (Python):</p>
<h3 data-number="13.7.1" id="prisma-node.js"><span
class="header-section-number">13.7.1</span> Prisma (Node.js)</h3>
<div class="sourceCode" id="cb285"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co">// prisma/schema.prisma</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>datasource db {</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>  provider <span class="op">=</span> <span class="st">&quot;postgresql&quot;</span></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>  url      <span class="op">=</span> <span class="fu">env</span>(<span class="st">&quot;DATABASE_URL&quot;</span>)</span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb285-6"><a href="#cb285-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-7"><a href="#cb285-7" aria-hidden="true" tabindex="-1"></a>generator client {</span>
<span id="cb285-8"><a href="#cb285-8" aria-hidden="true" tabindex="-1"></a>  provider <span class="op">=</span> <span class="st">&quot;prisma-client-js&quot;</span></span>
<span id="cb285-9"><a href="#cb285-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb285-10"><a href="#cb285-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-11"><a href="#cb285-11" aria-hidden="true" tabindex="-1"></a>model User {</span>
<span id="cb285-12"><a href="#cb285-12" aria-hidden="true" tabindex="-1"></a>  id        Int      @id @<span class="fu">default</span>(<span class="fu">autoincrement</span>())</span>
<span id="cb285-13"><a href="#cb285-13" aria-hidden="true" tabindex="-1"></a>  email     <span class="bu">String</span>   @unique</span>
<span id="cb285-14"><a href="#cb285-14" aria-hidden="true" tabindex="-1"></a>  name      <span class="bu">String</span><span class="op">?</span></span>
<span id="cb285-15"><a href="#cb285-15" aria-hidden="true" tabindex="-1"></a>  posts     Post[]</span>
<span id="cb285-16"><a href="#cb285-16" aria-hidden="true" tabindex="-1"></a>  createdAt DateTime @<span class="fu">default</span>(<span class="fu">now</span>())</span>
<span id="cb285-17"><a href="#cb285-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb285-18"><a href="#cb285-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-19"><a href="#cb285-19" aria-hidden="true" tabindex="-1"></a>model Post {</span>
<span id="cb285-20"><a href="#cb285-20" aria-hidden="true" tabindex="-1"></a>  id        Int      @id @<span class="fu">default</span>(<span class="fu">autoincrement</span>())</span>
<span id="cb285-21"><a href="#cb285-21" aria-hidden="true" tabindex="-1"></a>  title     <span class="bu">String</span></span>
<span id="cb285-22"><a href="#cb285-22" aria-hidden="true" tabindex="-1"></a>  content   <span class="bu">String</span><span class="op">?</span></span>
<span id="cb285-23"><a href="#cb285-23" aria-hidden="true" tabindex="-1"></a>  published <span class="bu">Boolean</span>  @<span class="fu">default</span>(<span class="kw">false</span>)</span>
<span id="cb285-24"><a href="#cb285-24" aria-hidden="true" tabindex="-1"></a>  author    User     @<span class="fu">relation</span>(<span class="dt">fields</span><span class="op">:</span> [authorId]<span class="op">,</span> <span class="dt">references</span><span class="op">:</span> [id])</span>
<span id="cb285-25"><a href="#cb285-25" aria-hidden="true" tabindex="-1"></a>  authorId  Int</span>
<span id="cb285-26"><a href="#cb285-26" aria-hidden="true" tabindex="-1"></a>  createdAt DateTime @<span class="fu">default</span>(<span class="fu">now</span>())</span>
<span id="cb285-27"><a href="#cb285-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb286"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="co">// server/routes/posts.js</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { PrismaClient } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;@prisma/client&#39;</span>)<span class="op">;</span></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> prisma <span class="op">=</span> <span class="kw">new</span> <span class="fu">PrismaClient</span>()<span class="op">;</span></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/posts&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> posts <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">include</span><span class="op">:</span> {</span>
<span id="cb286-8"><a href="#cb286-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">author</span><span class="op">:</span> {</span>
<span id="cb286-9"><a href="#cb286-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">select</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb286-10"><a href="#cb286-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb286-11"><a href="#cb286-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb286-12"><a href="#cb286-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">orderBy</span><span class="op">:</span> { <span class="dt">createdAt</span><span class="op">:</span> <span class="st">&#39;desc&#39;</span> }</span>
<span id="cb286-13"><a href="#cb286-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb286-14"><a href="#cb286-14" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(posts)<span class="op">;</span></span>
<span id="cb286-15"><a href="#cb286-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb286-16"><a href="#cb286-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-17"><a href="#cb286-17" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/posts&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb286-18"><a href="#cb286-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { title<span class="op">,</span> content } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb286-19"><a href="#cb286-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-20"><a href="#cb286-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> post <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb286-21"><a href="#cb286-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">data</span><span class="op">:</span> {</span>
<span id="cb286-22"><a href="#cb286-22" aria-hidden="true" tabindex="-1"></a>      title<span class="op">,</span></span>
<span id="cb286-23"><a href="#cb286-23" aria-hidden="true" tabindex="-1"></a>      content<span class="op">,</span></span>
<span id="cb286-24"><a href="#cb286-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">author</span><span class="op">:</span> {</span>
<span id="cb286-25"><a href="#cb286-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">connect</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span> }</span>
<span id="cb286-26"><a href="#cb286-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb286-27"><a href="#cb286-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb286-28"><a href="#cb286-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">include</span><span class="op">:</span> { <span class="dt">author</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb286-29"><a href="#cb286-29" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb286-30"><a href="#cb286-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-31"><a href="#cb286-31" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>(post)<span class="op">;</span></span>
<span id="cb286-32"><a href="#cb286-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb286-33"><a href="#cb286-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-34"><a href="#cb286-34" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">put</span>(<span class="st">&#39;/api/posts/:id&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb286-35"><a href="#cb286-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { id } <span class="op">=</span> req<span class="op">.</span><span class="at">params</span><span class="op">;</span></span>
<span id="cb286-36"><a href="#cb286-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { title<span class="op">,</span> content<span class="op">,</span> published } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb286-37"><a href="#cb286-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-38"><a href="#cb286-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check ownership</span></span>
<span id="cb286-39"><a href="#cb286-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> post <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">findUnique</span>({</span>
<span id="cb286-40"><a href="#cb286-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">where</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="pp">parseInt</span>(id) }</span>
<span id="cb286-41"><a href="#cb286-41" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb286-42"><a href="#cb286-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-43"><a href="#cb286-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (post<span class="op">.</span><span class="at">authorId</span> <span class="op">!==</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span>) {</span>
<span id="cb286-44"><a href="#cb286-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">403</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Forbidden&#39;</span> })<span class="op">;</span></span>
<span id="cb286-45"><a href="#cb286-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb286-46"><a href="#cb286-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-47"><a href="#cb286-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> updated <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">update</span>({</span>
<span id="cb286-48"><a href="#cb286-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">where</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> <span class="pp">parseInt</span>(id) }<span class="op">,</span></span>
<span id="cb286-49"><a href="#cb286-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">data</span><span class="op">:</span> { title<span class="op">,</span> content<span class="op">,</span> published }<span class="op">,</span></span>
<span id="cb286-50"><a href="#cb286-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">include</span><span class="op">:</span> { <span class="dt">author</span><span class="op">:</span> <span class="kw">true</span> }</span>
<span id="cb286-51"><a href="#cb286-51" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb286-52"><a href="#cb286-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-53"><a href="#cb286-53" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(updated)<span class="op">;</span></span>
<span id="cb286-54"><a href="#cb286-54" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.7.2" id="sqlalchemy-python"><span
class="header-section-number">13.7.2</span> SQLAlchemy (Python)</h3>
<div class="sourceCode" id="cb287"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="co"># models.py</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> Column, Integer, String, Text, Boolean, DateTime, ForeignKey</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.orm <span class="im">import</span> relationship</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> database <span class="im">import</span> Base</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(Base):</span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;users&quot;</span></span>
<span id="cb287-9"><a href="#cb287-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-10"><a href="#cb287-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> Column(Integer, primary_key<span class="op">=</span><span class="va">True</span>, index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb287-11"><a href="#cb287-11" aria-hidden="true" tabindex="-1"></a>    email <span class="op">=</span> Column(String, unique<span class="op">=</span><span class="va">True</span>, index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb287-12"><a href="#cb287-12" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> Column(String)</span>
<span id="cb287-13"><a href="#cb287-13" aria-hidden="true" tabindex="-1"></a>    hashed_password <span class="op">=</span> Column(String)</span>
<span id="cb287-14"><a href="#cb287-14" aria-hidden="true" tabindex="-1"></a>    posts <span class="op">=</span> relationship(<span class="st">&quot;Post&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;author&quot;</span>)</span>
<span id="cb287-15"><a href="#cb287-15" aria-hidden="true" tabindex="-1"></a>    created_at <span class="op">=</span> Column(DateTime, default<span class="op">=</span>datetime.utcnow)</span>
<span id="cb287-16"><a href="#cb287-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-17"><a href="#cb287-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Post(Base):</span>
<span id="cb287-18"><a href="#cb287-18" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;posts&quot;</span></span>
<span id="cb287-19"><a href="#cb287-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-20"><a href="#cb287-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> Column(Integer, primary_key<span class="op">=</span><span class="va">True</span>, index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb287-21"><a href="#cb287-21" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> Column(String, index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb287-22"><a href="#cb287-22" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> Column(Text)</span>
<span id="cb287-23"><a href="#cb287-23" aria-hidden="true" tabindex="-1"></a>    published <span class="op">=</span> Column(Boolean, default<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb287-24"><a href="#cb287-24" aria-hidden="true" tabindex="-1"></a>    author_id <span class="op">=</span> Column(Integer, ForeignKey(<span class="st">&quot;users.id&quot;</span>))</span>
<span id="cb287-25"><a href="#cb287-25" aria-hidden="true" tabindex="-1"></a>    author <span class="op">=</span> relationship(<span class="st">&quot;User&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;posts&quot;</span>)</span>
<span id="cb287-26"><a href="#cb287-26" aria-hidden="true" tabindex="-1"></a>    created_at <span class="op">=</span> Column(DateTime, default<span class="op">=</span>datetime.utcnow)</span>
<span id="cb287-27"><a href="#cb287-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-28"><a href="#cb287-28" aria-hidden="true" tabindex="-1"></a><span class="co"># routes.py</span></span>
<span id="cb287-29"><a href="#cb287-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI, Depends, HTTPException</span>
<span id="cb287-30"><a href="#cb287-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.orm <span class="im">import</span> Session</span>
<span id="cb287-31"><a href="#cb287-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb287-32"><a href="#cb287-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> models, schemas</span>
<span id="cb287-33"><a href="#cb287-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> database <span class="im">import</span> get_db</span>
<span id="cb287-34"><a href="#cb287-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-35"><a href="#cb287-35" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI()</span>
<span id="cb287-36"><a href="#cb287-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-37"><a href="#cb287-37" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">&quot;/api/posts&quot;</span>, response_model<span class="op">=</span>List[schemas.Post])</span>
<span id="cb287-38"><a href="#cb287-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_posts(db: Session <span class="op">=</span> Depends(get_db)):</span>
<span id="cb287-39"><a href="#cb287-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> db.query(models.Post).order_by(models.Post.created_at.desc()).<span class="bu">all</span>()</span>
<span id="cb287-40"><a href="#cb287-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-41"><a href="#cb287-41" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">&quot;/api/posts&quot;</span>, response_model<span class="op">=</span>schemas.Post)</span>
<span id="cb287-42"><a href="#cb287-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_post(post: schemas.PostCreate, db: Session <span class="op">=</span> Depends(get_db), user<span class="op">=</span>Depends(get_current_user)):</span>
<span id="cb287-43"><a href="#cb287-43" aria-hidden="true" tabindex="-1"></a>    db_post <span class="op">=</span> models.Post(<span class="op">**</span>post.<span class="bu">dict</span>(), author_id<span class="op">=</span>user.<span class="bu">id</span>)</span>
<span id="cb287-44"><a href="#cb287-44" aria-hidden="true" tabindex="-1"></a>    db.add(db_post)</span>
<span id="cb287-45"><a href="#cb287-45" aria-hidden="true" tabindex="-1"></a>    db.commit()</span>
<span id="cb287-46"><a href="#cb287-46" aria-hidden="true" tabindex="-1"></a>    db.refresh(db_post)</span>
<span id="cb287-47"><a href="#cb287-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> db_post</span>
<span id="cb287-48"><a href="#cb287-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-49"><a href="#cb287-49" aria-hidden="true" tabindex="-1"></a><span class="at">@app.put</span>(<span class="st">&quot;/api/posts/</span><span class="sc">{post_id}</span><span class="st">&quot;</span>, response_model<span class="op">=</span>schemas.Post)</span>
<span id="cb287-50"><a href="#cb287-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_post(post_id: <span class="bu">int</span>, post: schemas.PostUpdate, db: Session <span class="op">=</span> Depends(get_db), user<span class="op">=</span>Depends(get_current_user)):</span>
<span id="cb287-51"><a href="#cb287-51" aria-hidden="true" tabindex="-1"></a>    db_post <span class="op">=</span> db.query(models.Post).<span class="bu">filter</span>(models.Post.<span class="bu">id</span> <span class="op">==</span> post_id).first()</span>
<span id="cb287-52"><a href="#cb287-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> db_post:</span>
<span id="cb287-53"><a href="#cb287-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">404</span>, detail<span class="op">=</span><span class="st">&quot;Post not found&quot;</span>)</span>
<span id="cb287-54"><a href="#cb287-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> db_post.author_id <span class="op">!=</span> user.<span class="bu">id</span>:</span>
<span id="cb287-55"><a href="#cb287-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">403</span>, detail<span class="op">=</span><span class="st">&quot;Not authorized&quot;</span>)</span>
<span id="cb287-56"><a href="#cb287-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-57"><a href="#cb287-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> post.<span class="bu">dict</span>(exclude_unset<span class="op">=</span><span class="va">True</span>).items():</span>
<span id="cb287-58"><a href="#cb287-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">setattr</span>(db_post, key, value)</span>
<span id="cb287-59"><a href="#cb287-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-60"><a href="#cb287-60" aria-hidden="true" tabindex="-1"></a>    db.commit()</span>
<span id="cb287-61"><a href="#cb287-61" aria-hidden="true" tabindex="-1"></a>    db.refresh(db_post)</span>
<span id="cb287-62"><a href="#cb287-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> db_post</span></code></pre></div>
<h2 data-number="13.8" id="file-upload-and-download"><span
class="header-section-number">13.8</span> File Upload and Download</h2>
<p>Handle file uploads from LARC components:</p>
<h3 data-number="13.8.1" id="express-file-upload"><span
class="header-section-number">13.8.1</span> Express File Upload</h3>
<div class="sourceCode" id="cb288"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co">// server.js</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> multer <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;multer&#39;</span>)<span class="op">;</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> path <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Configure storage</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> storage <span class="op">=</span> multer<span class="op">.</span><span class="fu">diskStorage</span>({</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">destination</span><span class="op">:</span> (req<span class="op">,</span> file<span class="op">,</span> cb) <span class="kw">=&gt;</span> {</span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="st">&#39;uploads/&#39;</span>)<span class="op">;</span></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">filename</span><span class="op">:</span> (req<span class="op">,</span> file<span class="op">,</span> cb) <span class="kw">=&gt;</span> {</span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> uniqueSuffix <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">+</span> <span class="st">&#39;-&#39;</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="fl">1E9</span>)<span class="op">;</span></span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cb</span>(<span class="kw">null</span><span class="op">,</span> uniqueSuffix <span class="op">+</span> path<span class="op">.</span><span class="fu">extname</span>(file<span class="op">.</span><span class="at">originalname</span>))<span class="op">;</span></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> upload <span class="op">=</span> <span class="fu">multer</span>({</span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a>  storage<span class="op">,</span></span>
<span id="cb288-18"><a href="#cb288-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">limits</span><span class="op">:</span> { <span class="dt">fileSize</span><span class="op">:</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> }<span class="op">,</span> <span class="co">// 5MB</span></span>
<span id="cb288-19"><a href="#cb288-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileFilter</span><span class="op">:</span> (req<span class="op">,</span> file<span class="op">,</span> cb) <span class="kw">=&gt;</span> {</span>
<span id="cb288-20"><a href="#cb288-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> allowedTypes <span class="op">=</span> <span class="ss">/jpeg</span><span class="sc">|</span><span class="ss">jpg</span><span class="sc">|</span><span class="ss">png</span><span class="sc">|</span><span class="ss">gif</span><span class="sc">|</span><span class="ss">pdf/</span><span class="op">;</span></span>
<span id="cb288-21"><a href="#cb288-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> extname <span class="op">=</span> allowedTypes<span class="op">.</span><span class="fu">test</span>(path<span class="op">.</span><span class="fu">extname</span>(file<span class="op">.</span><span class="at">originalname</span>)<span class="op">.</span><span class="fu">toLowerCase</span>())<span class="op">;</span></span>
<span id="cb288-22"><a href="#cb288-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> mimetype <span class="op">=</span> allowedTypes<span class="op">.</span><span class="fu">test</span>(file<span class="op">.</span><span class="at">mimetype</span>)<span class="op">;</span></span>
<span id="cb288-23"><a href="#cb288-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-24"><a href="#cb288-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mimetype <span class="op">&amp;&amp;</span> extname) {</span>
<span id="cb288-25"><a href="#cb288-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb288-26"><a href="#cb288-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb288-27"><a href="#cb288-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cb</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Invalid file type&#39;</span>))<span class="op">;</span></span>
<span id="cb288-28"><a href="#cb288-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-29"><a href="#cb288-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb288-30"><a href="#cb288-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-31"><a href="#cb288-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Upload endpoint</span></span>
<span id="cb288-32"><a href="#cb288-32" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/upload&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> upload<span class="op">.</span><span class="fu">single</span>(<span class="st">&#39;file&#39;</span>)<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb288-33"><a href="#cb288-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>req<span class="op">.</span><span class="at">file</span>) {</span>
<span id="cb288-34"><a href="#cb288-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">400</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;No file uploaded&#39;</span> })<span class="op">;</span></span>
<span id="cb288-35"><a href="#cb288-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-36"><a href="#cb288-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-37"><a href="#cb288-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Save file metadata to database</span></span>
<span id="cb288-38"><a href="#cb288-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="at">files</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb288-39"><a href="#cb288-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">userId</span><span class="op">:</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb288-40"><a href="#cb288-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">filename</span><span class="op">:</span> req<span class="op">.</span><span class="at">file</span><span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb288-41"><a href="#cb288-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">originalName</span><span class="op">:</span> req<span class="op">.</span><span class="at">file</span><span class="op">.</span><span class="at">originalname</span><span class="op">,</span></span>
<span id="cb288-42"><a href="#cb288-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">mimetype</span><span class="op">:</span> req<span class="op">.</span><span class="at">file</span><span class="op">.</span><span class="at">mimetype</span><span class="op">,</span></span>
<span id="cb288-43"><a href="#cb288-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size</span><span class="op">:</span> req<span class="op">.</span><span class="at">file</span><span class="op">.</span><span class="at">size</span><span class="op">,</span></span>
<span id="cb288-44"><a href="#cb288-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">path</span><span class="op">:</span> req<span class="op">.</span><span class="at">file</span><span class="op">.</span><span class="at">path</span></span>
<span id="cb288-45"><a href="#cb288-45" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb288-46"><a href="#cb288-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-47"><a href="#cb288-47" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb288-48"><a href="#cb288-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> file<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb288-49"><a href="#cb288-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">filename</span><span class="op">:</span> file<span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb288-50"><a href="#cb288-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">url</span><span class="op">:</span> <span class="vs">`/uploads/</span><span class="sc">${</span>file<span class="op">.</span><span class="at">filename</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb288-51"><a href="#cb288-51" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb288-52"><a href="#cb288-52" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb288-53"><a href="#cb288-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-54"><a href="#cb288-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Download endpoint</span></span>
<span id="cb288-55"><a href="#cb288-55" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/files/:id/download&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb288-56"><a href="#cb288-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> file <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="at">files</span><span class="op">.</span><span class="fu">findById</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb288-57"><a href="#cb288-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-58"><a href="#cb288-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>file) {</span>
<span id="cb288-59"><a href="#cb288-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;File not found&#39;</span> })<span class="op">;</span></span>
<span id="cb288-60"><a href="#cb288-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb288-61"><a href="#cb288-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-62"><a href="#cb288-62" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">download</span>(file<span class="op">.</span><span class="at">path</span><span class="op">,</span> file<span class="op">.</span><span class="at">originalName</span>)<span class="op">;</span></span>
<span id="cb288-63"><a href="#cb288-63" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb288-64"><a href="#cb288-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-65"><a href="#cb288-65" aria-hidden="true" tabindex="-1"></a><span class="co">// Serve uploaded files</span></span>
<span id="cb288-66"><a href="#cb288-66" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="st">&#39;/uploads&#39;</span><span class="op">,</span> express<span class="op">.</span><span class="fu">static</span>(<span class="st">&#39;uploads&#39;</span>))<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.8.2" id="frontend-upload-component"><span
class="header-section-number">13.8.2</span> Frontend Upload
Component</h3>
<div class="sourceCode" id="cb289"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileUpload <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">handleUpload</span>(e) {</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> file <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>file) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> formData <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>    formData<span class="op">.</span><span class="fu">append</span>(<span class="st">&#39;file&#39;</span><span class="op">,</span> file)<span class="op">;</span></span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb289-10"><a href="#cb289-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> token <span class="op">=</span> auth<span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb289-11"><a href="#cb289-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;http://localhost:3000/api/upload&#39;</span><span class="op">,</span> {</span>
<span id="cb289-12"><a href="#cb289-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb289-13"><a href="#cb289-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb289-14"><a href="#cb289-14" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;Authorization&#39;</span><span class="op">:</span> <span class="vs">`Bearer </span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb289-15"><a href="#cb289-15" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb289-16"><a href="#cb289-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span><span class="op">:</span> formData</span>
<span id="cb289-17"><a href="#cb289-17" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb289-18"><a href="#cb289-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-19"><a href="#cb289-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Upload failed&#39;</span>)<span class="op">;</span></span>
<span id="cb289-20"><a href="#cb289-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-21"><a href="#cb289-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb289-22"><a href="#cb289-22" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;file.uploaded&#39;</span><span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb289-23"><a href="#cb289-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-24"><a href="#cb289-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showSuccess</span>(<span class="vs">`File uploaded: </span><span class="sc">${</span>result<span class="op">.</span><span class="at">filename</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb289-25"><a href="#cb289-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb289-26"><a href="#cb289-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">showError</span>(error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb289-27"><a href="#cb289-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb289-28"><a href="#cb289-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb289-29"><a href="#cb289-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-30"><a href="#cb289-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb289-31"><a href="#cb289-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb289-32"><a href="#cb289-32" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;upload-container&quot;&gt;</span></span>
<span id="cb289-33"><a href="#cb289-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;file&quot; id=&quot;file-input&quot;&gt;</span></span>
<span id="cb289-34"><a href="#cb289-34" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button onclick=&quot;document.getElementById(&#39;file-input&#39;).click()&quot;&gt;</span></span>
<span id="cb289-35"><a href="#cb289-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          Choose File</span></span>
<span id="cb289-36"><a href="#cb289-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/button&gt;</span></span>
<span id="cb289-37"><a href="#cb289-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;message&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb289-38"><a href="#cb289-38" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb289-39"><a href="#cb289-39" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb289-40"><a href="#cb289-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-41"><a href="#cb289-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#file-input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb289-42"><a href="#cb289-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleUpload</span>(e)<span class="op">;</span></span>
<span id="cb289-43"><a href="#cb289-43" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb289-44"><a href="#cb289-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb289-45"><a href="#cb289-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb289-46"><a href="#cb289-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-47"><a href="#cb289-47" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;file-upload&#39;</span><span class="op">,</span> FileUpload)<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.9" id="real-time-chat-application"><span
class="header-section-number">13.9</span> Real-Time Chat
Application</h2>
<p>Complete example combining HTTP and WebSocket:</p>
<h3 data-number="13.9.1" id="backend-node.js"><span
class="header-section-number">13.9.1</span> Backend (Node.js)</h3>
<div class="sourceCode" id="cb290"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="co">// chat-server.js</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> http <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">WebSocket</span> <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ws&#39;</span>)<span class="op">;</span></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> jwt <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;jsonwebtoken&#39;</span>)<span class="op">;</span></span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()<span class="op">;</span></span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> http<span class="op">.</span><span class="fu">createServer</span>(app)<span class="op">;</span></span>
<span id="cb290-9"><a href="#cb290-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wss <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="fu">Server</span>({ server })<span class="op">;</span></span>
<span id="cb290-10"><a href="#cb290-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-11"><a href="#cb290-11" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb290-12"><a href="#cb290-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-13"><a href="#cb290-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Store active connections</span></span>
<span id="cb290-14"><a href="#cb290-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> connections <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span> <span class="co">// ws -&gt; user</span></span>
<span id="cb290-15"><a href="#cb290-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rooms <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span> <span class="co">// roomId -&gt; Set of ws</span></span>
<span id="cb290-16"><a href="#cb290-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-17"><a href="#cb290-17" aria-hidden="true" tabindex="-1"></a><span class="co">// REST API for chat history</span></span>
<span id="cb290-18"><a href="#cb290-18" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/rooms/:roomId/messages&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb290-19"><a href="#cb290-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> messages <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb290-20"><a href="#cb290-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;SELECT * FROM messages WHERE room_id = ? ORDER BY created_at ASC&#39;</span><span class="op">,</span></span>
<span id="cb290-21"><a href="#cb290-21" aria-hidden="true" tabindex="-1"></a>    [req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">roomId</span>]</span>
<span id="cb290-22"><a href="#cb290-22" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb290-23"><a href="#cb290-23" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">json</span>(messages)<span class="op">;</span></span>
<span id="cb290-24"><a href="#cb290-24" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb290-25"><a href="#cb290-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-26"><a href="#cb290-26" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">post</span>(<span class="st">&#39;/api/rooms/:roomId/messages&#39;</span><span class="op">,</span> authenticate<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb290-27"><a href="#cb290-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { content } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb290-28"><a href="#cb290-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-29"><a href="#cb290-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> message <span class="op">=</span> <span class="cf">await</span> db<span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb290-30"><a href="#cb290-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;INSERT INTO messages (room_id, user_id, content) VALUES (?, ?, ?)&#39;</span><span class="op">,</span></span>
<span id="cb290-31"><a href="#cb290-31" aria-hidden="true" tabindex="-1"></a>    [req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">roomId</span><span class="op">,</span> req<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="op">,</span> content]</span>
<span id="cb290-32"><a href="#cb290-32" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb290-33"><a href="#cb290-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-34"><a href="#cb290-34" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">201</span>)<span class="op">.</span><span class="fu">json</span>(message)<span class="op">;</span></span>
<span id="cb290-35"><a href="#cb290-35" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb290-36"><a href="#cb290-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-37"><a href="#cb290-37" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket for real-time</span></span>
<span id="cb290-38"><a href="#cb290-38" aria-hidden="true" tabindex="-1"></a>wss<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connection&#39;</span><span class="op">,</span> (ws<span class="op">,</span> req) <span class="kw">=&gt;</span> {</span>
<span id="cb290-39"><a href="#cb290-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(req<span class="op">.</span><span class="at">url</span><span class="op">,</span> <span class="st">&#39;ws://localhost&#39;</span>)<span class="op">;</span></span>
<span id="cb290-40"><a href="#cb290-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> token <span class="op">=</span> url<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;token&#39;</span>)<span class="op">;</span></span>
<span id="cb290-41"><a href="#cb290-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-42"><a href="#cb290-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb290-43"><a href="#cb290-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> jwt<span class="op">.</span><span class="fu">verify</span>(token<span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">JWT_SECRET</span>)<span class="op">;</span></span>
<span id="cb290-44"><a href="#cb290-44" aria-hidden="true" tabindex="-1"></a>    connections<span class="op">.</span><span class="fu">set</span>(ws<span class="op">,</span> user)<span class="op">;</span></span>
<span id="cb290-45"><a href="#cb290-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-46"><a href="#cb290-46" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> (data) <span class="kw">=&gt;</span> {</span>
<span id="cb290-47"><a href="#cb290-47" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> message <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data)<span class="op">;</span></span>
<span id="cb290-48"><a href="#cb290-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">handleMessage</span>(ws<span class="op">,</span> user<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb290-49"><a href="#cb290-49" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb290-50"><a href="#cb290-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-51"><a href="#cb290-51" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb290-52"><a href="#cb290-52" aria-hidden="true" tabindex="-1"></a>      connections<span class="op">.</span><span class="fu">delete</span>(ws)<span class="op">;</span></span>
<span id="cb290-53"><a href="#cb290-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Remove from all rooms</span></span>
<span id="cb290-54"><a href="#cb290-54" aria-hidden="true" tabindex="-1"></a>      rooms<span class="op">.</span><span class="fu">forEach</span>(roomClients <span class="kw">=&gt;</span> roomClients<span class="op">.</span><span class="fu">delete</span>(ws))<span class="op">;</span></span>
<span id="cb290-55"><a href="#cb290-55" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb290-56"><a href="#cb290-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-57"><a href="#cb290-57" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;connected&#39;</span><span class="op">,</span> user }))<span class="op">;</span></span>
<span id="cb290-58"><a href="#cb290-58" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> {</span>
<span id="cb290-59"><a href="#cb290-59" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">close</span>(<span class="dv">4001</span><span class="op">,</span> <span class="st">&#39;Unauthorized&#39;</span>)<span class="op">;</span></span>
<span id="cb290-60"><a href="#cb290-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb290-61"><a href="#cb290-61" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb290-62"><a href="#cb290-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-63"><a href="#cb290-63" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">handleMessage</span>(ws<span class="op">,</span> user<span class="op">,</span> message) {</span>
<span id="cb290-64"><a href="#cb290-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (message<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb290-65"><a href="#cb290-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;join-room&#39;</span><span class="op">:</span></span>
<span id="cb290-66"><a href="#cb290-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>rooms<span class="op">.</span><span class="fu">has</span>(message<span class="op">.</span><span class="at">roomId</span>)) {</span>
<span id="cb290-67"><a href="#cb290-67" aria-hidden="true" tabindex="-1"></a>        rooms<span class="op">.</span><span class="fu">set</span>(message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">Set</span>())<span class="op">;</span></span>
<span id="cb290-68"><a href="#cb290-68" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb290-69"><a href="#cb290-69" aria-hidden="true" tabindex="-1"></a>      rooms<span class="op">.</span><span class="fu">get</span>(message<span class="op">.</span><span class="at">roomId</span>)<span class="op">.</span><span class="fu">add</span>(ws)<span class="op">;</span></span>
<span id="cb290-70"><a href="#cb290-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-71"><a href="#cb290-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Notify room</span></span>
<span id="cb290-72"><a href="#cb290-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">broadcastToRoom</span>(message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> {</span>
<span id="cb290-73"><a href="#cb290-73" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user-joined&#39;</span><span class="op">,</span></span>
<span id="cb290-74"><a href="#cb290-74" aria-hidden="true" tabindex="-1"></a>        <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> user<span class="op">.</span><span class="at">name</span> }</span>
<span id="cb290-75"><a href="#cb290-75" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb290-76"><a href="#cb290-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb290-77"><a href="#cb290-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-78"><a href="#cb290-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;leave-room&#39;</span><span class="op">:</span></span>
<span id="cb290-79"><a href="#cb290-79" aria-hidden="true" tabindex="-1"></a>      rooms<span class="op">.</span><span class="fu">get</span>(message<span class="op">.</span><span class="at">roomId</span>)<span class="op">?.</span><span class="fu">delete</span>(ws)<span class="op">;</span></span>
<span id="cb290-80"><a href="#cb290-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-81"><a href="#cb290-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">broadcastToRoom</span>(message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> {</span>
<span id="cb290-82"><a href="#cb290-82" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user-left&#39;</span><span class="op">,</span></span>
<span id="cb290-83"><a href="#cb290-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> user<span class="op">.</span><span class="at">name</span> }</span>
<span id="cb290-84"><a href="#cb290-84" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb290-85"><a href="#cb290-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb290-86"><a href="#cb290-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-87"><a href="#cb290-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;chat-message&#39;</span><span class="op">:</span></span>
<span id="cb290-88"><a href="#cb290-88" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Save to database</span></span>
<span id="cb290-89"><a href="#cb290-89" aria-hidden="true" tabindex="-1"></a>      db<span class="op">.</span><span class="fu">query</span>(</span>
<span id="cb290-90"><a href="#cb290-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;INSERT INTO messages (room_id, user_id, content) VALUES (?, ?, ?)&#39;</span><span class="op">,</span></span>
<span id="cb290-91"><a href="#cb290-91" aria-hidden="true" tabindex="-1"></a>        [message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> message<span class="op">.</span><span class="at">content</span>]</span>
<span id="cb290-92"><a href="#cb290-92" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">then</span>(result <span class="kw">=&gt;</span> {</span>
<span id="cb290-93"><a href="#cb290-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Broadcast to room</span></span>
<span id="cb290-94"><a href="#cb290-94" aria-hidden="true" tabindex="-1"></a>        <span class="fu">broadcastToRoom</span>(message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> {</span>
<span id="cb290-95"><a href="#cb290-95" aria-hidden="true" tabindex="-1"></a>          <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;chat-message&#39;</span><span class="op">,</span></span>
<span id="cb290-96"><a href="#cb290-96" aria-hidden="true" tabindex="-1"></a>          <span class="dt">message</span><span class="op">:</span> {</span>
<span id="cb290-97"><a href="#cb290-97" aria-hidden="true" tabindex="-1"></a>            <span class="dt">id</span><span class="op">:</span> result<span class="op">.</span><span class="at">insertId</span><span class="op">,</span></span>
<span id="cb290-98"><a href="#cb290-98" aria-hidden="true" tabindex="-1"></a>            <span class="dt">userId</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb290-99"><a href="#cb290-99" aria-hidden="true" tabindex="-1"></a>            <span class="dt">userName</span><span class="op">:</span> user<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb290-100"><a href="#cb290-100" aria-hidden="true" tabindex="-1"></a>            <span class="dt">content</span><span class="op">:</span> message<span class="op">.</span><span class="at">content</span><span class="op">,</span></span>
<span id="cb290-101"><a href="#cb290-101" aria-hidden="true" tabindex="-1"></a>            <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb290-102"><a href="#cb290-102" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb290-103"><a href="#cb290-103" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb290-104"><a href="#cb290-104" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb290-105"><a href="#cb290-105" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb290-106"><a href="#cb290-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-107"><a href="#cb290-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;typing&#39;</span><span class="op">:</span></span>
<span id="cb290-108"><a href="#cb290-108" aria-hidden="true" tabindex="-1"></a>      <span class="fu">broadcastToRoom</span>(message<span class="op">.</span><span class="at">roomId</span><span class="op">,</span> {</span>
<span id="cb290-109"><a href="#cb290-109" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;user-typing&#39;</span><span class="op">,</span></span>
<span id="cb290-110"><a href="#cb290-110" aria-hidden="true" tabindex="-1"></a>        <span class="dt">user</span><span class="op">:</span> { <span class="dt">id</span><span class="op">:</span> user<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> user<span class="op">.</span><span class="at">name</span> }</span>
<span id="cb290-111"><a href="#cb290-111" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span> ws)<span class="op">;</span></span>
<span id="cb290-112"><a href="#cb290-112" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb290-113"><a href="#cb290-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb290-114"><a href="#cb290-114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb290-115"><a href="#cb290-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-116"><a href="#cb290-116" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">broadcastToRoom</span>(roomId<span class="op">,</span> message<span class="op">,</span> exclude <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb290-117"><a href="#cb290-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> roomClients <span class="op">=</span> rooms<span class="op">.</span><span class="fu">get</span>(roomId)<span class="op">;</span></span>
<span id="cb290-118"><a href="#cb290-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>roomClients) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb290-119"><a href="#cb290-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-120"><a href="#cb290-120" aria-hidden="true" tabindex="-1"></a>  roomClients<span class="op">.</span><span class="fu">forEach</span>(client <span class="kw">=&gt;</span> {</span>
<span id="cb290-121"><a href="#cb290-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (client <span class="op">!==</span> exclude <span class="op">&amp;&amp;</span> client<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb290-122"><a href="#cb290-122" aria-hidden="true" tabindex="-1"></a>      client<span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(message))<span class="op">;</span></span>
<span id="cb290-123"><a href="#cb290-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb290-124"><a href="#cb290-124" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb290-125"><a href="#cb290-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb290-126"><a href="#cb290-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-127"><a href="#cb290-127" aria-hidden="true" tabindex="-1"></a>server<span class="op">.</span><span class="fu">listen</span>(<span class="dv">3000</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Chat server running on port 3000&#39;</span>))<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.9.2" id="frontend-chat-component"><span
class="header-section-number">13.9.2</span> Frontend Chat Component</h3>
<div class="sourceCode" id="cb291"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChatRoom <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">roomId</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;room-id&#39;</span>)<span class="op">;</span></span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb291-6"><a href="#cb291-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb291-7"><a href="#cb291-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">typingTimer</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb291-8"><a href="#cb291-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-9"><a href="#cb291-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-10"><a href="#cb291-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb291-11"><a href="#cb291-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadHistory</span>()<span class="op">;</span></span>
<span id="cb291-12"><a href="#cb291-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">connectWebSocket</span>()<span class="op">;</span></span>
<span id="cb291-13"><a href="#cb291-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb291-14"><a href="#cb291-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-15"><a href="#cb291-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-16"><a href="#cb291-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadHistory</span>() {</span>
<span id="cb291-17"><a href="#cb291-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb291-18"><a href="#cb291-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> <span class="cf">await</span> api<span class="op">.</span><span class="fu">get</span>(<span class="vs">`/rooms/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">roomId</span><span class="sc">}</span><span class="vs">/messages`</span>)<span class="op">;</span></span>
<span id="cb291-19"><a href="#cb291-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb291-20"><a href="#cb291-20" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load chat history:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb291-21"><a href="#cb291-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb291-22"><a href="#cb291-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-23"><a href="#cb291-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-24"><a href="#cb291-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectWebSocket</span>() {</span>
<span id="cb291-25"><a href="#cb291-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> token <span class="op">=</span> auth<span class="op">.</span><span class="fu">getToken</span>()<span class="op">;</span></span>
<span id="cb291-26"><a href="#cb291-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="vs">`ws://localhost:3000?token=</span><span class="sc">${</span>token<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb291-27"><a href="#cb291-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-28"><a href="#cb291-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onopen</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb291-29"><a href="#cb291-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb291-30"><a href="#cb291-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;join-room&#39;</span><span class="op">,</span></span>
<span id="cb291-31"><a href="#cb291-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">roomId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">roomId</span></span>
<span id="cb291-32"><a href="#cb291-32" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb291-33"><a href="#cb291-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb291-34"><a href="#cb291-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-35"><a href="#cb291-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb291-36"><a href="#cb291-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(<span class="bu">event</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb291-37"><a href="#cb291-37" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">handleWebSocketMessage</span>(data)<span class="op">;</span></span>
<span id="cb291-38"><a href="#cb291-38" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb291-39"><a href="#cb291-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-40"><a href="#cb291-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="at">onclose</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb291-41"><a href="#cb291-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Reconnect after 3 seconds</span></span>
<span id="cb291-42"><a href="#cb291-42" aria-hidden="true" tabindex="-1"></a>      <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">connectWebSocket</span>()<span class="op">,</span> <span class="dv">3000</span>)<span class="op">;</span></span>
<span id="cb291-43"><a href="#cb291-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb291-44"><a href="#cb291-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-45"><a href="#cb291-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-46"><a href="#cb291-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleWebSocketMessage</span>(data) {</span>
<span id="cb291-47"><a href="#cb291-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (data<span class="op">.</span><span class="at">type</span>) {</span>
<span id="cb291-48"><a href="#cb291-48" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;chat-message&#39;</span><span class="op">:</span></span>
<span id="cb291-49"><a href="#cb291-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">push</span>(data<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb291-50"><a href="#cb291-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb291-51"><a href="#cb291-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">scrollToBottom</span>()<span class="op">;</span></span>
<span id="cb291-52"><a href="#cb291-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb291-53"><a href="#cb291-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-54"><a href="#cb291-54" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;user-joined&#39;</span><span class="op">:</span></span>
<span id="cb291-55"><a href="#cb291-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(<span class="vs">`</span><span class="sc">${</span>data<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> joined`</span>)<span class="op">;</span></span>
<span id="cb291-56"><a href="#cb291-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb291-57"><a href="#cb291-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-58"><a href="#cb291-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;user-left&#39;</span><span class="op">:</span></span>
<span id="cb291-59"><a href="#cb291-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showNotification</span>(<span class="vs">`</span><span class="sc">${</span>data<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> left`</span>)<span class="op">;</span></span>
<span id="cb291-60"><a href="#cb291-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb291-61"><a href="#cb291-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-62"><a href="#cb291-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;user-typing&#39;</span><span class="op">:</span></span>
<span id="cb291-63"><a href="#cb291-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">showTypingIndicator</span>(data<span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb291-64"><a href="#cb291-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb291-65"><a href="#cb291-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb291-66"><a href="#cb291-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-67"><a href="#cb291-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-68"><a href="#cb291-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sendMessage</span>(content) {</span>
<span id="cb291-69"><a href="#cb291-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>content<span class="op">.</span><span class="fu">trim</span>()) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb291-70"><a href="#cb291-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-71"><a href="#cb291-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb291-72"><a href="#cb291-72" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;chat-message&#39;</span><span class="op">,</span></span>
<span id="cb291-73"><a href="#cb291-73" aria-hidden="true" tabindex="-1"></a>      <span class="dt">roomId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">roomId</span><span class="op">,</span></span>
<span id="cb291-74"><a href="#cb291-74" aria-hidden="true" tabindex="-1"></a>      content</span>
<span id="cb291-75"><a href="#cb291-75" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb291-76"><a href="#cb291-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-77"><a href="#cb291-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#message-input&#39;</span>)<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb291-78"><a href="#cb291-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-79"><a href="#cb291-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-80"><a href="#cb291-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">handleTyping</span>() {</span>
<span id="cb291-81"><a href="#cb291-81" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(<span class="kw">this</span><span class="op">.</span><span class="at">typingTimer</span>)<span class="op">;</span></span>
<span id="cb291-82"><a href="#cb291-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-83"><a href="#cb291-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb291-84"><a href="#cb291-84" aria-hidden="true" tabindex="-1"></a>      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;typing&#39;</span><span class="op">,</span></span>
<span id="cb291-85"><a href="#cb291-85" aria-hidden="true" tabindex="-1"></a>      <span class="dt">roomId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">roomId</span></span>
<span id="cb291-86"><a href="#cb291-86" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb291-87"><a href="#cb291-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-88"><a href="#cb291-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">typingTimer</span> <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb291-89"><a href="#cb291-89" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Stop typing indicator after 2 seconds</span></span>
<span id="cb291-90"><a href="#cb291-90" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb291-91"><a href="#cb291-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-92"><a href="#cb291-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-93"><a href="#cb291-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb291-94"><a href="#cb291-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb291-95"><a href="#cb291-95" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb291-96"><a href="#cb291-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        .chat-container {</span></span>
<span id="cb291-97"><a href="#cb291-97" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb291-98"><a href="#cb291-98" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb291-99"><a href="#cb291-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 600px;</span></span>
<span id="cb291-100"><a href="#cb291-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb291-101"><a href="#cb291-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb291-102"><a href="#cb291-102" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-103"><a href="#cb291-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-104"><a href="#cb291-104" aria-hidden="true" tabindex="-1"></a><span class="vs">        .messages {</span></span>
<span id="cb291-105"><a href="#cb291-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb291-106"><a href="#cb291-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-y: auto;</span></span>
<span id="cb291-107"><a href="#cb291-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 20px;</span></span>
<span id="cb291-108"><a href="#cb291-108" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-109"><a href="#cb291-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-110"><a href="#cb291-110" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message {</span></span>
<span id="cb291-111"><a href="#cb291-111" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 15px;</span></span>
<span id="cb291-112"><a href="#cb291-112" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-113"><a href="#cb291-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-114"><a href="#cb291-114" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message-author {</span></span>
<span id="cb291-115"><a href="#cb291-115" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb291-116"><a href="#cb291-116" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #667eea;</span></span>
<span id="cb291-117"><a href="#cb291-117" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-118"><a href="#cb291-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-119"><a href="#cb291-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message-content {</span></span>
<span id="cb291-120"><a href="#cb291-120" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 5px;</span></span>
<span id="cb291-121"><a href="#cb291-121" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-122"><a href="#cb291-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-123"><a href="#cb291-123" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message-time {</span></span>
<span id="cb291-124"><a href="#cb291-124" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 12px;</span></span>
<span id="cb291-125"><a href="#cb291-125" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #999;</span></span>
<span id="cb291-126"><a href="#cb291-126" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-127"><a href="#cb291-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-128"><a href="#cb291-128" aria-hidden="true" tabindex="-1"></a><span class="vs">        .input-area {</span></span>
<span id="cb291-129"><a href="#cb291-129" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb291-130"><a href="#cb291-130" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 10px;</span></span>
<span id="cb291-131"><a href="#cb291-131" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 15px;</span></span>
<span id="cb291-132"><a href="#cb291-132" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-top: 1px solid #ddd;</span></span>
<span id="cb291-133"><a href="#cb291-133" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-134"><a href="#cb291-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-135"><a href="#cb291-135" aria-hidden="true" tabindex="-1"></a><span class="vs">        input {</span></span>
<span id="cb291-136"><a href="#cb291-136" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb291-137"><a href="#cb291-137" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px;</span></span>
<span id="cb291-138"><a href="#cb291-138" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ddd;</span></span>
<span id="cb291-139"><a href="#cb291-139" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb291-140"><a href="#cb291-140" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-141"><a href="#cb291-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-142"><a href="#cb291-142" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb291-143"><a href="#cb291-143" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 10px 20px;</span></span>
<span id="cb291-144"><a href="#cb291-144" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #667eea;</span></span>
<span id="cb291-145"><a href="#cb291-145" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb291-146"><a href="#cb291-146" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb291-147"><a href="#cb291-147" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb291-148"><a href="#cb291-148" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb291-149"><a href="#cb291-149" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb291-150"><a href="#cb291-150" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb291-151"><a href="#cb291-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-152"><a href="#cb291-152" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;chat-container&quot;&gt;</span></span>
<span id="cb291-153"><a href="#cb291-153" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;messages&quot;&gt;</span></span>
<span id="cb291-154"><a href="#cb291-154" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">map</span>(msg <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb291-155"><a href="#cb291-155" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;message&quot;&gt;</span></span>
<span id="cb291-156"><a href="#cb291-156" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div class=&quot;message-author&quot;&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">userName</span><span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb291-157"><a href="#cb291-157" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div class=&quot;message-content&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">escapeHtml</span>(msg<span class="op">.</span><span class="at">content</span>)<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb291-158"><a href="#cb291-158" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div class=&quot;message-time&quot;&gt;</span><span class="sc">${</span><span class="kw">new</span> <span class="bu">Date</span>(msg<span class="op">.</span><span class="at">createdAt</span>)<span class="op">.</span><span class="fu">toLocaleTimeString</span>()<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb291-159"><a href="#cb291-159" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/div&gt;</span></span>
<span id="cb291-160"><a href="#cb291-160" aria-hidden="true" tabindex="-1"></a><span class="vs">          `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb291-161"><a href="#cb291-161" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb291-162"><a href="#cb291-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-163"><a href="#cb291-163" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;input-area&quot;&gt;</span></span>
<span id="cb291-164"><a href="#cb291-164" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;input</span></span>
<span id="cb291-165"><a href="#cb291-165" aria-hidden="true" tabindex="-1"></a><span class="vs">            type=&quot;text&quot;</span></span>
<span id="cb291-166"><a href="#cb291-166" aria-hidden="true" tabindex="-1"></a><span class="vs">            id=&quot;message-input&quot;</span></span>
<span id="cb291-167"><a href="#cb291-167" aria-hidden="true" tabindex="-1"></a><span class="vs">            placeholder=&quot;Type a message...&quot;</span></span>
<span id="cb291-168"><a href="#cb291-168" aria-hidden="true" tabindex="-1"></a><span class="vs">          &gt;</span></span>
<span id="cb291-169"><a href="#cb291-169" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button id=&quot;send-btn&quot;&gt;Send&lt;/button&gt;</span></span>
<span id="cb291-170"><a href="#cb291-170" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb291-171"><a href="#cb291-171" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb291-172"><a href="#cb291-172" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb291-173"><a href="#cb291-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-174"><a href="#cb291-174" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#message-input&#39;</span>)<span class="op">;</span></span>
<span id="cb291-175"><a href="#cb291-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sendBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#send-btn&#39;</span>)<span class="op">;</span></span>
<span id="cb291-176"><a href="#cb291-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-177"><a href="#cb291-177" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleTyping</span>())<span class="op">;</span></span>
<span id="cb291-178"><a href="#cb291-178" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keypress&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb291-179"><a href="#cb291-179" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">&#39;Enter&#39;</span>) {</span>
<span id="cb291-180"><a href="#cb291-180" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">sendMessage</span>(input<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb291-181"><a href="#cb291-181" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb291-182"><a href="#cb291-182" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb291-183"><a href="#cb291-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-184"><a href="#cb291-184" aria-hidden="true" tabindex="-1"></a>    sendBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb291-185"><a href="#cb291-185" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">sendMessage</span>(input<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb291-186"><a href="#cb291-186" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb291-187"><a href="#cb291-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-188"><a href="#cb291-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-189"><a href="#cb291-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">escapeHtml</span>(text) {</span>
<span id="cb291-190"><a href="#cb291-190" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> div <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;div&#39;</span>)<span class="op">;</span></span>
<span id="cb291-191"><a href="#cb291-191" aria-hidden="true" tabindex="-1"></a>    div<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> text<span class="op">;</span></span>
<span id="cb291-192"><a href="#cb291-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> div<span class="op">.</span><span class="at">innerHTML</span><span class="op">;</span></span>
<span id="cb291-193"><a href="#cb291-193" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-194"><a href="#cb291-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-195"><a href="#cb291-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scrollToBottom</span>() {</span>
<span id="cb291-196"><a href="#cb291-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> messages <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.messages&#39;</span>)<span class="op">;</span></span>
<span id="cb291-197"><a href="#cb291-197" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> messages<span class="op">.</span><span class="at">scrollHeight</span><span class="op">;</span></span>
<span id="cb291-198"><a href="#cb291-198" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-199"><a href="#cb291-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-200"><a href="#cb291-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb291-201"><a href="#cb291-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">ws</span>) {</span>
<span id="cb291-202"><a href="#cb291-202" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb291-203"><a href="#cb291-203" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;leave-room&#39;</span><span class="op">,</span></span>
<span id="cb291-204"><a href="#cb291-204" aria-hidden="true" tabindex="-1"></a>        <span class="dt">roomId</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">roomId</span></span>
<span id="cb291-205"><a href="#cb291-205" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb291-206"><a href="#cb291-206" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">ws</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb291-207"><a href="#cb291-207" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb291-208"><a href="#cb291-208" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb291-209"><a href="#cb291-209" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb291-210"><a href="#cb291-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-211"><a href="#cb291-211" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;chat-room&#39;</span><span class="op">,</span> ChatRoom)<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.10" id="troubleshooting-2"><span
class="header-section-number">13.10</span> Troubleshooting</h2>
<h3 data-number="13.10.1" id="problem-cors-errors-in-development"><span
class="header-section-number">13.10.1</span> Problem: CORS Errors in
Development</h3>
<p><strong>Symptom</strong>: <code>Access-Control-Allow-Origin</code>
errors</p>
<p><strong>Solution</strong>: Configure CORS properly for
development:</p>
<div class="sourceCode" id="cb292"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Express</span></span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;cors&#39;</span>)<span class="op">;</span></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>({</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> <span class="st">&#39;http://localhost:5173&#39;</span><span class="op">,</span> <span class="co">// Your frontend URL</span></span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">credentials</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb292-7"><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-8"><a href="#cb292-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Or for all origins in development</span></span>
<span id="cb292-9"><a href="#cb292-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;development&#39;</span>) {</span>
<span id="cb292-10"><a href="#cb292-10" aria-hidden="true" tabindex="-1"></a>  app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>({ <span class="dt">origin</span><span class="op">:</span> <span class="st">&#39;*&#39;</span> }))<span class="op">;</span></span>
<span id="cb292-11"><a href="#cb292-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="13.10.2"
id="problem-database-connection-pool-exhaustion"><span
class="header-section-number">13.10.2</span> Problem: Database
Connection Pool Exhaustion</h3>
<p><strong>Symptom</strong>: “Too many connections” errors</p>
<p><strong>Solution</strong>: Configure connection pooling:</p>
<div class="sourceCode" id="cb293"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> { Pool } <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pool</span>({</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="co">// Maximum connections</span></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">idleTimeoutMillis</span><span class="op">:</span> <span class="dv">30000</span><span class="op">,</span></span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">connectionTimeoutMillis</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Always release connections</span></span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> client <span class="op">=</span> <span class="cf">await</span> pool<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> client<span class="op">.</span><span class="fu">query</span>(<span class="st">&#39;SELECT * FROM users&#39;</span>)<span class="op">;</span></span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">json</span>(result<span class="op">.</span><span class="at">rows</span>)<span class="op">;</span></span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">finally</span> {</span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span><span class="fu">release</span>()<span class="op">;</span> <span class="co">// Important!</span></span>
<span id="cb293-17"><a href="#cb293-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb293-18"><a href="#cb293-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.10.3" id="problem-file-uploads-failing"><span
class="header-section-number">13.10.3</span> Problem: File Uploads
Failing</h3>
<p><strong>Symptom</strong>: 413 Payload Too Large or multipart parsing
errors</p>
<p><strong>Solution</strong>: Increase limits and configure multer
properly:</p>
<div class="sourceCode" id="cb294"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">json</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="st">&#39;10mb&#39;</span> }))<span class="op">;</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(express<span class="op">.</span><span class="fu">urlencoded</span>({ <span class="dt">limit</span><span class="op">:</span> <span class="st">&#39;10mb&#39;</span><span class="op">,</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span> }))<span class="op">;</span></span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> upload <span class="op">=</span> <span class="fu">multer</span>({</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">limits</span><span class="op">:</span> {</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fileSize</span><span class="op">:</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">,</span> <span class="co">// 10MB</span></span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">files</span><span class="op">:</span> <span class="dv">5</span> <span class="co">// Max 5 files</span></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="13.10.4" id="problem-websocket-connection-drops"><span
class="header-section-number">13.10.4</span> Problem: WebSocket
Connection Drops</h3>
<p><strong>Symptom</strong>: Frequent disconnections</p>
<p><strong>Solution</strong>: Implement heartbeat/ping-pong:</p>
<div class="sourceCode" id="cb295"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Server</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>wss<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connection&#39;</span><span class="op">,</span> (ws) <span class="kw">=&gt;</span> {</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="at">isAlive</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;pong&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="at">isAlive</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Ping clients every 30 seconds</span></span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> interval <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>  wss<span class="op">.</span><span class="at">clients</span><span class="op">.</span><span class="fu">forEach</span>((ws) <span class="kw">=&gt;</span> {</span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ws<span class="op">.</span><span class="at">isAlive</span> <span class="op">===</span> <span class="kw">false</span>) <span class="cf">return</span> ws<span class="op">.</span><span class="fu">terminate</span>()<span class="op">;</span></span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="at">isAlive</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">ping</span>()<span class="op">;</span></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb295-17"><a href="#cb295-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span>
<span id="cb295-18"><a href="#cb295-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-19"><a href="#cb295-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Client</span></span>
<span id="cb295-20"><a href="#cb295-20" aria-hidden="true" tabindex="-1"></a><span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb295-21"><a href="#cb295-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ws<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb295-22"><a href="#cb295-22" aria-hidden="true" tabindex="-1"></a>    ws<span class="op">.</span><span class="fu">send</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;ping&#39;</span> }))<span class="op">;</span></span>
<span id="cb295-23"><a href="#cb295-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb295-24"><a href="#cb295-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="dv">30000</span>)<span class="op">;</span></span></code></pre></div>
<h2 data-number="13.11" id="best-practices-9"><span
class="header-section-number">13.11</span> Best Practices</h2>
<ol type="1">
<li><strong>Use environment variables</strong> - Never hardcode secrets
or config</li>
<li><strong>Validate input</strong> - Always validate on the server, not
just client</li>
<li><strong>Use connection pooling</strong> - Reuse database
connections</li>
<li><strong>Implement rate limiting</strong> - Prevent abuse with rate
limits</li>
<li><strong>Log errors properly</strong> - Use structured logging
(Winston, Bunyan)</li>
<li><strong>Handle graceful shutdown</strong> - Close connections
properly on SIGTERM</li>
<li><strong>Use transactions</strong> - For operations that must succeed
or fail together</li>
<li><strong>Sanitize user input</strong> - Prevent SQL injection and
XSS</li>
<li><strong>Set security headers</strong> - Use helmet.js or
similar</li>
<li><strong>Monitor performance</strong> - Use APM tools (New Relic,
DataDog)</li>
</ol>
<h2 data-number="13.12" id="exercises-3"><span
class="header-section-number">13.12</span> Exercises</h2>
<h3 data-number="13.12.1" id="exercise-1-build-a-blog-api"><span
class="header-section-number">13.12.1</span> Exercise 1: Build a Blog
API</h3>
<p>Create a REST API with:</p>
<ul>
<li>User registration and authentication</li>
<li>CRUD operations for blog posts</li>
<li>Comments on posts</li>
<li>Search functionality</li>
<li>Tag/category filtering</li>
</ul>
<p><strong>Bonus</strong>: Add pagination and sorting options.</p>
<h3 data-number="13.12.2" id="exercise-2-real-time-notifications"><span
class="header-section-number">13.12.2</span> Exercise 2: Real-Time
Notifications</h3>
<p>Build a notification system with:</p>
<ul>
<li>WebSocket connection for real-time delivery</li>
<li>Fallback to polling if WebSocket unavailable</li>
<li>Mark as read/unread functionality</li>
<li>Notification categories (info, warning, error)</li>
<li>Persistence to database</li>
</ul>
<p><strong>Bonus</strong>: Add push notifications for mobile.</p>
<h3 data-number="13.12.3" id="exercise-3-file-management-system"><span
class="header-section-number">13.12.3</span> Exercise 3: File Management
System</h3>
<p>Create a file management API with:</p>
<ul>
<li>Upload multiple files</li>
<li>Organize files in folders</li>
<li>Share files with other users</li>
<li>Generate temporary download links</li>
<li>Thumbnail generation for images</li>
</ul>
<p><strong>Bonus</strong>: Implement file versioning.</p>
<h3 data-number="13.12.4" id="exercise-4-graphql-api"><span
class="header-section-number">13.12.4</span> Exercise 4: GraphQL
API</h3>
<p>Convert a REST API to GraphQL:</p>
<ul>
<li>Define schema for users, posts, comments</li>
<li>Implement resolvers</li>
<li>Add authentication to resolvers</li>
<li>Implement subscriptions for real-time</li>
<li>Optimize N+1 queries with DataLoader</li>
</ul>
<p><strong>Bonus</strong>: Add GraphQL Playground for testing.</p>
<hr />
<h2 data-number="13.13" id="summary-12"><span
class="header-section-number">13.13</span> Summary</h2>
<p>Server integration with LARC follows standard web patterns—your
frontend communicates via HTTP and WebSockets, regardless of backend
technology:</p>
<ul>
<li><strong>REST APIs</strong> with Express, Flask, FastAPI, or PHP</li>
<li><strong>ORMs</strong> like Prisma, SQLAlchemy for database
access</li>
<li><strong>File uploads</strong> with multer or similar libraries</li>
<li><strong>Real-time features</strong> with WebSockets</li>
<li><strong>Authentication</strong> via JWT tokens</li>
<li><strong>Database patterns</strong> with repositories and connection
pooling</li>
</ul>
<p>LARC doesn’t dictate your backend choices. Use whatever server
technology fits your team’s expertise and requirements. The PAN bus on
the frontend keeps your components decoupled from implementation
details.</p>
<hr />
<h2 data-number="13.14" id="further-reading-12"><span
class="header-section-number">13.14</span> Further Reading</h2>
<p><strong>For complete server integration reference:</strong> -
<em>Building with LARC</em> Chapter 13: Server Integration - Backend
patterns and API design - <em>Building with LARC</em> Chapter 7: Data
Fetching and APIs - HTTP and WebSocket patterns - <em>Building with
LARC</em> Appendix E: Recipes and Patterns - Server integration
recipes</p>
<div class="pagebreak">

</div>
<h1 data-number="14" id="testing-1"><span
class="header-section-number">14</span> Testing</h1>
<p>Testing isn’t optional. It’s how you know your code works, how you
prevent regressions, and how you confidently refactor. LARC applications
benefit from the same testing strategies as any JavaScript application,
with some patterns specific to Web Components.</p>
<h2 data-number="14.1" id="unit-testing-components"><span
class="header-section-number">14.1</span> Unit Testing Components</h2>
<p>The <code>@open-wc/testing</code> library provides excellent
utilities for testing Web Components:</p>
<div class="sourceCode" id="cb296"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="co">// user-card.test.js</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { expect<span class="op">,</span> fixture<span class="op">,</span> html } <span class="im">from</span> <span class="st">&#39;@open-wc/testing&#39;</span><span class="op">;</span></span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;../components/user-card.js&#39;</span><span class="op">;</span></span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;UserCard&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb296-6"><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;renders user name and email&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb296-7"><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb296-8"><a href="#cb296-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;user-card&gt;&lt;/user-card&gt;</span></span>
<span id="cb296-9"><a href="#cb296-9" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb296-10"><a href="#cb296-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-11"><a href="#cb296-11" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="at">user</span> <span class="op">=</span> { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="st">&#39;alice@example.com&#39;</span> }<span class="op">;</span></span>
<span id="cb296-12"><a href="#cb296-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb296-13"><a href="#cb296-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-14"><a href="#cb296-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> name <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.name&#39;</span>)<span class="op">;</span></span>
<span id="cb296-15"><a href="#cb296-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> email <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.email&#39;</span>)<span class="op">;</span></span>
<span id="cb296-16"><a href="#cb296-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-17"><a href="#cb296-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(name<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb296-18"><a href="#cb296-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(email<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;alice@example.com&#39;</span>)<span class="op">;</span></span>
<span id="cb296-19"><a href="#cb296-19" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb296-20"><a href="#cb296-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-21"><a href="#cb296-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;dispatches follow event when button clicked&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb296-22"><a href="#cb296-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;user-card&gt;&lt;/user-card&gt;`</span>)<span class="op">;</span></span>
<span id="cb296-23"><a href="#cb296-23" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="at">user</span> <span class="op">=</span> { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }<span class="op">;</span></span>
<span id="cb296-24"><a href="#cb296-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-25"><a href="#cb296-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> eventDetail <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb296-26"><a href="#cb296-26" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;follow&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb296-27"><a href="#cb296-27" aria-hidden="true" tabindex="-1"></a>      eventDetail <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb296-28"><a href="#cb296-28" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb296-29"><a href="#cb296-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-30"><a href="#cb296-30" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.follow-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb296-31"><a href="#cb296-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-32"><a href="#cb296-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(eventDetail)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">deep</span><span class="op">.</span><span class="fu">equal</span>({ <span class="dt">userId</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb296-33"><a href="#cb296-33" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb296-34"><a href="#cb296-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-35"><a href="#cb296-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;shows loading state initially&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb296-36"><a href="#cb296-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;user-card loading&gt;&lt;/user-card&gt;`</span>)<span class="op">;</span></span>
<span id="cb296-37"><a href="#cb296-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-38"><a href="#cb296-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> spinner <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.spinner&#39;</span>)<span class="op">;</span></span>
<span id="cb296-39"><a href="#cb296-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(spinner)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb296-40"><a href="#cb296-40" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb296-41"><a href="#cb296-41" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.2" id="testing-pan-bus-integration"><span
class="header-section-number">14.2</span> Testing PAN Bus
Integration</h2>
<p>Mock the PAN bus to test component communication:</p>
<div class="sourceCode" id="cb297"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co">// pan-mock.js</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MockPanBus {</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">publish</span>(topic<span class="op">,</span> data) {</span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">push</span>({ topic<span class="op">,</span> data })<span class="op">;</span></span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(topic) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb297-11"><a href="#cb297-11" aria-hidden="true" tabindex="-1"></a>    handlers<span class="op">.</span><span class="fu">forEach</span>(handler <span class="kw">=&gt;</span> <span class="fu">handler</span>(data))<span class="op">;</span></span>
<span id="cb297-12"><a href="#cb297-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-13"><a href="#cb297-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-14"><a href="#cb297-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span>(topic<span class="op">,</span> handler) {</span>
<span id="cb297-15"><a href="#cb297-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">has</span>(topic)) {</span>
<span id="cb297-16"><a href="#cb297-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">set</span>(topic<span class="op">,</span> [])<span class="op">;</span></span>
<span id="cb297-17"><a href="#cb297-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb297-18"><a href="#cb297-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(topic)<span class="op">.</span><span class="fu">push</span>(handler)<span class="op">;</span></span>
<span id="cb297-19"><a href="#cb297-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">unsubscribe</span>(topic<span class="op">,</span> handler)<span class="op">;</span></span>
<span id="cb297-20"><a href="#cb297-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-21"><a href="#cb297-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-22"><a href="#cb297-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unsubscribe</span>(topic<span class="op">,</span> handler) {</span>
<span id="cb297-23"><a href="#cb297-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> handlers <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">get</span>(topic) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb297-24"><a href="#cb297-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> handlers<span class="op">.</span><span class="fu">indexOf</span>(handler)<span class="op">;</span></span>
<span id="cb297-25"><a href="#cb297-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (index <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) handlers<span class="op">.</span><span class="fu">splice</span>(index<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb297-26"><a href="#cb297-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-27"><a href="#cb297-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-28"><a href="#cb297-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clear</span>() {</span>
<span id="cb297-29"><a href="#cb297-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb297-30"><a href="#cb297-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb297-31"><a href="#cb297-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-32"><a href="#cb297-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb297-33"><a href="#cb297-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-34"><a href="#cb297-34" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> mockPan <span class="op">=</span> <span class="kw">new</span> <span class="fu">MockPanBus</span>()<span class="op">;</span></span></code></pre></div>
<p>Use it in tests:</p>
<div class="sourceCode" id="cb298"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { mockPan } <span class="im">from</span> <span class="st">&#39;./pan-mock.js&#39;</span><span class="op">;</span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;NotificationList&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> mockPan<span class="op">.</span><span class="fu">clear</span>())<span class="op">;</span></span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;displays notifications from PAN bus&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;notification-list&gt;&lt;/notification-list&gt;`</span>)<span class="op">;</span></span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a>    mockPan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;notification.new&#39;</span><span class="op">,</span> {</span>
<span id="cb298-10"><a href="#cb298-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb298-11"><a href="#cb298-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="st">&#39;Hello world&#39;</span></span>
<span id="cb298-12"><a href="#cb298-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb298-13"><a href="#cb298-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-14"><a href="#cb298-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb298-15"><a href="#cb298-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-16"><a href="#cb298-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> notifications <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.notification&#39;</span>)<span class="op">;</span></span>
<span id="cb298-17"><a href="#cb298-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(notifications<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb298-18"><a href="#cb298-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(notifications[<span class="dv">0</span>]<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">include</span>(<span class="st">&#39;Hello world&#39;</span>)<span class="op">;</span></span>
<span id="cb298-19"><a href="#cb298-19" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb298-20"><a href="#cb298-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.3" id="integration-testing-1"><span
class="header-section-number">14.3</span> Integration Testing</h2>
<p>Test components working together:</p>
<div class="sourceCode" id="cb299"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Shopping Cart Integration&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;updates cart when product added&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cart <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;shopping-cart&gt;&lt;/shopping-cart&gt;`</span>)<span class="op">;</span></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> product <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;product-card .product=</span><span class="sc">${</span>{ <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Widget&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">10</span> }<span class="sc">}</span><span class="vs">&gt;</span></span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/product-card&gt;</span></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate add to cart</span></span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>    product<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.add-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-12"><a href="#cb299-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> cart<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb299-13"><a href="#cb299-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-14"><a href="#cb299-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(cart<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb299-15"><a href="#cb299-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(cart<span class="op">.</span><span class="at">total</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb299-16"><a href="#cb299-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb299-17"><a href="#cb299-17" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.4" id="end-to-end-testing-with-playwright"><span
class="header-section-number">14.4</span> End-to-End Testing with
Playwright</h2>
<p>For full user flow testing, Playwright provides excellent browser
automation:</p>
<div class="sourceCode" id="cb300"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co">// e2e/login.spec.js</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { test<span class="op">,</span> expect } <span class="im">from</span> <span class="st">&#39;@playwright/test&#39;</span><span class="op">;</span></span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">describe</span>(<span class="st">&#39;Login Flow&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;successful login redirects to dashboard&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;/login&#39;</span>)<span class="op">;</span></span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-8"><a href="#cb300-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">fill</span>(<span class="st">&#39;input[name=&quot;email&quot;]&#39;</span><span class="op">,</span> <span class="st">&#39;user@example.com&#39;</span>)<span class="op">;</span></span>
<span id="cb300-9"><a href="#cb300-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">fill</span>(<span class="st">&#39;input[name=&quot;password&quot;]&#39;</span><span class="op">,</span> <span class="st">&#39;password123&#39;</span>)<span class="op">;</span></span>
<span id="cb300-10"><a href="#cb300-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">click</span>(<span class="st">&#39;button[type=&quot;submit&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb300-11"><a href="#cb300-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-12"><a href="#cb300-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(page)<span class="op">.</span><span class="fu">toHaveURL</span>(<span class="st">&#39;/dashboard&#39;</span>)<span class="op">;</span></span>
<span id="cb300-13"><a href="#cb300-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;h1&#39;</span>))<span class="op">.</span><span class="fu">toHaveText</span>(<span class="st">&#39;Dashboard&#39;</span>)<span class="op">;</span></span>
<span id="cb300-14"><a href="#cb300-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb300-15"><a href="#cb300-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-16"><a href="#cb300-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;invalid credentials show error&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb300-17"><a href="#cb300-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;/login&#39;</span>)<span class="op">;</span></span>
<span id="cb300-18"><a href="#cb300-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-19"><a href="#cb300-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">fill</span>(<span class="st">&#39;input[name=&quot;email&quot;]&#39;</span><span class="op">,</span> <span class="st">&#39;wrong@example.com&#39;</span>)<span class="op">;</span></span>
<span id="cb300-20"><a href="#cb300-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">fill</span>(<span class="st">&#39;input[name=&quot;password&quot;]&#39;</span><span class="op">,</span> <span class="st">&#39;wrongpassword&#39;</span>)<span class="op">;</span></span>
<span id="cb300-21"><a href="#cb300-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">click</span>(<span class="st">&#39;button[type=&quot;submit&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb300-22"><a href="#cb300-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-23"><a href="#cb300-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;.error&#39;</span>))<span class="op">.</span><span class="fu">toHaveText</span>(<span class="st">&#39;Invalid credentials&#39;</span>)<span class="op">;</span></span>
<span id="cb300-24"><a href="#cb300-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(page)<span class="op">.</span><span class="fu">toHaveURL</span>(<span class="st">&#39;/login&#39;</span>)<span class="op">;</span></span>
<span id="cb300-25"><a href="#cb300-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb300-26"><a href="#cb300-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.5" id="mocking-fetch-requests"><span
class="header-section-number">14.5</span> Mocking Fetch Requests</h2>
<p>Control network responses in tests:</p>
<div class="sourceCode" id="cb301"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="co">// fetch-mock.js</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FetchMock {</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">mocks</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">originalFetch</span> <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">fetch</span><span class="op">;</span></span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb301-7"><a href="#cb301-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-8"><a href="#cb301-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mock</span>(url<span class="op">,</span> response<span class="op">,</span> options <span class="op">=</span> {}) {</span>
<span id="cb301-9"><a href="#cb301-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">mocks</span><span class="op">.</span><span class="fu">set</span>(url<span class="op">,</span> { response<span class="op">,</span> options })<span class="op">;</span></span>
<span id="cb301-10"><a href="#cb301-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb301-11"><a href="#cb301-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-12"><a href="#cb301-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enable</span>() {</span>
<span id="cb301-13"><a href="#cb301-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> <span class="kw">async</span> (url<span class="op">,</span> config) <span class="kw">=&gt;</span> {</span>
<span id="cb301-14"><a href="#cb301-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> mock <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">mocks</span><span class="op">.</span><span class="fu">get</span>(url)<span class="op">;</span></span>
<span id="cb301-15"><a href="#cb301-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (mock) {</span>
<span id="cb301-16"><a href="#cb301-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (mock<span class="op">.</span><span class="at">options</span><span class="op">.</span><span class="at">delay</span>) {</span>
<span id="cb301-17"><a href="#cb301-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(r <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(r<span class="op">,</span> mock<span class="op">.</span><span class="at">options</span><span class="op">.</span><span class="at">delay</span>))<span class="op">;</span></span>
<span id="cb301-18"><a href="#cb301-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb301-19"><a href="#cb301-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">Response</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(mock<span class="op">.</span><span class="at">response</span>)<span class="op">,</span> {</span>
<span id="cb301-20"><a href="#cb301-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">status</span><span class="op">:</span> mock<span class="op">.</span><span class="at">options</span><span class="op">.</span><span class="at">status</span> <span class="op">||</span> <span class="dv">200</span><span class="op">,</span></span>
<span id="cb301-21"><a href="#cb301-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }</span>
<span id="cb301-22"><a href="#cb301-22" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb301-23"><a href="#cb301-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb301-24"><a href="#cb301-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">originalFetch</span>(url<span class="op">,</span> config)<span class="op">;</span></span>
<span id="cb301-25"><a href="#cb301-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb301-26"><a href="#cb301-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb301-27"><a href="#cb301-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-28"><a href="#cb301-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disable</span>() {</span>
<span id="cb301-29"><a href="#cb301-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">originalFetch</span><span class="op">;</span></span>
<span id="cb301-30"><a href="#cb301-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">mocks</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb301-31"><a href="#cb301-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb301-32"><a href="#cb301-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb301-33"><a href="#cb301-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-34"><a href="#cb301-34" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> fetchMock <span class="op">=</span> <span class="kw">new</span> <span class="fu">FetchMock</span>()<span class="op">;</span></span></code></pre></div>
<p>Use in tests:</p>
<div class="sourceCode" id="cb302"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { fetchMock } <span class="im">from</span> <span class="st">&#39;./fetch-mock.js&#39;</span><span class="op">;</span></span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;UserList Component&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a>    fetchMock<span class="op">.</span><span class="fu">enable</span>()<span class="op">;</span></span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>    fetchMock<span class="op">.</span><span class="fu">mock</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> [</span>
<span id="cb302-7"><a href="#cb302-7" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Alice&#39;</span> }<span class="op">,</span></span>
<span id="cb302-8"><a href="#cb302-8" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Bob&#39;</span> }</span>
<span id="cb302-9"><a href="#cb302-9" aria-hidden="true" tabindex="-1"></a>    ])<span class="op">;</span></span>
<span id="cb302-10"><a href="#cb302-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb302-11"><a href="#cb302-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-12"><a href="#cb302-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">afterEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb302-13"><a href="#cb302-13" aria-hidden="true" tabindex="-1"></a>    fetchMock<span class="op">.</span><span class="fu">disable</span>()<span class="op">;</span></span>
<span id="cb302-14"><a href="#cb302-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb302-15"><a href="#cb302-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-16"><a href="#cb302-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;loads and displays users&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb302-17"><a href="#cb302-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;user-list&gt;&lt;/user-list&gt;`</span>)<span class="op">;</span></span>
<span id="cb302-18"><a href="#cb302-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb302-19"><a href="#cb302-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-20"><a href="#cb302-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> users <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.user&#39;</span>)<span class="op">;</span></span>
<span id="cb302-21"><a href="#cb302-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(users<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb302-22"><a href="#cb302-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb302-23"><a href="#cb302-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.6" id="visual-regression-testing-1"><span
class="header-section-number">14.6</span> Visual Regression Testing</h2>
<p>Catch visual changes with screenshot comparison:</p>
<div class="sourceCode" id="cb303"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co">// visual.test.js</span></span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { test<span class="op">,</span> expect } <span class="im">from</span> <span class="st">&#39;@playwright/test&#39;</span><span class="op">;</span></span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">describe</span>(<span class="st">&#39;Visual Regression&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;button should match snapshot&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;/components/button&#39;</span>)<span class="op">;</span></span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> button <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;app-button&#39;</span>)<span class="op">;</span></span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(button)<span class="op">.</span><span class="fu">toHaveScreenshot</span>(<span class="st">&#39;button-default.png&#39;</span>)<span class="op">;</span></span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-12"><a href="#cb303-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;button hover state&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb303-13"><a href="#cb303-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;/components/button&#39;</span>)<span class="op">;</span></span>
<span id="cb303-14"><a href="#cb303-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-15"><a href="#cb303-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> button <span class="op">=</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;app-button&#39;</span>)<span class="op">;</span></span>
<span id="cb303-16"><a href="#cb303-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> button<span class="op">.</span><span class="fu">hover</span>()<span class="op">;</span></span>
<span id="cb303-17"><a href="#cb303-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(button)<span class="op">.</span><span class="fu">toHaveScreenshot</span>(<span class="st">&#39;button-hover.png&#39;</span>)<span class="op">;</span></span>
<span id="cb303-18"><a href="#cb303-18" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb303-19"><a href="#cb303-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-20"><a href="#cb303-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">test</span>(<span class="st">&#39;dark mode theme&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ page }) <span class="kw">=&gt;</span> {</span>
<span id="cb303-21"><a href="#cb303-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">goto</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></span>
<span id="cb303-22"><a href="#cb303-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> page<span class="op">.</span><span class="fu">locator</span>(<span class="st">&#39;[data-theme-toggle]&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb303-23"><a href="#cb303-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-24"><a href="#cb303-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">expect</span>(page)<span class="op">.</span><span class="fu">toHaveScreenshot</span>(<span class="st">&#39;homepage-dark.png&#39;</span><span class="op">,</span> {</span>
<span id="cb303-25"><a href="#cb303-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fullPage</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb303-26"><a href="#cb303-26" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb303-27"><a href="#cb303-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb303-28"><a href="#cb303-28" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Run visual tests:</p>
<div class="sourceCode" id="cb304"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First run creates baseline screenshots</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> playwright test visual.test.js</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Subsequent runs compare against baseline</span></span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> playwright test visual.test.js</span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Update baselines when changes are intentional</span></span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> playwright test visual.test.js <span class="at">--update-snapshots</span></span></code></pre></div>
<h2 data-number="14.7" id="test-coverage"><span
class="header-section-number">14.7</span> Test Coverage</h2>
<p>Track which code is tested:</p>
<div class="sourceCode" id="cb305"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="co">// web-test-runner.config.js</span></span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">coverage</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">coverageConfig</span><span class="op">:</span> {</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">threshold</span><span class="op">:</span> {</span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">statements</span><span class="op">:</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">branches</span><span class="op">:</span> <span class="dv">75</span><span class="op">,</span></span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">functions</span><span class="op">:</span> <span class="dv">80</span><span class="op">,</span></span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lines</span><span class="op">:</span> <span class="dv">80</span></span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb305-11"><a href="#cb305-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">include</span><span class="op">:</span> [<span class="st">&#39;src/**/*.js&#39;</span>]<span class="op">,</span></span>
<span id="cb305-12"><a href="#cb305-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">exclude</span><span class="op">:</span> [<span class="st">&#39;src/**/*.test.js&#39;</span><span class="op">,</span> <span class="st">&#39;src/test/**&#39;</span>]</span>
<span id="cb305-13"><a href="#cb305-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb305-14"><a href="#cb305-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Generate coverage reports:</p>
<div class="sourceCode" id="cb306"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> wtr <span class="at">--coverage</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View HTML report</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> coverage/index.html</span></code></pre></div>
<h3 data-number="14.7.1" id="what-to-test"><span
class="header-section-number">14.7.1</span> What to Test</h3>
<p>Focus on:</p>
<ul>
<li><strong>Public API</strong> - Methods users will call</li>
<li><strong>Edge cases</strong> - Empty inputs, null values, errors</li>
<li><strong>State changes</strong> - Component updates correctly</li>
<li><strong>User interactions</strong> - Clicks, typing, form
submission</li>
<li><strong>Integration points</strong> - Component communication</li>
</ul>
<p>Skip testing:</p>
<ul>
<li><strong>Framework internals</strong> - Trust Web Components API</li>
<li><strong>Third-party libraries</strong> - They have their own
tests</li>
<li><strong>Trivial code</strong> - Simple getters/setters</li>
</ul>
<h2 data-number="14.8" id="component-testing-patterns"><span
class="header-section-number">14.8</span> Component Testing
Patterns</h2>
<h3 data-number="14.8.1" id="testing-async-loading"><span
class="header-section-number">14.8.1</span> Testing Async Loading</h3>
<div class="sourceCode" id="cb307"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;shows loading state then data&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;user-profile user-id=&quot;1&quot;&gt;&lt;/user-profile&gt;`</span>)<span class="op">;</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Should show loading initially</span></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loading&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Wait for data</span></span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">waitUntil</span>(() <span class="kw">=&gt;</span> <span class="op">!</span>el<span class="op">.</span><span class="at">loading</span>)<span class="op">;</span></span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Should show user data</span></span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.user-name&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">have</span><span class="op">.</span><span class="fu">text</span>(<span class="st">&#39;Alice&#39;</span>)<span class="op">;</span></span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.loading&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.8.2" id="testing-error-states"><span
class="header-section-number">14.8.2</span> Testing Error States</h3>
<div class="sourceCode" id="cb308"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;displays error message on fetch failure&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>  fetchMock<span class="op">.</span><span class="fu">mock</span>(<span class="st">&#39;/api/users&#39;</span><span class="op">,</span> { <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Server error&#39;</span> }<span class="op">,</span> { <span class="dt">status</span><span class="op">:</span> <span class="dv">500</span> })<span class="op">;</span></span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;user-list&gt;&lt;/user-list&gt;`</span>)<span class="op">;</span></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.error&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">have</span><span class="op">.</span><span class="fu">text</span>(<span class="st">&#39;Failed to load users&#39;</span>)<span class="op">;</span></span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.8.3" id="testing-form-validation"><span
class="header-section-number">14.8.3</span> Testing Form Validation</h3>
<div class="sourceCode" id="cb309"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;validates email format&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;login-form&gt;&lt;/login-form&gt;`</span>)<span class="op">;</span></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> emailInput <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#email&#39;</span>)<span class="op">;</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> form <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;form&#39;</span>)<span class="op">;</span></span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Invalid email</span></span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a>  emailInput<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&#39;notanemail&#39;</span><span class="op">;</span></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a>  emailInput<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">Event</span>(<span class="st">&#39;input&#39;</span>))<span class="op">;</span></span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;Invalid email format&#39;</span>)<span class="op">;</span></span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Valid email</span></span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a>  emailInput<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&#39;user@example.com&#39;</span><span class="op">;</span></span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a>  emailInput<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">Event</span>(<span class="st">&#39;input&#39;</span>))<span class="op">;</span></span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(el<span class="op">.</span><span class="at">errors</span><span class="op">.</span><span class="at">email</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="at">undefined</span><span class="op">;</span></span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.8.4" id="testing-component-communication"><span
class="header-section-number">14.8.4</span> Testing Component
Communication</h3>
<div class="sourceCode" id="cb310"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;publishes event on button click&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;add-todo&gt;&lt;/add-todo&gt;`</span>)<span class="op">;</span></span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> publishedData <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>  mockPan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;todo.added&#39;</span><span class="op">,</span> (msg) <span class="kw">=&gt;</span> {</span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a>    publishedData <span class="op">=</span> msg<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-9"><a href="#cb310-9" aria-hidden="true" tabindex="-1"></a>  el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#todo-input&#39;</span>)<span class="op">.</span><span class="at">value</span> <span class="op">=</span> <span class="st">&#39;Buy milk&#39;</span><span class="op">;</span></span>
<span id="cb310-10"><a href="#cb310-10" aria-hidden="true" tabindex="-1"></a>  el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;button&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb310-11"><a href="#cb310-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-12"><a href="#cb310-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(publishedData)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">deep</span><span class="op">.</span><span class="fu">equal</span>({ <span class="dt">text</span><span class="op">:</span> <span class="st">&#39;Buy milk&#39;</span> })<span class="op">;</span></span>
<span id="cb310-13"><a href="#cb310-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.9" id="cicd-integration"><span
class="header-section-number">14.9</span> CI/CD Integration</h2>
<h3 data-number="14.9.1" id="github-actions"><span
class="header-section-number">14.9.1</span> GitHub Actions</h3>
<div class="sourceCode" id="cb311"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/test.yml</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Tests</span></span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">,</span><span class="at"> pull_request</span><span class="kw">]</span></span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb311-8"><a href="#cb311-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb311-9"><a href="#cb311-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-10"><a href="#cb311-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb311-11"><a href="#cb311-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb311-12"><a href="#cb311-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-13"><a href="#cb311-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Node.js</span></span>
<span id="cb311-14"><a href="#cb311-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v3</span></span>
<span id="cb311-15"><a href="#cb311-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb311-16"><a href="#cb311-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;18&#39;</span></span>
<span id="cb311-17"><a href="#cb311-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cache</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;npm&#39;</span></span>
<span id="cb311-18"><a href="#cb311-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-19"><a href="#cb311-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb311-20"><a href="#cb311-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm ci</span></span>
<span id="cb311-21"><a href="#cb311-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-22"><a href="#cb311-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run unit tests</span></span>
<span id="cb311-23"><a href="#cb311-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm test</span></span>
<span id="cb311-24"><a href="#cb311-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-25"><a href="#cb311-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run E2E tests</span></span>
<span id="cb311-26"><a href="#cb311-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npx playwright test</span></span>
<span id="cb311-27"><a href="#cb311-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-28"><a href="#cb311-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload test results</span></span>
<span id="cb311-29"><a href="#cb311-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> failure()</span></span>
<span id="cb311-30"><a href="#cb311-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v3</span></span>
<span id="cb311-31"><a href="#cb311-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb311-32"><a href="#cb311-32" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> test-results</span></span>
<span id="cb311-33"><a href="#cb311-33" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> test-results/</span></span>
<span id="cb311-34"><a href="#cb311-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-35"><a href="#cb311-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload coverage</span></span>
<span id="cb311-36"><a href="#cb311-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> codecov/codecov-action@v3</span></span>
<span id="cb311-37"><a href="#cb311-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb311-38"><a href="#cb311-38" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">files</span><span class="kw">:</span><span class="at"> ./coverage/lcov.info</span></span></code></pre></div>
<h3 data-number="14.9.2" id="gitlab-ci"><span
class="header-section-number">14.9.2</span> GitLab CI</h3>
<div class="sourceCode" id="cb312"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .gitlab-ci.yml</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stages</span><span class="kw">:</span></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> test</span></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> report</span></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">stage</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">image</span><span class="kw">:</span><span class="at"> node:18</span></span>
<span id="cb312-9"><a href="#cb312-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cache</span><span class="kw">:</span></span>
<span id="cb312-10"><a href="#cb312-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb312-11"><a href="#cb312-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> node_modules/</span></span>
<span id="cb312-12"><a href="#cb312-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb312-13"><a href="#cb312-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> npm ci</span></span>
<span id="cb312-14"><a href="#cb312-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> npm test</span></span>
<span id="cb312-15"><a href="#cb312-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> npx playwright test</span></span>
<span id="cb312-16"><a href="#cb312-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">artifacts</span><span class="kw">:</span></span>
<span id="cb312-17"><a href="#cb312-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">when</span><span class="kw">:</span><span class="at"> always</span></span>
<span id="cb312-18"><a href="#cb312-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb312-19"><a href="#cb312-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> coverage/</span></span>
<span id="cb312-20"><a href="#cb312-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> test-results/</span></span>
<span id="cb312-21"><a href="#cb312-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">reports</span><span class="kw">:</span></span>
<span id="cb312-22"><a href="#cb312-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">coverage_report</span><span class="kw">:</span></span>
<span id="cb312-23"><a href="#cb312-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">coverage_format</span><span class="kw">:</span><span class="at"> cobertura</span></span>
<span id="cb312-24"><a href="#cb312-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> coverage/cobertura-coverage.xml</span></span>
<span id="cb312-25"><a href="#cb312-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-26"><a href="#cb312-26" aria-hidden="true" tabindex="-1"></a><span class="fu">coverage</span><span class="kw">:</span></span>
<span id="cb312-27"><a href="#cb312-27" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">stage</span><span class="kw">:</span><span class="at"> report</span></span>
<span id="cb312-28"><a href="#cb312-28" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">image</span><span class="kw">:</span><span class="at"> node:18</span></span>
<span id="cb312-29"><a href="#cb312-29" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">script</span><span class="kw">:</span></span>
<span id="cb312-30"><a href="#cb312-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> npx nyc report --reporter=text-summary</span></span>
<span id="cb312-31"><a href="#cb312-31" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">coverage</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;/Lines\s*:\s*(\d+\.\d+)%/&#39;</span></span></code></pre></div>
<h2 data-number="14.10" id="test-driven-development-tdd"><span
class="header-section-number">14.10</span> Test-Driven Development
(TDD)</h2>
<p>Write tests first, then implement:</p>
<h3 data-number="14.10.1"
id="example-building-a-counter-component"><span
class="header-section-number">14.10.1</span> Example: Building a Counter
Component</h3>
<p><strong>Step 1: Write the test</strong></p>
<div class="sourceCode" id="cb313"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="co">// counter.test.js</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;Counter&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;starts at zero&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> counter <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;app-counter&gt;&lt;/app-counter&gt;`</span>)<span class="op">;</span></span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.count&#39;</span>)<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;0&#39;</span>)<span class="op">;</span></span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;increments when plus button clicked&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb313-9"><a href="#cb313-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> counter <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;app-counter&gt;&lt;/app-counter&gt;`</span>)<span class="op">;</span></span>
<span id="cb313-10"><a href="#cb313-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-11"><a href="#cb313-11" aria-hidden="true" tabindex="-1"></a>    counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.plus-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb313-12"><a href="#cb313-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> counter<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb313-13"><a href="#cb313-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-14"><a href="#cb313-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.count&#39;</span>)<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;1&#39;</span>)<span class="op">;</span></span>
<span id="cb313-15"><a href="#cb313-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb313-16"><a href="#cb313-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-17"><a href="#cb313-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;decrements when minus button clicked&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb313-18"><a href="#cb313-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> counter <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;app-counter&gt;&lt;/app-counter&gt;`</span>)<span class="op">;</span></span>
<span id="cb313-19"><a href="#cb313-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-20"><a href="#cb313-20" aria-hidden="true" tabindex="-1"></a>    counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.plus-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb313-21"><a href="#cb313-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> counter<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb313-22"><a href="#cb313-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-23"><a href="#cb313-23" aria-hidden="true" tabindex="-1"></a>    counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.minus-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb313-24"><a href="#cb313-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> counter<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb313-25"><a href="#cb313-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-26"><a href="#cb313-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.count&#39;</span>)<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;0&#39;</span>)<span class="op">;</span></span>
<span id="cb313-27"><a href="#cb313-27" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb313-28"><a href="#cb313-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-29"><a href="#cb313-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;never goes below zero&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb313-30"><a href="#cb313-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> counter <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;app-counter&gt;&lt;/app-counter&gt;`</span>)<span class="op">;</span></span>
<span id="cb313-31"><a href="#cb313-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-32"><a href="#cb313-32" aria-hidden="true" tabindex="-1"></a>    counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.minus-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb313-33"><a href="#cb313-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> counter<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb313-34"><a href="#cb313-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-35"><a href="#cb313-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(counter<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.count&#39;</span>)<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;0&#39;</span>)<span class="op">;</span></span>
<span id="cb313-36"><a href="#cb313-36" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb313-37"><a href="#cb313-37" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Step 2: Run tests (they fail)</strong></p>
<div class="sourceCode" id="cb314"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> wtr</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a><span class="co"># All tests fail - component doesn&#39;t exist yet</span></span></code></pre></div>
<p><strong>Step 3: Implement minimal code</strong></p>
<div class="sourceCode" id="cb315"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="co">// counter.js</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb315-5"><a href="#cb315-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb315-6"><a href="#cb315-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb315-7"><a href="#cb315-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-8"><a href="#cb315-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-9"><a href="#cb315-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb315-10"><a href="#cb315-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb315-11"><a href="#cb315-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-12"><a href="#cb315-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-13"><a href="#cb315-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span>() {</span>
<span id="cb315-14"><a href="#cb315-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb315-15"><a href="#cb315-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb315-16"><a href="#cb315-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-17"><a href="#cb315-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-18"><a href="#cb315-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">decrement</span>() {</span>
<span id="cb315-19"><a href="#cb315-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb315-20"><a href="#cb315-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">--;</span></span>
<span id="cb315-21"><a href="#cb315-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb315-22"><a href="#cb315-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb315-23"><a href="#cb315-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-24"><a href="#cb315-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-25"><a href="#cb315-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb315-26"><a href="#cb315-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb315-27"><a href="#cb315-27" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div&gt;</span></span>
<span id="cb315-28"><a href="#cb315-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;minus-btn&quot;&gt;-&lt;/button&gt;</span></span>
<span id="cb315-29"><a href="#cb315-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;count&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb315-30"><a href="#cb315-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;plus-btn&quot;&gt;+&lt;/button&gt;</span></span>
<span id="cb315-31"><a href="#cb315-31" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb315-32"><a href="#cb315-32" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb315-33"><a href="#cb315-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-34"><a href="#cb315-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.plus-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">increment</span>())<span class="op">;</span></span>
<span id="cb315-35"><a href="#cb315-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.minus-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">decrement</span>())<span class="op">;</span></span>
<span id="cb315-36"><a href="#cb315-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-37"><a href="#cb315-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-38"><a href="#cb315-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">updateComplete</span>() {</span>
<span id="cb315-39"><a href="#cb315-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>()<span class="op">;</span></span>
<span id="cb315-40"><a href="#cb315-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb315-41"><a href="#cb315-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb315-42"><a href="#cb315-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-43"><a href="#cb315-43" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;app-counter&#39;</span><span class="op">,</span> Counter)<span class="op">;</span></span></code></pre></div>
<p><strong>Step 4: Run tests (they pass)</strong></p>
<div class="sourceCode" id="cb316"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> wtr</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a><span class="co"># All tests pass!</span></span></code></pre></div>
<p><strong>Step 5: Refactor with confidence</strong></p>
<p>Tests ensure refactoring doesn’t break functionality.</p>
<h2 data-number="14.11" id="advanced-testing-patterns"><span
class="header-section-number">14.11</span> Advanced Testing
Patterns</h2>
<h3 data-number="14.11.1" id="testing-custom-events"><span
class="header-section-number">14.11.1</span> Testing Custom Events</h3>
<div class="sourceCode" id="cb317"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;dispatches custom event with detail&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;product-card&gt;&lt;/product-card&gt;`</span>)<span class="op">;</span></span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> eventDetail <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a>  el<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;add-to-cart&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a>    eventDetail <span class="op">=</span> e<span class="op">.</span><span class="at">detail</span><span class="op">;</span></span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a>  el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.add-btn&#39;</span>)<span class="op">.</span><span class="fu">click</span>()<span class="op">;</span></span>
<span id="cb317-10"><a href="#cb317-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-11"><a href="#cb317-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(eventDetail)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">deep</span><span class="op">.</span><span class="fu">equal</span>({</span>
<span id="cb317-12"><a href="#cb317-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">productId</span><span class="op">:</span> <span class="dv">123</span><span class="op">,</span></span>
<span id="cb317-13"><a href="#cb317-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb317-14"><a href="#cb317-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb317-15"><a href="#cb317-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.11.2" id="testing-slots"><span
class="header-section-number">14.11.2</span> Testing Slots</h3>
<div class="sourceCode" id="cb318"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;renders slotted content&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;card-component&gt;</span></span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h2 slot=&quot;title&quot;&gt;My Title&lt;/h2&gt;</span></span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p&gt;My content&lt;/p&gt;</span></span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/card-component&gt;</span></span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;slot[name=&quot;title&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb318-10"><a href="#cb318-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> assignedNodes <span class="op">=</span> title<span class="op">.</span><span class="fu">assignedNodes</span>()<span class="op">;</span></span>
<span id="cb318-11"><a href="#cb318-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-12"><a href="#cb318-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(assignedNodes[<span class="dv">0</span>]<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;My Title&#39;</span>)<span class="op">;</span></span>
<span id="cb318-13"><a href="#cb318-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.11.3" id="testing-accessibility"><span
class="header-section-number">14.11.3</span> Testing Accessibility</h3>
<div class="sourceCode" id="cb319"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { expect } <span class="im">from</span> <span class="st">&#39;@open-wc/testing&#39;</span><span class="op">;</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;is accessible&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;my-button&gt;Click me&lt;/my-button&gt;`</span>)<span class="op">;</span></span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">expect</span>(el)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="fu">accessible</span>()<span class="op">;</span></span>
<span id="cb319-7"><a href="#cb319-7" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb319-8"><a href="#cb319-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-9"><a href="#cb319-9" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;has correct ARIA attributes&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb319-10"><a href="#cb319-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;dialog-box&gt;&lt;/dialog-box&gt;`</span>)<span class="op">;</span></span>
<span id="cb319-11"><a href="#cb319-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-12"><a href="#cb319-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dialog <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[role=&quot;dialog&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb319-13"><a href="#cb319-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(dialog)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">have</span><span class="op">.</span><span class="fu">attribute</span>(<span class="st">&#39;aria-modal&#39;</span><span class="op">,</span> <span class="st">&#39;true&#39;</span>)<span class="op">;</span></span>
<span id="cb319-14"><a href="#cb319-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(dialog)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">have</span><span class="op">.</span><span class="fu">attribute</span>(<span class="st">&#39;aria-labelledby&#39;</span>)<span class="op">;</span></span>
<span id="cb319-15"><a href="#cb319-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="14.11.4" id="testing-keyboard-navigation"><span
class="header-section-number">14.11.4</span> Testing Keyboard
Navigation</h3>
<div class="sourceCode" id="cb320"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;navigates with arrow keys&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;tab-panel&gt;</span></span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tab-item&gt;Tab 1&lt;/tab-item&gt;</span></span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tab-item&gt;Tab 2&lt;/tab-item&gt;</span></span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tab-item&gt;Tab 3&lt;/tab-item&gt;</span></span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a><span class="vs">    &lt;/tab-panel&gt;</span></span>
<span id="cb320-8"><a href="#cb320-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb320-9"><a href="#cb320-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-10"><a href="#cb320-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tabs <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;tab-item&#39;</span>)<span class="op">;</span></span>
<span id="cb320-11"><a href="#cb320-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-12"><a href="#cb320-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Focus first tab</span></span>
<span id="cb320-13"><a href="#cb320-13" aria-hidden="true" tabindex="-1"></a>  tabs[<span class="dv">0</span>]<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb320-14"><a href="#cb320-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-15"><a href="#cb320-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Press arrow right</span></span>
<span id="cb320-16"><a href="#cb320-16" aria-hidden="true" tabindex="-1"></a>  tabs[<span class="dv">0</span>]<span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">KeyboardEvent</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> { <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;ArrowRight&#39;</span> }))<span class="op">;</span></span>
<span id="cb320-17"><a href="#cb320-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-18"><a href="#cb320-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(tabs[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb320-19"><a href="#cb320-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.12" id="performance-testing"><span
class="header-section-number">14.12</span> Performance Testing</h2>
<p>Test component performance:</p>
<div class="sourceCode" id="cb321"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="fu">it</span>(<span class="st">&#39;renders large list efficiently&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> items <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>({ <span class="dt">length</span><span class="op">:</span> <span class="dv">10000</span> }<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({</span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span><span class="op">:</span> i<span class="op">,</span></span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span><span class="op">:</span> <span class="vs">`Item </span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;virtual-list .items=</span><span class="sc">${</span>items<span class="sc">}</span><span class="vs">&gt;&lt;/virtual-list&gt;`</span>)<span class="op">;</span></span>
<span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb321-11"><a href="#cb321-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-12"><a href="#cb321-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> renderTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb321-13"><a href="#cb321-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-14"><a href="#cb321-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Should render in under 100ms</span></span>
<span id="cb321-15"><a href="#cb321-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(renderTime)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="fu">lessThan</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb321-16"><a href="#cb321-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-17"><a href="#cb321-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Should only render visible items</span></span>
<span id="cb321-18"><a href="#cb321-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> renderedItems <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.item&#39;</span>)<span class="op">;</span></span>
<span id="cb321-19"><a href="#cb321-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect</span>(renderedItems<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="fu">lessThan</span>(<span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb321-20"><a href="#cb321-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.13" id="troubleshooting-tests"><span
class="header-section-number">14.13</span> Troubleshooting Tests</h2>
<h3 data-number="14.13.1"
id="problem-tests-pass-locally-but-fail-in-ci"><span
class="header-section-number">14.13.1</span> Problem: Tests Pass Locally
but Fail in CI</h3>
<p><strong>Symptom</strong>: Tests work on your machine but fail in
GitHub Actions</p>
<p><strong>Solution</strong>: Common issues:</p>
<div class="sourceCode" id="cb322"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Timing issues - add proper waits</span></span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">waitUntil</span>(() <span class="kw">=&gt;</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.data&#39;</span>))<span class="op">;</span></span>
<span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-4"><a href="#cb322-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Browser differences - use consistent browser</span></span>
<span id="cb322-5"><a href="#cb322-5" aria-hidden="true" tabindex="-1"></a><span class="co">// playwright.config.js</span></span>
<span id="cb322-6"><a href="#cb322-6" aria-hidden="true" tabindex="-1"></a>projects<span class="op">:</span> [</span>
<span id="cb322-7"><a href="#cb322-7" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;chromium&#39;</span><span class="op">,</span> <span class="dt">use</span><span class="op">:</span> { <span class="op">...</span>devices[<span class="st">&#39;Desktop Chrome&#39;</span>] } }</span>
<span id="cb322-8"><a href="#cb322-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb322-9"><a href="#cb322-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-10"><a href="#cb322-10" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. Port conflicts - use random ports</span></span>
<span id="cb322-11"><a href="#cb322-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> port <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">10000</span>) <span class="op">+</span> <span class="dv">50000</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="14.13.2" id="problem-flaky-tests"><span
class="header-section-number">14.13.2</span> Problem: Flaky Tests</h3>
<p><strong>Symptom</strong>: Tests sometimes pass, sometimes fail</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb323"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad: Fixed timeout</span></span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span></span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: Wait for condition</span></span>
<span id="cb323-5"><a href="#cb323-5" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="fu">waitUntil</span>(() <span class="kw">=&gt;</span> el<span class="op">.</span><span class="at">dataLoaded</span>)<span class="op">;</span></span>
<span id="cb323-6"><a href="#cb323-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-7"><a href="#cb323-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad: Race condition</span></span>
<span id="cb323-8"><a href="#cb323-8" aria-hidden="true" tabindex="-1"></a>el<span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb323-9"><a href="#cb323-9" aria-hidden="true" tabindex="-1"></a><span class="fu">expect</span>(el<span class="op">.</span><span class="at">data</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb323-10"><a href="#cb323-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-11"><a href="#cb323-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: Wait for async</span></span>
<span id="cb323-12"><a href="#cb323-12" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> el<span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb323-13"><a href="#cb323-13" aria-hidden="true" tabindex="-1"></a><span class="fu">expect</span>(el<span class="op">.</span><span class="at">data</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="14.13.3" id="problem-slow-tests"><span
class="header-section-number">14.13.3</span> Problem: Slow Tests</h3>
<p><strong>Symptom</strong>: Test suite takes too long</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb324"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Run tests in parallel</span></span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="co">// web-test-runner.config.js</span></span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">concurrency</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">nodeResolve</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Mock expensive operations</span></span>
<span id="cb324-9"><a href="#cb324-9" aria-hidden="true" tabindex="-1"></a><span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb324-10"><a href="#cb324-10" aria-hidden="true" tabindex="-1"></a>  fetchMock<span class="op">.</span><span class="fu">mock</span>(<span class="st">&#39;/api/expensive&#39;</span><span class="op">,</span> cachedData)<span class="op">;</span></span>
<span id="cb324-11"><a href="#cb324-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb324-12"><a href="#cb324-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-13"><a href="#cb324-13" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. Skip browser for pure logic</span></span>
<span id="cb324-14"><a href="#cb324-14" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;pure functions&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb324-15"><a href="#cb324-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;calculates correctly&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb324-16"><a href="#cb324-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(<span class="fu">calculateTotal</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">6</span>)<span class="op">;</span></span>
<span id="cb324-17"><a href="#cb324-17" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb324-18"><a href="#cb324-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="14.14" id="best-practices-10"><span
class="header-section-number">14.14</span> Best Practices</h2>
<ol type="1">
<li><strong>Test behavior, not implementation</strong> - Test what users
see, not internal details</li>
<li><strong>Keep tests focused</strong> - One assertion per test when
possible</li>
<li><strong>Use descriptive names</strong> - Test names should document
behavior</li>
<li><strong>Avoid test interdependence</strong> - Each test should run
independently</li>
<li><strong>Mock external dependencies</strong> - Don’t rely on real
APIs</li>
<li><strong>Test error paths</strong> - Test failures, not just
successes</li>
<li><strong>Run tests often</strong> - Catch bugs early</li>
<li><strong>Maintain test code</strong> - Refactor tests like production
code</li>
<li><strong>Use setup/teardown</strong> - DRY principle applies to
tests</li>
<li><strong>Achieve good coverage</strong> - Aim for 80%+, but focus on
critical paths</li>
</ol>
<h2 data-number="14.15" id="exercises-4"><span
class="header-section-number">14.15</span> Exercises</h2>
<h3 data-number="14.15.1" id="exercise-1-test-a-todo-component"><span
class="header-section-number">14.15.1</span> Exercise 1: Test a Todo
Component</h3>
<p>Write comprehensive tests for a todo component:</p>
<ul>
<li>Renders list of todos</li>
<li>Adds new todo when form submitted</li>
<li>Toggles complete status on click</li>
<li>Deletes todo when delete button clicked</li>
<li>Shows empty state when no todos</li>
<li>Validates input before adding</li>
</ul>
<p><strong>Bonus</strong>: Test keyboard shortcuts (Enter to submit,
Escape to clear).</p>
<h3 data-number="14.15.2" id="exercise-2-e2e-shopping-flow"><span
class="header-section-number">14.15.2</span> Exercise 2: E2E Shopping
Flow</h3>
<p>Create E2E tests for shopping cart:</p>
<ul>
<li>Browse products</li>
<li>Add items to cart</li>
<li>Update quantities</li>
<li>Apply coupon code</li>
<li>Complete checkout</li>
<li>Verify order confirmation</li>
</ul>
<p><strong>Bonus</strong>: Test as guest and authenticated user.</p>
<h3 data-number="14.15.3" id="exercise-3-visual-regression-suite"><span
class="header-section-number">14.15.3</span> Exercise 3: Visual
Regression Suite</h3>
<p>Set up visual regression testing:</p>
<ul>
<li>Capture screenshots of all components</li>
<li>Test different states (hover, focus, disabled)</li>
<li>Test responsive breakpoints</li>
<li>Test dark/light themes</li>
<li>Integrate into CI pipeline</li>
</ul>
<p><strong>Bonus</strong>: Add Percy or Chromatic for cloud-based visual
testing.</p>
<h3 data-number="14.15.4" id="exercise-4-tdd-calculator"><span
class="header-section-number">14.15.4</span> Exercise 4: TDD
Calculator</h3>
<p>Build a calculator component using TDD:</p>
<ul>
<li>Write tests first for basic operations (+, -, ×, ÷)</li>
<li>Implement each operation one at a time</li>
<li>Add tests for edge cases (divide by zero, overflow)</li>
<li>Add memory functions (MC, MR, M+, M-)</li>
<li>Keep tests passing throughout</li>
</ul>
<p><strong>Bonus</strong>: Add scientific functions (sin, cos,
sqrt).</p>
<hr />
<h2 data-number="14.16" id="summary-13"><span
class="header-section-number">14.16</span> Summary</h2>
<p>Testing ensures your LARC applications work correctly and continue
working as you make changes:</p>
<ul>
<li><strong>Unit tests</strong> verify individual components in
isolation</li>
<li><strong>Integration tests</strong> verify components work
together</li>
<li><strong>E2E tests</strong> verify complete user workflows</li>
<li><strong>Visual regression tests</strong> catch unintended visual
changes</li>
<li><strong>Test coverage</strong> ensures critical code is tested</li>
<li><strong>CI/CD integration</strong> catches problems before
deployment</li>
<li><strong>TDD</strong> helps design better components</li>
</ul>
<p>Good tests give you confidence to refactor, add features, and deploy.
They’re not overhead—they’re insurance that saves time debugging
production issues.</p>
<hr />
<h2 data-number="14.17" id="further-reading-13"><span
class="header-section-number">14.17</span> Further Reading</h2>
<p><strong>For complete testing reference:</strong> - <em>Building with
LARC</em> Chapter 13: Testing Strategies - All testing patterns and
tools - <em>Building with LARC</em> Appendix E: Recipes and Patterns -
Testing recipes and examples - <a
href="https://open-wc.org/docs/testing/testing-package/"><span
class="citation" data-cites="open-wc/testing">@open-wc/testing</span>
documentation</a> - <a href="https://playwright.dev/">Playwright
documentation</a></p>
<div class="pagebreak">

</div>
<h1 data-number="15" id="performance-and-optimization"><span
class="header-section-number">15</span> Performance and
Optimization</h1>
<p>Performance is a feature. Slow applications frustrate users and hurt
business metrics. LARC’s no-build philosophy gives you a head start—no
framework overhead, no transpilation artifacts—but there’s more you can
do.</p>
<h2 data-number="15.1" id="lazy-loading-components"><span
class="header-section-number">15.1</span> Lazy Loading Components</h2>
<p>Don’t load everything upfront. Load components when needed:</p>
<div class="sourceCode" id="cb325"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Lazy load on route change</span></span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ path }) <span class="kw">=&gt;</span> {</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (path <span class="op">===</span> <span class="st">&#39;/admin&#39;</span>) {</span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./components/admin-panel.js&#39;</span>)<span class="op">;</span></span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Lazy load on user interaction</span></span>
<span id="cb325-9"><a href="#cb325-9" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.show-chart&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb325-10"><a href="#cb325-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { ChartComponent } <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./components/chart.js&#39;</span>)<span class="op">;</span></span>
<span id="cb325-11"><a href="#cb325-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use component</span></span>
<span id="cb325-12"><a href="#cb325-12" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> { <span class="dt">once</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb325-13"><a href="#cb325-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-14"><a href="#cb325-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Lazy load when visible</span></span>
<span id="cb325-15"><a href="#cb325-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>(<span class="kw">async</span> (entries) <span class="kw">=&gt;</span> {</span>
<span id="cb325-16"><a href="#cb325-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> entry <span class="kw">of</span> entries) {</span>
<span id="cb325-17"><a href="#cb325-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (entry<span class="op">.</span><span class="at">isIntersecting</span>) {</span>
<span id="cb325-18"><a href="#cb325-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> component <span class="op">=</span> entry<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">component</span><span class="op">;</span></span>
<span id="cb325-19"><a href="#cb325-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> <span class="im">import</span>(<span class="vs">`./components/</span><span class="sc">${</span>component<span class="sc">}</span><span class="vs">.js`</span>)<span class="op">;</span></span>
<span id="cb325-20"><a href="#cb325-20" aria-hidden="true" tabindex="-1"></a>      observer<span class="op">.</span><span class="fu">unobserve</span>(entry<span class="op">.</span><span class="at">target</span>)<span class="op">;</span></span>
<span id="cb325-21"><a href="#cb325-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb325-22"><a href="#cb325-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb325-23"><a href="#cb325-23" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb325-24"><a href="#cb325-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb325-25"><a href="#cb325-25" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-lazy]&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(el <span class="kw">=&gt;</span> observer<span class="op">.</span><span class="fu">observe</span>(el))<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.2" id="image-optimization"><span
class="header-section-number">15.2</span> Image Optimization</h2>
<p>Images are often the largest assets. Optimize them:</p>
<div class="sourceCode" id="cb326"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LazyImage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;img</span></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a><span class="vs">        loading=&quot;lazy&quot;</span></span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;placeholder&#39;</span>) <span class="op">||</span> <span class="st">&#39;placeholder.svg&#39;</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a><span class="vs">        data-src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;src&#39;</span>)<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a><span class="vs">        alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;alt&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &gt;</span></span>
<span id="cb326-10"><a href="#cb326-10" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb326-11"><a href="#cb326-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-12"><a href="#cb326-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> img <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;img&#39;</span>)<span class="op">;</span></span>
<span id="cb326-13"><a href="#cb326-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-14"><a href="#cb326-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>((entries) <span class="kw">=&gt;</span> {</span>
<span id="cb326-15"><a href="#cb326-15" aria-hidden="true" tabindex="-1"></a>      entries<span class="op">.</span><span class="fu">forEach</span>(entry <span class="kw">=&gt;</span> {</span>
<span id="cb326-16"><a href="#cb326-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (entry<span class="op">.</span><span class="at">isIntersecting</span>) {</span>
<span id="cb326-17"><a href="#cb326-17" aria-hidden="true" tabindex="-1"></a>          img<span class="op">.</span><span class="at">src</span> <span class="op">=</span> img<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">src</span><span class="op">;</span></span>
<span id="cb326-18"><a href="#cb326-18" aria-hidden="true" tabindex="-1"></a>          observer<span class="op">.</span><span class="fu">unobserve</span>(img)<span class="op">;</span></span>
<span id="cb326-19"><a href="#cb326-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb326-20"><a href="#cb326-20" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb326-21"><a href="#cb326-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb326-22"><a href="#cb326-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-23"><a href="#cb326-23" aria-hidden="true" tabindex="-1"></a>    observer<span class="op">.</span><span class="fu">observe</span>(img)<span class="op">;</span></span>
<span id="cb326-24"><a href="#cb326-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb326-25"><a href="#cb326-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb326-26"><a href="#cb326-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-27"><a href="#cb326-27" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;lazy-image&#39;</span><span class="op">,</span> LazyImage)<span class="op">;</span></span></code></pre></div>
<p>Use responsive images with srcset:</p>
<div class="sourceCode" id="cb327"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">img</span></span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  srcset</span><span class="op">=</span><span class="st">&quot;image-400.jpg 400w,</span></span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a><span class="st">          image-800.jpg 800w,</span></span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a><span class="st">          image-1200.jpg 1200w&quot;</span></span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  sizes</span><span class="op">=</span><span class="st">&quot;(max-width: 400px) 400px,</span></span>
<span id="cb327-6"><a href="#cb327-6" aria-hidden="true" tabindex="-1"></a><span class="st">         (max-width: 800px) 800px,</span></span>
<span id="cb327-7"><a href="#cb327-7" aria-hidden="true" tabindex="-1"></a><span class="st">         1200px&quot;</span></span>
<span id="cb327-8"><a href="#cb327-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  src</span><span class="op">=</span><span class="st">&quot;image-800.jpg&quot;</span></span>
<span id="cb327-9"><a href="#cb327-9" aria-hidden="true" tabindex="-1"></a><span class="ot">  alt</span><span class="op">=</span><span class="st">&quot;Responsive image&quot;</span></span>
<span id="cb327-10"><a href="#cb327-10" aria-hidden="true" tabindex="-1"></a><span class="ot">  loading</span><span class="op">=</span><span class="st">&quot;lazy&quot;</span></span>
<span id="cb327-11"><a href="#cb327-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="15.3" id="service-worker-caching"><span
class="header-section-number">15.3</span> Service Worker Caching</h2>
<p>Service workers enable offline functionality and faster loads:</p>
<div class="sourceCode" id="cb328"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="co">// sw.js</span></span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> CACHE_NAME <span class="op">=</span> <span class="st">&#39;app-v1&#39;</span><span class="op">;</span></span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ASSETS <span class="op">=</span> [</span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/&#39;</span><span class="op">,</span></span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/index.html&#39;</span><span class="op">,</span></span>
<span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/styles.css&#39;</span><span class="op">,</span></span>
<span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/app.js&#39;</span><span class="op">,</span></span>
<span id="cb328-8"><a href="#cb328-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/components/header.js&#39;</span><span class="op">,</span></span>
<span id="cb328-9"><a href="#cb328-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;/components/footer.js&#39;</span></span>
<span id="cb328-10"><a href="#cb328-10" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb328-11"><a href="#cb328-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-12"><a href="#cb328-12" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;install&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb328-13"><a href="#cb328-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">waitUntil</span>(</span>
<span id="cb328-14"><a href="#cb328-14" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">open</span>(CACHE_NAME)<span class="op">.</span><span class="fu">then</span>(cache <span class="kw">=&gt;</span> cache<span class="op">.</span><span class="fu">addAll</span>(ASSETS))</span>
<span id="cb328-15"><a href="#cb328-15" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb328-16"><a href="#cb328-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb328-17"><a href="#cb328-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-18"><a href="#cb328-18" aria-hidden="true" tabindex="-1"></a>self<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;fetch&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb328-19"><a href="#cb328-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">event</span><span class="op">.</span><span class="fu">respondWith</span>(</span>
<span id="cb328-20"><a href="#cb328-20" aria-hidden="true" tabindex="-1"></a>    caches<span class="op">.</span><span class="fu">match</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>)<span class="op">.</span><span class="fu">then</span>(cached <span class="kw">=&gt;</span> {</span>
<span id="cb328-21"><a href="#cb328-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Cache first, network fallback</span></span>
<span id="cb328-22"><a href="#cb328-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cached) <span class="cf">return</span> cached<span class="op">;</span></span>
<span id="cb328-23"><a href="#cb328-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-24"><a href="#cb328-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">fetch</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span>)<span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> {</span>
<span id="cb328-25"><a href="#cb328-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cache successful responses</span></span>
<span id="cb328-26"><a href="#cb328-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb328-27"><a href="#cb328-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">const</span> clone <span class="op">=</span> response<span class="op">.</span><span class="fu">clone</span>()<span class="op">;</span></span>
<span id="cb328-28"><a href="#cb328-28" aria-hidden="true" tabindex="-1"></a>          caches<span class="op">.</span><span class="fu">open</span>(CACHE_NAME)<span class="op">.</span><span class="fu">then</span>(cache <span class="kw">=&gt;</span> {</span>
<span id="cb328-29"><a href="#cb328-29" aria-hidden="true" tabindex="-1"></a>            cache<span class="op">.</span><span class="fu">put</span>(<span class="bu">event</span><span class="op">.</span><span class="at">request</span><span class="op">,</span> clone)<span class="op">;</span></span>
<span id="cb328-30"><a href="#cb328-30" aria-hidden="true" tabindex="-1"></a>          })<span class="op">;</span></span>
<span id="cb328-31"><a href="#cb328-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb328-32"><a href="#cb328-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response<span class="op">;</span></span>
<span id="cb328-33"><a href="#cb328-33" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb328-34"><a href="#cb328-34" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb328-35"><a href="#cb328-35" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb328-36"><a href="#cb328-36" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Register it in your app:</p>
<div class="sourceCode" id="cb329"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">&#39;serviceWorker&#39;</span> <span class="kw">in</span> <span class="bu">navigator</span>) {</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">navigator</span><span class="op">.</span><span class="at">serviceWorker</span><span class="op">.</span><span class="fu">register</span>(<span class="st">&#39;/sw.js&#39;</span>)<span class="op">;</span></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="15.4" id="measuring-performance"><span
class="header-section-number">15.4</span> Measuring Performance</h2>
<p>You can’t optimize what you don’t measure. Use the Performance
API:</p>
<div class="sourceCode" id="cb330"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Measure component render time</span></span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="st">&#39;render-start&#39;</span>)<span class="op">;</span></span>
<span id="cb330-3"><a href="#cb330-3" aria-hidden="true" tabindex="-1"></a><span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb330-4"><a href="#cb330-4" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="st">&#39;render-end&#39;</span>)<span class="op">;</span></span>
<span id="cb330-5"><a href="#cb330-5" aria-hidden="true" tabindex="-1"></a><span class="bu">performance</span><span class="op">.</span><span class="fu">measure</span>(<span class="st">&#39;render&#39;</span><span class="op">,</span> <span class="st">&#39;render-start&#39;</span><span class="op">,</span> <span class="st">&#39;render-end&#39;</span>)<span class="op">;</span></span>
<span id="cb330-6"><a href="#cb330-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-7"><a href="#cb330-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> measure <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByName</span>(<span class="st">&#39;render&#39;</span>)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb330-8"><a href="#cb330-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Render took </span><span class="sc">${</span>measure<span class="op">.</span><span class="at">duration</span><span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span></code></pre></div>
<p>Track Web Vitals:</p>
<div class="sourceCode" id="cb331"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { getCLS<span class="op">,</span> getFID<span class="op">,</span> getLCP } <span class="im">from</span> <span class="st">&#39;web-vitals&#39;</span><span class="op">;</span></span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="fu">getCLS</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)<span class="op">;</span>  <span class="co">// Cumulative Layout Shift</span></span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a><span class="fu">getFID</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)<span class="op">;</span>  <span class="co">// First Input Delay</span></span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a><span class="fu">getLCP</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)<span class="op">;</span>  <span class="co">// Largest Contentful Paint</span></span></code></pre></div>
<h2 data-number="15.5" id="virtual-lists-for-large-data"><span
class="header-section-number">15.5</span> Virtual Lists for Large
Data</h2>
<p>Rendering thousands of items kills performance. Virtualize:</p>
<div class="sourceCode" id="cb332"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VirtualList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span> <span class="op">=</span> <span class="dv">40</span><span class="op">;</span></span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span> <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb332-9"><a href="#cb332-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-10"><a href="#cb332-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">data</span>(items) {</span>
<span id="cb332-11"><a href="#cb332-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> items<span class="op">;</span></span>
<span id="cb332-12"><a href="#cb332-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb332-13"><a href="#cb332-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb332-14"><a href="#cb332-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-15"><a href="#cb332-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb332-16"><a href="#cb332-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">cssText</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb332-17"><a href="#cb332-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      display: block;</span></span>
<span id="cb332-18"><a href="#cb332-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      height: 400px;</span></span>
<span id="cb332-19"><a href="#cb332-19" aria-hidden="true" tabindex="-1"></a><span class="vs">      overflow-y: auto;</span></span>
<span id="cb332-20"><a href="#cb332-20" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb332-21"><a href="#cb332-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-22"><a href="#cb332-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb332-23"><a href="#cb332-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span><span class="op">;</span></span>
<span id="cb332-24"><a href="#cb332-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb332-25"><a href="#cb332-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb332-26"><a href="#cb332-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-27"><a href="#cb332-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb332-28"><a href="#cb332-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb332-29"><a href="#cb332-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-30"><a href="#cb332-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb332-31"><a href="#cb332-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span>)<span class="op">;</span></span>
<span id="cb332-32"><a href="#cb332-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> visibleItems <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">slice</span>(startIndex<span class="op">,</span> startIndex <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span>)<span class="op">;</span></span>
<span id="cb332-33"><a href="#cb332-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-34"><a href="#cb332-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb332-35"><a href="#cb332-35" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px; position: relative;&quot;&gt;</span></span>
<span id="cb332-36"><a href="#cb332-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>visibleItems<span class="op">.</span><span class="fu">map</span>((item<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb332-37"><a href="#cb332-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style=&quot;</span></span>
<span id="cb332-38"><a href="#cb332-38" aria-hidden="true" tabindex="-1"></a><span class="vs">            position: absolute;</span></span>
<span id="cb332-39"><a href="#cb332-39" aria-hidden="true" tabindex="-1"></a><span class="vs">            top: </span><span class="sc">${</span>(startIndex <span class="op">+</span> i) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb332-40"><a href="#cb332-40" aria-hidden="true" tabindex="-1"></a><span class="vs">            height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb332-41"><a href="#cb332-41" aria-hidden="true" tabindex="-1"></a><span class="vs">            width: 100%;</span></span>
<span id="cb332-42"><a href="#cb332-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          &quot;&gt;</span></span>
<span id="cb332-43"><a href="#cb332-43" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span></span>
<span id="cb332-44"><a href="#cb332-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb332-45"><a href="#cb332-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb332-46"><a href="#cb332-46" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb332-47"><a href="#cb332-47" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb332-48"><a href="#cb332-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb332-49"><a href="#cb332-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb332-50"><a href="#cb332-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-51"><a href="#cb332-51" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;virtual-list&#39;</span><span class="op">,</span> VirtualList)<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.6" id="code-splitting-and-dynamic-imports"><span
class="header-section-number">15.6</span> Code Splitting and Dynamic
Imports</h2>
<p>Break your code into smaller chunks that load on demand:</p>
<div class="sourceCode" id="cb333"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Route-based code splitting</span></span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppRouter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb333-3"><a href="#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb333-4"><a href="#cb333-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb333-5"><a href="#cb333-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">routes</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>([</span>
<span id="cb333-6"><a href="#cb333-6" aria-hidden="true" tabindex="-1"></a>      [<span class="st">&#39;/&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/home.js&#39;</span>)]<span class="op">,</span></span>
<span id="cb333-7"><a href="#cb333-7" aria-hidden="true" tabindex="-1"></a>      [<span class="st">&#39;/products&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/products.js&#39;</span>)]<span class="op">,</span></span>
<span id="cb333-8"><a href="#cb333-8" aria-hidden="true" tabindex="-1"></a>      [<span class="st">&#39;/admin&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./pages/admin.js&#39;</span>)]</span>
<span id="cb333-9"><a href="#cb333-9" aria-hidden="true" tabindex="-1"></a>    ])<span class="op">;</span></span>
<span id="cb333-10"><a href="#cb333-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb333-11"><a href="#cb333-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-12"><a href="#cb333-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">navigate</span>(path) {</span>
<span id="cb333-13"><a href="#cb333-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show loading state</span></span>
<span id="cb333-14"><a href="#cb333-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;loading&quot;&gt;Loading...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb333-15"><a href="#cb333-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-16"><a href="#cb333-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb333-17"><a href="#cb333-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> loader <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">routes</span><span class="op">.</span><span class="fu">get</span>(path)<span class="op">;</span></span>
<span id="cb333-18"><a href="#cb333-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>loader) {</span>
<span id="cb333-19"><a href="#cb333-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Route not found&#39;</span>)<span class="op">;</span></span>
<span id="cb333-20"><a href="#cb333-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb333-21"><a href="#cb333-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-22"><a href="#cb333-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load the module</span></span>
<span id="cb333-23"><a href="#cb333-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> module <span class="op">=</span> <span class="cf">await</span> <span class="fu">loader</span>()<span class="op">;</span></span>
<span id="cb333-24"><a href="#cb333-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-25"><a href="#cb333-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render the page component</span></span>
<span id="cb333-26"><a href="#cb333-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;</span><span class="sc">${</span>module<span class="op">.</span><span class="at">tagName</span><span class="sc">}</span><span class="vs">&gt;&lt;/</span><span class="sc">${</span>module<span class="op">.</span><span class="at">tagName</span><span class="sc">}</span><span class="vs">&gt;`</span><span class="op">;</span></span>
<span id="cb333-27"><a href="#cb333-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-28"><a href="#cb333-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Track page load time</span></span>
<span id="cb333-29"><a href="#cb333-29" aria-hidden="true" tabindex="-1"></a>      <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="vs">`page-</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">-loaded`</span>)<span class="op">;</span></span>
<span id="cb333-30"><a href="#cb333-30" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb333-31"><a href="#cb333-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;error-page message=&quot;</span><span class="sc">${</span>error<span class="op">.</span><span class="at">message</span><span class="sc">}</span><span class="vs">&quot;&gt;&lt;/error-page&gt;`</span><span class="op">;</span></span>
<span id="cb333-32"><a href="#cb333-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb333-33"><a href="#cb333-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb333-34"><a href="#cb333-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb333-35"><a href="#cb333-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-36"><a href="#cb333-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Feature-based code splitting</span></span>
<span id="cb333-37"><a href="#cb333-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataGrid <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb333-38"><a href="#cb333-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">enableExport</span>() {</span>
<span id="cb333-39"><a href="#cb333-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span>) {</span>
<span id="cb333-40"><a href="#cb333-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Only load export library when user needs it</span></span>
<span id="cb333-41"><a href="#cb333-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span> <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;https://cdn.jsdelivr.net/npm/xlsx/+esm&#39;</span>)<span class="op">;</span></span>
<span id="cb333-42"><a href="#cb333-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb333-43"><a href="#cb333-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-44"><a href="#cb333-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> worksheet <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span><span class="op">.</span><span class="at">utils</span><span class="op">.</span><span class="fu">json_to_sheet</span>(<span class="kw">this</span><span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb333-45"><a href="#cb333-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> workbook <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span><span class="op">.</span><span class="at">utils</span><span class="op">.</span><span class="fu">book_new</span>()<span class="op">;</span></span>
<span id="cb333-46"><a href="#cb333-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span><span class="op">.</span><span class="at">utils</span><span class="op">.</span><span class="fu">book_append_sheet</span>(workbook<span class="op">,</span> worksheet<span class="op">,</span> <span class="st">&#39;Data&#39;</span>)<span class="op">;</span></span>
<span id="cb333-47"><a href="#cb333-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">exportModule</span><span class="op">.</span><span class="fu">writeFile</span>(workbook<span class="op">,</span> <span class="st">&#39;export.xlsx&#39;</span>)<span class="op">;</span></span>
<span id="cb333-48"><a href="#cb333-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb333-49"><a href="#cb333-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="15.7" id="debouncing-and-throttling-1"><span
class="header-section-number">15.7</span> Debouncing and Throttling</h2>
<p>Control how often expensive operations run:</p>
<div class="sourceCode" id="cb334"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Debounce: Wait for user to stop typing</span></span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">debounce</span>(fn<span class="op">,</span> delay <span class="op">=</span> <span class="dv">300</span>) {</span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> timeoutId<span class="op">;</span></span>
<span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span> (<span class="op">...</span>args) {</span>
<span id="cb334-5"><a href="#cb334-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb334-6"><a href="#cb334-6" aria-hidden="true" tabindex="-1"></a>    timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">,</span> delay)<span class="op">;</span></span>
<span id="cb334-7"><a href="#cb334-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb334-8"><a href="#cb334-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb334-9"><a href="#cb334-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-10"><a href="#cb334-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchBox <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb334-11"><a href="#cb334-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb334-12"><a href="#cb334-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb334-13"><a href="#cb334-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;input type=&quot;text&quot; placeholder=&quot;Search...&quot;&gt;</span></span>
<span id="cb334-14"><a href="#cb334-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;results&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb334-15"><a href="#cb334-15" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb334-16"><a href="#cb334-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-17"><a href="#cb334-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">;</span></span>
<span id="cb334-18"><a href="#cb334-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> results <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.results&#39;</span>)<span class="op">;</span></span>
<span id="cb334-19"><a href="#cb334-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-20"><a href="#cb334-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounce search API calls</span></span>
<span id="cb334-21"><a href="#cb334-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> searchDebounced <span class="op">=</span> <span class="fu">debounce</span>(<span class="kw">async</span> (query) <span class="kw">=&gt;</span> {</span>
<span id="cb334-22"><a href="#cb334-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (query<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb334-23"><a href="#cb334-23" aria-hidden="true" tabindex="-1"></a>        results<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb334-24"><a href="#cb334-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb334-25"><a href="#cb334-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb334-26"><a href="#cb334-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-27"><a href="#cb334-27" aria-hidden="true" tabindex="-1"></a>      results<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;Searching...&#39;</span><span class="op">;</span></span>
<span id="cb334-28"><a href="#cb334-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-29"><a href="#cb334-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/search?q=</span><span class="sc">${</span><span class="pp">encodeURIComponent</span>(query)<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb334-30"><a href="#cb334-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb334-31"><a href="#cb334-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-32"><a href="#cb334-32" aria-hidden="true" tabindex="-1"></a>      results<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> data<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span></span>
<span id="cb334-33"><a href="#cb334-33" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`&lt;div class=&quot;result&quot;&gt;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&lt;/div&gt;`</span></span>
<span id="cb334-34"><a href="#cb334-34" aria-hidden="true" tabindex="-1"></a>      )<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb334-35"><a href="#cb334-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">300</span>)<span class="op">;</span></span>
<span id="cb334-36"><a href="#cb334-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-37"><a href="#cb334-37" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb334-38"><a href="#cb334-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">searchDebounced</span>(e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb334-39"><a href="#cb334-39" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb334-40"><a href="#cb334-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb334-41"><a href="#cb334-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb334-42"><a href="#cb334-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-43"><a href="#cb334-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Throttle: Limit scroll handler frequency</span></span>
<span id="cb334-44"><a href="#cb334-44" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">throttle</span>(fn<span class="op">,</span> delay <span class="op">=</span> <span class="dv">100</span>) {</span>
<span id="cb334-45"><a href="#cb334-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> lastCall <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb334-46"><a href="#cb334-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span> (<span class="op">...</span>args) {</span>
<span id="cb334-47"><a href="#cb334-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> now <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb334-48"><a href="#cb334-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (now <span class="op">-</span> lastCall <span class="op">&gt;=</span> delay) {</span>
<span id="cb334-49"><a href="#cb334-49" aria-hidden="true" tabindex="-1"></a>      lastCall <span class="op">=</span> now<span class="op">;</span></span>
<span id="cb334-50"><a href="#cb334-50" aria-hidden="true" tabindex="-1"></a>      fn<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb334-51"><a href="#cb334-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb334-52"><a href="#cb334-52" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb334-53"><a href="#cb334-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb334-54"><a href="#cb334-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-55"><a href="#cb334-55" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> InfiniteScroll <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb334-56"><a href="#cb334-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb334-57"><a href="#cb334-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> loadMore <span class="op">=</span> <span class="fu">throttle</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb334-58"><a href="#cb334-58" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> scrollBottom <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">clientHeight</span><span class="op">;</span></span>
<span id="cb334-59"><a href="#cb334-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> threshold <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollHeight</span> <span class="op">-</span> <span class="dv">200</span><span class="op">;</span></span>
<span id="cb334-60"><a href="#cb334-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-61"><a href="#cb334-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scrollBottom <span class="op">&gt;=</span> threshold <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">loading</span>) {</span>
<span id="cb334-62"><a href="#cb334-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">loadNextPage</span>()<span class="op">;</span></span>
<span id="cb334-63"><a href="#cb334-63" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb334-64"><a href="#cb334-64" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb334-65"><a href="#cb334-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-66"><a href="#cb334-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> loadMore)<span class="op">;</span></span>
<span id="cb334-67"><a href="#cb334-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb334-68"><a href="#cb334-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-69"><a href="#cb334-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadNextPage</span>() {</span>
<span id="cb334-70"><a href="#cb334-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb334-71"><a href="#cb334-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load more items...</span></span>
<span id="cb334-72"><a href="#cb334-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loading</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb334-73"><a href="#cb334-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb334-74"><a href="#cb334-74" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="15.8" id="memoization-for-expensive-computations"><span
class="header-section-number">15.8</span> Memoization for Expensive
Computations</h2>
<p>Cache computed values to avoid redundant work:</p>
<div class="sourceCode" id="cb335"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataTable <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Memoize expensive sort operation</span></span>
<span id="cb335-8"><a href="#cb335-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSortedData</span>(data<span class="op">,</span> sortKey<span class="op">,</span> direction) {</span>
<span id="cb335-9"><a href="#cb335-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>sortKey<span class="sc">}</span><span class="vs">-</span><span class="sc">${</span>direction<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb335-10"><a href="#cb335-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-11"><a href="#cb335-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">has</span>(cacheKey)) {</span>
<span id="cb335-12"><a href="#cb335-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Using cached sort&#39;</span>)<span class="op">;</span></span>
<span id="cb335-13"><a href="#cb335-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></span>
<span id="cb335-14"><a href="#cb335-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb335-15"><a href="#cb335-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-16"><a href="#cb335-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Computing sort&#39;</span>)<span class="op">;</span></span>
<span id="cb335-17"><a href="#cb335-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> sorted <span class="op">=</span> [<span class="op">...</span>data]<span class="op">.</span><span class="fu">sort</span>((a<span class="op">,</span> b) <span class="kw">=&gt;</span> {</span>
<span id="cb335-18"><a href="#cb335-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> aVal <span class="op">=</span> a[sortKey]<span class="op">;</span></span>
<span id="cb335-19"><a href="#cb335-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> bVal <span class="op">=</span> b[sortKey]<span class="op">;</span></span>
<span id="cb335-20"><a href="#cb335-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> multiplier <span class="op">=</span> direction <span class="op">===</span> <span class="st">&#39;asc&#39;</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb335-21"><a href="#cb335-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> aVal <span class="op">&lt;</span> bVal <span class="op">?</span> <span class="op">-</span>multiplier <span class="op">:</span> aVal <span class="op">&gt;</span> bVal <span class="op">?</span> multiplier <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb335-22"><a href="#cb335-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb335-23"><a href="#cb335-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-24"><a href="#cb335-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> sorted)<span class="op">;</span></span>
<span id="cb335-25"><a href="#cb335-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sorted<span class="op">;</span></span>
<span id="cb335-26"><a href="#cb335-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb335-27"><a href="#cb335-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-28"><a href="#cb335-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Clear cache when data changes</span></span>
<span id="cb335-29"><a href="#cb335-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">data</span>(newData) {</span>
<span id="cb335-30"><a href="#cb335-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_data</span> <span class="op">=</span> newData<span class="op">;</span></span>
<span id="cb335-31"><a href="#cb335-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb335-32"><a href="#cb335-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb335-33"><a href="#cb335-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb335-34"><a href="#cb335-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb335-35"><a href="#cb335-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-36"><a href="#cb335-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Memoize with WeakMap for object keys</span></span>
<span id="cb335-37"><a href="#cb335-37" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> memoizedCalculations <span class="op">=</span> <span class="kw">new</span> <span class="bu">WeakMap</span>()<span class="op">;</span></span>
<span id="cb335-38"><a href="#cb335-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-39"><a href="#cb335-39" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">expensiveCalculation</span>(obj) {</span>
<span id="cb335-40"><a href="#cb335-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (memoizedCalculations<span class="op">.</span><span class="fu">has</span>(obj)) {</span>
<span id="cb335-41"><a href="#cb335-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> memoizedCalculations<span class="op">.</span><span class="fu">get</span>(obj)<span class="op">;</span></span>
<span id="cb335-42"><a href="#cb335-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb335-43"><a href="#cb335-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-44"><a href="#cb335-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> {</span>
<span id="cb335-45"><a href="#cb335-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total</span><span class="op">:</span> obj<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">price</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb335-46"><a href="#cb335-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tax</span><span class="op">:</span> obj<span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> item) <span class="kw">=&gt;</span> sum <span class="op">+</span> item<span class="op">.</span><span class="at">price</span> <span class="op">*</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb335-47"><a href="#cb335-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... more expensive calculations</span></span>
<span id="cb335-48"><a href="#cb335-48" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb335-49"><a href="#cb335-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb335-50"><a href="#cb335-50" aria-hidden="true" tabindex="-1"></a>  memoizedCalculations<span class="op">.</span><span class="fu">set</span>(obj<span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb335-51"><a href="#cb335-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb335-52"><a href="#cb335-52" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="15.9" id="bundle-size-optimization"><span
class="header-section-number">15.9</span> Bundle Size Optimization</h2>
<p>Keep your JavaScript small:</p>
<div class="sourceCode" id="cb336"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Use import maps to share dependencies</span></span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a><span class="co">// In your HTML:</span></span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;script type=&quot;importmap&quot;&gt;</span></span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a><span class="co">{</span></span>
<span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;imports&quot;: {</span></span>
<span id="cb336-7"><a href="#cb336-7" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;lit&quot;: &quot;https://cdn.jsdelivr.net/npm/lit@3/+esm&quot;,</span></span>
<span id="cb336-8"><a href="#cb336-8" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;lit/&quot;: &quot;https://cdn.jsdelivr.net/npm/lit@3/&quot;</span></span>
<span id="cb336-9"><a href="#cb336-9" aria-hidden="true" tabindex="-1"></a><span class="co">  }</span></span>
<span id="cb336-10"><a href="#cb336-10" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb336-11"><a href="#cb336-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;/script&gt;</span></span>
<span id="cb336-12"><a href="#cb336-12" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb336-13"><a href="#cb336-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-14"><a href="#cb336-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple components can share the same lit import</span></span>
<span id="cb336-15"><a href="#cb336-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { LitElement<span class="op">,</span> html<span class="op">,</span> css } <span class="im">from</span> <span class="st">&#39;lit&#39;</span><span class="op">;</span></span>
<span id="cb336-16"><a href="#cb336-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-17"><a href="#cb336-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Tree-shake unused code by importing only what you need</span></span>
<span id="cb336-18"><a href="#cb336-18" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: imports everything</span></span>
<span id="cb336-19"><a href="#cb336-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> utils <span class="im">from</span> <span class="st">&#39;./utils.js&#39;</span><span class="op">;</span></span>
<span id="cb336-20"><a href="#cb336-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-21"><a href="#cb336-21" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: imports only what&#39;s needed</span></span>
<span id="cb336-22"><a href="#cb336-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { formatDate<span class="op">,</span> formatCurrency } <span class="im">from</span> <span class="st">&#39;./utils.js&#39;</span><span class="op">;</span></span>
<span id="cb336-23"><a href="#cb336-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-24"><a href="#cb336-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Prefer native APIs over libraries</span></span>
<span id="cb336-25"><a href="#cb336-25" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Heavy date library (40KB+)</span></span>
<span id="cb336-26"><a href="#cb336-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dayjs <span class="im">from</span> <span class="st">&#39;dayjs&#39;</span><span class="op">;</span></span>
<span id="cb336-27"><a href="#cb336-27" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> formatted <span class="op">=</span> <span class="fu">dayjs</span>(date)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-DD&#39;</span>)<span class="op">;</span></span>
<span id="cb336-28"><a href="#cb336-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-29"><a href="#cb336-29" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Native Intl (0KB)</span></span>
<span id="cb336-30"><a href="#cb336-30" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> formatted <span class="op">=</span> <span class="kw">new</span> <span class="bu">Intl</span><span class="op">.</span><span class="fu">DateTimeFormat</span>(<span class="st">&#39;en-US&#39;</span>)<span class="op">.</span><span class="fu">format</span>(date)<span class="op">;</span></span>
<span id="cb336-31"><a href="#cb336-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-32"><a href="#cb336-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Use dynamic imports for conditional features</span></span>
<span id="cb336-33"><a href="#cb336-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (user<span class="op">.</span><span class="at">isAdmin</span>) {</span>
<span id="cb336-34"><a href="#cb336-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> { AdminPanel } <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./admin.js&#39;</span>)<span class="op">;</span></span>
<span id="cb336-35"><a href="#cb336-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use AdminPanel</span></span>
<span id="cb336-36"><a href="#cb336-36" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Check your bundle size:</p>
<div class="sourceCode" id="cb337"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze what&#39;s being loaded</span></span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-lh</span> dist/<span class="pp">*</span>.js</span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use browser DevTools Network tab to see:</span></span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Total KB transferred</span></span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - Uncompressed size</span></span>
<span id="cb337-7"><a href="#cb337-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - Number of requests</span></span></code></pre></div>
<h2 data-number="15.10" id="web-vitals-monitoring"><span
class="header-section-number">15.10</span> Web Vitals Monitoring</h2>
<p>Monitor real user experience:</p>
<div class="sourceCode" id="cb338"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="co">// web-vitals-tracker.js</span></span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WebVitalsTracker {</span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">track</span>() {</span>
<span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import web-vitals library only when needed</span></span>
<span id="cb338-9"><a href="#cb338-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { onCLS<span class="op">,</span> onFID<span class="op">,</span> onLCP<span class="op">,</span> onFCP<span class="op">,</span> onTTFB } <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(</span>
<span id="cb338-10"><a href="#cb338-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;https://cdn.jsdelivr.net/npm/web-vitals@3/+esm&#39;</span></span>
<span id="cb338-11"><a href="#cb338-11" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb338-12"><a href="#cb338-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-13"><a href="#cb338-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onCLS</span>((metric) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">reportMetric</span>(metric))<span class="op">;</span></span>
<span id="cb338-14"><a href="#cb338-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onFID</span>((metric) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">reportMetric</span>(metric))<span class="op">;</span></span>
<span id="cb338-15"><a href="#cb338-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onLCP</span>((metric) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">reportMetric</span>(metric))<span class="op">;</span></span>
<span id="cb338-16"><a href="#cb338-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onFCP</span>((metric) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">reportMetric</span>(metric))<span class="op">;</span></span>
<span id="cb338-17"><a href="#cb338-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onTTFB</span>((metric) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">reportMetric</span>(metric))<span class="op">;</span></span>
<span id="cb338-18"><a href="#cb338-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-19"><a href="#cb338-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-20"><a href="#cb338-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reportMetric</span>(metric) {</span>
<span id="cb338-21"><a href="#cb338-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span>[metric<span class="op">.</span><span class="at">name</span>] <span class="op">=</span> metric<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb338-22"><a href="#cb338-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-23"><a href="#cb338-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send to analytics</span></span>
<span id="cb338-24"><a href="#cb338-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">navigator</span><span class="op">.</span><span class="at">sendBeacon</span>) {</span>
<span id="cb338-25"><a href="#cb338-25" aria-hidden="true" tabindex="-1"></a>      <span class="bu">navigator</span><span class="op">.</span><span class="fu">sendBeacon</span>(<span class="st">&#39;/analytics&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb338-26"><a href="#cb338-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">metric</span><span class="op">:</span> metric<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb338-27"><a href="#cb338-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">value</span><span class="op">:</span> metric<span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb338-28"><a href="#cb338-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">rating</span><span class="op">:</span> metric<span class="op">.</span><span class="at">rating</span><span class="op">,</span></span>
<span id="cb338-29"><a href="#cb338-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">page</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span></span>
<span id="cb338-30"><a href="#cb338-30" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">;</span></span>
<span id="cb338-31"><a href="#cb338-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb338-32"><a href="#cb338-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-33"><a href="#cb338-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log for development</span></span>
<span id="cb338-34"><a href="#cb338-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>metric<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>metric<span class="op">.</span><span class="at">value</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>metric<span class="op">.</span><span class="at">rating</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">;</span></span>
<span id="cb338-35"><a href="#cb338-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-36"><a href="#cb338-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-37"><a href="#cb338-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getScores</span>() {</span>
<span id="cb338-38"><a href="#cb338-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb338-39"><a href="#cb338-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cls</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span><span class="op">.</span><span class="at">CLS</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb338-40"><a href="#cb338-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fid</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span><span class="op">.</span><span class="at">FID</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb338-41"><a href="#cb338-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lcp</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span><span class="op">.</span><span class="at">LCP</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb338-42"><a href="#cb338-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fcp</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span><span class="op">.</span><span class="at">FCP</span> <span class="op">||</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb338-43"><a href="#cb338-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ttfb</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">metrics</span><span class="op">.</span><span class="at">TTFB</span> <span class="op">||</span> <span class="dv">0</span></span>
<span id="cb338-44"><a href="#cb338-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb338-45"><a href="#cb338-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb338-46"><a href="#cb338-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-47"><a href="#cb338-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-48"><a href="#cb338-48" aria-hidden="true" tabindex="-1"></a><span class="co">// Use in your app</span></span>
<span id="cb338-49"><a href="#cb338-49" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> vitals <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebVitalsTracker</span>()<span class="op">;</span></span>
<span id="cb338-50"><a href="#cb338-50" aria-hidden="true" tabindex="-1"></a>vitals<span class="op">.</span><span class="fu">track</span>()<span class="op">;</span></span></code></pre></div>
<p>Display performance scores to users:</p>
<div class="sourceCode" id="cb339"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PerformanceWidget <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { onLCP<span class="op">,</span> onFID<span class="op">,</span> onCLS } <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(</span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;https://cdn.jsdelivr.net/npm/web-vitals@3/+esm&#39;</span></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-7"><a href="#cb339-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb339-8"><a href="#cb339-8" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;vitals&quot;&gt;</span></span>
<span id="cb339-9"><a href="#cb339-9" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;metric&quot;&gt;</span></span>
<span id="cb339-10"><a href="#cb339-10" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;label&quot;&gt;LCP&lt;/span&gt;</span></span>
<span id="cb339-11"><a href="#cb339-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;value lcp&quot;&gt;...&lt;/span&gt;</span></span>
<span id="cb339-12"><a href="#cb339-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb339-13"><a href="#cb339-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;metric&quot;&gt;</span></span>
<span id="cb339-14"><a href="#cb339-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;label&quot;&gt;FID&lt;/span&gt;</span></span>
<span id="cb339-15"><a href="#cb339-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;value fid&quot;&gt;...&lt;/span&gt;</span></span>
<span id="cb339-16"><a href="#cb339-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb339-17"><a href="#cb339-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;metric&quot;&gt;</span></span>
<span id="cb339-18"><a href="#cb339-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;label&quot;&gt;CLS&lt;/span&gt;</span></span>
<span id="cb339-19"><a href="#cb339-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;value cls&quot;&gt;...&lt;/span&gt;</span></span>
<span id="cb339-20"><a href="#cb339-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb339-21"><a href="#cb339-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb339-22"><a href="#cb339-22" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb339-23"><a href="#cb339-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-24"><a href="#cb339-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onLCP</span>(({ value<span class="op">,</span> rating }) <span class="kw">=&gt;</span> {</span>
<span id="cb339-25"><a href="#cb339-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.lcp&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(value)<span class="sc">}</span><span class="vs">ms`</span><span class="op">;</span></span>
<span id="cb339-26"><a href="#cb339-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.lcp&#39;</span>)<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="vs">`value lcp </span><span class="sc">${</span>rating<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb339-27"><a href="#cb339-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb339-28"><a href="#cb339-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-29"><a href="#cb339-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onFID</span>(({ value<span class="op">,</span> rating }) <span class="kw">=&gt;</span> {</span>
<span id="cb339-30"><a href="#cb339-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.fid&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(value)<span class="sc">}</span><span class="vs">ms`</span><span class="op">;</span></span>
<span id="cb339-31"><a href="#cb339-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.fid&#39;</span>)<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="vs">`value fid </span><span class="sc">${</span>rating<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb339-32"><a href="#cb339-32" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb339-33"><a href="#cb339-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-34"><a href="#cb339-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">onCLS</span>(({ value<span class="op">,</span> rating }) <span class="kw">=&gt;</span> {</span>
<span id="cb339-35"><a href="#cb339-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.cls&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> value<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb339-36"><a href="#cb339-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.cls&#39;</span>)<span class="op">.</span><span class="at">className</span> <span class="op">=</span> <span class="vs">`value cls </span><span class="sc">${</span>rating<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb339-37"><a href="#cb339-37" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb339-38"><a href="#cb339-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb339-39"><a href="#cb339-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb339-40"><a href="#cb339-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-41"><a href="#cb339-41" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;performance-widget&#39;</span><span class="op">,</span> PerformanceWidget)<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.11"
id="real-world-example-optimized-dashboard"><span
class="header-section-number">15.11</span> Real-World Example: Optimized
Dashboard</h2>
<p>Here’s a complete dashboard with all optimization techniques
applied:</p>
<div class="sourceCode" id="cb340"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OptimizedDashboard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">loadedWidgets</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span>()<span class="op">;</span></span>
<span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-9"><a href="#cb340-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb340-10"><a href="#cb340-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Render shell immediately (FCP)</span></span>
<span id="cb340-11"><a href="#cb340-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">renderShell</span>()<span class="op">;</span></span>
<span id="cb340-12"><a href="#cb340-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-13"><a href="#cb340-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Load critical data</span></span>
<span id="cb340-14"><a href="#cb340-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadCriticalData</span>()<span class="op">;</span></span>
<span id="cb340-15"><a href="#cb340-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-16"><a href="#cb340-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. Set up lazy loading for below-fold widgets</span></span>
<span id="cb340-17"><a href="#cb340-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupLazyLoading</span>()<span class="op">;</span></span>
<span id="cb340-18"><a href="#cb340-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-19"><a href="#cb340-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. Track performance</span></span>
<span id="cb340-20"><a href="#cb340-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">trackPerformance</span>()<span class="op">;</span></span>
<span id="cb340-21"><a href="#cb340-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-22"><a href="#cb340-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-23"><a href="#cb340-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderShell</span>() {</span>
<span id="cb340-24"><a href="#cb340-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb340-25"><a href="#cb340-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb340-26"><a href="#cb340-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb340-27"><a href="#cb340-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb340-28"><a href="#cb340-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          container-type: inline-size;</span></span>
<span id="cb340-29"><a href="#cb340-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb340-30"><a href="#cb340-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-31"><a href="#cb340-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        .grid {</span></span>
<span id="cb340-32"><a href="#cb340-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: grid;</span></span>
<span id="cb340-33"><a href="#cb340-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));</span></span>
<span id="cb340-34"><a href="#cb340-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 1rem;</span></span>
<span id="cb340-35"><a href="#cb340-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb340-36"><a href="#cb340-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb340-37"><a href="#cb340-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-38"><a href="#cb340-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        .widget {</span></span>
<span id="cb340-39"><a href="#cb340-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb340-40"><a href="#cb340-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb340-41"><a href="#cb340-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb340-42"><a href="#cb340-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          min-height: 200px;</span></span>
<span id="cb340-43"><a href="#cb340-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb340-44"><a href="#cb340-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-45"><a href="#cb340-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        .skeleton {</span></span>
<span id="cb340-46"><a href="#cb340-46" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);</span></span>
<span id="cb340-47"><a href="#cb340-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          background-size: 200% 100%;</span></span>
<span id="cb340-48"><a href="#cb340-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: shimmer 1.5s infinite;</span></span>
<span id="cb340-49"><a href="#cb340-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb340-50"><a href="#cb340-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-51"><a href="#cb340-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        @keyframes shimmer {</span></span>
<span id="cb340-52"><a href="#cb340-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          0% { background-position: 200% 0; }</span></span>
<span id="cb340-53"><a href="#cb340-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          100% { background-position: -200% 0; }</span></span>
<span id="cb340-54"><a href="#cb340-54" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb340-55"><a href="#cb340-55" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb340-56"><a href="#cb340-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-57"><a href="#cb340-57" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;grid&quot;&gt;</span></span>
<span id="cb340-58"><a href="#cb340-58" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;widget&quot; data-widget=&quot;revenue&quot;&gt;</span></span>
<span id="cb340-59"><a href="#cb340-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb340-60"><a href="#cb340-60" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb340-61"><a href="#cb340-61" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;widget&quot; data-widget=&quot;users&quot;&gt;</span></span>
<span id="cb340-62"><a href="#cb340-62" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb340-63"><a href="#cb340-63" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb340-64"><a href="#cb340-64" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;widget&quot; data-widget=&quot;chart&quot; data-lazy&gt;</span></span>
<span id="cb340-65"><a href="#cb340-65" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb340-66"><a href="#cb340-66" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb340-67"><a href="#cb340-67" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;widget&quot; data-widget=&quot;table&quot; data-lazy&gt;</span></span>
<span id="cb340-68"><a href="#cb340-68" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;skeleton&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb340-69"><a href="#cb340-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb340-70"><a href="#cb340-70" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb340-71"><a href="#cb340-71" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb340-72"><a href="#cb340-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-73"><a href="#cb340-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-74"><a href="#cb340-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadCriticalData</span>() {</span>
<span id="cb340-75"><a href="#cb340-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load above-the-fold widgets in parallel</span></span>
<span id="cb340-76"><a href="#cb340-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> criticalWidgets <span class="op">=</span> [<span class="st">&#39;revenue&#39;</span><span class="op">,</span> <span class="st">&#39;users&#39;</span>]<span class="op">;</span></span>
<span id="cb340-77"><a href="#cb340-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-78"><a href="#cb340-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb340-79"><a href="#cb340-79" aria-hidden="true" tabindex="-1"></a>      criticalWidgets<span class="op">.</span><span class="fu">map</span>(widget <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">loadWidget</span>(widget))</span>
<span id="cb340-80"><a href="#cb340-80" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb340-81"><a href="#cb340-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-82"><a href="#cb340-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-83"><a href="#cb340-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupLazyLoading</span>() {</span>
<span id="cb340-84"><a href="#cb340-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lazyWidgets <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-lazy]&#39;</span>)<span class="op">;</span></span>
<span id="cb340-85"><a href="#cb340-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-86"><a href="#cb340-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="fu">IntersectionObserver</span>(</span>
<span id="cb340-87"><a href="#cb340-87" aria-hidden="true" tabindex="-1"></a>      (entries) <span class="kw">=&gt;</span> {</span>
<span id="cb340-88"><a href="#cb340-88" aria-hidden="true" tabindex="-1"></a>        entries<span class="op">.</span><span class="fu">forEach</span>(entry <span class="kw">=&gt;</span> {</span>
<span id="cb340-89"><a href="#cb340-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (entry<span class="op">.</span><span class="at">isIntersecting</span>) {</span>
<span id="cb340-90"><a href="#cb340-90" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> widgetName <span class="op">=</span> entry<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">widget</span><span class="op">;</span></span>
<span id="cb340-91"><a href="#cb340-91" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">loadWidget</span>(widgetName)<span class="op">;</span></span>
<span id="cb340-92"><a href="#cb340-92" aria-hidden="true" tabindex="-1"></a>            observer<span class="op">.</span><span class="fu">unobserve</span>(entry<span class="op">.</span><span class="at">target</span>)<span class="op">;</span></span>
<span id="cb340-93"><a href="#cb340-93" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb340-94"><a href="#cb340-94" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb340-95"><a href="#cb340-95" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb340-96"><a href="#cb340-96" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">rootMargin</span><span class="op">:</span> <span class="st">&#39;50px&#39;</span> }</span>
<span id="cb340-97"><a href="#cb340-97" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb340-98"><a href="#cb340-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-99"><a href="#cb340-99" aria-hidden="true" tabindex="-1"></a>    lazyWidgets<span class="op">.</span><span class="fu">forEach</span>(widget <span class="kw">=&gt;</span> observer<span class="op">.</span><span class="fu">observe</span>(widget))<span class="op">;</span></span>
<span id="cb340-100"><a href="#cb340-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-101"><a href="#cb340-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-102"><a href="#cb340-102" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadWidget</span>(name) {</span>
<span id="cb340-103"><a href="#cb340-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">loadedWidgets</span><span class="op">.</span><span class="fu">has</span>(name)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb340-104"><a href="#cb340-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-105"><a href="#cb340-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="vs">`widget-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-start`</span>)<span class="op">;</span></span>
<span id="cb340-106"><a href="#cb340-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-107"><a href="#cb340-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb340-108"><a href="#cb340-108" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check cache first</span></span>
<span id="cb340-109"><a href="#cb340-109" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> data <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(name)<span class="op">;</span></span>
<span id="cb340-110"><a href="#cb340-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-111"><a href="#cb340-111" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>data) {</span>
<span id="cb340-112"><a href="#cb340-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load data with timeout</span></span>
<span id="cb340-113"><a href="#cb340-113" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> controller <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb340-114"><a href="#cb340-114" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> timeoutId <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> controller<span class="op">.</span><span class="fu">abort</span>()<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb340-115"><a href="#cb340-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-116"><a href="#cb340-116" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/widgets/</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb340-117"><a href="#cb340-117" aria-hidden="true" tabindex="-1"></a>          <span class="dt">signal</span><span class="op">:</span> controller<span class="op">.</span><span class="at">signal</span></span>
<span id="cb340-118"><a href="#cb340-118" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb340-119"><a href="#cb340-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-120"><a href="#cb340-120" aria-hidden="true" tabindex="-1"></a>        <span class="pp">clearTimeout</span>(timeoutId)<span class="op">;</span></span>
<span id="cb340-121"><a href="#cb340-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-122"><a href="#cb340-122" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cache for 5 minutes</span></span>
<span id="cb340-123"><a href="#cb340-123" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(name<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb340-124"><a href="#cb340-124" aria-hidden="true" tabindex="-1"></a>        <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">delete</span>(name)<span class="op">,</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb340-125"><a href="#cb340-125" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb340-126"><a href="#cb340-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-127"><a href="#cb340-127" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render widget</span></span>
<span id="cb340-128"><a href="#cb340-128" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> widget <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`[data-widget=&quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb340-129"><a href="#cb340-129" aria-hidden="true" tabindex="-1"></a>      widget<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderWidget</span>(name<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb340-130"><a href="#cb340-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-131"><a href="#cb340-131" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">loadedWidgets</span><span class="op">.</span><span class="fu">add</span>(name)<span class="op">;</span></span>
<span id="cb340-132"><a href="#cb340-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-133"><a href="#cb340-133" aria-hidden="true" tabindex="-1"></a>      <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(<span class="vs">`widget-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-end`</span>)<span class="op">;</span></span>
<span id="cb340-134"><a href="#cb340-134" aria-hidden="true" tabindex="-1"></a>      <span class="bu">performance</span><span class="op">.</span><span class="fu">measure</span>(</span>
<span id="cb340-135"><a href="#cb340-135" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`widget-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></span>
<span id="cb340-136"><a href="#cb340-136" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`widget-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-start`</span><span class="op">,</span></span>
<span id="cb340-137"><a href="#cb340-137" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`widget-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">-end`</span></span>
<span id="cb340-138"><a href="#cb340-138" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb340-139"><a href="#cb340-139" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb340-140"><a href="#cb340-140" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`Failed to load widget </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">:`</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb340-141"><a href="#cb340-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-142"><a href="#cb340-142" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> widget <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="vs">`[data-widget=&quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;]`</span>)<span class="op">;</span></span>
<span id="cb340-143"><a href="#cb340-143" aria-hidden="true" tabindex="-1"></a>      widget<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb340-144"><a href="#cb340-144" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;error&quot;&gt;</span></span>
<span id="cb340-145"><a href="#cb340-145" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;Failed to load </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb340-146"><a href="#cb340-146" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button onclick=&quot;this.getRootNode().host.loadWidget(&#39;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&#39;)&quot;&gt;</span></span>
<span id="cb340-147"><a href="#cb340-147" aria-hidden="true" tabindex="-1"></a><span class="vs">            Retry</span></span>
<span id="cb340-148"><a href="#cb340-148" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/button&gt;</span></span>
<span id="cb340-149"><a href="#cb340-149" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb340-150"><a href="#cb340-150" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb340-151"><a href="#cb340-151" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb340-152"><a href="#cb340-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-153"><a href="#cb340-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-154"><a href="#cb340-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderWidget</span>(name<span class="op">,</span> data) {</span>
<span id="cb340-155"><a href="#cb340-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (name) {</span>
<span id="cb340-156"><a href="#cb340-156" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;revenue&#39;</span><span class="op">:</span></span>
<span id="cb340-157"><a href="#cb340-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb340-158"><a href="#cb340-158" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;Revenue&lt;/h3&gt;</span></span>
<span id="cb340-159"><a href="#cb340-159" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;value&quot;&gt;$</span><span class="sc">${</span>data<span class="op">.</span><span class="at">total</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb340-160"><a href="#cb340-160" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;change </span><span class="sc">${</span>data<span class="op">.</span><span class="at">change</span> <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;positive&#39;</span> <span class="op">:</span> <span class="st">&#39;negative&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb340-161"><a href="#cb340-161" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>data<span class="op">.</span><span class="at">change</span> <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;↑&#39;</span> <span class="op">:</span> <span class="st">&#39;↓&#39;</span><span class="sc">}</span><span class="vs"> </span><span class="sc">${</span><span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(data<span class="op">.</span><span class="at">change</span>)<span class="sc">}</span><span class="vs">%</span></span>
<span id="cb340-162"><a href="#cb340-162" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb340-163"><a href="#cb340-163" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb340-164"><a href="#cb340-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-165"><a href="#cb340-165" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;users&#39;</span><span class="op">:</span></span>
<span id="cb340-166"><a href="#cb340-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb340-167"><a href="#cb340-167" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;Active Users&lt;/h3&gt;</span></span>
<span id="cb340-168"><a href="#cb340-168" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;value&quot;&gt;</span><span class="sc">${</span>data<span class="op">.</span><span class="at">count</span><span class="op">.</span><span class="fu">toLocaleString</span>()<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb340-169"><a href="#cb340-169" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb340-170"><a href="#cb340-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-171"><a href="#cb340-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;chart&#39;</span><span class="op">:</span></span>
<span id="cb340-172"><a href="#cb340-172" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lazy load chart library only when needed</span></span>
<span id="cb340-173"><a href="#cb340-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`&lt;canvas id=&quot;chart-</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot;&gt;&lt;/canvas&gt;`</span><span class="op">;</span></span>
<span id="cb340-174"><a href="#cb340-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-175"><a href="#cb340-175" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;table&#39;</span><span class="op">:</span></span>
<span id="cb340-176"><a href="#cb340-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`</span></span>
<span id="cb340-177"><a href="#cb340-177" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h3&gt;Recent Activity&lt;/h3&gt;</span></span>
<span id="cb340-178"><a href="#cb340-178" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;virtual-list&gt;&lt;/virtual-list&gt;</span></span>
<span id="cb340-179"><a href="#cb340-179" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb340-180"><a href="#cb340-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-181"><a href="#cb340-181" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb340-182"><a href="#cb340-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="vs">`&lt;div&gt;Unknown widget: </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&lt;/div&gt;`</span><span class="op">;</span></span>
<span id="cb340-183"><a href="#cb340-183" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb340-184"><a href="#cb340-184" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-185"><a href="#cb340-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-186"><a href="#cb340-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">trackPerformance</span>() {</span>
<span id="cb340-187"><a href="#cb340-187" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track load time</span></span>
<span id="cb340-188"><a href="#cb340-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb340-189"><a href="#cb340-189" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> loadTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">loadEventEnd</span> <span class="op">-</span></span>
<span id="cb340-190"><a href="#cb340-190" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">navigationStart</span><span class="op">;</span></span>
<span id="cb340-191"><a href="#cb340-191" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Dashboard loaded in </span><span class="sc">${</span>loadTime<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb340-192"><a href="#cb340-192" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb340-193"><a href="#cb340-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-194"><a href="#cb340-194" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track widget render times</span></span>
<span id="cb340-195"><a href="#cb340-195" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="bu">PerformanceObserver</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb340-196"><a href="#cb340-196" aria-hidden="true" tabindex="-1"></a>      list<span class="op">.</span><span class="fu">getEntries</span>()<span class="op">.</span><span class="fu">forEach</span>((entry) <span class="kw">=&gt;</span> {</span>
<span id="cb340-197"><a href="#cb340-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (entry<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&#39;widget-&#39;</span>)) {</span>
<span id="cb340-198"><a href="#cb340-198" aria-hidden="true" tabindex="-1"></a>          <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>entry<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>entry<span class="op">.</span><span class="at">duration</span><span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb340-199"><a href="#cb340-199" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb340-200"><a href="#cb340-200" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb340-201"><a href="#cb340-201" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb340-202"><a href="#cb340-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-203"><a href="#cb340-203" aria-hidden="true" tabindex="-1"></a>    observer<span class="op">.</span><span class="fu">observe</span>({ <span class="dt">entryTypes</span><span class="op">:</span> [<span class="st">&#39;measure&#39;</span>] })<span class="op">;</span></span>
<span id="cb340-204"><a href="#cb340-204" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb340-205"><a href="#cb340-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb340-206"><a href="#cb340-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-207"><a href="#cb340-207" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;optimized-dashboard&#39;</span><span class="op">,</span> OptimizedDashboard)<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.12" id="troubleshooting-performance-issues"><span
class="header-section-number">15.12</span> Troubleshooting Performance
Issues</h2>
<h3 data-number="15.12.1" id="problem-1-memory-leaks"><span
class="header-section-number">15.12.1</span> Problem 1: Memory
Leaks</h3>
<p><strong>Symptoms</strong>: Page gets slower over time, browser tab
uses increasing memory.</p>
<p><strong>Common causes</strong>:</p>
<ul>
<li>Event listeners not removed</li>
<li>Setters/intervals not cleared</li>
<li>Large objects cached indefinitely</li>
</ul>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb341"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LeakyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Memory leak: handler never removed</span></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">onResize</span>)<span class="op">;</span></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-6"><a href="#cb341-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Memory leak: interval never cleared</span></span>
<span id="cb341-7"><a href="#cb341-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">intervalId</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">update</span>()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb341-8"><a href="#cb341-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-9"><a href="#cb341-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Memory leak: cache grows forever</span></span>
<span id="cb341-10"><a href="#cb341-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb341-11"><a href="#cb341-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb341-12"><a href="#cb341-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb341-13"><a href="#cb341-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-14"><a href="#cb341-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FixedComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb341-15"><a href="#cb341-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb341-16"><a href="#cb341-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Store handler reference</span></span>
<span id="cb341-17"><a href="#cb341-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">onResize</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleResize</span>()<span class="op">;</span></span>
<span id="cb341-18"><a href="#cb341-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">onResize</span>)<span class="op">;</span></span>
<span id="cb341-19"><a href="#cb341-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-20"><a href="#cb341-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Store interval ID</span></span>
<span id="cb341-21"><a href="#cb341-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">intervalId</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">update</span>()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb341-22"><a href="#cb341-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-23"><a href="#cb341-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Use LRU cache with size limit</span></span>
<span id="cb341-24"><a href="#cb341-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb341-25"><a href="#cb341-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxCacheSize</span> <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb341-26"><a href="#cb341-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb341-27"><a href="#cb341-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-28"><a href="#cb341-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb341-29"><a href="#cb341-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Clean up listener</span></span>
<span id="cb341-30"><a href="#cb341-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">onResize</span>)<span class="op">;</span></span>
<span id="cb341-31"><a href="#cb341-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-32"><a href="#cb341-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Clear interval</span></span>
<span id="cb341-33"><a href="#cb341-33" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">intervalId</span>)<span class="op">;</span></span>
<span id="cb341-34"><a href="#cb341-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-35"><a href="#cb341-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Clear cache</span></span>
<span id="cb341-36"><a href="#cb341-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb341-37"><a href="#cb341-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb341-38"><a href="#cb341-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-39"><a href="#cb341-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addToCache</span>(key<span class="op">,</span> value) {</span>
<span id="cb341-40"><a href="#cb341-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="at">size</span> <span class="op">&gt;=</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxCacheSize</span>) {</span>
<span id="cb341-41"><a href="#cb341-41" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Remove oldest entry</span></span>
<span id="cb341-42"><a href="#cb341-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstKey <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">keys</span>()<span class="op">.</span><span class="fu">next</span>()<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb341-43"><a href="#cb341-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">delete</span>(firstKey)<span class="op">;</span></span>
<span id="cb341-44"><a href="#cb341-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb341-45"><a href="#cb341-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb341-46"><a href="#cb341-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb341-47"><a href="#cb341-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Use browser DevTools to detect leaks: 1. Open Performance Monitor
(Cmd/Ctrl + Shift + P → “Performance Monitor”) 2. Watch JS heap size
over time 3. Take heap snapshots to find retained objects</p>
<h3 data-number="15.12.2" id="problem-2-slow-initial-render"><span
class="header-section-number">15.12.2</span> Problem 2: Slow Initial
Render</h3>
<p><strong>Symptoms</strong>: Long time before page shows content, poor
LCP score.</p>
<p><strong>Common causes</strong>:</p>
<ul>
<li>Loading too much JavaScript upfront</li>
<li>Synchronous data fetching</li>
<li>Rendering everything at once</li>
</ul>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb342"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Wait for everything</span></span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SlowApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(data)<span class="op">;</span></span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb342-7"><a href="#cb342-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb342-8"><a href="#cb342-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-9"><a href="#cb342-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Progressive rendering</span></span>
<span id="cb342-10"><a href="#cb342-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FastApp <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb342-11"><a href="#cb342-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb342-12"><a href="#cb342-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Show shell immediately</span></span>
<span id="cb342-13"><a href="#cb342-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;div class=&quot;shell&quot;&gt;Loading...&lt;/div&gt;&#39;</span><span class="op">;</span></span>
<span id="cb342-14"><a href="#cb342-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-15"><a href="#cb342-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Load data asynchronously</span></span>
<span id="cb342-16"><a href="#cb342-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadData</span>()<span class="op">;</span></span>
<span id="cb342-17"><a href="#cb342-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb342-18"><a href="#cb342-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-19"><a href="#cb342-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadData</span>() {</span>
<span id="cb342-20"><a href="#cb342-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb342-21"><a href="#cb342-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/data&#39;</span>)<span class="op">.</span><span class="fu">then</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb342-22"><a href="#cb342-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(data)<span class="op">;</span></span>
<span id="cb342-23"><a href="#cb342-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb342-24"><a href="#cb342-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderError</span>(error)<span class="op">;</span></span>
<span id="cb342-25"><a href="#cb342-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb342-26"><a href="#cb342-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb342-27"><a href="#cb342-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="15.12.3" id="problem-3-large-bundle-size"><span
class="header-section-number">15.12.3</span> Problem 3: Large Bundle
Size</h3>
<p><strong>Symptoms</strong>: Slow initial load, poor First Contentful
Paint.</p>
<p><strong>Diagnosis</strong>:</p>
<div class="sourceCode" id="cb343"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Analyze what&#39;s in your bundle</span></span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">table</span>(</span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByType</span>(<span class="st">&#39;resource&#39;</span>)</span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">initiatorType</span> <span class="op">===</span> <span class="st">&#39;script&#39;</span>)</span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(r <span class="kw">=&gt;</span> ({</span>
<span id="cb343-6"><a href="#cb343-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> r<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)<span class="op">.</span><span class="fu">pop</span>()<span class="op">,</span></span>
<span id="cb343-7"><a href="#cb343-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">size</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>(r<span class="op">.</span><span class="at">transferSize</span> <span class="op">/</span> <span class="dv">1024</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs"> KB`</span><span class="op">,</span></span>
<span id="cb343-8"><a href="#cb343-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">time</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>r<span class="op">.</span><span class="at">duration</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">ms`</span></span>
<span id="cb343-9"><a href="#cb343-9" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb343-10"><a href="#cb343-10" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Use import maps to share dependencies</li>
<li>Lazy load non-critical features</li>
<li>Use native APIs instead of libraries</li>
<li>Tree-shake unused code</li>
</ul>
<h3 data-number="15.12.4" id="problem-4-layout-thrashing"><span
class="header-section-number">15.12.4</span> Problem 4: Layout
Thrashing</h3>
<p><strong>Symptoms</strong>: Janky scrolling, slow animations, poor
FPS.</p>
<p><strong>Cause</strong>: Reading and writing DOM in the same
frame.</p>
<div class="sourceCode" id="cb344"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Forces multiple reflows</span></span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">forEach</span>(item <span class="kw">=&gt;</span> {</span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> height <span class="op">=</span> item<span class="op">.</span><span class="at">offsetHeight</span><span class="op">;</span>  <span class="co">// Read (reflow)</span></span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a>  item<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> height <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="st">&#39;px&#39;</span><span class="op">;</span>  <span class="co">// Write (reflow)</span></span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-7"><a href="#cb344-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Batch reads and writes</span></span>
<span id="cb344-8"><a href="#cb344-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> heights <span class="op">=</span> items<span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> item<span class="op">.</span><span class="at">offsetHeight</span>)<span class="op">;</span>  <span class="co">// Batch reads</span></span>
<span id="cb344-9"><a href="#cb344-9" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">forEach</span>((item<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb344-10"><a href="#cb344-10" aria-hidden="true" tabindex="-1"></a>  item<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> heights[i] <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="st">&#39;px&#39;</span><span class="op">;</span>  <span class="co">// Batch writes</span></span>
<span id="cb344-11"><a href="#cb344-11" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb344-12"><a href="#cb344-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-13"><a href="#cb344-13" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Better: Use requestAnimationFrame</span></span>
<span id="cb344-14"><a href="#cb344-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateLayout</span>() {</span>
<span id="cb344-15"><a href="#cb344-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// All reads first</span></span>
<span id="cb344-16"><a href="#cb344-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> measurements <span class="op">=</span> elements<span class="op">.</span><span class="fu">map</span>(el <span class="kw">=&gt;</span> ({</span>
<span id="cb344-17"><a href="#cb344-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> el<span class="op">.</span><span class="at">offsetWidth</span><span class="op">,</span></span>
<span id="cb344-18"><a href="#cb344-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> el<span class="op">.</span><span class="at">offsetHeight</span></span>
<span id="cb344-19"><a href="#cb344-19" aria-hidden="true" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb344-20"><a href="#cb344-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-21"><a href="#cb344-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Then all writes</span></span>
<span id="cb344-22"><a href="#cb344-22" aria-hidden="true" tabindex="-1"></a>  elements<span class="op">.</span><span class="fu">forEach</span>((el<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb344-23"><a href="#cb344-23" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> measurements[i]<span class="op">.</span><span class="at">width</span> <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="st">&#39;px&#39;</span><span class="op">;</span></span>
<span id="cb344-24"><a href="#cb344-24" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> measurements[i]<span class="op">.</span><span class="at">height</span> <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> <span class="st">&#39;px&#39;</span><span class="op">;</span></span>
<span id="cb344-25"><a href="#cb344-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb344-26"><a href="#cb344-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb344-27"><a href="#cb344-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-28"><a href="#cb344-28" aria-hidden="true" tabindex="-1"></a><span class="fu">requestAnimationFrame</span>(updateLayout)<span class="op">;</span></span></code></pre></div>
<h2 data-number="15.13" id="performance-best-practices"><span
class="header-section-number">15.13</span> Performance Best
Practices</h2>
<ol type="1">
<li><p><strong>Load Critical Resources First</strong>: Prioritize
above-the-fold content and user-interactive elements.</p></li>
<li><p><strong>Lazy Load Everything Else</strong>: Use Intersection
Observer for images, components, and heavy features.</p></li>
<li><p><strong>Cache Aggressively</strong>: Use service workers, HTTP
caching, and in-memory caches appropriately.</p></li>
<li><p><strong>Measure Real Users</strong>: Track Web Vitals for actual
user experiences, not just lab tests.</p></li>
<li><p><strong>Debounce User Input</strong>: Don’t make API calls on
every keystroke—wait for users to finish typing.</p></li>
<li><p><strong>Virtualize Long Lists</strong>: Never render more than
~50-100 items at once.</p></li>
<li><p><strong>Code Split by Route</strong>: Load only the JavaScript
needed for the current page.</p></li>
<li><p><strong>Optimize Images</strong>: Use modern formats (WebP,
AVIF), lazy loading, and responsive images.</p></li>
<li><p><strong>Clean Up Resources</strong>: Always remove event
listeners and clear intervals in
<code>disconnectedCallback</code>.</p></li>
<li><p><strong>Profile Before Optimizing</strong>: Use DevTools to find
actual bottlenecks—don’t guess.</p></li>
</ol>
<h2 data-number="15.14" id="hands-on-exercises"><span
class="header-section-number">15.14</span> Hands-On Exercises</h2>
<h3 data-number="15.14.1"
id="exercise-1-optimize-an-image-gallery"><span
class="header-section-number">15.14.1</span> Exercise 1: Optimize an
Image Gallery</h3>
<p>Create an image gallery that:</p>
<ul>
<li>Lazy loads images as they scroll into view</li>
<li>Uses Intersection Observer</li>
<li>Shows a loading placeholder</li>
<li>Tracks LCP for the first visible image</li>
</ul>
<p><strong>Bonus</strong>: Add a “Load All” button that prefetches
remaining images.</p>
<h3 data-number="15.14.2" id="exercise-2-build-a-virtual-list"><span
class="header-section-number">15.14.2</span> Exercise 2: Build a Virtual
List</h3>
<p>Implement a virtual list component that:</p>
<ul>
<li>Renders only visible items</li>
<li>Handles variable-height items</li>
<li>Supports smooth scrolling</li>
<li>Works with 10,000+ items</li>
</ul>
<p><strong>Bonus</strong>: Add keyboard navigation and
accessibility.</p>
<h3 data-number="15.14.3"
id="exercise-3-implement-request-deduplication"><span
class="header-section-number">15.14.3</span> Exercise 3: Implement
Request Deduplication</h3>
<p>Create a data service that:</p>
<ul>
<li>Prevents duplicate API calls for the same resource</li>
<li>Shares pending requests between components</li>
<li>Caches responses for 1 minute</li>
<li>Provides a cache invalidation API</li>
</ul>
<p><strong>Bonus</strong>: Add optimistic updates with rollback on
error.</p>
<h3 data-number="15.14.4" id="exercise-4-performance-dashboard"><span
class="header-section-number">15.14.4</span> Exercise 4: Performance
Dashboard</h3>
<p>Build a performance monitoring dashboard that:</p>
<ul>
<li>Tracks all Core Web Vitals</li>
<li>Shows performance over time</li>
<li>Highlights performance regressions</li>
<li>Exports data to CSV</li>
</ul>
<p><strong>Bonus</strong>: Add alerts when metrics exceed
thresholds.</p>
<h2 data-number="15.15" id="summary-14"><span
class="header-section-number">15.15</span> Summary</h2>
<p>Performance optimization is about making smart tradeoffs:</p>
<ul>
<li><strong>Load less</strong>: Code split, lazy load, tree shake</li>
<li><strong>Cache more</strong>: Service workers, HTTP cache, memory
cache</li>
<li><strong>Render efficiently</strong>: Virtual lists, debouncing,
memoization</li>
<li><strong>Measure everything</strong>: Web Vitals, Performance API,
DevTools</li>
</ul>
<p>Start with the low-hanging fruit (lazy loading, caching) and use
DevTools to find the real bottlenecks. Remember: premature optimization
is the root of all evil—measure first, then optimize.</p>
<h2 data-number="15.16" id="further-reading-14"><span
class="header-section-number">15.16</span> Further Reading</h2>
<ul>
<li><strong>Building with LARC - Chapter 17 (Performance)</strong>: Deep
dive into LARC-specific optimization techniques</li>
<li><strong>Building with LARC - Chapter 8 (Lifecycle)</strong>:
Component cleanup and resource management</li>
<li><strong>Building with LARC - Chapter 11 (Best Practices)</strong>:
Performance patterns and anti-patterns</li>
</ul>
<div class="pagebreak">

</div>
<h1 data-number="16" id="deployment"><span
class="header-section-number">16</span> Deployment</h1>
<p>Deploying LARC applications is refreshingly simple. No build
artifacts to manage, no complex CI/CD pipelines required. Just static
files that any web server can handle.</p>
<h2 data-number="16.1" id="static-hosting-options"><span
class="header-section-number">16.1</span> Static Hosting Options</h2>
<p>LARC apps are static files. Host them anywhere:</p>
<h3 data-number="16.1.1" id="github-pages"><span
class="header-section-number">16.1.1</span> GitHub Pages</h3>
<p>Free hosting for public repositories:</p>
<div class="sourceCode" id="cb345"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/deploy.yml</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to GitHub Pages</span></span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-8"><a href="#cb345-8" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb345-9"><a href="#cb345-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy</span><span class="kw">:</span></span>
<span id="cb345-10"><a href="#cb345-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb345-11"><a href="#cb345-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb345-12"><a href="#cb345-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb345-13"><a href="#cb345-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> peaceiris/actions-gh-pages@v3</span></span>
<span id="cb345-14"><a href="#cb345-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb345-15"><a href="#cb345-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">github_token</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span>
<span id="cb345-16"><a href="#cb345-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">publish_dir</span><span class="kw">:</span><span class="at"> ./public</span></span></code></pre></div>
<h3 data-number="16.1.2" id="netlify"><span
class="header-section-number">16.1.2</span> Netlify</h3>
<p>Drag and drop deployment or connect to Git:</p>
<div class="sourceCode" id="cb346"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="co"># netlify.toml</span></span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[build]</span></span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">publish</span> <span class="op">=</span> <span class="st">&quot;public&quot;</span></span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[[redirects]]</span></span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">from</span> <span class="op">=</span> <span class="st">&quot;/*&quot;</span></span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">to</span> <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">status</span> <span class="op">=</span> <span class="dv">200</span></span></code></pre></div>
<h3 data-number="16.1.3" id="vercel"><span
class="header-section-number">16.1.3</span> Vercel</h3>
<p>Zero-config deployment:</p>
<div class="sourceCode" id="cb347"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;rewrites&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="st">&quot;/(.*)&quot;</span><span class="fu">,</span> <span class="dt">&quot;destination&quot;</span><span class="fu">:</span> <span class="st">&quot;/index.html&quot;</span> <span class="fu">}</span></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="16.2" id="cdn-configuration"><span
class="header-section-number">16.2</span> CDN Configuration</h2>
<p>Serve assets from a CDN for faster global delivery:</p>
<div class="sourceCode" id="cb348"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Use CDN for LARC core --&gt;</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> type=</span><span class="st">&quot;importmap&quot;</span><span class="dt">&gt;</span></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;imports&quot;</span><span class="op">:</span> {</span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@aspect/pan-client&quot;</span><span class="op">:</span> <span class="st">&quot;https://cdn.jsdelivr.net/npm/@aspect/pan-client@latest/pan-client.mjs&quot;</span></span>
<span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb348-7"><a href="#cb348-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb348-8"><a href="#cb348-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Set proper cache headers:</p>
<pre><code># .htaccess for Apache
&lt;IfModule mod_expires.c&gt;
  ExpiresActive On

  # HTML - no cache (or short cache)
  ExpiresByType text/html &quot;access plus 0 seconds&quot;

  # CSS and JS - long cache (use versioned filenames)
  ExpiresByType text/css &quot;access plus 1 year&quot;
  ExpiresByType application/javascript &quot;access plus 1 year&quot;

  # Images - long cache
  ExpiresByType image/png &quot;access plus 1 year&quot;
  ExpiresByType image/jpeg &quot;access plus 1 year&quot;
  ExpiresByType image/svg+xml &quot;access plus 1 year&quot;
&lt;/IfModule&gt;</code></pre>
<h2 data-number="16.3" id="environment-variables"><span
class="header-section-number">16.3</span> Environment Variables</h2>
<p>Manage configuration across environments:</p>
<div class="sourceCode" id="cb350"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config.js</span></span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> configs <span class="op">=</span> {</span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">development</span><span class="op">:</span> {</span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;http://localhost:3000/api&#39;</span><span class="op">,</span></span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">debug</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">production</span><span class="op">:</span> {</span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;https://api.example.com&#39;</span><span class="op">,</span></span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">debug</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> env <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">hostname</span> <span class="op">===</span> <span class="st">&#39;localhost&#39;</span> <span class="op">?</span> <span class="st">&#39;development&#39;</span> <span class="op">:</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></span>
<span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> config <span class="op">=</span> configs[env]<span class="op">;</span></span></code></pre></div>
<p>Or use a build-time approach:</p>
<div class="sourceCode" id="cb351"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Injected by server/build --&gt;</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">CONFIG</span> <span class="op">=</span> {</span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;%%API_URL%%&#39;</span><span class="op">,</span></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">version</span><span class="op">:</span> <span class="st">&#39;%%VERSION%%&#39;</span></span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="16.4" id="pre-deployment-checklist"><span
class="header-section-number">16.4</span> Pre-Deployment Checklist</h2>
<p>Before deploying to production:</p>
<ul class="task-list">
<li><label><input type="checkbox" />Test in all target
browsers</label></li>
<li><label><input type="checkbox" />Verify all API endpoints use
HTTPS</label></li>
<li><label><input type="checkbox" />Check for console
errors</label></li>
<li><label><input type="checkbox" />Validate accessibility (keyboard
navigation, screen readers)</label></li>
<li><label><input type="checkbox" />Test on slow network (Chrome
DevTools throttling)</label></li>
<li><label><input type="checkbox" />Verify error handling
works</label></li>
<li><label><input type="checkbox" />Check mobile
responsiveness</label></li>
<li><label><input type="checkbox" />Set up error monitoring (Sentry,
LogRocket)</label></li>
<li><label><input type="checkbox" />Configure analytics</label></li>
<li><label><input type="checkbox" />Enable HTTPS</label></li>
<li><label><input type="checkbox" />Set security headers</label></li>
</ul>
<h2 data-number="16.5" id="monitoring"><span
class="header-section-number">16.5</span> Monitoring</h2>
<p>Track errors in production:</p>
<div class="sourceCode" id="cb352"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="co">// error-tracking.js</span></span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(<span class="st">&#39;/api/errors&#39;</span><span class="op">,</span> {</span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">message</span><span class="op">,</span></span>
<span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">filename</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb352-9"><a href="#cb352-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineno</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">lineno</span><span class="op">,</span></span>
<span id="cb352-10"><a href="#cb352-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">colno</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">colno</span><span class="op">,</span></span>
<span id="cb352-11"><a href="#cb352-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stack</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">error</span><span class="op">?.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb352-12"><a href="#cb352-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userAgent</span><span class="op">:</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">userAgent</span><span class="op">,</span></span>
<span id="cb352-13"><a href="#cb352-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span></span>
<span id="cb352-14"><a href="#cb352-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb352-15"><a href="#cb352-15" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb352-16"><a href="#cb352-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb352-17"><a href="#cb352-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-18"><a href="#cb352-18" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;unhandledrejection&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb352-19"><a href="#cb352-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(<span class="st">&#39;/api/errors&#39;</span><span class="op">,</span> {</span>
<span id="cb352-20"><a href="#cb352-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb352-21"><a href="#cb352-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span> }<span class="op">,</span></span>
<span id="cb352-22"><a href="#cb352-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({</span>
<span id="cb352-23"><a href="#cb352-23" aria-hidden="true" tabindex="-1"></a>      <span class="dt">message</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">message</span> <span class="op">||</span> <span class="st">&#39;Unhandled promise rejection&#39;</span><span class="op">,</span></span>
<span id="cb352-24"><a href="#cb352-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">stack</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">reason</span><span class="op">?.</span><span class="at">stack</span><span class="op">,</span></span>
<span id="cb352-25"><a href="#cb352-25" aria-hidden="true" tabindex="-1"></a>      <span class="dt">userAgent</span><span class="op">:</span> <span class="bu">navigator</span><span class="op">.</span><span class="at">userAgent</span><span class="op">,</span></span>
<span id="cb352-26"><a href="#cb352-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">url</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">href</span></span>
<span id="cb352-27"><a href="#cb352-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb352-28"><a href="#cb352-28" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb352-29"><a href="#cb352-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.6" id="netlify-deployment-walkthrough"><span
class="header-section-number">16.6</span> Netlify Deployment
Walkthrough</h2>
<p>Let’s deploy a LARC app to Netlify step-by-step:</p>
<p><strong>1. Prepare your project:</strong></p>
<div class="sourceCode" id="cb353"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Project structure</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a><span class="ex">my-larc-app/</span></span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> public/</span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── index.html</span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── app.js</span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── components/</span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── styles/</span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> netlify.toml</span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> package.json</span></code></pre></div>
<p><strong>2. Create <code>netlify.toml</code>:</strong></p>
<div class="sourceCode" id="cb354"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[build]</span></span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">publish</span> <span class="op">=</span> <span class="st">&quot;public&quot;</span></span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a><span class="kw">[build.environment]</span></span>
<span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">NODE_VERSION</span> <span class="op">=</span> <span class="st">&quot;18&quot;</span></span>
<span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-7"><a href="#cb354-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[[redirects]]</span></span>
<span id="cb354-8"><a href="#cb354-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">from</span> <span class="op">=</span> <span class="st">&quot;/*&quot;</span></span>
<span id="cb354-9"><a href="#cb354-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">to</span> <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb354-10"><a href="#cb354-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">status</span> <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb354-11"><a href="#cb354-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-12"><a href="#cb354-12" aria-hidden="true" tabindex="-1"></a><span class="kw">[[headers]]</span></span>
<span id="cb354-13"><a href="#cb354-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">for</span> <span class="op">=</span> <span class="st">&quot;/*.js&quot;</span></span>
<span id="cb354-14"><a href="#cb354-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">[headers.values]</span></span>
<span id="cb354-15"><a href="#cb354-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Cache-Control</span> <span class="op">=</span> <span class="st">&quot;public, max-age=31536000, immutable&quot;</span></span>
<span id="cb354-16"><a href="#cb354-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-17"><a href="#cb354-17" aria-hidden="true" tabindex="-1"></a><span class="kw">[[headers]]</span></span>
<span id="cb354-18"><a href="#cb354-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">for</span> <span class="op">=</span> <span class="st">&quot;/*.css&quot;</span></span>
<span id="cb354-19"><a href="#cb354-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">[headers.values]</span></span>
<span id="cb354-20"><a href="#cb354-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Cache-Control</span> <span class="op">=</span> <span class="st">&quot;public, max-age=31536000, immutable&quot;</span></span>
<span id="cb354-21"><a href="#cb354-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-22"><a href="#cb354-22" aria-hidden="true" tabindex="-1"></a><span class="kw">[[headers]]</span></span>
<span id="cb354-23"><a href="#cb354-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">for</span> <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb354-24"><a href="#cb354-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">[headers.values]</span></span>
<span id="cb354-25"><a href="#cb354-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Cache-Control</span> <span class="op">=</span> <span class="st">&quot;public, max-age=0, must-revalidate&quot;</span></span>
<span id="cb354-26"><a href="#cb354-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">X-Frame-Options</span> <span class="op">=</span> <span class="st">&quot;DENY&quot;</span></span>
<span id="cb354-27"><a href="#cb354-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">X-Content-Type-Options</span> <span class="op">=</span> <span class="st">&quot;nosniff&quot;</span></span>
<span id="cb354-28"><a href="#cb354-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Referrer-Policy</span> <span class="op">=</span> <span class="st">&quot;strict-origin-when-cross-origin&quot;</span></span>
<span id="cb354-29"><a href="#cb354-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Permissions-Policy</span> <span class="op">=</span> <span class="st">&quot;geolocation=(), microphone=(), camera=()&quot;</span></span></code></pre></div>
<p><strong>3. Deploy via Netlify CLI:</strong></p>
<div class="sourceCode" id="cb355"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Netlify CLI</span></span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-g</span> netlify-cli</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Login</span></span>
<span id="cb355-5"><a href="#cb355-5" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> login</span>
<span id="cb355-6"><a href="#cb355-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-7"><a href="#cb355-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize site</span></span>
<span id="cb355-8"><a href="#cb355-8" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> init</span>
<span id="cb355-9"><a href="#cb355-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-10"><a href="#cb355-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy</span></span>
<span id="cb355-11"><a href="#cb355-11" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> deploy <span class="at">--prod</span></span></code></pre></div>
<p><strong>4. Set environment variables:</strong></p>
<div class="sourceCode" id="cb356"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Via CLI</span></span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> env:set API_URL <span class="st">&quot;https://api.example.com&quot;</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> env:set SENTRY_DSN <span class="st">&quot;https://...&quot;</span></span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Or in Netlify UI: Site Settings → Environment Variables</span></span></code></pre></div>
<p><strong>5. Access in your app:</strong></p>
<div class="sourceCode" id="cb357"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Access Netlify environment variables</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> config <span class="op">=</span> {</span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">apiUrl</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">ENV</span><span class="op">?.</span><span class="at">API_URL</span> <span class="op">||</span> <span class="st">&#39;http://localhost:3000&#39;</span><span class="op">,</span></span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sentryDsn</span><span class="op">:</span> <span class="bu">window</span><span class="op">.</span><span class="at">ENV</span><span class="op">?.</span><span class="at">SENTRY_DSN</span></span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.7" id="vercel-deployment-walkthrough"><span
class="header-section-number">16.7</span> Vercel Deployment
Walkthrough</h2>
<p>Deploy to Vercel with zero configuration:</p>
<p><strong>1. Install Vercel CLI:</strong></p>
<div class="sourceCode" id="cb358"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-g</span> vercel</span></code></pre></div>
<p><strong>2. Create <code>vercel.json</code>:</strong></p>
<div class="sourceCode" id="cb359"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;builds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;public/**&quot;</span><span class="fu">,</span></span>
<span id="cb359-6"><a href="#cb359-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;use&quot;</span><span class="fu">:</span> <span class="st">&quot;@vercel/static&quot;</span></span>
<span id="cb359-7"><a href="#cb359-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb359-8"><a href="#cb359-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb359-9"><a href="#cb359-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;routes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb359-10"><a href="#cb359-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb359-11"><a href="#cb359-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;/(.*)&quot;</span><span class="fu">,</span></span>
<span id="cb359-12"><a href="#cb359-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;dest&quot;</span><span class="fu">:</span> <span class="st">&quot;/public/$1&quot;</span></span>
<span id="cb359-13"><a href="#cb359-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb359-14"><a href="#cb359-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb359-15"><a href="#cb359-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;/.*&quot;</span><span class="fu">,</span></span>
<span id="cb359-16"><a href="#cb359-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;dest&quot;</span><span class="fu">:</span> <span class="st">&quot;/public/index.html&quot;</span></span>
<span id="cb359-17"><a href="#cb359-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb359-18"><a href="#cb359-18" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb359-19"><a href="#cb359-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;headers&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb359-20"><a href="#cb359-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb359-21"><a href="#cb359-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="st">&quot;/public/(.*</span><span class="ch">\\</span><span class="st">.js|.*</span><span class="ch">\\</span><span class="st">.css)&quot;</span><span class="fu">,</span></span>
<span id="cb359-22"><a href="#cb359-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;headers&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb359-23"><a href="#cb359-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb359-24"><a href="#cb359-24" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;Cache-Control&quot;</span><span class="fu">,</span></span>
<span id="cb359-25"><a href="#cb359-25" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="st">&quot;public, max-age=31536000, immutable&quot;</span></span>
<span id="cb359-26"><a href="#cb359-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb359-27"><a href="#cb359-27" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span></span>
<span id="cb359-28"><a href="#cb359-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb359-29"><a href="#cb359-29" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb359-30"><a href="#cb359-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;env&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb359-31"><a href="#cb359-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;API_URL&quot;</span><span class="fu">:</span> <span class="st">&quot;@api-url&quot;</span><span class="fu">,</span></span>
<span id="cb359-32"><a href="#cb359-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;NODE_ENV&quot;</span><span class="fu">:</span> <span class="st">&quot;production&quot;</span></span>
<span id="cb359-33"><a href="#cb359-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb359-34"><a href="#cb359-34" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>3. Deploy:</strong></p>
<div class="sourceCode" id="cb360"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First deployment</span></span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="ex">vercel</span></span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Production deployment</span></span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a><span class="ex">vercel</span> <span class="at">--prod</span></span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set secrets</span></span>
<span id="cb360-8"><a href="#cb360-8" aria-hidden="true" tabindex="-1"></a><span class="ex">vercel</span> secrets add api-url <span class="st">&quot;https://api.example.com&quot;</span></span></code></pre></div>
<p><strong>4. Configure custom domain:</strong></p>
<div class="sourceCode" id="cb361"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vercel</span> domains add www.example.com</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="ex">vercel</span> alias deployment-url.vercel.app www.example.com</span></code></pre></div>
<h2 data-number="16.8" id="github-pages-deployment"><span
class="header-section-number">16.8</span> GitHub Pages Deployment</h2>
<p>Deploy directly from your GitHub repository:</p>
<p><strong>1. Create GitHub Actions workflow:</strong></p>
<div class="sourceCode" id="cb362"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/deploy.yml</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to GitHub Pages</span></span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb362-7"><a href="#cb362-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb362-8"><a href="#cb362-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-9"><a href="#cb362-9" aria-hidden="true" tabindex="-1"></a><span class="fu">permissions</span><span class="kw">:</span></span>
<span id="cb362-10"><a href="#cb362-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">contents</span><span class="kw">:</span><span class="at"> read</span></span>
<span id="cb362-11"><a href="#cb362-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pages</span><span class="kw">:</span><span class="at"> write</span></span>
<span id="cb362-12"><a href="#cb362-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">id-token</span><span class="kw">:</span><span class="at"> write</span></span>
<span id="cb362-13"><a href="#cb362-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-14"><a href="#cb362-14" aria-hidden="true" tabindex="-1"></a><span class="fu">concurrency</span><span class="kw">:</span></span>
<span id="cb362-15"><a href="#cb362-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">group</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;pages&quot;</span></span>
<span id="cb362-16"><a href="#cb362-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">cancel-in-progress</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb362-17"><a href="#cb362-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-18"><a href="#cb362-18" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb362-19"><a href="#cb362-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy</span><span class="kw">:</span></span>
<span id="cb362-20"><a href="#cb362-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb362-21"><a href="#cb362-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> github-pages</span></span>
<span id="cb362-22"><a href="#cb362-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">url</span><span class="kw">:</span><span class="at"> ${{ steps.deployment.outputs.page_url }}</span></span>
<span id="cb362-23"><a href="#cb362-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb362-24"><a href="#cb362-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb362-25"><a href="#cb362-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout</span></span>
<span id="cb362-26"><a href="#cb362-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb362-27"><a href="#cb362-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-28"><a href="#cb362-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Pages</span></span>
<span id="cb362-29"><a href="#cb362-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/configure-pages@v4</span></span>
<span id="cb362-30"><a href="#cb362-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-31"><a href="#cb362-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload artifact</span></span>
<span id="cb362-32"><a href="#cb362-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-pages-artifact@v3</span></span>
<span id="cb362-33"><a href="#cb362-33" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb362-34"><a href="#cb362-34" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;./public&#39;</span></span>
<span id="cb362-35"><a href="#cb362-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-36"><a href="#cb362-36" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to GitHub Pages</span></span>
<span id="cb362-37"><a href="#cb362-37" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> deployment</span></span>
<span id="cb362-38"><a href="#cb362-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/deploy-pages@v4</span></span></code></pre></div>
<p><strong>2. Configure repository:</strong></p>
<ol type="1">
<li>Go to Settings → Pages</li>
<li>Source: “GitHub Actions”</li>
<li>Your site will be available at
<code>https://username.github.io/repo-name/</code></li>
</ol>
<p><strong>3. Handle base path:</strong></p>
<div class="sourceCode" id="cb363"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co">// config.js - Handle GitHub Pages subdirectory</span></span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> basePath <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;repo-name&#39;</span>)</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">?</span> <span class="st">&#39;/repo-name&#39;</span></span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> config <span class="op">=</span> {</span>
<span id="cb363-7"><a href="#cb363-7" aria-hidden="true" tabindex="-1"></a>  basePath<span class="op">,</span></span>
<span id="cb363-8"><a href="#cb363-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">apiUrl</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>basePath<span class="sc">}</span><span class="vs">/api`</span></span>
<span id="cb363-9"><a href="#cb363-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb363-10"><a href="#cb363-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-11"><a href="#cb363-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Use in router</span></span>
<span id="cb363-12"><a href="#cb363-12" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> {</span>
<span id="cb363-13"><a href="#cb363-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">path</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span>config<span class="op">.</span><span class="at">basePath</span><span class="sc">}</span><span class="vs">/about`</span></span>
<span id="cb363-14"><a href="#cb363-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="16.9" id="cicd-pipeline-example"><span
class="header-section-number">16.9</span> CI/CD Pipeline Example</h2>
<p>Complete GitHub Actions workflow with testing and deployment:</p>
<div class="sourceCode" id="cb364"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/ci-cd.yml</span></span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> CI/CD Pipeline</span></span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> develop</span><span class="kw">]</span></span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">NODE_VERSION</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;18&#39;</span></span>
<span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb364-14"><a href="#cb364-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb364-15"><a href="#cb364-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb364-16"><a href="#cb364-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb364-17"><a href="#cb364-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb364-18"><a href="#cb364-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-19"><a href="#cb364-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Node.js</span></span>
<span id="cb364-20"><a href="#cb364-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v4</span></span>
<span id="cb364-21"><a href="#cb364-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-22"><a href="#cb364-22" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> ${{ env.NODE_VERSION }}</span></span>
<span id="cb364-23"><a href="#cb364-23" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">cache</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;npm&#39;</span></span>
<span id="cb364-24"><a href="#cb364-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-25"><a href="#cb364-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb364-26"><a href="#cb364-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm ci</span></span>
<span id="cb364-27"><a href="#cb364-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-28"><a href="#cb364-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run linter</span></span>
<span id="cb364-29"><a href="#cb364-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm run lint</span></span>
<span id="cb364-30"><a href="#cb364-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-31"><a href="#cb364-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb364-32"><a href="#cb364-32" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm test</span></span>
<span id="cb364-33"><a href="#cb364-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-34"><a href="#cb364-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run E2E tests</span></span>
<span id="cb364-35"><a href="#cb364-35" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm run test:e2e</span></span>
<span id="cb364-36"><a href="#cb364-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-37"><a href="#cb364-37" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload test results</span></span>
<span id="cb364-38"><a href="#cb364-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> always()</span></span>
<span id="cb364-39"><a href="#cb364-39" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v3</span></span>
<span id="cb364-40"><a href="#cb364-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-41"><a href="#cb364-41" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> test-results</span></span>
<span id="cb364-42"><a href="#cb364-42" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> test-results/</span></span>
<span id="cb364-43"><a href="#cb364-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-44"><a href="#cb364-44" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb364-45"><a href="#cb364-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb364-46"><a href="#cb364-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb364-47"><a href="#cb364-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb364-48"><a href="#cb364-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb364-49"><a href="#cb364-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-50"><a href="#cb364-50" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Node.js</span></span>
<span id="cb364-51"><a href="#cb364-51" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-node@v4</span></span>
<span id="cb364-52"><a href="#cb364-52" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-53"><a href="#cb364-53" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">node-version</span><span class="kw">:</span><span class="at"> ${{ env.NODE_VERSION }}</span></span>
<span id="cb364-54"><a href="#cb364-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-55"><a href="#cb364-55" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Create build info</span></span>
<span id="cb364-56"><a href="#cb364-56" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb364-57"><a href="#cb364-57" aria-hidden="true" tabindex="-1"></a>          echo &quot;Build: ${{ github.sha }}&quot; &gt; public/build.txt</span>
<span id="cb364-58"><a href="#cb364-58" aria-hidden="true" tabindex="-1"></a>          echo &quot;Date: $(date)&quot; &gt;&gt; public/build.txt</span>
<span id="cb364-59"><a href="#cb364-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-60"><a href="#cb364-60" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload build artifact</span></span>
<span id="cb364-61"><a href="#cb364-61" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v3</span></span>
<span id="cb364-62"><a href="#cb364-62" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-63"><a href="#cb364-63" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> public</span></span>
<span id="cb364-64"><a href="#cb364-64" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> public/</span></span>
<span id="cb364-65"><a href="#cb364-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-66"><a href="#cb364-66" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy-staging</span><span class="kw">:</span></span>
<span id="cb364-67"><a href="#cb364-67" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> build</span></span>
<span id="cb364-68"><a href="#cb364-68" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == &#39;refs/heads/develop&#39;</span></span>
<span id="cb364-69"><a href="#cb364-69" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb364-70"><a href="#cb364-70" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb364-71"><a href="#cb364-71" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> staging</span></span>
<span id="cb364-72"><a href="#cb364-72" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">url</span><span class="kw">:</span><span class="at"> https://staging.example.com</span></span>
<span id="cb364-73"><a href="#cb364-73" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb364-74"><a href="#cb364-74" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Download artifact</span></span>
<span id="cb364-75"><a href="#cb364-75" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/download-artifact@v3</span></span>
<span id="cb364-76"><a href="#cb364-76" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-77"><a href="#cb364-77" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> public</span></span>
<span id="cb364-78"><a href="#cb364-78" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> public/</span></span>
<span id="cb364-79"><a href="#cb364-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-80"><a href="#cb364-80" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to staging</span></span>
<span id="cb364-81"><a href="#cb364-81" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> netlify/actions/cli@master</span></span>
<span id="cb364-82"><a href="#cb364-82" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb364-83"><a href="#cb364-83" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">NETLIFY_AUTH_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_AUTH_TOKEN }}</span></span>
<span id="cb364-84"><a href="#cb364-84" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">NETLIFY_SITE_ID</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_STAGING_SITE_ID }}</span></span>
<span id="cb364-85"><a href="#cb364-85" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-86"><a href="#cb364-86" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">args</span><span class="kw">:</span><span class="at"> deploy --dir=public --prod</span></span>
<span id="cb364-87"><a href="#cb364-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-88"><a href="#cb364-88" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy-production</span><span class="kw">:</span></span>
<span id="cb364-89"><a href="#cb364-89" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> build</span></span>
<span id="cb364-90"><a href="#cb364-90" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == &#39;refs/heads/main&#39;</span></span>
<span id="cb364-91"><a href="#cb364-91" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb364-92"><a href="#cb364-92" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb364-93"><a href="#cb364-93" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> production</span></span>
<span id="cb364-94"><a href="#cb364-94" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">url</span><span class="kw">:</span><span class="at"> https://example.com</span></span>
<span id="cb364-95"><a href="#cb364-95" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb364-96"><a href="#cb364-96" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Download artifact</span></span>
<span id="cb364-97"><a href="#cb364-97" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/download-artifact@v3</span></span>
<span id="cb364-98"><a href="#cb364-98" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-99"><a href="#cb364-99" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> public</span></span>
<span id="cb364-100"><a href="#cb364-100" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> public/</span></span>
<span id="cb364-101"><a href="#cb364-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-102"><a href="#cb364-102" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to production</span></span>
<span id="cb364-103"><a href="#cb364-103" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> netlify/actions/cli@master</span></span>
<span id="cb364-104"><a href="#cb364-104" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb364-105"><a href="#cb364-105" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">NETLIFY_AUTH_TOKEN</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_AUTH_TOKEN }}</span></span>
<span id="cb364-106"><a href="#cb364-106" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">NETLIFY_SITE_ID</span><span class="kw">:</span><span class="at"> ${{ secrets.NETLIFY_PROD_SITE_ID }}</span></span>
<span id="cb364-107"><a href="#cb364-107" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb364-108"><a href="#cb364-108" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">args</span><span class="kw">:</span><span class="at"> deploy --dir=public --prod</span></span>
<span id="cb364-109"><a href="#cb364-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-110"><a href="#cb364-110" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Notify deployment</span></span>
<span id="cb364-111"><a href="#cb364-111" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb364-112"><a href="#cb364-112" aria-hidden="true" tabindex="-1"></a>          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \</span>
<span id="cb364-113"><a href="#cb364-113" aria-hidden="true" tabindex="-1"></a>            -H &#39;Content-Type: application/json&#39; \</span>
<span id="cb364-114"><a href="#cb364-114" aria-hidden="true" tabindex="-1"></a>            -d &#39;{&quot;text&quot;:&quot;✅ Deployed to production: ${{ github.sha }}&quot;}&#39;</span></code></pre></div>
<h2 data-number="16.10" id="docker-deployment"><span
class="header-section-number">16.10</span> Docker Deployment</h2>
<p>Package your app with Nginx for containerized deployment:</p>
<p><strong>Dockerfile:</strong></p>
<div class="sourceCode" id="cb365"><pre
class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Nginx as base</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> nginx:alpine</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy app files</span></span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> public/ /usr/share/nginx/html/</span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy custom Nginx config</span></span>
<span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf</span>
<span id="cb365-9"><a href="#cb365-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-10"><a href="#cb365-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Expose port</span></span>
<span id="cb365-11"><a href="#cb365-11" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb365-12"><a href="#cb365-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-13"><a href="#cb365-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Health check</span></span>
<span id="cb365-14"><a href="#cb365-14" aria-hidden="true" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="op">--interval=30s</span> <span class="op">--timeout=3s</span> <span class="op">--start-period=5s</span> <span class="op">--retries=3</span> \</span>
<span id="cb365-15"><a href="#cb365-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">CMD</span> <span class="fu">wget</span> <span class="at">--quiet</span> <span class="at">--tries</span><span class="op">=</span>1 <span class="at">--spider</span> http://localhost/health <span class="kw">||</span> <span class="bu">exit</span> 1</span>
<span id="cb365-16"><a href="#cb365-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-17"><a href="#cb365-17" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;nginx&quot;</span>, <span class="st">&quot;-g&quot;</span>, <span class="st">&quot;daemon off;&quot;</span>]</span></code></pre></div>
<p><strong>nginx.conf:</strong></p>
<pre class="nginx"><code>server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  # Security headers
  add_header X-Frame-Options &quot;DENY&quot; always;
  add_header X-Content-Type-Options &quot;nosniff&quot; always;
  add_header X-XSS-Protection &quot;1; mode=block&quot; always;
  add_header Referrer-Policy &quot;strict-origin-when-cross-origin&quot; always;

  # Gzip compression
  gzip on;
  gzip_vary on;
  gzip_types text/css application/javascript application/json image/svg+xml;
  gzip_min_length 1024;

  # Cache static assets
  location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control &quot;public, immutable&quot;;
  }

  # No cache for HTML
  location ~* \.html$ {
    expires -1;
    add_header Cache-Control &quot;no-store, no-cache, must-revalidate, proxy-revalidate&quot;;
  }

  # SPA fallback
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Health check endpoint
  location /health {
    access_log off;
    return 200 &quot;healthy\n&quot;;
    add_header Content-Type text/plain;
  }
}</code></pre>
<p><strong>Build and run:</strong></p>
<div class="sourceCode" id="cb367"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build image</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> my-larc-app:latest .</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run locally</span></span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:80 my-larc-app:latest</span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Push to registry</span></span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag my-larc-app:latest registry.example.com/my-larc-app:latest</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push registry.example.com/my-larc-app:latest</span>
<span id="cb367-10"><a href="#cb367-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-11"><a href="#cb367-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy with docker-compose</span></span>
<span id="cb367-12"><a href="#cb367-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> docker-compose.yml <span class="op">&lt;&lt; EOF</span></span>
<span id="cb367-13"><a href="#cb367-13" aria-hidden="true" tabindex="-1"></a><span class="st">version: &#39;3.8&#39;</span></span>
<span id="cb367-14"><a href="#cb367-14" aria-hidden="true" tabindex="-1"></a><span class="st">services:</span></span>
<span id="cb367-15"><a href="#cb367-15" aria-hidden="true" tabindex="-1"></a><span class="st">  app:</span></span>
<span id="cb367-16"><a href="#cb367-16" aria-hidden="true" tabindex="-1"></a><span class="st">    image: my-larc-app:latest</span></span>
<span id="cb367-17"><a href="#cb367-17" aria-hidden="true" tabindex="-1"></a><span class="st">    ports:</span></span>
<span id="cb367-18"><a href="#cb367-18" aria-hidden="true" tabindex="-1"></a><span class="st">      - &quot;80:80&quot;</span></span>
<span id="cb367-19"><a href="#cb367-19" aria-hidden="true" tabindex="-1"></a><span class="st">    environment:</span></span>
<span id="cb367-20"><a href="#cb367-20" aria-hidden="true" tabindex="-1"></a><span class="st">      - NODE_ENV=production</span></span>
<span id="cb367-21"><a href="#cb367-21" aria-hidden="true" tabindex="-1"></a><span class="st">    restart: unless-stopped</span></span>
<span id="cb367-22"><a href="#cb367-22" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb367-23"><a href="#cb367-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-24"><a href="#cb367-24" aria-hidden="true" tabindex="-1"></a><span class="ex">docker-compose</span> up <span class="at">-d</span></span></code></pre></div>
<h2 data-number="16.11" id="security-headers"><span
class="header-section-number">16.11</span> Security Headers</h2>
<p>Protect your app with proper HTTP headers:</p>
<div class="sourceCode" id="cb368"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="co">// For Netlify (_headers file)</span></span>
<span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a><span class="co">  X-Frame-Options: DENY</span></span>
<span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a><span class="co">  X-Content-Type-Options: nosniff</span></span>
<span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a><span class="co">  X-XSS-Protection: 1; mode=block</span></span>
<span id="cb368-6"><a href="#cb368-6" aria-hidden="true" tabindex="-1"></a><span class="co">  Referrer-Policy: strict-origin-when-cross-origin</span></span>
<span id="cb368-7"><a href="#cb368-7" aria-hidden="true" tabindex="-1"></a><span class="co">  Permissions-Policy: geolocation=(), microphone=(), camera=()</span></span>
<span id="cb368-8"><a href="#cb368-8" aria-hidden="true" tabindex="-1"></a><span class="co">  Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39; https://cdn.jsdelivr.net; style-src &#39;self&#39; &#39;unsafe-inline&#39;; img-src &#39;self&#39; data: https:; font-src &#39;self&#39; data:; connect-src &#39;self&#39; https://api.example.com</span></span>
<span id="cb368-9"><a href="#cb368-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb368-10"><a href="#cb368-10" aria-hidden="true" tabindex="-1"></a><span class="co">/*.js</span></span>
<span id="cb368-11"><a href="#cb368-11" aria-hidden="true" tabindex="-1"></a><span class="co">  Cache-Control: public, max-age=31536000, immutable</span></span>
<span id="cb368-12"><a href="#cb368-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb368-13"><a href="#cb368-13" aria-hidden="true" tabindex="-1"></a><span class="co">/*.css</span></span>
<span id="cb368-14"><a href="#cb368-14" aria-hidden="true" tabindex="-1"></a><span class="co">  Cache-Control: public, max-age=31536000, immutable</span></span>
<span id="cb368-15"><a href="#cb368-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb368-16"><a href="#cb368-16" aria-hidden="true" tabindex="-1"></a><span class="co">/index.html</span></span>
<span id="cb368-17"><a href="#cb368-17" aria-hidden="true" tabindex="-1"></a><span class="co">  Cache-Control: public, max-age=0, must-revalidate</span></span></code></pre></div>
<p>Test security headers:</p>
<div class="sourceCode" id="cb369"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-I</span> https://your-site.com <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-E</span> <span class="st">&quot;X-Frame-Options|X-Content-Type&quot;</span></span></code></pre></div>
<p>Or use online tools:</p>
<ul>
<li>https://securityheaders.com</li>
<li>https://observatory.mozilla.org</li>
</ul>
<h2 data-number="16.12"
id="performance-optimization-for-production"><span
class="header-section-number">16.12</span> Performance Optimization for
Production</h2>
<p><strong>1. Enable compression:</strong></p>
<pre class="nginx"><code># Nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript
           application/x-javascript application/xml+rss
           application/javascript application/json image/svg+xml;</code></pre>
<p><strong>2. Set cache headers:</strong></p>
<div class="sourceCode" id="cb371"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="co">// For Cloudflare Workers</span></span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">fetch</span>(request) {</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(request<span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(request)<span class="op">;</span></span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clone response so we can modify headers</span></span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> newResponse <span class="op">=</span> <span class="kw">new</span> <span class="fu">Response</span>(response<span class="op">.</span><span class="at">body</span><span class="op">,</span> response)<span class="op">;</span></span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-10"><a href="#cb371-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (url<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">match</span>(<span class="ss">/</span><span class="sc">\.(</span><span class="ss">js</span><span class="sc">|</span><span class="ss">css</span><span class="sc">|</span><span class="ss">png</span><span class="sc">|</span><span class="ss">jpg</span><span class="sc">|</span><span class="ss">jpeg</span><span class="sc">|</span><span class="ss">svg</span><span class="sc">|</span><span class="ss">woff2</span><span class="sc">?)$</span><span class="ss">/</span>)) {</span>
<span id="cb371-11"><a href="#cb371-11" aria-hidden="true" tabindex="-1"></a>      newResponse<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;Cache-Control&#39;</span><span class="op">,</span> <span class="st">&#39;public, max-age=31536000, immutable&#39;</span>)<span class="op">;</span></span>
<span id="cb371-12"><a href="#cb371-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (url<span class="op">.</span><span class="at">pathname</span><span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.html&#39;</span>)) {</span>
<span id="cb371-13"><a href="#cb371-13" aria-hidden="true" tabindex="-1"></a>      newResponse<span class="op">.</span><span class="at">headers</span><span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;Cache-Control&#39;</span><span class="op">,</span> <span class="st">&#39;public, max-age=0, must-revalidate&#39;</span>)<span class="op">;</span></span>
<span id="cb371-14"><a href="#cb371-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb371-15"><a href="#cb371-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-16"><a href="#cb371-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> newResponse<span class="op">;</span></span>
<span id="cb371-17"><a href="#cb371-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb371-18"><a href="#cb371-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>3. Preload critical resources:</strong></p>
<div class="sourceCode" id="cb372"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Preload critical resources --&gt;</span></span>
<span id="cb372-5"><a href="#cb372-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;preload&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;/app.js&quot;</span><span class="ot"> as</span><span class="op">=</span><span class="st">&quot;script&quot;</span><span class="dt">&gt;</span></span>
<span id="cb372-6"><a href="#cb372-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;preload&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;/styles/main.css&quot;</span><span class="ot"> as</span><span class="op">=</span><span class="st">&quot;style&quot;</span><span class="dt">&gt;</span></span>
<span id="cb372-7"><a href="#cb372-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-8"><a href="#cb372-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Preconnect to external domains --&gt;</span></span>
<span id="cb372-9"><a href="#cb372-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;preconnect&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;https://api.example.com&quot;</span><span class="dt">&gt;</span></span>
<span id="cb372-10"><a href="#cb372-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;preconnect&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;https://cdn.jsdelivr.net&quot;</span><span class="dt">&gt;</span></span>
<span id="cb372-11"><a href="#cb372-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-12"><a href="#cb372-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- DNS prefetch for third-party domains --&gt;</span></span>
<span id="cb372-13"><a href="#cb372-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;dns-prefetch&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;https://analytics.example.com&quot;</span><span class="dt">&gt;</span></span>
<span id="cb372-14"><a href="#cb372-14" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb372-15"><a href="#cb372-15" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="16.13" id="rollback-strategies"><span
class="header-section-number">16.13</span> Rollback Strategies</h2>
<p>Prepare for when deployments go wrong:</p>
<p><strong>1. Keep previous versions:</strong></p>
<div class="sourceCode" id="cb373"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With Netlify CLI</span></span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> deploy <span class="at">--prod</span>  <span class="co"># Deploys new version</span></span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rollback to previous deploy</span></span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a><span class="ex">netlify</span> rollback</span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Or via UI: Deploys tab → Click on previous deploy → &quot;Publish deploy&quot;</span></span></code></pre></div>
<p><strong>2. Blue-green deployment:</strong></p>
<div class="sourceCode" id="cb374"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to staging (green), then swap with production (blue)</span></span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Blue-Green Deployment</span></span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb374-6"><a href="#cb374-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-7"><a href="#cb374-7" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb374-8"><a href="#cb374-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">deploy-green</span><span class="kw">:</span></span>
<span id="cb374-9"><a href="#cb374-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb374-10"><a href="#cb374-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb374-11"><a href="#cb374-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to green environment</span></span>
<span id="cb374-12"><a href="#cb374-12" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb374-13"><a href="#cb374-13" aria-hidden="true" tabindex="-1"></a>          netlify deploy --site=${{ secrets.GREEN_SITE_ID }} --prod</span>
<span id="cb374-14"><a href="#cb374-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-15"><a href="#cb374-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run smoke tests</span></span>
<span id="cb374-16"><a href="#cb374-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm run test:smoke -- --url=https://green.example.com</span></span>
<span id="cb374-17"><a href="#cb374-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-18"><a href="#cb374-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Swap blue and green</span></span>
<span id="cb374-19"><a href="#cb374-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">if</span><span class="kw">:</span><span class="at"> success()</span></span>
<span id="cb374-20"><a href="#cb374-20" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb374-21"><a href="#cb374-21" aria-hidden="true" tabindex="-1"></a>          # Update DNS or load balancer to point to green</span>
<span id="cb374-22"><a href="#cb374-22" aria-hidden="true" tabindex="-1"></a>          # This is provider-specific</span>
<span id="cb374-23"><a href="#cb374-23" aria-hidden="true" tabindex="-1"></a>          echo &quot;Swapping environments...&quot;</span></code></pre></div>
<p><strong>3. Feature flags for gradual rollout:</strong></p>
<div class="sourceCode" id="cb375"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="co">// feature-flags.js</span></span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeatureFlags {</span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">flags</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb375-5"><a href="#cb375-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">loadFlags</span>()<span class="op">;</span></span>
<span id="cb375-6"><a href="#cb375-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb375-7"><a href="#cb375-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-8"><a href="#cb375-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">loadFlags</span>() {</span>
<span id="cb375-9"><a href="#cb375-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb375-10"><a href="#cb375-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/api/feature-flags&#39;</span>)<span class="op">;</span></span>
<span id="cb375-11"><a href="#cb375-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">flags</span> <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb375-12"><a href="#cb375-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb375-13"><a href="#cb375-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load feature flags:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb375-14"><a href="#cb375-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb375-15"><a href="#cb375-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb375-16"><a href="#cb375-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-17"><a href="#cb375-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isEnabled</span>(feature<span class="op">,</span> userId <span class="op">=</span> <span class="kw">null</span>) {</span>
<span id="cb375-18"><a href="#cb375-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> flag <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">flags</span>[feature]<span class="op">;</span></span>
<span id="cb375-19"><a href="#cb375-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>flag) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb375-20"><a href="#cb375-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-21"><a href="#cb375-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Global enable/disable</span></span>
<span id="cb375-22"><a href="#cb375-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (flag<span class="op">.</span><span class="at">enabled</span> <span class="op">===</span> <span class="kw">false</span>) <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb375-23"><a href="#cb375-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-24"><a href="#cb375-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Percentage rollout</span></span>
<span id="cb375-25"><a href="#cb375-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (flag<span class="op">.</span><span class="at">percentage</span> <span class="op">&amp;&amp;</span> userId) {</span>
<span id="cb375-26"><a href="#cb375-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> hash <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hashUserId</span>(userId)<span class="op">;</span></span>
<span id="cb375-27"><a href="#cb375-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> (hash <span class="op">%</span> <span class="dv">100</span>) <span class="op">&lt;</span> flag<span class="op">.</span><span class="at">percentage</span><span class="op">;</span></span>
<span id="cb375-28"><a href="#cb375-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb375-29"><a href="#cb375-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-30"><a href="#cb375-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Whitelist</span></span>
<span id="cb375-31"><a href="#cb375-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (flag<span class="op">.</span><span class="at">whitelist</span> <span class="op">&amp;&amp;</span> userId) {</span>
<span id="cb375-32"><a href="#cb375-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> flag<span class="op">.</span><span class="at">whitelist</span><span class="op">.</span><span class="fu">includes</span>(userId)<span class="op">;</span></span>
<span id="cb375-33"><a href="#cb375-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb375-34"><a href="#cb375-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-35"><a href="#cb375-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> flag<span class="op">.</span><span class="at">enabled</span><span class="op">;</span></span>
<span id="cb375-36"><a href="#cb375-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb375-37"><a href="#cb375-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-38"><a href="#cb375-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hashUserId</span>(userId) {</span>
<span id="cb375-39"><a href="#cb375-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple hash for percentage rollout</span></span>
<span id="cb375-40"><a href="#cb375-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> hash <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb375-41"><a href="#cb375-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> userId<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb375-42"><a href="#cb375-42" aria-hidden="true" tabindex="-1"></a>      hash <span class="op">=</span> ((hash <span class="op">&lt;&lt;</span> <span class="dv">5</span>) <span class="op">-</span> hash) <span class="op">+</span> userId<span class="op">.</span><span class="fu">charCodeAt</span>(i)<span class="op">;</span></span>
<span id="cb375-43"><a href="#cb375-43" aria-hidden="true" tabindex="-1"></a>      hash <span class="op">=</span> hash <span class="op">&amp;</span> hash<span class="op">;</span></span>
<span id="cb375-44"><a href="#cb375-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb375-45"><a href="#cb375-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">abs</span>(hash)<span class="op">;</span></span>
<span id="cb375-46"><a href="#cb375-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb375-47"><a href="#cb375-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb375-48"><a href="#cb375-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-49"><a href="#cb375-49" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> featureFlags <span class="op">=</span> <span class="kw">new</span> <span class="fu">FeatureFlags</span>()<span class="op">;</span></span>
<span id="cb375-50"><a href="#cb375-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-51"><a href="#cb375-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb375-52"><a href="#cb375-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (featureFlags<span class="op">.</span><span class="fu">isEnabled</span>(<span class="st">&#39;new-dashboard&#39;</span><span class="op">,</span> user<span class="op">.</span><span class="at">id</span>)) {</span>
<span id="cb375-53"><a href="#cb375-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./components/new-dashboard.js&#39;</span>)<span class="op">;</span></span>
<span id="cb375-54"><a href="#cb375-54" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb375-55"><a href="#cb375-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./components/old-dashboard.js&#39;</span>)<span class="op">;</span></span>
<span id="cb375-56"><a href="#cb375-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="16.14" id="complete-deployment-example"><span
class="header-section-number">16.14</span> Complete Deployment
Example</h2>
<p>Let’s deploy a complete app with monitoring and error tracking:</p>
<p><strong>1. Project structure:</strong></p>
<pre><code>my-app/
├── public/
│   ├── index.html
│   ├── app.js
│   ├── config.js
│   └── components/
├── scripts/
│   └── deploy.sh
├── .github/workflows/
│   └── deploy.yml
├── netlify.toml
└── package.json</code></pre>
<p><strong>2. Environment-aware config:</strong></p>
<div class="sourceCode" id="cb377"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="co">// public/config.js</span></span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> environments <span class="op">=</span> {</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">local</span><span class="op">:</span> {</span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;http://localhost:3000&#39;</span><span class="op">,</span></span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sentryDsn</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">analytics</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">staging</span><span class="op">:</span> {</span>
<span id="cb377-9"><a href="#cb377-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;https://staging-api.example.com&#39;</span><span class="op">,</span></span>
<span id="cb377-10"><a href="#cb377-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sentryDsn</span><span class="op">:</span> <span class="st">&#39;https://...@sentry.io/staging&#39;</span><span class="op">,</span></span>
<span id="cb377-11"><a href="#cb377-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">analytics</span><span class="op">:</span> <span class="st">&#39;UA-STAGING&#39;</span></span>
<span id="cb377-12"><a href="#cb377-12" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb377-13"><a href="#cb377-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">production</span><span class="op">:</span> {</span>
<span id="cb377-14"><a href="#cb377-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;https://api.example.com&#39;</span><span class="op">,</span></span>
<span id="cb377-15"><a href="#cb377-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sentryDsn</span><span class="op">:</span> <span class="st">&#39;https://...@sentry.io/prod&#39;</span><span class="op">,</span></span>
<span id="cb377-16"><a href="#cb377-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">analytics</span><span class="op">:</span> <span class="st">&#39;UA-PROD&#39;</span></span>
<span id="cb377-17"><a href="#cb377-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb377-18"><a href="#cb377-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb377-19"><a href="#cb377-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-20"><a href="#cb377-20" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">detectEnvironment</span>() {</span>
<span id="cb377-21"><a href="#cb377-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> hostname <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span><span class="op">.</span><span class="at">hostname</span><span class="op">;</span></span>
<span id="cb377-22"><a href="#cb377-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hostname <span class="op">===</span> <span class="st">&#39;localhost&#39;</span> <span class="op">||</span> hostname <span class="op">===</span> <span class="st">&#39;127.0.0.1&#39;</span>) {</span>
<span id="cb377-23"><a href="#cb377-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;local&#39;</span><span class="op">;</span></span>
<span id="cb377-24"><a href="#cb377-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb377-25"><a href="#cb377-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hostname<span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;staging&#39;</span>)) {</span>
<span id="cb377-26"><a href="#cb377-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;staging&#39;</span><span class="op">;</span></span>
<span id="cb377-27"><a href="#cb377-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb377-28"><a href="#cb377-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></span>
<span id="cb377-29"><a href="#cb377-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb377-30"><a href="#cb377-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-31"><a href="#cb377-31" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> config <span class="op">=</span> environments[<span class="fu">detectEnvironment</span>()]<span class="op">;</span></span></code></pre></div>
<p><strong>3. Error tracking setup:</strong></p>
<div class="sourceCode" id="cb378"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="co">// public/monitoring.js</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { config } <span class="im">from</span> <span class="st">&#39;./config.js&#39;</span><span class="op">;</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ErrorTracker {</span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb378-6"><a href="#cb378-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="op">.</span><span class="at">sentryDsn</span>) {</span>
<span id="cb378-7"><a href="#cb378-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">initSentry</span>()<span class="op">;</span></span>
<span id="cb378-8"><a href="#cb378-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb378-9"><a href="#cb378-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupErrorHandlers</span>()<span class="op">;</span></span>
<span id="cb378-10"><a href="#cb378-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb378-11"><a href="#cb378-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-12"><a href="#cb378-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">initSentry</span>() {</span>
<span id="cb378-13"><a href="#cb378-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> Sentry <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;https://cdn.jsdelivr.net/npm/@sentry/browser@7/+esm&#39;</span>)<span class="op">;</span></span>
<span id="cb378-14"><a href="#cb378-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-15"><a href="#cb378-15" aria-hidden="true" tabindex="-1"></a>    Sentry<span class="op">.</span><span class="fu">init</span>({</span>
<span id="cb378-16"><a href="#cb378-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">dsn</span><span class="op">:</span> config<span class="op">.</span><span class="at">sentryDsn</span><span class="op">,</span></span>
<span id="cb378-17"><a href="#cb378-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">environment</span><span class="op">:</span> config<span class="op">.</span><span class="at">environment</span><span class="op">,</span></span>
<span id="cb378-18"><a href="#cb378-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">beforeSend</span>(<span class="bu">event</span>) {</span>
<span id="cb378-19"><a href="#cb378-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Filter out noise</span></span>
<span id="cb378-20"><a href="#cb378-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="bu">event</span><span class="op">.</span><span class="at">message</span><span class="op">?.</span><span class="fu">includes</span>(<span class="st">&#39;ResizeObserver&#39;</span>)) {</span>
<span id="cb378-21"><a href="#cb378-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb378-22"><a href="#cb378-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb378-23"><a href="#cb378-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">event</span><span class="op">;</span></span>
<span id="cb378-24"><a href="#cb378-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb378-25"><a href="#cb378-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb378-26"><a href="#cb378-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb378-27"><a href="#cb378-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-28"><a href="#cb378-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupErrorHandlers</span>() {</span>
<span id="cb378-29"><a href="#cb378-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb378-30"><a href="#cb378-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">captureError</span>(<span class="bu">event</span><span class="op">.</span><span class="at">error</span><span class="op">,</span> {</span>
<span id="cb378-31"><a href="#cb378-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">filename</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">filename</span><span class="op">,</span></span>
<span id="cb378-32"><a href="#cb378-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">lineno</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">lineno</span><span class="op">,</span></span>
<span id="cb378-33"><a href="#cb378-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">colno</span><span class="op">:</span> <span class="bu">event</span><span class="op">.</span><span class="at">colno</span></span>
<span id="cb378-34"><a href="#cb378-34" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb378-35"><a href="#cb378-35" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb378-36"><a href="#cb378-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-37"><a href="#cb378-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;unhandledrejection&#39;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb378-38"><a href="#cb378-38" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">captureError</span>(<span class="bu">event</span><span class="op">.</span><span class="at">reason</span><span class="op">,</span> {</span>
<span id="cb378-39"><a href="#cb378-39" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;unhandledrejection&#39;</span></span>
<span id="cb378-40"><a href="#cb378-40" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb378-41"><a href="#cb378-41" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb378-42"><a href="#cb378-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb378-43"><a href="#cb378-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-44"><a href="#cb378-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">captureError</span>(error<span class="op">,</span> context <span class="op">=</span> {}) {</span>
<span id="cb378-45"><a href="#cb378-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Error captured:&#39;</span><span class="op">,</span> error<span class="op">,</span> context)<span class="op">;</span></span>
<span id="cb378-46"><a href="#cb378-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-47"><a href="#cb378-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send to your error tracking service</span></span>
<span id="cb378-48"><a href="#cb378-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="op">.</span><span class="at">sentryDsn</span> <span class="op">&amp;&amp;</span> <span class="bu">window</span><span class="op">.</span><span class="at">Sentry</span>) {</span>
<span id="cb378-49"><a href="#cb378-49" aria-hidden="true" tabindex="-1"></a>      <span class="bu">window</span><span class="op">.</span><span class="at">Sentry</span><span class="op">.</span><span class="fu">captureException</span>(error<span class="op">,</span> { <span class="dt">extra</span><span class="op">:</span> context })<span class="op">;</span></span>
<span id="cb378-50"><a href="#cb378-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb378-51"><a href="#cb378-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb378-52"><a href="#cb378-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb378-53"><a href="#cb378-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-54"><a href="#cb378-54" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> errorTracker <span class="op">=</span> <span class="kw">new</span> <span class="fu">ErrorTracker</span>()<span class="op">;</span></span></code></pre></div>
<p><strong>4. Deployment script:</strong></p>
<div class="sourceCode" id="cb379"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a><span class="co"># scripts/deploy.sh</span></span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-6"><a href="#cb379-6" aria-hidden="true" tabindex="-1"></a><span class="va">ENV</span><span class="op">=</span><span class="va">${1</span><span class="op">:-</span>staging<span class="va">}</span></span>
<span id="cb379-7"><a href="#cb379-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-8"><a href="#cb379-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;🚀 Deploying to </span><span class="va">$ENV</span><span class="st">...&quot;</span></span>
<span id="cb379-9"><a href="#cb379-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-10"><a href="#cb379-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb379-11"><a href="#cb379-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;🧪 Running tests...&quot;</span></span>
<span id="cb379-12"><a href="#cb379-12" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> test</span>
<span id="cb379-13"><a href="#cb379-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-14"><a href="#cb379-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for uncommitted changes</span></span>
<span id="cb379-15"><a href="#cb379-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">[[</span> <span class="ot">-n</span> <span class="va">$(</span><span class="fu">git</span> status <span class="at">-s</span><span class="va">)</span> <span class="kw">]];</span> <span class="cf">then</span></span>
<span id="cb379-16"><a href="#cb379-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;❌ Uncommitted changes detected. Commit or stash them first.&quot;</span></span>
<span id="cb379-17"><a href="#cb379-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb379-18"><a href="#cb379-18" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb379-19"><a href="#cb379-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-20"><a href="#cb379-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get current version</span></span>
<span id="cb379-21"><a href="#cb379-21" aria-hidden="true" tabindex="-1"></a><span class="va">VERSION</span><span class="op">=</span><span class="va">$(</span><span class="fu">git</span> rev-parse <span class="at">--short</span> HEAD<span class="va">)</span></span>
<span id="cb379-22"><a href="#cb379-22" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;📦 Version: </span><span class="va">$VERSION</span><span class="st">&quot;</span></span>
<span id="cb379-23"><a href="#cb379-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-24"><a href="#cb379-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create build info</span></span>
<span id="cb379-25"><a href="#cb379-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> public/build-info.json <span class="op">&lt;&lt; EOF</span></span>
<span id="cb379-26"><a href="#cb379-26" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb379-27"><a href="#cb379-27" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;version&quot;: &quot;</span><span class="va">$VERSION</span><span class="st">&quot;,</span></span>
<span id="cb379-28"><a href="#cb379-28" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;environment&quot;: &quot;</span><span class="va">$ENV</span><span class="st">&quot;,</span></span>
<span id="cb379-29"><a href="#cb379-29" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;buildDate&quot;: &quot;</span><span class="va">$(</span><span class="fu">date</span> <span class="at">-u</span> +<span class="st">&quot;%Y-%m-%dT%H:%M:%SZ&quot;</span><span class="va">)</span><span class="st">&quot;,</span></span>
<span id="cb379-30"><a href="#cb379-30" aria-hidden="true" tabindex="-1"></a><span class="st">  &quot;branch&quot;: &quot;</span><span class="va">$(</span><span class="fu">git</span> rev-parse <span class="at">--abbrev-ref</span> HEAD<span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb379-31"><a href="#cb379-31" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb379-32"><a href="#cb379-32" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb379-33"><a href="#cb379-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-34"><a href="#cb379-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy based on environment</span></span>
<span id="cb379-35"><a href="#cb379-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$ENV</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;production&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb379-36"><a href="#cb379-36" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;🌍 Deploying to production...&quot;</span></span>
<span id="cb379-37"><a href="#cb379-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">netlify</span> deploy <span class="at">--prod</span> <span class="at">--site</span><span class="op">=</span><span class="va">$NETLIFY_PROD_SITE_ID</span></span>
<span id="cb379-38"><a href="#cb379-38" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$ENV</span><span class="st">&quot;</span> <span class="ot">=</span> <span class="st">&quot;staging&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb379-39"><a href="#cb379-39" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;🔧 Deploying to staging...&quot;</span></span>
<span id="cb379-40"><a href="#cb379-40" aria-hidden="true" tabindex="-1"></a>  <span class="ex">netlify</span> deploy <span class="at">--prod</span> <span class="at">--site</span><span class="op">=</span><span class="va">$NETLIFY_STAGING_SITE_ID</span></span>
<span id="cb379-41"><a href="#cb379-41" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb379-42"><a href="#cb379-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-43"><a href="#cb379-43" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;✅ Deployment complete!&quot;</span></span>
<span id="cb379-44"><a href="#cb379-44" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;🔗 Check deployment: https://</span><span class="va">$ENV</span><span class="st">.example.com&quot;</span></span></code></pre></div>
<h2 data-number="16.15" id="troubleshooting-deployment-issues"><span
class="header-section-number">16.15</span> Troubleshooting Deployment
Issues</h2>
<h3 data-number="16.15.1"
id="problem-1-404-on-refresh-spa-routing"><span
class="header-section-number">16.15.1</span> Problem 1: 404 on Refresh
(SPA Routing)</h3>
<p><strong>Symptoms</strong>: Navigating directly to <code>/about</code>
returns 404, but clicking links works.</p>
<p><strong>Cause</strong>: Server doesn’t know about client-side
routes.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb380"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="co"># netlify.toml</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[[redirects]]</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">from</span> <span class="op">=</span> <span class="st">&quot;/*&quot;</span></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">to</span> <span class="op">=</span> <span class="st">&quot;/index.html&quot;</span></span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">status</span> <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a><span class="co"># vercel.json</span></span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a><span class="er">{</span></span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;rewrites&quot;</span><span class="er">:</span> <span class="kw">[</span></span>
<span id="cb380-10"><a href="#cb380-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">{</span> <span class="dt">&quot;source&quot;</span><span class="er">:</span> <span class="dt">&quot;/(.*)&quot;</span><span class="er">,</span> <span class="dt">&quot;destination&quot;</span><span class="er">:</span> <span class="dt">&quot;/index.html&quot;</span> <span class="er">}</span></span>
<span id="cb380-11"><a href="#cb380-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">]</span></span>
<span id="cb380-12"><a href="#cb380-12" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb380-13"><a href="#cb380-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-14"><a href="#cb380-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Apache .htaccess</span></span>
<span id="cb380-15"><a href="#cb380-15" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;</span><span class="dt">IfModule</span> <span class="dt">mod_rewrite.c</span><span class="er">&gt;</span></span>
<span id="cb380-16"><a href="#cb380-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteEngine</span> <span class="dt">On</span></span>
<span id="cb380-17"><a href="#cb380-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteBase</span> <span class="er">/</span></span>
<span id="cb380-18"><a href="#cb380-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteRule</span> <span class="er">^</span><span class="dt">index</span><span class="er">\</span><span class="dt">.html</span><span class="er">$</span> <span class="dt">-</span> <span class="kw">[L]</span></span>
<span id="cb380-19"><a href="#cb380-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteCond</span> <span class="er">%{</span><span class="dt">REQUEST_FILENAME</span><span class="er">}</span> <span class="er">!</span><span class="dt">-f</span></span>
<span id="cb380-20"><a href="#cb380-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteCond</span> <span class="er">%{</span><span class="dt">REQUEST_FILENAME</span><span class="er">}</span> <span class="er">!</span><span class="dt">-d</span></span>
<span id="cb380-21"><a href="#cb380-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">RewriteRule</span> <span class="dt">.</span> <span class="er">/</span><span class="dt">index.html</span> <span class="kw">[L]</span></span>
<span id="cb380-22"><a href="#cb380-22" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;/</span><span class="dt">IfModule</span><span class="er">&gt;</span></span></code></pre></div>
<h3 data-number="16.15.2" id="problem-2-cors-errors-in-production"><span
class="header-section-number">16.15.2</span> Problem 2: CORS Errors in
Production</h3>
<p><strong>Symptoms</strong>: API calls work locally but fail in
production with CORS errors.</p>
<p><strong>Cause</strong>: API server not configured to allow your
production domain.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb381"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Backend CORS configuration</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>({</span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> [</span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;https://example.com&#39;</span><span class="op">,</span></span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;https://www.example.com&#39;</span><span class="op">,</span></span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;https://staging.example.com&#39;</span></span>
<span id="cb381-7"><a href="#cb381-7" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb381-8"><a href="#cb381-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">credentials</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb381-9"><a href="#cb381-9" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb381-10"><a href="#cb381-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-11"><a href="#cb381-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Or use environment variable</span></span>
<span id="cb381-12"><a href="#cb381-12" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>({</span>
<span id="cb381-13"><a href="#cb381-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">origin</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">ALLOWED_ORIGINS</span><span class="op">?.</span><span class="fu">split</span>(<span class="st">&#39;,&#39;</span>)<span class="op">,</span></span>
<span id="cb381-14"><a href="#cb381-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">credentials</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb381-15"><a href="#cb381-15" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span></code></pre></div>
<p><strong>Alternative</strong>: Use a proxy in your deployment
config:</p>
<div class="sourceCode" id="cb382"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="co"># netlify.toml</span></span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[[redirects]]</span></span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">from</span> <span class="op">=</span> <span class="st">&quot;/api/*&quot;</span></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">to</span> <span class="op">=</span> <span class="st">&quot;https://api.example.com/:splat&quot;</span></span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">status</span> <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb382-6"><a href="#cb382-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">force</span> <span class="op">=</span> <span class="cn">true</span></span></code></pre></div>
<h3 data-number="16.15.3"
id="problem-3-environment-variables-not-working"><span
class="header-section-number">16.15.3</span> Problem 3: Environment
Variables Not Working</h3>
<p><strong>Symptoms</strong>: App can’t read environment variables,
falls back to defaults.</p>
<p><strong>Cause</strong>: Build-time vs. runtime configuration
confusion.</p>
<p><strong>Solution</strong>:</p>
<p>For runtime configuration, inject variables into HTML:</p>
<div class="sourceCode" id="cb383"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Injected by build process or server --&gt;</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">ENV</span> <span class="op">=</span> {</span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">API_URL</span><span class="op">:</span> <span class="st">&quot;%%API_URL%%&quot;</span><span class="op">,</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">SENTRY_DSN</span><span class="op">:</span> <span class="st">&quot;%%SENTRY_DSN%%&quot;</span></span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb383-7"><a href="#cb383-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>Or load from a config endpoint:</p>
<div class="sourceCode" id="cb384"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">loadConfig</span>() {</span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">&#39;/config.json&#39;</span>)<span class="op">;</span></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb384-6"><a href="#cb384-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Failed to load config:&#39;</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb384-7"><a href="#cb384-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb384-8"><a href="#cb384-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">apiUrl</span><span class="op">:</span> <span class="st">&#39;http://localhost:3000&#39;</span><span class="op">,</span></span>
<span id="cb384-9"><a href="#cb384-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// fallback values</span></span>
<span id="cb384-10"><a href="#cb384-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb384-11"><a href="#cb384-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb384-12"><a href="#cb384-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb384-13"><a href="#cb384-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-14"><a href="#cb384-14" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> config <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadConfig</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="16.15.4" id="problem-4-slow-initial-load"><span
class="header-section-number">16.15.4</span> Problem 4: Slow Initial
Load</h3>
<p><strong>Symptoms</strong>: First visit takes several seconds to show
content.</p>
<p><strong>Diagnosis</strong>:</p>
<div class="sourceCode" id="cb385"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add timing to index.html</span></span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>script<span class="op">&gt;</span></span>
<span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="at">perfMetrics</span> <span class="op">=</span> {</span>
<span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">navigationStart</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">navigationStart</span><span class="op">,</span></span>
<span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fetchStart</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">fetchStart</span><span class="op">,</span></span>
<span id="cb385-6"><a href="#cb385-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domainLookupEnd</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">domainLookupEnd</span><span class="op">,</span></span>
<span id="cb385-7"><a href="#cb385-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">connectEnd</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">connectEnd</span><span class="op">,</span></span>
<span id="cb385-8"><a href="#cb385-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">responseEnd</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">responseEnd</span><span class="op">,</span></span>
<span id="cb385-9"><a href="#cb385-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">domContentLoadedEventEnd</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">domContentLoadedEventEnd</span><span class="op">,</span></span>
<span id="cb385-10"><a href="#cb385-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">loadEventEnd</span><span class="op">:</span> <span class="bu">performance</span><span class="op">.</span><span class="at">timing</span><span class="op">.</span><span class="at">loadEventEnd</span></span>
<span id="cb385-11"><a href="#cb385-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb385-12"><a href="#cb385-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-13"><a href="#cb385-13" aria-hidden="true" tabindex="-1"></a>  <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb385-14"><a href="#cb385-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> metrics <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">perfMetrics</span><span class="op">;</span></span>
<span id="cb385-15"><a href="#cb385-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;DNS lookup:&#39;</span><span class="op">,</span> metrics<span class="op">.</span><span class="at">domainLookupEnd</span> <span class="op">-</span> metrics<span class="op">.</span><span class="at">fetchStart</span>)<span class="op">;</span></span>
<span id="cb385-16"><a href="#cb385-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;TCP connection:&#39;</span><span class="op">,</span> metrics<span class="op">.</span><span class="at">connectEnd</span> <span class="op">-</span> metrics<span class="op">.</span><span class="at">domainLookupEnd</span>)<span class="op">;</span></span>
<span id="cb385-17"><a href="#cb385-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Response time:&#39;</span><span class="op">,</span> metrics<span class="op">.</span><span class="at">responseEnd</span> <span class="op">-</span> metrics<span class="op">.</span><span class="at">connectEnd</span>)<span class="op">;</span></span>
<span id="cb385-18"><a href="#cb385-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;DOM processing:&#39;</span><span class="op">,</span> metrics<span class="op">.</span><span class="at">domContentLoadedEventEnd</span> <span class="op">-</span> metrics<span class="op">.</span><span class="at">responseEnd</span>)<span class="op">;</span></span>
<span id="cb385-19"><a href="#cb385-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Total load time:&#39;</span><span class="op">,</span> metrics<span class="op">.</span><span class="at">loadEventEnd</span> <span class="op">-</span> metrics<span class="op">.</span><span class="at">navigationStart</span>)<span class="op">;</span></span>
<span id="cb385-20"><a href="#cb385-20" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb385-21"><a href="#cb385-21" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>script<span class="op">&gt;</span></span></code></pre></div>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Enable compression (gzip/brotli)</li>
<li>Use CDN for static assets</li>
<li>Preload critical resources</li>
<li>Lazy load non-critical components</li>
<li>Optimize images</li>
<li>Minify JavaScript and CSS</li>
</ul>
<h2 data-number="16.16" id="deployment-best-practices"><span
class="header-section-number">16.16</span> Deployment Best
Practices</h2>
<ol type="1">
<li><p><strong>Automate Everything</strong>: Use CI/CD pipelines for
consistent, reliable deployments.</p></li>
<li><p><strong>Test Before Deploying</strong>: Run linters, unit tests,
and E2E tests in your pipeline.</p></li>
<li><p><strong>Use Staging Environments</strong>: Test production builds
in a staging environment first.</p></li>
<li><p><strong>Monitor Deployments</strong>: Track errors, performance,
and user behavior after each deploy.</p></li>
<li><p><strong>Enable Rollbacks</strong>: Keep previous versions and be
ready to rollback quickly.</p></li>
<li><p><strong>Version Your Releases</strong>: Tag releases in Git and
track which version is deployed where.</p></li>
<li><p><strong>Secure Your Secrets</strong>: Never commit API keys or
secrets. Use environment variables or secret managers.</p></li>
<li><p><strong>Set Cache Headers Properly</strong>: Long cache for
assets (with versioned filenames), no cache for HTML.</p></li>
<li><p><strong>Use Health Checks</strong>: Implement
<code>/health</code> endpoints to verify deployments succeeded.</p></li>
<li><p><strong>Document Your Process</strong>: Maintain runbooks for
common deployment scenarios and troubleshooting.</p></li>
</ol>
<h2 data-number="16.17" id="hands-on-exercises-1"><span
class="header-section-number">16.17</span> Hands-On Exercises</h2>
<h3 data-number="16.17.1" id="exercise-1-deploy-to-netlify"><span
class="header-section-number">16.17.1</span> Exercise 1: Deploy to
Netlify</h3>
<p>Deploy your LARC app to Netlify:</p>
<ul>
<li>Set up a free Netlify account</li>
<li>Connect your Git repository</li>
<li>Configure build settings and environment variables</li>
<li>Set up a custom domain (or use Netlify subdomain)</li>
<li>Configure security headers</li>
</ul>
<p><strong>Bonus</strong>: Set up preview deployments for pull
requests.</p>
<h3 data-number="16.17.2" id="exercise-2-create-a-cicd-pipeline"><span
class="header-section-number">16.17.2</span> Exercise 2: Create a CI/CD
Pipeline</h3>
<p>Build a complete GitHub Actions workflow that:</p>
<ul>
<li>Runs tests on every push</li>
<li>Deploys to staging on merge to <code>develop</code></li>
<li>Deploys to production on merge to <code>main</code></li>
<li>Sends notifications on deployment success/failure</li>
</ul>
<p><strong>Bonus</strong>: Add automated performance testing with
Lighthouse CI.</p>
<h3 data-number="16.17.3" id="exercise-3-implement-feature-flags"><span
class="header-section-number">16.17.3</span> Exercise 3: Implement
Feature Flags</h3>
<p>Create a feature flag system that:</p>
<ul>
<li>Loads flags from a remote config</li>
<li>Supports percentage-based rollouts</li>
<li>Allows user whitelisting</li>
<li>Caches flags locally</li>
<li>Has a UI to toggle features</li>
</ul>
<p><strong>Bonus</strong>: Add A/B testing with analytics
integration.</p>
<h3 data-number="16.17.4" id="exercise-4-set-up-error-tracking"><span
class="header-section-number">16.17.4</span> Exercise 4: Set Up Error
Tracking</h3>
<p>Implement production error tracking:</p>
<ul>
<li>Integrate Sentry or similar service</li>
<li>Capture unhandled errors and promise rejections</li>
<li>Track custom errors with context</li>
<li>Filter out noise (ResizeObserver, etc.)</li>
<li>Set up alerts for critical errors</li>
</ul>
<p><strong>Bonus</strong>: Add user session replay for debugging.</p>
<h2 data-number="16.18" id="summary-15"><span
class="header-section-number">16.18</span> Summary</h2>
<p>Deploying LARC applications is straightforward—no build process means
fewer things to go wrong. Key takeaways:</p>
<ul>
<li><strong>Static hosting is simple</strong>: Use Netlify, Vercel,
GitHub Pages, or any static host</li>
<li><strong>Automate with CI/CD</strong>: Let GitHub Actions handle
testing and deployment</li>
<li><strong>Security matters</strong>: Set proper headers, use HTTPS,
configure CSP</li>
<li><strong>Monitor production</strong>: Track errors, performance, and
user experience</li>
<li><strong>Be ready to rollback</strong>: Keep previous versions and
have a rollback plan</li>
</ul>
<p>Start with simple deployments and add sophistication as needed. The
beauty of LARC’s no-build approach is that deployment remains simple
even as your app grows.</p>
<h2 data-number="16.19" id="further-reading-15"><span
class="header-section-number">16.19</span> Further Reading</h2>
<ul>
<li><strong>Building with LARC - Chapter 18 (Deployment)</strong>:
Advanced deployment patterns and strategies</li>
<li><strong>Building with LARC - Chapter 19 (Performance)</strong>:
Production optimization techniques</li>
<li><strong>Building with LARC - Chapter 11 (Best Practices)</strong>:
Security and reliability patterns</li>
</ul>
<div class="pagebreak">

</div>
<h1 data-number="17" id="component-library"><span
class="header-section-number">17</span> Component Library</h1>
<p>As your application grows, you’ll accumulate reusable components. A
well-organized component library accelerates development and ensures
consistency.</p>
<h2 data-number="17.1" id="organizing-components"><span
class="header-section-number">17.1</span> Organizing Components</h2>
<p>Structure your library logically:</p>
<pre><code>components/
├── core/
│   ├── pan-button.js
│   ├── pan-input.js
│   └── pan-card.js
├── layout/
│   ├── pan-header.js
│   ├── pan-sidebar.js
│   └── pan-grid.js
├── data/
│   ├── pan-table.js
│   ├── pan-list.js
│   └── pan-pagination.js
└── index.js</code></pre>
<p>Export from a single entry point:</p>
<div class="sourceCode" id="cb387"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/index.js</span></span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="op">*</span> <span class="im">from</span> <span class="st">&#39;./core/pan-button.js&#39;</span><span class="op">;</span></span>
<span id="cb387-3"><a href="#cb387-3" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="op">*</span> <span class="im">from</span> <span class="st">&#39;./core/pan-input.js&#39;</span><span class="op">;</span></span>
<span id="cb387-4"><a href="#cb387-4" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="op">*</span> <span class="im">from</span> <span class="st">&#39;./core/pan-card.js&#39;</span><span class="op">;</span></span>
<span id="cb387-5"><a href="#cb387-5" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="op">*</span> <span class="im">from</span> <span class="st">&#39;./layout/pan-header.js&#39;</span><span class="op">;</span></span>
<span id="cb387-6"><a href="#cb387-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>
<h2 data-number="17.2" id="documentation"><span
class="header-section-number">17.2</span> Documentation</h2>
<p>Document every component:</p>
<div class="sourceCode" id="cb388"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * A customizable button component.</span></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@element</span><span class="co"> pan-button</span></span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-6"><a href="#cb388-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {string} variant - Button style: &quot;primary&quot;, &quot;secondary&quot;, &quot;danger&quot;</span></span>
<span id="cb388-7"><a href="#cb388-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} disabled - Disables the button</span></span>
<span id="cb388-8"><a href="#cb388-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {string} size - Button size: &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;</span></span>
<span id="cb388-9"><a href="#cb388-9" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-10"><a href="#cb388-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@fires</span><span class="co"> click - Fired when button is clicked</span></span>
<span id="cb388-11"><a href="#cb388-11" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-12"><a href="#cb388-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> - Button content</span></span>
<span id="cb388-13"><a href="#cb388-13" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-14"><a href="#cb388-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@example</span></span>
<span id="cb388-15"><a href="#cb388-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="kw">&lt;pan-button</span><span class="ot"> variant=</span><span class="dt">&quot;primary&quot;</span><span class="kw">&gt;</span><span class="co">Click me</span><span class="kw">&lt;/pan-button&gt;</span></span>
<span id="cb388-16"><a href="#cb388-16" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb388-17"><a href="#cb388-17" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@example</span></span>
<span id="cb388-18"><a href="#cb388-18" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="kw">&lt;pan-button</span><span class="ot"> variant=</span><span class="dt">&quot;danger&quot;</span><span class="ot"> disabled</span><span class="kw">&gt;</span><span class="co">Delete</span><span class="kw">&lt;/pan-button&gt;</span></span>
<span id="cb388-19"><a href="#cb388-19" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb388-20"><a href="#cb388-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb388-21"><a href="#cb388-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb388-22"><a href="#cb388-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Generate documentation automatically with tools like
<code>web-component-analyzer</code>:</p>
<div class="sourceCode" id="cb389"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npx</span> web-component-analyzer analyze components/<span class="pp">**</span>/<span class="pp">*</span>.js <span class="at">--outFile</span> docs.json</span></code></pre></div>
<h2 data-number="17.3" id="design-tokens"><span
class="header-section-number">17.3</span> Design Tokens</h2>
<p>Use CSS custom properties for theming:</p>
<div class="sourceCode" id="cb390"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* tokens.css */</span></span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Colors */</span></span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-primary</span><span class="ch">:</span> <span class="cn">#0066cc</span><span class="op">;</span></span>
<span id="cb390-5"><a href="#cb390-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-secondary</span><span class="ch">:</span> <span class="cn">#6c757d</span><span class="op">;</span></span>
<span id="cb390-6"><a href="#cb390-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-success</span><span class="ch">:</span> <span class="cn">#28a745</span><span class="op">;</span></span>
<span id="cb390-7"><a href="#cb390-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">--color-danger</span><span class="ch">:</span> <span class="cn">#dc3545</span><span class="op">;</span></span>
<span id="cb390-8"><a href="#cb390-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb390-9"><a href="#cb390-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Spacing */</span></span>
<span id="cb390-10"><a href="#cb390-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-xs</span><span class="ch">:</span> <span class="dv">4</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-11"><a href="#cb390-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-sm</span><span class="ch">:</span> <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-12"><a href="#cb390-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-md</span><span class="ch">:</span> <span class="dv">16</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-13"><a href="#cb390-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-lg</span><span class="ch">:</span> <span class="dv">24</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-14"><a href="#cb390-14" aria-hidden="true" tabindex="-1"></a>  <span class="va">--space-xl</span><span class="ch">:</span> <span class="dv">32</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-15"><a href="#cb390-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb390-16"><a href="#cb390-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Typography */</span></span>
<span id="cb390-17"><a href="#cb390-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-family</span><span class="ch">:</span> <span class="dv">-apple-system</span><span class="op">,</span> <span class="dv">BlinkMacSystemFont</span><span class="op">,</span> <span class="st">&#39;Segoe UI&#39;</span><span class="op">,</span> <span class="dv">Roboto</span><span class="op">,</span> <span class="dv">sans-serif</span><span class="op">;</span></span>
<span id="cb390-18"><a href="#cb390-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-size-sm</span><span class="ch">:</span> <span class="dv">0.875</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb390-19"><a href="#cb390-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-size-md</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb390-20"><a href="#cb390-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">--font-size-lg</span><span class="ch">:</span> <span class="dv">1.25</span><span class="dt">rem</span><span class="op">;</span></span>
<span id="cb390-21"><a href="#cb390-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb390-22"><a href="#cb390-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Borders */</span></span>
<span id="cb390-23"><a href="#cb390-23" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-radius</span><span class="ch">:</span> <span class="dv">4</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-24"><a href="#cb390-24" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-width</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb390-25"><a href="#cb390-25" aria-hidden="true" tabindex="-1"></a>  <span class="va">--border-color</span><span class="ch">:</span> <span class="cn">#dee2e6</span><span class="op">;</span></span>
<span id="cb390-26"><a href="#cb390-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Components use these tokens:</p>
<div class="sourceCode" id="cb391"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanButton <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb391-11"><a href="#cb391-11" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: inline-block;</span></span>
<span id="cb391-12"><a href="#cb391-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb391-13"><a href="#cb391-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-14"><a href="#cb391-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb391-15"><a href="#cb391-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-family: var(--font-family);</span></span>
<span id="cb391-16"><a href="#cb391-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: var(--font-size-md);</span></span>
<span id="cb391-17"><a href="#cb391-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--space-sm) var(--space-md);</span></span>
<span id="cb391-18"><a href="#cb391-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: var(--border-radius);</span></span>
<span id="cb391-19"><a href="#cb391-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: var(--border-width) solid transparent;</span></span>
<span id="cb391-20"><a href="#cb391-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb391-21"><a href="#cb391-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb391-22"><a href="#cb391-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-23"><a href="#cb391-23" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([variant=&quot;primary&quot;]) button {</span></span>
<span id="cb391-24"><a href="#cb391-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--color-primary);</span></span>
<span id="cb391-25"><a href="#cb391-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb391-26"><a href="#cb391-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb391-27"><a href="#cb391-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-28"><a href="#cb391-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([variant=&quot;secondary&quot;]) button {</span></span>
<span id="cb391-29"><a href="#cb391-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--color-secondary);</span></span>
<span id="cb391-30"><a href="#cb391-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb391-31"><a href="#cb391-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb391-32"><a href="#cb391-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-33"><a href="#cb391-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([disabled]) button {</span></span>
<span id="cb391-34"><a href="#cb391-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          opacity: 0.5;</span></span>
<span id="cb391-35"><a href="#cb391-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: not-allowed;</span></span>
<span id="cb391-36"><a href="#cb391-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb391-37"><a href="#cb391-37" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb391-38"><a href="#cb391-38" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/button&gt;</span></span>
<span id="cb391-39"><a href="#cb391-39" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb391-40"><a href="#cb391-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb391-41"><a href="#cb391-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="17.4" id="versioning-and-publishing"><span
class="header-section-number">17.4</span> Versioning and Publishing</h2>
<p>Use semantic versioning. Publish to npm or a private registry:</p>
<div class="sourceCode" id="cb392"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;@myorg/components&quot;</span><span class="fu">,</span></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.2.0&quot;</span><span class="fu">,</span></span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;module&quot;</span><span class="fu">,</span></span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;.&quot;</span><span class="fu">:</span> <span class="st">&quot;./index.js&quot;</span><span class="fu">,</span></span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;./button&quot;</span><span class="fu">:</span> <span class="st">&quot;./core/pan-button.js&quot;</span><span class="fu">,</span></span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;./card&quot;</span><span class="fu">:</span> <span class="st">&quot;./core/pan-card.js&quot;</span></span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb392-10"><a href="#cb392-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<div class="sourceCode" id="cb393"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> publish <span class="at">--access</span> public</span></code></pre></div>
<h2 data-number="17.5" id="building-a-complete-component"><span
class="header-section-number">17.5</span> Building a Complete
Component</h2>
<p>Let’s build a production-ready dialog component from scratch:</p>
<div class="sourceCode" id="cb394"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/core/pan-dialog.js</span></span>
<span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-3"><a href="#cb394-3" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb394-4"><a href="#cb394-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * A modal dialog component with accessibility support.</span></span>
<span id="cb394-5"><a href="#cb394-5" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-6"><a href="#cb394-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@element</span><span class="co"> pan-dialog</span></span>
<span id="cb394-7"><a href="#cb394-7" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-8"><a href="#cb394-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} open - Controls dialog visibility</span></span>
<span id="cb394-9"><a href="#cb394-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {string} title - Dialog title</span></span>
<span id="cb394-10"><a href="#cb394-10" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} modal - Whether dialog is modal (blocks background)</span></span>
<span id="cb394-11"><a href="#cb394-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} close-on-escape - Close on Escape key (default: true)</span></span>
<span id="cb394-12"><a href="#cb394-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@attr</span><span class="co"> {boolean} close-on-backdrop - Close on backdrop click (default: true)</span></span>
<span id="cb394-13"><a href="#cb394-13" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-14"><a href="#cb394-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@fires</span><span class="co"> open - Fired when dialog opens</span></span>
<span id="cb394-15"><a href="#cb394-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@fires</span><span class="co"> close - Fired when dialog closes</span></span>
<span id="cb394-16"><a href="#cb394-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@fires</span><span class="co"> cancel - Fired when user tries to close (cancelable)</span></span>
<span id="cb394-17"><a href="#cb394-17" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-18"><a href="#cb394-18" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> - Main dialog content</span></span>
<span id="cb394-19"><a href="#cb394-19" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> header - Custom header content</span></span>
<span id="cb394-20"><a href="#cb394-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@slot</span><span class="co"> footer - Custom footer content</span></span>
<span id="cb394-21"><a href="#cb394-21" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-22"><a href="#cb394-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@csspart</span><span class="co"> dialog - The dialog container</span></span>
<span id="cb394-23"><a href="#cb394-23" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@csspart</span><span class="co"> header - The header section</span></span>
<span id="cb394-24"><a href="#cb394-24" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@csspart</span><span class="co"> body - The body section</span></span>
<span id="cb394-25"><a href="#cb394-25" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@csspart</span><span class="co"> footer - The footer section</span></span>
<span id="cb394-26"><a href="#cb394-26" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-27"><a href="#cb394-27" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@cssprop</span><span class="co"> --dialog-width - Dialog width (default: 500px)</span></span>
<span id="cb394-28"><a href="#cb394-28" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@cssprop</span><span class="co"> --dialog-max-width - Maximum dialog width (default: 90vw)</span></span>
<span id="cb394-29"><a href="#cb394-29" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@cssprop</span><span class="co"> --dialog-backdrop - Backdrop color (default: rgba(0,0,0,0.5))</span></span>
<span id="cb394-30"><a href="#cb394-30" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb394-31"><a href="#cb394-31" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@example</span></span>
<span id="cb394-32"><a href="#cb394-32" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="kw">&lt;pan-dialog</span><span class="ot"> open title=</span><span class="dt">&quot;Confirm Delete&quot;</span><span class="kw">&gt;</span></span>
<span id="cb394-33"><a href="#cb394-33" aria-hidden="true" tabindex="-1"></a><span class="co"> *   </span><span class="kw">&lt;p&gt;</span><span class="co">Are you sure you want to delete this item?</span><span class="kw">&lt;/p&gt;</span></span>
<span id="cb394-34"><a href="#cb394-34" aria-hidden="true" tabindex="-1"></a><span class="co"> *   </span><span class="kw">&lt;div</span><span class="ot"> slot=</span><span class="dt">&quot;footer&quot;</span><span class="kw">&gt;</span></span>
<span id="cb394-35"><a href="#cb394-35" aria-hidden="true" tabindex="-1"></a><span class="co"> *     </span><span class="kw">&lt;button&gt;</span><span class="co">Cancel</span><span class="kw">&lt;/button&gt;</span></span>
<span id="cb394-36"><a href="#cb394-36" aria-hidden="true" tabindex="-1"></a><span class="co"> *     </span><span class="kw">&lt;button&gt;</span><span class="co">Delete</span><span class="kw">&lt;/button&gt;</span></span>
<span id="cb394-37"><a href="#cb394-37" aria-hidden="true" tabindex="-1"></a><span class="co"> *   </span><span class="kw">&lt;/div&gt;</span></span>
<span id="cb394-38"><a href="#cb394-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="kw">&lt;/pan-dialog&gt;</span></span>
<span id="cb394-39"><a href="#cb394-39" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb394-40"><a href="#cb394-40" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanDialog <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb394-41"><a href="#cb394-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="st">&#39;title&#39;</span>]<span class="op">;</span></span>
<span id="cb394-42"><a href="#cb394-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-43"><a href="#cb394-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb394-44"><a href="#cb394-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb394-45"><a href="#cb394-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb394-46"><a href="#cb394-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_previouslyFocused</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb394-47"><a href="#cb394-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-48"><a href="#cb394-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-49"><a href="#cb394-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb394-50"><a href="#cb394-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb394-51"><a href="#cb394-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupAccessibility</span>()<span class="op">;</span></span>
<span id="cb394-52"><a href="#cb394-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupEventListeners</span>()<span class="op">;</span></span>
<span id="cb394-53"><a href="#cb394-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-54"><a href="#cb394-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-55"><a href="#cb394-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb394-56"><a href="#cb394-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">removeEventListeners</span>()<span class="op">;</span></span>
<span id="cb394-57"><a href="#cb394-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-58"><a href="#cb394-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-59"><a href="#cb394-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb394-60"><a href="#cb394-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (oldValue <span class="op">===</span> newValue) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb394-61"><a href="#cb394-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-62"><a href="#cb394-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;open&#39;</span>) {</span>
<span id="cb394-63"><a href="#cb394-63" aria-hidden="true" tabindex="-1"></a>      newValue <span class="op">!==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">this</span><span class="op">.</span><span class="fu">show</span>() <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hide</span>()<span class="op">;</span></span>
<span id="cb394-64"><a href="#cb394-64" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;title&#39;</span>) {</span>
<span id="cb394-65"><a href="#cb394-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateTitle</span>()<span class="op">;</span></span>
<span id="cb394-66"><a href="#cb394-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb394-67"><a href="#cb394-67" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-68"><a href="#cb394-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-69"><a href="#cb394-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb394-70"><a href="#cb394-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb394-71"><a href="#cb394-71" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb394-72"><a href="#cb394-72" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb394-73"><a href="#cb394-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: none;</span></span>
<span id="cb394-74"><a href="#cb394-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb394-75"><a href="#cb394-75" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 0;</span></span>
<span id="cb394-76"><a href="#cb394-76" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb394-77"><a href="#cb394-77" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb394-78"><a href="#cb394-78" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 100%;</span></span>
<span id="cb394-79"><a href="#cb394-79" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 1000;</span></span>
<span id="cb394-80"><a href="#cb394-80" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-81"><a href="#cb394-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-82"><a href="#cb394-82" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host([open]) {</span></span>
<span id="cb394-83"><a href="#cb394-83" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb394-84"><a href="#cb394-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb394-85"><a href="#cb394-85" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: center;</span></span>
<span id="cb394-86"><a href="#cb394-86" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-87"><a href="#cb394-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-88"><a href="#cb394-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        .backdrop {</span></span>
<span id="cb394-89"><a href="#cb394-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: absolute;</span></span>
<span id="cb394-90"><a href="#cb394-90" aria-hidden="true" tabindex="-1"></a><span class="vs">          top: 0;</span></span>
<span id="cb394-91"><a href="#cb394-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          left: 0;</span></span>
<span id="cb394-92"><a href="#cb394-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb394-93"><a href="#cb394-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          height: 100%;</span></span>
<span id="cb394-94"><a href="#cb394-94" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--dialog-backdrop, rgba(0, 0, 0, 0.5));</span></span>
<span id="cb394-95"><a href="#cb394-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: fadeIn 0.2s ease-out;</span></span>
<span id="cb394-96"><a href="#cb394-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-97"><a href="#cb394-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-98"><a href="#cb394-98" aria-hidden="true" tabindex="-1"></a><span class="vs">        .dialog {</span></span>
<span id="cb394-99"><a href="#cb394-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: relative;</span></span>
<span id="cb394-100"><a href="#cb394-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: var(--dialog-width, 500px);</span></span>
<span id="cb394-101"><a href="#cb394-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: var(--dialog-max-width, 90vw);</span></span>
<span id="cb394-102"><a href="#cb394-102" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 90vh;</span></span>
<span id="cb394-103"><a href="#cb394-103" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--dialog-bg, white);</span></span>
<span id="cb394-104"><a href="#cb394-104" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: var(--border-radius, 8px);</span></span>
<span id="cb394-105"><a href="#cb394-105" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);</span></span>
<span id="cb394-106"><a href="#cb394-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb394-107"><a href="#cb394-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb394-108"><a href="#cb394-108" aria-hidden="true" tabindex="-1"></a><span class="vs">          animation: slideUp 0.3s ease-out;</span></span>
<span id="cb394-109"><a href="#cb394-109" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-110"><a href="#cb394-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-111"><a href="#cb394-111" aria-hidden="true" tabindex="-1"></a><span class="vs">        .header {</span></span>
<span id="cb394-112"><a href="#cb394-112" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--space-md, 16px);</span></span>
<span id="cb394-113"><a href="#cb394-113" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid var(--border-color, #e0e0e0);</span></span>
<span id="cb394-114"><a href="#cb394-114" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb394-115"><a href="#cb394-115" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb394-116"><a href="#cb394-116" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: space-between;</span></span>
<span id="cb394-117"><a href="#cb394-117" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-118"><a href="#cb394-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-119"><a href="#cb394-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        .title {</span></span>
<span id="cb394-120"><a href="#cb394-120" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: var(--font-size-lg, 1.25rem);</span></span>
<span id="cb394-121"><a href="#cb394-121" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb394-122"><a href="#cb394-122" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0;</span></span>
<span id="cb394-123"><a href="#cb394-123" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-124"><a href="#cb394-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-125"><a href="#cb394-125" aria-hidden="true" tabindex="-1"></a><span class="vs">        .close-button {</span></span>
<span id="cb394-126"><a href="#cb394-126" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: none;</span></span>
<span id="cb394-127"><a href="#cb394-127" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb394-128"><a href="#cb394-128" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1.5rem;</span></span>
<span id="cb394-129"><a href="#cb394-129" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb394-130"><a href="#cb394-130" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 4px 8px;</span></span>
<span id="cb394-131"><a href="#cb394-131" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb394-132"><a href="#cb394-132" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: var(--color-text-secondary, #666);</span></span>
<span id="cb394-133"><a href="#cb394-133" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-134"><a href="#cb394-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-135"><a href="#cb394-135" aria-hidden="true" tabindex="-1"></a><span class="vs">        .close-button:hover {</span></span>
<span id="cb394-136"><a href="#cb394-136" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--color-hover, #f0f0f0);</span></span>
<span id="cb394-137"><a href="#cb394-137" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-138"><a href="#cb394-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-139"><a href="#cb394-139" aria-hidden="true" tabindex="-1"></a><span class="vs">        .body {</span></span>
<span id="cb394-140"><a href="#cb394-140" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--space-md, 16px);</span></span>
<span id="cb394-141"><a href="#cb394-141" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-y: auto;</span></span>
<span id="cb394-142"><a href="#cb394-142" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb394-143"><a href="#cb394-143" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-144"><a href="#cb394-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-145"><a href="#cb394-145" aria-hidden="true" tabindex="-1"></a><span class="vs">        .footer {</span></span>
<span id="cb394-146"><a href="#cb394-146" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: var(--space-md, 16px);</span></span>
<span id="cb394-147"><a href="#cb394-147" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-top: 1px solid var(--border-color, #e0e0e0);</span></span>
<span id="cb394-148"><a href="#cb394-148" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb394-149"><a href="#cb394-149" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: flex-end;</span></span>
<span id="cb394-150"><a href="#cb394-150" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: var(--space-sm, 8px);</span></span>
<span id="cb394-151"><a href="#cb394-151" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-152"><a href="#cb394-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-153"><a href="#cb394-153" aria-hidden="true" tabindex="-1"></a><span class="vs">        @keyframes fadeIn {</span></span>
<span id="cb394-154"><a href="#cb394-154" aria-hidden="true" tabindex="-1"></a><span class="vs">          from { opacity: 0; }</span></span>
<span id="cb394-155"><a href="#cb394-155" aria-hidden="true" tabindex="-1"></a><span class="vs">          to { opacity: 1; }</span></span>
<span id="cb394-156"><a href="#cb394-156" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-157"><a href="#cb394-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-158"><a href="#cb394-158" aria-hidden="true" tabindex="-1"></a><span class="vs">        @keyframes slideUp {</span></span>
<span id="cb394-159"><a href="#cb394-159" aria-hidden="true" tabindex="-1"></a><span class="vs">          from {</span></span>
<span id="cb394-160"><a href="#cb394-160" aria-hidden="true" tabindex="-1"></a><span class="vs">            transform: translateY(20px);</span></span>
<span id="cb394-161"><a href="#cb394-161" aria-hidden="true" tabindex="-1"></a><span class="vs">            opacity: 0;</span></span>
<span id="cb394-162"><a href="#cb394-162" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb394-163"><a href="#cb394-163" aria-hidden="true" tabindex="-1"></a><span class="vs">          to {</span></span>
<span id="cb394-164"><a href="#cb394-164" aria-hidden="true" tabindex="-1"></a><span class="vs">            transform: translateY(0);</span></span>
<span id="cb394-165"><a href="#cb394-165" aria-hidden="true" tabindex="-1"></a><span class="vs">            opacity: 1;</span></span>
<span id="cb394-166"><a href="#cb394-166" aria-hidden="true" tabindex="-1"></a><span class="vs">          }</span></span>
<span id="cb394-167"><a href="#cb394-167" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb394-168"><a href="#cb394-168" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb394-169"><a href="#cb394-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-170"><a href="#cb394-170" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;backdrop&quot; part=&quot;backdrop&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb394-171"><a href="#cb394-171" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;dialog&quot; part=&quot;dialog&quot; role=&quot;dialog&quot; aria-modal=&quot;true&quot;&gt;</span></span>
<span id="cb394-172"><a href="#cb394-172" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;header&quot; part=&quot;header&quot;&gt;</span></span>
<span id="cb394-173"><a href="#cb394-173" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;header&quot;&gt;</span></span>
<span id="cb394-174"><a href="#cb394-174" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;h2 class=&quot;title&quot; id=&quot;dialog-title&quot;&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;title&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&lt;/h2&gt;</span></span>
<span id="cb394-175"><a href="#cb394-175" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/slot&gt;</span></span>
<span id="cb394-176"><a href="#cb394-176" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button class=&quot;close-button&quot; aria-label=&quot;Close dialog&quot; type=&quot;button&quot;&gt;</span></span>
<span id="cb394-177"><a href="#cb394-177" aria-hidden="true" tabindex="-1"></a><span class="vs">            ×</span></span>
<span id="cb394-178"><a href="#cb394-178" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/button&gt;</span></span>
<span id="cb394-179"><a href="#cb394-179" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb394-180"><a href="#cb394-180" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;body&quot; part=&quot;body&quot;&gt;</span></span>
<span id="cb394-181"><a href="#cb394-181" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb394-182"><a href="#cb394-182" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb394-183"><a href="#cb394-183" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;footer&quot; part=&quot;footer&quot;&gt;</span></span>
<span id="cb394-184"><a href="#cb394-184" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;slot name=&quot;footer&quot;&gt;&lt;/slot&gt;</span></span>
<span id="cb394-185"><a href="#cb394-185" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb394-186"><a href="#cb394-186" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb394-187"><a href="#cb394-187" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb394-188"><a href="#cb394-188" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-189"><a href="#cb394-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-190"><a href="#cb394-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupAccessibility</span>() {</span>
<span id="cb394-191"><a href="#cb394-191" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dialog <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.dialog&#39;</span>)<span class="op">;</span></span>
<span id="cb394-192"><a href="#cb394-192" aria-hidden="true" tabindex="-1"></a>    dialog<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;aria-labelledby&#39;</span><span class="op">,</span> <span class="st">&#39;dialog-title&#39;</span>)<span class="op">;</span></span>
<span id="cb394-193"><a href="#cb394-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-194"><a href="#cb394-194" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set focus trap</span></span>
<span id="cb394-195"><a href="#cb394-195" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> focusableElements <span class="op">=</span> dialog<span class="op">.</span><span class="fu">querySelectorAll</span>(</span>
<span id="cb394-196"><a href="#cb394-196" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;button, [href], input, select, textarea, [tabindex]:not([tabindex=&quot;-1&quot;])&#39;</span></span>
<span id="cb394-197"><a href="#cb394-197" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb394-198"><a href="#cb394-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-199"><a href="#cb394-199" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_firstFocusable</span> <span class="op">=</span> focusableElements[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb394-200"><a href="#cb394-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_lastFocusable</span> <span class="op">=</span> focusableElements[focusableElements<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb394-201"><a href="#cb394-201" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-202"><a href="#cb394-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-203"><a href="#cb394-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupEventListeners</span>() {</span>
<span id="cb394-204"><a href="#cb394-204" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Close button</span></span>
<span id="cb394-205"><a href="#cb394-205" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.close-button&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb394-206"><a href="#cb394-206" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb394-207"><a href="#cb394-207" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb394-208"><a href="#cb394-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-209"><a href="#cb394-209" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Backdrop click</span></span>
<span id="cb394-210"><a href="#cb394-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;close-on-backdrop&#39;</span>) <span class="op">||</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;close-on-backdrop&#39;</span>)) {</span>
<span id="cb394-211"><a href="#cb394-211" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.backdrop&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb394-212"><a href="#cb394-212" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb394-213"><a href="#cb394-213" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb394-214"><a href="#cb394-214" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb394-215"><a href="#cb394-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-216"><a href="#cb394-216" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Escape key</span></span>
<span id="cb394-217"><a href="#cb394-217" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_keydownHandler</span> <span class="op">=</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb394-218"><a href="#cb394-218" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">&#39;Escape&#39;</span> <span class="op">&amp;&amp;</span> (<span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;close-on-escape&#39;</span>) <span class="op">||</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;close-on-escape&#39;</span>))) {</span>
<span id="cb394-219"><a href="#cb394-219" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">close</span>()<span class="op">;</span></span>
<span id="cb394-220"><a href="#cb394-220" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb394-221"><a href="#cb394-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-222"><a href="#cb394-222" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Focus trap</span></span>
<span id="cb394-223"><a href="#cb394-223" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">&#39;Tab&#39;</span> <span class="op">&amp;&amp;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;open&#39;</span>)) {</span>
<span id="cb394-224"><a href="#cb394-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (e<span class="op">.</span><span class="at">shiftKey</span>) {</span>
<span id="cb394-225"><a href="#cb394-225" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">_firstFocusable</span>) {</span>
<span id="cb394-226"><a href="#cb394-226" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb394-227"><a href="#cb394-227" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">_lastFocusable</span><span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb394-228"><a href="#cb394-228" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb394-229"><a href="#cb394-229" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb394-230"><a href="#cb394-230" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span> <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">_lastFocusable</span>) {</span>
<span id="cb394-231"><a href="#cb394-231" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb394-232"><a href="#cb394-232" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">_firstFocusable</span><span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb394-233"><a href="#cb394-233" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb394-234"><a href="#cb394-234" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb394-235"><a href="#cb394-235" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb394-236"><a href="#cb394-236" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb394-237"><a href="#cb394-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-238"><a href="#cb394-238" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">_keydownHandler</span>)<span class="op">;</span></span>
<span id="cb394-239"><a href="#cb394-239" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-240"><a href="#cb394-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-241"><a href="#cb394-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">removeEventListeners</span>() {</span>
<span id="cb394-242"><a href="#cb394-242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">_keydownHandler</span>)<span class="op">;</span></span>
<span id="cb394-243"><a href="#cb394-243" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-244"><a href="#cb394-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-245"><a href="#cb394-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show</span>() {</span>
<span id="cb394-246"><a href="#cb394-246" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store previously focused element</span></span>
<span id="cb394-247"><a href="#cb394-247" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_previouslyFocused</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span><span class="op">;</span></span>
<span id="cb394-248"><a href="#cb394-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-249"><a href="#cb394-249" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prevent body scroll</span></span>
<span id="cb394-250"><a href="#cb394-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">overflow</span> <span class="op">=</span> <span class="st">&#39;hidden&#39;</span><span class="op">;</span></span>
<span id="cb394-251"><a href="#cb394-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-252"><a href="#cb394-252" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Focus first focusable element</span></span>
<span id="cb394-253"><a href="#cb394-253" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb394-254"><a href="#cb394-254" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">_firstFocusable</span><span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb394-255"><a href="#cb394-255" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb394-256"><a href="#cb394-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-257"><a href="#cb394-257" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fire event</span></span>
<span id="cb394-258"><a href="#cb394-258" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;open&#39;</span>))<span class="op">;</span></span>
<span id="cb394-259"><a href="#cb394-259" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-260"><a href="#cb394-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-261"><a href="#cb394-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hide</span>() {</span>
<span id="cb394-262"><a href="#cb394-262" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restore body scroll</span></span>
<span id="cb394-263"><a href="#cb394-263" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="at">overflow</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb394-264"><a href="#cb394-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-265"><a href="#cb394-265" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restore focus</span></span>
<span id="cb394-266"><a href="#cb394-266" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_previouslyFocused</span><span class="op">?.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb394-267"><a href="#cb394-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-268"><a href="#cb394-268" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fire event</span></span>
<span id="cb394-269"><a href="#cb394-269" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;close&#39;</span>))<span class="op">;</span></span>
<span id="cb394-270"><a href="#cb394-270" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-271"><a href="#cb394-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-272"><a href="#cb394-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>() {</span>
<span id="cb394-273"><a href="#cb394-273" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fire cancelable event</span></span>
<span id="cb394-274"><a href="#cb394-274" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> <span class="bu">event</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;cancel&#39;</span><span class="op">,</span> {</span>
<span id="cb394-275"><a href="#cb394-275" aria-hidden="true" tabindex="-1"></a>      <span class="dt">cancelable</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb394-276"><a href="#cb394-276" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb394-277"><a href="#cb394-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-278"><a href="#cb394-278" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="bu">event</span>)<span class="op">;</span></span>
<span id="cb394-279"><a href="#cb394-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-280"><a href="#cb394-280" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">defaultPrevented</span>) {</span>
<span id="cb394-281"><a href="#cb394-281" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb394-282"><a href="#cb394-282" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb394-283"><a href="#cb394-283" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-284"><a href="#cb394-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-285"><a href="#cb394-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateTitle</span>() {</span>
<span id="cb394-286"><a href="#cb394-286" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> titleEl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;dialog-title&#39;</span>)<span class="op">;</span></span>
<span id="cb394-287"><a href="#cb394-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (titleEl) {</span>
<span id="cb394-288"><a href="#cb394-288" aria-hidden="true" tabindex="-1"></a>      titleEl<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;title&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb394-289"><a href="#cb394-289" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb394-290"><a href="#cb394-290" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb394-291"><a href="#cb394-291" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb394-292"><a href="#cb394-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-293"><a href="#cb394-293" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;pan-dialog&#39;</span><span class="op">,</span> PanDialog)<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.6" id="component-showcase"><span
class="header-section-number">17.6</span> Component Showcase</h2>
<p>Build a documentation page to showcase components:</p>
<div class="sourceCode" id="cb395"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="co">// docs/showcase.js</span></span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ComponentShowcase <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a><span class="vs">        .showcase {</span></span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 1200px;</span></span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0 auto;</span></span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2rem;</span></span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        .component-demo {</span></span>
<span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 2rem 0;</span></span>
<span id="cb395-14"><a href="#cb395-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2rem;</span></span>
<span id="cb395-15"><a href="#cb395-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #e0e0e0;</span></span>
<span id="cb395-16"><a href="#cb395-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb395-17"><a href="#cb395-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-18"><a href="#cb395-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-19"><a href="#cb395-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        .demo-title {</span></span>
<span id="cb395-20"><a href="#cb395-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1.5rem;</span></span>
<span id="cb395-21"><a href="#cb395-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 1rem;</span></span>
<span id="cb395-22"><a href="#cb395-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-23"><a href="#cb395-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-24"><a href="#cb395-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        .demo-example {</span></span>
<span id="cb395-25"><a href="#cb395-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb395-26"><a href="#cb395-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f8f8f8;</span></span>
<span id="cb395-27"><a href="#cb395-27" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb395-28"><a href="#cb395-28" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 1rem 0;</span></span>
<span id="cb395-29"><a href="#cb395-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-30"><a href="#cb395-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-31"><a href="#cb395-31" aria-hidden="true" tabindex="-1"></a><span class="vs">        .demo-code {</span></span>
<span id="cb395-32"><a href="#cb395-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #282c34;</span></span>
<span id="cb395-33"><a href="#cb395-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #abb2bf;</span></span>
<span id="cb395-34"><a href="#cb395-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb395-35"><a href="#cb395-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb395-36"><a href="#cb395-36" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-x: auto;</span></span>
<span id="cb395-37"><a href="#cb395-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-38"><a href="#cb395-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-39"><a href="#cb395-39" aria-hidden="true" tabindex="-1"></a><span class="vs">        .demo-props {</span></span>
<span id="cb395-40"><a href="#cb395-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 1rem;</span></span>
<span id="cb395-41"><a href="#cb395-41" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-42"><a href="#cb395-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-43"><a href="#cb395-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        .prop-table {</span></span>
<span id="cb395-44"><a href="#cb395-44" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb395-45"><a href="#cb395-45" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-collapse: collapse;</span></span>
<span id="cb395-46"><a href="#cb395-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-47"><a href="#cb395-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-48"><a href="#cb395-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        .prop-table th,</span></span>
<span id="cb395-49"><a href="#cb395-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        .prop-table td {</span></span>
<span id="cb395-50"><a href="#cb395-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: left;</span></span>
<span id="cb395-51"><a href="#cb395-51" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb395-52"><a href="#cb395-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #e0e0e0;</span></span>
<span id="cb395-53"><a href="#cb395-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb395-54"><a href="#cb395-54" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb395-55"><a href="#cb395-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-56"><a href="#cb395-56" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;showcase&quot;&gt;</span></span>
<span id="cb395-57"><a href="#cb395-57" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h1&gt;Component Library&lt;/h1&gt;</span></span>
<span id="cb395-58"><a href="#cb395-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-59"><a href="#cb395-59" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;component-demo&quot;&gt;</span></span>
<span id="cb395-60"><a href="#cb395-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h2 class=&quot;demo-title&quot;&gt;Dialog&lt;/h2&gt;</span></span>
<span id="cb395-61"><a href="#cb395-61" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;A modal dialog with accessibility features.&lt;/p&gt;</span></span>
<span id="cb395-62"><a href="#cb395-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-63"><a href="#cb395-63" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;demo-example&quot;&gt;</span></span>
<span id="cb395-64"><a href="#cb395-64" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;button id=&quot;open-dialog&quot;&gt;Open Dialog&lt;/button&gt;</span></span>
<span id="cb395-65"><a href="#cb395-65" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;pan-dialog id=&quot;demo-dialog&quot; title=&quot;Example Dialog&quot;&gt;</span></span>
<span id="cb395-66"><a href="#cb395-66" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;p&gt;This is a sample dialog with default settings.&lt;/p&gt;</span></span>
<span id="cb395-67"><a href="#cb395-67" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;div slot=&quot;footer&quot;&gt;</span></span>
<span id="cb395-68"><a href="#cb395-68" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;button id=&quot;cancel-btn&quot;&gt;Cancel&lt;/button&gt;</span></span>
<span id="cb395-69"><a href="#cb395-69" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;button id=&quot;confirm-btn&quot; style=&quot;background: #0066cc; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;&quot;&gt;Confirm&lt;/button&gt;</span></span>
<span id="cb395-70"><a href="#cb395-70" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/div&gt;</span></span>
<span id="cb395-71"><a href="#cb395-71" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/pan-dialog&gt;</span></span>
<span id="cb395-72"><a href="#cb395-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb395-73"><a href="#cb395-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-74"><a href="#cb395-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;demo-code&quot;&gt;</span></span>
<span id="cb395-75"><a href="#cb395-75" aria-hidden="true" tabindex="-1"></a><span class="vs">&lt;pre&gt;&amp;lt;pan-dialog open title=&quot;Example Dialog&quot;&amp;gt;</span></span>
<span id="cb395-76"><a href="#cb395-76" aria-hidden="true" tabindex="-1"></a><span class="vs">  &amp;lt;p&amp;gt;This is a sample dialog.&amp;lt;/p&amp;gt;</span></span>
<span id="cb395-77"><a href="#cb395-77" aria-hidden="true" tabindex="-1"></a><span class="vs">  &amp;lt;div slot=&quot;footer&quot;&amp;gt;</span></span>
<span id="cb395-78"><a href="#cb395-78" aria-hidden="true" tabindex="-1"></a><span class="vs">    &amp;lt;button&amp;gt;Cancel&amp;lt;/button&amp;gt;</span></span>
<span id="cb395-79"><a href="#cb395-79" aria-hidden="true" tabindex="-1"></a><span class="vs">    &amp;lt;button&amp;gt;Confirm&amp;lt;/button&amp;gt;</span></span>
<span id="cb395-80"><a href="#cb395-80" aria-hidden="true" tabindex="-1"></a><span class="vs">  &amp;lt;/div&amp;gt;</span></span>
<span id="cb395-81"><a href="#cb395-81" aria-hidden="true" tabindex="-1"></a><span class="vs">&amp;lt;/pan-dialog&amp;gt;&lt;/pre&gt;</span></span>
<span id="cb395-82"><a href="#cb395-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb395-83"><a href="#cb395-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-84"><a href="#cb395-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;demo-props&quot;&gt;</span></span>
<span id="cb395-85"><a href="#cb395-85" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;h3&gt;Properties&lt;/h3&gt;</span></span>
<span id="cb395-86"><a href="#cb395-86" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;table class=&quot;prop-table&quot;&gt;</span></span>
<span id="cb395-87"><a href="#cb395-87" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;thead&gt;</span></span>
<span id="cb395-88"><a href="#cb395-88" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;tr&gt;</span></span>
<span id="cb395-89"><a href="#cb395-89" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;th&gt;Attribute&lt;/th&gt;</span></span>
<span id="cb395-90"><a href="#cb395-90" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;th&gt;Type&lt;/th&gt;</span></span>
<span id="cb395-91"><a href="#cb395-91" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;th&gt;Default&lt;/th&gt;</span></span>
<span id="cb395-92"><a href="#cb395-92" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;th&gt;Description&lt;/th&gt;</span></span>
<span id="cb395-93"><a href="#cb395-93" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/tr&gt;</span></span>
<span id="cb395-94"><a href="#cb395-94" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/thead&gt;</span></span>
<span id="cb395-95"><a href="#cb395-95" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;tbody&gt;</span></span>
<span id="cb395-96"><a href="#cb395-96" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;tr&gt;</span></span>
<span id="cb395-97"><a href="#cb395-97" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;&lt;code&gt;open&lt;/code&gt;&lt;/td&gt;</span></span>
<span id="cb395-98"><a href="#cb395-98" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;boolean&lt;/td&gt;</span></span>
<span id="cb395-99"><a href="#cb395-99" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;false&lt;/td&gt;</span></span>
<span id="cb395-100"><a href="#cb395-100" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;Controls dialog visibility&lt;/td&gt;</span></span>
<span id="cb395-101"><a href="#cb395-101" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/tr&gt;</span></span>
<span id="cb395-102"><a href="#cb395-102" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;tr&gt;</span></span>
<span id="cb395-103"><a href="#cb395-103" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;&lt;code&gt;title&lt;/code&gt;&lt;/td&gt;</span></span>
<span id="cb395-104"><a href="#cb395-104" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;string&lt;/td&gt;</span></span>
<span id="cb395-105"><a href="#cb395-105" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;&quot;&quot;&lt;/td&gt;</span></span>
<span id="cb395-106"><a href="#cb395-106" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;Dialog title&lt;/td&gt;</span></span>
<span id="cb395-107"><a href="#cb395-107" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/tr&gt;</span></span>
<span id="cb395-108"><a href="#cb395-108" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;tr&gt;</span></span>
<span id="cb395-109"><a href="#cb395-109" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;&lt;code&gt;close-on-escape&lt;/code&gt;&lt;/td&gt;</span></span>
<span id="cb395-110"><a href="#cb395-110" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;boolean&lt;/td&gt;</span></span>
<span id="cb395-111"><a href="#cb395-111" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;true&lt;/td&gt;</span></span>
<span id="cb395-112"><a href="#cb395-112" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;Close on Escape key&lt;/td&gt;</span></span>
<span id="cb395-113"><a href="#cb395-113" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/tr&gt;</span></span>
<span id="cb395-114"><a href="#cb395-114" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;tr&gt;</span></span>
<span id="cb395-115"><a href="#cb395-115" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;&lt;code&gt;close-on-backdrop&lt;/code&gt;&lt;/td&gt;</span></span>
<span id="cb395-116"><a href="#cb395-116" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;boolean&lt;/td&gt;</span></span>
<span id="cb395-117"><a href="#cb395-117" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;true&lt;/td&gt;</span></span>
<span id="cb395-118"><a href="#cb395-118" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;td&gt;Close on backdrop click&lt;/td&gt;</span></span>
<span id="cb395-119"><a href="#cb395-119" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/tr&gt;</span></span>
<span id="cb395-120"><a href="#cb395-120" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/tbody&gt;</span></span>
<span id="cb395-121"><a href="#cb395-121" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/table&gt;</span></span>
<span id="cb395-122"><a href="#cb395-122" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb395-123"><a href="#cb395-123" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb395-124"><a href="#cb395-124" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb395-125"><a href="#cb395-125" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb395-126"><a href="#cb395-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-127"><a href="#cb395-127" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup demo interactivity</span></span>
<span id="cb395-128"><a href="#cb395-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupDemos</span>()<span class="op">;</span></span>
<span id="cb395-129"><a href="#cb395-129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb395-130"><a href="#cb395-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-131"><a href="#cb395-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupDemos</span>() {</span>
<span id="cb395-132"><a href="#cb395-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> openBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#open-dialog&#39;</span>)<span class="op">;</span></span>
<span id="cb395-133"><a href="#cb395-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dialog <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#demo-dialog&#39;</span>)<span class="op">;</span></span>
<span id="cb395-134"><a href="#cb395-134" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cancelBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#cancel-btn&#39;</span>)<span class="op">;</span></span>
<span id="cb395-135"><a href="#cb395-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> confirmBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#confirm-btn&#39;</span>)<span class="op">;</span></span>
<span id="cb395-136"><a href="#cb395-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-137"><a href="#cb395-137" aria-hidden="true" tabindex="-1"></a>    openBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb395-138"><a href="#cb395-138" aria-hidden="true" tabindex="-1"></a>      dialog<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb395-139"><a href="#cb395-139" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb395-140"><a href="#cb395-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-141"><a href="#cb395-141" aria-hidden="true" tabindex="-1"></a>    cancelBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb395-142"><a href="#cb395-142" aria-hidden="true" tabindex="-1"></a>      dialog<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb395-143"><a href="#cb395-143" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb395-144"><a href="#cb395-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-145"><a href="#cb395-145" aria-hidden="true" tabindex="-1"></a>    confirmBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb395-146"><a href="#cb395-146" aria-hidden="true" tabindex="-1"></a>      <span class="fu">alert</span>(<span class="st">&#39;Confirmed!&#39;</span>)<span class="op">;</span></span>
<span id="cb395-147"><a href="#cb395-147" aria-hidden="true" tabindex="-1"></a>      dialog<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb395-148"><a href="#cb395-148" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb395-149"><a href="#cb395-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb395-150"><a href="#cb395-150" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb395-151"><a href="#cb395-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-152"><a href="#cb395-152" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;component-showcase&#39;</span><span class="op">,</span> ComponentShowcase)<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.7" id="testing-components-1"><span
class="header-section-number">17.7</span> Testing Components</h2>
<p>Write comprehensive tests for your components:</p>
<div class="sourceCode" id="cb396"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="co">// components/core/pan-dialog.test.js</span></span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { expect<span class="op">,</span> fixture<span class="op">,</span> html<span class="op">,</span> oneEvent } <span class="im">from</span> <span class="st">&#39;@open-wc/testing&#39;</span><span class="op">;</span></span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./pan-dialog.js&#39;</span><span class="op">;</span></span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-5"><a href="#cb396-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;PanDialog&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-6"><a href="#cb396-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should render with default attributes&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-7"><a href="#cb396-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-8"><a href="#cb396-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(el)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-9"><a href="#cb396-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(el<span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;open&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="at">false</span><span class="op">;</span></span>
<span id="cb396-10"><a href="#cb396-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-11"><a href="#cb396-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-12"><a href="#cb396-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should show when open attribute is set&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-13"><a href="#cb396-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-14"><a href="#cb396-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> computedStyle <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="fu">getComputedStyle</span>(el)<span class="op">;</span></span>
<span id="cb396-15"><a href="#cb396-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(computedStyle<span class="op">.</span><span class="at">display</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;flex&#39;</span>)<span class="op">;</span></span>
<span id="cb396-16"><a href="#cb396-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-17"><a href="#cb396-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-18"><a href="#cb396-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should hide when open attribute is removed&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-19"><a href="#cb396-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-20"><a href="#cb396-20" aria-hidden="true" tabindex="-1"></a>    el<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb396-21"><a href="#cb396-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> el<span class="op">.</span><span class="at">updateComplete</span><span class="op">;</span></span>
<span id="cb396-22"><a href="#cb396-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> computedStyle <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="fu">getComputedStyle</span>(el)<span class="op">;</span></span>
<span id="cb396-23"><a href="#cb396-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(computedStyle<span class="op">.</span><span class="at">display</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;none&#39;</span>)<span class="op">;</span></span>
<span id="cb396-24"><a href="#cb396-24" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-25"><a href="#cb396-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-26"><a href="#cb396-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should fire open event when opened&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-27"><a href="#cb396-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-28"><a href="#cb396-28" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> el<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>))<span class="op">;</span></span>
<span id="cb396-29"><a href="#cb396-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { detail } <span class="op">=</span> <span class="cf">await</span> <span class="fu">oneEvent</span>(el<span class="op">,</span> <span class="st">&#39;open&#39;</span>)<span class="op">;</span></span>
<span id="cb396-30"><a href="#cb396-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(detail)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-31"><a href="#cb396-31" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-32"><a href="#cb396-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-33"><a href="#cb396-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should fire close event when closed&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-34"><a href="#cb396-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-35"><a href="#cb396-35" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> el<span class="op">.</span><span class="fu">removeAttribute</span>(<span class="st">&#39;open&#39;</span>))<span class="op">;</span></span>
<span id="cb396-36"><a href="#cb396-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { detail } <span class="op">=</span> <span class="cf">await</span> <span class="fu">oneEvent</span>(el<span class="op">,</span> <span class="st">&#39;close&#39;</span>)<span class="op">;</span></span>
<span id="cb396-37"><a href="#cb396-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(detail)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-38"><a href="#cb396-38" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-39"><a href="#cb396-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-40"><a href="#cb396-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should close on backdrop click&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-41"><a href="#cb396-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open close-on-backdrop&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-42"><a href="#cb396-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> backdrop <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.backdrop&#39;</span>)<span class="op">;</span></span>
<span id="cb396-43"><a href="#cb396-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-44"><a href="#cb396-44" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> backdrop<span class="op">.</span><span class="fu">click</span>())<span class="op">;</span></span>
<span id="cb396-45"><a href="#cb396-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">oneEvent</span>(el<span class="op">,</span> <span class="st">&#39;cancel&#39;</span>)<span class="op">;</span></span>
<span id="cb396-46"><a href="#cb396-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-47"><a href="#cb396-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(el<span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;open&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="at">false</span><span class="op">;</span></span>
<span id="cb396-48"><a href="#cb396-48" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-49"><a href="#cb396-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-50"><a href="#cb396-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should close on Escape key&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-51"><a href="#cb396-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open close-on-escape&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-52"><a href="#cb396-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-53"><a href="#cb396-53" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb396-54"><a href="#cb396-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> <span class="bu">event</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">KeyboardEvent</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> { <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;Escape&#39;</span> })<span class="op">;</span></span>
<span id="cb396-55"><a href="#cb396-55" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="bu">event</span>)<span class="op">;</span></span>
<span id="cb396-56"><a href="#cb396-56" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb396-57"><a href="#cb396-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-58"><a href="#cb396-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">oneEvent</span>(el<span class="op">,</span> <span class="st">&#39;cancel&#39;</span>)<span class="op">;</span></span>
<span id="cb396-59"><a href="#cb396-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(el<span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;open&#39;</span>))<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">be</span><span class="op">.</span><span class="at">false</span><span class="op">;</span></span>
<span id="cb396-60"><a href="#cb396-60" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-61"><a href="#cb396-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-62"><a href="#cb396-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should trap focus within dialog&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-63"><a href="#cb396-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb396-64"><a href="#cb396-64" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;pan-dialog open&gt;</span></span>
<span id="cb396-65"><a href="#cb396-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;btn1&quot;&gt;Button 1&lt;/button&gt;</span></span>
<span id="cb396-66"><a href="#cb396-66" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button id=&quot;btn2&quot;&gt;Button 2&lt;/button&gt;</span></span>
<span id="cb396-67"><a href="#cb396-67" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/pan-dialog&gt;</span></span>
<span id="cb396-68"><a href="#cb396-68" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb396-69"><a href="#cb396-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-70"><a href="#cb396-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> btn1 <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#btn1&#39;</span>)<span class="op">;</span></span>
<span id="cb396-71"><a href="#cb396-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> btn2 <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#btn2&#39;</span>)<span class="op">;</span></span>
<span id="cb396-72"><a href="#cb396-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-73"><a href="#cb396-73" aria-hidden="true" tabindex="-1"></a>    btn2<span class="op">.</span><span class="fu">focus</span>()<span class="op">;</span></span>
<span id="cb396-74"><a href="#cb396-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(btn2)<span class="op">;</span></span>
<span id="cb396-75"><a href="#cb396-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-76"><a href="#cb396-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate Tab key on last focusable element</span></span>
<span id="cb396-77"><a href="#cb396-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tabEvent <span class="op">=</span> <span class="kw">new</span> <span class="bu">KeyboardEvent</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> { <span class="dt">key</span><span class="op">:</span> <span class="st">&#39;Tab&#39;</span><span class="op">,</span> <span class="dt">bubbles</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb396-78"><a href="#cb396-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">dispatchEvent</span>(tabEvent)<span class="op">;</span></span>
<span id="cb396-79"><a href="#cb396-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-80"><a href="#cb396-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Should wrap to first focusable element</span></span>
<span id="cb396-81"><a href="#cb396-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(<span class="bu">document</span><span class="op">.</span><span class="at">activeElement</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(btn1)<span class="op">;</span></span>
<span id="cb396-82"><a href="#cb396-82" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-83"><a href="#cb396-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-84"><a href="#cb396-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should support custom CSS parts&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-85"><a href="#cb396-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;pan-dialog open&gt;&lt;/pan-dialog&gt;`</span>)<span class="op">;</span></span>
<span id="cb396-86"><a href="#cb396-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dialog <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[part=&quot;dialog&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb396-87"><a href="#cb396-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> header <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[part=&quot;header&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb396-88"><a href="#cb396-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> body <span class="op">=</span> el<span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[part=&quot;body&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb396-89"><a href="#cb396-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-90"><a href="#cb396-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(dialog)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-91"><a href="#cb396-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(header)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-92"><a href="#cb396-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(body)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="at">exist</span><span class="op">;</span></span>
<span id="cb396-93"><a href="#cb396-93" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-94"><a href="#cb396-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-95"><a href="#cb396-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should render slotted content&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb396-96"><a href="#cb396-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`</span></span>
<span id="cb396-97"><a href="#cb396-97" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;pan-dialog open&gt;</span></span>
<span id="cb396-98"><a href="#cb396-98" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;Custom content&lt;/p&gt;</span></span>
<span id="cb396-99"><a href="#cb396-99" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button slot=&quot;footer&quot;&gt;Action&lt;/button&gt;</span></span>
<span id="cb396-100"><a href="#cb396-100" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/pan-dialog&gt;</span></span>
<span id="cb396-101"><a href="#cb396-101" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb396-102"><a href="#cb396-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-103"><a href="#cb396-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> paragraph <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;p&#39;</span>)<span class="op">;</span></span>
<span id="cb396-104"><a href="#cb396-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> footerButton <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;[slot=&quot;footer&quot;]&#39;</span>)<span class="op">;</span></span>
<span id="cb396-105"><a href="#cb396-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-106"><a href="#cb396-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(paragraph<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;Custom content&#39;</span>)<span class="op">;</span></span>
<span id="cb396-107"><a href="#cb396-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(footerButton<span class="op">.</span><span class="at">textContent</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="st">&#39;Action&#39;</span>)<span class="op">;</span></span>
<span id="cb396-108"><a href="#cb396-108" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb396-109"><a href="#cb396-109" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.8" id="theming-system"><span
class="header-section-number">17.8</span> Theming System</h2>
<p>Create a comprehensive theming system:</p>
<div class="sourceCode" id="cb397"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="co">// themes/theme-manager.js</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeManager {</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">themes</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentTheme</span> <span class="op">=</span> <span class="st">&#39;default&#39;</span><span class="op">;</span></span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">registerTheme</span>(name<span class="op">,</span> tokens) {</span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">themes</span><span class="op">.</span><span class="fu">set</span>(name<span class="op">,</span> tokens)<span class="op">;</span></span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyTheme</span>(name) {</span>
<span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> theme <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">themes</span><span class="op">.</span><span class="fu">get</span>(name)<span class="op">;</span></span>
<span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>theme) {</span>
<span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`Theme &quot;</span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">&quot; not found`</span>)<span class="op">;</span></span>
<span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb397-17"><a href="#cb397-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb397-18"><a href="#cb397-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-19"><a href="#cb397-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply CSS custom properties to :root</span></span>
<span id="cb397-20"><a href="#cb397-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(theme)<span class="op">.</span><span class="fu">forEach</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> {</span>
<span id="cb397-21"><a href="#cb397-21" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="at">documentElement</span><span class="op">.</span><span class="at">style</span><span class="op">.</span><span class="fu">setProperty</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb397-22"><a href="#cb397-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb397-23"><a href="#cb397-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-24"><a href="#cb397-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">currentTheme</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb397-25"><a href="#cb397-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-26"><a href="#cb397-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store preference</span></span>
<span id="cb397-27"><a href="#cb397-27" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;theme&#39;</span><span class="op">,</span> name)<span class="op">;</span></span>
<span id="cb397-28"><a href="#cb397-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-29"><a href="#cb397-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dispatch event</span></span>
<span id="cb397-30"><a href="#cb397-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">dispatchEvent</span>(<span class="kw">new</span> <span class="bu">CustomEvent</span>(<span class="st">&#39;theme-changed&#39;</span><span class="op">,</span> {</span>
<span id="cb397-31"><a href="#cb397-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">detail</span><span class="op">:</span> { <span class="dt">theme</span><span class="op">:</span> name }</span>
<span id="cb397-32"><a href="#cb397-32" aria-hidden="true" tabindex="-1"></a>    }))<span class="op">;</span></span>
<span id="cb397-33"><a href="#cb397-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-34"><a href="#cb397-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-35"><a href="#cb397-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCurrentTheme</span>() {</span>
<span id="cb397-36"><a href="#cb397-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">currentTheme</span><span class="op">;</span></span>
<span id="cb397-37"><a href="#cb397-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-38"><a href="#cb397-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-39"><a href="#cb397-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAvailableThemes</span>() {</span>
<span id="cb397-40"><a href="#cb397-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="kw">this</span><span class="op">.</span><span class="at">themes</span><span class="op">.</span><span class="fu">keys</span>())<span class="op">;</span></span>
<span id="cb397-41"><a href="#cb397-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-42"><a href="#cb397-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb397-43"><a href="#cb397-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-44"><a href="#cb397-44" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> themeManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">ThemeManager</span>()<span class="op">;</span></span>
<span id="cb397-45"><a href="#cb397-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-46"><a href="#cb397-46" aria-hidden="true" tabindex="-1"></a><span class="co">// Register default theme</span></span>
<span id="cb397-47"><a href="#cb397-47" aria-hidden="true" tabindex="-1"></a>themeManager<span class="op">.</span><span class="fu">registerTheme</span>(<span class="st">&#39;default&#39;</span><span class="op">,</span> {</span>
<span id="cb397-48"><a href="#cb397-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-primary&#39;</span><span class="op">:</span> <span class="st">&#39;#0066cc&#39;</span><span class="op">,</span></span>
<span id="cb397-49"><a href="#cb397-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#6c757d&#39;</span><span class="op">,</span></span>
<span id="cb397-50"><a href="#cb397-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-success&#39;</span><span class="op">:</span> <span class="st">&#39;#28a745&#39;</span><span class="op">,</span></span>
<span id="cb397-51"><a href="#cb397-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-danger&#39;</span><span class="op">:</span> <span class="st">&#39;#dc3545&#39;</span><span class="op">,</span></span>
<span id="cb397-52"><a href="#cb397-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-warning&#39;</span><span class="op">:</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span></span>
<span id="cb397-53"><a href="#cb397-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-info&#39;</span><span class="op">:</span> <span class="st">&#39;#17a2b8&#39;</span><span class="op">,</span></span>
<span id="cb397-54"><a href="#cb397-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-55"><a href="#cb397-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-text&#39;</span><span class="op">:</span> <span class="st">&#39;#212529&#39;</span><span class="op">,</span></span>
<span id="cb397-56"><a href="#cb397-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-text-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#6c757d&#39;</span><span class="op">,</span></span>
<span id="cb397-57"><a href="#cb397-57" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-bg&#39;</span><span class="op">:</span> <span class="st">&#39;#ffffff&#39;</span><span class="op">,</span></span>
<span id="cb397-58"><a href="#cb397-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-bg-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#f8f9fa&#39;</span><span class="op">,</span></span>
<span id="cb397-59"><a href="#cb397-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-60"><a href="#cb397-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--space-xs&#39;</span><span class="op">:</span> <span class="st">&#39;4px&#39;</span><span class="op">,</span></span>
<span id="cb397-61"><a href="#cb397-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--space-sm&#39;</span><span class="op">:</span> <span class="st">&#39;8px&#39;</span><span class="op">,</span></span>
<span id="cb397-62"><a href="#cb397-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--space-md&#39;</span><span class="op">:</span> <span class="st">&#39;16px&#39;</span><span class="op">,</span></span>
<span id="cb397-63"><a href="#cb397-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--space-lg&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span><span class="op">,</span></span>
<span id="cb397-64"><a href="#cb397-64" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--space-xl&#39;</span><span class="op">:</span> <span class="st">&#39;32px&#39;</span><span class="op">,</span></span>
<span id="cb397-65"><a href="#cb397-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-66"><a href="#cb397-66" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--font-family&#39;</span><span class="op">:</span> <span class="st">&#39;-apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, sans-serif&#39;</span><span class="op">,</span></span>
<span id="cb397-67"><a href="#cb397-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--font-size-sm&#39;</span><span class="op">:</span> <span class="st">&#39;0.875rem&#39;</span><span class="op">,</span></span>
<span id="cb397-68"><a href="#cb397-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--font-size-md&#39;</span><span class="op">:</span> <span class="st">&#39;1rem&#39;</span><span class="op">,</span></span>
<span id="cb397-69"><a href="#cb397-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--font-size-lg&#39;</span><span class="op">:</span> <span class="st">&#39;1.25rem&#39;</span><span class="op">,</span></span>
<span id="cb397-70"><a href="#cb397-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--font-size-xl&#39;</span><span class="op">:</span> <span class="st">&#39;1.5rem&#39;</span><span class="op">,</span></span>
<span id="cb397-71"><a href="#cb397-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-72"><a href="#cb397-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--border-radius&#39;</span><span class="op">:</span> <span class="st">&#39;4px&#39;</span><span class="op">,</span></span>
<span id="cb397-73"><a href="#cb397-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--border-radius-lg&#39;</span><span class="op">:</span> <span class="st">&#39;8px&#39;</span><span class="op">,</span></span>
<span id="cb397-74"><a href="#cb397-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--border-width&#39;</span><span class="op">:</span> <span class="st">&#39;1px&#39;</span><span class="op">,</span></span>
<span id="cb397-75"><a href="#cb397-75" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--border-color&#39;</span><span class="op">:</span> <span class="st">&#39;#dee2e6&#39;</span><span class="op">,</span></span>
<span id="cb397-76"><a href="#cb397-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-77"><a href="#cb397-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-sm&#39;</span><span class="op">:</span> <span class="st">&#39;0 1px 2px rgba(0, 0, 0, 0.05)&#39;</span><span class="op">,</span></span>
<span id="cb397-78"><a href="#cb397-78" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-md&#39;</span><span class="op">:</span> <span class="st">&#39;0 4px 6px rgba(0, 0, 0, 0.1)&#39;</span><span class="op">,</span></span>
<span id="cb397-79"><a href="#cb397-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-lg&#39;</span><span class="op">:</span> <span class="st">&#39;0 10px 15px rgba(0, 0, 0, 0.1)&#39;</span><span class="op">,</span></span>
<span id="cb397-80"><a href="#cb397-80" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb397-81"><a href="#cb397-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-82"><a href="#cb397-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Register dark theme</span></span>
<span id="cb397-83"><a href="#cb397-83" aria-hidden="true" tabindex="-1"></a>themeManager<span class="op">.</span><span class="fu">registerTheme</span>(<span class="st">&#39;dark&#39;</span><span class="op">,</span> {</span>
<span id="cb397-84"><a href="#cb397-84" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-primary&#39;</span><span class="op">:</span> <span class="st">&#39;#4d9fff&#39;</span><span class="op">,</span></span>
<span id="cb397-85"><a href="#cb397-85" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#6c757d&#39;</span><span class="op">,</span></span>
<span id="cb397-86"><a href="#cb397-86" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-success&#39;</span><span class="op">:</span> <span class="st">&#39;#28a745&#39;</span><span class="op">,</span></span>
<span id="cb397-87"><a href="#cb397-87" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-danger&#39;</span><span class="op">:</span> <span class="st">&#39;#dc3545&#39;</span><span class="op">,</span></span>
<span id="cb397-88"><a href="#cb397-88" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-warning&#39;</span><span class="op">:</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span></span>
<span id="cb397-89"><a href="#cb397-89" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-info&#39;</span><span class="op">:</span> <span class="st">&#39;#17a2b8&#39;</span><span class="op">,</span></span>
<span id="cb397-90"><a href="#cb397-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-91"><a href="#cb397-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-text&#39;</span><span class="op">:</span> <span class="st">&#39;#e9ecef&#39;</span><span class="op">,</span></span>
<span id="cb397-92"><a href="#cb397-92" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-text-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#adb5bd&#39;</span><span class="op">,</span></span>
<span id="cb397-93"><a href="#cb397-93" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-bg&#39;</span><span class="op">:</span> <span class="st">&#39;#212529&#39;</span><span class="op">,</span></span>
<span id="cb397-94"><a href="#cb397-94" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-bg-secondary&#39;</span><span class="op">:</span> <span class="st">&#39;#343a40&#39;</span><span class="op">,</span></span>
<span id="cb397-95"><a href="#cb397-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-96"><a href="#cb397-96" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--border-color&#39;</span><span class="op">:</span> <span class="st">&#39;#495057&#39;</span><span class="op">,</span></span>
<span id="cb397-97"><a href="#cb397-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-98"><a href="#cb397-98" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-sm&#39;</span><span class="op">:</span> <span class="st">&#39;0 1px 2px rgba(0, 0, 0, 0.3)&#39;</span><span class="op">,</span></span>
<span id="cb397-99"><a href="#cb397-99" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-md&#39;</span><span class="op">:</span> <span class="st">&#39;0 4px 6px rgba(0, 0, 0, 0.4)&#39;</span><span class="op">,</span></span>
<span id="cb397-100"><a href="#cb397-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--shadow-lg&#39;</span><span class="op">:</span> <span class="st">&#39;0 10px 15px rgba(0, 0, 0, 0.4)&#39;</span><span class="op">,</span></span>
<span id="cb397-101"><a href="#cb397-101" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb397-102"><a href="#cb397-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-103"><a href="#cb397-103" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply saved theme or default</span></span>
<span id="cb397-104"><a href="#cb397-104" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> savedTheme <span class="op">=</span> localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;theme&#39;</span>) <span class="op">||</span> <span class="st">&#39;default&#39;</span><span class="op">;</span></span>
<span id="cb397-105"><a href="#cb397-105" aria-hidden="true" tabindex="-1"></a>themeManager<span class="op">.</span><span class="fu">applyTheme</span>(savedTheme)<span class="op">;</span></span></code></pre></div>
<p><strong>Theme switcher component:</strong></p>
<div class="sourceCode" id="cb398"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ThemeSwitcher <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span>(<span class="st">&#39;./theme-manager.js&#39;</span>)<span class="op">.</span><span class="fu">then</span>(({ themeManager }) <span class="kw">=&gt;</span> {</span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">themeManager</span> <span class="op">=</span> themeManager<span class="op">;</span></span>
<span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb398-6"><a href="#cb398-6" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb398-7"><a href="#cb398-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb398-8"><a href="#cb398-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-9"><a href="#cb398-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb398-10"><a href="#cb398-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> themes <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">themeManager</span><span class="op">.</span><span class="fu">getAvailableThemes</span>()<span class="op">;</span></span>
<span id="cb398-11"><a href="#cb398-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> current <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">themeManager</span><span class="op">.</span><span class="fu">getCurrentTheme</span>()<span class="op">;</span></span>
<span id="cb398-12"><a href="#cb398-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-13"><a href="#cb398-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb398-14"><a href="#cb398-14" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb398-15"><a href="#cb398-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        .theme-switcher {</span></span>
<span id="cb398-16"><a href="#cb398-16" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: inline-flex;</span></span>
<span id="cb398-17"><a href="#cb398-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb398-18"><a href="#cb398-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb398-19"><a href="#cb398-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-20"><a href="#cb398-20" aria-hidden="true" tabindex="-1"></a><span class="vs">        .theme-button {</span></span>
<span id="cb398-21"><a href="#cb398-21" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 1rem;</span></span>
<span id="cb398-22"><a href="#cb398-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid var(--border-color);</span></span>
<span id="cb398-23"><a href="#cb398-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: var(--border-radius);</span></span>
<span id="cb398-24"><a href="#cb398-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--color-bg);</span></span>
<span id="cb398-25"><a href="#cb398-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: var(--color-text);</span></span>
<span id="cb398-26"><a href="#cb398-26" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb398-27"><a href="#cb398-27" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb398-28"><a href="#cb398-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-29"><a href="#cb398-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        .theme-button.active {</span></span>
<span id="cb398-30"><a href="#cb398-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: var(--color-primary);</span></span>
<span id="cb398-31"><a href="#cb398-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb398-32"><a href="#cb398-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-color: var(--color-primary);</span></span>
<span id="cb398-33"><a href="#cb398-33" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb398-34"><a href="#cb398-34" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb398-35"><a href="#cb398-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-36"><a href="#cb398-36" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;theme-switcher&quot;&gt;</span></span>
<span id="cb398-37"><a href="#cb398-37" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>themes<span class="op">.</span><span class="fu">map</span>(theme <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb398-38"><a href="#cb398-38" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button</span></span>
<span id="cb398-39"><a href="#cb398-39" aria-hidden="true" tabindex="-1"></a><span class="vs">            class=&quot;theme-button </span><span class="sc">${</span>theme <span class="op">===</span> current <span class="op">?</span> <span class="st">&#39;active&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb398-40"><a href="#cb398-40" aria-hidden="true" tabindex="-1"></a><span class="vs">            data-theme=&quot;</span><span class="sc">${</span>theme<span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb398-41"><a href="#cb398-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          &gt;</span></span>
<span id="cb398-42"><a href="#cb398-42" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>theme<span class="sc">}</span></span>
<span id="cb398-43"><a href="#cb398-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/button&gt;</span></span>
<span id="cb398-44"><a href="#cb398-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb398-45"><a href="#cb398-45" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb398-46"><a href="#cb398-46" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb398-47"><a href="#cb398-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-48"><a href="#cb398-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add event listeners</span></span>
<span id="cb398-49"><a href="#cb398-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.theme-button&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(btn <span class="kw">=&gt;</span> {</span>
<span id="cb398-50"><a href="#cb398-50" aria-hidden="true" tabindex="-1"></a>      btn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb398-51"><a href="#cb398-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> theme <span class="op">=</span> btn<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">theme</span><span class="op">;</span></span>
<span id="cb398-52"><a href="#cb398-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">themeManager</span><span class="op">.</span><span class="fu">applyTheme</span>(theme)<span class="op">;</span></span>
<span id="cb398-53"><a href="#cb398-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb398-54"><a href="#cb398-54" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb398-55"><a href="#cb398-55" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb398-56"><a href="#cb398-56" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb398-57"><a href="#cb398-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb398-58"><a href="#cb398-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-59"><a href="#cb398-59" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;theme-switcher&#39;</span><span class="op">,</span> ThemeSwitcher)<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.9" id="publishing-to-npm"><span
class="header-section-number">17.9</span> Publishing to npm</h2>
<p>Prepare your library for npm:</p>
<p><strong>1. package.json configuration:</strong></p>
<div class="sourceCode" id="cb399"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;@myorg/larc-components&quot;</span><span class="fu">,</span></span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;LARC component library&quot;</span><span class="fu">,</span></span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;module&quot;</span><span class="fu">,</span></span>
<span id="cb399-6"><a href="#cb399-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;./index.js&quot;</span><span class="fu">,</span></span>
<span id="cb399-7"><a href="#cb399-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exports&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-8"><a href="#cb399-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;.&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-9"><a href="#cb399-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;import&quot;</span><span class="fu">:</span> <span class="st">&quot;./index.js&quot;</span><span class="fu">,</span></span>
<span id="cb399-10"><a href="#cb399-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;types&quot;</span><span class="fu">:</span> <span class="st">&quot;./index.d.ts&quot;</span></span>
<span id="cb399-11"><a href="#cb399-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb399-12"><a href="#cb399-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;./dialog&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-13"><a href="#cb399-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;import&quot;</span><span class="fu">:</span> <span class="st">&quot;./components/core/pan-dialog.js&quot;</span><span class="fu">,</span></span>
<span id="cb399-14"><a href="#cb399-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;types&quot;</span><span class="fu">:</span> <span class="st">&quot;./components/core/pan-dialog.d.ts&quot;</span></span>
<span id="cb399-15"><a href="#cb399-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb399-16"><a href="#cb399-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;./button&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-17"><a href="#cb399-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;import&quot;</span><span class="fu">:</span> <span class="st">&quot;./components/core/pan-button.js&quot;</span></span>
<span id="cb399-18"><a href="#cb399-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb399-19"><a href="#cb399-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;./themes/*&quot;</span><span class="fu">:</span> <span class="st">&quot;./themes/*&quot;</span></span>
<span id="cb399-20"><a href="#cb399-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb399-21"><a href="#cb399-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;files&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb399-22"><a href="#cb399-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;components/&quot;</span><span class="ot">,</span></span>
<span id="cb399-23"><a href="#cb399-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;themes/&quot;</span><span class="ot">,</span></span>
<span id="cb399-24"><a href="#cb399-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;index.js&quot;</span><span class="ot">,</span></span>
<span id="cb399-25"><a href="#cb399-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;README.md&quot;</span></span>
<span id="cb399-26"><a href="#cb399-26" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb399-27"><a href="#cb399-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb399-28"><a href="#cb399-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;web-components&quot;</span><span class="ot">,</span></span>
<span id="cb399-29"><a href="#cb399-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;larc&quot;</span><span class="ot">,</span></span>
<span id="cb399-30"><a href="#cb399-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;components&quot;</span><span class="ot">,</span></span>
<span id="cb399-31"><a href="#cb399-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ui&quot;</span></span>
<span id="cb399-32"><a href="#cb399-32" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb399-33"><a href="#cb399-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;customElements&quot;</span><span class="fu">:</span> <span class="st">&quot;custom-elements.json&quot;</span><span class="fu">,</span></span>
<span id="cb399-34"><a href="#cb399-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-35"><a href="#cb399-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;web-test-runner </span><span class="ch">\&quot;</span><span class="st">components/**/*.test.js</span><span class="ch">\&quot;</span><span class="st">&quot;</span><span class="fu">,</span></span>
<span id="cb399-36"><a href="#cb399-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;analyze&quot;</span><span class="fu">:</span> <span class="st">&quot;wca analyze </span><span class="ch">\&quot;</span><span class="st">components/**/*.js</span><span class="ch">\&quot;</span><span class="st"> --outFile custom-elements.json&quot;</span><span class="fu">,</span></span>
<span id="cb399-37"><a href="#cb399-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prepublishOnly&quot;</span><span class="fu">:</span> <span class="st">&quot;npm test &amp;&amp; npm run analyze&quot;</span></span>
<span id="cb399-38"><a href="#cb399-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb399-39"><a href="#cb399-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;repository&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb399-40"><a href="#cb399-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;git&quot;</span><span class="fu">,</span></span>
<span id="cb399-41"><a href="#cb399-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/myorg/larc-components&quot;</span></span>
<span id="cb399-42"><a href="#cb399-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb399-43"><a href="#cb399-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;license&quot;</span><span class="fu">:</span> <span class="st">&quot;MIT&quot;</span></span>
<span id="cb399-44"><a href="#cb399-44" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>2. Create README.md:</strong></p>
<div class="sourceCode" id="cb400"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># @myorg/larc-components</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>A collection of accessible, themeable web components built with LARC.</span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## Installation</span></span>
<span id="cb400-6"><a href="#cb400-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-7"><a href="#cb400-7" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb400-8"><a href="#cb400-8" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install @myorg/larc-components</span></code></pre></div>
<h2 data-number="17.10" id="usage"><span
class="header-section-number">17.10</span> Usage</h2>
<h3 data-number="17.10.1" id="import-all-components"><span
class="header-section-number">17.10.1</span> Import all components</h3>
<div class="sourceCode" id="cb401"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;@myorg/larc-components&#39;</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="17.10.2" id="import-specific-components"><span
class="header-section-number">17.10.2</span> Import specific
components</h3>
<div class="sourceCode" id="cb402"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;@myorg/larc-components/dialog&#39;</span><span class="op">;</span></span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;@myorg/larc-components/button&#39;</span><span class="op">;</span></span></code></pre></div>
<h3 data-number="17.10.3" id="use-in-html"><span
class="header-section-number">17.10.3</span> Use in HTML</h3>
<div class="sourceCode" id="cb403"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-dialog</span><span class="ot"> open title</span><span class="op">=</span><span class="st">&quot;Example&quot;</span><span class="dt">&gt;</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Dialog content<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">pan-dialog</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="17.11" id="theming"><span
class="header-section-number">17.11</span> Theming</h2>
<div class="sourceCode" id="cb404"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { themeManager } <span class="im">from</span> <span class="st">&#39;@myorg/larc-components/themes/theme-manager.js&#39;</span><span class="op">;</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply dark theme</span></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>themeManager<span class="op">.</span><span class="fu">applyTheme</span>(<span class="st">&#39;dark&#39;</span>)<span class="op">;</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Register custom theme</span></span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a>themeManager<span class="op">.</span><span class="fu">registerTheme</span>(<span class="st">&#39;custom&#39;</span><span class="op">,</span> {</span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;--color-primary&#39;</span><span class="op">:</span> <span class="st">&#39;#ff0000&#39;</span><span class="op">,</span></span>
<span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...more tokens</span></span>
<span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.12" id="components"><span
class="header-section-number">17.12</span> Components</h2>
<ul>
<li><code>&lt;pan-dialog&gt;</code> - Modal dialog</li>
<li><code>&lt;pan-button&gt;</code> - Button component</li>
<li><code>&lt;pan-card&gt;</code> - Card container</li>
<li>More coming soon…</li>
</ul>
<h2 data-number="17.13" id="license"><span
class="header-section-number">17.13</span> License</h2>
<p>MIT</p>
<pre><code>
**3. Publish:**

```bash
# Login to npm
npm login

# Publish (first time)
npm publish --access public

# Publish update
npm version patch  # or minor, major
npm publish</code></pre>
<h2 data-number="17.14" id="version-management-1"><span
class="header-section-number">17.14</span> Version Management</h2>
<p>Follow semantic versioning and maintain a changelog:</p>
<div class="sourceCode" id="cb406"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Changelog</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>All notable changes to this project will be documented in this file.</span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## [1.2.0] - 2024-01-15</span></span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a><span class="fu">### Added</span></span>
<span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>New <span class="in">`&lt;pan-dialog&gt;`</span> component with full accessibility support</span>
<span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dark theme support</span>
<span id="cb406-10"><a href="#cb406-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>CSS parts for style customization</span>
<span id="cb406-11"><a href="#cb406-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-12"><a href="#cb406-12" aria-hidden="true" tabindex="-1"></a><span class="fu">### Changed</span></span>
<span id="cb406-13"><a href="#cb406-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Improved button component focus styles</span>
<span id="cb406-14"><a href="#cb406-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Updated default theme colors</span>
<span id="cb406-15"><a href="#cb406-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-16"><a href="#cb406-16" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fixed</span></span>
<span id="cb406-17"><a href="#cb406-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Fixed focus trap in dialog component</span>
<span id="cb406-18"><a href="#cb406-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Fixed memory leak in theme manager</span>
<span id="cb406-19"><a href="#cb406-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-20"><a href="#cb406-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## [1.1.0] - 2024-01-01</span></span>
<span id="cb406-21"><a href="#cb406-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-22"><a href="#cb406-22" aria-hidden="true" tabindex="-1"></a><span class="fu">### Added</span></span>
<span id="cb406-23"><a href="#cb406-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>New <span class="in">`&lt;pan-card&gt;`</span> component</span>
<span id="cb406-24"><a href="#cb406-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Theme switcher component</span>
<span id="cb406-25"><a href="#cb406-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-26"><a href="#cb406-26" aria-hidden="true" tabindex="-1"></a><span class="fu">### Changed</span></span>
<span id="cb406-27"><a href="#cb406-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Breaking: Renamed <span class="in">`variant`</span> to <span class="in">`type`</span> in button component</span>
<span id="cb406-28"><a href="#cb406-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-29"><a href="#cb406-29" aria-hidden="true" tabindex="-1"></a><span class="fu">### Migration Guide</span></span>
<span id="cb406-30"><a href="#cb406-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-31"><a href="#cb406-31" aria-hidden="true" tabindex="-1"></a>Update button variant attribute:</span>
<span id="cb406-32"><a href="#cb406-32" aria-hidden="true" tabindex="-1"></a><span class="in">```html</span></span>
<span id="cb406-33"><a href="#cb406-33" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Before --&gt;</span></span>
<span id="cb406-34"><a href="#cb406-34" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-button</span><span class="ot"> variant</span><span class="op">=</span><span class="st">&quot;primary&quot;</span><span class="dt">&gt;</span>Click<span class="dt">&lt;/</span><span class="kw">pan-button</span><span class="dt">&gt;</span></span>
<span id="cb406-35"><a href="#cb406-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-36"><a href="#cb406-36" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- After --&gt;</span></span>
<span id="cb406-37"><a href="#cb406-37" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">pan-button</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;primary&quot;</span><span class="dt">&gt;</span>Click<span class="dt">&lt;/</span><span class="kw">pan-button</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="17.15" id="section"><span
class="header-section-number">17.15</span> [1.0.0] - 2023-12-01</h2>
<ul>
<li>Initial release</li>
</ul>
<pre><code>
## Component API Design Patterns

Design consistent, predictable component APIs:

**1. Boolean attributes:**

```javascript
// ✅ Good: Use presence/absence
&lt;pan-dialog open&gt;&lt;/pan-dialog&gt;
&lt;pan-button disabled&gt;&lt;/pan-button&gt;

// ❌ Bad: Use string values
&lt;pan-dialog open=&quot;true&quot;&gt;&lt;/pan-dialog&gt;</code></pre>
<p><strong>2. Enum attributes:</strong></p>
<div class="sourceCode" id="cb408"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Use lowercase, hyphenated</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>pan<span class="op">-</span>button variant<span class="op">=</span><span class="st">&quot;primary&quot;</span><span class="op">&gt;&lt;/</span>pan<span class="op">-</span>button<span class="op">&gt;</span></span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>pan<span class="op">-</span>input type<span class="op">=</span><span class="st">&quot;email&quot;</span><span class="op">&gt;&lt;/</span>pan<span class="op">-</span>input<span class="op">&gt;</span></span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Use camelCase or weird casing</span></span>
<span id="cb408-6"><a href="#cb408-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>pan<span class="op">-</span>button variant<span class="op">=</span><span class="st">&quot;Primary&quot;</span><span class="op">&gt;&lt;/</span>pan<span class="op">-</span>button<span class="op">&gt;</span></span></code></pre></div>
<p><strong>3. Event naming:</strong></p>
<div class="sourceCode" id="cb409"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Use present tense for state changes</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a>element<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;open&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {})<span class="op">;</span></span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>element<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {})<span class="op">;</span></span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-5"><a href="#cb409-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Use past tense for completed actions</span></span>
<span id="cb409-6"><a href="#cb409-6" aria-hidden="true" tabindex="-1"></a>element<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;loaded&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {})<span class="op">;</span></span>
<span id="cb409-7"><a href="#cb409-7" aria-hidden="true" tabindex="-1"></a>element<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;changed&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {})<span class="op">;</span></span></code></pre></div>
<p><strong>4. CSS custom properties:</strong></p>
<div class="sourceCode" id="cb410"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Namespace and descriptive</span></span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>dialog<span class="op">-</span>width</span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>button<span class="op">-</span>primary<span class="op">-</span>bg</span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>card<span class="op">-</span>border<span class="op">-</span>radius</span>
<span id="cb410-5"><a href="#cb410-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb410-6"><a href="#cb410-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Generic or unclear</span></span>
<span id="cb410-7"><a href="#cb410-7" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>width</span>
<span id="cb410-8"><a href="#cb410-8" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>bg</span>
<span id="cb410-9"><a href="#cb410-9" aria-hidden="true" tabindex="-1"></a><span class="op">--</span>radius</span></code></pre></div>
<p><strong>5. Slots:</strong></p>
<div class="sourceCode" id="cb411"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Named slots for specific content</span></span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>slot name<span class="op">=</span><span class="st">&quot;header&quot;</span><span class="op">&gt;&lt;/</span>slot<span class="op">&gt;</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>slot name<span class="op">=</span><span class="st">&quot;footer&quot;</span><span class="op">&gt;&lt;/</span>slot<span class="op">&gt;</span></span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>slot<span class="op">&gt;&lt;/</span>slot<span class="op">&gt;</span>  <span class="co">// default slot</span></span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Too many unnamed slots</span></span></code></pre></div>
<h2 data-number="17.16" id="troubleshooting-component-libraries"><span
class="header-section-number">17.16</span> Troubleshooting Component
Libraries</h2>
<h3 data-number="17.16.1"
id="problem-1-styles-bleeding-between-components"><span
class="header-section-number">17.16.1</span> Problem 1: Styles Bleeding
Between Components</h3>
<p><strong>Symptoms</strong>: Components inherit unwanted styles from
global CSS or other components.</p>
<p><strong>Cause</strong>: Not using Shadow DOM or improperly scoped
styles.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb412"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Always use Shadow DOM for encapsulation</span></span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span>  <span class="co">// ← Critical!</span></span>
<span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb412-7"><a href="#cb412-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb412-8"><a href="#cb412-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb412-9"><a href="#cb412-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb412-10"><a href="#cb412-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb412-11"><a href="#cb412-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        /* These styles won&#39;t leak out */</span></span>
<span id="cb412-12"><a href="#cb412-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb412-13"><a href="#cb412-13" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb412-14"><a href="#cb412-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb412-15"><a href="#cb412-15" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb412-16"><a href="#cb412-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;content&quot;&gt;</span></span>
<span id="cb412-17"><a href="#cb412-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;slot&gt;&lt;/slot&gt;</span></span>
<span id="cb412-18"><a href="#cb412-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb412-19"><a href="#cb412-19" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb412-20"><a href="#cb412-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb412-21"><a href="#cb412-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.16.2"
id="problem-2-components-not-updating-when-attributes-change"><span
class="header-section-number">17.16.2</span> Problem 2: Components Not
Updating When Attributes Change</h3>
<p><strong>Symptoms</strong>: Changing attributes doesn’t update the
component.</p>
<p><strong>Cause</strong>: Not implementing
<code>observedAttributes</code> or
<code>attributeChangedCallback</code>.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb413"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ✅ Declare which attributes to watch</span></span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;value&#39;</span><span class="op">,</span> <span class="st">&#39;disabled&#39;</span>]<span class="op">;</span></span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (oldValue <span class="op">===</span> newValue) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle attribute change</span></span>
<span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;value&#39;</span>) {</span>
<span id="cb413-10"><a href="#cb413-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateValue</span>(newValue)<span class="op">;</span></span>
<span id="cb413-11"><a href="#cb413-11" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;disabled&#39;</span>) {</span>
<span id="cb413-12"><a href="#cb413-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">updateDisabledState</span>(newValue <span class="op">!==</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb413-13"><a href="#cb413-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb413-14"><a href="#cb413-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb413-15"><a href="#cb413-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.16.3"
id="problem-3-memory-leaks-in-components"><span
class="header-section-number">17.16.3</span> Problem 3: Memory Leaks in
Components</h3>
<p><strong>Symptoms</strong>: Memory usage grows over time, especially
when components are added/removed.</p>
<p><strong>Cause</strong>: Event listeners not cleaned up.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb414"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb414-3"><a href="#cb414-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store handler reference</span></span>
<span id="cb414-4"><a href="#cb414-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_resizeHandler</span> <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">handleResize</span>()<span class="op">;</span></span>
<span id="cb414-5"><a href="#cb414-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">_resizeHandler</span>)<span class="op">;</span></span>
<span id="cb414-6"><a href="#cb414-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-7"><a href="#cb414-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">_panSubscriptionId</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;data.updated&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb414-8"><a href="#cb414-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">refresh</span>()<span class="op">;</span></span>
<span id="cb414-9"><a href="#cb414-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb414-10"><a href="#cb414-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb414-11"><a href="#cb414-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-12"><a href="#cb414-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb414-13"><a href="#cb414-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Clean up everything</span></span>
<span id="cb414-14"><a href="#cb414-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">removeEventListener</span>(<span class="st">&#39;resize&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">_resizeHandler</span>)<span class="op">;</span></span>
<span id="cb414-15"><a href="#cb414-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-16"><a href="#cb414-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">_panSubscriptionId</span>) {</span>
<span id="cb414-17"><a href="#cb414-17" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">unsubscribe</span>(<span class="kw">this</span><span class="op">.</span><span class="at">_panSubscriptionId</span>)<span class="op">;</span></span>
<span id="cb414-18"><a href="#cb414-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb414-19"><a href="#cb414-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb414-20"><a href="#cb414-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="17.16.4"
id="problem-4-slow-component-registration"><span
class="header-section-number">17.16.4</span> Problem 4: Slow Component
Registration</h3>
<p><strong>Symptoms</strong>: Initial page load is slow when many
components are imported.</p>
<p><strong>Cause</strong>: Importing all components upfront.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb415"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Bad: Import everything upfront</span></span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/dialog.js&#39;</span><span class="op">;</span></span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/button.js&#39;</span><span class="op">;</span></span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./components/card.js&#39;</span><span class="op">;</span></span>
<span id="cb415-5"><a href="#cb415-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ... 50 more imports</span></span>
<span id="cb415-6"><a href="#cb415-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-7"><a href="#cb415-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Good: Lazy load on demand</span></span>
<span id="cb415-8"><a href="#cb415-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> componentRegistry <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>([</span>
<span id="cb415-9"><a href="#cb415-9" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&#39;pan-dialog&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./components/dialog.js&#39;</span>)]<span class="op">,</span></span>
<span id="cb415-10"><a href="#cb415-10" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&#39;pan-button&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./components/button.js&#39;</span>)]<span class="op">,</span></span>
<span id="cb415-11"><a href="#cb415-11" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&#39;pan-card&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./components/card.js&#39;</span>)]</span>
<span id="cb415-12"><a href="#cb415-12" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb415-13"><a href="#cb415-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-14"><a href="#cb415-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Auto-load when component is used</span></span>
<span id="cb415-15"><a href="#cb415-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> observer <span class="op">=</span> <span class="kw">new</span> <span class="bu">MutationObserver</span>((mutations) <span class="kw">=&gt;</span> {</span>
<span id="cb415-16"><a href="#cb415-16" aria-hidden="true" tabindex="-1"></a>  mutations<span class="op">.</span><span class="fu">forEach</span>(mutation <span class="kw">=&gt;</span> {</span>
<span id="cb415-17"><a href="#cb415-17" aria-hidden="true" tabindex="-1"></a>    mutation<span class="op">.</span><span class="at">addedNodes</span><span class="op">.</span><span class="fu">forEach</span>(node <span class="kw">=&gt;</span> {</span>
<span id="cb415-18"><a href="#cb415-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (node<span class="op">.</span><span class="at">nodeType</span> <span class="op">===</span> <span class="dv">1</span>) {</span>
<span id="cb415-19"><a href="#cb415-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tagName <span class="op">=</span> node<span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb415-20"><a href="#cb415-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (componentRegistry<span class="op">.</span><span class="fu">has</span>(tagName)) {</span>
<span id="cb415-21"><a href="#cb415-21" aria-hidden="true" tabindex="-1"></a>          componentRegistry<span class="op">.</span><span class="fu">get</span>(tagName)()<span class="op">;</span></span>
<span id="cb415-22"><a href="#cb415-22" aria-hidden="true" tabindex="-1"></a>          componentRegistry<span class="op">.</span><span class="fu">delete</span>(tagName)<span class="op">;</span>  <span class="co">// Load once</span></span>
<span id="cb415-23"><a href="#cb415-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb415-24"><a href="#cb415-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb415-25"><a href="#cb415-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb415-26"><a href="#cb415-26" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb415-27"><a href="#cb415-27" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb415-28"><a href="#cb415-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-29"><a href="#cb415-29" aria-hidden="true" tabindex="-1"></a>observer<span class="op">.</span><span class="fu">observe</span>(<span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">,</span> {</span>
<span id="cb415-30"><a href="#cb415-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">childList</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb415-31"><a href="#cb415-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">subtree</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb415-32"><a href="#cb415-32" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="17.17" id="component-library-best-practices"><span
class="header-section-number">17.17</span> Component Library Best
Practices</h2>
<ol type="1">
<li><p><strong>Always Use Shadow DOM</strong>: Encapsulate styles and
prevent leakage.</p></li>
<li><p><strong>Document Everything</strong>: Use JSDoc comments for all
public APIs.</p></li>
<li><p><strong>Test Thoroughly</strong>: Unit tests, accessibility
tests, and visual regression tests.</p></li>
<li><p><strong>Follow Web Standards</strong>: Use standard HTML
attributes and patterns when possible.</p></li>
<li><p><strong>Make Components Composable</strong>: Small, focused
components that work well together.</p></li>
<li><p><strong>Provide Customization</strong>: CSS parts, custom
properties, and slots for flexibility.</p></li>
<li><p><strong>Accessibility First</strong>: Always include ARIA
attributes, keyboard navigation, and focus management.</p></li>
<li><p><strong>Version Carefully</strong>: Follow semantic versioning
and provide migration guides for breaking changes.</p></li>
<li><p><strong>Optimize Performance</strong>: Lazy load components,
clean up resources, avoid unnecessary re-renders.</p></li>
<li><p><strong>Maintain Consistency</strong>: Use consistent naming,
patterns, and behaviors across all components.</p></li>
</ol>
<h2 data-number="17.18" id="hands-on-exercises-2"><span
class="header-section-number">17.18</span> Hands-On Exercises</h2>
<h3 data-number="17.18.1"
id="exercise-1-build-a-toast-notification-component"><span
class="header-section-number">17.18.1</span> Exercise 1: Build a Toast
Notification Component</h3>
<p>Create a <code>&lt;pan-toast&gt;</code> component that:</p>
<ul>
<li>Shows temporary notifications</li>
<li>Supports different types (success, error, warning, info)</li>
<li>Auto-dismisses after a timeout</li>
<li>Stacks multiple toasts</li>
<li>Has accessible announcements (aria-live)</li>
</ul>
<p><strong>Bonus</strong>: Add slide-in animations and a queue
system.</p>
<h3 data-number="17.18.2"
id="exercise-2-create-a-component-documentation-site"><span
class="header-section-number">17.18.2</span> Exercise 2: Create a
Component Documentation Site</h3>
<p>Build an interactive documentation site for your components that:</p>
<ul>
<li>Shows live examples with editable code</li>
<li>Displays component API (props, events, slots)</li>
<li>Includes accessibility information</li>
<li>Has a theme switcher</li>
<li>Provides copy-paste code snippets</li>
</ul>
<p><strong>Bonus</strong>: Generate documentation from JSDoc comments
automatically.</p>
<h3 data-number="17.18.3"
id="exercise-3-implement-a-component-testing-suite"><span
class="header-section-number">17.18.3</span> Exercise 3: Implement a
Component Testing Suite</h3>
<p>Set up comprehensive testing for a component:</p>
<ul>
<li>Unit tests for all functionality</li>
<li>Accessibility tests (keyboard nav, screen readers)</li>
<li>Visual regression tests with screenshots</li>
<li>Performance tests (render time)</li>
<li>Cross-browser testing</li>
</ul>
<p><strong>Bonus</strong>: Integrate tests into CI/CD pipeline.</p>
<h3 data-number="17.18.4"
id="exercise-4-publish-a-component-package"><span
class="header-section-number">17.18.4</span> Exercise 4: Publish a
Component Package</h3>
<p>Package and publish a component library:</p>
<ul>
<li>Set up proper package.json with exports</li>
<li>Create comprehensive README</li>
<li>Write CHANGELOG.md</li>
<li>Publish to npm</li>
<li>Set up automated versioning and releases</li>
</ul>
<p><strong>Bonus</strong>: Create a landing page with examples and
documentation.</p>
<h2 data-number="17.19" id="summary-16"><span
class="header-section-number">17.19</span> Summary</h2>
<p>Building a component library is about more than just writing
components—it’s about creating a sustainable system:</p>
<ul>
<li><strong>Organize logically</strong>: Group related components, use
consistent naming</li>
<li><strong>Document thoroughly</strong>: Every component, prop, event,
and slot</li>
<li><strong>Test comprehensively</strong>: Unit, integration,
accessibility, visual</li>
<li><strong>Theme consistently</strong>: Design tokens and CSS custom
properties</li>
<li><strong>Version carefully</strong>: Semantic versioning with clear
changelogs</li>
<li><strong>Distribute effectively</strong>: npm, CDN, or monorepo</li>
</ul>
<p>A well-maintained component library accelerates development and
ensures consistency across your applications.</p>
<h2 data-number="17.20" id="further-reading-16"><span
class="header-section-number">17.20</span> Further Reading</h2>
<ul>
<li><strong>Building with LARC - Chapter 15 (Component
Patterns)</strong>: Advanced component architecture</li>
<li><strong>Building with LARC - Chapter 5 (Shadow DOM)</strong>: Deep
dive into encapsulation</li>
<li><strong>Building with LARC - Chapter 10 (Accessibility)</strong>:
Making components accessible</li>
</ul>
<div class="pagebreak">

</div>
<h1 data-number="18" id="tooling"><span
class="header-section-number">18</span> Tooling</h1>
<p>While LARC doesn’t require a build step, the right tools make
development faster and more enjoyable.</p>
<h2 data-number="18.1" id="development-server"><span
class="header-section-number">18.1</span> Development Server</h2>
<p>A simple development server with live reload:</p>
<div class="sourceCode" id="cb416"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a><span class="co">// dev-server.js</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> http <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;http&#39;</span>)<span class="op">;</span></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)<span class="op">;</span></span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> path <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></span>
<span id="cb416-5"><a href="#cb416-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">WebSocket</span> <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;ws&#39;</span>)<span class="op">;</span></span>
<span id="cb416-6"><a href="#cb416-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-7"><a href="#cb416-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></span>
<span id="cb416-8"><a href="#cb416-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PUBLIC_DIR <span class="op">=</span> <span class="st">&#39;./public&#39;</span><span class="op">;</span></span>
<span id="cb416-9"><a href="#cb416-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-10"><a href="#cb416-10" aria-hidden="true" tabindex="-1"></a><span class="co">// HTTP Server</span></span>
<span id="cb416-11"><a href="#cb416-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> http<span class="op">.</span><span class="fu">createServer</span>((req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb416-12"><a href="#cb416-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> filePath <span class="op">=</span> path<span class="op">.</span><span class="fu">join</span>(PUBLIC_DIR<span class="op">,</span> req<span class="op">.</span><span class="at">url</span> <span class="op">===</span> <span class="st">&#39;/&#39;</span> <span class="op">?</span> <span class="st">&#39;index.html&#39;</span> <span class="op">:</span> req<span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb416-13"><a href="#cb416-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-14"><a href="#cb416-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ext <span class="op">=</span> path<span class="op">.</span><span class="fu">extname</span>(filePath)<span class="op">;</span></span>
<span id="cb416-15"><a href="#cb416-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contentTypes <span class="op">=</span> {</span>
<span id="cb416-16"><a href="#cb416-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.html&#39;</span><span class="op">:</span> <span class="st">&#39;text/html&#39;</span><span class="op">,</span></span>
<span id="cb416-17"><a href="#cb416-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.js&#39;</span><span class="op">:</span> <span class="st">&#39;application/javascript&#39;</span><span class="op">,</span></span>
<span id="cb416-18"><a href="#cb416-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.mjs&#39;</span><span class="op">:</span> <span class="st">&#39;application/javascript&#39;</span><span class="op">,</span></span>
<span id="cb416-19"><a href="#cb416-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.css&#39;</span><span class="op">:</span> <span class="st">&#39;text/css&#39;</span><span class="op">,</span></span>
<span id="cb416-20"><a href="#cb416-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;.json&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span></span>
<span id="cb416-21"><a href="#cb416-21" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb416-22"><a href="#cb416-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-23"><a href="#cb416-23" aria-hidden="true" tabindex="-1"></a>  fs<span class="op">.</span><span class="fu">readFile</span>(filePath<span class="op">,</span> (err<span class="op">,</span> content) <span class="kw">=&gt;</span> {</span>
<span id="cb416-24"><a href="#cb416-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err) {</span>
<span id="cb416-25"><a href="#cb416-25" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">404</span>)<span class="op">;</span></span>
<span id="cb416-26"><a href="#cb416-26" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">end</span>(<span class="st">&#39;Not found&#39;</span>)<span class="op">;</span></span>
<span id="cb416-27"><a href="#cb416-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb416-28"><a href="#cb416-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb416-29"><a href="#cb416-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-30"><a href="#cb416-30" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">200</span><span class="op">,</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> contentTypes[ext] <span class="op">||</span> <span class="st">&#39;text/plain&#39;</span> })<span class="op">;</span></span>
<span id="cb416-31"><a href="#cb416-31" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(content)<span class="op">;</span></span>
<span id="cb416-32"><a href="#cb416-32" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb416-33"><a href="#cb416-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb416-34"><a href="#cb416-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-35"><a href="#cb416-35" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket for live reload</span></span>
<span id="cb416-36"><a href="#cb416-36" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wss <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="fu">Server</span>({ server })<span class="op">;</span></span>
<span id="cb416-37"><a href="#cb416-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-38"><a href="#cb416-38" aria-hidden="true" tabindex="-1"></a>fs<span class="op">.</span><span class="fu">watch</span>(PUBLIC_DIR<span class="op">,</span> { <span class="dt">recursive</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb416-39"><a href="#cb416-39" aria-hidden="true" tabindex="-1"></a>  wss<span class="op">.</span><span class="at">clients</span><span class="op">.</span><span class="fu">forEach</span>(client <span class="kw">=&gt;</span> {</span>
<span id="cb416-40"><a href="#cb416-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (client<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="bu">WebSocket</span><span class="op">.</span><span class="at">OPEN</span>) {</span>
<span id="cb416-41"><a href="#cb416-41" aria-hidden="true" tabindex="-1"></a>      client<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;reload&#39;</span>)<span class="op">;</span></span>
<span id="cb416-42"><a href="#cb416-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb416-43"><a href="#cb416-43" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb416-44"><a href="#cb416-44" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb416-45"><a href="#cb416-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb416-46"><a href="#cb416-46" aria-hidden="true" tabindex="-1"></a>server<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Dev server at http://localhost:</span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></span></code></pre></div>
<p>Add live reload to your HTML:</p>
<div class="sourceCode" id="cb417"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> ws <span class="op">=</span> <span class="kw">new</span> <span class="bu">WebSocket</span>(<span class="st">&#39;ws://localhost:3000&#39;</span>)<span class="op">;</span></span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="at">onmessage</span> <span class="op">=</span> () <span class="kw">=&gt;</span> location<span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h2 data-number="18.2" id="vs-code-configuration"><span
class="header-section-number">18.2</span> VS Code Configuration</h2>
<p>Enhance your editor experience:</p>
<div class="sourceCode" id="cb418"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/settings.json</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.formatOnSave&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.defaultFormatter&quot;</span><span class="fu">:</span> <span class="st">&quot;esbenp.prettier-vscode&quot;</span><span class="fu">,</span></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;emmet.includeLanguages&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;javascript&quot;</span><span class="fu">:</span> <span class="st">&quot;html&quot;</span></span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;files.associations&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb418-9"><a href="#cb418-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;*.mjs&quot;</span><span class="fu">:</span> <span class="st">&quot;javascript&quot;</span></span>
<span id="cb418-10"><a href="#cb418-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb418-11"><a href="#cb418-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Useful snippets:</p>
<div class="sourceCode" id="cb419"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/snippets/larc.code-snippets</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;LARC Component&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;larc&quot;</span><span class="fu">,</span></span>
<span id="cb419-5"><a href="#cb419-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;body&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb419-6"><a href="#cb419-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;class ${1:ComponentName} extends HTMLElement {&quot;</span><span class="ot">,</span></span>
<span id="cb419-7"><a href="#cb419-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  constructor() {&quot;</span><span class="ot">,</span></span>
<span id="cb419-8"><a href="#cb419-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    super();&quot;</span><span class="ot">,</span></span>
<span id="cb419-9"><a href="#cb419-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.attachShadow({ mode: &#39;open&#39; });&quot;</span><span class="ot">,</span></span>
<span id="cb419-10"><a href="#cb419-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb419-11"><a href="#cb419-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb419-12"><a href="#cb419-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  connectedCallback() {&quot;</span><span class="ot">,</span></span>
<span id="cb419-13"><a href="#cb419-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.render();&quot;</span><span class="ot">,</span></span>
<span id="cb419-14"><a href="#cb419-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb419-15"><a href="#cb419-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb419-16"><a href="#cb419-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  render() {&quot;</span><span class="ot">,</span></span>
<span id="cb419-17"><a href="#cb419-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.shadowRoot.innerHTML = `&quot;</span><span class="ot">,</span></span>
<span id="cb419-18"><a href="#cb419-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;style&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb419-19"><a href="#cb419-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;        :host { display: block; }&quot;</span><span class="ot">,</span></span>
<span id="cb419-20"><a href="#cb419-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;/style&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb419-21"><a href="#cb419-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;div&gt;$2&lt;/div&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb419-22"><a href="#cb419-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    `;&quot;</span><span class="ot">,</span></span>
<span id="cb419-23"><a href="#cb419-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb419-24"><a href="#cb419-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;}&quot;</span><span class="ot">,</span></span>
<span id="cb419-25"><a href="#cb419-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb419-26"><a href="#cb419-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;customElements.define(&#39;${3:component-name}&#39;, ${1:ComponentName});&quot;</span></span>
<span id="cb419-27"><a href="#cb419-27" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb419-28"><a href="#cb419-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb419-29"><a href="#cb419-29" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="18.3" id="eslint-configuration"><span
class="header-section-number">18.3</span> ESLint Configuration</h2>
<p>Lint your code for consistency:</p>
<div class="sourceCode" id="cb420"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="co">// eslint.config.js</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> [</span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">files</span><span class="op">:</span> [<span class="st">&#39;**/*.js&#39;</span><span class="op">,</span> <span class="st">&#39;**/*.mjs&#39;</span>]<span class="op">,</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rules</span><span class="op">:</span> {</span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-unused-vars&#39;</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-console&#39;</span><span class="op">:</span> [<span class="st">&#39;warn&#39;</span><span class="op">,</span> { <span class="dt">allow</span><span class="op">:</span> [<span class="st">&#39;warn&#39;</span><span class="op">,</span> <span class="st">&#39;error&#39;</span>] }]<span class="op">,</span></span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;prefer-const&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-var&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span></span>
<span id="cb420-10"><a href="#cb420-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb420-11"><a href="#cb420-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb420-12"><a href="#cb420-12" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span></code></pre></div>
<h2 data-number="18.4" id="browser-devtools-1"><span
class="header-section-number">18.4</span> Browser DevTools</h2>
<p>Chrome DevTools has excellent Web Component support:</p>
<ul>
<li><strong>Elements panel</strong>: Inspect shadow DOM by clicking the
<code>#shadow-root</code> toggle</li>
<li><strong>Console</strong>: Access element’s shadow root with
<code>$0.shadowRoot</code></li>
<li><strong>Network panel</strong>: Monitor fetch requests and WebSocket
connections</li>
<li><strong>Performance panel</strong>: Profile render performance</li>
<li><strong>Application panel</strong>: Inspect localStorage,
sessionStorage, IndexedDB</li>
</ul>
<h2 data-number="18.5" id="debugging-pan-bus"><span
class="header-section-number">18.5</span> Debugging PAN Bus</h2>
<p>Add a debug utility:</p>
<div class="sourceCode" id="cb421"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="co">// pan-debug.js</span></span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (data<span class="op">,</span> topic) <span class="kw">=&gt;</span> {</span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[PAN] </span><span class="sc">${</span>topic<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Or use the LARC DevTools extension for a visual message
inspector.</p>
<h2 data-number="18.6" id="complete-development-environment-setup"><span
class="header-section-number">18.6</span> Complete Development
Environment Setup</h2>
<p>Let’s set up a full-featured development environment:</p>
<p><strong>1. Project structure:</strong></p>
<pre><code>my-larc-project/
├── public/
│   ├── index.html
│   ├── app.js
│   ├── components/
│   └── styles/
├── tests/
│   ├── unit/
│   └── e2e/
├── .vscode/
│   ├── settings.json
│   ├── extensions.json
│   └── snippets/
├── .eslintrc.js
├── .prettierrc
├── package.json
└── dev-server.js</code></pre>
<p><strong>2. Package.json with dev scripts:</strong></p>
<div class="sourceCode" id="cb423"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;my-larc-app&quot;</span><span class="fu">,</span></span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;module&quot;</span><span class="fu">,</span></span>
<span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;dev&quot;</span><span class="fu">:</span> <span class="st">&quot;node dev-server.js&quot;</span><span class="fu">,</span></span>
<span id="cb423-7"><a href="#cb423-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;web-test-runner </span><span class="ch">\&quot;</span><span class="st">tests/**/*.test.js</span><span class="ch">\&quot;</span><span class="st">&quot;</span><span class="fu">,</span></span>
<span id="cb423-8"><a href="#cb423-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;test:watch&quot;</span><span class="fu">:</span> <span class="st">&quot;npm test -- --watch&quot;</span><span class="fu">,</span></span>
<span id="cb423-9"><a href="#cb423-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;lint&quot;</span><span class="fu">:</span> <span class="st">&quot;eslint &#39;**/*.{js,mjs}&#39;&quot;</span><span class="fu">,</span></span>
<span id="cb423-10"><a href="#cb423-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;lint:fix&quot;</span><span class="fu">:</span> <span class="st">&quot;eslint &#39;**/*.{js,mjs}&#39; --fix&quot;</span><span class="fu">,</span></span>
<span id="cb423-11"><a href="#cb423-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;format&quot;</span><span class="fu">:</span> <span class="st">&quot;prettier --write &#39;**/*.{js,mjs,html,css,json,md}&#39;&quot;</span><span class="fu">,</span></span>
<span id="cb423-12"><a href="#cb423-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;format:check&quot;</span><span class="fu">:</span> <span class="st">&quot;prettier --check &#39;**/*.{js,mjs,html,css,json,md}&#39;&quot;</span><span class="fu">,</span></span>
<span id="cb423-13"><a href="#cb423-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;analyze&quot;</span><span class="fu">:</span> <span class="st">&quot;wca analyze &#39;public/components/**/*.js&#39; --outFile custom-elements.json&quot;</span></span>
<span id="cb423-14"><a href="#cb423-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb423-15"><a href="#cb423-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb423-16"><a href="#cb423-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@open-wc/testing&quot;</span><span class="fu">:</span> <span class="st">&quot;^4.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-17"><a href="#cb423-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@web/dev-server&quot;</span><span class="fu">:</span> <span class="st">&quot;^0.4.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-18"><a href="#cb423-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;@web/test-runner&quot;</span><span class="fu">:</span> <span class="st">&quot;^0.18.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-19"><a href="#cb423-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;eslint&quot;</span><span class="fu">:</span> <span class="st">&quot;^8.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-20"><a href="#cb423-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prettier&quot;</span><span class="fu">:</span> <span class="st">&quot;^3.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-21"><a href="#cb423-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;web-component-analyzer&quot;</span><span class="fu">:</span> <span class="st">&quot;^2.0.0&quot;</span><span class="fu">,</span></span>
<span id="cb423-22"><a href="#cb423-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;ws&quot;</span><span class="fu">:</span> <span class="st">&quot;^8.0.0&quot;</span></span>
<span id="cb423-23"><a href="#cb423-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb423-24"><a href="#cb423-24" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>3. Complete dev server with HMR:</strong></p>
<div class="sourceCode" id="cb424"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="co">// dev-server.js</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { createServer } <span class="im">from</span> <span class="st">&#39;http&#39;</span><span class="op">;</span></span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { readFile } <span class="im">from</span> <span class="st">&#39;fs/promises&#39;</span><span class="op">;</span></span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { watch } <span class="im">from</span> <span class="st">&#39;fs&#39;</span><span class="op">;</span></span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { join<span class="op">,</span> extname } <span class="im">from</span> <span class="st">&#39;path&#39;</span><span class="op">;</span></span>
<span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { WebSocketServer } <span class="im">from</span> <span class="st">&#39;ws&#39;</span><span class="op">;</span></span>
<span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3000</span><span class="op">;</span></span>
<span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PUBLIC_DIR <span class="op">=</span> <span class="st">&#39;./public&#39;</span><span class="op">;</span></span>
<span id="cb424-10"><a href="#cb424-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-11"><a href="#cb424-11" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> contentTypes <span class="op">=</span> {</span>
<span id="cb424-12"><a href="#cb424-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.html&#39;</span><span class="op">:</span> <span class="st">&#39;text/html; charset=utf-8&#39;</span><span class="op">,</span></span>
<span id="cb424-13"><a href="#cb424-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.js&#39;</span><span class="op">:</span> <span class="st">&#39;application/javascript; charset=utf-8&#39;</span><span class="op">,</span></span>
<span id="cb424-14"><a href="#cb424-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.mjs&#39;</span><span class="op">:</span> <span class="st">&#39;application/javascript; charset=utf-8&#39;</span><span class="op">,</span></span>
<span id="cb424-15"><a href="#cb424-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.css&#39;</span><span class="op">:</span> <span class="st">&#39;text/css; charset=utf-8&#39;</span><span class="op">,</span></span>
<span id="cb424-16"><a href="#cb424-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.json&#39;</span><span class="op">:</span> <span class="st">&#39;application/json; charset=utf-8&#39;</span><span class="op">,</span></span>
<span id="cb424-17"><a href="#cb424-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.png&#39;</span><span class="op">:</span> <span class="st">&#39;image/png&#39;</span><span class="op">,</span></span>
<span id="cb424-18"><a href="#cb424-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.jpg&#39;</span><span class="op">:</span> <span class="st">&#39;image/jpeg&#39;</span><span class="op">,</span></span>
<span id="cb424-19"><a href="#cb424-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.svg&#39;</span><span class="op">:</span> <span class="st">&#39;image/svg+xml&#39;</span><span class="op">,</span></span>
<span id="cb424-20"><a href="#cb424-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;.ico&#39;</span><span class="op">:</span> <span class="st">&#39;image/x-icon&#39;</span></span>
<span id="cb424-21"><a href="#cb424-21" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb424-22"><a href="#cb424-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-23"><a href="#cb424-23" aria-hidden="true" tabindex="-1"></a><span class="co">// HTTP Server</span></span>
<span id="cb424-24"><a href="#cb424-24" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="fu">createServer</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb424-25"><a href="#cb424-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb424-26"><a href="#cb424-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle SPA routing - serve index.html for non-file routes</span></span>
<span id="cb424-27"><a href="#cb424-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> filePath <span class="op">=</span> <span class="fu">join</span>(PUBLIC_DIR<span class="op">,</span> req<span class="op">.</span><span class="at">url</span> <span class="op">===</span> <span class="st">&#39;/&#39;</span> <span class="op">?</span> <span class="st">&#39;index.html&#39;</span> <span class="op">:</span> req<span class="op">.</span><span class="at">url</span>)<span class="op">;</span></span>
<span id="cb424-28"><a href="#cb424-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-29"><a href="#cb424-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try to read the file</span></span>
<span id="cb424-30"><a href="#cb424-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> content<span class="op">;</span></span>
<span id="cb424-31"><a href="#cb424-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb424-32"><a href="#cb424-32" aria-hidden="true" tabindex="-1"></a>      content <span class="op">=</span> <span class="cf">await</span> <span class="fu">readFile</span>(filePath)<span class="op">;</span></span>
<span id="cb424-33"><a href="#cb424-33" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb424-34"><a href="#cb424-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If file not found and URL doesn&#39;t have extension, serve index.html</span></span>
<span id="cb424-35"><a href="#cb424-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="fu">extname</span>(req<span class="op">.</span><span class="at">url</span>)) {</span>
<span id="cb424-36"><a href="#cb424-36" aria-hidden="true" tabindex="-1"></a>        filePath <span class="op">=</span> <span class="fu">join</span>(PUBLIC_DIR<span class="op">,</span> <span class="st">&#39;index.html&#39;</span>)<span class="op">;</span></span>
<span id="cb424-37"><a href="#cb424-37" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> <span class="cf">await</span> <span class="fu">readFile</span>(filePath)<span class="op">;</span></span>
<span id="cb424-38"><a href="#cb424-38" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb424-39"><a href="#cb424-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb424-40"><a href="#cb424-40" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb424-41"><a href="#cb424-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb424-42"><a href="#cb424-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-43"><a href="#cb424-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ext <span class="op">=</span> <span class="fu">extname</span>(filePath)<span class="op">;</span></span>
<span id="cb424-44"><a href="#cb424-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contentType <span class="op">=</span> contentTypes[ext] <span class="op">||</span> <span class="st">&#39;application/octet-stream&#39;</span><span class="op">;</span></span>
<span id="cb424-45"><a href="#cb424-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-46"><a href="#cb424-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inject live reload script for HTML files</span></span>
<span id="cb424-47"><a href="#cb424-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ext <span class="op">===</span> <span class="st">&#39;.html&#39;</span>) {</span>
<span id="cb424-48"><a href="#cb424-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> liveReloadScript <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb424-49"><a href="#cb424-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;script&gt;</span></span>
<span id="cb424-50"><a href="#cb424-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          (function() {</span></span>
<span id="cb424-51"><a href="#cb424-51" aria-hidden="true" tabindex="-1"></a><span class="vs">            const ws = new WebSocket(&#39;ws://localhost:</span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs">&#39;);</span></span>
<span id="cb424-52"><a href="#cb424-52" aria-hidden="true" tabindex="-1"></a><span class="vs">            ws.onmessage = (event) =&gt; {</span></span>
<span id="cb424-53"><a href="#cb424-53" aria-hidden="true" tabindex="-1"></a><span class="vs">              if (event.data === &#39;reload&#39;) {</span></span>
<span id="cb424-54"><a href="#cb424-54" aria-hidden="true" tabindex="-1"></a><span class="vs">                console.log(&#39;[Dev Server] Reloading...&#39;);</span></span>
<span id="cb424-55"><a href="#cb424-55" aria-hidden="true" tabindex="-1"></a><span class="vs">                location.reload();</span></span>
<span id="cb424-56"><a href="#cb424-56" aria-hidden="true" tabindex="-1"></a><span class="vs">              } else if (event.data.startsWith(&#39;hmr:&#39;)) {</span></span>
<span id="cb424-57"><a href="#cb424-57" aria-hidden="true" tabindex="-1"></a><span class="vs">                const module = event.data.substring(4);</span></span>
<span id="cb424-58"><a href="#cb424-58" aria-hidden="true" tabindex="-1"></a><span class="vs">                console.log(&#39;[Dev Server] Hot reload:&#39;, module);</span></span>
<span id="cb424-59"><a href="#cb424-59" aria-hidden="true" tabindex="-1"></a><span class="vs">                // Implement HMR logic here</span></span>
<span id="cb424-60"><a href="#cb424-60" aria-hidden="true" tabindex="-1"></a><span class="vs">              }</span></span>
<span id="cb424-61"><a href="#cb424-61" aria-hidden="true" tabindex="-1"></a><span class="vs">            };</span></span>
<span id="cb424-62"><a href="#cb424-62" aria-hidden="true" tabindex="-1"></a><span class="vs">            ws.onerror = () =&gt; console.error(&#39;[Dev Server] WebSocket error&#39;);</span></span>
<span id="cb424-63"><a href="#cb424-63" aria-hidden="true" tabindex="-1"></a><span class="vs">            ws.onclose = () =&gt; console.log(&#39;[Dev Server] Disconnected&#39;);</span></span>
<span id="cb424-64"><a href="#cb424-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          })();</span></span>
<span id="cb424-65"><a href="#cb424-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/script&gt;</span></span>
<span id="cb424-66"><a href="#cb424-66" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span><span class="op">;</span></span>
<span id="cb424-67"><a href="#cb424-67" aria-hidden="true" tabindex="-1"></a>      content <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">from</span>(</span>
<span id="cb424-68"><a href="#cb424-68" aria-hidden="true" tabindex="-1"></a>        content<span class="op">.</span><span class="fu">toString</span>()<span class="op">.</span><span class="fu">replace</span>(<span class="st">&#39;&lt;/body&gt;&#39;</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>liveReloadScript<span class="sc">}</span><span class="vs">&lt;/body&gt;`</span>)</span>
<span id="cb424-69"><a href="#cb424-69" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb424-70"><a href="#cb424-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb424-71"><a href="#cb424-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-72"><a href="#cb424-72" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">200</span><span class="op">,</span> {</span>
<span id="cb424-73"><a href="#cb424-73" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> contentType<span class="op">,</span></span>
<span id="cb424-74"><a href="#cb424-74" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Cache-Control&#39;</span><span class="op">:</span> <span class="st">&#39;no-cache&#39;</span><span class="op">,</span></span>
<span id="cb424-75"><a href="#cb424-75" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;Access-Control-Allow-Origin&#39;</span><span class="op">:</span> <span class="st">&#39;*&#39;</span></span>
<span id="cb424-76"><a href="#cb424-76" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb424-77"><a href="#cb424-77" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(content)<span class="op">;</span></span>
<span id="cb424-78"><a href="#cb424-78" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (err) {</span>
<span id="cb424-79"><a href="#cb424-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">&#39;Server error:&#39;</span><span class="op">,</span> err)<span class="op">;</span></span>
<span id="cb424-80"><a href="#cb424-80" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">writeHead</span>(<span class="dv">404</span><span class="op">,</span> { <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;text/html&#39;</span> })<span class="op">;</span></span>
<span id="cb424-81"><a href="#cb424-81" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">end</span>(<span class="vs">`</span></span>
<span id="cb424-82"><a href="#cb424-82" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;!DOCTYPE html&gt;</span></span>
<span id="cb424-83"><a href="#cb424-83" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;html&gt;</span></span>
<span id="cb424-84"><a href="#cb424-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span></span>
<span id="cb424-85"><a href="#cb424-85" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;body&gt;</span></span>
<span id="cb424-86"><a href="#cb424-86" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h1&gt;404 - Not Found&lt;/h1&gt;</span></span>
<span id="cb424-87"><a href="#cb424-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;p&gt;</span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb424-88"><a href="#cb424-88" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/body&gt;</span></span>
<span id="cb424-89"><a href="#cb424-89" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/html&gt;</span></span>
<span id="cb424-90"><a href="#cb424-90" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb424-91"><a href="#cb424-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb424-92"><a href="#cb424-92" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb424-93"><a href="#cb424-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-94"><a href="#cb424-94" aria-hidden="true" tabindex="-1"></a><span class="co">// WebSocket for live reload</span></span>
<span id="cb424-95"><a href="#cb424-95" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> wss <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebSocketServer</span>({ server })<span class="op">;</span></span>
<span id="cb424-96"><a href="#cb424-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-97"><a href="#cb424-97" aria-hidden="true" tabindex="-1"></a>wss<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;connection&#39;</span><span class="op">,</span> (ws) <span class="kw">=&gt;</span> {</span>
<span id="cb424-98"><a href="#cb424-98" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Client connected&#39;</span>)<span class="op">;</span></span>
<span id="cb424-99"><a href="#cb424-99" aria-hidden="true" tabindex="-1"></a>  ws<span class="op">.</span><span class="fu">on</span>(<span class="st">&#39;close&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Client disconnected&#39;</span>))<span class="op">;</span></span>
<span id="cb424-100"><a href="#cb424-100" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb424-101"><a href="#cb424-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-102"><a href="#cb424-102" aria-hidden="true" tabindex="-1"></a><span class="co">// File watcher</span></span>
<span id="cb424-103"><a href="#cb424-103" aria-hidden="true" tabindex="-1"></a><span class="fu">watch</span>(PUBLIC_DIR<span class="op">,</span> { <span class="dt">recursive</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span> (eventType<span class="op">,</span> filename) <span class="kw">=&gt;</span> {</span>
<span id="cb424-104"><a href="#cb424-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (filename) {</span>
<span id="cb424-105"><a href="#cb424-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`File changed: </span><span class="sc">${</span>filename<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb424-106"><a href="#cb424-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-107"><a href="#cb424-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Notify all connected clients</span></span>
<span id="cb424-108"><a href="#cb424-108" aria-hidden="true" tabindex="-1"></a>    wss<span class="op">.</span><span class="at">clients</span><span class="op">.</span><span class="fu">forEach</span>(client <span class="kw">=&gt;</span> {</span>
<span id="cb424-109"><a href="#cb424-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (client<span class="op">.</span><span class="at">readyState</span> <span class="op">===</span> <span class="dv">1</span>) { <span class="co">// WebSocket.OPEN</span></span>
<span id="cb424-110"><a href="#cb424-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (filename<span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.js&#39;</span>) <span class="op">||</span> filename<span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.mjs&#39;</span>)) {</span>
<span id="cb424-111"><a href="#cb424-111" aria-hidden="true" tabindex="-1"></a>          client<span class="op">.</span><span class="fu">send</span>(<span class="vs">`hmr:</span><span class="sc">${</span>filename<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb424-112"><a href="#cb424-112" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb424-113"><a href="#cb424-113" aria-hidden="true" tabindex="-1"></a>          client<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;reload&#39;</span>)<span class="op">;</span></span>
<span id="cb424-114"><a href="#cb424-114" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb424-115"><a href="#cb424-115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb424-116"><a href="#cb424-116" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb424-117"><a href="#cb424-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb424-118"><a href="#cb424-118" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb424-119"><a href="#cb424-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-120"><a href="#cb424-120" aria-hidden="true" tabindex="-1"></a>server<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb424-121"><a href="#cb424-121" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span></span>
<span id="cb424-122"><a href="#cb424-122" aria-hidden="true" tabindex="-1"></a><span class="vs">🚀 Dev server running at http://localhost:</span><span class="sc">${</span>PORT<span class="sc">}</span></span>
<span id="cb424-123"><a href="#cb424-123" aria-hidden="true" tabindex="-1"></a><span class="vs">📁 Serving: </span><span class="sc">${</span>PUBLIC_DIR<span class="sc">}</span></span>
<span id="cb424-124"><a href="#cb424-124" aria-hidden="true" tabindex="-1"></a><span class="vs">🔥 Live reload enabled</span></span>
<span id="cb424-125"><a href="#cb424-125" aria-hidden="true" tabindex="-1"></a><span class="vs">  `</span>)<span class="op">;</span></span>
<span id="cb424-126"><a href="#cb424-126" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="18.7" id="advanced-vs-code-configuration"><span
class="header-section-number">18.7</span> Advanced VS Code
Configuration</h2>
<p><strong>Complete settings.json:</strong></p>
<div class="sourceCode" id="cb425"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.formatOnSave&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.defaultFormatter&quot;</span><span class="fu">:</span> <span class="st">&quot;esbenp.prettier-vscode&quot;</span><span class="fu">,</span></span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.codeActionsOnSave&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;source.fixAll.eslint&quot;</span><span class="fu">:</span> <span class="st">&quot;explicit&quot;</span></span>
<span id="cb425-6"><a href="#cb425-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-7"><a href="#cb425-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;editor.quickSuggestions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-8"><a href="#cb425-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;strings&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb425-9"><a href="#cb425-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-10"><a href="#cb425-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;emmet.includeLanguages&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-11"><a href="#cb425-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;javascript&quot;</span><span class="fu">:</span> <span class="st">&quot;html&quot;</span></span>
<span id="cb425-12"><a href="#cb425-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-13"><a href="#cb425-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;files.associations&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-14"><a href="#cb425-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;*.mjs&quot;</span><span class="fu">:</span> <span class="st">&quot;javascript&quot;</span></span>
<span id="cb425-15"><a href="#cb425-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-16"><a href="#cb425-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;files.exclude&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-17"><a href="#cb425-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/.git&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-18"><a href="#cb425-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/node_modules&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-19"><a href="#cb425-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/.DS_Store&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb425-20"><a href="#cb425-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-21"><a href="#cb425-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;search.exclude&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb425-22"><a href="#cb425-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/node_modules&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-23"><a href="#cb425-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/dist&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-24"><a href="#cb425-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;**/.git&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb425-25"><a href="#cb425-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb425-26"><a href="#cb425-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;javascript.preferences.quoteStyle&quot;</span><span class="fu">:</span> <span class="st">&quot;single&quot;</span><span class="fu">,</span></span>
<span id="cb425-27"><a href="#cb425-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;javascript.suggest.autoImports&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb425-28"><a href="#cb425-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;javascript.updateImportsOnFileMove.enabled&quot;</span><span class="fu">:</span> <span class="st">&quot;always&quot;</span><span class="fu">,</span></span>
<span id="cb425-29"><a href="#cb425-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;css.lint.unknownAtRules&quot;</span><span class="fu">:</span> <span class="st">&quot;ignore&quot;</span></span>
<span id="cb425-30"><a href="#cb425-30" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Recommended extensions:</strong></p>
<div class="sourceCode" id="cb426"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/extensions.json</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;recommendations&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dbaeumer.vscode-eslint&quot;</span><span class="ot">,</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;esbenp.prettier-vscode&quot;</span><span class="ot">,</span></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;bradlc.vscode-tailwindcss&quot;</span><span class="ot">,</span></span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ritwickdey.liveserver&quot;</span><span class="ot">,</span></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;christian-kohler.path-intellisense&quot;</span><span class="ot">,</span></span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;zignd.html-css-class-completion&quot;</span><span class="ot">,</span></span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;formulahendry.auto-rename-tag&quot;</span></span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Custom snippets:</strong></p>
<div class="sourceCode" id="cb427"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.vscode/snippets/larc.code-snippets</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;LARC Component with Shadow DOM&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;larc-component&quot;</span><span class="fu">,</span></span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;body&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;/**&quot;</span><span class="ot">,</span></span>
<span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot; * ${1:ComponentName} - ${2:Component description}&quot;</span><span class="ot">,</span></span>
<span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot; * @element ${3:component-name}&quot;</span><span class="ot">,</span></span>
<span id="cb427-9"><a href="#cb427-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot; */&quot;</span><span class="ot">,</span></span>
<span id="cb427-10"><a href="#cb427-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;class ${1:ComponentName} extends HTMLElement {&quot;</span><span class="ot">,</span></span>
<span id="cb427-11"><a href="#cb427-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  constructor() {&quot;</span><span class="ot">,</span></span>
<span id="cb427-12"><a href="#cb427-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    super();&quot;</span><span class="ot">,</span></span>
<span id="cb427-13"><a href="#cb427-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.attachShadow({ mode: &#39;open&#39; });&quot;</span><span class="ot">,</span></span>
<span id="cb427-14"><a href="#cb427-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb427-15"><a href="#cb427-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb427-16"><a href="#cb427-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  connectedCallback() {&quot;</span><span class="ot">,</span></span>
<span id="cb427-17"><a href="#cb427-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.render();&quot;</span><span class="ot">,</span></span>
<span id="cb427-18"><a href="#cb427-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb427-19"><a href="#cb427-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb427-20"><a href="#cb427-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  disconnectedCallback() {&quot;</span><span class="ot">,</span></span>
<span id="cb427-21"><a href="#cb427-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    // Clean up&quot;</span><span class="ot">,</span></span>
<span id="cb427-22"><a href="#cb427-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb427-23"><a href="#cb427-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb427-24"><a href="#cb427-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  render() {&quot;</span><span class="ot">,</span></span>
<span id="cb427-25"><a href="#cb427-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    this.shadowRoot.innerHTML = `&quot;</span><span class="ot">,</span></span>
<span id="cb427-26"><a href="#cb427-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;style&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb427-27"><a href="#cb427-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;        :host {&quot;</span><span class="ot">,</span></span>
<span id="cb427-28"><a href="#cb427-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;          display: block;&quot;</span><span class="ot">,</span></span>
<span id="cb427-29"><a href="#cb427-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;        }&quot;</span><span class="ot">,</span></span>
<span id="cb427-30"><a href="#cb427-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;/style&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb427-31"><a href="#cb427-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;div class=</span><span class="ch">\&quot;</span><span class="st">${3:component-name}</span><span class="ch">\&quot;</span><span class="st">&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb427-32"><a href="#cb427-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;        $4&quot;</span><span class="ot">,</span></span>
<span id="cb427-33"><a href="#cb427-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;      &lt;/div&gt;&quot;</span><span class="ot">,</span></span>
<span id="cb427-34"><a href="#cb427-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;    `;&quot;</span><span class="ot">,</span></span>
<span id="cb427-35"><a href="#cb427-35" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  }&quot;</span><span class="ot">,</span></span>
<span id="cb427-36"><a href="#cb427-36" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;}&quot;</span><span class="ot">,</span></span>
<span id="cb427-37"><a href="#cb427-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;&quot;</span><span class="ot">,</span></span>
<span id="cb427-38"><a href="#cb427-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;customElements.define(&#39;${3:component-name}&#39;, ${1:ComponentName});&quot;</span></span>
<span id="cb427-39"><a href="#cb427-39" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb427-40"><a href="#cb427-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Create a LARC component with Shadow DOM&quot;</span></span>
<span id="cb427-41"><a href="#cb427-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb427-42"><a href="#cb427-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;PAN Subscribe&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb427-43"><a href="#cb427-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;pan-sub&quot;</span><span class="fu">,</span></span>
<span id="cb427-44"><a href="#cb427-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;body&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb427-45"><a href="#cb427-45" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;this.subscription = pan.subscribe(&#39;${1:topic}&#39;, (data) =&gt; {&quot;</span><span class="ot">,</span></span>
<span id="cb427-46"><a href="#cb427-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  $2&quot;</span><span class="ot">,</span></span>
<span id="cb427-47"><a href="#cb427-47" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;});&quot;</span></span>
<span id="cb427-48"><a href="#cb427-48" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb427-49"><a href="#cb427-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Subscribe to PAN topic&quot;</span></span>
<span id="cb427-50"><a href="#cb427-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb427-51"><a href="#cb427-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;PAN Publish&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb427-52"><a href="#cb427-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;prefix&quot;</span><span class="fu">:</span> <span class="st">&quot;pan-pub&quot;</span><span class="fu">,</span></span>
<span id="cb427-53"><a href="#cb427-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;body&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb427-54"><a href="#cb427-54" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;pan.publish(&#39;${1:topic}&#39;, {&quot;</span><span class="ot">,</span></span>
<span id="cb427-55"><a href="#cb427-55" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;  $2&quot;</span><span class="ot">,</span></span>
<span id="cb427-56"><a href="#cb427-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;});&quot;</span></span>
<span id="cb427-57"><a href="#cb427-57" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb427-58"><a href="#cb427-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Publish to PAN topic&quot;</span></span>
<span id="cb427-59"><a href="#cb427-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb427-60"><a href="#cb427-60" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 data-number="18.8" id="eslint-and-prettier-configuration"><span
class="header-section-number">18.8</span> ESLint and Prettier
Configuration</h2>
<p><strong>Complete ESLint config:</strong></p>
<div class="sourceCode" id="cb428"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="co">// eslint.config.js</span></span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> [</span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">files</span><span class="op">:</span> [<span class="st">&#39;**/*.{js,mjs}&#39;</span>]<span class="op">,</span></span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">languageOptions</span><span class="op">:</span> {</span>
<span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ecmaVersion</span><span class="op">:</span> <span class="dv">2022</span><span class="op">,</span></span>
<span id="cb428-7"><a href="#cb428-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">sourceType</span><span class="op">:</span> <span class="st">&#39;module&#39;</span><span class="op">,</span></span>
<span id="cb428-8"><a href="#cb428-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">globals</span><span class="op">:</span> {</span>
<span id="cb428-9"><a href="#cb428-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">window</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-10"><a href="#cb428-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">document</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-11"><a href="#cb428-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">customElements</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-12"><a href="#cb428-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">HTMLElement</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-13"><a href="#cb428-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">console</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-14"><a href="#cb428-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fetch</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-15"><a href="#cb428-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">localStorage</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-16"><a href="#cb428-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sessionStorage</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-17"><a href="#cb428-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">navigator</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-18"><a href="#cb428-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">URL</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-19"><a href="#cb428-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">URLSearchParams</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span></span>
<span id="cb428-20"><a href="#cb428-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-21"><a href="#cb428-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb428-22"><a href="#cb428-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">rules</span><span class="op">:</span> {</span>
<span id="cb428-23"><a href="#cb428-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Best practices</span></span>
<span id="cb428-24"><a href="#cb428-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-unused-vars&#39;</span><span class="op">:</span> [<span class="st">&#39;warn&#39;</span><span class="op">,</span> { <span class="dt">argsIgnorePattern</span><span class="op">:</span> <span class="st">&#39;^_&#39;</span> }]<span class="op">,</span></span>
<span id="cb428-25"><a href="#cb428-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-console&#39;</span><span class="op">:</span> [<span class="st">&#39;warn&#39;</span><span class="op">,</span> { <span class="dt">allow</span><span class="op">:</span> [<span class="st">&#39;warn&#39;</span><span class="op">,</span> <span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="st">&#39;info&#39;</span>] }]<span class="op">,</span></span>
<span id="cb428-26"><a href="#cb428-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;prefer-const&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-27"><a href="#cb428-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-var&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-28"><a href="#cb428-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;eqeqeq&#39;</span><span class="op">:</span> [<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="st">&#39;always&#39;</span>]<span class="op">,</span></span>
<span id="cb428-29"><a href="#cb428-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-eval&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-30"><a href="#cb428-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-implied-eval&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-31"><a href="#cb428-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-32"><a href="#cb428-32" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Formatting (let Prettier handle most)</span></span>
<span id="cb428-33"><a href="#cb428-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;semi&#39;</span><span class="op">:</span> [<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="st">&#39;always&#39;</span>]<span class="op">,</span></span>
<span id="cb428-34"><a href="#cb428-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;quotes&#39;</span><span class="op">:</span> [<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="st">&#39;single&#39;</span><span class="op">,</span> { <span class="dt">avoidEscape</span><span class="op">:</span> <span class="kw">true</span> }]<span class="op">,</span></span>
<span id="cb428-35"><a href="#cb428-35" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;comma-dangle&#39;</span><span class="op">:</span> [<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="st">&#39;never&#39;</span>]<span class="op">,</span></span>
<span id="cb428-36"><a href="#cb428-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-37"><a href="#cb428-37" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ES6+</span></span>
<span id="cb428-38"><a href="#cb428-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;arrow-spacing&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-39"><a href="#cb428-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;prefer-arrow-callback&#39;</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb428-40"><a href="#cb428-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;prefer-template&#39;</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb428-41"><a href="#cb428-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;template-curly-spacing&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-42"><a href="#cb428-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;object-shorthand&#39;</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb428-43"><a href="#cb428-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-44"><a href="#cb428-44" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Async</span></span>
<span id="cb428-45"><a href="#cb428-45" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-async-promise-executor&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span><span class="op">,</span></span>
<span id="cb428-46"><a href="#cb428-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;require-await&#39;</span><span class="op">:</span> <span class="st">&#39;warn&#39;</span><span class="op">,</span></span>
<span id="cb428-47"><a href="#cb428-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-48"><a href="#cb428-48" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Custom Elements</span></span>
<span id="cb428-49"><a href="#cb428-49" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;no-constructor-return&#39;</span><span class="op">:</span> <span class="st">&#39;error&#39;</span></span>
<span id="cb428-50"><a href="#cb428-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb428-51"><a href="#cb428-51" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb428-52"><a href="#cb428-52" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb428-53"><a href="#cb428-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">files</span><span class="op">:</span> [<span class="st">&#39;**/*.test.{js,mjs}&#39;</span>]<span class="op">,</span></span>
<span id="cb428-54"><a href="#cb428-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">languageOptions</span><span class="op">:</span> {</span>
<span id="cb428-55"><a href="#cb428-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">globals</span><span class="op">:</span> {</span>
<span id="cb428-56"><a href="#cb428-56" aria-hidden="true" tabindex="-1"></a>        <span class="dt">describe</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-57"><a href="#cb428-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">it</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-58"><a href="#cb428-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">expect</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-59"><a href="#cb428-59" aria-hidden="true" tabindex="-1"></a>        <span class="dt">beforeEach</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span><span class="op">,</span></span>
<span id="cb428-60"><a href="#cb428-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">afterEach</span><span class="op">:</span> <span class="st">&#39;readonly&#39;</span></span>
<span id="cb428-61"><a href="#cb428-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb428-62"><a href="#cb428-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb428-63"><a href="#cb428-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb428-64"><a href="#cb428-64" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span></code></pre></div>
<p><strong>Prettier configuration:</strong></p>
<div class="sourceCode" id="cb429"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">.prettierrc</span></span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;semi&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;singleQuote&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;trailingComma&quot;</span><span class="fu">:</span> <span class="st">&quot;none&quot;</span><span class="fu">,</span></span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;printWidth&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;tabWidth&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;useTabs&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb429-9"><a href="#cb429-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;arrowParens&quot;</span><span class="fu">:</span> <span class="st">&quot;avoid&quot;</span><span class="fu">,</span></span>
<span id="cb429-10"><a href="#cb429-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;endOfLine&quot;</span><span class="fu">:</span> <span class="st">&quot;lf&quot;</span></span>
<span id="cb429-11"><a href="#cb429-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Ignore files:</strong></p>
<pre><code># .prettierignore
node_modules
dist
build
coverage
*.min.js
package-lock.json</code></pre>
<h2 data-number="18.9" id="advanced-debugging-techniques"><span
class="header-section-number">18.9</span> Advanced Debugging
Techniques</h2>
<p><strong>1. Source maps for debugging:</strong></p>
<p>Although LARC doesn’t need transpilation, you can still use source
maps for development:</p>
<div class="sourceCode" id="cb431"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add inline source maps during development</span></span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="im">import</span><span class="op">.</span><span class="at">meta</span><span class="op">.</span><span class="at">env</span><span class="op">?.</span><span class="at">MODE</span> <span class="op">===</span> <span class="st">&#39;development&#39;</span>) {</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Error</span><span class="op">.</span><span class="at">stackTraceLimit</span> <span class="op">=</span> <span class="kw">Infinity</span><span class="op">;</span></span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>2. Component debugger:</strong></p>
<div class="sourceCode" id="cb432"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="co">// debug-component.js</span></span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">debugComponent</span>(ComponentClass) {</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalConnected <span class="op">=</span> ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">connectedCallback</span><span class="op">;</span></span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalDisconnected <span class="op">=</span> ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">disconnectedCallback</span><span class="op">;</span></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> originalAttributeChanged <span class="op">=</span> ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">attributeChangedCallback</span><span class="op">;</span></span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-7"><a href="#cb432-7" aria-hidden="true" tabindex="-1"></a>  ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">connectedCallback</span> <span class="op">=</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb432-8"><a href="#cb432-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[Connected] &lt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="sc">}</span><span class="vs">&gt;`</span><span class="op">,</span> <span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb432-9"><a href="#cb432-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> originalConnected<span class="op">?.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb432-10"><a href="#cb432-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb432-11"><a href="#cb432-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-12"><a href="#cb432-12" aria-hidden="true" tabindex="-1"></a>  ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">disconnectedCallback</span> <span class="op">=</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb432-13"><a href="#cb432-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[Disconnected] &lt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="sc">}</span><span class="vs">&gt;`</span><span class="op">,</span> <span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb432-14"><a href="#cb432-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> originalDisconnected<span class="op">?.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)<span class="op">;</span></span>
<span id="cb432-15"><a href="#cb432-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb432-16"><a href="#cb432-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-17"><a href="#cb432-17" aria-hidden="true" tabindex="-1"></a>  ComponentClass<span class="op">.</span><span class="at">prototype</span><span class="op">.</span><span class="at">attributeChangedCallback</span> <span class="op">=</span> <span class="kw">function</span>(name<span class="op">,</span> old<span class="op">,</span> val) {</span>
<span id="cb432-18"><a href="#cb432-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[Attribute] &lt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">tagName</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="sc">}</span><span class="vs">&gt; </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>old<span class="sc">}</span><span class="vs"> → </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb432-19"><a href="#cb432-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> originalAttributeChanged<span class="op">?.</span><span class="fu">call</span>(<span class="kw">this</span><span class="op">,</span> name<span class="op">,</span> old<span class="op">,</span> val)<span class="op">;</span></span>
<span id="cb432-20"><a href="#cb432-20" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb432-21"><a href="#cb432-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-22"><a href="#cb432-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ComponentClass<span class="op">;</span></span>
<span id="cb432-23"><a href="#cb432-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb432-24"><a href="#cb432-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-25"><a href="#cb432-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb432-26"><a href="#cb432-26" aria-hidden="true" tabindex="-1"></a>@debugComponent</span>
<span id="cb432-27"><a href="#cb432-27" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb432-28"><a href="#cb432-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb432-29"><a href="#cb432-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>3. Performance profiling:</strong></p>
<div class="sourceCode" id="cb433"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a><span class="co">// performance-tracker.js</span></span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PerformanceTracker {</span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>(name) {</span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">marks</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb433-6"><a href="#cb433-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-7"><a href="#cb433-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-8"><a href="#cb433-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">start</span>(label) {</span>
<span id="cb433-9"><a href="#cb433-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> markName <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>label<span class="sc">}</span><span class="vs">:start`</span><span class="op">;</span></span>
<span id="cb433-10"><a href="#cb433-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(markName)<span class="op">;</span></span>
<span id="cb433-11"><a href="#cb433-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">marks</span><span class="op">.</span><span class="fu">set</span>(label<span class="op">,</span> markName)<span class="op">;</span></span>
<span id="cb433-12"><a href="#cb433-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-13"><a href="#cb433-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-14"><a href="#cb433-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">end</span>(label) {</span>
<span id="cb433-15"><a href="#cb433-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startMark <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">marks</span><span class="op">.</span><span class="fu">get</span>(label)<span class="op">;</span></span>
<span id="cb433-16"><a href="#cb433-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>startMark) {</span>
<span id="cb433-17"><a href="#cb433-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(<span class="vs">`No start mark for </span><span class="sc">${</span>label<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb433-18"><a href="#cb433-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb433-19"><a href="#cb433-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb433-20"><a href="#cb433-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-21"><a href="#cb433-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> endMark <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>label<span class="sc">}</span><span class="vs">:end`</span><span class="op">;</span></span>
<span id="cb433-22"><a href="#cb433-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">mark</span>(endMark)<span class="op">;</span></span>
<span id="cb433-23"><a href="#cb433-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-24"><a href="#cb433-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> measureName <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">:</span><span class="sc">${</span>label<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb433-25"><a href="#cb433-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">measure</span>(measureName<span class="op">,</span> startMark<span class="op">,</span> endMark)<span class="op">;</span></span>
<span id="cb433-26"><a href="#cb433-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-27"><a href="#cb433-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> measure <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">getEntriesByName</span>(measureName)[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb433-28"><a href="#cb433-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`⏱ </span><span class="sc">${</span>measureName<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>measure<span class="op">.</span><span class="at">duration</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">ms`</span>)<span class="op">;</span></span>
<span id="cb433-29"><a href="#cb433-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-30"><a href="#cb433-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up</span></span>
<span id="cb433-31"><a href="#cb433-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">clearMarks</span>(startMark)<span class="op">;</span></span>
<span id="cb433-32"><a href="#cb433-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">clearMarks</span>(endMark)<span class="op">;</span></span>
<span id="cb433-33"><a href="#cb433-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">performance</span><span class="op">.</span><span class="fu">clearMeasures</span>(measureName)<span class="op">;</span></span>
<span id="cb433-34"><a href="#cb433-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">marks</span><span class="op">.</span><span class="fu">delete</span>(label)<span class="op">;</span></span>
<span id="cb433-35"><a href="#cb433-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-36"><a href="#cb433-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb433-37"><a href="#cb433-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-38"><a href="#cb433-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in component</span></span>
<span id="cb433-39"><a href="#cb433-39" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyComponent <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb433-40"><a href="#cb433-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb433-41"><a href="#cb433-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb433-42"><a href="#cb433-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">perf</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">PerformanceTracker</span>(<span class="st">&#39;MyComponent&#39;</span>)<span class="op">;</span></span>
<span id="cb433-43"><a href="#cb433-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-44"><a href="#cb433-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-45"><a href="#cb433-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb433-46"><a href="#cb433-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">perf</span><span class="op">.</span><span class="fu">start</span>(<span class="st">&#39;render&#39;</span>)<span class="op">;</span></span>
<span id="cb433-47"><a href="#cb433-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb433-48"><a href="#cb433-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">perf</span><span class="op">.</span><span class="fu">end</span>(<span class="st">&#39;render&#39;</span>)<span class="op">;</span></span>
<span id="cb433-49"><a href="#cb433-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb433-50"><a href="#cb433-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>4. Network debugging:</strong></p>
<div class="sourceCode" id="cb434"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="co">// network-debugger.js</span></span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> originalFetch <span class="op">=</span> <span class="bu">window</span><span class="op">.</span><span class="at">fetch</span><span class="op">;</span></span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">fetch</span> <span class="op">=</span> <span class="kw">function</span>(<span class="op">...</span>args) {</span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [url<span class="op">,</span> options] <span class="op">=</span> args<span class="op">;</span></span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[Fetch] →`</span><span class="op">,</span> {</span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a>    url<span class="op">,</span></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> options<span class="op">?.</span><span class="at">method</span> <span class="op">||</span> <span class="st">&#39;GET&#39;</span><span class="op">,</span></span>
<span id="cb434-11"><a href="#cb434-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">headers</span><span class="op">:</span> options<span class="op">?.</span><span class="at">headers</span><span class="op">,</span></span>
<span id="cb434-12"><a href="#cb434-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">body</span><span class="op">:</span> options<span class="op">?.</span><span class="at">body</span></span>
<span id="cb434-13"><a href="#cb434-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb434-14"><a href="#cb434-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-15"><a href="#cb434-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> originalFetch<span class="op">.</span><span class="fu">apply</span>(<span class="kw">this</span><span class="op">,</span> args)</span>
<span id="cb434-16"><a href="#cb434-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> {</span>
<span id="cb434-17"><a href="#cb434-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> duration <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb434-18"><a href="#cb434-18" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`[Fetch] ← </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>duration<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs">ms)`</span><span class="op">,</span> url)<span class="op">;</span></span>
<span id="cb434-19"><a href="#cb434-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response<span class="op">;</span></span>
<span id="cb434-20"><a href="#cb434-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb434-21"><a href="#cb434-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb434-22"><a href="#cb434-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> duration <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb434-23"><a href="#cb434-23" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="vs">`[Fetch] ✗ (</span><span class="sc">${</span>duration<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">0</span>)<span class="sc">}</span><span class="vs">ms)`</span><span class="op">,</span> url<span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb434-24"><a href="#cb434-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">throw</span> error<span class="op">;</span></span>
<span id="cb434-25"><a href="#cb434-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb434-26"><a href="#cb434-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 data-number="18.10" id="pan-bus-devtools"><span
class="header-section-number">18.10</span> PAN Bus DevTools</h2>
<p>Build a visual inspector for PAN messages:</p>
<div class="sourceCode" id="cb435"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="co">// pan-devtools.js</span></span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PanDevTools <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">maxMessages</span> <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">filter</span> <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupPanMonitoring</span>()<span class="op">;</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupPanMonitoring</span>() {</span>
<span id="cb435-17"><a href="#cb435-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to all topics</span></span>
<span id="cb435-18"><a href="#cb435-18" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (data<span class="op">,</span> topic) <span class="kw">=&gt;</span> {</span>
<span id="cb435-19"><a href="#cb435-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logMessage</span>({</span>
<span id="cb435-20"><a href="#cb435-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">,</span></span>
<span id="cb435-21"><a href="#cb435-21" aria-hidden="true" tabindex="-1"></a>        topic<span class="op">,</span></span>
<span id="cb435-22"><a href="#cb435-22" aria-hidden="true" tabindex="-1"></a>        data<span class="op">,</span></span>
<span id="cb435-23"><a href="#cb435-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;received&#39;</span></span>
<span id="cb435-24"><a href="#cb435-24" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb435-25"><a href="#cb435-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb435-26"><a href="#cb435-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-27"><a href="#cb435-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Intercept publishes (if PAN client supports it)</span></span>
<span id="cb435-28"><a href="#cb435-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> originalPublish <span class="op">=</span> pan<span class="op">.</span><span class="at">publish</span><span class="op">;</span></span>
<span id="cb435-29"><a href="#cb435-29" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="at">publish</span> <span class="op">=</span> (topic<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb435-30"><a href="#cb435-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">logMessage</span>({</span>
<span id="cb435-31"><a href="#cb435-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">,</span></span>
<span id="cb435-32"><a href="#cb435-32" aria-hidden="true" tabindex="-1"></a>        topic<span class="op">,</span></span>
<span id="cb435-33"><a href="#cb435-33" aria-hidden="true" tabindex="-1"></a>        data<span class="op">,</span></span>
<span id="cb435-34"><a href="#cb435-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;sent&#39;</span></span>
<span id="cb435-35"><a href="#cb435-35" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb435-36"><a href="#cb435-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> originalPublish<span class="op">.</span><span class="fu">call</span>(pan<span class="op">,</span> topic<span class="op">,</span> data)<span class="op">;</span></span>
<span id="cb435-37"><a href="#cb435-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb435-38"><a href="#cb435-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-39"><a href="#cb435-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-40"><a href="#cb435-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logMessage</span>(message) {</span>
<span id="cb435-41"><a href="#cb435-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">unshift</span>(message)<span class="op">;</span></span>
<span id="cb435-42"><a href="#cb435-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">maxMessages</span>) {</span>
<span id="cb435-43"><a href="#cb435-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb435-44"><a href="#cb435-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb435-45"><a href="#cb435-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">renderMessages</span>()<span class="op">;</span></span>
<span id="cb435-46"><a href="#cb435-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-47"><a href="#cb435-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-48"><a href="#cb435-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb435-49"><a href="#cb435-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb435-50"><a href="#cb435-50" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb435-51"><a href="#cb435-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        :host {</span></span>
<span id="cb435-52"><a href="#cb435-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          position: fixed;</span></span>
<span id="cb435-53"><a href="#cb435-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          bottom: 0;</span></span>
<span id="cb435-54"><a href="#cb435-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          right: 0;</span></span>
<span id="cb435-55"><a href="#cb435-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 400px;</span></span>
<span id="cb435-56"><a href="#cb435-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-height: 600px;</span></span>
<span id="cb435-57"><a href="#cb435-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #1e1e1e;</span></span>
<span id="cb435-58"><a href="#cb435-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #d4d4d4;</span></span>
<span id="cb435-59"><a href="#cb435-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-family: &#39;Monaco&#39;, &#39;Courier New&#39;, monospace;</span></span>
<span id="cb435-60"><a href="#cb435-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 12px;</span></span>
<span id="cb435-61"><a href="#cb435-61" aria-hidden="true" tabindex="-1"></a><span class="vs">          box-shadow: 0 -2px 10px rgba(0,0,0,0.3);</span></span>
<span id="cb435-62"><a href="#cb435-62" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb435-63"><a href="#cb435-63" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex-direction: column;</span></span>
<span id="cb435-64"><a href="#cb435-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          z-index: 10000;</span></span>
<span id="cb435-65"><a href="#cb435-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-66"><a href="#cb435-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-67"><a href="#cb435-67" aria-hidden="true" tabindex="-1"></a><span class="vs">        .header {</span></span>
<span id="cb435-68"><a href="#cb435-68" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px;</span></span>
<span id="cb435-69"><a href="#cb435-69" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #252526;</span></span>
<span id="cb435-70"><a href="#cb435-70" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #3e3e42;</span></span>
<span id="cb435-71"><a href="#cb435-71" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb435-72"><a href="#cb435-72" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: space-between;</span></span>
<span id="cb435-73"><a href="#cb435-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          align-items: center;</span></span>
<span id="cb435-74"><a href="#cb435-74" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-75"><a href="#cb435-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-76"><a href="#cb435-76" aria-hidden="true" tabindex="-1"></a><span class="vs">        .title {</span></span>
<span id="cb435-77"><a href="#cb435-77" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb435-78"><a href="#cb435-78" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #4ec9b0;</span></span>
<span id="cb435-79"><a href="#cb435-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-80"><a href="#cb435-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-81"><a href="#cb435-81" aria-hidden="true" tabindex="-1"></a><span class="vs">        .controls {</span></span>
<span id="cb435-82"><a href="#cb435-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb435-83"><a href="#cb435-83" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 8px;</span></span>
<span id="cb435-84"><a href="#cb435-84" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-85"><a href="#cb435-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-86"><a href="#cb435-86" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb435-87"><a href="#cb435-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #3e3e42;</span></span>
<span id="cb435-88"><a href="#cb435-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb435-89"><a href="#cb435-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #d4d4d4;</span></span>
<span id="cb435-90"><a href="#cb435-90" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 4px 8px;</span></span>
<span id="cb435-91"><a href="#cb435-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 3px;</span></span>
<span id="cb435-92"><a href="#cb435-92" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb435-93"><a href="#cb435-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 11px;</span></span>
<span id="cb435-94"><a href="#cb435-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-95"><a href="#cb435-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-96"><a href="#cb435-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:hover {</span></span>
<span id="cb435-97"><a href="#cb435-97" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #4e4e52;</span></span>
<span id="cb435-98"><a href="#cb435-98" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-99"><a href="#cb435-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-100"><a href="#cb435-100" aria-hidden="true" tabindex="-1"></a><span class="vs">        .filter {</span></span>
<span id="cb435-101"><a href="#cb435-101" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px;</span></span>
<span id="cb435-102"><a href="#cb435-102" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 1px solid #3e3e42;</span></span>
<span id="cb435-103"><a href="#cb435-103" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-104"><a href="#cb435-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-105"><a href="#cb435-105" aria-hidden="true" tabindex="-1"></a><span class="vs">        input {</span></span>
<span id="cb435-106"><a href="#cb435-106" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb435-107"><a href="#cb435-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 4px 8px;</span></span>
<span id="cb435-108"><a href="#cb435-108" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #3c3c3c;</span></span>
<span id="cb435-109"><a href="#cb435-109" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #3e3e42;</span></span>
<span id="cb435-110"><a href="#cb435-110" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #d4d4d4;</span></span>
<span id="cb435-111"><a href="#cb435-111" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 3px;</span></span>
<span id="cb435-112"><a href="#cb435-112" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 11px;</span></span>
<span id="cb435-113"><a href="#cb435-113" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-114"><a href="#cb435-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-115"><a href="#cb435-115" aria-hidden="true" tabindex="-1"></a><span class="vs">        .messages {</span></span>
<span id="cb435-116"><a href="#cb435-116" aria-hidden="true" tabindex="-1"></a><span class="vs">          flex: 1;</span></span>
<span id="cb435-117"><a href="#cb435-117" aria-hidden="true" tabindex="-1"></a><span class="vs">          overflow-y: auto;</span></span>
<span id="cb435-118"><a href="#cb435-118" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px;</span></span>
<span id="cb435-119"><a href="#cb435-119" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-120"><a href="#cb435-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-121"><a href="#cb435-121" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message {</span></span>
<span id="cb435-122"><a href="#cb435-122" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 8px;</span></span>
<span id="cb435-123"><a href="#cb435-123" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 8px;</span></span>
<span id="cb435-124"><a href="#cb435-124" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #252526;</span></span>
<span id="cb435-125"><a href="#cb435-125" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-left: 3px solid #4ec9b0;</span></span>
<span id="cb435-126"><a href="#cb435-126" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 3px;</span></span>
<span id="cb435-127"><a href="#cb435-127" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-128"><a href="#cb435-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-129"><a href="#cb435-129" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message.sent {</span></span>
<span id="cb435-130"><a href="#cb435-130" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-left-color: #569cd6;</span></span>
<span id="cb435-131"><a href="#cb435-131" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-132"><a href="#cb435-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-133"><a href="#cb435-133" aria-hidden="true" tabindex="-1"></a><span class="vs">        .message-header {</span></span>
<span id="cb435-134"><a href="#cb435-134" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb435-135"><a href="#cb435-135" aria-hidden="true" tabindex="-1"></a><span class="vs">          justify-content: space-between;</span></span>
<span id="cb435-136"><a href="#cb435-136" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 4px;</span></span>
<span id="cb435-137"><a href="#cb435-137" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-138"><a href="#cb435-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-139"><a href="#cb435-139" aria-hidden="true" tabindex="-1"></a><span class="vs">        .topic {</span></span>
<span id="cb435-140"><a href="#cb435-140" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #4ec9b0;</span></span>
<span id="cb435-141"><a href="#cb435-141" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb435-142"><a href="#cb435-142" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-143"><a href="#cb435-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-144"><a href="#cb435-144" aria-hidden="true" tabindex="-1"></a><span class="vs">        .timestamp {</span></span>
<span id="cb435-145"><a href="#cb435-145" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #858585;</span></span>
<span id="cb435-146"><a href="#cb435-146" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 10px;</span></span>
<span id="cb435-147"><a href="#cb435-147" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-148"><a href="#cb435-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-149"><a href="#cb435-149" aria-hidden="true" tabindex="-1"></a><span class="vs">        .data {</span></span>
<span id="cb435-150"><a href="#cb435-150" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #ce9178;</span></span>
<span id="cb435-151"><a href="#cb435-151" aria-hidden="true" tabindex="-1"></a><span class="vs">          white-space: pre-wrap;</span></span>
<span id="cb435-152"><a href="#cb435-152" aria-hidden="true" tabindex="-1"></a><span class="vs">          word-break: break-all;</span></span>
<span id="cb435-153"><a href="#cb435-153" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-154"><a href="#cb435-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-155"><a href="#cb435-155" aria-hidden="true" tabindex="-1"></a><span class="vs">        .type {</span></span>
<span id="cb435-156"><a href="#cb435-156" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: inline-block;</span></span>
<span id="cb435-157"><a href="#cb435-157" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2px 6px;</span></span>
<span id="cb435-158"><a href="#cb435-158" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 3px;</span></span>
<span id="cb435-159"><a href="#cb435-159" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 10px;</span></span>
<span id="cb435-160"><a href="#cb435-160" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-left: 8px;</span></span>
<span id="cb435-161"><a href="#cb435-161" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-162"><a href="#cb435-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-163"><a href="#cb435-163" aria-hidden="true" tabindex="-1"></a><span class="vs">        .type.sent {</span></span>
<span id="cb435-164"><a href="#cb435-164" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #569cd6;</span></span>
<span id="cb435-165"><a href="#cb435-165" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-166"><a href="#cb435-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-167"><a href="#cb435-167" aria-hidden="true" tabindex="-1"></a><span class="vs">        .type.received {</span></span>
<span id="cb435-168"><a href="#cb435-168" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #4ec9b0;</span></span>
<span id="cb435-169"><a href="#cb435-169" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb435-170"><a href="#cb435-170" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb435-171"><a href="#cb435-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-172"><a href="#cb435-172" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;header&quot;&gt;</span></span>
<span id="cb435-173"><a href="#cb435-173" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span class=&quot;title&quot;&gt;PAN DevTools&lt;/span&gt;</span></span>
<span id="cb435-174"><a href="#cb435-174" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;controls&quot;&gt;</span></span>
<span id="cb435-175"><a href="#cb435-175" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button id=&quot;clear-btn&quot;&gt;Clear&lt;/button&gt;</span></span>
<span id="cb435-176"><a href="#cb435-176" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button id=&quot;close-btn&quot;&gt;Close&lt;/button&gt;</span></span>
<span id="cb435-177"><a href="#cb435-177" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb435-178"><a href="#cb435-178" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb435-179"><a href="#cb435-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-180"><a href="#cb435-180" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;filter&quot;&gt;</span></span>
<span id="cb435-181"><a href="#cb435-181" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input type=&quot;text&quot; id=&quot;filter-input&quot; placeholder=&quot;Filter by topic...&quot;&gt;</span></span>
<span id="cb435-182"><a href="#cb435-182" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb435-183"><a href="#cb435-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-184"><a href="#cb435-184" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;messages&quot; id=&quot;messages&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb435-185"><a href="#cb435-185" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb435-186"><a href="#cb435-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-187"><a href="#cb435-187" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Setup event listeners</span></span>
<span id="cb435-188"><a href="#cb435-188" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;clear-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb435-189"><a href="#cb435-189" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">messages</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb435-190"><a href="#cb435-190" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderMessages</span>()<span class="op">;</span></span>
<span id="cb435-191"><a href="#cb435-191" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb435-192"><a href="#cb435-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-193"><a href="#cb435-193" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;close-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb435-194"><a href="#cb435-194" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb435-195"><a href="#cb435-195" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb435-196"><a href="#cb435-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-197"><a href="#cb435-197" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;filter-input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb435-198"><a href="#cb435-198" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">filter</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb435-199"><a href="#cb435-199" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">renderMessages</span>()<span class="op">;</span></span>
<span id="cb435-200"><a href="#cb435-200" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb435-201"><a href="#cb435-201" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-202"><a href="#cb435-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-203"><a href="#cb435-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderMessages</span>() {</span>
<span id="cb435-204"><a href="#cb435-204" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> messagesEl <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;messages&#39;</span>)<span class="op">;</span></span>
<span id="cb435-205"><a href="#cb435-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>messagesEl) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb435-206"><a href="#cb435-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-207"><a href="#cb435-207" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> filtered <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">filter</span></span>
<span id="cb435-208"><a href="#cb435-208" aria-hidden="true" tabindex="-1"></a>      <span class="op">?</span> <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">.</span><span class="fu">filter</span>(m <span class="kw">=&gt;</span> m<span class="op">.</span><span class="at">topic</span><span class="op">.</span><span class="fu">toLowerCase</span>()<span class="op">.</span><span class="fu">includes</span>(<span class="kw">this</span><span class="op">.</span><span class="at">filter</span>))</span>
<span id="cb435-209"><a href="#cb435-209" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">messages</span><span class="op">;</span></span>
<span id="cb435-210"><a href="#cb435-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-211"><a href="#cb435-211" aria-hidden="true" tabindex="-1"></a>    messagesEl<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(msg <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb435-212"><a href="#cb435-212" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;message </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb435-213"><a href="#cb435-213" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;message-header&quot;&gt;</span></span>
<span id="cb435-214"><a href="#cb435-214" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;topic&quot;&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">topic</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb435-215"><a href="#cb435-215" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;timestamp&quot;&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">timestamp</span><span class="op">.</span><span class="fu">toLocaleTimeString</span>()<span class="sc">}</span><span class="vs">.</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">timestamp</span><span class="op">.</span><span class="fu">getMilliseconds</span>()<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb435-216"><a href="#cb435-216" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb435-217"><a href="#cb435-217" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div&gt;</span></span>
<span id="cb435-218"><a href="#cb435-218" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;type </span><span class="sc">${</span>msg<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>msg<span class="op">.</span><span class="at">type</span><span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb435-219"><a href="#cb435-219" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb435-220"><a href="#cb435-220" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;data&quot;&gt;</span><span class="sc">${</span><span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(msg<span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/div&gt;</span></span>
<span id="cb435-221"><a href="#cb435-221" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb435-222"><a href="#cb435-222" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb435-223"><a href="#cb435-223" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-224"><a href="#cb435-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb435-225"><a href="#cb435-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-226"><a href="#cb435-226" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;pan-devtools&#39;</span><span class="op">,</span> PanDevTools)<span class="op">;</span></span>
<span id="cb435-227"><a href="#cb435-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-228"><a href="#cb435-228" aria-hidden="true" tabindex="-1"></a><span class="co">// Add to page with keyboard shortcut</span></span>
<span id="cb435-229"><a href="#cb435-229" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;keydown&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb435-230"><a href="#cb435-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (e<span class="op">.</span><span class="at">ctrlKey</span> <span class="op">&amp;&amp;</span> e<span class="op">.</span><span class="at">shiftKey</span> <span class="op">&amp;&amp;</span> e<span class="op">.</span><span class="at">key</span> <span class="op">===</span> <span class="st">&#39;P&#39;</span>) {</span>
<span id="cb435-231"><a href="#cb435-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;pan-devtools&#39;</span>)) {</span>
<span id="cb435-232"><a href="#cb435-232" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">appendChild</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;pan-devtools&#39;</span>))<span class="op">;</span></span>
<span id="cb435-233"><a href="#cb435-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb435-234"><a href="#cb435-234" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb435-235"><a href="#cb435-235" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="18.11" id="optional-build-tools"><span
class="header-section-number">18.11</span> Optional Build Tools</h2>
<p>While LARC doesn’t need a build step, sometimes you want to bundle
for production:</p>
<p><strong>Using esbuild for optimization:</strong></p>
<div class="sourceCode" id="cb436"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="co">// build.js</span></span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> esbuild <span class="im">from</span> <span class="st">&#39;esbuild&#39;</span><span class="op">;</span></span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> esbuild<span class="op">.</span><span class="fu">build</span>({</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">entryPoints</span><span class="op">:</span> [<span class="st">&#39;public/app.js&#39;</span>]<span class="op">,</span></span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bundle</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minify</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sourcemap</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">target</span><span class="op">:</span> [<span class="st">&#39;es2020&#39;</span>]<span class="op">,</span></span>
<span id="cb436-10"><a href="#cb436-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">outfile</span><span class="op">:</span> <span class="st">&#39;dist/app.min.js&#39;</span><span class="op">,</span></span>
<span id="cb436-11"><a href="#cb436-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;esm&#39;</span><span class="op">,</span></span>
<span id="cb436-12"><a href="#cb436-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">splitting</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb436-13"><a href="#cb436-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">treeShaking</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb436-14"><a href="#cb436-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb436-15"><a href="#cb436-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-16"><a href="#cb436-16" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;✅ Build complete&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><strong>Using Rollup:</strong></p>
<div class="sourceCode" id="cb437"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="co">// rollup.config.js</span></span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { terser } <span class="im">from</span> <span class="st">&#39;rollup-plugin-terser&#39;</span><span class="op">;</span></span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> resolve <span class="im">from</span> <span class="st">&#39;@rollup/plugin-node-resolve&#39;</span><span class="op">;</span></span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> {</span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">input</span><span class="op">:</span> <span class="st">&#39;public/app.js&#39;</span><span class="op">,</span></span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">output</span><span class="op">:</span> {</span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">file</span><span class="op">:</span> <span class="st">&#39;dist/app.min.js&#39;</span><span class="op">,</span></span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;esm&#39;</span><span class="op">,</span></span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sourcemap</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">plugins</span><span class="op">:</span> [</span>
<span id="cb437-13"><a href="#cb437-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resolve</span>()<span class="op">,</span></span>
<span id="cb437-14"><a href="#cb437-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">terser</span>()</span>
<span id="cb437-15"><a href="#cb437-15" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb437-16"><a href="#cb437-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 data-number="18.12" id="troubleshooting-tooling-issues"><span
class="header-section-number">18.12</span> Troubleshooting Tooling
Issues</h2>
<h3 data-number="18.12.1" id="problem-1-live-reload-not-working"><span
class="header-section-number">18.12.1</span> Problem 1: Live Reload Not
Working</h3>
<p><strong>Symptoms</strong>: Changes aren’t reflected after saving
files.</p>
<p><strong>Diagnosis</strong>:</p>
<div class="sourceCode" id="cb438"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if dev server is running</span></span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ps</span> aux <span class="kw">|</span> <span class="fu">grep</span> node</span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check WebSocket connection in browser console</span></span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Should see WebSocket connected message</span></span></code></pre></div>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb439"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Ensure WebSocket script is injected</span></span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Check browser console for WebSocket errors</span></span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Verify port 3000 is not blocked by firewall</span></span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Alternative: Use browser extension like LiveReload</span></span></code></pre></div>
<h3 data-number="18.12.2" id="problem-2-eslint-errors-in-vs-code"><span
class="header-section-number">18.12.2</span> Problem 2: ESLint Errors in
VS Code</h3>
<p><strong>Symptoms</strong>: Red squiggly lines everywhere, but code
works fine.</p>
<p><strong>Cause</strong>: ESLint configuration mismatch.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb440"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reinstall ESLint</span></span>
<span id="cb440-2"><a href="#cb440-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">--save-dev</span> eslint</span>
<span id="cb440-3"><a href="#cb440-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-4"><a href="#cb440-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Restart VS Code ESLint server</span></span>
<span id="cb440-5"><a href="#cb440-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmd+Shift+P → &quot;ESLint: Restart ESLint Server&quot;</span></span>
<span id="cb440-6"><a href="#cb440-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb440-7"><a href="#cb440-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check ESLint output panel</span></span>
<span id="cb440-8"><a href="#cb440-8" aria-hidden="true" tabindex="-1"></a><span class="co"># View → Output → Select &quot;ESLint&quot; from dropdown</span></span></code></pre></div>
<h3 data-number="18.12.3"
id="problem-3-import-paths-not-resolving"><span
class="header-section-number">18.12.3</span> Problem 3: Import Paths Not
Resolving</h3>
<p><strong>Symptoms</strong>: VS Code shows import errors, but browser
loads fine.</p>
<p><strong>Cause</strong>: VS Code doesn’t understand import maps.</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb441"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">jsconfig.json</span> <span class="er">-</span> <span class="er">Help</span> <span class="er">VS</span> <span class="er">Code</span> <span class="er">understand</span> <span class="er">paths</span></span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;compilerOptions&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;module&quot;</span><span class="fu">:</span> <span class="st">&quot;esnext&quot;</span><span class="fu">,</span></span>
<span id="cb441-5"><a href="#cb441-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;moduleResolution&quot;</span><span class="fu">:</span> <span class="st">&quot;bundler&quot;</span><span class="fu">,</span></span>
<span id="cb441-6"><a href="#cb441-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;baseUrl&quot;</span><span class="fu">:</span> <span class="st">&quot;./public&quot;</span><span class="fu">,</span></span>
<span id="cb441-7"><a href="#cb441-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;paths&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb441-8"><a href="#cb441-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@components/*&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;components/*&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb441-9"><a href="#cb441-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;@utils/*&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;utils/*&quot;</span><span class="ot">]</span></span>
<span id="cb441-10"><a href="#cb441-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb441-11"><a href="#cb441-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb441-12"><a href="#cb441-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;include&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;public/**/*&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb441-13"><a href="#cb441-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;exclude&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;node_modules&quot;</span><span class="ot">,</span> <span class="st">&quot;dist&quot;</span><span class="ot">]</span></span>
<span id="cb441-14"><a href="#cb441-14" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 data-number="18.12.4"
id="problem-4-shadow-dom-not-visible-in-devtools"><span
class="header-section-number">18.12.4</span> Problem 4: Shadow DOM Not
Visible in DevTools</h3>
<p><strong>Symptoms</strong>: Can’t inspect Shadow DOM elements.</p>
<p><strong>Cause</strong>: Shadow DOM panel not enabled.</p>
<p><strong>Solution</strong>:</p>
<ol type="1">
<li>Open Chrome DevTools</li>
<li>Go to Settings (gear icon)</li>
<li>Preferences → Elements → Enable “Show user agent shadow DOM”</li>
<li>Now you can see <code>#shadow-root</code> in Elements panel</li>
</ol>
<h2 data-number="18.13" id="tooling-best-practices"><span
class="header-section-number">18.13</span> Tooling Best Practices</h2>
<ol type="1">
<li><p><strong>Use a Dev Server</strong>: Never open HTML files
directly—use a local server for proper CORS and module loading.</p></li>
<li><p><strong>Enable Live Reload</strong>: Instant feedback speeds up
development significantly.</p></li>
<li><p><strong>Configure Your Editor</strong>: Proper linting,
formatting, and snippets save hours of work.</p></li>
<li><p><strong>Debug with DevTools</strong>: Master the Elements,
Console, Network, and Performance panels.</p></li>
<li><p><strong>Monitor PAN Messages</strong>: Use a visual inspector to
understand message flow.</p></li>
<li><p><strong>Profile Performance</strong>: Use Performance API and
DevTools to find bottlenecks.</p></li>
<li><p><strong>Automate Formatting</strong>: Let Prettier handle code
style—focus on logic.</p></li>
<li><p><strong>Test Continuously</strong>: Run tests in watch mode
during development.</p></li>
<li><p><strong>Document As You Go</strong>: JSDoc comments help VS Code
provide better autocomplete.</p></li>
<li><p><strong>Keep It Simple</strong>: Don’t over-tool. Start minimal
and add tools as needed.</p></li>
</ol>
<h2 data-number="18.14" id="hands-on-exercises-3"><span
class="header-section-number">18.14</span> Hands-On Exercises</h2>
<h3 data-number="18.14.1"
id="exercise-1-set-up-complete-dev-environment"><span
class="header-section-number">18.14.1</span> Exercise 1: Set Up Complete
Dev Environment</h3>
<p>Configure a full development environment with:</p>
<ul>
<li>Dev server with live reload</li>
<li>VS Code with all recommended extensions</li>
<li>ESLint and Prettier configured</li>
<li>Custom snippets for LARC components</li>
<li>Git hooks for pre-commit linting</li>
</ul>
<p><strong>Bonus</strong>: Add automated testing on file save.</p>
<h3 data-number="18.14.2"
id="exercise-2-build-a-pan-message-inspector"><span
class="header-section-number">18.14.2</span> Exercise 2: Build a PAN
Message Inspector</h3>
<p>Create a browser extension or dev panel that:</p>
<ul>
<li>Shows all PAN messages in real-time</li>
<li>Filters messages by topic pattern</li>
<li>Records and exports message history</li>
<li>Shows message timing and frequency</li>
<li>Highlights retained vs. transient messages</li>
</ul>
<p><strong>Bonus</strong>: Add ability to publish test messages.</p>
<h3 data-number="18.14.3"
id="exercise-3-create-custom-vs-code-extension"><span
class="header-section-number">18.14.3</span> Exercise 3: Create Custom
VS Code Extension</h3>
<p>Build a VS Code extension that:</p>
<ul>
<li>Generates LARC component boilerplate</li>
<li>Validates component structure</li>
<li>Provides autocomplete for PAN topics</li>
<li>Shows component documentation on hover</li>
<li>Refactors component names across files</li>
</ul>
<p><strong>Bonus</strong>: Publish to VS Code marketplace.</p>
<h3 data-number="18.14.4"
id="exercise-4-implement-advanced-debugging"><span
class="header-section-number">18.14.4</span> Exercise 4: Implement
Advanced Debugging</h3>
<p>Set up comprehensive debugging tools:</p>
<ul>
<li>Component lifecycle logger</li>
<li>Performance profiler for renders</li>
<li>Network request interceptor</li>
<li>Error boundary with stack traces</li>
<li>State inspector for component properties</li>
</ul>
<p><strong>Bonus</strong>: Create a dashboard showing all metrics.</p>
<h2 data-number="18.15" id="summary-17"><span
class="header-section-number">18.15</span> Summary</h2>
<p>Good tooling makes LARC development faster and more enjoyable:</p>
<ul>
<li><strong>Dev server</strong>: Live reload and hot module
replacement</li>
<li><strong>Editor setup</strong>: VS Code configuration, extensions,
snippets</li>
<li><strong>Linting</strong>: ESLint for code quality, Prettier for
formatting</li>
<li><strong>Debugging</strong>: DevTools mastery, PAN inspector,
performance tracking</li>
<li><strong>Automation</strong>: npm scripts, git hooks, CI
integration</li>
</ul>
<p>Start simple and add tools as your project grows. The beauty of LARC
is you can be productive with just a text editor and a
browser—everything else is optional.</p>
<h2 data-number="18.16" id="further-reading-17"><span
class="header-section-number">18.16</span> Further Reading</h2>
<ul>
<li><strong>Building with LARC - Chapter 20 (DevTools)</strong>:
Advanced debugging techniques</li>
<li><strong>Building with LARC - Chapter 11 (Best Practices)</strong>:
Development workflow patterns</li>
<li><strong>Building with LARC - Chapter 14 (Testing)</strong>: Testing
infrastructure setup</li>
</ul>
<div class="pagebreak">

</div>
<h1 data-number="19" id="real-world-applications"><span
class="header-section-number">19</span> Real-World Applications</h1>
<p>Theory only takes you so far. Let’s examine how LARC principles apply
to real applications.</p>
<h2 data-number="19.1" id="case-study-e-commerce-platform"><span
class="header-section-number">19.1</span> Case Study: E-Commerce
Platform</h2>
<p>An online store built with LARC demonstrates the architecture at
scale.</p>
<h3 data-number="19.1.1" id="architecture-overview"><span
class="header-section-number">19.1.1</span> Architecture Overview</h3>
<pre><code>store/
├── index.html
├── components/
│   ├── product-card.js
│   ├── product-grid.js
│   ├── shopping-cart.js
│   ├── cart-item.js
│   ├── checkout-form.js
│   └── order-confirmation.js
├── services/
│   ├── cart-service.js
│   ├── product-service.js
│   └── order-service.js
└── styles/
    └── main.css</code></pre>
<h3 data-number="19.1.2" id="product-catalog"><span
class="header-section-number">19.1.2</span> Product Catalog</h3>
<p>The product grid loads data and renders cards:</p>
<div class="sourceCode" id="cb443"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="co">// product-grid.js</span></span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductGrid <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;p&gt;Loading products...&lt;/p&gt;&#39;</span><span class="op">;</span></span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb443-7"><a href="#cb443-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> products <span class="op">=</span> <span class="cf">await</span> productService<span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb443-8"><a href="#cb443-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>(products)<span class="op">;</span></span>
<span id="cb443-9"><a href="#cb443-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb443-10"><a href="#cb443-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;p class=&quot;error&quot;&gt;Failed to load products&lt;/p&gt;`</span><span class="op">;</span></span>
<span id="cb443-11"><a href="#cb443-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb443-12"><a href="#cb443-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-13"><a href="#cb443-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-14"><a href="#cb443-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>(products) {</span>
<span id="cb443-15"><a href="#cb443-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb443-16"><a href="#cb443-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;grid&quot;&gt;</span></span>
<span id="cb443-17"><a href="#cb443-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>products<span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb443-18"><a href="#cb443-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;product-card</span></span>
<span id="cb443-19"><a href="#cb443-19" aria-hidden="true" tabindex="-1"></a><span class="vs">            product-id=&quot;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-20"><a href="#cb443-20" aria-hidden="true" tabindex="-1"></a><span class="vs">            name=&quot;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-21"><a href="#cb443-21" aria-hidden="true" tabindex="-1"></a><span class="vs">            price=&quot;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">price</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb443-22"><a href="#cb443-22" aria-hidden="true" tabindex="-1"></a><span class="vs">            image=&quot;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">image</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb443-23"><a href="#cb443-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/product-card&gt;</span></span>
<span id="cb443-24"><a href="#cb443-24" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb443-25"><a href="#cb443-25" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb443-26"><a href="#cb443-26" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb443-27"><a href="#cb443-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-28"><a href="#cb443-28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.1.3" id="shopping-cart"><span
class="header-section-number">19.1.3</span> Shopping Cart</h3>
<p>The cart subscribes to add-to-cart events and persists state:</p>
<div class="sourceCode" id="cb444"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="co">// shopping-cart.js</span></span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ShoppingCart <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb444-5"><a href="#cb444-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;cart&#39;</span>)) <span class="op">||</span> []<span class="op">;</span></span>
<span id="cb444-6"><a href="#cb444-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-7"><a href="#cb444-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-8"><a href="#cb444-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb444-9"><a href="#cb444-9" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.add&#39;</span><span class="op">,</span> ({ product }) <span class="kw">=&gt;</span> {</span>
<span id="cb444-10"><a href="#cb444-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">addItem</span>(product)<span class="op">;</span></span>
<span id="cb444-11"><a href="#cb444-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb444-12"><a href="#cb444-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-13"><a href="#cb444-13" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;cart.remove&#39;</span><span class="op">,</span> ({ productId }) <span class="kw">=&gt;</span> {</span>
<span id="cb444-14"><a href="#cb444-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">removeItem</span>(productId)<span class="op">;</span></span>
<span id="cb444-15"><a href="#cb444-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb444-16"><a href="#cb444-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-17"><a href="#cb444-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb444-18"><a href="#cb444-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-19"><a href="#cb444-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-20"><a href="#cb444-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addItem</span>(product) {</span>
<span id="cb444-21"><a href="#cb444-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> existing <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">find</span>(i <span class="kw">=&gt;</span> i<span class="op">.</span><span class="at">id</span> <span class="op">===</span> product<span class="op">.</span><span class="at">id</span>)<span class="op">;</span></span>
<span id="cb444-22"><a href="#cb444-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (existing) {</span>
<span id="cb444-23"><a href="#cb444-23" aria-hidden="true" tabindex="-1"></a>      existing<span class="op">.</span><span class="at">quantity</span><span class="op">++;</span></span>
<span id="cb444-24"><a href="#cb444-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb444-25"><a href="#cb444-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">push</span>({ <span class="op">...</span>product<span class="op">,</span> <span class="dt">quantity</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb444-26"><a href="#cb444-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb444-27"><a href="#cb444-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">save</span>()<span class="op">;</span></span>
<span id="cb444-28"><a href="#cb444-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb444-29"><a href="#cb444-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-30"><a href="#cb444-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-31"><a href="#cb444-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">removeItem</span>(productId) {</span>
<span id="cb444-32"><a href="#cb444-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">filter</span>(i <span class="kw">=&gt;</span> i<span class="op">.</span><span class="at">id</span> <span class="op">!==</span> productId)<span class="op">;</span></span>
<span id="cb444-33"><a href="#cb444-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">save</span>()<span class="op">;</span></span>
<span id="cb444-34"><a href="#cb444-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb444-35"><a href="#cb444-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-36"><a href="#cb444-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-37"><a href="#cb444-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>() {</span>
<span id="cb444-38"><a href="#cb444-38" aria-hidden="true" tabindex="-1"></a>    localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;cart&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">items</span>))<span class="op">;</span></span>
<span id="cb444-39"><a href="#cb444-39" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;cart.updated&#39;</span><span class="op">,</span> { <span class="dt">items</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">,</span> <span class="dt">total</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">total</span> })<span class="op">;</span></span>
<span id="cb444-40"><a href="#cb444-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-41"><a href="#cb444-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-42"><a href="#cb444-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span> <span class="fu">total</span>() {</span>
<span id="cb444-43"><a href="#cb444-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">reduce</span>((sum<span class="op">,</span> i) <span class="kw">=&gt;</span> sum <span class="op">+</span> i<span class="op">.</span><span class="at">price</span> <span class="op">*</span> i<span class="op">.</span><span class="at">quantity</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb444-44"><a href="#cb444-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-45"><a href="#cb444-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-46"><a href="#cb444-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb444-47"><a href="#cb444-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb444-48"><a href="#cb444-48" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h2&gt;Cart (</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs"> items)&lt;/h2&gt;</span></span>
<span id="cb444-49"><a href="#cb444-49" aria-hidden="true" tabindex="-1"></a><span class="vs">      </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">map</span>(item <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb444-50"><a href="#cb444-50" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;cart-item</span></span>
<span id="cb444-51"><a href="#cb444-51" aria-hidden="true" tabindex="-1"></a><span class="vs">          product-id=&quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb444-52"><a href="#cb444-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          name=&quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb444-53"><a href="#cb444-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          price=&quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">price</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb444-54"><a href="#cb444-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          quantity=&quot;</span><span class="sc">${</span>item<span class="op">.</span><span class="at">quantity</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb444-55"><a href="#cb444-55" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/cart-item&gt;</span></span>
<span id="cb444-56"><a href="#cb444-56" aria-hidden="true" tabindex="-1"></a><span class="vs">      `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb444-57"><a href="#cb444-57" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;p class=&quot;total&quot;&gt;Total: $</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">total</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb444-58"><a href="#cb444-58" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;button class=&quot;checkout-btn&quot;&gt;Checkout&lt;/button&gt;</span></span>
<span id="cb444-59"><a href="#cb444-59" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb444-60"><a href="#cb444-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb444-61"><a href="#cb444-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="19.2" id="case-study-dashboard-application"><span
class="header-section-number">19.2</span> Case Study: Dashboard
Application</h2>
<p>A data dashboard shows real-time metrics with role-based access.</p>
<h3 data-number="19.2.1" id="real-time-updates"><span
class="header-section-number">19.2.1</span> Real-Time Updates</h3>
<p>WebSocket messages update charts automatically:</p>
<div class="sourceCode" id="cb445"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="co">// metrics-chart.js</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MetricsChart <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-6"><a href="#cb445-6" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;ws.message.metrics&#39;</span><span class="op">,</span> ({ value<span class="op">,</span> timestamp }) <span class="kw">=&gt;</span> {</span>
<span id="cb445-7"><a href="#cb445-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">push</span>({ value<span class="op">,</span> timestamp })<span class="op">;</span></span>
<span id="cb445-8"><a href="#cb445-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">100</span>) <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">shift</span>()<span class="op">;</span></span>
<span id="cb445-9"><a href="#cb445-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb445-10"><a href="#cb445-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb445-11"><a href="#cb445-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-12"><a href="#cb445-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb445-13"><a href="#cb445-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-14"><a href="#cb445-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-15"><a href="#cb445-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb445-16"><a href="#cb445-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render chart using canvas or SVG</span></span>
<span id="cb445-17"><a href="#cb445-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> canvas <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;canvas&#39;</span>) <span class="op">||</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;canvas&#39;</span>)<span class="op">;</span></span>
<span id="cb445-18"><a href="#cb445-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">contains</span>(canvas)) <span class="kw">this</span><span class="op">.</span><span class="fu">appendChild</span>(canvas)<span class="op">;</span></span>
<span id="cb445-19"><a href="#cb445-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-20"><a href="#cb445-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> ctx <span class="op">=</span> canvas<span class="op">.</span><span class="fu">getContext</span>(<span class="st">&#39;2d&#39;</span>)<span class="op">;</span></span>
<span id="cb445-21"><a href="#cb445-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ... draw chart</span></span>
<span id="cb445-22"><a href="#cb445-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-23"><a href="#cb445-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.2.2" id="role-based-views"><span
class="header-section-number">19.2.2</span> Role-Based Views</h3>
<p>Different users see different widgets:</p>
<div class="sourceCode" id="cb446"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="co">// dashboard-page.js</span></span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DashboardPage <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> user <span class="op">=</span> auth<span class="op">.</span><span class="fu">getCurrentUser</span>()<span class="op">;</span></span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-6"><a href="#cb446-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb446-7"><a href="#cb446-7" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;h1&gt;Dashboard&lt;/h1&gt;</span></span>
<span id="cb446-8"><a href="#cb446-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-9"><a href="#cb446-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;widgets&quot;&gt;</span></span>
<span id="cb446-10"><a href="#cb446-10" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;metrics-chart&gt;&lt;/metrics-chart&gt;</span></span>
<span id="cb446-11"><a href="#cb446-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;recent-activity&gt;&lt;/recent-activity&gt;</span></span>
<span id="cb446-12"><a href="#cb446-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-13"><a href="#cb446-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>rbac<span class="op">.</span><span class="fu">can</span>(user<span class="op">,</span> <span class="st">&#39;view-analytics&#39;</span>) <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb446-14"><a href="#cb446-14" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;analytics-panel&gt;&lt;/analytics-panel&gt;</span></span>
<span id="cb446-15"><a href="#cb446-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb446-16"><a href="#cb446-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-17"><a href="#cb446-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>rbac<span class="op">.</span><span class="fu">can</span>(user<span class="op">,</span> <span class="st">&#39;manage-users&#39;</span>) <span class="op">?</span> <span class="vs">`</span></span>
<span id="cb446-18"><a href="#cb446-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;user-management&gt;&lt;/user-management&gt;</span></span>
<span id="cb446-19"><a href="#cb446-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb446-20"><a href="#cb446-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb446-21"><a href="#cb446-21" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb446-22"><a href="#cb446-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb446-23"><a href="#cb446-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="19.3" id="lessons-learned"><span
class="header-section-number">19.3</span> Lessons Learned</h2>
<p>Building real applications with LARC teaches valuable lessons:</p>
<ol type="1">
<li><p><strong>Start simple</strong>: Begin with basic components and
add complexity as needed.</p></li>
<li><p><strong>Use the PAN bus liberally</strong>: It’s cheap and
powerful. When in doubt, publish an event.</p></li>
<li><p><strong>Embrace the platform</strong>: Native APIs are
well-optimized. Use fetch, not axios. Use template literals, not a
template library.</p></li>
<li><p><strong>Think in components</strong>: Small, focused components
are easier to test, reuse, and understand.</p></li>
<li><p><strong>Test early</strong>: Writing tests as you build prevents
painful debugging later.</p></li>
<li><p><strong>Profile before optimizing</strong>: Measure performance
before assuming where bottlenecks are.</p></li>
<li><p><strong>Document as you go</strong>: Future you will thank
present you.</p></li>
<li><p><strong>Progressive enhancement</strong>: Build core
functionality first, then enhance for modern browsers.</p></li>
</ol>
<h3 data-number="19.3.1" id="complete-checkout-flow"><span
class="header-section-number">19.3.1</span> Complete Checkout Flow</h3>
<p>Let’s implement the full checkout process:</p>
<div class="sourceCode" id="cb447"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="co">// checkout-form.js</span></span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CheckoutForm <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb447-5"><a href="#cb447-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb447-6"><a href="#cb447-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-7"><a href="#cb447-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-8"><a href="#cb447-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb447-9"><a href="#cb447-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb447-10"><a href="#cb447-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupEventListeners</span>()<span class="op">;</span></span>
<span id="cb447-11"><a href="#cb447-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-12"><a href="#cb447-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-13"><a href="#cb447-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb447-14"><a href="#cb447-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb447-15"><a href="#cb447-15" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb447-16"><a href="#cb447-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        form {</span></span>
<span id="cb447-17"><a href="#cb447-17" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 600px;</span></span>
<span id="cb447-18"><a href="#cb447-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0 auto;</span></span>
<span id="cb447-19"><a href="#cb447-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-20"><a href="#cb447-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-21"><a href="#cb447-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        .section {</span></span>
<span id="cb447-22"><a href="#cb447-22" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 2rem;</span></span>
<span id="cb447-23"><a href="#cb447-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1.5rem;</span></span>
<span id="cb447-24"><a href="#cb447-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #e0e0e0;</span></span>
<span id="cb447-25"><a href="#cb447-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 8px;</span></span>
<span id="cb447-26"><a href="#cb447-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-27"><a href="#cb447-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-28"><a href="#cb447-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        .field {</span></span>
<span id="cb447-29"><a href="#cb447-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 1rem;</span></span>
<span id="cb447-30"><a href="#cb447-30" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-31"><a href="#cb447-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-32"><a href="#cb447-32" aria-hidden="true" tabindex="-1"></a><span class="vs">        label {</span></span>
<span id="cb447-33"><a href="#cb447-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: block;</span></span>
<span id="cb447-34"><a href="#cb447-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 0.5rem;</span></span>
<span id="cb447-35"><a href="#cb447-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: 600;</span></span>
<span id="cb447-36"><a href="#cb447-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-37"><a href="#cb447-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-38"><a href="#cb447-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        input, select {</span></span>
<span id="cb447-39"><a href="#cb447-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb447-40"><a href="#cb447-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb447-41"><a href="#cb447-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ccc;</span></span>
<span id="cb447-42"><a href="#cb447-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb447-43"><a href="#cb447-43" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-44"><a href="#cb447-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-45"><a href="#cb447-45" aria-hidden="true" tabindex="-1"></a><span class="vs">        .error {</span></span>
<span id="cb447-46"><a href="#cb447-46" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #dc3545;</span></span>
<span id="cb447-47"><a href="#cb447-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 0.875rem;</span></span>
<span id="cb447-48"><a href="#cb447-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 0.25rem;</span></span>
<span id="cb447-49"><a href="#cb447-49" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-50"><a href="#cb447-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-51"><a href="#cb447-51" aria-hidden="true" tabindex="-1"></a><span class="vs">        button {</span></span>
<span id="cb447-52"><a href="#cb447-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb447-53"><a href="#cb447-53" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb447-54"><a href="#cb447-54" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #0066cc;</span></span>
<span id="cb447-55"><a href="#cb447-55" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: white;</span></span>
<span id="cb447-56"><a href="#cb447-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb447-57"><a href="#cb447-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb447-58"><a href="#cb447-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 1rem;</span></span>
<span id="cb447-59"><a href="#cb447-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb447-60"><a href="#cb447-60" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-61"><a href="#cb447-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-62"><a href="#cb447-62" aria-hidden="true" tabindex="-1"></a><span class="vs">        button:disabled {</span></span>
<span id="cb447-63"><a href="#cb447-63" aria-hidden="true" tabindex="-1"></a><span class="vs">          opacity: 0.5;</span></span>
<span id="cb447-64"><a href="#cb447-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: not-allowed;</span></span>
<span id="cb447-65"><a href="#cb447-65" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb447-66"><a href="#cb447-66" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb447-67"><a href="#cb447-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-68"><a href="#cb447-68" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;form id=&quot;checkout-form&quot;&gt;</span></span>
<span id="cb447-69"><a href="#cb447-69" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;section&quot;&gt;</span></span>
<span id="cb447-70"><a href="#cb447-70" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h2&gt;Shipping Information&lt;/h2&gt;</span></span>
<span id="cb447-71"><a href="#cb447-71" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-72"><a href="#cb447-72" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;email&quot;&gt;Email&lt;/label&gt;</span></span>
<span id="cb447-73"><a href="#cb447-73" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;email&quot; id=&quot;email&quot; required&gt;</span></span>
<span id="cb447-74"><a href="#cb447-74" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;div class=&quot;error&quot; id=&quot;email-error&quot;&gt;&lt;/div&gt;</span></span>
<span id="cb447-75"><a href="#cb447-75" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-76"><a href="#cb447-76" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-77"><a href="#cb447-77" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;name&quot;&gt;Full Name&lt;/label&gt;</span></span>
<span id="cb447-78"><a href="#cb447-78" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;name&quot; required&gt;</span></span>
<span id="cb447-79"><a href="#cb447-79" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-80"><a href="#cb447-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-81"><a href="#cb447-81" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;address&quot;&gt;Address&lt;/label&gt;</span></span>
<span id="cb447-82"><a href="#cb447-82" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;address&quot; required&gt;</span></span>
<span id="cb447-83"><a href="#cb447-83" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-84"><a href="#cb447-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-85"><a href="#cb447-85" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;city&quot;&gt;City&lt;/label&gt;</span></span>
<span id="cb447-86"><a href="#cb447-86" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;city&quot; required&gt;</span></span>
<span id="cb447-87"><a href="#cb447-87" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-88"><a href="#cb447-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-89"><a href="#cb447-89" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;zip&quot;&gt;ZIP Code&lt;/label&gt;</span></span>
<span id="cb447-90"><a href="#cb447-90" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;zip&quot; pattern=&quot;[0-9]{5}&quot; required&gt;</span></span>
<span id="cb447-91"><a href="#cb447-91" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-92"><a href="#cb447-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb447-93"><a href="#cb447-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-94"><a href="#cb447-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;section&quot;&gt;</span></span>
<span id="cb447-95"><a href="#cb447-95" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;h2&gt;Payment Information&lt;/h2&gt;</span></span>
<span id="cb447-96"><a href="#cb447-96" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-97"><a href="#cb447-97" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;card-number&quot;&gt;Card Number&lt;/label&gt;</span></span>
<span id="cb447-98"><a href="#cb447-98" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;card-number&quot; pattern=&quot;[0-9]{16}&quot; required&gt;</span></span>
<span id="cb447-99"><a href="#cb447-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-100"><a href="#cb447-100" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-101"><a href="#cb447-101" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;expiry&quot;&gt;Expiry Date&lt;/label&gt;</span></span>
<span id="cb447-102"><a href="#cb447-102" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;expiry&quot; placeholder=&quot;MM/YY&quot; required&gt;</span></span>
<span id="cb447-103"><a href="#cb447-103" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-104"><a href="#cb447-104" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div class=&quot;field&quot;&gt;</span></span>
<span id="cb447-105"><a href="#cb447-105" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;label for=&quot;cvv&quot;&gt;CVV&lt;/label&gt;</span></span>
<span id="cb447-106"><a href="#cb447-106" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;input type=&quot;text&quot; id=&quot;cvv&quot; pattern=&quot;[0-9]{3}&quot; required&gt;</span></span>
<span id="cb447-107"><a href="#cb447-107" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb447-108"><a href="#cb447-108" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb447-109"><a href="#cb447-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-110"><a href="#cb447-110" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button type=&quot;submit&quot; id=&quot;submit-btn&quot;&gt;Place Order&lt;/button&gt;</span></span>
<span id="cb447-111"><a href="#cb447-111" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/form&gt;</span></span>
<span id="cb447-112"><a href="#cb447-112" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb447-113"><a href="#cb447-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-114"><a href="#cb447-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-115"><a href="#cb447-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupEventListeners</span>() {</span>
<span id="cb447-116"><a href="#cb447-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;checkout-form&#39;</span>)<span class="op">;</span></span>
<span id="cb447-117"><a href="#cb447-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> submitBtn <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;submit-btn&#39;</span>)<span class="op">;</span></span>
<span id="cb447-118"><a href="#cb447-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-119"><a href="#cb447-119" aria-hidden="true" tabindex="-1"></a>    form<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;submit&#39;</span><span class="op">,</span> <span class="kw">async</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb447-120"><a href="#cb447-120" aria-hidden="true" tabindex="-1"></a>      e<span class="op">.</span><span class="fu">preventDefault</span>()<span class="op">;</span></span>
<span id="cb447-121"><a href="#cb447-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-122"><a href="#cb447-122" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="fu">validate</span>()) {</span>
<span id="cb447-123"><a href="#cb447-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span><span class="op">;</span></span>
<span id="cb447-124"><a href="#cb447-124" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb447-125"><a href="#cb447-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-126"><a href="#cb447-126" aria-hidden="true" tabindex="-1"></a>      submitBtn<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb447-127"><a href="#cb447-127" aria-hidden="true" tabindex="-1"></a>      submitBtn<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Processing...&#39;</span><span class="op">;</span></span>
<span id="cb447-128"><a href="#cb447-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-129"><a href="#cb447-129" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span> {</span>
<span id="cb447-130"><a href="#cb447-130" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> order <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getFormData</span>()<span class="op">;</span></span>
<span id="cb447-131"><a href="#cb447-131" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> orderService<span class="op">.</span><span class="fu">submit</span>(order)<span class="op">;</span></span>
<span id="cb447-132"><a href="#cb447-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-133"><a href="#cb447-133" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;order.completed&#39;</span><span class="op">,</span> { <span class="dt">orderId</span><span class="op">:</span> result<span class="op">.</span><span class="at">id</span> })<span class="op">;</span></span>
<span id="cb447-134"><a href="#cb447-134" aria-hidden="true" tabindex="-1"></a>        pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="vs">`/order-confirmation/</span><span class="sc">${</span>result<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">`</span> })<span class="op">;</span></span>
<span id="cb447-135"><a href="#cb447-135" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">catch</span> (error) {</span>
<span id="cb447-136"><a href="#cb447-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(<span class="st">&#39;Order failed: &#39;</span> <span class="op">+</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb447-137"><a href="#cb447-137" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">finally</span> {</span>
<span id="cb447-138"><a href="#cb447-138" aria-hidden="true" tabindex="-1"></a>        submitBtn<span class="op">.</span><span class="at">disabled</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb447-139"><a href="#cb447-139" aria-hidden="true" tabindex="-1"></a>        submitBtn<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Place Order&#39;</span><span class="op">;</span></span>
<span id="cb447-140"><a href="#cb447-140" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb447-141"><a href="#cb447-141" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb447-142"><a href="#cb447-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-143"><a href="#cb447-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-144"><a href="#cb447-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">validate</span>() {</span>
<span id="cb447-145"><a href="#cb447-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implement validation logic</span></span>
<span id="cb447-146"><a href="#cb447-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb447-147"><a href="#cb447-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-148"><a href="#cb447-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-149"><a href="#cb447-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getFormData</span>() {</span>
<span id="cb447-150"><a href="#cb447-150" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> form <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;checkout-form&#39;</span>)<span class="op">;</span></span>
<span id="cb447-151"><a href="#cb447-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb447-152"><a href="#cb447-152" aria-hidden="true" tabindex="-1"></a>      <span class="dt">email</span><span class="op">:</span> form<span class="op">.</span><span class="at">email</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-153"><a href="#cb447-153" aria-hidden="true" tabindex="-1"></a>      <span class="dt">name</span><span class="op">:</span> form<span class="op">.</span><span class="at">name</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-154"><a href="#cb447-154" aria-hidden="true" tabindex="-1"></a>      <span class="dt">address</span><span class="op">:</span> form<span class="op">.</span><span class="at">address</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-155"><a href="#cb447-155" aria-hidden="true" tabindex="-1"></a>      <span class="dt">city</span><span class="op">:</span> form<span class="op">.</span><span class="at">city</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-156"><a href="#cb447-156" aria-hidden="true" tabindex="-1"></a>      <span class="dt">zip</span><span class="op">:</span> form<span class="op">.</span><span class="at">zip</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-157"><a href="#cb447-157" aria-hidden="true" tabindex="-1"></a>      <span class="dt">payment</span><span class="op">:</span> {</span>
<span id="cb447-158"><a href="#cb447-158" aria-hidden="true" tabindex="-1"></a>        <span class="dt">cardNumber</span><span class="op">:</span> form[<span class="st">&#39;card-number&#39;</span>]<span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-159"><a href="#cb447-159" aria-hidden="true" tabindex="-1"></a>        <span class="dt">expiry</span><span class="op">:</span> form<span class="op">.</span><span class="at">expiry</span><span class="op">.</span><span class="at">value</span><span class="op">,</span></span>
<span id="cb447-160"><a href="#cb447-160" aria-hidden="true" tabindex="-1"></a>        <span class="dt">cvv</span><span class="op">:</span> form<span class="op">.</span><span class="at">cvv</span><span class="op">.</span><span class="at">value</span></span>
<span id="cb447-161"><a href="#cb447-161" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb447-162"><a href="#cb447-162" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb447-163"><a href="#cb447-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb447-164"><a href="#cb447-164" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb447-165"><a href="#cb447-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb447-166"><a href="#cb447-166" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;checkout-form&#39;</span><span class="op">,</span> CheckoutForm)<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.3.2" id="inventory-management"><span
class="header-section-number">19.3.2</span> Inventory Management</h3>
<p>Admin panel for managing products:</p>
<div class="sourceCode" id="cb448"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="co">// admin-inventory.js</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AdminInventory <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="cf">await</span> productService<span class="op">.</span><span class="fu">getAll</span>()<span class="op">;</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb448-9"><a href="#cb448-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb448-10"><a href="#cb448-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;admin-panel&quot;&gt;</span></span>
<span id="cb448-11"><a href="#cb448-11" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h1&gt;Inventory Management&lt;/h1&gt;</span></span>
<span id="cb448-12"><a href="#cb448-12" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;add-product-btn&quot;&gt;Add New Product&lt;/button&gt;</span></span>
<span id="cb448-13"><a href="#cb448-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-14"><a href="#cb448-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;table class=&quot;inventory-table&quot;&gt;</span></span>
<span id="cb448-15"><a href="#cb448-15" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;thead&gt;</span></span>
<span id="cb448-16"><a href="#cb448-16" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;tr&gt;</span></span>
<span id="cb448-17"><a href="#cb448-17" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;ID&lt;/th&gt;</span></span>
<span id="cb448-18"><a href="#cb448-18" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;Name&lt;/th&gt;</span></span>
<span id="cb448-19"><a href="#cb448-19" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;Price&lt;/th&gt;</span></span>
<span id="cb448-20"><a href="#cb448-20" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;Stock&lt;/th&gt;</span></span>
<span id="cb448-21"><a href="#cb448-21" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;Status&lt;/th&gt;</span></span>
<span id="cb448-22"><a href="#cb448-22" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;th&gt;Actions&lt;/th&gt;</span></span>
<span id="cb448-23"><a href="#cb448-23" aria-hidden="true" tabindex="-1"></a><span class="vs">            &lt;/tr&gt;</span></span>
<span id="cb448-24"><a href="#cb448-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/thead&gt;</span></span>
<span id="cb448-25"><a href="#cb448-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;tbody&gt;</span></span>
<span id="cb448-26"><a href="#cb448-26" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">map</span>(p <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb448-27"><a href="#cb448-27" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;tr&gt;</span></span>
<span id="cb448-28"><a href="#cb448-28" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb448-29"><a href="#cb448-29" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb448-30"><a href="#cb448-30" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;$</span><span class="sc">${</span>p<span class="op">.</span><span class="at">price</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb448-31"><a href="#cb448-31" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;</span><span class="sc">${</span>p<span class="op">.</span><span class="at">stock</span><span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb448-32"><a href="#cb448-32" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;</span></span>
<span id="cb448-33"><a href="#cb448-33" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;span class=&quot;badge </span><span class="sc">${</span>p<span class="op">.</span><span class="at">stock</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;in-stock&#39;</span> <span class="op">:</span> <span class="st">&#39;out-of-stock&#39;</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb448-34"><a href="#cb448-34" aria-hidden="true" tabindex="-1"></a><span class="vs">                    </span><span class="sc">${</span>p<span class="op">.</span><span class="at">stock</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">&#39;In Stock&#39;</span> <span class="op">:</span> <span class="st">&#39;Out of Stock&#39;</span><span class="sc">}</span></span>
<span id="cb448-35"><a href="#cb448-35" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;/span&gt;</span></span>
<span id="cb448-36"><a href="#cb448-36" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/td&gt;</span></span>
<span id="cb448-37"><a href="#cb448-37" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;td&gt;</span></span>
<span id="cb448-38"><a href="#cb448-38" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;button onclick=&quot;this.getRootNode().host.editProduct(</span><span class="sc">${</span>p<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;</span></span>
<span id="cb448-39"><a href="#cb448-39" aria-hidden="true" tabindex="-1"></a><span class="vs">                    Edit</span></span>
<span id="cb448-40"><a href="#cb448-40" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;/button&gt;</span></span>
<span id="cb448-41"><a href="#cb448-41" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;button onclick=&quot;this.getRootNode().host.deleteProduct(</span><span class="sc">${</span>p<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">)&quot;&gt;</span></span>
<span id="cb448-42"><a href="#cb448-42" aria-hidden="true" tabindex="-1"></a><span class="vs">                    Delete</span></span>
<span id="cb448-43"><a href="#cb448-43" aria-hidden="true" tabindex="-1"></a><span class="vs">                  &lt;/button&gt;</span></span>
<span id="cb448-44"><a href="#cb448-44" aria-hidden="true" tabindex="-1"></a><span class="vs">                &lt;/td&gt;</span></span>
<span id="cb448-45"><a href="#cb448-45" aria-hidden="true" tabindex="-1"></a><span class="vs">              &lt;/tr&gt;</span></span>
<span id="cb448-46"><a href="#cb448-46" aria-hidden="true" tabindex="-1"></a><span class="vs">            `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb448-47"><a href="#cb448-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/tbody&gt;</span></span>
<span id="cb448-48"><a href="#cb448-48" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/table&gt;</span></span>
<span id="cb448-49"><a href="#cb448-49" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb448-50"><a href="#cb448-50" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb448-51"><a href="#cb448-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-52"><a href="#cb448-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-53"><a href="#cb448-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">editProduct</span>(id) {</span>
<span id="cb448-54"><a href="#cb448-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> product <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">find</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">id</span> <span class="op">===</span> id)<span class="op">;</span></span>
<span id="cb448-55"><a href="#cb448-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Show edit dialog</span></span>
<span id="cb448-56"><a href="#cb448-56" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;dialog.open&#39;</span><span class="op">,</span> {</span>
<span id="cb448-57"><a href="#cb448-57" aria-hidden="true" tabindex="-1"></a>      <span class="dt">component</span><span class="op">:</span> <span class="st">&#39;product-edit-form&#39;</span><span class="op">,</span></span>
<span id="cb448-58"><a href="#cb448-58" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> product</span>
<span id="cb448-59"><a href="#cb448-59" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb448-60"><a href="#cb448-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-61"><a href="#cb448-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-62"><a href="#cb448-62" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">deleteProduct</span>(id) {</span>
<span id="cb448-63"><a href="#cb448-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="fu">confirm</span>(<span class="st">&#39;Are you sure?&#39;</span>)) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb448-64"><a href="#cb448-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-65"><a href="#cb448-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> productService<span class="op">.</span><span class="fu">delete</span>(id)<span class="op">;</span></span>
<span id="cb448-66"><a href="#cb448-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">products</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">filter</span>(p <span class="kw">=&gt;</span> p<span class="op">.</span><span class="at">id</span> <span class="op">!==</span> id)<span class="op">;</span></span>
<span id="cb448-67"><a href="#cb448-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb448-68"><a href="#cb448-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb448-69"><a href="#cb448-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb448-70"><a href="#cb448-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-71"><a href="#cb448-71" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;admin-inventory&#39;</span><span class="op">,</span> AdminInventory)<span class="op">;</span></span></code></pre></div>
<h2 data-number="19.4" id="case-study-blogcms-application"><span
class="header-section-number">19.4</span> Case Study: Blog/CMS
Application</h2>
<p>A content management system demonstrates LARC’s flexibility for
content-heavy applications.</p>
<h3 data-number="19.4.1" id="architecture"><span
class="header-section-number">19.4.1</span> Architecture</h3>
<pre><code>blog/
├── index.html
├── components/
│   ├── article-editor.js
│   ├── article-list.js
│   ├── article-card.js
│   ├── markdown-renderer.js
│   └── tag-selector.js
├── services/
│   ├── content-service.js
│   └── media-service.js
└── admin/
    ├── dashboard.js
    ├── editor.js
    └── settings.js</code></pre>
<h3 data-number="19.4.2" id="rich-text-editor"><span
class="header-section-number">19.4.2</span> Rich Text Editor</h3>
<div class="sourceCode" id="cb450"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="co">// article-editor.js</span></span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ArticleEditor <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">attachShadow</span>({ <span class="dt">mode</span><span class="op">:</span> <span class="st">&#39;open&#39;</span> })<span class="op">;</span></span>
<span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">article</span> <span class="op">=</span> { <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">content</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">tags</span><span class="op">:</span> [] }<span class="op">;</span></span>
<span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb450-10"><a href="#cb450-10" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;article.load&#39;</span><span class="op">,</span> ({ article }) <span class="kw">=&gt;</span> {</span>
<span id="cb450-11"><a href="#cb450-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">article</span> <span class="op">=</span> article<span class="op">;</span></span>
<span id="cb450-12"><a href="#cb450-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb450-13"><a href="#cb450-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb450-14"><a href="#cb450-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-15"><a href="#cb450-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb450-16"><a href="#cb450-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupAutoSave</span>()<span class="op">;</span></span>
<span id="cb450-17"><a href="#cb450-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-18"><a href="#cb450-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-19"><a href="#cb450-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb450-20"><a href="#cb450-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb450-21"><a href="#cb450-21" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;style&gt;</span></span>
<span id="cb450-22"><a href="#cb450-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        .editor {</span></span>
<span id="cb450-23"><a href="#cb450-23" aria-hidden="true" tabindex="-1"></a><span class="vs">          max-width: 900px;</span></span>
<span id="cb450-24"><a href="#cb450-24" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin: 0 auto;</span></span>
<span id="cb450-25"><a href="#cb450-25" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 2rem;</span></span>
<span id="cb450-26"><a href="#cb450-26" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-27"><a href="#cb450-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-28"><a href="#cb450-28" aria-hidden="true" tabindex="-1"></a><span class="vs">        .title-input {</span></span>
<span id="cb450-29"><a href="#cb450-29" aria-hidden="true" tabindex="-1"></a><span class="vs">          width: 100%;</span></span>
<span id="cb450-30"><a href="#cb450-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 2rem;</span></span>
<span id="cb450-31"><a href="#cb450-31" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-weight: bold;</span></span>
<span id="cb450-32"><a href="#cb450-32" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: none;</span></span>
<span id="cb450-33"><a href="#cb450-33" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-bottom: 2px solid #e0e0e0;</span></span>
<span id="cb450-34"><a href="#cb450-34" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 0;</span></span>
<span id="cb450-35"><a href="#cb450-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 2rem;</span></span>
<span id="cb450-36"><a href="#cb450-36" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-37"><a href="#cb450-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-38"><a href="#cb450-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        .content-editor {</span></span>
<span id="cb450-39"><a href="#cb450-39" aria-hidden="true" tabindex="-1"></a><span class="vs">          min-height: 400px;</span></span>
<span id="cb450-40"><a href="#cb450-40" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #e0e0e0;</span></span>
<span id="cb450-41"><a href="#cb450-41" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb450-42"><a href="#cb450-42" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 1rem;</span></span>
<span id="cb450-43"><a href="#cb450-43" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-family: monospace;</span></span>
<span id="cb450-44"><a href="#cb450-44" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-45"><a href="#cb450-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-46"><a href="#cb450-46" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toolbar {</span></span>
<span id="cb450-47"><a href="#cb450-47" aria-hidden="true" tabindex="-1"></a><span class="vs">          display: flex;</span></span>
<span id="cb450-48"><a href="#cb450-48" aria-hidden="true" tabindex="-1"></a><span class="vs">          gap: 0.5rem;</span></span>
<span id="cb450-49"><a href="#cb450-49" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-bottom: 1rem;</span></span>
<span id="cb450-50"><a href="#cb450-50" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem;</span></span>
<span id="cb450-51"><a href="#cb450-51" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: #f5f5f5;</span></span>
<span id="cb450-52"><a href="#cb450-52" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb450-53"><a href="#cb450-53" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-54"><a href="#cb450-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-55"><a href="#cb450-55" aria-hidden="true" tabindex="-1"></a><span class="vs">        .toolbar button {</span></span>
<span id="cb450-56"><a href="#cb450-56" aria-hidden="true" tabindex="-1"></a><span class="vs">          padding: 0.5rem 1rem;</span></span>
<span id="cb450-57"><a href="#cb450-57" aria-hidden="true" tabindex="-1"></a><span class="vs">          background: white;</span></span>
<span id="cb450-58"><a href="#cb450-58" aria-hidden="true" tabindex="-1"></a><span class="vs">          border: 1px solid #ccc;</span></span>
<span id="cb450-59"><a href="#cb450-59" aria-hidden="true" tabindex="-1"></a><span class="vs">          border-radius: 4px;</span></span>
<span id="cb450-60"><a href="#cb450-60" aria-hidden="true" tabindex="-1"></a><span class="vs">          cursor: pointer;</span></span>
<span id="cb450-61"><a href="#cb450-61" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-62"><a href="#cb450-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-63"><a href="#cb450-63" aria-hidden="true" tabindex="-1"></a><span class="vs">        .save-status {</span></span>
<span id="cb450-64"><a href="#cb450-64" aria-hidden="true" tabindex="-1"></a><span class="vs">          text-align: right;</span></span>
<span id="cb450-65"><a href="#cb450-65" aria-hidden="true" tabindex="-1"></a><span class="vs">          color: #666;</span></span>
<span id="cb450-66"><a href="#cb450-66" aria-hidden="true" tabindex="-1"></a><span class="vs">          font-size: 0.875rem;</span></span>
<span id="cb450-67"><a href="#cb450-67" aria-hidden="true" tabindex="-1"></a><span class="vs">          margin-top: 1rem;</span></span>
<span id="cb450-68"><a href="#cb450-68" aria-hidden="true" tabindex="-1"></a><span class="vs">        }</span></span>
<span id="cb450-69"><a href="#cb450-69" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/style&gt;</span></span>
<span id="cb450-70"><a href="#cb450-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-71"><a href="#cb450-71" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;editor&quot;&gt;</span></span>
<span id="cb450-72"><a href="#cb450-72" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input</span></span>
<span id="cb450-73"><a href="#cb450-73" aria-hidden="true" tabindex="-1"></a><span class="vs">          type=&quot;text&quot;</span></span>
<span id="cb450-74"><a href="#cb450-74" aria-hidden="true" tabindex="-1"></a><span class="vs">          class=&quot;title-input&quot;</span></span>
<span id="cb450-75"><a href="#cb450-75" aria-hidden="true" tabindex="-1"></a><span class="vs">          placeholder=&quot;Article Title&quot;</span></span>
<span id="cb450-76"><a href="#cb450-76" aria-hidden="true" tabindex="-1"></a><span class="vs">          value=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">article</span><span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs">&quot;</span></span>
<span id="cb450-77"><a href="#cb450-77" aria-hidden="true" tabindex="-1"></a><span class="vs">        &gt;</span></span>
<span id="cb450-78"><a href="#cb450-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-79"><a href="#cb450-79" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;toolbar&quot;&gt;</span></span>
<span id="cb450-80"><a href="#cb450-80" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button data-action=&quot;bold&quot;&gt;Bold&lt;/button&gt;</span></span>
<span id="cb450-81"><a href="#cb450-81" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button data-action=&quot;italic&quot;&gt;Italic&lt;/button&gt;</span></span>
<span id="cb450-82"><a href="#cb450-82" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button data-action=&quot;link&quot;&gt;Link&lt;/button&gt;</span></span>
<span id="cb450-83"><a href="#cb450-83" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button data-action=&quot;image&quot;&gt;Image&lt;/button&gt;</span></span>
<span id="cb450-84"><a href="#cb450-84" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button data-action=&quot;code&quot;&gt;Code Block&lt;/button&gt;</span></span>
<span id="cb450-85"><a href="#cb450-85" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb450-86"><a href="#cb450-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-87"><a href="#cb450-87" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;textarea</span></span>
<span id="cb450-88"><a href="#cb450-88" aria-hidden="true" tabindex="-1"></a><span class="vs">          class=&quot;content-editor&quot;</span></span>
<span id="cb450-89"><a href="#cb450-89" aria-hidden="true" tabindex="-1"></a><span class="vs">          placeholder=&quot;Write your article in Markdown...&quot;</span></span>
<span id="cb450-90"><a href="#cb450-90" aria-hidden="true" tabindex="-1"></a><span class="vs">        &gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">article</span><span class="op">.</span><span class="at">content</span><span class="sc">}</span><span class="vs">&lt;/textarea&gt;</span></span>
<span id="cb450-91"><a href="#cb450-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-92"><a href="#cb450-92" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;save-status&quot;&gt;</span></span>
<span id="cb450-93"><a href="#cb450-93" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;span class=&quot;status-text&quot;&gt;All changes saved&lt;/span&gt;</span></span>
<span id="cb450-94"><a href="#cb450-94" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb450-95"><a href="#cb450-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-96"><a href="#cb450-96" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div class=&quot;actions&quot;&gt;</span></span>
<span id="cb450-97"><a href="#cb450-97" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button class=&quot;preview-btn&quot;&gt;Preview&lt;/button&gt;</span></span>
<span id="cb450-98"><a href="#cb450-98" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button class=&quot;publish-btn&quot;&gt;Publish&lt;/button&gt;</span></span>
<span id="cb450-99"><a href="#cb450-99" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;button class=&quot;save-draft-btn&quot;&gt;Save Draft&lt;/button&gt;</span></span>
<span id="cb450-100"><a href="#cb450-100" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb450-101"><a href="#cb450-101" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb450-102"><a href="#cb450-102" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb450-103"><a href="#cb450-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-104"><a href="#cb450-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setupEditorEvents</span>()<span class="op">;</span></span>
<span id="cb450-105"><a href="#cb450-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-106"><a href="#cb450-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-107"><a href="#cb450-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupEditorEvents</span>() {</span>
<span id="cb450-108"><a href="#cb450-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> titleInput <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.title-input&#39;</span>)<span class="op">;</span></span>
<span id="cb450-109"><a href="#cb450-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contentEditor <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.content-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb450-110"><a href="#cb450-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-111"><a href="#cb450-111" aria-hidden="true" tabindex="-1"></a>    titleInput<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb450-112"><a href="#cb450-112" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">article</span><span class="op">.</span><span class="at">title</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb450-113"><a href="#cb450-113" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">markDirty</span>()<span class="op">;</span></span>
<span id="cb450-114"><a href="#cb450-114" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb450-115"><a href="#cb450-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-116"><a href="#cb450-116" aria-hidden="true" tabindex="-1"></a>    contentEditor<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;input&#39;</span><span class="op">,</span> (e) <span class="kw">=&gt;</span> {</span>
<span id="cb450-117"><a href="#cb450-117" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">article</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> e<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb450-118"><a href="#cb450-118" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">markDirty</span>()<span class="op">;</span></span>
<span id="cb450-119"><a href="#cb450-119" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb450-120"><a href="#cb450-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-121"><a href="#cb450-121" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Toolbar actions</span></span>
<span id="cb450-122"><a href="#cb450-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;[data-action]&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>(btn <span class="kw">=&gt;</span> {</span>
<span id="cb450-123"><a href="#cb450-123" aria-hidden="true" tabindex="-1"></a>      btn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb450-124"><a href="#cb450-124" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">applyFormatting</span>(btn<span class="op">.</span><span class="at">dataset</span><span class="op">.</span><span class="at">action</span>)<span class="op">;</span></span>
<span id="cb450-125"><a href="#cb450-125" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb450-126"><a href="#cb450-126" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb450-127"><a href="#cb450-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-128"><a href="#cb450-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-129"><a href="#cb450-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setupAutoSave</span>() {</span>
<span id="cb450-130"><a href="#cb450-130" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb450-131"><a href="#cb450-131" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">dirty</span>) {</span>
<span id="cb450-132"><a href="#cb450-132" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">save</span>()<span class="op">;</span></span>
<span id="cb450-133"><a href="#cb450-133" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb450-134"><a href="#cb450-134" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="dv">10000</span>)<span class="op">;</span> <span class="co">// Auto-save every 10 seconds</span></span>
<span id="cb450-135"><a href="#cb450-135" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-136"><a href="#cb450-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-137"><a href="#cb450-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">markDirty</span>() {</span>
<span id="cb450-138"><a href="#cb450-138" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">dirty</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb450-139"><a href="#cb450-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status-text&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Unsaved changes&#39;</span><span class="op">;</span></span>
<span id="cb450-140"><a href="#cb450-140" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-141"><a href="#cb450-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-142"><a href="#cb450-142" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">save</span>() {</span>
<span id="cb450-143"><a href="#cb450-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb450-144"><a href="#cb450-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">await</span> contentService<span class="op">.</span><span class="fu">save</span>(<span class="kw">this</span><span class="op">.</span><span class="at">article</span>)<span class="op">;</span></span>
<span id="cb450-145"><a href="#cb450-145" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">dirty</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb450-146"><a href="#cb450-146" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status-text&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;All changes saved&#39;</span><span class="op">;</span></span>
<span id="cb450-147"><a href="#cb450-147" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb450-148"><a href="#cb450-148" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.status-text&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="st">&#39;Save failed&#39;</span><span class="op">;</span></span>
<span id="cb450-149"><a href="#cb450-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb450-150"><a href="#cb450-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-151"><a href="#cb450-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-152"><a href="#cb450-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">applyFormatting</span>(action) {</span>
<span id="cb450-153"><a href="#cb450-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> textarea <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">shadowRoot</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.content-editor&#39;</span>)<span class="op">;</span></span>
<span id="cb450-154"><a href="#cb450-154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> start <span class="op">=</span> textarea<span class="op">.</span><span class="at">selectionStart</span><span class="op">;</span></span>
<span id="cb450-155"><a href="#cb450-155" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> end <span class="op">=</span> textarea<span class="op">.</span><span class="at">selectionEnd</span><span class="op">;</span></span>
<span id="cb450-156"><a href="#cb450-156" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> selectedText <span class="op">=</span> textarea<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">substring</span>(start<span class="op">,</span> end)<span class="op">;</span></span>
<span id="cb450-157"><a href="#cb450-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-158"><a href="#cb450-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> formattedText<span class="op">;</span></span>
<span id="cb450-159"><a href="#cb450-159" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (action) {</span>
<span id="cb450-160"><a href="#cb450-160" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;bold&#39;</span><span class="op">:</span></span>
<span id="cb450-161"><a href="#cb450-161" aria-hidden="true" tabindex="-1"></a>        formattedText <span class="op">=</span> <span class="vs">`**</span><span class="sc">${</span>selectedText<span class="sc">}</span><span class="vs">**`</span><span class="op">;</span></span>
<span id="cb450-162"><a href="#cb450-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb450-163"><a href="#cb450-163" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;italic&#39;</span><span class="op">:</span></span>
<span id="cb450-164"><a href="#cb450-164" aria-hidden="true" tabindex="-1"></a>        formattedText <span class="op">=</span> <span class="vs">`*</span><span class="sc">${</span>selectedText<span class="sc">}</span><span class="vs">*`</span><span class="op">;</span></span>
<span id="cb450-165"><a href="#cb450-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb450-166"><a href="#cb450-166" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;code&#39;</span><span class="op">:</span></span>
<span id="cb450-167"><a href="#cb450-167" aria-hidden="true" tabindex="-1"></a>        formattedText <span class="op">=</span> <span class="vs">`</span><span class="sc">\`\`\`\n${</span>selectedText<span class="sc">}\n\`\`\`</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb450-168"><a href="#cb450-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb450-169"><a href="#cb450-169" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;link&#39;</span><span class="op">:</span></span>
<span id="cb450-170"><a href="#cb450-170" aria-hidden="true" tabindex="-1"></a>        formattedText <span class="op">=</span> <span class="vs">`[</span><span class="sc">${</span>selectedText<span class="sc">}</span><span class="vs">](url)`</span><span class="op">;</span></span>
<span id="cb450-171"><a href="#cb450-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb450-172"><a href="#cb450-172" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;image&#39;</span><span class="op">:</span></span>
<span id="cb450-173"><a href="#cb450-173" aria-hidden="true" tabindex="-1"></a>        formattedText <span class="op">=</span> <span class="vs">`![</span><span class="sc">${</span>selectedText<span class="sc">}</span><span class="vs">](image-url)`</span><span class="op">;</span></span>
<span id="cb450-174"><a href="#cb450-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb450-175"><a href="#cb450-175" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb450-176"><a href="#cb450-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-177"><a href="#cb450-177" aria-hidden="true" tabindex="-1"></a>    textarea<span class="op">.</span><span class="at">value</span> <span class="op">=</span></span>
<span id="cb450-178"><a href="#cb450-178" aria-hidden="true" tabindex="-1"></a>      textarea<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">substring</span>(<span class="dv">0</span><span class="op">,</span> start) <span class="op">+</span></span>
<span id="cb450-179"><a href="#cb450-179" aria-hidden="true" tabindex="-1"></a>      formattedText <span class="op">+</span></span>
<span id="cb450-180"><a href="#cb450-180" aria-hidden="true" tabindex="-1"></a>      textarea<span class="op">.</span><span class="at">value</span><span class="op">.</span><span class="fu">substring</span>(end)<span class="op">;</span></span>
<span id="cb450-181"><a href="#cb450-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-182"><a href="#cb450-182" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">article</span><span class="op">.</span><span class="at">content</span> <span class="op">=</span> textarea<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb450-183"><a href="#cb450-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">markDirty</span>()<span class="op">;</span></span>
<span id="cb450-184"><a href="#cb450-184" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb450-185"><a href="#cb450-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb450-186"><a href="#cb450-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-187"><a href="#cb450-187" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;article-editor&#39;</span><span class="op">,</span> ArticleEditor)<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.4.3" id="content-preview"><span
class="header-section-number">19.4.3</span> Content Preview</h3>
<div class="sourceCode" id="cb451"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="co">// markdown-renderer.js</span></span>
<span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MarkdownRenderer <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;content&#39;</span>]<span class="op">;</span></span>
<span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>(name<span class="op">,</span> oldValue<span class="op">,</span> newValue) {</span>
<span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (name <span class="op">===</span> <span class="st">&#39;content&#39;</span> <span class="op">&amp;&amp;</span> oldValue <span class="op">!==</span> newValue) {</span>
<span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb451-9"><a href="#cb451-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-10"><a href="#cb451-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-11"><a href="#cb451-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">render</span>() {</span>
<span id="cb451-12"><a href="#cb451-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> markdown <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;content&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb451-13"><a href="#cb451-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-14"><a href="#cb451-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use marked.js for markdown parsing</span></span>
<span id="cb451-15"><a href="#cb451-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { marked } <span class="op">=</span> <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;https://cdn.jsdelivr.net/npm/marked@12/+esm&#39;</span>)<span class="op">;</span></span>
<span id="cb451-16"><a href="#cb451-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-17"><a href="#cb451-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb451-18"><a href="#cb451-18" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;markdown-content&quot;&gt;</span></span>
<span id="cb451-19"><a href="#cb451-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>marked<span class="op">.</span><span class="fu">parse</span>(markdown)<span class="sc">}</span></span>
<span id="cb451-20"><a href="#cb451-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb451-21"><a href="#cb451-21" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb451-22"><a href="#cb451-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb451-23"><a href="#cb451-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb451-24"><a href="#cb451-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-25"><a href="#cb451-25" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;markdown-renderer&#39;</span><span class="op">,</span> MarkdownRenderer)<span class="op">;</span></span></code></pre></div>
<h2 data-number="19.5" id="architecture-decisions-and-tradeoffs"><span
class="header-section-number">19.5</span> Architecture Decisions and
Tradeoffs</h2>
<h3 data-number="19.5.1" id="when-to-use-larc-1"><span
class="header-section-number">19.5.1</span> When to Use LARC</h3>
<p><strong>✅ Great for:</strong> - Progressive web apps - Content-heavy
sites (blogs, documentation) - Dashboards and admin panels - Internal
tools - Prototypes and MVPs - Projects with long maintenance
horizons</p>
<p><strong>❌ Consider alternatives for:</strong> - Apps requiring
server-side rendering for SEO - Highly interactive games (use
Canvas/WebGL directly) - Apps requiring React Native for mobile - Teams
deeply invested in React/Vue ecosystem</p>
<h3 data-number="19.5.2" id="state-management-patterns"><span
class="header-section-number">19.5.2</span> State Management
Patterns</h3>
<p><strong>Local State (Component Properties):</strong></p>
<div class="sourceCode" id="cb452"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb452-2"><a href="#cb452-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb452-3"><a href="#cb452-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb452-4"><a href="#cb452-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Local state</span></span>
<span id="cb452-5"><a href="#cb452-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb452-6"><a href="#cb452-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb452-7"><a href="#cb452-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span>() {</span>
<span id="cb452-8"><a href="#cb452-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">count</span><span class="op">++;</span></span>
<span id="cb452-9"><a href="#cb452-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb452-10"><a href="#cb452-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb452-11"><a href="#cb452-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Shared State (PAN Bus):</strong></p>
<div class="sourceCode" id="cb453"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="co">// One component publishes</span></span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> { userId<span class="op">,</span> name })<span class="op">;</span></span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Many components subscribe</span></span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;user.login&#39;</span><span class="op">,</span> ({ name }) <span class="kw">=&gt;</span> {</span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">userName</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p><strong>Persistent State (LocalStorage + PAN):</strong></p>
<div class="sourceCode" id="cb454"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppState {</span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb454-3"><a href="#cb454-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(localStorage<span class="op">.</span><span class="fu">getItem</span>(<span class="st">&#39;app-state&#39;</span>)) <span class="op">||</span> {}<span class="op">;</span></span>
<span id="cb454-4"><a href="#cb454-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-5"><a href="#cb454-5" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;state.*&#39;</span><span class="op">,</span> (data<span class="op">,</span> topic) <span class="kw">=&gt;</span> {</span>
<span id="cb454-6"><a href="#cb454-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> key <span class="op">=</span> topic<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb454-7"><a href="#cb454-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">state</span>[key] <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb454-8"><a href="#cb454-8" aria-hidden="true" tabindex="-1"></a>      localStorage<span class="op">.</span><span class="fu">setItem</span>(<span class="st">&#39;app-state&#39;</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(<span class="kw">this</span><span class="op">.</span><span class="at">state</span>))<span class="op">;</span></span>
<span id="cb454-9"><a href="#cb454-9" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb454-10"><a href="#cb454-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb454-11"><a href="#cb454-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-12"><a href="#cb454-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(key) {</span>
<span id="cb454-13"><a href="#cb454-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span>[key]<span class="op">;</span></span>
<span id="cb454-14"><a href="#cb454-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb454-15"><a href="#cb454-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-16"><a href="#cb454-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(key<span class="op">,</span> value) {</span>
<span id="cb454-17"><a href="#cb454-17" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="vs">`state.</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb454-18"><a href="#cb454-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb454-19"><a href="#cb454-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb454-20"><a href="#cb454-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-21"><a href="#cb454-21" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> appState <span class="op">=</span> <span class="kw">new</span> <span class="fu">AppState</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.5.3" id="scaling-considerations"><span
class="header-section-number">19.5.3</span> Scaling Considerations</h3>
<p><strong>Code Organization:</strong></p>
<pre><code>large-app/
├── index.html
├── app.js
├── features/
│   ├── auth/
│   │   ├── components/
│   │   ├── services/
│   │   └── index.js
│   ├── products/
│   │   ├── components/
│   │   ├── services/
│   │   └── index.js
│   └── checkout/
│       ├── components/
│       ├── services/
│       └── index.js
├── shared/
│   ├── components/
│   ├── services/
│   └── utils/
└── config/
    ├── router.js
    └── pan.js</code></pre>
<p><strong>Lazy Loading Features:</strong></p>
<div class="sourceCode" id="cb456"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a><span class="co">// app.js - Load features on demand</span></span>
<span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> features <span class="op">=</span> {</span>
<span id="cb456-3"><a href="#cb456-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;auth&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./features/auth/index.js&#39;</span>)<span class="op">,</span></span>
<span id="cb456-4"><a href="#cb456-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;products&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./features/products/index.js&#39;</span>)<span class="op">,</span></span>
<span id="cb456-5"><a href="#cb456-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;checkout&#39;</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="im">import</span>(<span class="st">&#39;./features/checkout/index.js&#39;</span>)</span>
<span id="cb456-6"><a href="#cb456-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb456-7"><a href="#cb456-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb456-8"><a href="#cb456-8" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;feature.load&#39;</span><span class="op">,</span> <span class="kw">async</span> ({ name }) <span class="kw">=&gt;</span> {</span>
<span id="cb456-9"><a href="#cb456-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (features[name]) {</span>
<span id="cb456-10"><a href="#cb456-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> features[name]()<span class="op">;</span></span>
<span id="cb456-11"><a href="#cb456-11" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;feature.loaded&#39;</span><span class="op">,</span> { name })<span class="op">;</span></span>
<span id="cb456-12"><a href="#cb456-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb456-13"><a href="#cb456-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb456-14"><a href="#cb456-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb456-15"><a href="#cb456-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Auto-load on route change</span></span>
<span id="cb456-16"><a href="#cb456-16" aria-hidden="true" tabindex="-1"></a>pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> ({ path }) <span class="kw">=&gt;</span> {</span>
<span id="cb456-17"><a href="#cb456-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> feature <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;/&#39;</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb456-18"><a href="#cb456-18" aria-hidden="true" tabindex="-1"></a>  pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;feature.load&#39;</span><span class="op">,</span> { <span class="dt">name</span><span class="op">:</span> feature })<span class="op">;</span></span>
<span id="cb456-19"><a href="#cb456-19" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.5.4" id="performance-at-scale"><span
class="header-section-number">19.5.4</span> Performance at Scale</h3>
<p><strong>Virtual Scrolling for Large Lists:</strong></p>
<div class="sourceCode" id="cb457"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VirtualList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb457-4"><a href="#cb457-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb457-5"><a href="#cb457-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span> <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb457-6"><a href="#cb457-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span> <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb457-7"><a href="#cb457-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb457-8"><a href="#cb457-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb457-9"><a href="#cb457-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb457-10"><a href="#cb457-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> <span class="fu">data</span>(items) {</span>
<span id="cb457-11"><a href="#cb457-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">items</span> <span class="op">=</span> items<span class="op">;</span></span>
<span id="cb457-12"><a href="#cb457-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb457-13"><a href="#cb457-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb457-14"><a href="#cb457-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb457-15"><a href="#cb457-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb457-16"><a href="#cb457-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;scroll&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb457-17"><a href="#cb457-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span><span class="op">;</span></span>
<span id="cb457-18"><a href="#cb457-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">requestAnimationFrame</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>())<span class="op">;</span></span>
<span id="cb457-19"><a href="#cb457-19" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb457-20"><a href="#cb457-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb457-21"><a href="#cb457-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb457-22"><a href="#cb457-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb457-23"><a href="#cb457-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span> <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span>)<span class="op">;</span></span>
<span id="cb457-24"><a href="#cb457-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> endIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(startIndex <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">visibleCount</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb457-25"><a href="#cb457-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> visibleItems <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="fu">slice</span>(startIndex<span class="op">,</span> endIndex)<span class="op">;</span></span>
<span id="cb457-26"><a href="#cb457-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb457-27"><a href="#cb457-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb457-28"><a href="#cb457-28" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">items</span><span class="op">.</span><span class="at">length</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px; position: relative;&quot;&gt;</span></span>
<span id="cb457-29"><a href="#cb457-29" aria-hidden="true" tabindex="-1"></a><span class="vs">        </span><span class="sc">${</span>visibleItems<span class="op">.</span><span class="fu">map</span>((item<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="vs">`</span></span>
<span id="cb457-30"><a href="#cb457-30" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;div style=&quot;</span></span>
<span id="cb457-31"><a href="#cb457-31" aria-hidden="true" tabindex="-1"></a><span class="vs">            position: absolute;</span></span>
<span id="cb457-32"><a href="#cb457-32" aria-hidden="true" tabindex="-1"></a><span class="vs">            top: </span><span class="sc">${</span>(startIndex <span class="op">+</span> i) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb457-33"><a href="#cb457-33" aria-hidden="true" tabindex="-1"></a><span class="vs">            height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">itemHeight</span><span class="sc">}</span><span class="vs">px;</span></span>
<span id="cb457-34"><a href="#cb457-34" aria-hidden="true" tabindex="-1"></a><span class="vs">            width: 100%;</span></span>
<span id="cb457-35"><a href="#cb457-35" aria-hidden="true" tabindex="-1"></a><span class="vs">          &quot;&gt;</span></span>
<span id="cb457-36"><a href="#cb457-36" aria-hidden="true" tabindex="-1"></a><span class="vs">            </span><span class="sc">${</span>item<span class="op">.</span><span class="at">name</span><span class="sc">}</span></span>
<span id="cb457-37"><a href="#cb457-37" aria-hidden="true" tabindex="-1"></a><span class="vs">          &lt;/div&gt;</span></span>
<span id="cb457-38"><a href="#cb457-38" aria-hidden="true" tabindex="-1"></a><span class="vs">        `</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb457-39"><a href="#cb457-39" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb457-40"><a href="#cb457-40" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb457-41"><a href="#cb457-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb457-42"><a href="#cb457-42" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Memoization and Caching:</strong></p>
<div class="sourceCode" id="cb458"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductCatalog <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb458-5"><a href="#cb458-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cacheTimeout</span> <span class="op">=</span> <span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// 5 minutes</span></span>
<span id="cb458-6"><a href="#cb458-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb458-7"><a href="#cb458-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-8"><a href="#cb458-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">getProducts</span>(category) {</span>
<span id="cb458-9"><a href="#cb458-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cacheKey <span class="op">=</span> <span class="vs">`products-</span><span class="sc">${</span>category<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb458-10"><a href="#cb458-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cached <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">get</span>(cacheKey)<span class="op">;</span></span>
<span id="cb458-11"><a href="#cb458-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-12"><a href="#cb458-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (cached <span class="op">&amp;&amp;</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> cached<span class="op">.</span><span class="at">timestamp</span> <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">cacheTimeout</span>) {</span>
<span id="cb458-13"><a href="#cb458-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> cached<span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb458-14"><a href="#cb458-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb458-15"><a href="#cb458-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-16"><a href="#cb458-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> productService<span class="op">.</span><span class="fu">getByCategory</span>(category)<span class="op">;</span></span>
<span id="cb458-17"><a href="#cb458-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-18"><a href="#cb458-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">cache</span><span class="op">.</span><span class="fu">set</span>(cacheKey<span class="op">,</span> {</span>
<span id="cb458-19"><a href="#cb458-19" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb458-20"><a href="#cb458-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">timestamp</span><span class="op">:</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()</span>
<span id="cb458-21"><a href="#cb458-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb458-22"><a href="#cb458-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-23"><a href="#cb458-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data<span class="op">;</span></span>
<span id="cb458-24"><a href="#cb458-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb458-25"><a href="#cb458-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="19.6" id="maintenance-and-evolution"><span
class="header-section-number">19.6</span> Maintenance and Evolution</h2>
<h3 data-number="19.6.1" id="versioning-components"><span
class="header-section-number">19.6.1</span> Versioning Components</h3>
<div class="sourceCode" id="cb459"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="co">// v1/button.js</span></span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ButtonV1 <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Original implementation</span></span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;app-button-v1&#39;</span><span class="op">,</span> ButtonV1)<span class="op">;</span></span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a><span class="co">// v2/button.js</span></span>
<span id="cb459-8"><a href="#cb459-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ButtonV2 <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb459-9"><a href="#cb459-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// New implementation with breaking changes</span></span>
<span id="cb459-10"><a href="#cb459-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb459-11"><a href="#cb459-11" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;app-button&#39;</span><span class="op">,</span> ButtonV2)<span class="op">;</span></span>
<span id="cb459-12"><a href="#cb459-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-13"><a href="#cb459-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Migration path: Both versions coexist</span></span>
<span id="cb459-14"><a href="#cb459-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Old code uses app-button-v1</span></span>
<span id="cb459-15"><a href="#cb459-15" aria-hidden="true" tabindex="-1"></a><span class="co">// New code uses app-button</span></span>
<span id="cb459-16"><a href="#cb459-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Gradual migration over time</span></span></code></pre></div>
<h3 data-number="19.6.2" id="feature-flags"><span
class="header-section-number">19.6.2</span> Feature Flags</h3>
<div class="sourceCode" id="cb460"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="co">// feature-flags.js</span></span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeatureFlags {</span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">flags</span> <span class="op">=</span> {</span>
<span id="cb460-5"><a href="#cb460-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;new-checkout&#39;</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb460-6"><a href="#cb460-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;beta-dashboard&#39;</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb460-7"><a href="#cb460-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;experimental-editor&#39;</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb460-8"><a href="#cb460-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb460-9"><a href="#cb460-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb460-10"><a href="#cb460-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-11"><a href="#cb460-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">isEnabled</span>(feature) {</span>
<span id="cb460-12"><a href="#cb460-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">flags</span>[feature] <span class="op">??</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb460-13"><a href="#cb460-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb460-14"><a href="#cb460-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-15"><a href="#cb460-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enable</span>(feature) {</span>
<span id="cb460-16"><a href="#cb460-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">flags</span>[feature] <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb460-17"><a href="#cb460-17" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;feature-flag.changed&#39;</span><span class="op">,</span> { feature<span class="op">,</span> <span class="dt">enabled</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb460-18"><a href="#cb460-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb460-19"><a href="#cb460-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb460-20"><a href="#cb460-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-21"><a href="#cb460-21" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> featureFlags <span class="op">=</span> <span class="kw">new</span> <span class="fu">FeatureFlags</span>()<span class="op">;</span></span>
<span id="cb460-22"><a href="#cb460-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-23"><a href="#cb460-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage in component</span></span>
<span id="cb460-24"><a href="#cb460-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Checkout <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb460-25"><a href="#cb460-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb460-26"><a href="#cb460-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (featureFlags<span class="op">.</span><span class="fu">isEnabled</span>(<span class="st">&#39;new-checkout&#39;</span>)) {</span>
<span id="cb460-27"><a href="#cb460-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;new-checkout-flow&gt;&lt;/new-checkout-flow&gt;&#39;</span><span class="op">;</span></span>
<span id="cb460-28"><a href="#cb460-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb460-29"><a href="#cb460-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;legacy-checkout-flow&gt;&lt;/legacy-checkout-flow&gt;&#39;</span><span class="op">;</span></span>
<span id="cb460-30"><a href="#cb460-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb460-31"><a href="#cb460-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb460-32"><a href="#cb460-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.6.3" id="migration-from-react"><span
class="header-section-number">19.6.3</span> Migration from React</h3>
<p>Here’s how to migrate a React app to LARC:</p>
<p><strong>React Component:</strong></p>
<div class="sourceCode" id="cb461"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">TodoItem</span>({ todo<span class="op">,</span> onComplete }) {</span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;todo-item&quot;</span><span class="op">&gt;</span></span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>input</span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a>        type<span class="op">=</span><span class="st">&quot;checkbox&quot;</span></span>
<span id="cb461-6"><a href="#cb461-6" aria-hidden="true" tabindex="-1"></a>        checked<span class="op">=</span>{todo<span class="op">.</span><span class="at">completed</span>}</span>
<span id="cb461-7"><a href="#cb461-7" aria-hidden="true" tabindex="-1"></a>        onChange<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="fu">onComplete</span>(todo<span class="op">.</span><span class="at">id</span>)}</span>
<span id="cb461-8"><a href="#cb461-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">/&gt;</span></span>
<span id="cb461-9"><a href="#cb461-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;</span>span<span class="op">&gt;</span>{todo<span class="op">.</span><span class="at">text</span>}<span class="op">&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb461-10"><a href="#cb461-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb461-11"><a href="#cb461-11" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb461-12"><a href="#cb461-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>LARC Equivalent:</strong></p>
<div class="sourceCode" id="cb462"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TodoItem <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;completed&#39;</span>]<span class="op">;</span></span>
<span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-4"><a href="#cb462-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb462-5"><a href="#cb462-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb462-6"><a href="#cb462-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb462-7"><a href="#cb462-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-8"><a href="#cb462-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attributeChangedCallback</span>() {</span>
<span id="cb462-9"><a href="#cb462-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb462-10"><a href="#cb462-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb462-11"><a href="#cb462-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-12"><a href="#cb462-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb462-13"><a href="#cb462-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> completed <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">hasAttribute</span>(<span class="st">&#39;completed&#39;</span>)<span class="op">;</span></span>
<span id="cb462-14"><a href="#cb462-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> text <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;text&#39;</span>) <span class="op">||</span> <span class="st">&#39;&#39;</span><span class="op">;</span></span>
<span id="cb462-15"><a href="#cb462-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-16"><a href="#cb462-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb462-17"><a href="#cb462-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;todo-item&quot;&gt;</span></span>
<span id="cb462-18"><a href="#cb462-18" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;input</span></span>
<span id="cb462-19"><a href="#cb462-19" aria-hidden="true" tabindex="-1"></a><span class="vs">          type=&quot;checkbox&quot;</span></span>
<span id="cb462-20"><a href="#cb462-20" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>completed <span class="op">?</span> <span class="st">&#39;checked&#39;</span> <span class="op">:</span> <span class="st">&#39;&#39;</span><span class="sc">}</span></span>
<span id="cb462-21"><a href="#cb462-21" aria-hidden="true" tabindex="-1"></a><span class="vs">        &gt;</span></span>
<span id="cb462-22"><a href="#cb462-22" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;span&gt;</span><span class="sc">${</span>text<span class="sc">}</span><span class="vs">&lt;/span&gt;</span></span>
<span id="cb462-23"><a href="#cb462-23" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb462-24"><a href="#cb462-24" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb462-25"><a href="#cb462-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-26"><a href="#cb462-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb462-27"><a href="#cb462-27" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;todo.complete&#39;</span><span class="op">,</span> { <span class="dt">id</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;todo-id&#39;</span>) })<span class="op">;</span></span>
<span id="cb462-28"><a href="#cb462-28" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb462-29"><a href="#cb462-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb462-30"><a href="#cb462-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb462-31"><a href="#cb462-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-32"><a href="#cb462-32" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;todo-item&#39;</span><span class="op">,</span> TodoItem)<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.6.4" id="migration-from-vue"><span
class="header-section-number">19.6.4</span> Migration from Vue</h3>
<p><strong>Vue Component:</strong></p>
<pre class="vue"><code>&lt;template&gt;
  &lt;div class=&quot;user-card&quot;&gt;
    &lt;img :src=&quot;user.avatar&quot; :alt=&quot;user.name&quot;&gt;
    &lt;h3&gt;{{ user.name }}&lt;/h3&gt;
    &lt;p&gt;{{ user.email }}&lt;/p&gt;
    &lt;button @click=&quot;viewProfile&quot;&gt;View Profile&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  props: [&#39;user&#39;],
  methods: {
    viewProfile() {
      this.$router.push(`/user/${this.user.id}`);
    }
  }
}
&lt;/script&gt;</code></pre>
<p><strong>LARC Equivalent:</strong></p>
<div class="sourceCode" id="cb464"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static</span> observedAttributes <span class="op">=</span> [<span class="st">&#39;user-id&#39;</span>]<span class="op">;</span></span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-4"><a href="#cb464-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">connectedCallback</span>() {</span>
<span id="cb464-5"><a href="#cb464-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> userId <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;user-id&#39;</span>)<span class="op">;</span></span>
<span id="cb464-6"><a href="#cb464-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">user</span> <span class="op">=</span> <span class="cf">await</span> userService<span class="op">.</span><span class="fu">get</span>(userId)<span class="op">;</span></span>
<span id="cb464-7"><a href="#cb464-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb464-8"><a href="#cb464-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb464-9"><a href="#cb464-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-10"><a href="#cb464-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb464-11"><a href="#cb464-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb464-12"><a href="#cb464-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div class=&quot;user-card&quot;&gt;</span></span>
<span id="cb464-13"><a href="#cb464-13" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;img src=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">avatar</span><span class="sc">}</span><span class="vs">&quot; alt=&quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&quot;&gt;</span></span>
<span id="cb464-14"><a href="#cb464-14" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;h3&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">&lt;/h3&gt;</span></span>
<span id="cb464-15"><a href="#cb464-15" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;p&gt;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">email</span><span class="sc">}</span><span class="vs">&lt;/p&gt;</span></span>
<span id="cb464-16"><a href="#cb464-16" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;button class=&quot;view-btn&quot;&gt;View Profile&lt;/button&gt;</span></span>
<span id="cb464-17"><a href="#cb464-17" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb464-18"><a href="#cb464-18" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb464-19"><a href="#cb464-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-20"><a href="#cb464-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;.view-btn&#39;</span>)<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb464-21"><a href="#cb464-21" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">publish</span>(<span class="st">&#39;router.navigate&#39;</span><span class="op">,</span> { <span class="dt">path</span><span class="op">:</span> <span class="vs">`/user/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">user</span><span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">`</span> })<span class="op">;</span></span>
<span id="cb464-22"><a href="#cb464-22" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb464-23"><a href="#cb464-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb464-24"><a href="#cb464-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb464-25"><a href="#cb464-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb464-26"><a href="#cb464-26" aria-hidden="true" tabindex="-1"></a>customElements<span class="op">.</span><span class="fu">define</span>(<span class="st">&#39;user-card&#39;</span><span class="op">,</span> UserCard)<span class="op">;</span></span></code></pre></div>
<h2 data-number="19.7" id="real-world-challenges-and-solutions"><span
class="header-section-number">19.7</span> Real-World Challenges and
Solutions</h2>
<h3 data-number="19.7.1" id="challenge-1-seo-for-content-sites"><span
class="header-section-number">19.7.1</span> Challenge 1: SEO for Content
Sites</h3>
<p><strong>Problem</strong>: Client-side rendering isn’t indexed by
search engines.</p>
<p><strong>Solution</strong>: Pre-render static content</p>
<div class="sourceCode" id="cb465"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a><span class="co">// build-static.js - Pre-render pages at build time</span></span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { JSDOM } <span class="im">from</span> <span class="st">&#39;jsdom&#39;</span><span class="op">;</span></span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { writeFileSync } <span class="im">from</span> <span class="st">&#39;fs&#39;</span><span class="op">;</span></span>
<span id="cb465-4"><a href="#cb465-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-5"><a href="#cb465-5" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">prerender</span>(url<span class="op">,</span> outputPath) {</span>
<span id="cb465-6"><a href="#cb465-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> dom <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSDOM</span>(html)<span class="op">;</span></span>
<span id="cb465-7"><a href="#cb465-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">window</span> <span class="op">=</span> dom<span class="op">.</span><span class="at">window</span><span class="op">;</span></span>
<span id="cb465-8"><a href="#cb465-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">global</span><span class="op">.</span><span class="at">document</span> <span class="op">=</span> dom<span class="op">.</span><span class="at">window</span><span class="op">.</span><span class="at">document</span><span class="op">;</span></span>
<span id="cb465-9"><a href="#cb465-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-10"><a href="#cb465-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Load and execute components</span></span>
<span id="cb465-11"><a href="#cb465-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="im">import</span>(<span class="st">&#39;./components/article-page.js&#39;</span>)<span class="op">;</span></span>
<span id="cb465-12"><a href="#cb465-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-13"><a href="#cb465-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Wait for async content to load</span></span>
<span id="cb465-14"><a href="#cb465-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span></span>
<span id="cb465-15"><a href="#cb465-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-16"><a href="#cb465-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Write rendered HTML</span></span>
<span id="cb465-17"><a href="#cb465-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeFileSync</span>(outputPath<span class="op">,</span> dom<span class="op">.</span><span class="fu">serialize</span>())<span class="op">;</span></span>
<span id="cb465-18"><a href="#cb465-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb465-19"><a href="#cb465-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb465-20"><a href="#cb465-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Pre-render all blog posts</span></span>
<span id="cb465-21"><a href="#cb465-21" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> posts <span class="op">=</span> <span class="cf">await</span> contentService<span class="op">.</span><span class="fu">getAllPosts</span>()<span class="op">;</span></span>
<span id="cb465-22"><a href="#cb465-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">const</span> post <span class="kw">of</span> posts) {</span>
<span id="cb465-23"><a href="#cb465-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">await</span> <span class="fu">prerender</span>(<span class="vs">`/blog/</span><span class="sc">${</span>post<span class="op">.</span><span class="at">slug</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span> <span class="vs">`dist/blog/</span><span class="sc">${</span>post<span class="op">.</span><span class="at">slug</span><span class="sc">}</span><span class="vs">.html`</span>)<span class="op">;</span></span>
<span id="cb465-24"><a href="#cb465-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.7.2"
id="challenge-2-complex-state-synchronization"><span
class="header-section-number">19.7.2</span> Challenge 2: Complex State
Synchronization</h3>
<p><strong>Problem</strong>: Multiple components need to stay in sync
with complex state.</p>
<p><strong>Solution</strong>: Centralized state manager</p>
<div class="sourceCode" id="cb466"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="co">// state-manager.js</span></span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StateManager {</span>
<span id="cb466-3"><a href="#cb466-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb466-4"><a href="#cb466-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb466-5"><a href="#cb466-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscribers</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Map</span>()<span class="op">;</span></span>
<span id="cb466-6"><a href="#cb466-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-7"><a href="#cb466-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-8"><a href="#cb466-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">get</span>(path) {</span>
<span id="cb466-9"><a href="#cb466-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">.</span><span class="fu">reduce</span>((obj<span class="op">,</span> key) <span class="kw">=&gt;</span> obj<span class="op">?.</span>[key]<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span>)<span class="op">;</span></span>
<span id="cb466-10"><a href="#cb466-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-11"><a href="#cb466-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-12"><a href="#cb466-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span>(path<span class="op">,</span> value) {</span>
<span id="cb466-13"><a href="#cb466-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> keys <span class="op">=</span> path<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)<span class="op">;</span></span>
<span id="cb466-14"><a href="#cb466-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> lastKey <span class="op">=</span> keys<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span></span>
<span id="cb466-15"><a href="#cb466-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> target <span class="op">=</span> keys<span class="op">.</span><span class="fu">reduce</span>((obj<span class="op">,</span> key) <span class="kw">=&gt;</span> {</span>
<span id="cb466-16"><a href="#cb466-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span>obj[key]) obj[key] <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb466-17"><a href="#cb466-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> obj[key]<span class="op">;</span></span>
<span id="cb466-18"><a href="#cb466-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span>)<span class="op">;</span></span>
<span id="cb466-19"><a href="#cb466-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-20"><a href="#cb466-20" aria-hidden="true" tabindex="-1"></a>    target[lastKey] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb466-21"><a href="#cb466-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-22"><a href="#cb466-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Notify subscribers</span></span>
<span id="cb466-23"><a href="#cb466-23" aria-hidden="true" tabindex="-1"></a>    pan<span class="op">.</span><span class="fu">publish</span>(<span class="vs">`state.</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb466-24"><a href="#cb466-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-25"><a href="#cb466-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-26"><a href="#cb466-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span>(path<span class="op">,</span> callback) {</span>
<span id="cb466-27"><a href="#cb466-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="vs">`state.</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> callback)<span class="op">;</span></span>
<span id="cb466-28"><a href="#cb466-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb466-29"><a href="#cb466-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb466-30"><a href="#cb466-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb466-31"><a href="#cb466-31" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">const</span> state <span class="op">=</span> <span class="kw">new</span> <span class="fu">StateManager</span>()<span class="op">;</span></span></code></pre></div>
<h3 data-number="19.7.3"
id="challenge-3-testing-async-component-behavior"><span
class="header-section-number">19.7.3</span> Challenge 3: Testing Async
Component Behavior</h3>
<p><strong>Problem</strong>: Components with async data loading are hard
to test.</p>
<p><strong>Solution</strong>: Dependency injection and mocking</p>
<div class="sourceCode" id="cb467"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="co">// product-list.test.js</span></span>
<span id="cb467-2"><a href="#cb467-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { fixture<span class="op">,</span> html } <span class="im">from</span> <span class="st">&#39;@open-wc/testing&#39;</span><span class="op">;</span></span>
<span id="cb467-3"><a href="#cb467-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="st">&#39;./product-list.js&#39;</span><span class="op">;</span></span>
<span id="cb467-4"><a href="#cb467-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-5"><a href="#cb467-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Mock service</span></span>
<span id="cb467-6"><a href="#cb467-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mockProductService <span class="op">=</span> {</span>
<span id="cb467-7"><a href="#cb467-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">getAll</span><span class="op">:</span> () <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">resolve</span>([</span>
<span id="cb467-8"><a href="#cb467-8" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Product 1&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">10</span> }<span class="op">,</span></span>
<span id="cb467-9"><a href="#cb467-9" aria-hidden="true" tabindex="-1"></a>    { <span class="dt">id</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;Product 2&#39;</span><span class="op">,</span> <span class="dt">price</span><span class="op">:</span> <span class="dv">20</span> }</span>
<span id="cb467-10"><a href="#cb467-10" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb467-11"><a href="#cb467-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb467-12"><a href="#cb467-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-13"><a href="#cb467-13" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;ProductList&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb467-14"><a href="#cb467-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;renders products after loading&#39;</span><span class="op">,</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb467-15"><a href="#cb467-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inject mock</span></span>
<span id="cb467-16"><a href="#cb467-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="at">productService</span> <span class="op">=</span> mockProductService<span class="op">;</span></span>
<span id="cb467-17"><a href="#cb467-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-18"><a href="#cb467-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> el <span class="op">=</span> <span class="cf">await</span> <span class="fu">fixture</span>(<span class="fu">html</span><span class="vs">`&lt;product-list&gt;&lt;/product-list&gt;`</span>)<span class="op">;</span></span>
<span id="cb467-19"><a href="#cb467-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-20"><a href="#cb467-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for async render</span></span>
<span id="cb467-21"><a href="#cb467-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb467-22"><a href="#cb467-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-23"><a href="#cb467-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> products <span class="op">=</span> el<span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;product-card&#39;</span>)<span class="op">;</span></span>
<span id="cb467-24"><a href="#cb467-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(products<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="at">to</span><span class="op">.</span><span class="fu">equal</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb467-25"><a href="#cb467-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb467-26"><a href="#cb467-26" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 data-number="19.8" id="team-practices-and-workflows"><span
class="header-section-number">19.8</span> Team Practices and
Workflows</h2>
<h3 data-number="19.8.1" id="code-review-checklist"><span
class="header-section-number">19.8.1</span> Code Review Checklist</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Component follows single
responsibility principle</label></li>
<li><label><input type="checkbox" />Shadow DOM used for
encapsulation</label></li>
<li><label><input type="checkbox" />Event listeners cleaned up in
<code>disconnectedCallback</code></label></li>
<li><label><input type="checkbox" />Attributes declared in
<code>observedAttributes</code></label></li>
<li><label><input type="checkbox" />JSDoc comments for public
API</label></li>
<li><label><input type="checkbox" />Tests cover happy path and error
cases</label></li>
<li><label><input type="checkbox" />Accessible (keyboard navigation,
ARIA)</label></li>
<li><label><input type="checkbox" />Performance profiled (if rendering
&gt; 100 items)</label></li>
</ul>
<h3 data-number="19.8.2" id="component-design-guidelines"><span
class="header-section-number">19.8.2</span> Component Design
Guidelines</h3>
<ol type="1">
<li><strong>Keep components small</strong>: If a component is &gt; 200
lines, split it</li>
<li><strong>Prefer composition</strong>: Use slots and nested
components</li>
<li><strong>Clear naming</strong>:
<code>&lt;user-profile-card&gt;</code> not
<code>&lt;component-5&gt;</code></li>
<li><strong>Consistent patterns</strong>: All similar components follow
same structure</li>
<li><strong>Document props</strong>: JSDoc with type information</li>
<li><strong>Handle errors gracefully</strong>: Show user-friendly error
messages</li>
</ol>
<h3 data-number="19.8.3" id="development-workflow-1"><span
class="header-section-number">19.8.3</span> Development Workflow</h3>
<div class="sourceCode" id="cb468"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create feature branch</span></span>
<span id="cb468-2"><a href="#cb468-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout <span class="at">-b</span> feature/user-authentication</span>
<span id="cb468-3"><a href="#cb468-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-4"><a href="#cb468-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Write component with tests</span></span>
<span id="cb468-5"><a href="#cb468-5" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run test:watch</span>
<span id="cb468-6"><a href="#cb468-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-7"><a href="#cb468-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Run linter</span></span>
<span id="cb468-8"><a href="#cb468-8" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run lint</span>
<span id="cb468-9"><a href="#cb468-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-10"><a href="#cb468-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Create PR</span></span>
<span id="cb468-11"><a href="#cb468-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> push origin feature/user-authentication</span>
<span id="cb468-12"><a href="#cb468-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-13"><a href="#cb468-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. CI runs tests and linter</span></span>
<span id="cb468-14"><a href="#cb468-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Code review</span></span>
<span id="cb468-15"><a href="#cb468-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Merge to main</span></span>
<span id="cb468-16"><a href="#cb468-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Deploy to production</span></span>
<span id="cb468-17"><a href="#cb468-17" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> run deploy</span></code></pre></div>
<h2 data-number="19.9"
id="troubleshooting-real-world-applications"><span
class="header-section-number">19.9</span> Troubleshooting Real-World
Applications</h2>
<h3 data-number="19.9.1"
id="problem-1-component-state-gets-out-of-sync"><span
class="header-section-number">19.9.1</span> Problem 1: Component State
Gets Out of Sync</h3>
<p><strong>Symptoms</strong>: UI shows stale data, actions don’t reflect
in other parts of the app</p>
<p><strong>Cause</strong>: Multiple sources of truth, missed PAN bus
updates</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb469"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Bad: Duplicated state</span></span>
<span id="cb469-2"><a href="#cb469-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb469-3"><a href="#cb469-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb469-4"><a href="#cb469-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb469-5"><a href="#cb469-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">product</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>  <span class="co">// Local copy</span></span>
<span id="cb469-6"><a href="#cb469-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb469-7"><a href="#cb469-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb469-8"><a href="#cb469-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb469-9"><a href="#cb469-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Good: Single source of truth</span></span>
<span id="cb469-10"><a href="#cb469-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProductCard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb469-11"><a href="#cb469-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb469-12"><a href="#cb469-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to state changes</span></span>
<span id="cb469-13"><a href="#cb469-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">unsub</span> <span class="op">=</span> pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;products.*.updated&#39;</span><span class="op">,</span> (data<span class="op">,</span> topic) <span class="kw">=&gt;</span> {</span>
<span id="cb469-14"><a href="#cb469-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> productId <span class="op">=</span> topic<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;.&#39;</span>)[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb469-15"><a href="#cb469-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (productId <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">productId</span>) {</span>
<span id="cb469-16"><a href="#cb469-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">render</span>()<span class="op">;</span></span>
<span id="cb469-17"><a href="#cb469-17" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb469-18"><a href="#cb469-18" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb469-19"><a href="#cb469-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb469-20"><a href="#cb469-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.9.2"
id="problem-2-memory-leaks-in-long-running-apps"><span
class="header-section-number">19.9.2</span> Problem 2: Memory Leaks in
Long-Running Apps</h3>
<p><strong>Symptoms</strong>: App slows down over time, browser tab uses
increasing memory</p>
<p><strong>Cause</strong>: Event listeners not cleaned up, retained
references</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb470"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dashboard <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb470-2"><a href="#cb470-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">connectedCallback</span>() {</span>
<span id="cb470-3"><a href="#cb470-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track subscriptions for cleanup</span></span>
<span id="cb470-4"><a href="#cb470-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> [</span>
<span id="cb470-5"><a href="#cb470-5" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;metrics.updated&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleMetrics</span>)<span class="op">,</span></span>
<span id="cb470-6"><a href="#cb470-6" aria-hidden="true" tabindex="-1"></a>      pan<span class="op">.</span><span class="fu">subscribe</span>(<span class="st">&#39;alerts.new&#39;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">handleAlert</span>)</span>
<span id="cb470-7"><a href="#cb470-7" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb470-8"><a href="#cb470-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb470-9"><a href="#cb470-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Track intervals</span></span>
<span id="cb470-10"><a href="#cb470-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">updateInterval</span> <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">fetchUpdates</span>()<span class="op">,</span> <span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb470-11"><a href="#cb470-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb470-12"><a href="#cb470-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb470-13"><a href="#cb470-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">disconnectedCallback</span>() {</span>
<span id="cb470-14"><a href="#cb470-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean up all subscriptions</span></span>
<span id="cb470-15"><a href="#cb470-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span><span class="op">.</span><span class="fu">forEach</span>(unsub <span class="kw">=&gt;</span> <span class="fu">unsub</span>())<span class="op">;</span></span>
<span id="cb470-16"><a href="#cb470-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscriptions</span> <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb470-17"><a href="#cb470-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb470-18"><a href="#cb470-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear intervals</span></span>
<span id="cb470-19"><a href="#cb470-19" aria-hidden="true" tabindex="-1"></a>    <span class="pp">clearInterval</span>(<span class="kw">this</span><span class="op">.</span><span class="at">updateInterval</span>)<span class="op">;</span></span>
<span id="cb470-20"><a href="#cb470-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb470-21"><a href="#cb470-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.9.3"
id="problem-3-performance-degrades-with-large-datasets"><span
class="header-section-number">19.9.3</span> Problem 3: Performance
Degrades with Large Datasets</h3>
<p><strong>Symptoms</strong>: Slow rendering, laggy interactions when
displaying many items</p>
<p><strong>Cause</strong>: Rendering all items at once, no
virtualization</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb471"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Use virtual scrolling for large lists</span></span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VirtualProductList <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span>() {</span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> viewportHeight <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">clientHeight</span><span class="op">;</span></span>
<span id="cb471-5"><a href="#cb471-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> scrollTop <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">scrollTop</span><span class="op">;</span></span>
<span id="cb471-6"><a href="#cb471-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> itemHeight <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb471-7"><a href="#cb471-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-8"><a href="#cb471-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate visible range</span></span>
<span id="cb471-9"><a href="#cb471-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> startIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(scrollTop <span class="op">/</span> itemHeight)<span class="op">;</span></span>
<span id="cb471-10"><a href="#cb471-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> endIndex <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">ceil</span>((scrollTop <span class="op">+</span> viewportHeight) <span class="op">/</span> itemHeight)<span class="op">;</span></span>
<span id="cb471-11"><a href="#cb471-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-12"><a href="#cb471-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only render visible items</span></span>
<span id="cb471-13"><a href="#cb471-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> visibleItems <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="fu">slice</span>(startIndex<span class="op">,</span> endIndex <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb471-14"><a href="#cb471-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-15"><a href="#cb471-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb471-16"><a href="#cb471-16" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;div style=&quot;height: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">products</span><span class="op">.</span><span class="at">length</span> <span class="op">*</span> itemHeight<span class="sc">}</span><span class="vs">px&quot;&gt;</span></span>
<span id="cb471-17"><a href="#cb471-17" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;div style=&quot;transform: translateY(</span><span class="sc">${</span>startIndex <span class="op">*</span> itemHeight<span class="sc">}</span><span class="vs">px)&quot;&gt;</span></span>
<span id="cb471-18"><a href="#cb471-18" aria-hidden="true" tabindex="-1"></a><span class="vs">          </span><span class="sc">${</span>visibleItems<span class="op">.</span><span class="fu">map</span>(product <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">renderItem</span>(product))<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)<span class="sc">}</span></span>
<span id="cb471-19"><a href="#cb471-19" aria-hidden="true" tabindex="-1"></a><span class="vs">        &lt;/div&gt;</span></span>
<span id="cb471-20"><a href="#cb471-20" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/div&gt;</span></span>
<span id="cb471-21"><a href="#cb471-21" aria-hidden="true" tabindex="-1"></a><span class="vs">    `</span><span class="op">;</span></span>
<span id="cb471-22"><a href="#cb471-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb471-23"><a href="#cb471-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 data-number="19.9.4"
id="problem-4-race-conditions-with-async-operations"><span
class="header-section-number">19.9.4</span> Problem 4: Race Conditions
with Async Operations</h3>
<p><strong>Symptoms</strong>: Wrong data displayed, operations complete
out of order</p>
<p><strong>Cause</strong>: Multiple async requests, no cancellation or
ordering</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb472"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchBox <span class="kw">extends</span> <span class="bu">HTMLElement</span> {</span>
<span id="cb472-2"><a href="#cb472-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span>() {</span>
<span id="cb472-3"><a href="#cb472-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>()<span class="op">;</span></span>
<span id="cb472-4"><a href="#cb472-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb472-5"><a href="#cb472-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb472-6"><a href="#cb472-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-7"><a href="#cb472-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-8"><a href="#cb472-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">async</span> <span class="fu">search</span>(query) {</span>
<span id="cb472-9"><a href="#cb472-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Cancel previous request</span></span>
<span id="cb472-10"><a href="#cb472-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">abortController</span>) {</span>
<span id="cb472-11"><a href="#cb472-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="fu">abort</span>()<span class="op">;</span></span>
<span id="cb472-12"><a href="#cb472-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb472-13"><a href="#cb472-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-14"><a href="#cb472-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">AbortController</span>()<span class="op">;</span></span>
<span id="cb472-15"><a href="#cb472-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> currentRequestId <span class="op">=</span> <span class="op">++</span><span class="kw">this</span><span class="op">.</span><span class="at">requestId</span><span class="op">;</span></span>
<span id="cb472-16"><a href="#cb472-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-17"><a href="#cb472-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> {</span>
<span id="cb472-18"><a href="#cb472-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="vs">`/api/search?q=</span><span class="sc">${</span>query<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb472-19"><a href="#cb472-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">signal</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">abortController</span><span class="op">.</span><span class="at">signal</span></span>
<span id="cb472-20"><a href="#cb472-20" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb472-21"><a href="#cb472-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-22"><a href="#cb472-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Only update if this is still the latest request</span></span>
<span id="cb472-23"><a href="#cb472-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (currentRequestId <span class="op">===</span> <span class="kw">this</span><span class="op">.</span><span class="at">requestId</span>) {</span>
<span id="cb472-24"><a href="#cb472-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">displayResults</span>(<span class="cf">await</span> results<span class="op">.</span><span class="fu">json</span>())<span class="op">;</span></span>
<span id="cb472-25"><a href="#cb472-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb472-26"><a href="#cb472-26" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">catch</span> (err) {</span>
<span id="cb472-27"><a href="#cb472-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err<span class="op">.</span><span class="at">name</span> <span class="op">!==</span> <span class="st">&#39;AbortError&#39;</span>) <span class="cf">throw</span> err<span class="op">;</span></span>
<span id="cb472-28"><a href="#cb472-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb472-29"><a href="#cb472-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb472-30"><a href="#cb472-30" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="19.10" id="real-world-application-best-practices"><span
class="header-section-number">19.10</span> Real-World Application Best
Practices</h2>
<ol type="1">
<li><strong>Design for Scale from Day One</strong>
<ul>
<li>Plan component boundaries before coding</li>
<li>Use lazy loading for routes and heavy components</li>
<li>Profile performance early and often</li>
</ul></li>
<li><strong>Establish Clear State Management Patterns</strong>
<ul>
<li>Single source of truth for shared state</li>
<li>Local state for component-specific data</li>
<li>Document state flow in architecture diagrams</li>
</ul></li>
<li><strong>Implement Comprehensive Error Handling</strong>
<ul>
<li>Catch errors at component boundaries</li>
<li>Display user-friendly error messages</li>
<li>Log errors for debugging and monitoring</li>
</ul></li>
<li><strong>Write Tests for Critical Paths</strong>
<ul>
<li>Test user journeys end-to-end</li>
<li>Cover edge cases and error scenarios</li>
<li>Maintain test coverage above 80%</li>
</ul></li>
<li><strong>Optimize for Production</strong>
<ul>
<li>Minify and compress assets</li>
<li>Enable HTTP/2 and compression</li>
<li>Use CDN for static assets</li>
<li>Implement service worker caching</li>
</ul></li>
<li><strong>Monitor and Measure</strong>
<ul>
<li>Track Core Web Vitals</li>
<li>Set up error tracking (Sentry, etc.)</li>
<li>Monitor real user metrics</li>
<li>Set up alerts for performance regressions</li>
</ul></li>
<li><strong>Plan for Evolution</strong>
<ul>
<li>Version your components</li>
<li>Use feature flags for gradual rollouts</li>
<li>Keep dependencies up to date</li>
<li>Document breaking changes</li>
</ul></li>
<li><strong>Prioritize Developer Experience</strong>
<ul>
<li>Set up linting and formatting</li>
<li>Create component templates/generators</li>
<li>Document common patterns</li>
<li>Maintain example implementations</li>
</ul></li>
<li><strong>Focus on Accessibility</strong>
<ul>
<li>Test with screen readers</li>
<li>Support keyboard navigation</li>
<li>Follow ARIA best practices</li>
<li>Include accessibility in code review checklist</li>
</ul></li>
<li><strong>Build for the Long Term</strong>
<ul>
<li>Prefer web standards over frameworks</li>
<li>Keep dependencies minimal</li>
<li>Write clear, self-documenting code</li>
<li>Invest in comprehensive documentation</li>
</ul></li>
</ol>
<h2 data-number="19.11" id="hands-on-exercises-4"><span
class="header-section-number">19.11</span> Hands-On Exercises</h2>
<h3 data-number="19.11.1"
id="exercise-1-build-a-multi-page-e-commerce-app"><span
class="header-section-number">19.11.1</span> Exercise 1: Build a
Multi-Page E-Commerce App</h3>
<p>Build a complete e-commerce application with:</p>
<ul>
<li>Product listing with filters and sorting</li>
<li>Individual product pages</li>
<li>Shopping cart with persistence</li>
<li>Checkout flow with form validation</li>
<li>Admin panel for inventory management</li>
</ul>
<p><strong>Requirements:</strong> - Use PAN bus for state management -
Implement lazy loading for routes - Add comprehensive error handling -
Include unit and E2E tests - Deploy to production hosting</p>
<p><strong>Bonus Challenge:</strong> Add user authentication with JWT
tokens and implement role-based access control for admin features.</p>
<h3 data-number="19.11.2"
id="exercise-2-create-a-real-time-dashboard"><span
class="header-section-number">19.11.2</span> Exercise 2: Create a
Real-Time Dashboard</h3>
<p>Build a dashboard application that displays:</p>
<ul>
<li>Real-time metrics (using WebSocket)</li>
<li>Interactive charts and graphs</li>
<li>Data filtering and time range selection</li>
<li>Alert notifications</li>
<li>User preferences and saved views</li>
</ul>
<p><strong>Requirements:</strong> - Virtual scrolling for large datasets
- Optimistic UI updates - Service worker for offline functionality -
Performance profiled (60fps interactions) - Responsive design for
mobile/desktop</p>
<p><strong>Bonus Challenge:</strong> Implement data export (CSV, PDF),
scheduled reports, and email notifications for alerts.</p>
<h3 data-number="19.11.3" id="exercise-3-build-a-blog-cms"><span
class="header-section-number">19.11.3</span> Exercise 3: Build a Blog
CMS</h3>
<p>Create a complete content management system with:</p>
<ul>
<li>Rich text editor for articles</li>
<li>Draft/publish workflow</li>
<li>Tag and category management</li>
<li>SEO optimization (meta tags, sitemaps)</li>
<li>Media library for images</li>
<li>Comment moderation</li>
</ul>
<p><strong>Requirements:</strong> - Server integration (Node.js or your
choice) - Client-side routing with SSR for SEO - Form validation and
error handling - Auto-save functionality - Search functionality - User
roles (admin, editor, author)</p>
<p><strong>Bonus Challenge:</strong> Add markdown support with live
preview, scheduled publishing, and content analytics (views,
engagement).</p>
<h3 data-number="19.11.4"
id="exercise-4-migrate-an-existing-application"><span
class="header-section-number">19.11.4</span> Exercise 4: Migrate an
Existing Application</h3>
<p>Take an existing React or Vue application and migrate it to LARC:</p>
<ul>
<li>Audit current architecture and dependencies</li>
<li>Create migration plan with phases</li>
<li>Implement hybrid approach (gradual migration)</li>
<li>Maintain feature parity during migration</li>
<li>Compare bundle sizes and performance</li>
</ul>
<p><strong>Requirements:</strong> - Document migration process - Create
mapping guide (React/Vue → LARC) - Identify and solve migration
challenges - Set up automated tests to prevent regressions - Deploy both
versions and compare metrics</p>
<p><strong>Bonus Challenge:</strong> Create a migration tool/CLI that
automates conversion of common component patterns.</p>
<h2 data-number="19.12" id="summary-18"><span
class="header-section-number">19.12</span> Summary</h2>
<p>Building real applications with LARC teaches you to:</p>
<ul>
<li><strong>Think in components</strong>: Break UI into small, reusable
pieces</li>
<li><strong>Leverage web standards</strong>: Use what browsers
provide</li>
<li><strong>Embrace simplicity</strong>: No build step means faster
development</li>
<li><strong>Scale thoughtfully</strong>: Lazy load, virtualize, cache
strategically</li>
<li><strong>Test continuously</strong>: Catch bugs early with
comprehensive tests</li>
<li><strong>Profile performance</strong>: Measure before optimizing</li>
<li><strong>Plan for evolution</strong>: Version components, use feature
flags</li>
</ul>
<p>LARC’s no-build philosophy and standards-based approach make it ideal
for long-lived projects that need maintainability and performance at
scale.</p>
<h2 data-number="19.13" id="further-reading-18"><span
class="header-section-number">19.13</span> Further Reading</h2>
<ul>
<li><strong>Building with LARC - All Chapters</strong>: Complete API
reference and advanced patterns</li>
<li><strong>MDN Web Components</strong>: Deep dive into the
platform</li>
<li><strong>Open-wc</strong>: Testing and tooling best practices for web
components</li>
</ul>
<div class="pagebreak">

</div>
<h2 data-number="19.14" id="about-the-author-1"><span
class="header-section-number">19.14</span> About the Author</h2>
<p>Christopher Robison is a veteran software engineer and architect with
nearly three decades of experience building systems that range from
biotech and online trading platforms to complex web applications and
AI-driven tools. A lifelong maker with a deep appreciation for open
standards, he has spent his career exploring the boundaries of what the
web can do when you stop fighting the platform and start embracing
it.</p>
<p>He is the creator of LARC.js and the PAN message bus, a
browser-native architecture inspired by the elegant simplicity of the
automotive CAN bus. His work blends engineering pragmatism with a
playful curiosity that has led him to design everything from 3D printers
and robotics to interactive music systems and decentralized
applications.</p>
<p>Christopher currently lives in San Francisco, where he continues to
build things that bridge the digital and physical worlds — and
occasionally sneaks off to play punk rock shows with his band.</p>
<div class="pagebreak">

</div>
<h2 data-number="19.15"
id="the-web-has-grown-up.-its-time-our-apps-did-too."><span
class="header-section-number">19.15</span> The Web Has Grown Up. It’s
Time Our Apps Did Too.</h2>
<p>Modern browsers aren’t the brittle playgrounds they once were.
They’re fast, secure, richly capable application platforms — yet most of
today’s development stacks still treat them like dumb terminals that
need layers of tooling, bundling, and framework magic just to
function.</p>
<p><strong>Learning LARC</strong> shows another path.</p>
<p>LARC embraces the browser as a mature runtime, using nothing but open
standards — Web Components, modules, events, and message buses — to
build complex, deeply interactive applications without build systems,
without monoliths, and without ceremony. Through clear narrative
examples and real architectural stories, this book teaches you how to
design apps as ecosystems: small parts, clearly defined, communicating
through a shared bus.</p>
<p>You’ll learn how to structure large systems out of tiny cooperating
modules, expose capabilities through message patterns instead of global
state, keep your interfaces clean, and let the platform do the heavy
lifting it was built for.</p>
<p>No bundlers. No scaffolding. No twenty-layer dependency stacks. Just
the browser, finally treated like the grown-up it is.</p>
<p>Whether you’re maintaining a legacy system or starting fresh,
<strong>Learning LARC</strong> will help you rethink how modern web apps
can — and should — be built.</p>
</body>
</html>
