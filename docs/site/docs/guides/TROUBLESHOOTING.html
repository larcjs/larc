<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LARC Troubleshooting Guide · PAN Documentation</title>
  <meta name="description" content="PAN (Page Area Network) Documentation - LARC Troubleshooting Guide">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/theme.css">
  <link rel="stylesheet" href="../assets/docs.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha384-wH75j6z1lH97ZOpMOInqhgKzFkAInZPPSPlZpYKYTOqsaizPvhQZmAtLcPKXpLyH" crossorigin="anonymous">
</head>
<body>
  <header class="docs-header">
    <div class="docs-header-content">
      <a href="../index.html" class="logo">
        <span>PAN</span>
      </a>
      <nav class="docs-nav">
        <a href="../index.html">Home</a>
        <a href="index.html" class="active">Docs</a>
        <a href="../examples.html">Examples</a>
        <a href="../apps.html">Apps</a>
        <a href="https://github.com/chrisrobison/pan" target="_blank">GitHub</a>
      </nav>
    </div>
  </header>

  <div class="docs-layout">
    <aside class="docs-sidebar">
      <div class="docs-sidebar-content">
        <h3>Documentation</h3>
        <nav class="docs-menu" id="docs-menu">
          <!-- Will be populated by JavaScript -->
        </nav>
      </div>
    </aside>

    <main class="docs-main">
      <div class="docs-breadcrumb">
        <a href="../index.html">Home</a> / <a href="#">guides</a> / <span>TROUBLESHOOTING</span>
      </div>
      <article class="docs-content">
        <h1>LARC Troubleshooting Guide</h1>
<strong>Version:</strong> 1.0
<strong>Last Updated:</strong> November 2024
<strong>Status:</strong> Production Ready
<p>Comprehensive troubleshooting guide for LARC (Lightweight Asynchronous Relay Core). This guide provides practical solutions to common issues, debugging techniques, and step-by-step diagnostic workflows.</p>
<hr>
<h2>Table of Contents</h2>
<li><a href="#1-quick-reference-common-issues">Quick Reference: Common Issues</a></li>
<li><a href="#2-components-not-loading">Components Not Loading</a></li>
<li><a href="#3-messages-not-being-delivered">Messages Not Being Delivered</a></li>
<li><a href="#4-bus-not-ready-errors">Bus Not Ready Errors</a></li>
<li><a href="#5-module-resolution-failures">Module Resolution Failures</a></li>
<li><a href="#6-memory-leaks-and-performance">Memory Leaks and Performance</a></li>
<li><a href="#7-cors-and-cdn-issues">CORS and CDN Issues</a></li>
<li><a href="#8-csp-violations">CSP Violations</a></li>
<li><a href="#9-debugging-tools-and-techniques">Debugging Tools and Techniques</a></li>
<li><a href="#10-error-messages-reference">Error Messages Reference</a></li>
<li><a href="#11-browser-compatibility-issues">Browser Compatibility Issues</a></li>
<li><a href="#12-integration-issues">Integration Issues</a></li>
<li><a href="#13-development-vs-production-issues">Development vs Production Issues</a></li>
<li><a href="#14-diagnostic-workflows">Diagnostic Workflows</a></li>
<li><a href="#15-getting-help">Getting Help</a></li>
<hr>
<h2>1. Quick Reference: Common Issues</h2>
<h3>1.1 Most Common Problems</h3>
<p>| Problem | Quick Fix | Section |
|---------|-----------|---------|
| Component not loading | Check <code>data-module</code> attribute, verify path | <a href="#21-component-not-defined">2.1</a> |
| Messages not received | Wait for <code>bus.ready()</code>, check topic pattern | <a href="#31-subscriber-not-receiving-messages">3.1</a> |
| Bus not ready | Ensure <code><pan-bus></code> element exists in DOM | <a href="#41-pan-bus-element-missing">4.1</a> |
| CDN 404 error | Pin CDN version, check URL format | <a href="#71-cdn-resources-not-loading">7.1</a> |
| CSP blocking scripts | Add CDN to <code>script-src</code> directive | <a href="#81-scripts-blocked-by-csp">8.1</a> |
| Retained messages not working | Use <code>{ retained: true }</code> in subscribe options | <a href="#33-retained-messages-not-delivered">3.3</a> |
| Memory growing | Unsubscribe when done, avoid circular refs | <a href="#61-memory-leaks">6.1</a> |
| Request timeout | Verify responder is subscribed, increase timeout | <a href="#35-request-timeout">3.5</a> |</p>
<h3>1.2 Emergency Checklist</h3>
<p>If LARC isn't working at all, check these in order:</p>
<li>[ ] Is <code><pan-bus></code> in the DOM?</li>
<li>[ ] Are browser DevTools showing any console errors?</li>
<li>[ ] Is the browser modern enough? (Chrome 90+, Firefox 88+, Safari 14+)</li>
<li>[ ] Are module scripts loading? (Check Network tab)</li>
<li>[ ] Is CSP blocking resources?</li>
<li>[ ] Is CDN accessible? (Try loading URL directly)</li>
<hr>
<h2>2. Components Not Loading</h2>
<h3>2.1 Component Not Defined</h3>
<strong>Problem:</strong> Custom element appears but doesn't render. Console shows: <code>Uncaught DOMException: Failed to execute 'define' on 'CustomElementRegistry'</code>
<strong>Symptoms:</strong>
<ul><li>Element shows as <code>:not(:defined)</code> in DevTools</li>
<li>Component appears as plain text in DOM</li>
<li>No functionality</li>
</ul>
<strong>Common Causes:</strong>
<p>#### 2.1.1 Component File Not Found</p>
<pre><code class="language-html">&lt;!-- Wrong: File doesn&#039;t exist --&gt;
&lt;my-component&gt;&lt;/my-component&gt;
&lt;!-- Autoloader looks for: ./components/my-component.mjs --&gt;</code></pre>
<strong>Solution:</strong>
<pre><code class="language-bash"># Verify file exists
ls ./components/my-component.mjs

# Or specify explicit path
&lt;my-component data-module=&quot;/path/to/component.mjs&quot;&gt;&lt;/my-component&gt;</code></pre>
<p>#### 2.1.2 Component Path Configuration</p>
<pre><code class="language-javascript">// Check autoloader configuration
console.log(window.panAutoload.config);
// Should show:
// {
//   baseUrl: &quot;...&quot;,
//   componentsPath: &quot;./components/&quot;,
//   extension: &quot;.mjs&quot;
// }

// Fix configuration before loading pan.mjs
window.panAutoload = {
  baseUrl: &#039;/static/&#039;,
  componentsPath: &#039;./components/&#039;,
  extension: &#039;.mjs&#039;
};</code></pre>
<p>#### 2.1.3 Component Not Exported Properly</p>
<pre><code class="language-javascript">// ❌ WRONG: No export
class MyComponent extends HTMLElement {
  // ...
}
customElements.define(&#039;my-component&#039;, MyComponent);

// ✅ CORRECT: Export as default
class MyComponent extends HTMLElement {
  // ...
}
export default MyComponent;</code></pre>
<p>#### 2.1.4 Naming Mismatch</p>
<pre><code class="language-javascript">// ❌ WRONG: Tag name doesn&#039;t match class
&lt;my-widget&gt;&lt;/my-widget&gt;
// File: my-component.mjs (name doesn&#039;t match tag)

// ✅ CORRECT: Match tag name to filename
&lt;my-widget&gt;&lt;/my-widget&gt;
// File: my-widget.mjs</code></pre>
<strong>Debugging Steps:</strong>
<li><strong>Check console for errors</strong></li>
   <pre><code class="language-javascript">// Look for module loading errors
   // Open DevTools Console and check for 404s or import errors</code></pre>
<li><strong>Verify autoloader saw the element</strong></li>
   <pre><code class="language-javascript">// Check if element was observed
   const el = document.querySelector(&#039;my-component&#039;);
   console.log(&#039;Is custom tag:&#039;, el.tagName.includes(&#039;-&#039;));
   console.log(&#039;Is defined:&#039;, customElements.get(el.localName));</code></pre>
<li><strong>Manually load component</strong></li>
   <pre><code class="language-javascript">// Force load to see error
   await window.panAutoload.maybeLoadFor(
     document.querySelector(&#039;my-component&#039;)
   );</code></pre>
<li><strong>Check Network tab</strong></li>
   - Look for 404 errors on <code>.mjs</code> files
   - Verify correct URL is being requested
   - Check CORS headers if loading from CDN
<h3>2.2 Module Import Errors</h3>
<strong>Problem:</strong> Component file loads but import fails
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">Uncaught SyntaxError: Cannot use import statement outside a module</code></pre>
<strong>Solutions:</strong>
<p>#### 2.2.1 Missing <code>type="module"</code></p>
<pre><code class="language-html">&lt;!-- ❌ WRONG --&gt;
&lt;script src=&quot;./pan.mjs&quot;&gt;&lt;/script&gt;

&lt;!-- ✅ CORRECT --&gt;
&lt;script type=&quot;module&quot; src=&quot;./pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<p>#### 2.2.2 Relative Import Path Issues</p>
<pre><code class="language-javascript">// ❌ WRONG: Relative import without extension
import { PanClient } from &#039;./pan-client&#039;;

// ✅ CORRECT: Include extension
import { PanClient } from &#039;./pan-client.mjs&#039;;

// ✅ ALSO CORRECT: Absolute or CDN URL
import { PanClient } from &#039;https://unpkg.com/@larcjs/core@2.0.0/pan-client.mjs&#039;;</code></pre>
<h3>2.3 Autoloader Not Running</h3>
<strong>Problem:</strong> Components never load, no errors in console
<strong>Symptoms:</strong>
<ul><li>Elements remain <code>:not(:defined)</code></li>
<li>Network tab shows no component requests</li>
<li><code>window.panAutoload</code> is undefined</li>
</ul>
<strong>Solutions:</strong>
<p>#### 2.3.1 Check Autoloader Loaded</p>
<pre><code class="language-javascript">// Verify autoloader is present
if (!window.panAutoload) {
  console.error(&#039;Autoloader not loaded!&#039;);
  // Check if pan.mjs was loaded correctly
}</code></pre>
<p>#### 2.3.2 Check IntersectionObserver Support</p>
<pre><code class="language-javascript">// Verify browser support
if (!(&#039;IntersectionObserver&#039; in window)) {
  console.error(&#039;IntersectionObserver not supported&#039;);
  // Load polyfill or manually load components
}</code></pre>
<p>#### 2.3.3 Manually Trigger Observation</p>
<pre><code class="language-javascript">// Force observation of element
const container = document.querySelector(&#039;#dynamic-content&#039;);
window.panAutoload.observeTree(container);</code></pre>
<h3>2.4 Dynamic Components Not Loading</h3>
<strong>Problem:</strong> Components added via JavaScript don't auto-load
<strong>Solution:</strong>
<pre><code class="language-javascript">// After adding elements dynamically, trigger observation
const container = document.querySelector(&#039;#app&#039;);
container.innerHTML = &#039;&lt;my-component&gt;&lt;/my-component&gt;&#039;;

// Trigger autoloader
window.panAutoload.observeTree(container);

// OR manually load
const el = container.querySelector(&#039;my-component&#039;);
await window.panAutoload.maybeLoadFor(el);</code></pre>
<hr>
<h2>3. Messages Not Being Delivered</h2>
<h3>3.1 Subscriber Not Receiving Messages</h3>
<strong>Problem:</strong> Published messages don't reach subscriber
<strong>Debugging Steps:</strong>
<p>#### 3.1.1 Verify Bus is Ready</p>
<pre><code class="language-javascript">// ❌ WRONG: Publish before bus ready
const client = new PanClient();
client.publish({ topic: &#039;test&#039;, data: {} }); // May be lost

// ✅ CORRECT: Wait for ready
const client = new PanClient();
await client.ready();
client.publish({ topic: &#039;test&#039;, data: {} });</code></pre>
<p>#### 3.1.2 Check Topic Matching</p>
<pre><code class="language-javascript">// Debug topic matching
const topic = &#039;users.item.updated&#039;;
const pattern = &#039;users.*&#039;;

// Check if pattern matches
console.log(&#039;Matches:&#039;, PanClient.matches(topic, pattern));
// false - pattern only matches one segment

// Fix: Use correct pattern
const correctPattern = &#039;users.item.*&#039;; // or &#039;users.*.updated&#039;
console.log(&#039;Matches:&#039;, PanClient.matches(topic, correctPattern)); // true</code></pre>
<p>#### 3.1.3 Verify Subscription</p>
<pre><code class="language-javascript">// Add debug logging to subscription
client.subscribe(&#039;users.*&#039;, (msg) =&gt; {
  console.log(&#039;Received message:&#039;, msg);
  // If you see this, subscription works
});

// Test with a publish
client.publish({
  topic: &#039;users.test&#039;,
  data: { test: true }
});</code></pre>
<p>#### 3.1.4 Check Element Still in DOM</p>
<pre><code class="language-javascript">// If subscribing from a component, ensure it&#039;s still connected
class MyComponent extends HTMLElement {
  connectedCallback() {
    this.client = new PanClient(this);

    this.unsub = this.client.subscribe(&#039;data.*&#039;, (msg) =&gt; {
      if (!this.isConnected) {
        console.warn(&#039;Component disconnected but still receiving messages!&#039;);
        this.unsub(); // Clean up
      }
    });
  }

  disconnectedCallback() {
    // IMPORTANT: Unsubscribe when component removed
    if (this.unsub) this.unsub();
  }
}</code></pre>
<h3>3.2 Wildcard Subscriptions Not Working</h3>
<strong>Problem:</strong> Wildcard patterns don't match expected topics
<strong>Pattern Rules:</strong>
<pre><code class="language-javascript">// Single segment wildcard
&#039;users.*&#039;         // Matches: users.list, users.item
                  // NOT: users.item.updated (2 segments after users)

// Multiple wildcards
&#039;*.updated&#039;       // Matches: users.updated, posts.updated
&#039;users.*.state&#039;   // Matches: users.list.state, users.item.state

// Global wildcard
&#039;*&#039;               // Matches: ALL topics (use carefully!)</code></pre>
<strong>Testing Patterns:</strong>
<pre><code class="language-javascript">// Test your patterns
const testPatterns = [
  [&#039;users.item.updated&#039;, &#039;users.*&#039;],           // false
  [&#039;users.item.updated&#039;, &#039;users.item.*&#039;],      // true
  [&#039;users.item.updated&#039;, &#039;*.updated&#039;],         // false
  [&#039;users.item.updated&#039;, &#039;*.*.updated&#039;],       // true
  [&#039;users.item.updated&#039;, &#039;users.*.updated&#039;],   // true
  [&#039;users.item.updated&#039;, &#039;*&#039;],                 // true
];

testPatterns.forEach(([topic, pattern]) =&gt; {
  console.log(`${topic} ~ ${pattern} = ${PanClient.matches(topic, pattern)}`);
});</code></pre>
<h3>3.3 Retained Messages Not Delivered</h3>
<strong>Problem:</strong> New subscriber doesn't receive retained message
<strong>Solutions:</strong>
<p>#### 3.3.1 Enable Retained Option</p>
<pre><code class="language-javascript">// ❌ WRONG: No retained option
client.subscribe(&#039;app.state&#039;, (msg) =&gt; {
  // Won&#039;t receive retained message
});

// ✅ CORRECT: Request retained messages
client.subscribe(&#039;app.state&#039;, (msg) =&gt; {
  // Will receive current state immediately
}, { retained: true });</code></pre>
<p>#### 3.3.2 Verify Message Was Published with Retain</p>
<pre><code class="language-javascript">// ❌ WRONG: No retain flag
client.publish({
  topic: &#039;app.state&#039;,
  data: { theme: &#039;dark&#039; }
  // Missing: retain: true
});

// ✅ CORRECT: Set retain flag
client.publish({
  topic: &#039;app.state&#039;,
  data: { theme: &#039;dark&#039; },
  retain: true  // Store for late subscribers
});</code></pre>
<p>#### 3.3.3 Check Retention Limits</p>
<pre><code class="language-javascript">// If using pan-bus with memory limits
// Check if retained message was evicted
document.querySelector(&#039;pan-bus&#039;).dispatchEvent(
  new CustomEvent(&#039;pan:sys.stats&#039;, { bubbles: true })
);

// Listen for stats
document.addEventListener(&#039;pan:deliver&#039;, (e) =&gt; {
  if (e.detail.topic === &#039;pan:sys.stats&#039;) {
    console.log(&#039;Retained messages:&#039;, e.detail.data.retained);
    console.log(&#039;Evicted count:&#039;, e.detail.data.retainedEvicted);
  }
}, { once: true });</code></pre>
<h3>3.4 Messages Delayed or Out of Order</h3>
<strong>Problem:</strong> Messages arrive late or in wrong order
<strong>Causes & Solutions:</strong>
<p>#### 3.4.1 Heavy Processing in Handler</p>
<pre><code class="language-javascript">// ❌ PROBLEM: Blocking handler
client.subscribe(&#039;data.*&#039;, (msg) =&gt; {
  // Expensive synchronous operation blocks other messages
  const result = processHeavyData(msg.data); // Takes 100ms
  updateUI(result);
});

// ✅ SOLUTION: Use async processing
client.subscribe(&#039;data.*&#039;, async (msg) =&gt; {
  // Process asynchronously
  const result = await processHeavyDataAsync(msg.data);
  updateUI(result);
});

// OR: Defer processing
client.subscribe(&#039;data.*&#039;, (msg) =&gt; {
  setTimeout(() =&gt; {
    const result = processHeavyData(msg.data);
    updateUI(result);
  }, 0);
});</code></pre>
<p>#### 3.4.2 Race Conditions</p>
<pre><code class="language-javascript">// ❌ PROBLEM: Race condition
let userData = null;
client.subscribe(&#039;user.loaded&#039;, (msg) =&gt; {
  userData = msg.data; // May arrive after other messages
});

client.subscribe(&#039;user.action&#039;, (msg) =&gt; {
  // userData might still be null!
  processAction(userData, msg.data);
});

// ✅ SOLUTION: Use retained messages
client.publish({
  topic: &#039;user.loaded&#039;,
  data: currentUser,
  retain: true  // Late subscribers get it immediately
});

client.subscribe(&#039;user.loaded&#039;, (msg) =&gt; {
  userData = msg.data;
}, { retained: true }); // Get current user immediately</code></pre>
<h3>3.5 Request Timeout</h3>
<strong>Problem:</strong> <code>client.request()</code> times out
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">Error: PAN request timeout</code></pre>
<strong>Solutions:</strong>
<p>#### 3.5.1 Verify Responder is Subscribed</p>
<pre><code class="language-javascript">// Make sure someone is listening!
// Responder side:
client.subscribe(&#039;api.user.get&#039;, (msg) =&gt; {
  if (!msg.replyTo) return; // Not a request

  // Process and reply
  const user = getUser(msg.data.id);
  client.publish({
    topic: msg.replyTo,
    data: { ok: true, item: user },
    correlationId: msg.correlationId
  });
});

// Requester side:
try {
  const response = await client.request(&#039;api.user.get&#039;, { id: 123 });
  console.log(&#039;User:&#039;, response.data.item);
} catch (err) {
  console.error(&#039;No responder available&#039;);
}</code></pre>
<p>#### 3.5.2 Increase Timeout</p>
<pre><code class="language-javascript">// Default timeout is 5000ms
const response = await client.request(&#039;api.slow.operation&#039;, data, {
  timeoutMs: 10000  // Increase to 10 seconds
});</code></pre>
<p>#### 3.5.3 Check for Reply Errors</p>
<pre><code class="language-javascript">// Responder: Always send a reply, even on error
client.subscribe(&#039;api.user.get&#039;, async (msg) =&gt; {
  if (!msg.replyTo) return;

  try {
    const user = await getUser(msg.data.id);
    client.publish({
      topic: msg.replyTo,
      data: { ok: true, item: user },
      correlationId: msg.correlationId
    });
  } catch (err) {
    // Send error reply instead of silence
    client.publish({
      topic: msg.replyTo,
      data: { ok: false, error: err.message },
      correlationId: msg.correlationId
    });
  }
});</code></pre>
<hr>
<h2>4. Bus Not Ready Errors</h2>
<h3>4.1 PAN Bus Element Missing</h3>
<strong>Problem:</strong> <code>window.__panReady</code> is undefined, <code>pan:sys.ready</code> event never fires
<strong>Symptoms:</strong>
<pre><code class="language-javascript">await client.ready(); // Never resolves</code></pre>
<strong>Solutions:</strong>
<p>#### 4.1.1 Add Bus Element</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;script type=&quot;module&quot; src=&quot;./src/pan.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;!-- ✅ Add this --&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;my-app&gt;&lt;/my-app&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>#### 4.1.2 Ensure Bus Loads First</p>
<pre><code class="language-javascript">// If creating bus programmatically
import { ensureBus } from &#039;./src/pan.mjs&#039;;

// Create bus before using client
ensureBus();

const client = new PanClient();
await client.ready();</code></pre>
<p>#### 4.1.3 Check Bus is Defined</p>
<pre><code class="language-javascript">// Verify bus custom element is defined
if (!customElements.get(&#039;pan-bus&#039;)) {
  console.error(&#039;pan-bus not defined!&#039;);
  // Check if pan.mjs loaded correctly
}

// Check if bus exists in DOM
const bus = document.querySelector(&#039;pan-bus&#039;);
if (!bus) {
  console.error(&#039;pan-bus element not in DOM!&#039;);
}</code></pre>
<h3>4.2 Bus Ready Race Condition</h3>
<strong>Problem:</strong> Client created before bus is ready
<strong>Solution:</strong>
<pre><code class="language-javascript">// ❌ PROBLEM: Create client too early
const client = new PanClient(); // Bus might not exist yet

// ✅ SOLUTION 1: Wait for DOM ready
document.addEventListener(&#039;DOMContentLoaded&#039;, async () =&gt; {
  const client = new PanClient();
  await client.ready();
  // Now safe to use
});

// ✅ SOLUTION 2: Wait for bus ready event
document.addEventListener(&#039;pan:sys.ready&#039;, () =&gt; {
  const client = new PanClient();
  // Bus is guaranteed ready
}, { once: true });

// ✅ SOLUTION 3: Always await ready()
const client = new PanClient();
await client.ready(); // Waits for bus if needed
client.publish({ topic: &#039;app.started&#039;, data: {} });</code></pre>
<h3>4.3 Multiple Bus Elements</h3>
<strong>Problem:</strong> Multiple <code><pan-bus></code> elements in DOM
<strong>Symptoms:</strong>
<ul><li>Duplicate message delivery</li>
<li>Unexpected behavior</li>
<li>Messages delivered multiple times</li>
</ul>
<strong>Solution:</strong>
<pre><code class="language-javascript">// Check for multiple buses
const buses = document.querySelectorAll(&#039;pan-bus&#039;);
if (buses.length &gt; 1) {
  console.error(`Found ${buses.length} bus elements! Should be 1.`);
  // Remove extras
  buses.forEach((bus, i) =&gt; {
    if (i &gt; 0) bus.remove();
  });
}</code></pre>
<hr>
<h2>5. Module Resolution Failures</h2>
<h3>5.1 Relative Path Issues</h3>
<strong>Problem:</strong> Module imports fail with 404
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">GET http://localhost/pan-client.mjs 404 (Not Found)</code></pre>
<strong>Solutions:</strong>
<p>#### 5.1.1 Always Include Extension</p>
<pre><code class="language-javascript">// ❌ WRONG: Missing .mjs extension
import { PanClient } from &#039;./components/pan-client&#039;;

// ✅ CORRECT: Include extension
import { PanClient } from &#039;./components/pan-client.mjs&#039;;</code></pre>
<p>#### 5.1.2 Use Absolute Paths or Import Maps</p>
<pre><code class="language-html">&lt;!-- Import map for cleaner imports --&gt;
&lt;script type=&quot;importmap&quot;&gt;
{
  &quot;imports&quot;: {
    &quot;larc&quot;: &quot;/static/larc/pan.mjs&quot;,
    &quot;larc/&quot;: &quot;/static/larc/&quot;
  }
}
&lt;/script&gt;

&lt;script type=&quot;module&quot;&gt;
import { PanClient } from &#039;larc&#039;;
import { PanBus } from &#039;larc/components/pan-bus.mjs&#039;;
&lt;/script&gt;</code></pre>
<h3>5.2 CDN Module Resolution</h3>
<strong>Problem:</strong> Components can't load when using CDN for core
<strong>Solution:</strong>
<pre><code class="language-html">&lt;script type=&quot;module&quot;&gt;
  // Configure autoloader for CDN
  window.panAutoload = {
    baseUrl: &#039;https://unpkg.com/@larcjs/core@2.0.0/&#039;,
    componentsPath: &#039;./&#039;,
    extension: &#039;.mjs&#039;
  };
&lt;/script&gt;
&lt;script type=&quot;module&quot; src=&quot;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<h3>5.3 Path Resolution with data-module</h3>
<strong>Problem:</strong> Custom component paths not resolving
<strong>Solutions:</strong>
<pre><code class="language-html">&lt;!-- Relative to current page --&gt;
&lt;my-component data-module=&quot;./widgets/my-component.mjs&quot;&gt;&lt;/my-component&gt;

&lt;!-- Absolute path --&gt;
&lt;my-component data-module=&quot;/static/components/my-component.mjs&quot;&gt;&lt;/my-component&gt;

&lt;!-- CDN URL --&gt;
&lt;my-component data-module=&quot;https://unpkg.com/my-package/component.mjs&quot;&gt;&lt;/my-component&gt;</code></pre>
<hr>
<h2>6. Memory Leaks and Performance</h2>
<h3>6.1 Memory Leaks</h3>
<strong>Problem:</strong> Memory usage grows over time
<strong>Common Causes:</strong>
<p>#### 6.1.1 Subscriptions Not Cleaned Up</p>
<pre><code class="language-javascript">// ❌ PROBLEM: Subscriptions leak
class MyComponent extends HTMLElement {
  connectedCallback() {
    this.client = new PanClient(this);
    this.client.subscribe(&#039;data.*&#039;, this.handleData);
    // No cleanup when component removed!
  }

  handleData = (msg) =&gt; {
    this.render(msg.data);
  }
}

// ✅ SOLUTION: Always unsubscribe
class MyComponent extends HTMLElement {
  connectedCallback() {
    this.client = new PanClient(this);
    // Store unsubscribe function
    this.unsub = this.client.subscribe(&#039;data.*&#039;, this.handleData);
  }

  disconnectedCallback() {
    // Clean up subscription
    if (this.unsub) this.unsub();
  }

  handleData = (msg) =&gt; {
    this.render(msg.data);
  }
}

// ✅ BETTER: Use AbortSignal
class MyComponent extends HTMLElement {
  connectedCallback() {
    this.client = new PanClient(this);
    this.abortController = new AbortController();

    // Auto-cleanup with signal
    this.client.subscribe(&#039;data.*&#039;, this.handleData, {
      signal: this.abortController.signal
    });
  }

  disconnectedCallback() {
    // Unsubscribe all at once
    this.abortController.abort();
  }

  handleData = (msg) =&gt; {
    this.render(msg.data);
  }
}</code></pre>
<p>#### 6.1.2 Circular References in Messages</p>
<pre><code class="language-javascript">// ❌ PROBLEM: Circular reference
const obj = { name: &#039;test&#039; };
obj.self = obj; // Circular!

client.publish({
  topic: &#039;data.update&#039;,
  data: obj // Will fail validation
});

// ✅ SOLUTION: Only send serializable data
client.publish({
  topic: &#039;data.update&#039;,
  data: { name: &#039;test&#039; } // Plain object
});</code></pre>
<p>#### 6.1.3 Large Retained Messages</p>
<pre><code class="language-javascript">// ❌ PROBLEM: Retaining huge datasets
client.publish({
  topic: &#039;users.list&#039;,
  data: { users: largeArrayOf10000Users },
  retain: true // Stored in memory!
});

// ✅ SOLUTION: Paginate or use pagination topic
client.publish({
  topic: &#039;users.list.page.1&#039;,
  data: { users: first100Users, total: 10000 },
  retain: true
});</code></pre>
<h3>6.2 Performance Issues</h3>
<p>#### 6.2.1 Too Many Subscribers</p>
<strong>Problem:</strong> Performance degrades with many subscribers
<strong>Solution:</strong>
<pre><code class="language-javascript">// ❌ PROBLEM: Each element subscribes individually
class ListItem extends HTMLElement {
  connectedCallback() {
    // 1000 items = 1000 subscriptions!
    this.unsub = client.subscribe(&#039;item.update&#039;, this.handleUpdate);
  }
}

// ✅ SOLUTION: Subscribe once at parent level
class ItemList extends HTMLElement {
  connectedCallback() {
    // One subscription for all items
    this.unsub = client.subscribe(&#039;item.update&#039;, (msg) =&gt; {
      const item = this.querySelector(`[data-id=&quot;${msg.data.id}&quot;]`);
      if (item) item.update(msg.data);
    });
  }
}</code></pre>
<p>#### 6.2.2 Message Rate Limiting</p>
<strong>Problem:</strong> Publishing too many messages causes performance issues
<strong>Solution:</strong>
<pre><code class="language-javascript">// ❌ PROBLEM: Publish on every input event
input.addEventListener(&#039;input&#039;, (e) =&gt; {
  client.publish({
    topic: &#039;search.query&#039;,
    data: { query: e.target.value }
  }); // Publishes hundreds of times per second!
});

// ✅ SOLUTION: Debounce
let debounceTimer;
input.addEventListener(&#039;input&#039;, (e) =&gt; {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() =&gt; {
    client.publish({
      topic: &#039;search.query&#039;,
      data: { query: e.target.value }
    });
  }, 300); // Only publish after 300ms of no input
});</code></pre>
<p>#### 6.2.3 Heavy Message Processing</p>
<strong>Problem:</strong> Message handlers block UI
<strong>Solution:</strong>
<pre><code class="language-javascript">// ❌ PROBLEM: Synchronous heavy processing
client.subscribe(&#039;data.process&#039;, (msg) =&gt; {
  const result = heavyComputation(msg.data); // Blocks UI!
  updateUI(result);
});

// ✅ SOLUTION: Use Web Workers
const worker = new Worker(&#039;/workers/process.js&#039;);

client.subscribe(&#039;data.process&#039;, (msg) =&gt; {
  worker.postMessage(msg.data);
});

worker.onmessage = (e) =&gt; {
  updateUI(e.data);
};</code></pre>
<h3>6.3 Monitoring Memory Usage</h3>
<pre><code class="language-javascript">// Monitor memory usage
function logMemoryUsage() {
  if (performance.memory) {
    const { usedJSHeapSize, totalJSHeapSize } = performance.memory;
    console.log(&#039;Memory:&#039;, {
      used: `${(usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
      total: `${(totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
      percentage: `${((usedJSHeapSize / totalJSHeapSize) * 100).toFixed(1)}%`
    });
  }
}

// Check periodically
setInterval(logMemoryUsage, 10000);

// Check PAN bus stats
function checkBusStats() {
  const bus = document.querySelector(&#039;pan-bus&#039;);
  if (bus &amp;&amp; bus.stats) {
    console.log(&#039;Bus stats:&#039;, bus.stats);
  }
}</code></pre>
<hr>
<h2>7. CORS and CDN Issues</h2>
<h3>7.1 CDN Resources Not Loading</h3>
<strong>Problem:</strong> CDN modules fail to load with CORS or 404 errors
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">Access to script at &#039;https://unpkg.com/...&#039; from origin &#039;http://localhost&#039; has been blocked by CORS policy</code></pre>
<strong>Solutions:</strong>
<p>#### 7.1.1 Pin CDN Versions</p>
<pre><code class="language-html">&lt;!-- ❌ WRONG: Unpinned version can break --&gt;
&lt;script type=&quot;module&quot; src=&quot;https://unpkg.com/@larcjs/core/pan.mjs&quot;&gt;&lt;/script&gt;

&lt;!-- ✅ CORRECT: Pinned version --&gt;
&lt;script type=&quot;module&quot; src=&quot;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<p>#### 7.1.2 CDN Failover</p>
<pre><code class="language-javascript">// Implement automatic failover
const CDN_SOURCES = [
  &#039;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&#039;,
  &#039;https://cdn.jsdelivr.net/npm/@larcjs/core@2.0.0/src/pan.mjs&#039;,
  &#039;/static/larc/pan.mjs&#039; // Local fallback
];

async function loadWithFailover(sources) {
  for (const src of sources) {
    try {
      await import(src);
      console.log(`Loaded from: ${src}`);
      return;
    } catch (err) {
      console.warn(`Failed to load from ${src}:`, err);
    }
  }
  throw new Error(&#039;Failed to load from all sources&#039;);
}

await loadWithFailover(CDN_SOURCES);</code></pre>
<p>#### 7.1.3 Check CDN Status</p>
<pre><code class="language-javascript">// Test CDN availability
async function testCDN(url) {
  try {
    const response = await fetch(url, { method: &#039;HEAD&#039; });
    return response.ok;
  } catch (err) {
    return false;
  }
}

const cdnAvailable = await testCDN(&#039;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&#039;);
console.log(&#039;CDN available:&#039;, cdnAvailable);</code></pre>
<h3>7.2 Mixed Content Errors</h3>
<strong>Problem:</strong> HTTPS page loading HTTP resources
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">Mixed Content: The page at &#039;https://example.com&#039; was loaded over HTTPS, but requested an insecure script &#039;http://unpkg.com/...&#039;</code></pre>
<strong>Solution:</strong>
<pre><code class="language-html">&lt;!-- ❌ WRONG: HTTP URL --&gt;
&lt;script type=&quot;module&quot; src=&quot;http://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;

&lt;!-- ✅ CORRECT: HTTPS URL --&gt;
&lt;script type=&quot;module&quot; src=&quot;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;

&lt;!-- ✅ BETTER: Protocol-relative (not recommended for modules) --&gt;
&lt;script type=&quot;module&quot; src=&quot;//unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<h3>7.3 CDN Cache Issues</h3>
<strong>Problem:</strong> Old version cached, new version not loading
<strong>Solutions:</strong>
<pre><code class="language-javascript">// Clear service worker cache
if (&#039;serviceWorker&#039; in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations =&gt; {
    registrations.forEach(reg =&gt; reg.unregister());
  });

  caches.keys().then(names =&gt; {
    names.forEach(name =&gt; caches.delete(name));
  });
}

// Force reload bypassing cache
location.reload(true);

// Or use cache-busting query param
const timestamp = Date.now();
const script = document.createElement(&#039;script&#039;);
script.type = &#039;module&#039;;
script.src = `./pan.mjs?v=${timestamp}`;
document.head.appendChild(script);</code></pre>
<hr>
<h2>8. CSP Violations</h2>
<h3>8.1 Scripts Blocked by CSP</h3>
<strong>Problem:</strong> Console shows CSP violation errors
<strong>Symptoms:</strong>
<pre><code class="language-plaintext">Refused to load the script &#039;https://unpkg.com/...&#039; because it violates the following Content Security Policy directive: &quot;script-src &#039;self&#039;&quot;</code></pre>
<strong>Solutions:</strong>
<p>#### 8.1.1 Update CSP Header</p>
<pre><code class="language-html">&lt;!-- Add CDN to allowed sources --&gt;
&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;
  default-src &#039;self&#039;;
  script-src &#039;self&#039; https://unpkg.com https://cdn.jsdelivr.net;
  script-src-elem &#039;self&#039; https://unpkg.com;
  connect-src &#039;self&#039;;
  style-src &#039;self&#039; &#039;unsafe-inline&#039;;
&quot;&gt;</code></pre>
<p>#### 8.1.2 Nginx CSP Configuration</p>
<pre><code class="language-nginx">add_header Content-Security-Policy &quot;
  default-src &#039;self&#039;;
  script-src &#039;self&#039; https://unpkg.com https://cdn.jsdelivr.net;
  script-src-elem &#039;self&#039; https://unpkg.com;
  connect-src &#039;self&#039;;
  style-src &#039;self&#039; &#039;unsafe-inline&#039;;
  img-src &#039;self&#039; data: https:;
  font-src &#039;self&#039; data:;
  worker-src &#039;self&#039; blob:;
&quot; always;</code></pre>
<p>#### 8.1.3 Test CSP Locally</p>
<pre><code class="language-javascript">// Check what&#039;s being blocked
window.addEventListener(&#039;securitypolicyviolation&#039;, (e) =&gt; {
  console.error(&#039;CSP Violation:&#039;, {
    directive: e.violatedDirective,
    blocked: e.blockedURI,
    document: e.documentURI
  });
});</code></pre>
<h3>8.2 Unsafe-inline Required</h3>
<strong>Problem:</strong> Inline event handlers or styles blocked
<strong>Solution:</strong>
<pre><code class="language-javascript">// ❌ AVOID: Inline event handlers
&lt;button onclick=&quot;handleClick()&quot;&gt;Click&lt;/button&gt;

// ✅ USE: Proper event listeners
&lt;button id=&quot;myBtn&quot;&gt;Click&lt;/button&gt;
&lt;script type=&quot;module&quot;&gt;
  document.getElementById(&#039;myBtn&#039;).addEventListener(&#039;click&#039;, handleClick);
&lt;/script&gt;</code></pre>
<h3>8.3 Worker CSP Issues</h3>
<strong>Problem:</strong> Web Workers blocked by CSP
<strong>Solution:</strong>
<pre><code class="language-html">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;
  worker-src &#039;self&#039; blob:;
&quot;&gt;</code></pre>
<hr>
<h2>9. Debugging Tools and Techniques</h2>
<h3>9.1 Enable Debug Mode</h3>
<pre><code class="language-html">&lt;!-- Enable debug logging --&gt;
&lt;pan-bus debug=&quot;true&quot;&gt;&lt;/pan-bus&gt;</code></pre>
<pre><code class="language-javascript">// Or enable programmatically
const bus = document.querySelector(&#039;pan-bus&#039;);
if (bus) {
  bus.setAttribute(&#039;debug&#039;, &#039;true&#039;);
}

// Check debug output in console
// [PAN Bus] Published {topic: &quot;test&quot;, retain: false, delivered: 2}</code></pre>
<h3>9.2 Browser DevTools</h3>
<p>#### 9.2.1 Check Component Registration</p>
<pre><code class="language-javascript">// In DevTools Console:

// List all defined custom elements
customElements.getName(MyComponent); // Returns tag name

// Check if element is defined
customElements.get(&#039;my-component&#039;); // Returns constructor or undefined

// Get all custom elements in page
document.querySelectorAll(&#039;*&#039;).forEach(el =&gt; {
  if (el.tagName.includes(&#039;-&#039;)) {
    console.log(el.tagName, customElements.get(el.localName) ? &#039;✅&#039; : &#039;❌&#039;);
  }
});</code></pre>
<p>#### 9.2.2 Monitor Network Requests</p>
<pre><code class="language-javascript">// Enable verbose logging for module loads
// Chrome DevTools: Network tab
// Filter: .mjs
// Look for:
// - Status codes (404 = not found, 200 = OK)
// - Timing (slow loading?)
// - Size (large modules?)
// - CORS headers</code></pre>
<p>#### 9.2.3 Inspect Event Listeners</p>
<pre><code class="language-javascript">// Get event listeners on bus
getEventListeners(document.querySelector(&#039;pan-bus&#039;));

// Check message deliveries
monitorEvents(document, &#039;pan:deliver&#039;);
// Now see all pan:deliver events in console</code></pre>
<h3>9.3 Message Logging</h3>
<pre><code class="language-javascript">// Log all messages
const client = new PanClient();

client.subscribe(&#039;*&#039;, (msg) =&gt; {
  console.log(`[${msg.topic}]`, msg.data, {
    id: msg.id,
    ts: new Date(msg.ts).toISOString(),
    retain: msg.retain,
    correlationId: msg.correlationId
  });
});</code></pre>
<h3>9.4 Performance Profiling</h3>
<pre><code class="language-javascript">// Profile message throughput
let messageCount = 0;
let startTime = Date.now();

client.subscribe(&#039;*&#039;, () =&gt; {
  messageCount++;
});

setInterval(() =&gt; {
  const elapsed = (Date.now() - startTime) / 1000;
  const rate = (messageCount / elapsed).toFixed(2);
  console.log(`Message rate: ${rate} msg/sec (${messageCount} total)`);
}, 5000);</code></pre>
<h3>9.5 Check Bus Statistics</h3>
<pre><code class="language-javascript">// Request bus stats
function getBusStats() {
  return new Promise((resolve) =&gt; {
    const listener = (e) =&gt; {
      if (e.detail.topic === &#039;pan:sys.stats&#039;) {
        document.removeEventListener(&#039;pan:deliver&#039;, listener);
        resolve(e.detail.data);
      }
    };

    document.addEventListener(&#039;pan:deliver&#039;, listener);
    document.dispatchEvent(
      new CustomEvent(&#039;pan:sys.stats&#039;, { bubbles: true })
    );
  });
}

// Use it
const stats = await getBusStats();
console.log(&#039;Bus Stats:&#039;, stats);
// {
//   published: 1234,
//   delivered: 5678,
//   dropped: 0,
//   subscriptions: 12,
//   clients: 3,
//   retained: 5
// }</code></pre>
<h3>9.6 Test Component Loading</h3>
<pre><code class="language-javascript">// Test component load
async function testComponentLoad(tagName) {
  console.log(`Testing: ${tagName}`);

  const el = document.createElement(tagName);
  document.body.appendChild(el);

  try {
    await window.panAutoload.maybeLoadFor(el);

    if (customElements.get(tagName)) {
      console.log(`✅ ${tagName} loaded successfully`);
      return true;
    } else {
      console.error(`❌ ${tagName} failed to define`);
      return false;
    }
  } catch (err) {
    console.error(`❌ ${tagName} load error:`, err);
    return false;
  } finally {
    el.remove();
  }
}

// Test multiple components
await testComponentLoad(&#039;my-component&#039;);
await testComponentLoad(&#039;my-widget&#039;);</code></pre>
<hr>
<h2>10. Error Messages Reference</h2>
<h3>10.1 Bus Error Codes</h3>
<p>| Code | Message | Cause | Solution |
|------|---------|-------|----------|
| <code>RATE_LIMIT_EXCEEDED</code> | Too many messages | Client exceeded rate limit | Reduce publish frequency or increase limit |
| <code>MESSAGE_INVALID</code> | Message validation failed | Data not serializable or too large | Check message data, avoid circular refs |
| <code>SUBSCRIPTION_INVALID</code> | Subscription rejected | Invalid pattern or global wildcard disabled | Fix pattern or enable global wildcards |
| <code>PAYLOAD_SIZE_EXCEEDED</code> | Payload too large | Data exceeds maxPayloadSize | Reduce data size or increase limit |</p>
<h3>10.2 Component Loading Errors</h3>
<pre><code class="language-javascript">// &quot;Failed to load module&quot;
// Cause: 404 on component file
// Solution: Check file path, verify file exists

// &quot;Uncaught SyntaxError: Cannot use import statement outside a module&quot;
// Cause: Missing type=&quot;module&quot;
// Solution: Add type=&quot;module&quot; to script tag

// &quot;Failed to execute &#039;define&#039; on &#039;CustomElementRegistry&#039;&quot;
// Cause: Element already defined or invalid name
// Solution: Check for duplicate definitions, verify tag name has dash

// &quot;The provided value is not of type &#039;Function&#039;&quot;
// Cause: Component didn&#039;t export a class
// Solution: Export class as default

// &quot;Uncaught TypeError: Cannot read property &#039;prototype&#039; of undefined&quot;
// Cause: Module didn&#039;t load correctly
// Solution: Check network tab, verify import path</code></pre>
<h3>10.3 Message Errors</h3>
<pre><code class="language-javascript">// &quot;PAN request timeout&quot;
// Cause: No responder or responder too slow
// Solution: Verify responder subscribed, increase timeout

// &quot;Data must be JSON-serializable&quot;
// Cause: Circular reference or function in data
// Solution: Only send plain objects, arrays, primitives

// &quot;Message size exceeds limit&quot;
// Cause: Message too large (default 1MB)
// Solution: Reduce data size or increase maxMessageSize

// &quot;Topic must be a non-empty string&quot;
// Cause: Missing or invalid topic
// Solution: Provide valid topic string</code></pre>
<h3>10.4 Browser-Specific Errors</h3>
<p>#### Safari</p>
<pre><code class="language-javascript">// &quot;ReferenceError: Can&#039;t find variable: customElements&quot;
// Cause: Safari &lt; 10.1
// Solution: Update Safari or load polyfill

// &quot;TypeError: IntersectionObserver is not a constructor&quot;
// Cause: Safari &lt; 12.1
// Solution: Load IntersectionObserver polyfill</code></pre>
<p>#### Firefox</p>
<pre><code class="language-javascript">// &quot;Import declarations may only appear at top level of a module&quot;
// Cause: Dynamic import() in wrong context
// Solution: Use static imports or ensure module context</code></pre>
<hr>
<h2>11. Browser Compatibility Issues</h2>
<h3>11.1 Check Browser Support</h3>
<pre><code class="language-javascript">import { Features } from &#039;./src/utils/features.mjs&#039;;

// Check if browser is compatible
if (!Features.hasCoreFeatuers()) {
  console.error(&#039;Browser not supported!&#039;);

  // Show upgrade message
  const report = Features.getReport();
  console.log(&#039;Missing features:&#039;, report.core);
  console.log(&#039;Recommendations:&#039;, report.recommendations);
}

// Check specific features
if (!Features.has.intersectionObserver()) {
  console.warn(&#039;IntersectionObserver not supported, components will load immediately&#039;);
}</code></pre>
<h3>11.2 Safari-Specific Issues</h3>
<p>#### 11.2.1 Module Caching</p>
<strong>Problem:</strong> Safari aggressively caches modules
<strong>Solution:</strong>
<pre><code class="language-javascript">// Add cache-busting to avoid stale modules
const version = &#039;1.0.2&#039;;
const script = document.createElement(&#039;script&#039;);
script.type = &#039;module&#039;;
script.src = `./pan.mjs?v=${version}`;</code></pre>
<p>#### 11.2.2 Private File System</p>
<strong>Problem:</strong> Safari doesn't support OPFS
<strong>Solution:</strong>
<pre><code class="language-javascript">// Check support and use fallback
if (!Features.has.opfs()) {
  console.log(&#039;OPFS not available, using IndexedDB fallback&#039;);
  // Use alternative storage
}</code></pre>
<h3>11.3 Firefox Issues</h3>
<p>#### 11.3.1 Dynamic Imports</p>
<strong>Problem:</strong> Firefox strict about dynamic imports
<strong>Solution:</strong>
<pre><code class="language-javascript">// Use static imports when possible
import { PanClient } from &#039;./pan-client.mjs&#039;;

// Or ensure dynamic imports are properly contextualized
async function loadComponent(name) {
  const module = await import(`./components/${name}.mjs`);
  return module.default;
}</code></pre>
<h3>11.4 Older Browser Support</h3>
<strong>Problem:</strong> Need to support older browsers
<strong>Solution:</strong>
<pre><code class="language-html">&lt;!-- Load polyfills for older browsers --&gt;
&lt;script src=&quot;https://unpkg.com/@webcomponents/webcomponentsjs@2.8.0/webcomponents-loader.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://unpkg.com/intersection-observer@0.12.2/intersection-observer.js&quot;&gt;&lt;/script&gt;

&lt;!-- Then load LARC --&gt;
&lt;script type=&quot;module&quot; src=&quot;./pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<hr>
<h2>12. Integration Issues</h2>
<h3>12.1 React Integration</h3>
<strong>Problem:</strong> Components not rendering in React
<strong>Solution:</strong>
<pre><code class="language-javascript">import { useEffect, useRef } from &#039;react&#039;;

function MyReactComponent() {
  const ref = useRef();

  useEffect(() =&gt; {
    // Wait for custom element to be defined
    if (customElements.get(&#039;my-component&#039;)) {
      ref.current.setAttribute(&#039;data&#039;, JSON.stringify({ value: &#039;test&#039; }));
    } else {
      customElements.whenDefined(&#039;my-component&#039;).then(() =&gt; {
        ref.current.setAttribute(&#039;data&#039;, JSON.stringify({ value: &#039;test&#039; }));
      });
    }
  }, []);

  return &lt;my-component ref={ref}&gt;&lt;/my-component&gt;;
}</code></pre>
<h3>12.2 Vue Integration</h3>
<strong>Problem:</strong> Vue tries to parse custom elements
<strong>Solution:</strong>
<pre><code class="language-javascript">// vue.config.js or vite.config.js
export default {
  compilerOptions: {
    isCustomElement: tag =&gt; tag.includes(&#039;-&#039;)
  }
}

// Or in Vue 3 app
app.config.compilerOptions.isCustomElement = tag =&gt; tag.includes(&#039;-&#039;);</code></pre>
<h3>12.3 Shadow DOM Conflicts</h3>
<strong>Problem:</strong> Styles don't apply to custom elements
<strong>Solution:</strong>
<pre><code class="language-javascript">// Custom element with open shadow DOM
class MyComponent extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: &#039;open&#039; });
  }

  connectedCallback() {
    // Add styles to shadow root
    this.shadowRoot.innerHTML = `
      &lt;style&gt;
        :host {
          display: block;
        }
        /* Component styles */
      &lt;/style&gt;
      &lt;div&gt;Content&lt;/div&gt;
    `;
  }
}</code></pre>
<hr>
<h2>13. Development vs Production Issues</h2>
<h3>13.1 Works in Dev, Not in Production</h3>
<p>#### 13.1.1 CDN Version Mismatch</p>
<pre><code class="language-javascript">// Development
&lt;script type=&quot;module&quot; src=&quot;./pan.mjs&quot;&gt;&lt;/script&gt;

// Production - ensure version matches!
&lt;script type=&quot;module&quot; src=&quot;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&quot;&gt;&lt;/script&gt;</code></pre>
<p>#### 13.1.2 Path Resolution</p>
<pre><code class="language-javascript">// Dev: Relative paths work
import { PanClient } from &#039;./components/pan-client.mjs&#039;;

// Prod: May need absolute paths or import map
import { PanClient } from &#039;/static/larc/components/pan-client.mjs&#039;;</code></pre>
<p>#### 13.1.3 Caching Issues</p>
<pre><code class="language-javascript">// Clear production cache
// Add cache-busting headers
// Nginx:
add_header Cache-Control &quot;public, max-age=0, must-revalidate&quot;;

// Or use versioned URLs
&lt;script type=&quot;module&quot; src=&quot;/static/pan.mjs?v=1.0.2&quot;&gt;&lt;/script&gt;</code></pre>
<h3>13.2 Minification Breaking Code</h3>
<strong>Problem:</strong> Minified code doesn't work
<strong>Solution:</strong>
<pre><code class="language-javascript">// Ensure minifier preserves ES modules
// Using esbuild:
esbuild.build({
  entryPoints: [&#039;src/pan.mjs&#039;],
  outfile: &#039;dist/pan.min.mjs&#039;,
  bundle: false,
  minify: true,
  format: &#039;esm&#039;,  // Keep as ES module
  target: &#039;es2020&#039;
});</code></pre>
<h3>13.3 Source Maps Missing</h3>
<strong>Problem:</strong> Can't debug production issues
<strong>Solution:</strong>
<pre><code class="language-javascript">// Generate source maps
esbuild.build({
  entryPoints: [&#039;src/pan.mjs&#039;],
  outfile: &#039;dist/pan.min.mjs&#039;,
  minify: true,
  sourcemap: true,
  sourcesContent: true
});

// Deploy source maps
// Nginx: Serve .map files with correct headers
location ~ \.map$ {
  add_header Content-Type application/json;
}</code></pre>
<hr>
<h2>14. Diagnostic Workflows</h2>
<h3>14.1 Component Not Appearing</h3>
<pre><code class="language-plaintext">1. Is component in DOM?
   ├─ No → Check HTML, verify element added
   └─ Yes → Continue

2. Is component :defined?
   ├─ No → Continue to step 3
   └─ Yes → Check component&#039;s connectedCallback, styles

3. Check console for errors
   ├─ 404 error → Fix file path (step 4)
   ├─ CORS error → Fix CDN/headers (section 7)
   ├─ CSP error → Update CSP (section 8)
   └─ No errors → Continue to step 4

4. Check component file path
   ├─ Has data-module? → Verify path exists
   └─ No data-module → Check autoloader config

5. Check autoloader configuration
   └─ console.log(window.panAutoload.config)

6. Manually load component
   └─ await window.panAutoload.maybeLoadFor(element)

7. Check Network tab
   └─ Look for .mjs requests, check status codes</code></pre>
<h3>14.2 Messages Not Flowing</h3>
<pre><code class="language-plaintext">1. Is bus ready?
   ├─ No → Wait for pan:sys.ready event
   └─ Yes → Continue

2. Check publisher
   ├─ await client.ready() called? → Yes/Continue
   └─ No → Add await client.ready()

3. Check subscriber
   ├─ Subscription before publish? → Yes/Continue
   ├─ Pattern matches topic? → Test with PanClient.matches()
   └─ Element still in DOM? → Check isConnected

4. Enable debug mode
   └─ &lt;pan-bus debug=&quot;true&quot;&gt;&lt;/pan-bus&gt;

5. Log all messages
   └─ client.subscribe(&#039;*&#039;, msg =&gt; console.log(msg))

6. Check bus stats
   └─ await getBusStats()

7. Verify no errors in console</code></pre>
<h3>14.3 Performance Degradation</h3>
<pre><code class="language-plaintext">1. Check memory usage
   └─ console.log(performance.memory)

2. Check subscription count
   └─ await getBusStats() → Check subscriptions count

3. Profile message rate
   └─ Monitor msg/sec (section 9.4)

4. Check for subscription leaks
   └─ Are components cleaning up? (section 6.1.1)

5. Check message size
   └─ Log message size, check for large payloads

6. Check handler performance
   └─ Profile handlers with Performance tab

7. Consider rate limiting
   └─ Debounce frequent publishes (section 6.2.2)</code></pre>
<h3>14.4 Minimal Reproduction</h3>
<p>To report a bug, create minimal reproduction:</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;title&gt;LARC Issue Reproduction&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus debug=&quot;true&quot;&gt;&lt;/pan-bus&gt;

  &lt;script type=&quot;module&quot;&gt;
    import { PanClient } from &#039;https://unpkg.com/@larcjs/core@2.0.0/src/pan.mjs&#039;;

    const client = new PanClient();
    await client.ready();

    // Minimal code to reproduce issue
    client.subscribe(&#039;test&#039;, msg =&gt; {
      console.log(&#039;Received:&#039;, msg);
    });

    client.publish({
      topic: &#039;test&#039;,
      data: { value: 123 }
    });

    // Expected: See message in console
    // Actual: [describe what happens]
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<hr>
<h2>15. Getting Help</h2>
<h3>15.1 Before Asking for Help</h3>
<ul><li>[ ] Check this troubleshooting guide</li>
<li>[ ] Search <a href="https://github.com/larcjs/core/issues">GitHub Issues</a></li>
<li>[ ] Read <a href="./API_REFERENCE.md">API Reference</a></li>
<li>[ ] Read <a href="./PRODUCTION-DEPLOYMENT.md">Production Deployment Guide</a></li>
<li>[ ] Create minimal reproduction (section 14.4)</li>
<li>[ ] Check browser console for errors</li>
<li>[ ] Test in different browser</li>
</ul>
<h3>15.2 Information to Include</h3>
<p>When reporting an issue, include:</p>
<li><strong>LARC Version</strong></li>
   <pre><code class="language-javascript">// Check version
   // From CDN URL or package.json</code></pre>
<li><strong>Browser & Version</strong></li>
   <pre><code class="language-javascript">// Copy from DevTools
   console.log(navigator.userAgent);

   // Or use feature detection
   const report = Features.getReport();
   console.log(report.browser);</code></pre>
<li><strong>Error Messages</strong></li>
   <pre><code class="language-plaintext">Copy exact error from console, including stack trace</code></pre>
<li><strong>Reproduction Steps</strong></li>
   <pre><code class="language-plaintext">1. Create component with...
   2. Subscribe to topic...
   3. Publish message...
   4. Error occurs</code></pre>
<li><strong>Expected vs Actual Behavior</strong></li>
   <pre><code class="language-plaintext">Expected: Message delivered to subscriber
   Actual: Subscriber never receives message</code></pre>
<li><strong>Configuration</strong></li>
   <pre><code class="language-javascript">// Copy your config
   console.log(window.panAutoload.config);</code></pre>
<h3>15.3 Resources</h3>
<ul><li><strong>Documentation:</strong> <a href="https://larcjs.github.io/site/">https://larcjs.github.io/site/</a></li>
<li><strong>GitHub:</strong> <a href="https://github.com/larcjs/core">https://github.com/larcjs/core</a></li>
<li><strong>Issues:</strong> <a href="https://github.com/larcjs/core/issues">https://github.com/larcjs/core/issues</a></li>
<li><strong>Discussions:</strong> <a href="https://github.com/larcjs/core/discussions">https://github.com/larcjs/core/discussions</a></li>
</ul>
<h3>15.4 Community Guidelines</h3>
<ul><li>Search before posting</li>
<li>Be specific and provide details</li>
<li>Include minimal reproduction</li>
<li>Be respectful and patient</li>
<li>Help others when you can</li>
</ul>
<hr>
<h2>Appendix: Quick Debugging Snippets</h2>
<h3>A1. Test Everything</h3>
<pre><code class="language-javascript">// Comprehensive test script
// Paste in browser console

console.log(&#039;=== LARC Debug Report ===&#039;);

// 1. Check bus
const bus = document.querySelector(&#039;pan-bus&#039;);
console.log(&#039;Bus exists:&#039;, !!bus);
console.log(&#039;Bus ready:&#039;, window.__panReady);

// 2. Check autoloader
console.log(&#039;Autoloader:&#039;, !!window.panAutoload);
if (window.panAutoload) {
  console.log(&#039;Config:&#039;, window.panAutoload.config);
}

// 3. Check features
if (window.Features) {
  const report = window.Features.getReport();
  console.log(&#039;Browser:&#039;, report.browser);
  console.log(&#039;Compatible:&#039;, report.compatible);
  console.log(&#039;Recommendations:&#039;, report.recommendations);
}

// 4. List custom elements
const customElements = [];
document.querySelectorAll(&#039;*&#039;).forEach(el =&gt; {
  if (el.tagName.includes(&#039;-&#039;)) {
    customElements.push({
      tag: el.tagName,
      defined: !!window.customElements.get(el.localName),
      connected: el.isConnected
    });
  }
});
console.log(&#039;Custom elements:&#039;, customElements);

// 5. Test message flow
const testClient = new PanClient();
await testClient.ready();

let received = false;
testClient.subscribe(&#039;debug.test&#039;, () =&gt; {
  received = true;
  console.log(&#039;✅ Message flow working!&#039;);
});

testClient.publish({ topic: &#039;debug.test&#039;, data: {} });

setTimeout(() =&gt; {
  if (!received) {
    console.error(&#039;❌ Message flow broken!&#039;);
  }
}, 100);

console.log(&#039;=== End Debug Report ===&#039;);</code></pre>
<h3>A2. Monitor All Activity</h3>
<pre><code class="language-javascript">// Log everything LARC does
const client = new PanClient();
await client.ready();

// Log all messages
client.subscribe(&#039;*&#039;, (msg) =&gt; {
  console.log(`📨 [${msg.topic}]`, msg);
});

// Monitor bus events
[&#039;pan:publish&#039;, &#039;pan:subscribe&#039;, &#039;pan:unsubscribe&#039;, &#039;pan:deliver&#039;].forEach(type =&gt; {
  document.addEventListener(type, (e) =&gt; {
    console.log(`🚌 ${type}:`, e.detail);
  }, true);
});

// Monitor custom element definitions
const originalDefine = customElements.define;
customElements.define = function(name, constructor, options) {
  console.log(`📦 Defined: ${name}`);
  return originalDefine.call(this, name, constructor, options);
};

console.log(&#039;Monitoring enabled&#039;);</code></pre>
<h3>A3. Performance Monitor</h3>
<pre><code class="language-javascript">// Track performance metrics
const metrics = {
  messages: 0,
  requests: 0,
  errors: 0,
  startTime: Date.now()
};

client.subscribe(&#039;*&#039;, (msg) =&gt; {
  metrics.messages++;
  if (msg.replyTo) metrics.requests++;
});

window.addEventListener(&#039;error&#039;, () =&gt; {
  metrics.errors++;
});

setInterval(() =&gt; {
  const elapsed = (Date.now() - metrics.startTime) / 1000;
  console.log(&#039;Performance:&#039;, {
    uptime: `${elapsed.toFixed(0)}s`,
    messageRate: `${(metrics.messages / elapsed).toFixed(2)}/s`,
    totalMessages: metrics.messages,
    requests: metrics.requests,
    errors: metrics.errors
  });
}, 10000);</code></pre>
<hr>
<strong>Last Updated:</strong> November 2024
<strong>Version:</strong> 1.0
<p>For the latest documentation, visit: <a href="https://larcjs.github.io/site/">https://larcjs.github.io/site/</a></p>
      </article>
      <footer class="docs-footer">
        <a href="https://github.com/chrisrobison/pan/edit/main/guides/TROUBLESHOOTING.md" target="_blank">
          Edit this page on GitHub
        </a>
      </footer>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" crossorigin="anonymous"></script>
  <script src="../assets/docs.js"></script>
</body>
</html>