<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- CRITICAL: Load theme BEFORE CSS to prevent flash -->
  <script src="../../../../../../playground/theme-init.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Utility Components Reference · PAN Documentation</title>
  <meta name="description" content="PAN (Page Area Network) Documentation - Utility Components Reference">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/theme.css">
  <link rel="stylesheet" href="../assets/docs.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha384-wH75j6z1lH97ZOpMOInqhgKzFkAInZPPSPlZpYKYTOqsaizPvhQZmAtLcPKXpLyH" crossorigin="anonymous">
</head>
<body>
  <header class="docs-header">
    <div class="docs-header-content">
      <a href="../index.html" class="logo">
        <span>PAN</span>
      </a>
      <nav class="docs-nav">
        <a href="../index.html">Home</a>
        <a href="index.html" class="active">Docs</a>
        <a href="../examples.html">Examples</a>
        <a href="../apps.html">Apps</a>
        <a href="https://github.com/chrisrobison/pan" target="_blank">GitHub</a>
      </nav>
    </div>
  </header>

  <div class="docs-layout">
    <aside class="docs-sidebar">
      <div class="docs-sidebar-content">
        <h3>Documentation</h3>
        <nav class="docs-menu" id="docs-menu">
          <!-- Will be populated by JavaScript -->
        </nav>
      </div>
    </aside>

    <main class="docs-main">
      <div class="docs-breadcrumb">
        <a href="../index.html">Home</a> / <a href="#">books</a> / <a href="#">building-with-larc</a> / <a href="#">chapters</a> / <span>21-utility-components</span>
      </div>
      <article class="docs-content">
        <h1>Utility Components Reference</h1>
<p>API documentation for LARC's utility components. For tutorials, see <em>Learning LARC</em> Chapter 14.</p>
<h2>pan-debug</h2>
<strong>Purpose</strong>: Message tracing and debugging for PAN bus introspection  
<strong>Import</strong>: <code>import { PanDebugManager } from './pan-debug.mjs';</code>  
<strong>Global Access</strong>: <code>window.pan.debug</code> (when using pan-bus)
<h3>Quick Example</h3>
<pre><code class="language-javascript">// Access via global
const debug = window.pan.debug;

// Enable tracing
debug.enableTracing({ maxBuffer: 500, sampleRate: 1.0 });

// Query messages
const recentMessages = debug.getTrace({ limit: 10 });
console.log(&#039;Recent messages:&#039;, recentMessages);

// Find specific messages
const loginMessages = debug.findMessages({
  topic: &#039;user.login&#039;,
  timeRange: { start: Date.now() - 60000 } // Last minute
});

// Export for analysis
const traceData = debug.exportTrace();
console.log(&#039;Trace export:&#039;, traceData);

// Disable when done
debug.disableTracing();</code></pre>
<h3>API</h3>
<p>#### Constructor</p>
<pre><code class="language-javascript">new PanDebugManager()</code></pre>
<p>Creates debug manager with defaults:</p>
<ul><li><code>enabled</code>: false</li>
<li><code>maxBuffer</code>: 1000</li>
<li><code>sampleRate</code>: 1.0 (100%)</li>
</ul>
#### Configuration Methods
<p>| Method | Parameters | Description |
|--------|-----------|-------------|
| <code>enableTracing(options)</code> | options?: <code>{ maxBuffer?, sampleRate? }</code> | Enable message tracing |
| <code>disableTracing()</code> | - | Disable tracing and clear buffer |
| <code>setSampleRate(rate)</code> | rate: Number (0.0-1.0) | Set sampling rate |
| <code>clearTrace()</code> | - | Clear trace buffer |</p>
<strong>options:</strong>
<ul><li><code>maxBuffer</code> (Number, default: 1000): Max messages to retain</li>
<li><code>sampleRate</code> (Number, default: 1.0): Sampling rate (0.0-1.0)</li>
</ul>
#### Query Methods
<p>| Method | Parameters | Returns | Description |
|--------|-----------|---------|-------------|
| <code>getTrace(options)</code> | options?: <code>{ limit?, offset? }</code> | Array | Get trace buffer |
| <code>findMessages(query)</code> | query: Object | Array | Find messages matching criteria |
| <code>getStats()</code> | - | Object | Get statistics |
| <code>exportTrace(format)</code> | format?: String | String/Object | Export trace data |</p>
<strong>Query options:</strong>
<ul><li><code>topic</code> (String): Match topic pattern</li>
<li><code>clientId</code> (String): Filter by client ID</li>
<li><code>timeRange</code> (Object): <code>{ start?, end? }</code> in milliseconds</li>
<li><code>limit</code> (Number): Max results</li>
</ul>
<strong>Stats object:</strong>
<pre><code class="language-javascript">{
  totalMessages: 1523,
  tracedMessages: 1523,
  droppedMessages: 0,
  bufferSize: 1000,
  sampleRate: 1.0,
  enabled: true
}</code></pre>
<h3>Complete Example</h3>
<pre><code class="language-javascript">import { PanDebugManager } from &#039;./pan-debug.mjs&#039;;

// Create and enable
const debug = new PanDebugManager();
debug.enableTracing({ maxBuffer: 1000, sampleRate: 0.1 }); // Sample 10%

// Build debug UI
function buildDebugPanel() {
  const panel = document.createElement(&#039;div&#039;);
  panel.style.cssText = `
    position: fixed; bottom: 0; right: 0; width: 400px; height: 300px;
    background: white; border: 1px solid #ccc; overflow: auto; 
    font-family: monospace; font-size: 12px; padding: 10px;
  `;

  const refresh = () =&gt; {
    const messages = debug.getTrace({ limit: 20 });
    panel.innerHTML = `
      &lt;h3&gt;PAN Bus Debug (${debug.getStats().totalMessages} total)&lt;/h3&gt;
      &lt;button onclick=&quot;window.panDebug.clearTrace()&quot;&gt;Clear&lt;/button&gt;
      &lt;button onclick=&quot;window.panDebug.exportToConsole()&quot;&gt;Export&lt;/button&gt;
      &lt;hr&gt;
      ${messages.map(msg =&gt; `
        &lt;div style=&quot;margin: 5px 0; border-left: 3px solid #007bff; padding-left: 5px;&quot;&gt;
          &lt;strong&gt;${msg.topic}&lt;/strong&gt;
          &lt;small&gt;(${new Date(msg.timestamp).toLocaleTimeString()})&lt;/small&gt;
          &lt;pre style=&quot;margin: 2px 0;&quot;&gt;${JSON.stringify(msg.data, null, 2)}&lt;/pre&gt;
        &lt;/div&gt;
      `).join(&#039;&#039;)}
    `;
  };

  // Refresh every 2 seconds
  setInterval(refresh, 2000);
  refresh();

  document.body.appendChild(panel);

  // Expose controls
  window.panDebug = {
    clearTrace: () =&gt; { debug.clearTrace(); refresh(); },
    exportToConsole: () =&gt; console.log(debug.exportTrace())
  };
}

// Initialize when bus ready
if (window.__panReady) {
  buildDebugPanel();
} else {
  window.addEventListener(&#039;pan:sys.ready&#039;, buildDebugPanel, { once: true });
}</code></pre>
<h3>Helper Functions</h3>
<pre><code class="language-javascript">// Filter by topic pattern
function findByTopic(pattern) {
  return debug.findMessages({ topic: pattern });
}

// Get message frequency
function getMessageFrequency() {
  const messages = debug.getTrace();
  const freq = {};
  messages.forEach(msg =&gt; {
    freq[msg.topic] = (freq[msg.topic] || 0) + 1;
  });
  return Object.entries(freq).sort((a, b) =&gt; b[1] - a[1]);
}

// Find slow handlers
function findSlowHandlers(thresholdMs = 100) {
  const messages = debug.getTrace();
  return messages.filter(msg =&gt; 
    msg.processingTime &amp;&amp; msg.processingTime &gt; thresholdMs
  );
}</code></pre>
<h3>Errors</h3>
<p>pan-debug can encounter various error conditions during tracing operations. All errors are thrown as standard JavaScript errors.</p>
<p>#### Error Conditions</p>
<p>| Code | Cause | Resolution |
|------|-------|------------|
| <code>BUFFER_OVERFLOW</code> | Trace buffer exceeded maxBuffer limit | Increase maxBuffer, reduce sampleRate, or clear trace more frequently |
| <code>INVALID_SAMPLE_RATE</code> | sampleRate outside 0.0-1.0 range | Provide valid sample rate between 0.0 and 1.0 |
| <code>QUERY_FAILED</code> | findMessages() query malformed | Check query object format (topic, clientId, timeRange) |
| <code>EXPORT_FAILED</code> | exportTrace() serialization error | Check for circular references or non-serializable data |
| <code>MEMORY_EXCEEDED</code> | Trace buffer consuming too much memory | Reduce maxBuffer or use lower sampleRate |</p>
<p>#### Error Handling</p>
<pre><code class="language-javascript">import { PanDebugManager } from &#039;./pan-debug.mjs&#039;;

const debug = new PanDebugManager();

// Safe initialization with error handling
function initializeDebugger(options = {}) {
  try {
    // Validate sample rate
    const sampleRate = options.sampleRate ?? 1.0;
    if (sampleRate &lt; 0 || sampleRate &gt; 1.0) {
      throw new Error(&#039;INVALID_SAMPLE_RATE: Sample rate must be between 0.0 and 1.0&#039;);
    }

    // Enable tracing with validated options
    debug.enableTracing({
      maxBuffer: options.maxBuffer || 1000,
      sampleRate: sampleRate
    });

    console.log(&#039;Debug tracing enabled&#039;);
  } catch (err) {
    console.error(&#039;Debug initialization failed:&#039;, err.message);
    // Fallback to minimal tracing
    debug.enableTracing({ maxBuffer: 100, sampleRate: 0.01 });
  }
}

// Safe query with error handling
function safeQuery(queryOptions) {
  try {
    // Validate time range
    if (queryOptions.timeRange) {
      const { start, end } = queryOptions.timeRange;
      if (start &amp;&amp; end &amp;&amp; start &gt; end) {
        throw new Error(&#039;QUERY_FAILED: Invalid time range (start &gt; end)&#039;);
      }
    }

    const results = debug.findMessages(queryOptions);
    return results;
  } catch (err) {
    console.error(&#039;Query failed:&#039;, err.message);
    return [];
  }
}

// Safe export with size checking
function safeExport(format = &#039;json&#039;) {
  try {
    const stats = debug.getStats();
    
    // Check buffer size before export
    if (stats.tracedMessages &gt; 10000) {
      console.warn(&#039;Large trace buffer, export may be slow&#039;);
      // Optionally export in chunks
      const chunkSize = 1000;
      const chunks = [];
      for (let i = 0; i &lt; stats.tracedMessages; i += chunkSize) {
        const chunk = debug.getTrace({ limit: chunkSize, offset: i });
        chunks.push(chunk);
      }
      return chunks;
    }

    const exportData = debug.exportTrace(format);
    return exportData;
  } catch (err) {
    console.error(&#039;Export failed:&#039;, err.message);
    // Return minimal diagnostic data
    return { error: err.message, stats: debug.getStats() };
  }
}

// Memory monitoring
function monitorMemory() {
  const stats = debug.getStats();
  const estimatedSize = stats.bufferSize * 1000; // ~1KB per message

  if (estimatedSize &gt; 10 * 1024 * 1024) { // 10MB threshold
    console.warn(&#039;MEMORY_EXCEEDED: Trace buffer exceeding 10MB&#039;);
    debug.clearTrace();
    debug.setSampleRate(0.1); // Reduce to 10%
  }
}

// Periodic memory check
setInterval(monitorMemory, 30000);

// Example: Safe debug UI with error boundaries
function buildRobustDebugPanel() {
  try {
    initializeDebugger({ maxBuffer: 500, sampleRate: 0.1 });

    const panel = document.createElement(&#039;div&#039;);
    panel.id = &#039;debug-panel&#039;;

    const refresh = () =&gt; {
      try {
        const messages = safeQuery({ limit: 20 });
        const stats = debug.getStats();

        panel.innerHTML = `
          &lt;h3&gt;PAN Debug (${stats.totalMessages} total, ${stats.droppedMessages} dropped)&lt;/h3&gt;
          &lt;p&gt;Buffer: ${stats.tracedMessages}/${stats.bufferSize} | Rate: ${stats.sampleRate * 100}%&lt;/p&gt;
          &lt;button onclick=&quot;clearDebugTrace()&quot;&gt;Clear&lt;/button&gt;
          &lt;button onclick=&quot;exportDebugTrace()&quot;&gt;Export&lt;/button&gt;
          ${stats.droppedMessages &gt; 0 ? &#039;&lt;span style=&quot;color:red;&quot;&gt;⚠ Messages dropped&lt;/span&gt;&#039; : &#039;&#039;}
          &lt;hr&gt;
          ${messages.length === 0 ? &#039;&lt;p&gt;No messages traced&lt;/p&gt;&#039; : 
            messages.map(msg =&gt; `
              &lt;div style=&quot;margin: 5px 0; padding: 5px; border: 1px solid #ddd;&quot;&gt;
                &lt;strong&gt;${msg.topic}&lt;/strong&gt;
                &lt;small&gt;${new Date(msg.timestamp).toLocaleTimeString()}&lt;/small&gt;
                &lt;pre&gt;${JSON.stringify(msg.data, null, 2).substring(0, 200)}&lt;/pre&gt;
              &lt;/div&gt;
            `).join(&#039;&#039;)
          }
        `;
      } catch (err) {
        panel.innerHTML = `&lt;p style=&quot;color:red;&quot;&gt;Error: ${err.message}&lt;/p&gt;`;
      }
    };

    setInterval(refresh, 2000);
    refresh();
    document.body.appendChild(panel);

    // Global safe controls
    window.clearDebugTrace = () =&gt; {
      try {
        debug.clearTrace();
        refresh();
      } catch (err) {
        console.error(&#039;Clear failed:&#039;, err.message);
      }
    };

    window.exportDebugTrace = () =&gt; {
      try {
        const data = safeExport();
        console.log(&#039;Exported trace:&#039;, data);
        // Optionally download as file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: &#039;application/json&#039; });
        const url = URL.createObjectURL(blob);
        const a = document.createElement(&#039;a&#039;);
        a.href = url;
        a.download = `pan-trace-${Date.now()}.json`;
        a.click();
      } catch (err) {
        console.error(&#039;Export failed:&#039;, err.message);
      }
    };

  } catch (err) {
    console.error(&#039;Debug panel initialization failed:&#039;, err.message);
  }
}</code></pre>
<p>#### Exceptions Thrown</p>
<ul><li><strong>TypeError</strong>: Invalid parameter types (e.g., non-numeric sample rate)</li>
<li><strong>Error</strong>: General tracing errors (buffer overflow, query failures, export errors)</li>
</ul>
#### Performance Considerations
<ul><li>Large buffers (>1000 messages) increase memory usage significantly</li>
<li>High sample rates (>0.1) can impact application performance</li>
<li>Export operations on large traces (>5000 messages) may block UI thread</li>
<li>Consider Web Workers for large export operations in production</li>
</ul>
<h3>Common Issues</h3>
<strong>High memory usage</strong>: Reduce <code>maxBuffer</code> or <code>sampleRate</code>. For production, use <code>sampleRate: 0.01</code> (1%).
<strong>Messages not appearing</strong>: Ensure tracing enabled and sampling rate > 0.
<strong>Performance impact</strong>: Tracing adds overhead. Use sampling (0.01-0.1) in production, or disable entirely.
<hr>
<h2>pan-forwarder</h2>
<strong>Purpose</strong>: Forward PAN messages to HTTP endpoints  
<strong>Import</strong>: <code><pan-forwarder></code> custom element
<h3>Quick Example</h3>
<pre><code class="language-html">&lt;pan-forwarder
  url=&quot;https://api.example.com/events&quot;
  topics=&quot;user.login,user.logout,error.*&quot;
  method=&quot;POST&quot;
  debounce=&quot;500&quot;&gt;
&lt;/pan-forwarder&gt;

&lt;script type=&quot;module&quot;&gt;
// Messages matching topics are automatically forwarded
// No additional code needed
&lt;/script&gt;</code></pre>
<h3>Attributes</h3>
<p>| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| <code>url</code> | String | "" | HTTP endpoint URL |
| <code>topics</code> | String | "*" | Comma-separated topic patterns |
| <code>method</code> | String | "POST" | HTTP method |
| <code>debounce</code> | Number | 0 | Debounce delay (ms) |
| <code>batch-size</code> | Number | 1 | Batch multiple messages |
| <code>batch-timeout</code> | Number | 1000 | Max batch wait time (ms) |
| <code>credentials</code> | String | "" | Fetch credentials mode |
| <code>deduplicate</code> | Boolean | false | Skip duplicate messages |</p>
<h3>Headers Configuration</h3>
<p>Configure headers via embedded JSON script:</p>
<pre><code class="language-html">&lt;pan-forwarder url=&quot;/api/events&quot; topics=&quot;user.*&quot;&gt;
  &lt;script type=&quot;application/json&quot;&gt;
    {
      &quot;headers&quot;: {
        &quot;Authorization&quot;: &quot;Bearer TOKEN&quot;,
        &quot;X-App-Version&quot;: &quot;1.0.0&quot;
      }
    }
  &lt;/script&gt;
&lt;/pan-forwarder&gt;</code></pre>
<h3>Request Format</h3>
<strong>Single message:</strong>
<pre><code class="language-json">{
  &quot;topic&quot;: &quot;user.login&quot;,
  &quot;data&quot;: { &quot;userId&quot;: 123 },
  &quot;timestamp&quot;: 1640000000000,
  &quot;id&quot;: &quot;msg-abc123&quot;
}</code></pre>
<strong>Batched messages:</strong>
<pre><code class="language-json">{
  &quot;messages&quot;: [
    { &quot;topic&quot;: &quot;user.login&quot;, &quot;data&quot;: {...}, &quot;timestamp&quot;: 1640000000000 },
    { &quot;topic&quot;: &quot;user.action&quot;, &quot;data&quot;: {...}, &quot;timestamp&quot;: 1640000001000 }
  ],
  &quot;batchSize&quot;: 2
}</code></pre>
<h3>Complete Example</h3>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;script type=&quot;module&quot;&gt;
    import &#039;./pan-bus.mjs&#039;;
    import &#039;./pan-forwarder.mjs&#039;;
    import { PanClient } from &#039;./pan-client.mjs&#039;;

    customElements.whenDefined(&#039;pan-bus&#039;).then(() =&gt; {
      const pc = new PanClient();

      // Application publishes messages normally
      document.getElementById(&#039;login-btn&#039;).addEventListener(&#039;click&#039;, () =&gt; {
        pc.publish(&#039;user.login&#039;, {
          userId: 123,
          timestamp: Date.now()
        });
        // Message automatically forwarded to server
      });

      // Track forwarding status
      pc.subscribe(&#039;forwarder.success&#039;, (msg) =&gt; {
        console.log(&#039;Forwarded:&#039;, msg.data.topic);
      });

      pc.subscribe(&#039;forwarder.error&#039;, (msg) =&gt; {
        console.error(&#039;Forward failed:&#039;, msg.data.error);
      });
    });
  &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;
  
  &lt;!-- Forward user events to analytics server --&gt;
  &lt;pan-forwarder
    url=&quot;https://analytics.example.com/events&quot;
    topics=&quot;user.login,user.logout,user.action&quot;
    method=&quot;POST&quot;
    debounce=&quot;1000&quot;
    batch-size=&quot;10&quot;
    batch-timeout=&quot;5000&quot;&gt;
    &lt;script type=&quot;application/json&quot;&gt;
      {
        &quot;headers&quot;: {
          &quot;Authorization&quot;: &quot;Bearer analytics-token&quot;,
          &quot;Content-Type&quot;: &quot;application/json&quot;
        }
      }
    &lt;/script&gt;
  &lt;/pan-forwarder&gt;

  &lt;!-- Forward errors to monitoring service --&gt;
  &lt;pan-forwarder
    url=&quot;https://monitoring.example.com/errors&quot;
    topics=&quot;error.*,*.error&quot;
    method=&quot;POST&quot;
    credentials=&quot;include&quot;&gt;
    &lt;script type=&quot;application/json&quot;&gt;
      {
        &quot;headers&quot;: {
          &quot;X-Service&quot;: &quot;my-app&quot;,
          &quot;X-Environment&quot;: &quot;production&quot;
        }
      }
    &lt;/script&gt;
  &lt;/pan-forwarder&gt;

  &lt;button id=&quot;login-btn&quot;&gt;Login (forwards to server)&lt;/button&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3>Server-Side Example</h3>
<strong>Node.js/Express:</strong>
<pre><code class="language-javascript">app.post(&#039;/events&#039;, express.json(), (req, res) =&gt; {
  const { topic, data, timestamp } = req.body;
  
  console.log(`Received: ${topic}`, data);
  
  // Process event
  if (topic === &#039;user.login&#039;) {
    analytics.track(&#039;login&#039;, data);
  }
  
  res.json({ success: true });
});

// Batched messages
app.post(&#039;/events/batch&#039;, express.json(), (req, res) =&gt; {
  const { messages } = req.body;
  
  messages.forEach(msg =&gt; {
    console.log(`Received: ${msg.topic}`, msg.data);
  });
  
  res.json({ success: true, processed: messages.length });
});</code></pre>
<h3>PAN Events</h3>
<p>#### Published</p>
<p>| Topic | Data | Description |
|-------|------|-------------|
| <code>forwarder.success</code> | <code>{ topic, url, status }</code> | Message forwarded successfully |
| <code>forwarder.error</code> | <code>{ topic, url, error, status }</code> | Forward failed |</p>
<h3>Errors</h3>
<p>pan-forwarder can encounter various error conditions when forwarding messages to HTTP endpoints. All errors are published as PAN messages on the <code>forwarder.error</code> topic.</p>
<p>#### Error Conditions</p>
<p>| Code | Cause | Resolution |
|------|-------|------------|
| <code>NETWORK_ERROR</code> | Network connection failed | Check internet connectivity, verify URL is reachable |
| <code>HTTP_ERROR</code> | Server returned error status (4xx, 5xx) | Check server logs, verify authentication, check endpoint exists |
| <code>BATCH_TIMEOUT</code> | Batch timeout exceeded before filling | Reduce batch-timeout or batch-size for low-volume scenarios |
| <code>TOPIC_MISMATCH</code> | No topics matched messages | Verify topic patterns, use "*" to match all messages |
| <code>PARSE_ERROR</code> | Response body parsing failed | Check server returns valid JSON, verify Content-Type header |
| <code>CORS_ERROR</code> | Cross-origin request blocked | Configure CORS headers on server, check credentials mode |
| <code>INVALID_CONFIG</code> | Malformed configuration JSON | Validate JSON syntax in embedded script tag |</p>
<p>#### Error Handling</p>
<pre><code class="language-javascript">import { PanClient } from &#039;./pan-client.mjs&#039;;

const pc = new PanClient();

// Monitor forwarding errors
pc.subscribe(&#039;forwarder.error&#039;, (msg) =&gt; {
  const { topic, url, error, status, response } = msg.data;
  console.error(`Forward failed [${topic}]:`, error);

  // Handle different error scenarios
  switch (true) {
    case error.includes(&#039;NETWORK_ERROR&#039;):
      handleNetworkError(topic, msg.data.originalMessage);
      break;

    case status === 401:
      console.error(&#039;Authentication required&#039;);
      refreshAuthToken();
      break;

    case status === 429:
      console.warn(&#039;Rate limited, backing off&#039;);
      increaseDebounce();
      break;

    case status &gt;= 500:
      console.warn(&#039;Server error, will retry&#039;);
      queueForRetry(topic, msg.data.originalMessage);
      break;

    case error.includes(&#039;CORS_ERROR&#039;):
      console.error(&#039;CORS configuration issue on server&#039;);
      showCorsWarning();
      break;

    default:
      console.error(&#039;Unhandled forward error:&#039;, error);
      logToErrorTracking({ topic, error, status });
  }
});

// Track successful forwards
let forwardCount = 0;
pc.subscribe(&#039;forwarder.success&#039;, (msg) =&gt; {
  forwardCount++;
  console.log(`Forwarded ${msg.data.topic} (total: ${forwardCount})`);
});

// Network error handling with offline queue
const offlineQueue = [];
let isOnline = navigator.onLine;

function handleNetworkError(topic, originalMessage) {
  if (!isOnline) {
    console.log(&#039;Queueing message for offline:&#039;, topic);
    offlineQueue.push({ topic, data: originalMessage });
    localStorage.setItem(&#039;forwarder_queue&#039;, JSON.stringify(offlineQueue));
  }
}

// Restore queue when online
window.addEventListener(&#039;online&#039;, () =&gt; {
  isOnline = true;
  const saved = localStorage.getItem(&#039;forwarder_queue&#039;);
  if (saved) {
    const queue = JSON.parse(saved);
    console.log(`Replaying ${queue.length} queued messages`);
    queue.forEach(({ topic, data }) =&gt; {
      pc.publish(topic, data);
    });
    localStorage.removeItem(&#039;forwarder_queue&#039;);
    offlineQueue.length = 0;
  }
});

window.addEventListener(&#039;offline&#039;, () =&gt; {
  isOnline = false;
  console.warn(&#039;Network offline, queueing messages&#039;);
});

// Retry logic with exponential backoff
const retryQueue = [];
let retryTimer = null;

function queueForRetry(topic, message, retries = 0) {
  if (retries &gt;= 3) {
    console.error(&#039;Max retries exceeded for:&#039;, topic);
    logToErrorTracking({ topic, message, error: &#039;max_retries_exceeded&#039; });
    return;
  }

  retryQueue.push({ topic, message, retries });

  if (!retryTimer) {
    const delay = Math.pow(2, retries) * 1000; // 1s, 2s, 4s
    retryTimer = setTimeout(() =&gt; {
      console.log(`Retrying ${retryQueue.length} messages...`);
      const batch = [...retryQueue];
      retryQueue.length = 0;
      retryTimer = null;

      batch.forEach(({ topic, message, retries }) =&gt; {
        pc.publish(topic, message);
        // Monitor if it fails again
        const unsubscribe = pc.subscribe(&#039;forwarder.error&#039;, (msg) =&gt; {
          if (msg.data.topic === topic) {
            queueForRetry(topic, message, retries + 1);
            unsubscribe();
          }
        });
      });
    }, delay);
  }
}

// Dynamic debounce adjustment for rate limiting
let currentDebounce = 0;

function increaseDebounce() {
  currentDebounce = Math.min(currentDebounce + 500, 5000); // Max 5s
  console.log(`Increased debounce to ${currentDebounce}ms`);
  
  // Update forwarder element
  const forwarder = document.querySelector(&#039;pan-forwarder&#039;);
  if (forwarder) {
    forwarder.setAttribute(&#039;debounce&#039;, currentDebounce);
  }
}

// Reset debounce after successful forwards
let successCount = 0;
pc.subscribe(&#039;forwarder.success&#039;, () =&gt; {
  successCount++;
  if (successCount &gt;= 10 &amp;&amp; currentDebounce &gt; 0) {
    currentDebounce = Math.max(currentDebounce - 500, 0);
    console.log(`Reduced debounce to ${currentDebounce}ms`);
    const forwarder = document.querySelector(&#039;pan-forwarder&#039;);
    if (forwarder) {
      forwarder.setAttribute(&#039;debounce&#039;, currentDebounce);
    }
    successCount = 0;
  }
});

// Authentication token refresh
async function refreshAuthToken() {
  try {
    const response = await fetch(&#039;/api/refresh-token&#039;, {
      method: &#039;POST&#039;,
      credentials: &#039;include&#039;
    });
    
    if (response.ok) {
      const { token } = await response.json();
      
      // Update forwarder headers
      const forwarder = document.querySelector(&#039;pan-forwarder&#039;);
      const scriptTag = forwarder.querySelector(&#039;script[type=&quot;application/json&quot;]&#039;);
      const config = JSON.parse(scriptTag.textContent);
      config.headers.Authorization = `Bearer ${token}`;
      scriptTag.textContent = JSON.stringify(config, null, 2);
      
      console.log(&#039;Auth token refreshed&#039;);
    } else {
      console.error(&#039;Token refresh failed, redirecting to login&#039;);
      window.location.href = &#039;/login&#039;;
    }
  } catch (err) {
    console.error(&#039;Token refresh error:&#039;, err.message);
  }
}

// CORS warning display
function showCorsWarning() {
  const warning = document.createElement(&#039;div&#039;);
  warning.style.cssText = `
    position: fixed; top: 20px; right: 20px; 
    background: #ff9800; color: white; padding: 15px;
    border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10000;
  `;
  warning.innerHTML = `
    &lt;strong&gt;⚠ CORS Error&lt;/strong&gt;&lt;br&gt;
    Server needs CORS headers configured.&lt;br&gt;
    &lt;button onclick=&quot;this.parentElement.remove()&quot;&gt;Dismiss&lt;/button&gt;
  `;
  document.body.appendChild(warning);
}

// Error tracking integration
function logToErrorTracking(errorData) {
  // Example: Send to monitoring service
  fetch(&#039;https://monitoring.example.com/errors&#039;, {
    method: &#039;POST&#039;,
    headers: { &#039;Content-Type&#039;: &#039;application/json&#039; },
    body: JSON.stringify({
      component: &#039;pan-forwarder&#039;,
      timestamp: Date.now(),
      ...errorData
    })
  }).catch(err =&gt; console.error(&#039;Error tracking failed:&#039;, err.message));
}

// Example: Robust forwarder with comprehensive error handling
function setupRobustForwarder() {
  const container = document.createElement(&#039;div&#039;);
  container.innerHTML = `
    &lt;pan-forwarder
      url=&quot;https://api.example.com/events&quot;
      topics=&quot;user.*,error.*&quot;
      method=&quot;POST&quot;
      debounce=&quot;1000&quot;
      batch-size=&quot;10&quot;
      batch-timeout=&quot;5000&quot;
      credentials=&quot;include&quot;&gt;
      &lt;script type=&quot;application/json&quot;&gt;
        {
          &quot;headers&quot;: {
            &quot;Authorization&quot;: &quot;Bearer initial-token&quot;,
            &quot;Content-Type&quot;: &quot;application/json&quot;,
            &quot;X-Client-Version&quot;: &quot;1.0.0&quot;
          }
        }
      &lt;/script&gt;
    &lt;/pan-forwarder&gt;

    &lt;div id=&quot;forward-stats&quot; style=&quot;position: fixed; bottom: 10px; right: 10px; background: white; padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;&quot;&gt;
      Forwards: &lt;span id=&quot;success-count&quot;&gt;0&lt;/span&gt; | 
      Errors: &lt;span id=&quot;error-count&quot;&gt;0&lt;/span&gt; | 
      Queued: &lt;span id=&quot;queue-count&quot;&gt;0&lt;/span&gt;
    &lt;/div&gt;
  `;
  
  document.body.appendChild(container);

  // Update stats display
  let errorCount = 0;
  pc.subscribe(&#039;forwarder.error&#039;, () =&gt; {
    errorCount++;
    document.getElementById(&#039;error-count&#039;).textContent = errorCount;
    document.getElementById(&#039;queue-count&#039;).textContent = offlineQueue.length + retryQueue.length;
  });

  pc.subscribe(&#039;forwarder.success&#039;, () =&gt; {
    document.getElementById(&#039;success-count&#039;).textContent = forwardCount;
  });

  // Periodic queue check
  setInterval(() =&gt; {
    document.getElementById(&#039;queue-count&#039;).textContent = offlineQueue.length + retryQueue.length;
  }, 1000);
}

// Initialize when ready
customElements.whenDefined(&#039;pan-bus&#039;).then(setupRobustForwarder);</code></pre>
<p>#### Exceptions Thrown</p>
<p>pan-forwarder does not throw exceptions directly. All errors are published as PAN messages on <code>forwarder.error</code> topic.</p>
<p>#### HTTP Status Codes</p>
<p>Common status codes encountered:</p>
<ul><li><strong>401 Unauthorized</strong>: Missing or invalid authentication token</li>
<li><strong>403 Forbidden</strong>: Valid token but insufficient permissions</li>
<li><strong>404 Not Found</strong>: Endpoint URL incorrect</li>
<li><strong>429 Too Many Requests</strong>: Rate limiting in effect</li>
<li><strong>500 Internal Server Error</strong>: Server-side processing error</li>
<li><strong>502 Bad Gateway</strong>: Server unreachable or down</li>
<li><strong>503 Service Unavailable</strong>: Server temporarily overloaded</li>
</ul>
#### Server Requirements
<p>For successful message forwarding, server must:</p>
<li>Accept POST requests (or configured method) at the URL</li>
<li>Support JSON request body (Content-Type: application/json)</li>
<li>Return JSON response with status field</li>
<li>Configure CORS headers if cross-origin:</li>
   <pre><code class="language-plaintext">Access-Control-Allow-Origin: *
   Access-Control-Allow-Methods: POST, OPTIONS
   Access-Control-Allow-Headers: Content-Type, Authorization</code></pre>
<li>Handle batched messages if batch-size > 1</li>
<li>Respond within reasonable timeout (default: 30s)</li>
<h3>Common Issues</h3>
<strong>Messages not forwarded</strong>: Check topic patterns match. Use <code>topics="*"</code> to forward all messages.
<strong>CORS errors</strong>: Configure CORS headers on server. Use <code>credentials="include"</code> for cookies.
<strong>Too many requests</strong>: Increase <code>debounce</code> or use <code>batch-size</code> to group messages.
<strong>Duplicate forwards</strong>: Enable <code>deduplicate="true"</code> to skip duplicate messages within 5-second window.
<strong>Server overload</strong>: Use batching (<code>batch-size="50"</code>, <code>batch-timeout="5000"</code>) to reduce request frequency.
<hr>
<h2>Summary</h2>
<p>This chapter documented LARC's utility components:</p>
<ul><li><strong>pan-debug</strong>: Message tracing and debugging with query capabilities</li>
<li><strong>pan-forwarder</strong>: HTTP message forwarding for server integration</li>
</ul>
These components provide observability and extensibility without modifying core application logic.
<strong>See Also</strong>:
<ul><li>Tutorial: <em>Learning LARC</em> Chapter 14</li>
<li>Core components: Chapter 17</li>
<li>Integration patterns: Chapter 20</li>
<li>Debugging guide: Appendix D</li>
</ul>
      </article>
      <footer class="docs-footer">
        <a href="https://github.com/chrisrobison/pan/edit/main/books/building-with-larc/chapters/21-utility-components.md" target="_blank">
          Edit this page on GitHub
        </a>
      </footer>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" crossorigin="anonymous"></script>
  <script src="../assets/docs.js"></script>
  <pan-theme-provider></pan-theme-provider>
</body>
</html>