<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Utility Components · PAN Documentation</title>
  <meta name="description" content="PAN (Page Area Network) Documentation - Utility Components">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/theme.css">
  <link rel="stylesheet" href="../assets/docs.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha384-wH75j6z1lH97ZOpMOInqhgKzFkAInZPPSPlZpYKYTOqsaizPvhQZmAtLcPKXpLyH" crossorigin="anonymous">
</head>
<body>
  <header class="docs-header">
    <div class="docs-header-content">
      <a href="../index.html" class="logo">
        <span>PAN</span>
      </a>
      <nav class="docs-nav">
        <a href="../index.html">Home</a>
        <a href="index.html" class="active">Docs</a>
        <a href="../examples.html">Examples</a>
        <a href="../apps.html">Apps</a>
        <a href="https://github.com/chrisrobison/pan" target="_blank">GitHub</a>
      </nav>
    </div>
  </header>

  <div class="docs-layout">
    <aside class="docs-sidebar">
      <div class="docs-sidebar-content">
        <h3>Documentation</h3>
        <nav class="docs-menu" id="docs-menu">
          <!-- Will be populated by JavaScript -->
        </nav>
      </div>
    </aside>

    <main class="docs-main">
      <div class="docs-breadcrumb">
        <a href="../index.html">Home</a> / <a href="#">books</a> / <a href="#">building-with-larc</a> / <span>chapter-25-utility-components</span>
      </div>
      <article class="docs-content">
        <h1>Utility Components</h1>
<blockquote>"The best debugging tool is still careful thought, coupled with judiciously placed print statements."</blockquote>
>
<blockquote>— Brian Kernighan</blockquote>
<p>Utility components are the unsung heroes of application development. They don't render UI, manage state, or fetch data. Instead, they provide infrastructure: observability, message routing, cross-system integration. They're the scaffolding that makes complex applications comprehensible and maintainable.</p>
<p>This chapter documents LARC's utility components: <code>pan-debug</code> for message tracing and debugging, and <code>pan-forwarder</code> for HTTP message forwarding. These components help you understand what's happening in your application and extend it beyond the browser.</p>
<h2>Overview</h2>
<p>LARC provides two utility components:</p>
<ul><li><strong>pan-debug</strong>: Message tracing and debugging utilities for introspection</li>
<li><strong>pan-forwarder</strong>: HTTP message forwarding for server integration</li>
</ul>
These components operate at the infrastructure level. <code>pan-debug</code> observes message flows without altering them, while <code>pan-forwarder</code> bridges LARC's in-browser message bus to external systems via HTTP. Together, they provide visibility into your application's behavior and pathways to external integration.
<h2>pan-debug: Message Tracing and Debugging</h2>
<h3>Overview</h3>
<code>pan-debug</code> is not a custom element—it's a JavaScript class (<code>PanDebugManager</code>) that provides introspection and debugging capabilities for PAN message flows. It tracks messages as they pass through the bus, records routing decisions, captures errors, and provides query capabilities for analysis.
<p>Think of it as flight data recorder for your message bus. When something goes wrong—a message disappears, a route doesn't fire, a handler throws an error—the trace buffer tells you exactly what happened.</p>
<h3>When to Use</h3>
<strong>Use <code>pan-debug</code> when:</strong>
<ul><li>Debugging routing issues or missing messages</li>
<li>Profiling message throughput and patterns</li>
<li>Investigating performance bottlenecks in message handling</li>
<li>Building developer tools or admin dashboards</li>
<li>Diagnosing production issues (with sampling to minimize overhead)</li>
</ul>
<strong>Don't use <code>pan-debug</code> when:</strong>
<ul><li>Building production applications (unless explicitly needed for diagnostics)</li>
<li>Memory is constrained (trace buffer can grow large)</li>
<li>You need real-time streaming of every message (sampling is more appropriate)</li>
</ul>
<h3>Installation and Setup</h3>
<code>pan-debug</code> is typically integrated into <code>pan-bus</code>. Access it via the global API after the bus is ready:
<pre><code class="language-javascript">// Wait for bus readiness
await new Promise(resolve =&gt; {
  if (window.__panReady) resolve();
  else window.addEventListener(&#039;pan:sys.ready&#039;, resolve, { once: true });
});

// Access debug manager
const debug = window.pan.debug;</code></pre>
<p>Alternatively, import the class directly:</p>
<pre><code class="language-javascript">import { PanDebugManager } from &#039;./pan-debug.mjs&#039;;

const debug = new PanDebugManager();</code></pre>
<p>Enable tracing to start capturing messages:</p>
<pre><code class="language-javascript">// Enable with defaults (1000 message buffer, 100% sampling)
debug.enableTracing();

// Enable with custom configuration
debug.enableTracing({
  maxBuffer: 500,    // Keep last 500 messages
  sampleRate: 0.1    // Sample 10% of messages
});</code></pre>
<h3>API Reference</h3>
<p>#### Constructor</p>
<pre><code class="language-javascript">new PanDebugManager()</code></pre>
<p>Creates a new debug manager instance with default configuration:</p>
<ul><li><code>enabled</code>: <code>false</code></li>
<li><code>maxBuffer</code>: <code>1000</code></li>
<li><code>sampleRate</code>: <code>1.0</code></li>
<li><code>traceBuffer</code>: <code>[]</code></li>
<li><code>messageCount</code>: <code>0</code></li>
</ul>
#### enableTracing(options)
<p>Enables message tracing with optional configuration.</p>
<strong>Parameters:</strong>
<ul><li><code>options</code> (Object, optional): Configuration object</li>
</ul>  - <code>maxBuffer</code> (Number): Maximum messages to retain. Default: <code>1000</code>
  - <code>sampleRate</code> (Number): Sampling rate from 0.0 to 1.0. Default: <code>1.0</code>
<strong>Returns:</strong> <code>undefined</code>
<strong>Example:</strong>
<pre><code class="language-javascript">// Enable with full sampling
debug.enableTracing();

// Enable with limited buffer
debug.enableTracing({ maxBuffer: 100 });

// Enable with 25% sampling for production
debug.enableTracing({
  maxBuffer: 500,
  sampleRate: 0.25
});</code></pre>
<p>#### disableTracing()</p>
<p>Disables message tracing. Logs the number of captured messages to the console.</p>
<strong>Returns:</strong> <code>undefined</code>
<strong>Example:</strong>
<pre><code class="language-javascript">debug.disableTracing();
// Console: &quot;[PAN Debug] Tracing disabled (captured 347 messages)&quot;</code></pre>
<p>#### trace(message, matchedRoutes)</p>
<p>Records a message trace entry. Typically called by the bus routing system, not user code.</p>
<strong>Parameters:</strong>
<ul><li><code>message</code> (Object, required): Message object to trace</li>
<li><code>matchedRoutes</code> (Array, optional): Array of route objects that matched this message. Default: <code>[]</code></li>
</ul>
<strong>Returns:</strong> <code>undefined</code>
<strong>Trace Entry Structure:</strong>
<pre><code class="language-javascript">{
  message: {       // Sanitized message copy
    id: &quot;msg-123&quot;,
    type: &quot;user.login&quot;,
    topic: &quot;user.login&quot;,
    ts: 1638360000000,
    data: { ... }
  },
  matchedRoutes: [ // Routes that matched
    {
      id: &quot;route-1&quot;,
      name: &quot;User Login Handler&quot;,
      actions: [&quot;publish&quot;, &quot;transform&quot;],
      error: null
    }
  ],
  ts: 1638360000000,  // Capture timestamp
  sequence: 347        // Message sequence number
}</code></pre>
<p>#### traceError(message, route, error)</p>
<p>Records a routing error for a previously traced message.</p>
<strong>Parameters:</strong>
<ul><li><code>message</code> (Object, required): Message that caused the error</li>
<li><code>route</code> (Object, required): Route that threw the error</li>
<li><code>error</code> (Error, required): Error object</li>
</ul>
<strong>Returns:</strong> <code>undefined</code>
<strong>Example:</strong>
<pre><code class="language-javascript">try {
  // Route action that throws
  executeRouteAction(message, route);
} catch (err) {
  debug.traceError(message, route, err);
  throw err;
}</code></pre>
<p>#### getTrace()</p>
<p>Returns a copy of the trace buffer.</p>
<strong>Returns:</strong> <code>Array<Object></code> - Array of trace entries
<strong>Example:</strong>
<pre><code class="language-javascript">const trace = debug.getTrace();
console.log(`Captured ${trace.length} messages`);

trace.forEach(entry =&gt; {
  console.log(`[${entry.sequence}] ${entry.message.topic}`, entry.message.data);
});</code></pre>
<p>#### clearTrace()</p>
<p>Clears the trace buffer and resets message count.</p>
<strong>Returns:</strong> <code>undefined</code>
<strong>Example:</strong>
<pre><code class="language-javascript">debug.clearTrace();
// Console: &quot;[PAN Debug] Trace buffer cleared&quot;</code></pre>
<p>#### getStats()</p>
<p>Returns statistics about the trace buffer.</p>
<strong>Returns:</strong> <code>Object</code> with the following properties:
<ul><li><code>enabled</code> (Boolean): Whether tracing is enabled</li>
<li><code>messageCount</code> (Number): Total messages seen (including sampled)</li>
<li><code>bufferSize</code> (Number): Current number of entries in buffer</li>
<li><code>maxBuffer</code> (Number): Maximum buffer size</li>
<li><code>sampleRate</code> (Number): Current sampling rate</li>
<li><code>oldestMessage</code> (Number, optional): Timestamp of oldest message</li>
<li><code>newestMessage</code> (Number, optional): Timestamp of newest message</li>
<li><code>timespan</code> (Number, optional): Milliseconds between oldest and newest</li>
</ul>
<strong>Example:</strong>
<pre><code class="language-javascript">const stats = debug.getStats();
console.log(`Tracing: ${stats.enabled ? &#039;ON&#039; : &#039;OFF&#039;}`);
console.log(`Buffer: ${stats.bufferSize} / ${stats.maxBuffer}`);
console.log(`Total processed: ${stats.messageCount}`);

if (stats.timespan) {
  console.log(`Timespan: ${(stats.timespan / 1000).toFixed(1)}s`);
}</code></pre>
<p>#### query(filter)</p>
<p>Queries the trace buffer with filtering options.</p>
<strong>Parameters:</strong>
<ul><li><code>filter</code> (Object, optional): Filter criteria</li>
</ul>  - <code>topic</code> (String): Match exact topic
  - <code>type</code> (String): Match exact message type
  - <code>hasRoutes</code> (Boolean): Filter by whether routes matched
  - <code>hasErrors</code> (Boolean): Filter by whether errors occurred
  - <code>startTs</code> (Number): Minimum timestamp (milliseconds)
  - <code>endTs</code> (Number): Maximum timestamp (milliseconds)
  - <code>limit</code> (Number): Maximum results to return (returns most recent)
<strong>Returns:</strong> <code>Array<Object></code> - Filtered trace entries
<strong>Example:</strong>
<pre><code class="language-javascript">// Find all user.* messages
const userMessages = debug.query({ topic: &#039;user.login&#039; });

// Find messages with no matched routes (dead letters)
const unrouted = debug.query({ hasRoutes: false });

// Find messages with errors
const errors = debug.query({ hasErrors: true });

// Find recent messages (last 10)
const recent = debug.query({ limit: 10 });

// Find messages in time range
const inRange = debug.query({
  startTs: Date.now() - 60000,  // Last minute
  limit: 50
});

// Combine filters
const errorMessages = debug.query({
  hasErrors: true,
  startTs: Date.now() - 300000,  // Last 5 minutes
  limit: 20
});</code></pre>
<p>#### export()</p>
<p>Exports the trace buffer as formatted JSON.</p>
<strong>Returns:</strong> <code>String</code> - JSON string with 2-space indentation
<strong>Example:</strong>
<pre><code class="language-javascript">const json = debug.export();

// Save to file
const blob = new Blob([json], { type: &#039;application/json&#039; });
const url = URL.createObjectURL(blob);
const a = document.createElement(&#039;a&#039;);
a.href = url;
a.download = `pan-trace-${Date.now()}.json`;
a.click();</code></pre>
<p>#### import(json)</p>
<p>Imports a trace buffer from JSON. Replaces the current buffer.</p>
<strong>Parameters:</strong>
<ul><li><code>json</code> (String, required): JSON string from previous export</li>
</ul>
<strong>Returns:</strong> <code>undefined</code>
<strong>Throws:</strong> Error if JSON is invalid
<strong>Example:</strong>
<pre><code class="language-javascript">// Load from file
const fileInput = document.querySelector(&#039;input[type=&quot;file&quot;]&#039;);
fileInput.addEventListener(&#039;change&#039;, async (e) =&gt; {
  const file = e.target.files[0];
  const json = await file.text();

  try {
    debug.import(json);
    console.log(&#039;Trace imported successfully&#039;);
  } catch (err) {
    console.error(&#039;Failed to import trace:&#039;, err);
  }
});</code></pre>
<h3>Helper Functions</h3>
<p>#### captureSnapshot(bus, routes, debug)</p>
<p>Creates a comprehensive snapshot of the current PAN state, including bus statistics, routing information, and debug status.</p>
<strong>Parameters:</strong>
<ul><li><code>bus</code> (Object, required): PAN bus instance</li>
<li><code>routes</code> (Object, required): Routes manager instance</li>
<li><code>debug</code> (Object, required): Debug manager instance</li>
</ul>
<strong>Returns:</strong> <code>Object</code> with the following structure:
<pre><code class="language-javascript">{
  timestamp: 1638360000000,
  bus: {
    stats: {
      published: 1247,
      subscriptions: 23,
      // ... other bus stats
    },
    subscriptions: 23,
    retained: 15
  },
  routes: {
    routeCount: 8,
    activeRoutes: 6,
    // ... other route stats
  },
  debug: {
    enabled: true,
    messageCount: 1247,
    bufferSize: 500,
    maxBuffer: 1000,
    sampleRate: 1.0
  }
}</code></pre>
<strong>Example:</strong>
<pre><code class="language-javascript">import { captureSnapshot } from &#039;./pan-debug.mjs&#039;;

// Capture current state
const snapshot = captureSnapshot(
  window.pan.bus,
  window.pan.routes,
  window.pan.debug
);

console.log(&#039;System snapshot:&#039;, snapshot);

// Store for later comparison
localStorage.setItem(&#039;pan-snapshot&#039;, JSON.stringify(snapshot));</code></pre>
<h3>Complete Working Examples</h3>
<p>#### Example 1: Basic Debug Session</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot;&gt;
    import &#039;./pan-bus.mjs&#039;;

    // Wait for bus
    await new Promise(resolve =&gt; {
      window.addEventListener(&#039;pan:sys.ready&#039;, resolve, { once: true });
    });

    const debug = window.pan.debug;
    const bus = window.pan.bus;

    // Enable tracing
    debug.enableTracing({ maxBuffer: 50 });

    // Publish test messages
    bus.publish(&#039;user.login&#039;, { userId: &#039;123&#039; });
    bus.publish(&#039;user.profile&#039;, { name: &#039;Alice&#039; });
    bus.publish(&#039;cart.add&#039;, { itemId: &#039;456&#039; });

    // Check trace
    console.log(&#039;Trace:&#039;, debug.getTrace());
    console.log(&#039;Stats:&#039;, debug.getStats());

    // Query for user messages
    const userMsgs = debug.query({
      topic: &#039;user.login&#039;
    });
    console.log(&#039;User messages:&#039;, userMsgs);
  &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>#### Example 2: Production Sampling</p>
<pre><code class="language-javascript">// Enable lightweight tracing in production
class ProductionDebugger {
  constructor() {
    this.debug = window.pan.debug;

    // Sample 5% of messages, keep last 200
    this.debug.enableTracing({
      maxBuffer: 200,
      sampleRate: 0.05
    });

    // Periodically check for errors
    setInterval(() =&gt; this.checkForErrors(), 60000);
  }

  checkForErrors() {
    const errors = this.debug.query({
      hasErrors: true,
      startTs: Date.now() - 60000  // Last minute
    });

    if (errors.length &gt; 0) {
      // Send to error tracking service
      this.reportErrors(errors);

      // Clear to prevent re-reporting
      this.debug.clearTrace();
    }
  }

  reportErrors(errors) {
    fetch(&#039;/api/errors&#039;, {
      method: &#039;POST&#039;,
      headers: { &#039;Content-Type&#039;: &#039;application/json&#039; },
      body: JSON.stringify({
        timestamp: Date.now(),
        errors: errors.map(e =&gt; ({
          message: e.message,
          route: e.matchedRoutes.find(r =&gt; r.error),
          error: e.matchedRoutes.find(r =&gt; r.error)?.error
        }))
      })
    });
  }
}

// Initialize in production
if (window.location.hostname !== &#039;localhost&#039;) {
  new ProductionDebugger();
}</code></pre>
<p>#### Example 3: Debug Dashboard</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;style&gt;
    body { font: 14px/1.4 system-ui; margin: 20px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
    .trace-entry { border-left: 3px solid #4a90e2; padding: 8px; margin: 4px 0; background: #f7f7f7; }
    .error { border-left-color: #e74c3c; }
    button { padding: 8px 16px; margin: 4px; cursor: pointer; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;PAN Debug Dashboard&lt;/h1&gt;

  &lt;div class=&quot;stats&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h3&gt;Status&lt;/h3&gt;
      &lt;div id=&quot;status&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h3&gt;Buffer&lt;/h3&gt;
      &lt;div id=&quot;buffer&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h3&gt;Timespan&lt;/h3&gt;
      &lt;div id=&quot;timespan&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;button id=&quot;toggle&quot;&gt;Enable Tracing&lt;/button&gt;
    &lt;button id=&quot;clear&quot;&gt;Clear Buffer&lt;/button&gt;
    &lt;button id=&quot;export&quot;&gt;Export JSON&lt;/button&gt;
    &lt;button id=&quot;errors&quot;&gt;Show Errors&lt;/button&gt;
    &lt;button id=&quot;unrouted&quot;&gt;Show Unrouted&lt;/button&gt;
    &lt;button id=&quot;all&quot;&gt;Show All&lt;/button&gt;
  &lt;/div&gt;

  &lt;div id=&quot;trace&quot;&gt;&lt;/div&gt;

  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;script type=&quot;module&quot;&gt;
    await new Promise(resolve =&gt; {
      window.addEventListener(&#039;pan:sys.ready&#039;, resolve, { once: true });
    });

    const debug = window.pan.debug;
    const bus = window.pan.bus;

    // Update dashboard
    function updateStats() {
      const stats = debug.getStats();

      document.getElementById(&#039;status&#039;).innerHTML =
        `Enabled: ${stats.enabled ? &#039;[v]&#039; : &#039;[x]&#039;}&lt;br&gt;` +
        `Messages: ${stats.messageCount}`;

      document.getElementById(&#039;buffer&#039;).innerHTML =
        `Size: ${stats.bufferSize} / ${stats.maxBuffer}&lt;br&gt;` +
        `Sample: ${(stats.sampleRate * 100).toFixed(0)}%`;

      if (stats.timespan) {
        document.getElementById(&#039;timespan&#039;).innerHTML =
          `${(stats.timespan / 1000).toFixed(1)}s`;
      }
    }

    // Display trace entries
    function displayTrace(entries) {
      const traceDiv = document.getElementById(&#039;trace&#039;);
      traceDiv.innerHTML = &#039;&#039;;

      entries.forEach(entry =&gt; {
        const div = document.createElement(&#039;div&#039;);
        div.className = &#039;trace-entry&#039;;

        if (entry.matchedRoutes.some(r =&gt; r.error)) {
          div.classList.add(&#039;error&#039;);
        }

        div.innerHTML = `
          &lt;strong&gt;[${entry.sequence}] ${entry.message.topic}&lt;/strong&gt;&lt;br&gt;
          &lt;pre&gt;${JSON.stringify(entry.message.data, null, 2)}&lt;/pre&gt;
          Routes: ${entry.matchedRoutes.length}
        `;

        traceDiv.appendChild(div);
      });

      updateStats();
    }

    // Controls
    document.getElementById(&#039;toggle&#039;).onclick = () =&gt; {
      if (debug.getStats().enabled) {
        debug.disableTracing();
        document.getElementById(&#039;toggle&#039;).textContent = &#039;Enable Tracing&#039;;
      } else {
        debug.enableTracing({ maxBuffer: 100 });
        document.getElementById(&#039;toggle&#039;).textContent = &#039;Disable Tracing&#039;;
      }
      updateStats();
    };

    document.getElementById(&#039;clear&#039;).onclick = () =&gt; {
      debug.clearTrace();
      displayTrace([]);
    };

    document.getElementById(&#039;export&#039;).onclick = () =&gt; {
      const json = debug.export();
      const blob = new Blob([json], { type: &#039;application/json&#039; });
      const url = URL.createObjectURL(blob);
      const a = document.createElement(&#039;a&#039;);
      a.href = url;
      a.download = `pan-trace-${Date.now()}.json`;
      a.click();
    };

    document.getElementById(&#039;errors&#039;).onclick = () =&gt; {
      displayTrace(debug.query({ hasErrors: true }));
    };

    document.getElementById(&#039;unrouted&#039;).onclick = () =&gt; {
      displayTrace(debug.query({ hasRoutes: false }));
    };

    document.getElementById(&#039;all&#039;).onclick = () =&gt; {
      displayTrace(debug.getTrace());
    };

    // Enable by default
    debug.enableTracing({ maxBuffer: 100 });
    document.getElementById(&#039;toggle&#039;).textContent = &#039;Disable Tracing&#039;;

    // Publish test messages
    setInterval(() =&gt; {
      bus.publish(&#039;test.ping&#039;, { ts: Date.now() });
    }, 2000);

    // Update display every second
    setInterval(updateStats, 1000);
    updateStats();
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3>Common Issues and Solutions</h3>
<strong>Issue: Trace buffer fills up quickly</strong>
<em>Solution:</em> Reduce <code>maxBuffer</code> or lower <code>sampleRate</code>:
<pre><code class="language-javascript">debug.enableTracing({
  maxBuffer: 200,
  sampleRate: 0.1  // Only 10% of messages
});</code></pre>
<strong>Issue: Missing messages in trace</strong>
<em>Cause:</em> Sampling is active
<em>Solution:</em> Check the sample rate:
<pre><code class="language-javascript">const stats = debug.getStats();
console.log(`Sample rate: ${stats.sampleRate}`);

// Increase to 100% for debugging
debug.enableTracing({ sampleRate: 1.0 });</code></pre>
<strong>Issue: Memory usage grows over time</strong>
<em>Cause:</em> Large trace buffer or high message volume
<em>Solution:</em> Use periodic cleanup:
<pre><code class="language-javascript">// Clear trace every 5 minutes
setInterval(() =&gt; {
  debug.clearTrace();
}, 300000);</code></pre>
<strong>Issue: Cannot find specific message</strong>
<em>Solution:</em> Use query filters:
<pre><code class="language-javascript">// Search by topic pattern
const results = debug.query({
  topic: &#039;user.login&#039;,
  startTs: Date.now() - 60000  // Last minute
});

if (results.length === 0) {
  console.log(&#039;No matching messages found&#039;);
  console.log(&#039;Total in buffer:&#039;, debug.getStats().bufferSize);
}</code></pre>
<h2>pan-forwarder: HTTP Message Forwarding</h2>
<h3>Overview</h3>
<code>pan-forwarder</code> is a custom element that forwards PAN messages to HTTP endpoints. It subscribes to topic patterns and POSTs each matching message to a configured destination, enabling integration with server-side systems, webhooks, and external APIs.
<p>Think of it as a bridge between LARC's in-browser message bus and the wider world. Messages published to the PAN bus can trigger server-side actions, be logged to external systems, or forwarded to other clients via a hub.</p>
<h3>When to Use</h3>
<strong>Use <code>pan-forwarder</code> when:</strong>
<ul><li>Synchronizing local actions to a server (chat messages, collaborative editing)</li>
<li>Logging client events to analytics or monitoring systems</li>
<li>Triggering server-side workflows from browser actions</li>
<li>Implementing server-sent events (SSE) with bidirectional flow</li>
<li>Building multi-client synchronization</li>
</ul>
<strong>Don't use <code>pan-forwarder</code> when:</strong>
<ul><li>You need request-response patterns (use <code>pan-xhr</code> or <code>fetch</code> directly)</li>
<li>Messages contain sensitive data and your endpoint isn't secured</li>
<li>You're forwarding high-frequency messages without throttling</li>
<li>Creating message loops (forwarding + SSE on same topics)</li>
</ul>
<h3>Installation and Setup</h3>
<pre><code class="language-html">&lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;

&lt;pan-forwarder
  dest=&quot;https://api.example.com/events&quot;
  topics=&quot;chat.* user.action.*&quot;
  method=&quot;POST&quot;
  headers=&#039;{&quot;Authorization&quot;: &quot;Bearer token123&quot;}&#039;
  enabled=&quot;true&quot;&gt;
&lt;/pan-forwarder&gt;</code></pre>
<h3>Attributes</h3>
<p>| Attribute | Type | Default | Description |
|-----------|------|---------|-------------|
| <code>dest</code> | String | <em>(required)</em> | Destination URL for HTTP requests. Must be a valid URL. |
| <code>topics</code> | String | <code>"*"</code> | Space-separated topic patterns to forward. Supports wildcards. |
| <code>method</code> | String | <code>"POST"</code> | HTTP method to use. Typically POST or PUT. |
| <code>headers</code> | String | <code>"{}"</code> | HTTP headers as JSON object or semicolon-separated key-value pairs. |
| <code>with-credentials</code> | Boolean | <code>true</code> | Whether to include credentials (cookies) in requests. |
| <code>enabled</code> | Boolean | <code>true</code> | Whether forwarding is active. Set to "false" or "0" to disable. |</p>
<strong>Attribute Details:</strong>
<strong>dest</strong>
<p>Required. The HTTP endpoint that will receive forwarded messages.</p>
<pre><code class="language-html">&lt;pan-forwarder dest=&quot;https://api.example.com/pan&quot;&gt;&lt;/pan-forwarder&gt;</code></pre>
<strong>topics</strong>
<p>Space-separated list of topic patterns. Defaults to <code>*</code> (all messages).</p>
<pre><code class="language-html">&lt;!-- Forward all user and admin messages --&gt;
&lt;pan-forwarder
  dest=&quot;/api/events&quot;
  topics=&quot;user.* admin.*&quot;&gt;
&lt;/pan-forwarder&gt;

&lt;!-- Forward specific topics --&gt;
&lt;pan-forwarder
  dest=&quot;/api/chat&quot;
  topics=&quot;chat.message chat.typing&quot;&gt;
&lt;/pan-forwarder&gt;</code></pre>
<strong>method</strong>
<p>HTTP method to use. Converted to uppercase.</p>
<pre><code class="language-html">&lt;pan-forwarder dest=&quot;/api/events&quot; method=&quot;PUT&quot;&gt;&lt;/pan-forwarder&gt;</code></pre>
<strong>headers</strong>
<p>HTTP headers as JSON or semicolon-separated pairs:</p>
<pre><code class="language-html">&lt;!-- JSON format --&gt;
&lt;pan-forwarder
  dest=&quot;/api/events&quot;
  headers=&#039;{&quot;Authorization&quot;: &quot;Bearer abc123&quot;, &quot;X-Client&quot;: &quot;web&quot;}&#039;&gt;
&lt;/pan-forwarder&gt;

&lt;!-- Semicolon-separated format --&gt;
&lt;pan-forwarder
  dest=&quot;/api/events&quot;
  headers=&quot;Authorization: Bearer abc123; X-Client: web&quot;&gt;
&lt;/pan-forwarder&gt;</code></pre>
<strong>with-credentials</strong>
<p>Controls whether cookies and authorization headers are included:</p>
<pre><code class="language-html">&lt;!-- Include credentials (default) --&gt;
&lt;pan-forwarder dest=&quot;/api/events&quot; with-credentials=&quot;true&quot;&gt;&lt;/pan-forwarder&gt;

&lt;!-- Omit credentials for CORS requests --&gt;
&lt;pan-forwarder dest=&quot;https://other-domain.com/events&quot; with-credentials=&quot;false&quot;&gt;&lt;/pan-forwarder&gt;</code></pre>
<strong>enabled</strong>
<p>Controls whether forwarding is active:</p>
<pre><code class="language-html">&lt;!-- Disabled --&gt;
&lt;pan-forwarder dest=&quot;/api/events&quot; enabled=&quot;false&quot;&gt;&lt;/pan-forwarder&gt;

&lt;!-- Enable/disable programmatically --&gt;
&lt;pan-forwarder id=&quot;fwd&quot; dest=&quot;/api/events&quot;&gt;&lt;/pan-forwarder&gt;
&lt;script&gt;
  const fwd = document.getElementById(&#039;fwd&#039;);
  fwd.setAttribute(&#039;enabled&#039;, &#039;false&#039;);  // Disable
  fwd.setAttribute(&#039;enabled&#039;, &#039;true&#039;);   // Re-enable
&lt;/script&gt;</code></pre>
<h3>Properties</h3>
<p>Access configuration via JavaScript properties:</p>
<pre><code class="language-javascript">const forwarder = document.querySelector(&#039;pan-forwarder&#039;);

console.log(forwarder.dest);            // &quot;https://api.example.com/events&quot;
console.log(forwarder.topics);          // [&quot;chat.*&quot;, &quot;user.*&quot;]
console.log(forwarder.method);          // &quot;POST&quot;
console.log(forwarder.headers);         // { Authorization: &quot;Bearer ...&quot; }
console.log(forwarder.withCredentials); // true
console.log(forwarder.enabled);         // true</code></pre>
<h3>Request Body Format</h3>
<p>Each forwarded message is sent as JSON with the following structure:</p>
<pre><code class="language-javascript">{
  &quot;topic&quot;: &quot;chat.message&quot;,
  &quot;data&quot;: {
    &quot;user&quot;: &quot;Alice&quot;,
    &quot;text&quot;: &quot;Hello world&quot;
  },
  &quot;retain&quot;: false,
  &quot;id&quot;: &quot;msg-123&quot;,
  &quot;ts&quot;: 1638360000000
}</code></pre>
<strong>Fields:</strong>
<ul><li><code>topic</code> (String): Message topic</li>
<li><code>data</code> (Any): Message payload</li>
<li><code>retain</code> (Boolean): Whether message was marked for retention</li>
<li><code>id</code> (String, optional): Message ID if present</li>
<li><code>ts</code> (Number, optional): Message timestamp if present</li>
</ul>
<h3>Deduplication</h3>
<code>pan-forwarder</code> implements best-effort deduplication using message IDs. If a message includes an <code>id</code> field, the forwarder tracks recently sent IDs to avoid duplicates.
<p>The deduplication cache is cleared every 30 seconds to prevent unbounded growth.</p>
<h3>Complete Working Examples</h3>
<p>#### Example 1: Basic Forwarding</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-bus.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;!-- Forward chat messages to server --&gt;
  &lt;pan-forwarder
    dest=&quot;/api/chat&quot;
    topics=&quot;chat.message&quot;&gt;
  &lt;/pan-forwarder&gt;

  &lt;input id=&quot;message&quot; placeholder=&quot;Type a message&quot;&gt;
  &lt;button id=&quot;send&quot;&gt;Send&lt;/button&gt;

  &lt;script type=&quot;module&quot;&gt;
    import { PanClient } from &#039;/components/pan-client.mjs&#039;;

    const pc = new PanClient();

    document.getElementById(&#039;send&#039;).onclick = () =&gt; {
      const text = document.getElementById(&#039;message&#039;).value;
      if (!text) return;

      // Publish locally (forwarder sends to server)
      pc.publish({
        topic: &#039;chat.message&#039;,
        data: {
          user: &#039;Alice&#039;,
          text: text,
          ts: Date.now()
        }
      });

      document.getElementById(&#039;message&#039;).value = &#039;&#039;;
    };
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>#### Example 2: Multi-Topic Forwarding with Headers</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-bus.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;!-- Forward multiple topic patterns with auth --&gt;
  &lt;pan-forwarder
    dest=&quot;https://api.example.com/events&quot;
    topics=&quot;user.* admin.* system.alert&quot;
    headers=&#039;{&quot;Authorization&quot;: &quot;Bearer abc123&quot;, &quot;X-App&quot;: &quot;dashboard&quot;}&#039;&gt;
  &lt;/pan-forwarder&gt;

  &lt;script type=&quot;module&quot;&gt;
    import { PanClient } from &#039;/components/pan-client.mjs&#039;;

    const pc = new PanClient();

    // These will be forwarded
    pc.publish({ topic: &#039;user.login&#039;, data: { userId: &#039;123&#039; } });
    pc.publish({ topic: &#039;admin.action&#039;, data: { action: &#039;delete&#039; } });
    pc.publish({ topic: &#039;system.alert&#039;, data: { level: &#039;critical&#039; } });

    // This will NOT be forwarded (doesn&#039;t match patterns)
    pc.publish({ topic: &#039;ui.click&#039;, data: { button: &#039;submit&#039; } });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>#### Example 3: SSE Integration (Bidirectional Sync)</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-bus.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-sse.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;!-- Receive messages from server via SSE --&gt;
  &lt;pan-sse
    src=&quot;/api/sse&quot;
    topics=&quot;chat.message&quot;
    persist-last-event=&quot;chat&quot;&gt;
  &lt;/pan-sse&gt;

  &lt;!-- Forward local messages to server --&gt;
  &lt;pan-forwarder
    dest=&quot;/api/chat&quot;
    topics=&quot;chat.message&quot;&gt;
  &lt;/pan-forwarder&gt;

  &lt;div id=&quot;messages&quot;&gt;&lt;/div&gt;
  &lt;input id=&quot;text&quot; placeholder=&quot;Type a message&quot;&gt;
  &lt;button id=&quot;send&quot;&gt;Send&lt;/button&gt;

  &lt;script type=&quot;module&quot;&gt;
    import { PanClient } from &#039;/components/pan-client.mjs&#039;;

    const pc = new PanClient();
    const messagesDiv = document.getElementById(&#039;messages&#039;);

    // Display incoming messages (from SSE or local)
    pc.subscribe(&#039;chat.message&#039;, (msg) =&gt; {
      const div = document.createElement(&#039;div&#039;);
      div.textContent = `${msg.data.user}: ${msg.data.text}`;
      messagesDiv.appendChild(div);
    });

    // Send message
    document.getElementById(&#039;send&#039;).onclick = () =&gt; {
      const text = document.getElementById(&#039;text&#039;).value;
      if (!text) return;

      // Publish locally
      // Forwarder sends to server
      // Server broadcasts via SSE to all clients
      pc.publish({
        topic: &#039;chat.message&#039;,
        data: {
          user: &#039;Current User&#039;,
          text: text,
          ts: Date.now()
        }
      });

      document.getElementById(&#039;text&#039;).value = &#039;&#039;;
    };
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<strong>Important Note:</strong> When using <code>pan-forwarder</code> with <code>pan-sse</code>, be careful to avoid message loops. Forward write intents only (e.g., <code>chat.send</code>) rather than read events (e.g., <code>chat.message</code>), or ensure the server doesn't echo back messages from the same client.
<p>#### Example 4: Conditional Forwarding</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-bus.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;!-- Initially disabled --&gt;
  &lt;pan-forwarder
    id=&quot;forwarder&quot;
    dest=&quot;/api/events&quot;
    topics=&quot;user.*&quot;
    enabled=&quot;false&quot;&gt;
  &lt;/pan-forwarder&gt;

  &lt;label&gt;
    &lt;input type=&quot;checkbox&quot; id=&quot;sync&quot;&gt;
    Enable server sync
  &lt;/label&gt;

  &lt;script type=&quot;module&quot;&gt;
    const forwarder = document.getElementById(&#039;forwarder&#039;);
    const checkbox = document.getElementById(&#039;sync&#039;);

    // Enable/disable based on checkbox
    checkbox.addEventListener(&#039;change&#039;, () =&gt; {
      forwarder.setAttribute(&#039;enabled&#039;, checkbox.checked);
    });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>#### Example 5: Analytics Forwarding</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-bus.mjs&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;module&quot; src=&quot;/components/pan-forwarder.mjs&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;pan-bus&gt;&lt;/pan-bus&gt;

  &lt;!-- Forward analytics events to tracking server --&gt;
  &lt;pan-forwarder
    dest=&quot;https://analytics.example.com/events&quot;
    topics=&quot;analytics.*&quot;
    headers=&#039;{&quot;X-API-Key&quot;: &quot;your-api-key&quot;}&#039;&gt;
  &lt;/pan-forwarder&gt;

  &lt;button id=&quot;btn1&quot;&gt;Action 1&lt;/button&gt;
  &lt;button id=&quot;btn2&quot;&gt;Action 2&lt;/button&gt;

  &lt;script type=&quot;module&quot;&gt;
    import { PanClient } from &#039;/components/pan-client.mjs&#039;;

    const pc = new PanClient();

    // Track button clicks
    document.getElementById(&#039;btn1&#039;).onclick = () =&gt; {
      pc.publish({
        topic: &#039;analytics.click&#039;,
        data: {
          button: &#039;action1&#039;,
          timestamp: Date.now(),
          page: window.location.pathname
        }
      });
    };

    document.getElementById(&#039;btn2&#039;).onclick = () =&gt; {
      pc.publish({
        topic: &#039;analytics.click&#039;,
        data: {
          button: &#039;action2&#039;,
          timestamp: Date.now(),
          page: window.location.pathname
        }
      });
    };

    // Track page views
    pc.publish({
      topic: &#039;analytics.pageview&#039;,
      data: {
        page: window.location.pathname,
        timestamp: Date.now(),
        referrer: document.referrer
      }
    });
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h3>Server-Side Implementation</h3>
<p>A typical server endpoint for receiving forwarded messages:</p>
<pre><code class="language-php">&lt;?php
// /api/events endpoint (PHP example)
header(&#039;Content-Type: application/json&#039;);
header(&#039;Access-Control-Allow-Origin: *&#039;);
header(&#039;Access-Control-Allow-Methods: POST, OPTIONS&#039;);
header(&#039;Access-Control-Allow-Headers: Content-Type, Authorization&#039;);

if ($_SERVER[&#039;REQUEST_METHOD&#039;] === &#039;OPTIONS&#039;) {
  exit(0);
}

$json = file_get_contents(&#039;php://input&#039;);
$message = json_decode($json, true);

if (!$message || !isset($message[&#039;topic&#039;], $message[&#039;data&#039;])) {
  http_response_code(400);
  echo json_encode([&#039;error&#039; =&gt; &#039;Invalid message format&#039;]);
  exit;
}

// Process message
$topic = $message[&#039;topic&#039;];
$data = $message[&#039;data&#039;];
$retain = $message[&#039;retain&#039;] ?? false;
$id = $message[&#039;id&#039;] ?? null;
$ts = $message[&#039;ts&#039;] ?? time() * 1000;

// Log to database
$pdo = new PDO(&#039;sqlite:messages.db&#039;);
$stmt = $pdo-&gt;prepare(&#039;INSERT INTO messages (topic, data, ts) VALUES (?, ?, ?)&#039;);
$stmt-&gt;execute([$topic, json_encode($data), $ts]);

// Broadcast to other clients (if using SSE)
broadcast_message($topic, $data);

echo json_encode([&#039;status&#039; =&gt; &#039;ok&#039;]);</code></pre>
<h3>Related Components</h3>
<strong>pan-sse</strong>
<p>Receives server-sent events and publishes them to the PAN bus. Often used in conjunction with <code>pan-forwarder</code> for bidirectional synchronization.</p>
<strong>pan-xhr</strong>
<p>Provides request-response HTTP patterns. Use for traditional API calls rather than one-way message forwarding.</p>
<strong>pan-bus</strong>
<p>The message bus that <code>pan-forwarder</code> subscribes to. Configure routing and message validation in <code>pan-bus</code>.</p>
<h3>Common Issues and Solutions</h3>
<strong>Issue: Messages not being forwarded</strong>
<em>Possible causes:</em>
<li><code>enabled</code> attribute is false</li>
<li>Topic patterns don't match</li>
<li>No <code>dest</code> attribute</li>
<li>CORS errors (check browser console)</li>
<em>Solution:</em>
<pre><code class="language-javascript">const fwd = document.querySelector(&#039;pan-forwarder&#039;);

console.log(&#039;Enabled:&#039;, fwd.enabled);
console.log(&#039;Destination:&#039;, fwd.dest);
console.log(&#039;Topics:&#039;, fwd.topics);

// Check if topic matches
import { PanBusEnhanced } from &#039;/components/pan-bus.mjs&#039;;
const matches = fwd.topics.some(pattern =&gt;
  PanBusEnhanced.matches(&#039;your.topic&#039;, pattern)
);
console.log(&#039;Topic matches:&#039;, matches);</code></pre>
<strong>Issue: CORS errors when forwarding</strong>
<em>Cause:</em> Server doesn't allow cross-origin requests
<em>Solution:</em> Configure CORS headers on server:
<pre><code class="language-javascript">// Server must respond with:
Access-Control-Allow-Origin: https://your-domain.com
Access-Control-Allow-Methods: POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Allow-Credentials: true  // If with-credentials=&quot;true&quot;</code></pre>
<strong>Issue: Message loops with SSE</strong>
<em>Cause:</em> Forwarding the same topics that SSE publishes
<em>Solution:</em> Use different topic patterns:
<pre><code class="language-html">&lt;!-- BAD: Loop --&gt;
&lt;pan-sse src=&quot;/api/sse&quot; topics=&quot;chat.message&quot;&gt;&lt;/pan-sse&gt;
&lt;pan-forwarder dest=&quot;/api/chat&quot; topics=&quot;chat.message&quot;&gt;&lt;/pan-forwarder&gt;

&lt;!-- GOOD: Separate intent and state --&gt;
&lt;pan-sse src=&quot;/api/sse&quot; topics=&quot;chat.message&quot;&gt;&lt;/pan-sse&gt;
&lt;pan-forwarder dest=&quot;/api/chat&quot; topics=&quot;chat.send&quot;&gt;&lt;/pan-forwarder&gt;

&lt;!-- In your code, publish to chat.send instead of chat.message --&gt;
&lt;script&gt;
  pc.publish({ topic: &#039;chat.send&#039;, data: { text: &#039;Hello&#039; } });
&lt;/script&gt;</code></pre>
<strong>Issue: High network traffic</strong>
<em>Cause:</em> Forwarding high-frequency messages without throttling
<em>Solution:</em> Throttle at the source:
<pre><code class="language-javascript">class ThrottledPublisher {
  constructor(pc, interval = 100) {
    this.pc = pc;
    this.interval = interval;
    this.pending = null;
    this.timer = null;
  }

  publish(topic, data) {
    this.pending = { topic, data };

    if (!this.timer) {
      this.flush();
      this.timer = setInterval(() =&gt; this.flush(), this.interval);
    }
  }

  flush() {
    if (this.pending) {
      this.pc.publish(this.pending.topic, this.pending.data);
      this.pending = null;
    }
  }
}

// Use throttled publisher for high-frequency events
const throttled = new ThrottledPublisher(pc, 100);

document.addEventListener(&#039;mousemove&#039;, (e) =&gt; {
  throttled.publish(&#039;mouse.move&#039;, { x: e.clientX, y: e.clientY });
});</code></pre>
<strong>Issue: Duplicate messages</strong>
<em>Cause:</em> Messages without IDs bypass deduplication
<em>Solution:</em> Include unique IDs in published messages:
<pre><code class="language-javascript">import { generateId } from &#039;/utils/id.mjs&#039;;

pc.publish({
  topic: &#039;chat.message&#039;,
  data: { text: &#039;Hello&#039; },
  id: generateId()  // Ensures deduplication
});</code></pre>
<strong>Issue: Authentication failures</strong>
<em>Cause:</em> Missing or incorrect headers
<em>Solution:</em> Verify headers are set correctly:
<pre><code class="language-html">&lt;pan-forwarder
  id=&quot;fwd&quot;
  dest=&quot;/api/events&quot;
  headers=&#039;{&quot;Authorization&quot;: &quot;Bearer your-token&quot;}&#039;&gt;
&lt;/pan-forwarder&gt;

&lt;script&gt;
  const fwd = document.getElementById(&#039;fwd&#039;);
  console.log(&#039;Headers:&#039;, fwd.headers);
  // Should show: { Authorization: &quot;Bearer your-token&quot; }
&lt;/script&gt;</code></pre>
<p>Or set headers programmatically:</p>
<pre><code class="language-javascript">const fwd = document.querySelector(&#039;pan-forwarder&#039;);

// Get auth token
const token = localStorage.getItem(&#039;authToken&#039;);

// Update headers
fwd.setAttribute(&#039;headers&#039;, JSON.stringify({
  Authorization: `Bearer ${token}`
}));</code></pre>
<h2>Best Practices</h2>
<h3>Debug Component Best Practices</h3>
<li><strong>Use sampling in production</strong>: Full tracing has memory and performance overhead</li>
<li><strong>Clear buffers periodically</strong>: Prevent unbounded memory growth</li>
<li><strong>Export traces before refresh</strong>: Trace data is lost on page reload</li>
<li><strong>Query efficiently</strong>: Use specific filters rather than scanning entire buffer</li>
<li><strong>Monitor error patterns</strong>: Check for recurring issues with <code>query({ hasErrors: true })</code></li>
<h3>Forwarder Best Practices</h3>
<li><strong>Avoid message loops</strong>: Don't forward topics that SSE publishes back</li>
<li><strong>Use specific topic patterns</strong>: Forward only what's needed</li>
<li><strong>Throttle high-frequency events</strong>: Reduce network overhead</li>
<li><strong>Include message IDs</strong>: Enable deduplication</li>
<li><strong>Secure endpoints</strong>: Use HTTPS and authentication headers</li>
<li><strong>Handle server errors gracefully</strong>: Forwarder silently ignores failures</li>
<li><strong>Test CORS configuration</strong>: Ensure server allows cross-origin requests</li>
<li><strong>Use <code>with-credentials</code> carefully</strong>: Required for cookies, but can cause CORS issues</li>
<h2>Summary</h2>
<p>Utility components provide infrastructure for observability and integration:</p>
<strong>pan-debug</strong> gives you x-ray vision into message flows. Use it during development to understand routing behavior, diagnose issues, and profile performance. In production, enable sampling to capture errors without overwhelming resources.
<strong>pan-forwarder</strong> extends LARC beyond the browser. Use it to synchronize state with servers, log analytics events, trigger workflows, and build real-time collaborative features. Combined with <code>pan-sse</code>, it enables bidirectional message flow between client and server.
<p>Both components embody LARC's philosophy: simple, focused tools that compose cleanly. They don't try to solve every problem—they solve specific problems well, and they integrate seamlessly with the rest of the ecosystem.</p>
<p>In the next chapter, we'll explore advanced integration patterns: building full-stack applications, implementing offline-first architectures, and connecting LARC to external systems and frameworks.</p>
      </article>
      <footer class="docs-footer">
        <a href="https://github.com/chrisrobison/pan/edit/main/books/building-with-larc/chapter-25-utility-components.md" target="_blank">
          Edit this page on GitHub
        </a>
      </footer>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" crossorigin="anonymous"></script>
  <script src="../assets/docs.js"></script>
</body>
</html>