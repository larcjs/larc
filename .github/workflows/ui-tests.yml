name: LARC UI Component Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'packages/ui/**'
      - 'packages/core/**'
      - '.github/workflows/ui-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'packages/ui/**'
      - 'packages/core/**'
  workflow_dispatch:

# Restrict workflow permissions to minimum required
permissions:
  contents: read
  actions: read

jobs:
  test:
    name: Test UI Components
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: ./packages/ui
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./packages/ui
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Run UI component tests
        working-directory: ./packages/ui
        run: npm test
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results-${{ matrix.os }}-${{ matrix.node-version }}
          path: packages/ui/test-results/
          retention-days: 7

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-playwright-report-${{ matrix.os }}-${{ matrix.node-version }}
          path: packages/ui/playwright-report/
          retention-days: 7

  test-summary:
    name: UI Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: ui-test-results-*
          path: all-ui-test-results

      - name: Publish test summary
        run: |
          echo "## UI Component Test Results ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Coverage:** 165 tests across 55 components" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix:" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu Latest + Node 18.x, 20.x" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Browser Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ WebKit/Safari" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components Tested:" >> $GITHUB_STEP_SUMMARY
          echo "- Data display (tables, grids, charts)" >> $GITHUB_STEP_SUMMARY
          echo "- Forms and input (forms, dropdowns, date pickers)" >> $GITHUB_STEP_SUMMARY
          echo "- UI controls (modals, tabs, cards)" >> $GITHUB_STEP_SUMMARY
          echo "- State management (sync, computed, offline)" >> $GITHUB_STEP_SUMMARY
          echo "- Data providers and connectors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage Includes:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Custom element registration" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Shadow DOM rendering" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Attribute reactivity" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ PAN bus message handling" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cross-browser compatibility" >> $GITHUB_STEP_SUMMARY

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: ./packages/ui
        run: npm ci

      - name: Check for console.log statements
        working-directory: ./packages/ui
        run: |
          if grep -r "console\.log" *.mjs --include="*.mjs" --include="*.js" | grep -v "// console.log" | grep -v "pan-debug" | grep -v "pan-inspector"; then
            echo "❌ Found console.log statements in source files"
            exit 1
          else
            echo "✅ No console.log statements found"
          fi

      - name: Validate package.json
        working-directory: ./packages/ui
        run: |
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"
          echo "✅ package.json is valid JSON"

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Run npm audit
        working-directory: ./packages/ui
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for known vulnerabilities
        working-directory: ./packages/ui
        run: |
          npm audit --json > audit-report.json || true
          echo "✅ Security audit completed"

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-security-audit
          path: packages/ui/audit-report.json
          retention-days: 30
